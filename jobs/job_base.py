import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwsIENhbGxhYmxlCmZyb20gYWJjIGltcG9ydCBBQkMsIGFic3RyYWN0bWV0aG9kCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmltcG9ydCB1cmxsaWIucGFyc2UKaW1wb3J0IHJhbmRvbQppbXBvcnQgY29uZmlnCiMgVOG6oW8gbG9nZ2VyIGNobyBCYXNlSm9iCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkJhc2VKb2IiKQoKY2xhc3MgQmFzZUpvYihBQkMpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gIiIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gIiIKICAgICAgICAjIEjDoG0gc2xlZXAgbeG6t2MgxJHhu4tuaCBsw6AgdGltZS5zbGVlcAogICAgICAgIHNlbGYuX3NsZWVwX2Z1bmMgPSB0aW1lLnNsZWVwCiAgICAgICAgIyBU4bqhbyBsb2dnZXIgY2hvIGluc3RhbmNlIGPhu6UgdGjhu4MKICAgICAgICBzZWxmLmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoZiJKb2Iue3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgCiAgICAgICAgIyBQcm94eSBzZXJ2aWNlIHPhur0gxJHGsOG7o2Mgc2V0IHNhdSBraGkga2jhu59pIHThuqFvCiAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlID0gTm9uZQogICAgICAgIAogICAgICAgICMgQXBwLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24gY2FjaGUKICAgICAgICBzZWxmLl9hcHBfY29uZmlnX2NhY2hlID0gTm9uZQogICAgICAgIHNlbGYuX2NvbmZpZ19jYWNoZV90aW1lID0gMAogICAgICAgIHNlbGYuX2NvbmZpZ19jYWNoZV90dGwgPSAzMDAgICMgQ2FjaGUgNSBwaMO6dAogICAgICAgIAogICAgICAgICMgRGVmYXVsdCBjb25maWcgY2hvIGFwcCAoY8OzIHRo4buDIG92ZXJyaWRlIHRyb25nIHN1YmNsYXNzKQogICAgICAgIHNlbGYuX2RlZmF1bHRfY29uZmlnID0gewogICAgICAgICAgICAiYWN0aW9uX3dlaWdodHMiOiB7CiAgICAgICAgICAgICAgICAibmV3c2ZlZWQiOiAxNSwgICAgICAjIDE1JSB2deG7kXQgbmV3c2ZlZWQvYuG6o25nIHRpbgogICAgICAgICAgICAgICAgInJlZWxzIjogMjAsICAgICAgICAgIyAyMCUgeGVtIHJlZWxzL3ZpZGVvCiAgICAgICAgICAgICAgICAibm90aWZpY2F0aW9uIjogMTAsICAgIyAxMCUgeGVtIHRow7RuZyBiw6FvCiAgICAgICAgICAgICAgICAicHJvZmlsZSI6IDE1LCAgICAgICAjIDE1JSB4ZW0gcHJvZmlsZQogICAgICAgICAgICAgICAgImpvYiI6IDIwLCAgICAgICAgICAgIyAyMCUgbMOgbSBqb2IKICAgICAgICAgICAgICAgICJleHBsb3JlIjogNSwgICAgICAgICMgNSUga2jDoW0gcGjDoQogICAgICAgICAgICAgICAgInNlYXJjaCI6IDE1ICAgICAgICAgIyAxNSUgdMOsbSBraeG6v20KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm1pbl9hY3Rpb25zX3Blcl9zZXNzaW9uIjogNSwgICAgICAgICAjIFThu5FpIHRoaeG7g3UgYWN0aW9ucyBt4buXaSBzZXNzaW9uCiAgICAgICAgICAgICJtYXhfc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzIjogMzAsICAgIyBUaOG7nWkgZ2lhbiB04buRaSDEkWEgbeG7l2kgc2Vzc2lvbiAocGjDunQpCiAgICAgICAgICAgICJhY3Rpb25fZGVsYXlfbWluIjogMywgICAgICAgICAgICAgICAgIyBEZWxheSB04buRaSB0aGnhu4N1IGdp4buvYSBhY3Rpb25zIChnacOieSkKICAgICAgICAgICAgImFjdGlvbl9kZWxheV9tYXgiOiAxMCAgICAgICAgICAgICAgICAjIERlbGF5IHThu5FpIMSRYSBnaeG7r2EgYWN0aW9ucyAoZ2nDonkpCiAgICAgICAgfQogICAgICAgIAogICAgZGVmIHNldF9wcm94eV9zZXJ2aWNlKHNlbGYsIHByb3h5X3NlcnZpY2UpOgogICAgICAgICIiIgogICAgICAgIFRoaeG6v3QgbOG6rXAgcHJveHkgc2VydmljZSBjaG8gam9iIGhhbmRsZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcm94eV9zZXJ2aWNlOiBQcm94eVNlcnZpY2UgaW5zdGFuY2UKICAgICAgICAiIiIKICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UgPSBwcm94eV9zZXJ2aWNlCiAgICAgICAgCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBnZXRfYWNjb3VudHNfZnJvbV9kZXZpY2Uoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4siIiIKICAgICAgICBwYXNzCgogICAgICAgIAogICAgZGVmIHN5bmNfYWNjb3VudHNfdG9fZGIoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iyB2w6BvIGRhdGFiYXNlIHbDoCBtYXAgduG7m2kgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBzZWxmLmdldF9hY2NvdW50c19mcm9tX2RldmljZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZCB04burIGRhdGFiYXNlCiAgICAgICAgICAgIGFuZHJvaWRfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gaGnhu4duIGPDsyB0cm9uZyBEQiBjaG8gYXBwIG7DoHkKICAgICAgICAgICAgZXhpc3RpbmdfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9c2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gc2V0IGPDoWMgdW5pcXVlX3VzZXJuYW1lIHThu6sgdGhp4bq/dCBi4buLIMSR4buDIGThu4Ugc28gc8OhbmgKICAgICAgICAgICAgZGV2aWNlX3VzZXJuYW1lcyA9IHNldCgpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGRldmljZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfdXNlcm5hbWVzLmFkZCh1c2VybmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gdHJvbmcgREIgbcOgIGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iyAtPiDEkcOhbmggZOG6pXUgbG9nb3V0CiAgICAgICAgICAgIGZvciBleGlzdGluZ19hY2NvdW50IGluIGV4aXN0aW5nX2FjY291bnRzOgogICAgICAgICAgICAgICAgZXhpc3RpbmdfdXNlcm5hbWUgPSBleGlzdGluZ19hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX3VzZXJuYW1lIGFuZCBleGlzdGluZ191c2VybmFtZSBub3QgaW4gZGV2aWNlX3VzZXJuYW1lczoKICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBjw7MgdHJvbmcgREIgbmjGsG5nIGtow7RuZyBjw7MgdHLDqm4gdGhp4bq/dCBi4buLIC0+IGxvZ291dAogICAgICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQuZ2V0KCJzdGF0dXMiKSAhPSAibG9nb3V0IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7ZXhpc3RpbmdfdXNlcm5hbWV9IGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iywgxJHDoW5oIGThuqV1IGxvZ291dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoZXhpc3RpbmdfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICJUw6BpIGtob+G6o24ga2jDtG5nIGPDsm4gdHLDqm4gdGhp4bq/dCBi4buLIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGhv4bq3YyB0aMOqbSBt4bubaSB2w6BvIERCCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGRldmljZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICMgVGjDqm0gdGjDtG5nIHRpbiBhcHAgdsOgIGRldmljZV9pZAogICAgICAgICAgICAgICAgYWNjb3VudFsiYXBwIl0gPSBzZWxmLmFwcF9uYW1lCiAgICAgICAgICAgICAgICBhY2NvdW50WyJkZXZpY2VfaWQiXSA9IGFuZHJvaWRfaWQKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kgxJHhu4MgZ+G7rWkgbMOqbiBzZXJ2ZXIKICAgICAgICAgICAgICAgIGFjY291bnRbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSBjaMawYSBk4buxYSB2w6BvIHVuaXF1ZV91c2VybmFtZSArIGFwcAogICAgICAgICAgICAgICAgZXhpc3RpbmdfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnRfYnlfdW5pcXVlX3VzZXJuYW1lKHNlbGYuYXBwX25hbWUsIGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZXhpc3RpbmdfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gaGnhu4duIGPDsyAtIGNo4buJIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGxvZ2luL2xvZ291dAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBleGlzdGluZ19hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3UgY+G6rXAgbmjhuq10IHThu5FpIHRoaeG7g3UKICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBhY2NvdW50LmdldCgibGFzdF91cGRhdGUiLCBpbnQodGltZS50aW1lKCkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgdMOgaSBraG/huqNuIHRyb25nIERCIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGxvZ291dCBuaMawbmcgeHXhuqV0IGhp4buHbiBs4bqhaSB0csOqbiB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgPT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdOG7qyBsb2dvdXQgduG7gSBhY3RpdmUgdsOgIHjDs2EgaW5hY3RpdmVfcmVhc29uCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJzdGF0dXMiXSA9ICJhY3RpdmUiCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJpbmFjdGl2ZV9yZWFzb24iXSA9ICIiCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJHDoyB4deG6pXQgaGnhu4duIGzhuqFpIHRyw6puIHRoaeG6v3QgYuG7iywgcmVzZXQgdOG7qyBsb2dvdXQgduG7gSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBhY3RpdmUgdGjDrCBnaeG7ryBuZ3V5w6puIHN0YXR1cywga2jDtG5nIHRoYXkgxJHhu5VpIGfDrCBraMOhYwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHRyb25nIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVGjDqm0gdMOgaSBraG/huqNuIG3hu5tpIHbhu5tpIHRy4bqhbmcgdGjDoWkgYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudFsic3RhdHVzIl0gPSAiYWN0aXZlIgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuYWRkX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0aMOqbSB0w6BpIGtob+G6o24gbeG7m2kge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gY2hvIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iywgdGjhu7FjIGhp4buHbiBtYXBwaW5nIHbhu5tpIEdvTGlrZQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IG1hcHBpbmcgdMOgaSBraG/huqNuIHtzZWxmLmFwcF9uYW1lfSB24bubaSBHb0xpa2UuLi4iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICAgICAgZ29saWtlX2FjY291bnRzID0gc2VsZi5nZXRfZ29saWtlX2FjY291bnRzKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKGdvbGlrZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIGPhuq1wIG5o4bqtdCB04burIERCCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9kZXZpY2VfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9c2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gbWFwcGluZwogICAgICAgICAgICAgICAgICAgIG1hcHBlZF9jb3VudCA9IHNlbGYubWFwX2dvbGlrZV9hY2NvdW50cyhnb2xpa2VfYWNjb3VudHMsIHVwZGF0ZWRfZGV2aWNlX2FjY291bnRzKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobWFwcGVkX2NvdW50LCBpbnQpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBtYXBwaW5nIHttYXBwZWRfY291bnR9IHTDoGkga2hv4bqjbiB7c2VsZi5hcHBfbmFtZX0gduG7m2kgR29MaWtlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIG1hcHBpbmcgdMOgaSBraG/huqNuIHtzZWxmLmFwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBHb0xpa2UgbsOgbyBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBtYXBwaW5nIHbhu5tpIEdvTGlrZToge2V9IikKICAgICAgICAgICAgICAgICMgS2jDtG5nIHRocm93IGV4Y2VwdGlvbiB2w6wgc3luYyB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sgxJHDoyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZGV2aWNlX2FjY291bnRzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7c2VsZi5hcHBfbmFtZX0iKQogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgCiAgICBkZWYgaXNfZ29saWtlX2F1dGhlbnRpY2F0ZWQoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSDEkcOjIGPDsyB0aMO0bmcgdGluIHjDoWMgdGjhu7FjIEdvTGlrZSBo4bujcCBs4buHIGNoxrBhCiAgICAgICAgU+G7rSBk4bulbmcgR29MaWtlU2VydmljZSDEkeG7gyB2YWxpZGF0ZSBjaOG6t3QgY2jhur0gaMahbgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyB4w6FjIHRo4buxYyDEkeG6p3kgxJHhu6csIEZhbHNlIG7hur91IHRoaeG6v3UgdGjDtG5nIHRpbgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmdvbGlrZV9zZXJ2aWNlLmlzX2dvbGlrZV9hdXRoZW50aWNhdGVkKCkKICAgIAogICAgZGVmIGFwaV9yZXF1ZXN0KHNlbGYsIHVybDogc3RyLCBtZXRob2Q6IHN0ciA9ICJHRVQiLCBwYXlsb2FkOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBH4buNaSBBUEkgR29MaWtlIHRow7RuZyBxdWEgR29MaWtlU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVybDogVVJMIGPhu6dhIEFQSQogICAgICAgICAgICBtZXRob2Q6IFBoxrDGoW5nIHRo4bupYyBIVFRQIChHRVQgaG/hurdjIFBPU1QpCiAgICAgICAgICAgIHBheWxvYWQ6IEThu68gbGnhu4d1IGfhu61pIMSRaSAoY2hvIFBPU1QgcmVxdWVzdCkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogS+G6v3QgcXXhuqMgQVBJIG7hur91IHRow6BuaCBjw7RuZywgTm9uZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgZ+G7jWkgQVBJOiBHb0xpa2VTZXJ2aWNlIGNoxrBhIMSRxrDhu6NjIGN1bmcgY+G6pXAgY2hvIHtzZWxmLmFwcF9uYW1lfSBqb2IiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IHBheWxvYWQgY2hvIEdFVCByZXF1ZXN0IC0gdGjDqm0gdsOgbyBVUkwKICAgICAgICBpZiBtZXRob2QudXBwZXIoKSA9PSAiR0VUIiBhbmQgcGF5bG9hZDoKICAgICAgICAgICAgIyBU4bqhbyBxdWVyeSBzdHJpbmcgdOG7qyBwYXlsb2FkCiAgICAgICAgICAgIHF1ZXJ5X3BhcmFtcyA9IFtdCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIHBheWxvYWQuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIHZhbHVlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIHF1ZXJ5X3BhcmFtcy5hcHBlbmQoZiJ7dXJsbGliLnBhcnNlLnF1b3RlKGtleSl9PXt1cmxsaWIucGFyc2UucXVvdGUoc3RyKHZhbHVlKSl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gcXVlcnkgc3RyaW5nIHbDoG8gVVJMCiAgICAgICAgICAgIGlmIHF1ZXJ5X3BhcmFtczoKICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9ICImIiBpZiAiPyIgaW4gdXJsIGVsc2UgIj8iCiAgICAgICAgICAgICAgICB1cmwgPSBmInt1cmx9e3NlcGFyYXRvcn17JyYnLmpvaW4ocXVlcnlfcGFyYW1zKX0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq3dCBwYXlsb2FkIHbhu4EgTm9uZSB2w6wgxJHDoyDEkcawYSB2w6BvIFVSTAogICAgICAgICAgICBwYXlsb2FkID0gTm9uZQogICAgICAgIAogICAgICAgIHJldHVybiBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kLCBwYXlsb2FkKQogICAgCiAgICBkZWYgZ2V0X2dvbGlrZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMSRxINuZyBrw70gduG7m2kgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkMaw4budbmcgZOG6q24gQVBJIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVybCA9IGYie3NlbGYuZ2V0X2FjY291bnRfdXJsKCl9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KHVybCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIFtdKQogICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgbWFwX2dvbGlrZV9hY2NvdW50cyhzZWxmLCBnb2xpa2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dLCBkZXZpY2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICDDgW5oIHjhuqEgdMOgaSBraG/huqNuIHThu6sgR29MaWtlIHbDoG8gdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyBHb0xpa2UgQVBJCiAgICAgICAgICAgIGRldmljZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMOhbmggeOG6oQogICAgICAgICIiIgogICAgICAgICMgUGjGsMahbmcgdGjhu6ljIG3hurdjIMSR4buLbmgsIGPhuqduIG92ZXJyaWRlIOG7nyBs4bubcCBjb24KICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGVmIGZldGNoX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gam9iIHThu6sgR29MaWtlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogVGjDtG5nIHRpbiBqb2IgbuG6v3UgY8OzLCBOb25lIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDGsOG7nW5nIGThuqtuIEFQSSBs4bqleSBqb2IKICAgICAgICAgICAgdXJsID0gZiJ7c2VsZi5nZXRfam9ic191cmwoKX0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRoYW0gc+G7kSB0w7l5IHRoZW8gbG/huqFpIGFwcAogICAgICAgICAgICBwYXJhbXMgPSBzZWxmLmdldF9qb2JfcGFyYW1zKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIEFQSQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuYXBpX3JlcXVlc3QodXJsLCAiR0VUIiwgcGFyYW1zKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3VjY2VzcyIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGpvYiA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBqb2I6CiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3Ugam9iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYubWFwX2pvYl9kYXRhKGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBs4bqleSBqb2IiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgbWFwX2pvYl9kYXRhKHNlbGYsIGpvYl9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ2h14bqpbiBow7NhIGThu68gbGnhu4d1IGpvYiB04burIEFQSQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9kYXRhOiBE4buvIGxp4buHdSBqb2IgdOG7qyBBUEkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEThu68gbGnhu4d1IGpvYiDEkcOjIGNodeG6qW4gaMOzYQogICAgICAgICIiIgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhcHAiOiBzZWxmLmFwcF9uYW1lLAogICAgICAgICAgICAiaWQiOiBqb2JfZGF0YS5nZXQoImlkIiksCiAgICAgICAgICAgICJsaW5rIjogam9iX2RhdGEuZ2V0KCJsaW5rIiksCiAgICAgICAgICAgICJ0eXBlIjogam9iX2RhdGEuZ2V0KCJ0eXBlIiksCiAgICAgICAgICAgICJvYmplY3RfaWQiOiBqb2JfZGF0YS5nZXQoIm9iamVjdF9pZCIpLAogICAgICAgICAgICAicHJpY2VfYWZ0ZXJfY29zdCI6IGpvYl9kYXRhLmdldCgicHJpY2VfYWZ0ZXJfY29zdCIpLAogICAgICAgICAgICAic3RhdHVzIjogImlkbGUiLCAgIyBTdGF0dXMgbeG6t2MgxJHhu4tuaCBsw6AgaWRsZQogICAgICAgICAgICAicmF3X2RhdGEiOiBqb2JfZGF0YSAgIyBMxrB1IGzhuqFpIGThu68gbGnhu4d1IGfhu5FjIMSR4buDIHRoYW0ga2jhuqNvIGtoaSBj4bqnbgogICAgICAgIH0KICAgIAogICAgZGVmIHZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCB2YWxpZGF0ZSBqb2IgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyB2YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgLSB2YWxpZCAoYm9vbCk6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICAgICAgICAgLSBzaG91bGRfc2tpcCAoYm9vbCk6IFRydWUgbuG6v3UgbsOqbiBza2lwIGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgICAgICAgICAtIHJlYXNvbiAoc3RyKTogTMO9IGRvIGtow7RuZyBo4bujcCBs4buHIGhv4bq3YyBza2lwCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGNoaSB0aeG6v3QKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgIGpvYl9wcmljZSA9IGpvYi5nZXQoInByaWNlX2FmdGVyX2Nvc3QiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYiBmb2xsb3cKICAgICAgICAgICAgaWYgam9iX3R5cGUgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAjIDEuIEtp4buDbSB0cmEgZ2nDoSB0aeG7gW4gY+G7p2Egam9iIGZvbGxvdwogICAgICAgICAgICAgICAgbWluX2ZvbGxvd19wcmljZSA9IHNlbGYuZGIuZ2V0KCJtaW5fZm9sbG93X3ByaWNlIiwgMzApICAjIE3hurdjIMSR4buLbmggMzAKICAgICAgICAgICAgICAgIGlmIGpvYl9wcmljZSA8IG1pbl9mb2xsb3dfcHJpY2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgInZhbGlkIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJzaG91bGRfc2tpcCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZiJKb2IgZm9sbG93IGPDsyBnacOhIHtqb2JfcHJpY2V9IDwge21pbl9mb2xsb3dfcHJpY2V9LCBza2lwIGpvYi4iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6MgYuG7jyBraeG7g20gdHJhIGtow7NhIGZvbGxvdyB2w6wga2jDtG5nIGPDsm4gZ2nhu5tpIGjhuqFuIGZvbGxvdwogICAgICAgICAgICAKICAgICAgICAgICAgIyBKb2IgaOG7o3AgbOG7hwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInZhbGlkIjogVHJ1ZSwKICAgICAgICAgICAgICAgICJzaG91bGRfc2tpcCI6IEZhbHNlLAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiSm9iIGjhu6NwIGzhu4ciCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdmFsaWRhdGUgam9iOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAidmFsaWQiOiBGYWxzZSwKICAgICAgICAgICAgICAgICJzaG91bGRfc2tpcCI6IEZhbHNlLAogICAgICAgICAgICAgICAgInJlYXNvbiI6ICJ2YWxpZGF0aW9uX2Vycm9yIiwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZiJM4buXaSBraGkgdmFsaWRhdGUgam9iOiB7c3RyKGUpfSIKICAgICAgICAgICAgfQogICAgCiAgICBkZWYgZXhlY3V0ZV9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiBqb2IsIGJhbyBn4buTbToKICAgICAgICAgICAgICAgIC0gc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgICAgICAwOiBDaMawYSB0aOG7sWMgaGnhu4duCiAgICAgICAgICAgICAgICAgICAgMTogVGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgMjogVGjhuqV0IGLhuqFpLCBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgICAgICAgICAgMzogVGjhuqV0IGLhuqFpLCDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICAtIHN1Y2Nlc3MgKGJvb2wpOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBN4bq3YyDEkeG7i25oIGtow7RuZyBsw6BtIGfDrCwgY+G6p24gb3ZlcnJpZGUg4bufIGzhu5twIGNvbgogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoMCwgIkNoxrBhIHRo4buxYyBoaeG7h24gam9iIiwgRmFsc2UpCiAgICAKICAgIGRlZiBfY3JlYXRlX2pvYl9yZXN1bHQoc2VsZiwgc3RhdHVzOiBpbnQsIG1lc3NhZ2U6IHN0ciwgc3VjY2VzczogYm9vbCwgKiprd2FyZ3MpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFThuqFvIGvhur90IHF14bqjIGpvYiBjaHXhuqluCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgIDA6IENoxrBhIHRo4buxYyBoaeG7h24KICAgICAgICAgICAgICAgIDE6IFRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgMjogVGjhuqV0IGLhuqFpLCBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgICAgICAzOiBUaOG6pXQgYuG6oWksIMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgICAgIDQ6IFRo4bqldCBi4bqhaSwgecOqdSBj4bqndSDEkWFuZyBjaOG7nQogICAgICAgICAgICAgICAgNTogR+G7rWkgecOqdSBj4bqndSBjaOG7nSBkdXnhu4d0IChJbnN0YWdyYW0pCiAgICAgICAgICAgIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgIHN1Y2Nlc3MgKGJvb2wpOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgICoqa3dhcmdzOiBDw6FjIHRow7RuZyB0aW4gYuG7lSBzdW5nCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyBqb2IgxJHDoyBjaHXhuqluIGjDs2EKICAgICAgICAiIiIKICAgICAgICByZXN1bHQgPSB7CiAgICAgICAgICAgICJzdGF0dXMiOiBzdGF0dXMsCiAgICAgICAgICAgICJtZXNzYWdlIjogbWVzc2FnZSwKICAgICAgICAgICAgInN1Y2Nlc3MiOiBzdWNjZXNzCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgVGjDqm0gdGjDtG5nIHRpbiBi4buVIHN1bmcgbuG6v3UgY8OzCiAgICAgICAgcmVzdWx0LnVwZGF0ZShrd2FyZ3MpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgCiAgICBkZWYgcmVwb3J0X2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgcmVzdWx0OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBCw6FvIGPDoW8ga+G6v3QgcXXhuqMgam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICByZXN1bHQ6IEvhur90IHF14bqjIHRo4buxYyBoaeG7h24gam9iIGJhbyBn4buTbToKICAgICAgICAgICAgICAgIC0gc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgICAgICAxOiBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAyOiBUaOG6pXQgYuG6oWksIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcKICAgICAgICAgICAgICAgICAgICAzOiBUaOG6pXQgYuG6oWksIMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgICAgIC0gbWVzc2FnZSAoc3RyKTogVGjDtG5nIGLDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIC0gc3VjY2VzcyAoYm9vbCk6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBiw6FvIGPDoW8gdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAgICAgam9iX3R5cGUgPSBqb2IuZ2V0KCJ0eXBlIiwgIiIpCiAgICAgICAgICAgIGpvYl9zdGF0dXMgPSByZXN1bHQuZ2V0KCJzdGF0dXMiLCAwKQogICAgICAgICAgICBqb2Jfc3VjY2VzcyA9IHJlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2hpIGzhuqFpIGzhu4tjaCBz4butIGpvYgogICAgICAgICAgICBzZWxmLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIGPDsyBJRCBqb2IgxJHhu4MgYsOhbyBjw6FvIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGpvYiB2w6AgeOG7rSBsw70gdMawxqFuZyDhu6luZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBzdGF0dXMgbMOgIDIgKGzhu5dpIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcpLCBo4buneSBqb2IgdsOgIGLDoW8gY8OhbyB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSAyOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiB7am9iX2lkfSwga2jDtG5nIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZywgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Ugc3RhdHVzIGzDoCA2ICjEkeG6oXQgZ2nhu5tpIGjhuqFuIGhv4bq3YyBi4buLIGtow7NhKSwgaOG7p3kgam9iCiAgICAgICAgICAgIGlmIGpvYl9zdGF0dXMgPT0gNjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJKb2Ige2pvYl9pZH0gYuG7iyBo4buneSBkbyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGhv4bq3YyB0w6BpIGtob+G6o24gYuG7iyBraMOzYSIpCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IHN0YXR1cyBsw6AgMyAoxJHDoyBi4buLIHVuZm9sbG93L3VubGlrZSksIMSRw6FuaCBk4bqldSB0cm9uZyByZXN1bHQgxJHhu4MgSm9iU2VydmljZSB44butIGzDvQogICAgICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDM6CiAgICAgICAgICAgICAgICBhY2NvdW50X3VzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiUGjDoXQgaGnhu4duIGLhu4sgdW5mb2xsb3cvdW5saWtlLCB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBI4buneSBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICBzZWxmLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdW5mb2xsb3cgdHJvbmcgcmVzdWx0IMSR4buDIEpvYlNlcnZpY2UgeOG7rSBsw70gdOG6rXAgdHJ1bmcKICAgICAgICAgICAgICAgIHJlc3VsdFsidW5mb2xsb3ciXSA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiWcOqdSBj4bqndSDEkWFuZyBjaOG7nSB0cm9uZyBqb2Ige2pvYl90eXBlfSwgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHNlbGYuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGpvYiB0aMOgbmggY8O0bmcsIGLDoW8gY8OhbyBr4bq/dCBxdeG6owogICAgICAgICAgICBpZiBqb2Jfc3VjY2VzczoKICAgICAgICAgICAgICAgICMgVVJMIEFQSSBiw6FvIGPDoW8gam9iCiAgICAgICAgICAgICAgICB1cmwgPSBzZWxmLmdldF9jb21wbGV0ZV9qb2JzX3VybCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVOG6oW8gcGF5bG9hZCBjaG8gYsOhbyBjw6FvIGpvYgogICAgICAgICAgICAgICAgcGF5bG9hZCA9IHNlbGYuZ2V0X3JlcG9ydF9wYXlsb2FkKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIGlmIG5vdCBwYXlsb2FkOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgdOG6oW8gcGF5bG9hZCBjaG8gYsOhbyBjw6FvIGpvYiIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjhu60gZ+G7jWkgQVBJIHThu5FpIMSRYSAzIGzhuqduCiAgICAgICAgICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZSgzKToKICAgICAgICAgICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuYXBpX3JlcXVlc3QodXJsLCAiUE9TVCIsIHBheWxvYWQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3VjY2VzcyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgYsOhbyBjw6FvIGpvYiB7am9iX2lkfSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3RhdHVzIikgPT0gNDAwOgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXNwb25zZS5nZXQoJ21lc3NhZ2UnLCAnJykKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJbe2F0dGVtcHQgKyAxfV0gQsOhbyBjw6FvIGpvYiBs4buXaToge2Vycm9yX21zZ30sIHRo4butIGzhuqFpIHNhdSA1cy4uLiIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJQaOG6o24gaOG7k2kga2jDtG5nIG1vbmcgxJHhu6NpIGtoaSBiw6FvIGPDoW8gam9iOiB7cmVzcG9uc2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdGjDoG5oIGPDtG5nIHNhdSAzIGzhuqduIHRo4butLCBo4buneSBqb2IKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGLDoW8gY8OhbyBqb2Ige2pvYl9pZH0gc2F1IDMgbOG6p24gdGjhu60iKQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBKb2Iga2jDtG5nIHRow6BuaCBjw7RuZywgaOG7p3kgam9iCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiSm9iIHtqb2JfaWR9IGtow7RuZyB0aMOgbmggY8O0bmcsIGjhu6d5IGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9yZXBvcnRfcGF5bG9hZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVOG6oW8gcGF5bG9hZCBjaG8gdmnhu4djIGLDoW8gY8OhbyBob8OgbiB0aMOgbmggam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogUGF5bG9hZCBjaG8gQVBJIGLDoW8gY8OhbwogICAgICAgICIiIgogICAgICAgIGdvbGlrZV9pZCA9IGFjY291bnQuZ2V0KCJnb2xpa2VfaWQiKQogICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAKICAgICAgICBpZiBub3QgZ29saWtlX2lkIG9yIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJUaGnhur91IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhv4bq3YyBqb2IgxJHhu4MgdOG6oW8gcGF5bG9hZCBiw6FvIGPDoW8iKQogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgImFkc19pZCI6IGpvYl9pZCwKICAgICAgICAgICAgImFjY291bnRfaWQiOiBnb2xpa2VfaWQsCiAgICAgICAgICAgICJhc3luYyI6IFRydWUsCiAgICAgICAgICAgICJkYXRhIjogTm9uZQogICAgICAgIH0KICAgIAogICAgZGVmIGdldF9za2lwX3BheWxvYWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFThuqFvIHBheWxvYWQgY2hvIHZp4buHYyBi4buPIHF1YS9o4buneSBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBQYXlsb2FkIGNobyBBUEkgc2tpcCBqb2IKICAgICAgICAiIiIKICAgICAgICBnb2xpa2VfaWQgPSBhY2NvdW50LmdldCgiZ29saWtlX2lkIikKICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgam9iX3R5cGUgPSBqb2IuZ2V0KCJ0eXBlIikKICAgICAgICBvYmplY3RfaWQgPSBqb2IuZ2V0KCJvYmplY3RfaWQiKQogICAgICAgIAogICAgICAgIGlmIG5vdCBnb2xpa2VfaWQgb3Igbm90IGpvYl9pZDoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIlRoaeG6v3UgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gaG/hurdjIGpvYiDEkeG7gyB04bqhbyBwYXlsb2FkIGjhu6d5IikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhZHNfaWQiOiBqb2JfaWQsCiAgICAgICAgICAgICJhY2NvdW50X2lkIjogZ29saWtlX2lkLAogICAgICAgICAgICAib2JqZWN0X2lkIjogb2JqZWN0X2lkLAogICAgICAgICAgICAidHlwZSI6IGpvYl90eXBlCiAgICAgICAgfQogICAgICAgIAogICAgZGVmIHNraXBfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIELhu48gcXVhL2jhu6d5IGpvYiBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgaOG7p3kgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFVSTCBBUEkgxJHhu4Mgc2tpcCBqb2IKICAgICAgICAgICAgdXJsID0gc2VsZi5nZXRfc2tpcF9qb2JzX3VybCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHBheWxvYWQgY2hvIHZp4buHYyBza2lwIGpvYgogICAgICAgICAgICBwYXlsb2FkID0gc2VsZi5nZXRfc2tpcF9wYXlsb2FkKGFjY291bnQsIGpvYikKICAgICAgICAgICAgaWYgbm90IHBheWxvYWQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHThuqFvIHBheWxvYWQgY2hvIHNraXAgam9iIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KHVybCwgIlBPU1QiLCBwYXlsb2FkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3VjY2VzcyIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGjhu6d5IGpvYiB7am9iLmdldCgnaWQnKX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiSOG7p3kgam9iIHtqb2IuZ2V0KCdpZCcpfSB0aOG6pXQgYuG6oWk6IHtyZXNwb25zZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGjhu6d5IGpvYiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgZGVmIGNsb3NlX2FwcChzZWxmKToKICAgICAgICAiIiIKICAgICAgICDEkMOzbmcgYXBwCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5oZWxwZXIuY2xvc2VfYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICBkZWYgZ2V0X2FwaV9iYXNlX3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIGfhu5FjIGPhu6dhIEFQSSBHb0xpa2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBn4buRYwogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0ve3NlbGYuYXBwX25hbWV9IgogICAgCiAgICBkZWYgZ2V0X2FjY291bnRfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIHTDoGkga2hv4bqjbiBj4bunYSBHb0xpa2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGNvbmZpZwogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS97c2VsZi5hcHBfbmFtZX0tYWNjb3VudCIKICAgIAogICAgZGVmIGdldF9qb2JzX3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSBqb2JzIGPhu6dhIEdvTGlrZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVJMIEFQSSBqb2JzCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGNvbmZpZwogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS9hZHZlcnRpc2luZy9wdWJsaXNoZXJzL3tzZWxmLmFwcF9uYW1lfS9qb2JzIgogICAgCiAgICBkZWYgZ2V0X2NvbXBsZXRlX2pvYnNfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGLDoW8gY8OhbyBqb2IgaG/DoG4gdGjDoG5oIGPhu6dhIEdvTGlrZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVJMIEFQSSBiw6FvIGPDoW8gam9iIGhvw6BuIHRow6BuaAogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vY29tcGxldGUtam9icyIKICAgIAogICAgZGVmIGdldF9za2lwX2pvYnNfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIHNraXAgam9icyBj4bunYSBHb0xpa2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgc2tpcCBqb2JzCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGNvbmZpZwogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS9hZHZlcnRpc2luZy9wdWJsaXNoZXJzL3tzZWxmLmFwcF9uYW1lfS9za2lwLWpvYnMiCiAgICAKICAgIGRlZiBnZXRfam9iX3JlcG9ydF91cmwoc2VsZiwgam9iX2lkOiBzdHIpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGLDoW8gY8OhbyBqb2IgY+G7p2EgR29MaWtlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgam9iX2lkOiBJRCBj4bunYSBqb2IKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIGLDoW8gY8OhbyBqb2IKICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfS9qb2JzL3tqb2JfaWR9L3JlcG9ydCIKICAgIAogICAgZGVmIGdldF9qb2JfcGFyYW1zKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aGFtIHPhu5EgxJHhu4MgZ+G7jWkgQVBJIGzhuqV5IGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBUaGFtIHPhu5EKICAgICAgICAiIiIKICAgICAgICAjIE3hurdjIMSR4buLbmgga2jDtG5nIGPDsyB0aGFtIHPhu5EsIGPhuqduIG92ZXJyaWRlIOG7nyBs4bubcCBjb24KICAgICAgICByZXR1cm4ge30KICAgIAogICAgZGVmIGdldF9hY2NvdW50c19mcm9tX2RldmljZShzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiJQaMawxqFuZyB0aOG7qWMgY8ahIHPhu58gxJHhu4MgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24sIGPhuqduIG92ZXJyaWRlIOG7nyBjbGFzcyBjb24iIiIKICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGVmIHNldF9zbGVlcF9mdW5jdGlvbihzZWxmLCBzbGVlcF9mdW5jOiBDYWxsYWJsZVtbZmxvYXRdLCBib29sXSk6CiAgICAgICAgIiIiCiAgICAgICAgxJDhurd0IGjDoG0gc2xlZXAgdMO5eSBjaOG7iW5oCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2xlZXBfZnVuYzogSMOgbSBzbGVlcCBuaOG6rW4gbeG7mXQgdGhhbSBz4buRIGzDoCBz4buRIGdpw6J5IHbDoCB0cuG6oyB24buBIFRydWUgbuG6v3Ugc2xlZXAgxJHhu6cgdGjhu51pIGdpYW4sCiAgICAgICAgICAgICAgICAgICAgICAgIEZhbHNlIG7hur91IGLhu4sgZOG7q25nIGzhuqFpCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5fc2xlZXBfZnVuYyA9IHNsZWVwX2Z1bmMKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBzZWNvbmRzOiBT4buRIGdpw6J5IGPhuqduIG5n4bunCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugbmfhu6cgxJHhu6cgdGjhu51pIGdpYW4sIEZhbHNlIG7hur91IGLhu4sgZOG7q25nIGzhuqFpCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuX3NsZWVwX2Z1bmMoc2Vjb25kcykKICAgIAogICAgZGVmIHN3aXRjaF90b19hY2NvdW50KHNlbGYsIHRhcmdldF9hY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ2h1eeG7g24gxJHhu5VpIHNhbmcgdMOgaSBraG/huqNuIG3hu6VjIHRpw6p1CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFyZ2V0X2FjY291bnQ6IFTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbiDEkeG6v24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IHsKICAgICAgICAgICAgICAgICdzdWNjZXNzJzogYm9vbCwKICAgICAgICAgICAgICAgICdyZWFzb24nOiBzdHIgKG7hur91IHRo4bqldCBi4bqhaSksCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IHN0cgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJBhbmcgY2h1eeG7g24gxJHhu5VpIHNhbmcgdMOgaSBraG/huqNuIHt0YXJnZXRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICd1bmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhurd0IHRo4budaSBnaWFuIGNo4budIHThu5FpIMSRYSAoZ2nDonkpCiAgICAgICAgICAgIHRpbWVvdXQgPSA2MAogICAgICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdXNlcm5hbWUgY+G7p2EgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAKICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgdGFyZ2V0X3VzZXJuYW1lID0gdGFyZ2V0X2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAgxJHDum5nIHTDoGkga2hv4bqjbiBy4buTaSwga2jDtG5nIGPhuqduIGNodXnhu4NuIMSR4buVaQogICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lIGFuZCBjdXJyZW50X3VzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIMSRxINuZyBuaOG6rXAgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IHLhu5NpIikKICAgICAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBUcnVlLCAnbWVzc2FnZSc6IGYnxJDDoyDEkcSDbmcgbmjhuq1wIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSd9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGNoxrBhIMSRxINuZyBuaOG6rXAgxJHDum5nIHTDoGkga2hv4bqjbiwgdGjhu7FjIGhp4buHbiBjaHV54buDbiDEkeG7lWkKICAgICAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgdGltZW91dDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIFBoxrDGoW5nIHRo4bupYyBuw6B5IHPhur0gxJHGsOG7o2MgZ2hpIMSRw6ggYuG7n2kgbOG7m3AgY29uIHTDuXkgdGhlbyDhu6luZyBk4bulbmcKICAgICAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gc2VsZi5fcGVyZm9ybV9hY2NvdW50X3N3aXRjaCh0YXJnZXRfYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMgdHLhuqMgduG7gSB04burIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzd2l0Y2hfcmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCdzdWNjZXNzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN3aXRjaF9yZXN1bHQgICMgVHLhuqMgduG7gSBuZ2F5IGzhu5dpIHThu6sgX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2gKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAjIFTGsMahbmcgdGjDrWNoIHbhu5tpIGltcGxlbWVudGF0aW9uIGPFqSB0cuG6oyB24buBIGJvb2xlYW4KICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdzd2l0Y2hfZmFpbGVkJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0aOG7gyBjaHV54buDbiB0w6BpIGtob+G6o24nCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIMSQ4bujaSBt4buZdCBjaMO6dCDEkeG7gyDhu6luZyBk4bulbmcgbG9hZCB4b25nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSDEkcOjIGNodXnhu4NuIMSRw7puZyB0w6BpIGtob+G6o24gY2jGsGEKICAgICAgICAgICAgICAgICAgICBuZXdfdXNlcm5hbWUgPSBzZWxmLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgbmV3X3VzZXJuYW1lIGFuZCBuZXdfdXNlcm5hbWUgPT0gdGFyZ2V0X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIucmVzZXRfbG9naW5fc3RhdHVzX2J5X2FwcChzZWxmLmFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KHRhcmdldF9hY2NvdW50WyJpZCJdLCB7ImlzX2xvZ2luIjogVHJ1ZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogVHJ1ZSwgJ21lc3NhZ2UnOiBmJ0NodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IHRow6BuaCBjw7RuZyd9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBjaMawYSB0aMOgbmggY8O0bmcsIMSR4bujaSBt4buZdCBjaMO6dCBy4buTaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbjoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gc2F1IHt0aW1lb3V0fSBnacOieSIpCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICdyZWFzb24nOiAndGltZW91dCcsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IHNhdSB7dGltZW91dH0gZ2nDonknCiAgICAgICAgICAgIH0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24iKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAncmVhc29uJzogJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnTOG7l2kga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbjoge3N0cihlKX0nCiAgICAgICAgICAgIH0KICAgIAogICAgZGVmIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoKHNlbGYsIHRhcmdldF9hY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBjw6FjIHRoYW8gdMOhYyBVSSDEkeG7gyBjaHV54buDbiB0w6BpIGtob+G6o24KICAgICAgICBQaMawxqFuZyB0aOG7qWMgbsOgeSBj4bqnbiDEkcaw4bujYyBnaGkgxJHDqCBi4bufaSBs4bubcCBjb24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXJnZXRfYWNjb3VudDogVMOgaSBraG/huqNuIGPhuqduIGNodXnhu4NuIMSR4bq/bgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBib29sLAogICAgICAgICAgICAgICAgJ3JlYXNvbic6IHN0ciAobuG6v3UgdGjhuqV0IGLhuqFpIC0gJ2FjY291bnRfbm90X2ZvdW5kJywgJ3VpX2Vycm9yJywgZXRjLiksCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IHN0cgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgIyBQaMawxqFuZyB0aOG7qWMgY8ahIHPhu58gY2jhu4kgbG9nIGPhuqNuaCBiw6FvCiAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlBoxrDGoW5nIHRo4bupYyBfcGVyZm9ybV9hY2NvdW50X3N3aXRjaCBjaMawYSDEkcaw4bujYyB0cmnhu4NuIGtoYWkgY2hvIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAncmVhc29uJzogJ25vdF9pbXBsZW1lbnRlZCcsCiAgICAgICAgICAgICdtZXNzYWdlJzogZidQaMawxqFuZyB0aOG7qWMgX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2ggY2jGsGEgxJHGsOG7o2MgdHJp4buDbiBraGFpIGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199JwogICAgICAgIH0KICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoc2VsZikgLT4gT3B0aW9uYWxbc3RyXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB1c2VybmFtZSBj4bunYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0ciBob+G6t2MgTm9uZTogVXNlcm5hbWUgY+G7p2EgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAsIGhv4bq3YyBOb25lIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICAjIFBoxrDGoW5nIHRo4bupYyBjxqEgc+G7nyBjaOG7iSBsb2cgY+G6o25oIGLDoW8KICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiUGjGsMahbmcgdGjhu6ljIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSBjaMawYSDEkcaw4bujYyB0cmnhu4NuIGtoYWkgY2hvIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiByZWNvcmRfam9iX2hpc3Rvcnkoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIHJlc3VsdDogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBHaGkgbOG6oWkgbOG7i2NoIHPhu60gam9iIHbDoG8gZGF0YWJhc2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIHJlc3VsdDogS+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVVUlEIGPhu6dhIGLhuqNuIGdoaSBs4buLY2ggc+G7rSBqb2IgaG/hurdjIGNodeG7l2kgcuG7l25nIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQKICAgICAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodeG6qW4gYuG7iyBk4buvIGxp4buHdSBqb2IgaGlzdG9yeQogICAgICAgICAgICBqb2JfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJhY2NvdW50X3V1aWQiOiBhY2NvdW50LmdldCgiYWNjb3VudF91dWlkIiwgIiIpLAogICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICJhcHAiOiBzZWxmLmFwcF9uYW1lLAogICAgICAgICAgICAgICAgImpvYl9pZCI6IGpvYi5nZXQoImlkIiwgIiIpLAogICAgICAgICAgICAgICAgImpvYl90eXBlIjogam9iLmdldCgidHlwZSIsICIiKSwKICAgICAgICAgICAgICAgICJvYmplY3RfaWQiOiBqb2IuZ2V0KCJvYmplY3RfaWQiLCAiIiksCiAgICAgICAgICAgICAgICAibGluayI6IGpvYi5nZXQoImxpbmsiLCAiIiksCiAgICAgICAgICAgICAgICAic3RhdHVzIjogcmVzdWx0LmdldCgic3RhdHVzIiwgMCksCiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IHJlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSksCiAgICAgICAgICAgICAgICAicHJpY2UiOiBqb2IuZ2V0KCJwcmljZV9hZnRlcl9jb3N0IiwgMCksCiAgICAgICAgICAgICAgICAiZXJyb3JfbWVzc2FnZSI6IHJlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiIikgaWYgbm90IHJlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkgZWxzZSAiIiwKICAgICAgICAgICAgICAgICJjcmVhdGVkX2F0IjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UgICMgxJDhuqNtIGLhuqNvIHRy4bqhbmcgdGjDoWkgbMOgIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBqb2JfdXVpZCA9IHNlbGYuZGIuYWRkX2pvYl9oaXN0b3J5KGpvYl9kYXRhKQogICAgICAgICAgICBpZiBqb2JfdXVpZDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYixJDDoyBsxrB1IGzhu4tjaCBz4butIGpvYiB7am9iLmdldCgnaWQnKX0gdsOgbyBkYXRhYmFzZSB24bubaSBVVUlEOiB7am9iX3V1aWR9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgbMawdSBs4buLY2ggc+G7rSBqb2Ige2pvYi5nZXQoJ2lkJyl9IHbDoG8gZGF0YWJhc2UiKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGpvYl91dWlkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBnaGkgbOG7i2NoIHPhu60gam9iIikKICAgICAgICAgICAgcmV0dXJuICIiCgogICAgZGVmIHJlcG9ydF9qb2JfY29tcGxldGVkKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCByZXBvcnRfZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIELDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIHJlcG9ydF9kYXRhOiBE4buvIGxp4buHdSBiw6FvIGPDoW8KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEvhur90IHF14bqjIGLDoW8gY8OhbyB04burIEFQSQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBqb2JfaWQgdOG7qyBqb2IKICAgICAgICAgICAgam9iX2lkID0gam9iLmdldCgiaWQiKQogICAgICAgICAgICBpZiBub3Qgam9iX2lkOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBqb2JfaWQgdHJvbmcgam9iIikKICAgICAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJlcnJvciIsICJtZXNzYWdlIjogIktow7RuZyB0w6xtIHRo4bqleSBqb2JfaWQgdHJvbmcgam9iIn0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIENodeG6qW4gYuG7iyBk4buvIGxp4buHdSBiw6FvIGPDoW8KICAgICAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgICAgICJpZCI6IGpvYl9pZCwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiBUcnVlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgYsOhbyBjw6FvIG7hur91IGPDswogICAgICAgICAgICBpZiByZXBvcnRfZGF0YToKICAgICAgICAgICAgICAgIHBheWxvYWQudXBkYXRlKHJlcG9ydF9kYXRhKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgQVBJIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmgKICAgICAgICAgICAgdXJsID0gc2VsZi5nZXRfY29tcGxldGVfam9ic191cmwoKQogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kPSJQT1NUIiwgcGF5bG9hZD1wYXlsb2FkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGhvw6BuIHRow6BuaCIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGhvw6BuIHRow6BuaCJ9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgYsOhbyBjw6FvIGpvYiB7am9iX2lkfSBob8OgbiB0aMOgbmggdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MiLCAibWVzc2FnZSI6ICLEkMOjIGLDoW8gY8OhbyBqb2IgaG/DoG4gdGjDoG5oIHRow6BuaCBjw7RuZyIsICJkYXRhIjogcmVzdWx0fQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmgiKQogICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6IGYiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmg6IHtzdHIoZSl9In0KICAgICAgICAgICAgCiAgICBkZWYgcmVwb3J0X2pvYl9za2lwcGVkKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCByZWFzb246IHN0ciA9ICIiKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBCw6FvIGPDoW8gam9iIMSRw6MgYuG7iyBi4buPIHF1YQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gYuG7jyBxdWEgam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyBiw6FvIGPDoW8gdOG7qyBBUEkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgam9iX2lkIHThu6sgam9iCiAgICAgICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAgICAgaWYgbm90IGpvYl9pZDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgam9iX2lkIHRyb25nIGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJLaMO0bmcgdMOsbSB0aOG6pXkgam9iX2lkIHRyb25nIGpvYiJ9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3UgYsOhbyBjw6FvCiAgICAgICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICAiaWQiOiBqb2JfaWQKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBsw70gZG8gbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHJlYXNvbjoKICAgICAgICAgICAgICAgIHBheWxvYWRbInJlYXNvbiJdID0gcmVhc29uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWEKICAgICAgICAgICAgdXJsID0gc2VsZi5nZXRfc2tpcF9qb2JzX3VybCgpCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuZ29saWtlX3NlcnZpY2UuYXBpX3JlcXVlc3QodXJsLCBtZXRob2Q9IlBPU1QiLCBwYXlsb2FkPXBheWxvYWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBiw6FvIGPDoW8gam9iIMSRw6MgYuG7iyBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWEifQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGLDoW8gY8OhbyBqb2Ige2pvYl9pZH0gYuG7iyBi4buPIHF1YSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAic3VjY2VzcyIsICJtZXNzYWdlIjogIsSQw6MgYsOhbyBjw6FvIGpvYiBi4buLIGLhu48gcXVhIHRow6BuaCBjw7RuZyIsICJkYXRhIjogcmVzdWx0fQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IgxJHDoyBi4buLIGLhu48gcXVhIikKICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiBmIkzhu5dpIGtoaSBiw6FvIGPDoW8gam9iIMSRw6MgYuG7iyBi4buPIHF1YToge3N0cihlKX0ifQogICAgCiAgICBkZWYgZ2V0X2FjY291bnRfbGlzdF91cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0ve3NlbGYuYXBwX25hbWV9IgogICAgICAgIAogICAgZGVmIGdldF9hY2NvdW50X2RldGFpbF91cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgY2hpIHRp4bq/dCB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgY2hpIHRp4bq/dCB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0ve3NlbGYuYXBwX25hbWV9LWFjY291bnQiCiAgICAgICAgCiAgICBkZWYgZ2V0X2pvYl9saXN0X3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSBkYW5oIHPDoWNoIGpvYgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVJMIEFQSSBkYW5oIHPDoWNoIGpvYgogICAgICAgICIiIgogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS9hZHZlcnRpc2luZy9wdWJsaXNoZXJzL3tzZWxmLmFwcF9uYW1lfS9qb2JzIgogICAgICAgIAogICAgZGVmIGdldF9qb2JfcmVwb3J0X3VybChzZWxmLCBqb2JfaWQ6IHN0cikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgYsOhbyBjw6FvIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9pZDogSUQgY+G7p2Egam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVJMIEFQSSBiw6FvIGPDoW8gam9iCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfS9qb2JzL3tqb2JfaWR9L3JlcG9ydCIKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBBQlNUUkFDVCBNRVRIT0RTIENITyBDQVJFIEFDVElPTlMgKEtIw5RORyBQSOG6okkgSk9CKQogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBkZWYgcGVyZm9ybV9uZXdzZmVlZF9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIHZ14buRdCBuZXdzZmVlZC9i4bqjbmcgdGluCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYicGVyZm9ybV9uZXdzZmVlZF9hY3Rpb24gY2jGsGEgxJHGsOG7o2MgaW1wbGVtZW50IGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fcmVlbHNfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyB4ZW0gcmVlbHMvdmlkZW8KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJwZXJmb3JtX3JlZWxzX2FjdGlvbiBjaMawYSDEkcaw4bujYyBpbXBsZW1lbnQgY2hvIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcGVyZm9ybV9ub3RpZmljYXRpb25fYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyB4ZW0gdGjDtG5nIGLDoW8KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJwZXJmb3JtX25vdGlmaWNhdGlvbl9hY3Rpb24gY2jGsGEgxJHGsOG7o2MgaW1wbGVtZW50IGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fcHJvZmlsZV9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIHhlbSBwcm9maWxlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYicGVyZm9ybV9wcm9maWxlX2FjdGlvbiBjaMawYSDEkcaw4bujYyBpbXBsZW1lbnQgY2hvIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcGVyZm9ybV9leHBsb3JlX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcga2jDoW0gcGjDoS90w6xtIGhp4buDdQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmInBlcmZvcm1fZXhwbG9yZV9hY3Rpb24gY2jGsGEgxJHGsOG7o2MgaW1wbGVtZW50IGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fc2VhcmNoX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgdMOsbSBraeG6v20KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJwZXJmb3JtX3NlYXJjaF9hY3Rpb24gY2jGsGEgxJHGsOG7o2MgaW1wbGVtZW50IGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBNRVRIT0RTIEjhu5YgVFLhu6IgQ0hPIEFQUCBNQU5BR0VNRU5UCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIG9wZW5fYXBwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTeG7nyBhcHAgdMawxqFuZyDhu6luZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgcGFzcwogICAgCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBlbnN1cmVfaG9tZV9zY3JlZW4oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gxJFhbmcg4bufIG3DoG4gaMOsbmggaG9tZSAoaW1wbGVtZW50YXRpb24gY2h1bmcpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBtYXhfcmV0cmllcyA9IDMKICAgICAgICAKICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfcmV0cmllcyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgQsaw4bubYyAxOiBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICBjdXJyZW50X3BhY2thZ2UgPSBzZWxmLmhlbHBlci5nZXRfY3VycmVudF9wYWNrYWdlKCkKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJBcHAgY2jGsGEgbeG7nyAoaGnhu4duIHThuqFpOiB7Y3VycmVudF9wYWNrYWdlfSksIMSRYW5nIG3hu58gYXBwLi4uIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgICMgQ2jhu50gMTAgZ2nDonkgY2hvIGFwcCBraOG7n2kgxJHhu5luZwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDI6IEtp4buDbSB0cmEgY8OzIHBo4bqjaSB0cmFuZyBjaOG7pyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZygixJDDoyDhu58gbcOgbiBow6xuaCBob21lIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELGsOG7m2MgMzogVmFsaWRhdGUgYXBwIGtow7RuZyBi4buLIGJhbm5lZAogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYudmFsaWRhdGVfYXBwX25vdF9iYW5uZWQoKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJBcHAgYuG7iyBiYW5uZWQsIMSRw7NuZyB2w6AgbeG7nyBs4bqhaS4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuY2xvc2VfYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgyKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUgICMgUmV0cnkgdOG7qyDEkeG6p3UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IFjhu60gbMO9IGPDoWMgZGlhbG9nIHbDoCB24buBIGhvbWUKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9kaWFsb2dzX2FuZF9uYXZpZ2F0ZV9ob21lKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDU6IEtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiQXR0ZW1wdCB7YXR0ZW1wdCArIDF9OiBW4bqrbiBjaMawYSB24buBIMSRxrDhu6NjIGhvbWUgc2NyZWVuIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGVuc3VyZV9ob21lX3NjcmVlbiBhdHRlbXB0IHthdHRlbXB0ICsgMX06IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyB24buBIGhvbWUgc2NyZWVuIHNhdSB7bWF4X3JldHJpZXN9IGzhuqduIHRo4butIikKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiB2YWxpZGF0ZV9hcHBfbm90X2Jhbm5lZChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgYXBwIGPDsyBi4buLIGJhbm5lZCBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGtow7RuZyBi4buLIGJhbm5lZCwgRmFsc2UgbuG6v3UgYuG7iyBiYW5uZWQKICAgICAgICAiIiIKICAgICAgICBwYXNzCiAgICAKICAgIGRlZiBfaGFuZGxlX2RpYWxvZ3NfYW5kX25hdmlnYXRlX2hvbWUoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY8OhYyBkaWFsb2cgdsOgIG5hdmlnYXRlIHbhu4EgaG9tZSAoY8OzIHRo4buDIG92ZXJyaWRlIHRyb25nIHN1YmNsYXNzKQogICAgICAgICIiIgogICAgICAgICMgRGVmYXVsdCBpbXBsZW1lbnRhdGlvbiAtIHN1YmNsYXNzIGPDsyB0aOG7gyBvdmVycmlkZQogICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKCLEkGFuZyB44butIGzDvSBkaWFsb2dzIHbDoCBuYXZpZ2F0ZSB24buBIGhvbWUuLi4iKQogICAgICAgIAogICAgICAgICMgVGjhu60gbmjhuqVuIGJhY2sgbeG7mXQgdsOgaSBs4bqnbgogICAgICAgIGZvciBfIGluIHJhbmdlKDMpOgogICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSB24bqrbiBjaMawYSB24buBIMSRxrDhu6NjIGhvbWUsIHRo4butIHTDrG0gaG9tZSBidXR0b24KICAgICAgICBpZiBub3Qgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgaWYgbm90IGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iVHJhbmcgY2jhu6ciKQogICAgICAgICAgICBpZiBub3QgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJIb21lIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQoKICAgIEBhYnN0cmFjdG1ldGhvZAogICAgZGVmIGlzX2hvbWVfc2NyZWVuKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIOG7nyBtw6BuIGjDrG5oIGhvbWUga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkWFuZyDhu58gaG9tZSBzY3JlZW4KICAgICAgICAiIiIKICAgICAgICBwYXNzCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgTUVUSE9EUyBI4buWIFRS4buiIENITyBBQ1RJT04gV0VJR0hUUyBDT05GSUdVUkFUSU9OCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAKICAgIGRlZiBnZXRfYWN0aW9uX3dlaWdodHMoc2VsZikgLT4gRGljdFtzdHIsIGludF06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdOG7iSBs4buHIGjDoG5oIMSR4buZbmcgY2hvIGFwcCBuw6B5IC0gxrB1IHRpw6puIHThu6sgREIsIGZhbGxiYWNrIHbhu4EgZGVmYXVsdAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBpbnRdOiBU4buJIGzhu4cgaMOgbmggxJHhu5luZyB7YWN0aW9uX25hbWU6IHdlaWdodF9wZXJjZW50fQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX2NvbmZpZyA9IHNlbGYuZ2V0X2FwcF9jb25maWcoKQogICAgICAgICAgICByZXR1cm4gYXBwX2NvbmZpZy5nZXQoImFjdGlvbl93ZWlnaHRzIiwgc2VsZi5fZGVmYXVsdF9jb25maWdbImFjdGlvbl93ZWlnaHRzIl0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgbOG6pXkgYWN0aW9uIHdlaWdodHMsIGTDuW5nIGRlZmF1bHQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZWZhdWx0X2NvbmZpZ1siYWN0aW9uX3dlaWdodHMiXQogICAgCiAgICBkZWYgZ2V0X2FwcF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY29uZmlnIGNobyBhcHAgbsOgeSB04burIERCIHbhu5tpIHByaW9yaXR5OiBhcHBfY29uZmlnIOKGkiBnbG9iYWxfY29uZmlnIOKGkiBkZWZhdWx0CiAgICAgICAgTHXDtG4gxJHhu41jIHThu6sgREIsIGtow7RuZyBjYWNoZSDEkeG7gyBjw7MgdGjhu4MgdXBkYXRlIHF1YSBNUVRUCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IENvbmZpZyBj4bunYSBhcHAsIG1lcmdlIHRoZW8gcHJpb3JpdHkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgREIgc2VydmljZSDEkeG7gyBs4bqleSBjb25maWcgduG7m2kgcHJpb3JpdHkgbG9naWMKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZGIuZ2V0X2FwcF9jb25maWcoc2VsZi5hcHBfbmFtZSwgc2VsZi5fZGVmYXVsdF9jb25maWcpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgbOG6pXkgYXBwIGNvbmZpZywgZMO5bmcgZGVmYXVsdDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RlZmF1bHRfY29uZmlnLmNvcHkoKQogICAgCiAgICBkZWYgc2F2ZV9hcHBfY29uZmlnKHNlbGYsIGNvbmZpZ191cGRhdGVzOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IGNvbmZpZyBjaG8gYXBwIG7DoHkgdsOgbyBEQiAobWVyZ2UgduG7m2kgY29uZmlnIGhp4buHbiB04bqhaSkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfdXBkYXRlczogQ8OhYyBjb25maWcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5kYi51cGRhdGVfYXBwX2NvbmZpZyhzZWxmLmFwcF9uYW1lLCBjb25maWdfdXBkYXRlcykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgbMawdSBhcHAgY29uZmlnOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGluaXRfZGVmYXVsdF9hcHBfY29uZmlnKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyBhcHAgbuG6v3UgY2jGsGEgY8OzIHRyb25nIERCCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgY29uZmlnIGhp4buHbiB04bqhaSAoY2jhu4kgcmnDqm5nIGPhu6dhIGFwcCwga2jDtG5nIG1lcmdlKQogICAgICAgICAgICBhcHBfY29uZmlnX2tleSA9IGYie3NlbGYuYXBwX25hbWV9X2NvbmZpZyIKICAgICAgICAgICAgY3VycmVudF9hcHBfY29uZmlnID0gc2VsZi5kYi5nZXQoYXBwX2NvbmZpZ19rZXksIHt9KQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYXBwX2NvbmZpZzoKICAgICAgICAgICAgICAgICMgQ2jGsGEgY8OzIGNvbmZpZyByacOqbmcgY2hvIGFwcCwgbMawdSBkZWZhdWx0CiAgICAgICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5zZXRfYXBwX2NvbmZpZyhzZWxmLmFwcF9uYW1lLCBzZWxmLl9kZWZhdWx0X2NvbmZpZykKICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6Mga2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyB7c2VsZi5hcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3MKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgxJDDoyBjw7MgY29uZmlnLCBraeG7g20gdHJhIHbDoCBi4buVIHN1bmcgY8OhYyBrZXlzIHRoaeG6v3UKICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgZm9yIGtleSwgZGVmYXVsdF92YWx1ZSBpbiBzZWxmLl9kZWZhdWx0X2NvbmZpZy5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIGlmIGtleSBub3QgaW4gY3VycmVudF9hcHBfY29uZmlnOgogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2FwcF9jb25maWdba2V5XSA9IGRlZmF1bHRfdmFsdWUKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZCA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBTcGVjaWFsIGNoZWNrIGNobyBhY3Rpb25fd2VpZ2h0cwogICAgICAgICAgICAgICAgaWYgImFjdGlvbl93ZWlnaHRzIiBpbiBjdXJyZW50X2FwcF9jb25maWcgYW5kICJhY3Rpb25fd2VpZ2h0cyIgaW4gc2VsZi5fZGVmYXVsdF9jb25maWc6CiAgICAgICAgICAgICAgICAgICAgZm9yIGFjdGlvbiwgd2VpZ2h0IGluIHNlbGYuX2RlZmF1bHRfY29uZmlnWyJhY3Rpb25fd2VpZ2h0cyJdLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFjdGlvbiBub3QgaW4gY3VycmVudF9hcHBfY29uZmlnWyJhY3Rpb25fd2VpZ2h0cyJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9hcHBfY29uZmlnWyJhY3Rpb25fd2VpZ2h0cyJdW2FjdGlvbl0gPSB3ZWlnaHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWQ6CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2V0X2FwcF9jb25maWcoc2VsZi5hcHBfbmFtZSwgY3VycmVudF9hcHBfY29uZmlnKQogICAgICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCBjb25maWcgdGhp4bq/dSBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3VjY2VzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBLaMO0bmcgY+G6p24gdXBkYXRlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGto4bufaSB04bqhbyBkZWZhdWx0IGFwcCBjb25maWc6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgZ2V0X21pbl9hY3Rpb25zX3Blcl9zZXNzaW9uKHNlbGYpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBz4buRIGFjdGlvbiB04buRaSB0aGnhu4N1IG3hu5dpIHNlc3Npb24gdOG7qyBjb25maWcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFPhu5EgYWN0aW9uIHThu5FpIHRoaeG7g3UKICAgICAgICAiIiIKICAgICAgICBhcHBfY29uZmlnID0gc2VsZi5nZXRfYXBwX2NvbmZpZygpCiAgICAgICAgcmV0dXJuIGFwcF9jb25maWcuZ2V0KCJtaW5fYWN0aW9uc19wZXJfc2Vzc2lvbiIsIDUpCiAgICAKICAgIGRlZiBnZXRfbWF4X3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyhzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gdOG7kWkgxJFhIG3hu5dpIHNlc3Npb24gdOG7qyBjb25maWcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRo4budaSBnaWFuIHThu5FpIMSRYSAocGjDunQpCiAgICAgICAgIiIiCiAgICAgICAgYXBwX2NvbmZpZyA9IHNlbGYuZ2V0X2FwcF9jb25maWcoKQogICAgICAgIHJldHVybiBhcHBfY29uZmlnLmdldCgibWF4X3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyIsIDMwKQogICAgCiAgICBkZWYgZ2V0X2FjdGlvbl9kZWxheV9yYW5nZShzZWxmKSAtPiB0dXBsZVtpbnQsIGludF06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkga2hv4bqjbmcgZGVsYXkgZ2nhu69hIGPDoWMgYWN0aW9ucyB04burIGNvbmZpZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHR1cGxlW2ludCwgaW50XTogKG1pbl9kZWxheSwgbWF4X2RlbGF5KSB0cm9uZyBnacOieQogICAgICAgICIiIgogICAgICAgIGFwcF9jb25maWcgPSBzZWxmLmdldF9hcHBfY29uZmlnKCkKICAgICAgICBtaW5fZGVsYXkgPSBhcHBfY29uZmlnLmdldCgiYWN0aW9uX2RlbGF5X21pbiIsIDMpCiAgICAgICAgbWF4X2RlbGF5ID0gYXBwX2NvbmZpZy5nZXQoImFjdGlvbl9kZWxheV9tYXgiLCAxMCkKICAgICAgICByZXR1cm4gKG1pbl9kZWxheSwgbWF4X2RlbGF5KQogICAgCiAgICBkZWYgc2hvdWxkX3NraXBfam9iX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIGPDsyBuw6puIHNraXAgam9iIGFjdGlvbiBraMO0bmcgZOG7sWEgdHLDqm4gY29uZmlnIHbDoCB0cuG6oW5nIHRow6FpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuw6puIHNraXAgam9iIGFjdGlvbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFjdGlvbl93ZWlnaHRzIMSR4buDIHF1eeG6v3QgxJHhu4tuaCBjw7MgbMOgbSBqb2Iga2jDtG5nCiAgICAgICAgICAgIGFjdGlvbl93ZWlnaHRzID0gc2VsZi5nZXRfYWN0aW9uX3dlaWdodHMoKQogICAgICAgICAgICBqb2Jfd2VpZ2h0ID0gYWN0aW9uX3dlaWdodHMuZ2V0KCJqb2IiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBqb2Igd2VpZ2h0ID0gMCB0aMOsIHNraXAgam9iIGFjdGlvbgogICAgICAgICAgICBpZiBqb2Jfd2VpZ2h0ID09IDA6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDoWMgxJFp4buBdSBraeG7h24gam9iIHRoxrDhu51uZwogICAgICAgICAgICByZXR1cm4gbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtp4buDbSB0cmEgc2tpcCBqb2IgYWN0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBBbiB0b8OgbiAtIHNraXAgbuG6v3UgbOG7l2kKICAgIAogICAgZGVmIGdldF9zdXBwb3J0ZWRfYWN0aW9ucyhzZWxmKSAtPiBMaXN0W3N0cl06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGFuaCBzw6FjaCBow6BuaCDEkeG7mW5nIMSRxrDhu6NjIGjhu5cgdHLhu6MgYuG7n2kgYXBwIG7DoHkKICAgICAgICBBcHAgY8OzIHRo4buDIG92ZXJyaWRlIMSR4buDIGjhu5cgdHLhu6MgY8OhYyBow6BuaCDEkeG7mW5nIGtow6FjIG5oYXUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W3N0cl06IERhbmggc8OhY2ggYWN0aW9uIG5hbWVzIMSRxrDhu6NjIGjhu5cgdHLhu6MKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gbGlzdChzZWxmLmdldF9hY3Rpb25fd2VpZ2h0cygpLmtleXMoKSkKICAgIAogICAgZGVmIHBlcmZvcm1fYWN0aW9uKHNlbGYsIGFjdGlvbjogc3RyLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgxJHGsOG7o2MgY2jhu4kgxJHhu4tuaCB24bubaSBjb25maWctYmFzZWQgbG9naWMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY3Rpb246IFTDqm4gaMOgbmggxJHhu5luZwogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFjdGlvbiBjw7MgxJHGsOG7o2MgaOG7lyB0cuG7oyBraMO0bmcKICAgICAgICAgICAgaWYgYWN0aW9uIG5vdCBpbiBzZWxmLmdldF9zdXBwb3J0ZWRfYWN0aW9ucygpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkFjdGlvbiAne2FjdGlvbn0nIGtow7RuZyDEkcaw4bujYyBo4buXIHRy4bujIGLhu59pIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjhu60gbMO9IMSR4bq3YyBiaeG7h3QgY2hvIGpvYiBhY3Rpb24gZOG7sWEgdHLDqm4gY29uZmlnCiAgICAgICAgICAgIGlmIGFjdGlvbiA9PSAiam9iIjoKICAgICAgICAgICAgICAgIGlmIHNlbGYuc2hvdWxkX3NraXBfam9iX2FjdGlvbihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU2tpcCBqb2IgYWN0aW9uIGNobyB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSB0aGVvIGNvbmZpZyIpCiAgICAgICAgICAgICAgICAgICAgIyBUaGF5IHRo4bq/IGLhurFuZyBhY3Rpb24ga2jDoWMgKGtow7RuZyBwaOG6o2kgam9iKQogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0aXZlX2FjdGlvbiA9IHNlbGYuX2Nob29zZV9hbHRlcm5hdGl2ZV9hY3Rpb24oKQogICAgICAgICAgICAgICAgICAgIGlmIGFsdGVybmF0aXZlX2FjdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24ge2FsdGVybmF0aXZlX2FjdGlvbn0gdGhheSBjaG8gam9iIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucGVyZm9ybV9hY3Rpb24oYWx0ZXJuYXRpdmVfYWN0aW9uLCBhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIE7hur91IGtow7RuZyBjw7MgYWx0ZXJuYXRpdmUsIGNvaSBuaMawIHRow6BuaCBjw7RuZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSBn4buNaSBtZXRob2QgxJHhu5luZyBjaG8gYWN0aW9uIHTDuXkgY2jhu4luaCB0csaw4bubYwogICAgICAgICAgICBjdXN0b21fbWV0aG9kX25hbWUgPSBmInBlcmZvcm1fe2FjdGlvbn1fYWN0aW9uIgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsIGN1c3RvbV9tZXRob2RfbmFtZSk6CiAgICAgICAgICAgICAgICBjdXN0b21fbWV0aG9kID0gZ2V0YXR0cihzZWxmLCBjdXN0b21fbWV0aG9kX25hbWUpCiAgICAgICAgICAgICAgICBpZiBjYWxsYWJsZShjdXN0b21fbWV0aG9kKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU+G7rSBk4bulbmcgY3VzdG9tIG1ldGhvZCAne2N1c3RvbV9tZXRob2RfbmFtZX0nIGNobyBhY3Rpb24gJ3thY3Rpb259JyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1c3RvbV9tZXRob2QoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTWFwcGluZyBjw6FjIGFjdGlvbnMgdOG7m2kgbWV0aG9kcyBjaHXhuqluCiAgICAgICAgICAgIHN0YW5kYXJkX2FjdGlvbl9tZXRob2RzID0gewogICAgICAgICAgICAgICAgIm5ld3NmZWVkIjogc2VsZi5wZXJmb3JtX25ld3NmZWVkX2FjdGlvbiwKICAgICAgICAgICAgICAgICJyZWVscyI6IHNlbGYucGVyZm9ybV9yZWVsc19hY3Rpb24sCiAgICAgICAgICAgICAgICAibm90aWZpY2F0aW9uIjogc2VsZi5wZXJmb3JtX25vdGlmaWNhdGlvbl9hY3Rpb24sCiAgICAgICAgICAgICAgICAicHJvZmlsZSI6IHNlbGYucGVyZm9ybV9wcm9maWxlX2FjdGlvbiwKICAgICAgICAgICAgICAgICJqb2IiOiBzZWxmLnBlcmZvcm1fam9iX2FjdGlvbiwKICAgICAgICAgICAgICAgICJleHBsb3JlIjogc2VsZi5wZXJmb3JtX2V4cGxvcmVfYWN0aW9uLAogICAgICAgICAgICAgICAgInNlYXJjaCI6IHNlbGYucGVyZm9ybV9zZWFyY2hfYWN0aW9uLAogICAgICAgICAgICAgICAgInBvc3QiOiBzZWxmLnBlcmZvcm1fcG9zdF9hY3Rpb24KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBtZXRob2QgdMawxqFuZyDhu6luZyB24bubaSBhY3Rpb24KICAgICAgICAgICAgYWN0aW9uX21ldGhvZCA9IHN0YW5kYXJkX2FjdGlvbl9tZXRob2RzLmdldChhY3Rpb24pCiAgICAgICAgICAgIGlmIG5vdCBhY3Rpb25fbWV0aG9kOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBtZXRob2QgY2hvIGFjdGlvbiAne2FjdGlvbn0nIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGFjdGlvbgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBhY3Rpb24gJ3thY3Rpb259JyBjaG8ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICByZXR1cm4gYWN0aW9uX21ldGhvZChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgdGjhu7FjIGhp4buHbiBhY3Rpb24gJ3thY3Rpb259Jzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfY2hvb3NlX2FsdGVybmF0aXZlX2FjdGlvbihzZWxmKSAtPiBPcHRpb25hbFtzdHJdOgogICAgICAgICIiIgogICAgICAgIENo4buNbiBhY3Rpb24gdGhheSB0aOG6vyBraGkga2jDtG5nIHRo4buDIGzDoG0gam9iCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBUw6puIGFjdGlvbiB0aGF5IHRo4bq/LCBob+G6t2MgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBhY3Rpb24gd2VpZ2h0cyBraMO0bmcgYmFvIGfhu5NtIGpvYgogICAgICAgICAgICBhY3Rpb25fd2VpZ2h0cyA9IHNlbGYuZ2V0X2FjdGlvbl93ZWlnaHRzKCkKICAgICAgICAgICAgYWx0ZXJuYXRpdmVfd2VpZ2h0cyA9IHtrOiB2IGZvciBrLCB2IGluIGFjdGlvbl93ZWlnaHRzLml0ZW1zKCkgaWYgayAhPSAiam9iIn0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBhbHRlcm5hdGl2ZV93ZWlnaHRzOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu41uIHJhbmRvbSB0aGVvIHdlaWdodAogICAgICAgICAgICBhY3Rpb25zID0gbGlzdChhbHRlcm5hdGl2ZV93ZWlnaHRzLmtleXMoKSkKICAgICAgICAgICAgd2VpZ2h0cyA9IGxpc3QoYWx0ZXJuYXRpdmVfd2VpZ2h0cy52YWx1ZXMoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNob3Nlbl9hY3Rpb24gPSByYW5kb20uY2hvaWNlcyhhY3Rpb25zLCB3ZWlnaHRzPXdlaWdodHMsIGs9MSlbMF0KICAgICAgICAgICAgcmV0dXJuIGNob3Nlbl9hY3Rpb24KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgY2jhu41uIGFsdGVybmF0aXZlIGFjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICJuZXdzZmVlZCIgICMgRmFsbGJhY2sgdG8gbmV3c2ZlZWQKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9hY3Rpb25zX25lZWRlZF9mb3Jfc2Vzc2lvbihzZWxmLCBhY2NvdW50czogTGlzdFtEaWN0W3N0ciwgQW55XV0pIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUw61uaCB0b8OhbiBz4buRIGFjdGlvbnMgY+G6p24gdGhp4bq/dCBjaG8gc2Vzc2lvbiBk4buxYSB0csOqbiBjb25maWcgdsOgIHPhu5Egam9icyBjw7MgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBT4buRIGFjdGlvbnMgY+G6p24gdGjhu7FjIGhp4buHbiB0cm9uZyBzZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGNvbmZpZyBtaW4gYWN0aW9ucwogICAgICAgICAgICBtaW5fYWN0aW9ucyA9IHNlbGYuZ2V0X21pbl9hY3Rpb25zX3Blcl9zZXNzaW9uKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhur9tIHPhu5EgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIGpvYgogICAgICAgICAgICBqb2JfY2FwYWJsZV9hY2NvdW50cyA9IDAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zaG91bGRfc2tpcF9qb2JfYWN0aW9uKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIGpvYl9jYXBhYmxlX2FjY291bnRzICs9IDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQmFzZSBhY3Rpb25zIGThu7FhIHRyw6puIHPhu5EgdMOgaSBraG/huqNuCiAgICAgICAgICAgICMgTeG7l2kgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIGpvYiBz4bq9IHTGsMahbmcg4bupbmcgduG7m2kgMi0zIGFjdGlvbnMKICAgICAgICAgICAgZGVmYXVsdF9hY3Rpb25zX3Blcl9hY2NvdW50ID0gMi41CiAgICAgICAgICAgIGFjdGlvbnNfZnJvbV9hY2NvdW50cyA9IGludChqb2JfY2FwYWJsZV9hY2NvdW50cyAqIGRlZmF1bHRfYWN0aW9uc19wZXJfYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgbWF4IGdp4buvYSBhY3Rpb25zIHThu6sgYWNjb3VudHMgdsOgIG1pbiBhY3Rpb25zCiAgICAgICAgICAgIHRvdGFsX2FjdGlvbnMgPSBtYXgoYWN0aW9uc19mcm9tX2FjY291bnRzLCBtaW5fYWN0aW9ucykKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw61uaCB0b8OhbiBhY3Rpb25zIGNobyBzZXNzaW9uOiB7am9iX2NhcGFibGVfYWNjb3VudHN9IGFjY291bnRzIGPDsyB0aOG7gyBsw6BtIHZp4buHYywgIgogICAgICAgICAgICAgICAgICAgICAgICAgICBmIntkZWZhdWx0X2FjdGlvbnNfcGVyX2FjY291bnR9IGFjdGlvbnMvYWNjb3VudCA9IHthY3Rpb25zX2Zyb21fYWNjb3VudHN9IGFjdGlvbnMgdOG7qyBhY2NvdW50cywgIgogICAgICAgICAgICAgICAgICAgICAgICAgICBmIm1pbiB7bWluX2FjdGlvbnN9ID0+IHRvdGFsIHt0b3RhbF9hY3Rpb25zfSBhY3Rpb25zIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0b3RhbF9hY3Rpb25zCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSB0w61uaCB0b8OhbiBhY3Rpb25zIG5lZWRlZDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X21pbl9hY3Rpb25zX3Blcl9zZXNzaW9uKCkgICMgRmFsbGJhY2sKICAgIAogICAgZGVmIGNob29zZV93ZWlnaHRlZF9hY3Rpb24oc2VsZiwgZXhjbHVkZV9hY3Rpb25zOiBMaXN0W3N0cl0gPSBOb25lKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhu41uIGFjdGlvbiB0aGVvIHdlaWdodCB04burIGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGV4Y2x1ZGVfYWN0aW9uczogRGFuaCBzw6FjaCBhY3Rpb25zIGPhuqduIGxv4bqhaSB0cuG7qwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IEFjdGlvbiDEkcaw4bujYyBjaOG7jW4KICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY3Rpb25fd2VpZ2h0cyA9IHNlbGYuZ2V0X2FjdGlvbl93ZWlnaHRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG/huqFpIHRy4burIGFjdGlvbnMga2jDtG5nIG1vbmcgbXXhu5FuCiAgICAgICAgICAgIGlmIGV4Y2x1ZGVfYWN0aW9uczoKICAgICAgICAgICAgICAgIGFjdGlvbl93ZWlnaHRzID0ge2s6IHYgZm9yIGssIHYgaW4gYWN0aW9uX3dlaWdodHMuaXRlbXMoKSBpZiBrIG5vdCBpbiBleGNsdWRlX2FjdGlvbnN9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWN0aW9uX3dlaWdodHM6CiAgICAgICAgICAgICAgICByZXR1cm4gIm5ld3NmZWVkIiAgIyBGYWxsYmFjawogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7jW4gcmFuZG9tIHRoZW8gd2VpZ2h0CiAgICAgICAgICAgIGFjdGlvbnMgPSBsaXN0KGFjdGlvbl93ZWlnaHRzLmtleXMoKSkKICAgICAgICAgICAgd2VpZ2h0cyA9IGxpc3QoYWN0aW9uX3dlaWdodHMudmFsdWVzKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICBjaG9zZW5fYWN0aW9uID0gcmFuZG9tLmNob2ljZXMoYWN0aW9ucywgd2VpZ2h0cz13ZWlnaHRzLCBrPTEpWzBdCiAgICAgICAgICAgIHJldHVybiBjaG9zZW5fYWN0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGNo4buNbiB3ZWlnaHRlZCBhY3Rpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAibmV3c2ZlZWQiICAjIEZhbGxiYWNrCiAgICAKICAgIGRlZiBwZXJmb3JtX2pvYl9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIGzDoG0gam9iIC0gQ29tcGxldGUgam9iIHByb2Nlc3NpbmcgcGlwZWxpbmUKICAgICAgICAKICAgICAgICBQaXBlbGluZToKICAgICAgICAxLiBWYWxpZGF0ZSBHb0xpa2UgaGVhZGVycwogICAgICAgIDIuIFZhbGlkYXRlIGFjY291bnQgY2FuIHJ1biBqb2IKICAgICAgICAzLiBGZXRjaCBqb2IgZnJvbSBHb0xpa2UgIAogICAgICAgIDQuIFVwZGF0ZSBkZXZpY2UgbWVzc2FnZQogICAgICAgIDUuIFZhbGlkYXRlIGpvYiBiZWZvcmUgZXhlY3V0aW9uCiAgICAgICAgNi4gRXhlY3V0ZSBqb2IKICAgICAgICA3LiBSZXBvcnQgam9iIHJlc3VsdCB0byBHb0xpa2UKICAgICAgICA4LiBVcGRhdGUgam9iIHN0YXRpc3RpY3MKICAgICAgICAKICAgICAgICBBcHAgY8OzIHRo4buDIG92ZXJyaWRlIMSR4buDIGPDsyBsb2dpYyBsw6BtIGpvYiByacOqbmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTMOgbSBqb2IgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDA6IEtp4buDbSB0cmEgeMOhYyB0aOG7sWMgR29MaWtlCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmlzX2dvbGlrZV9hdXRoZW50aWNhdGVkKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBLaeG7g20gdHJhIGPDsyB0aOG7gyBsw6BtIGpvYiBraMO0bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkFjY291bnQge3VzZXJuYW1lfSBraMO0bmcgdGjhu4MgbMOgbSBqb2IiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogRmV0Y2ggam9iIHThu6sgR29MaWtlCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJM4bqleSBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgam9iID0gc2VsZi5mZXRjaF9qb2IoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgbOG6pXkgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDM6IEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZSBjaG8gam9iCiAgICAgICAgICAgIHNlbGYudXBkYXRlX2RldmljZV9tZXNzYWdlX2Zvcl9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IFZhbGlkYXRlIGpvYgogICAgICAgICAgICBpZiBub3Qgc2VsZi52YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKGFjY291bnQsIGpvYik6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSm9iIGtow7RuZyBo4bujcCBs4buHIGhv4bq3YyDEkcOjIHNraXAgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDU6IFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtqb2IuZ2V0KCd0eXBlJywgJ3Vua25vd24nKX0iKQogICAgICAgICAgICBqb2JfcmVzdWx0ID0gc2VsZi5leGVjdXRlX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgam9iX3Jlc3VsdDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIG5o4bqtbiDEkcaw4bujYyBr4bq/dCBxdeG6oyBqb2IgdOG7qyBoYW5kbGVyIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDY6IELDoW8gY8OhbyBr4bq/dCBxdeG6oyB24buBIEdvTGlrZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCBqb2JfcmVzdWx0KQogICAgICAgICAgICAgICAgc3VjY2VzcyA9IGpvYl9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBiw6FvIGPDoW8gam9iIGNobyB7dXNlcm5hbWV9OiBzdWNjZXNzPXtzdWNjZXNzfSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBiw6FvIGPDoW8gam9iIGNobyB7dXNlcm5hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDc6IEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IKICAgICAgICAgICAgc3VjY2VzcyA9IGpvYl9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpCiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9qb2Jfc3RhdHMoYWNjb3VudCwgc3VjY2Vzcywgam9iX3R5cGUsIGpvYl9yZXN1bHQpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gc3VjY2VzcwogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgbMOgbSBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSBqb2Iga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgICAgICBhY2NvdW50X3N0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgaW4gWyJkaXNhYmxlZCIsICJsb2dvdXQiXToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBpbmFjdGl2ZSwga2nhu4NtIHRyYSBqb2JfZGlzYWJsZV91bnRpbAogICAgICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPiB0aW1lLnRpbWUoKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gS2nhu4NtIHRyYSBqb2JfZW5hYmxlCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBLaeG7g20gdHJhIMSRw6MgbGnDqm4ga+G6v3QgR29MaWtlIChj4bqnbiBjaG8gam9icykKICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDQuIEtp4buDbSB0cmEgxJHDoyBsb2dpbgogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGRhaWx5CiAgICAgICAgICAgIGRhaWx5X2xpbWl0ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMTAwKQogICAgICAgICAgICBkYWlseV9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgICAgICBpZiBkYWlseV9jb3VudCA+PSBkYWlseV9saW1pdDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgY2FuIHJ1biBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3ZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIGpvYiB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbgogICAgICAgIEFwcCBjw7MgdGjhu4Mgb3ZlcnJpZGUgxJHhu4MgY8OzIGxvZ2ljIHZhbGlkYXRlIHJpw6puZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBqb2IgaOG7o3AgbOG7hwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBzZWxmLnZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYikKICAgICAgICAgICAgaWYgbm90IHZhbGlkYXRpb25fcmVzdWx0LmdldCgidmFsaWQiLCBUcnVlKToKICAgICAgICAgICAgICAgIGlmIHZhbGlkYXRpb25fcmVzdWx0LmdldCgic2hvdWxkX3NraXAiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlNraXAgam9iIHRoZW8gecOqdSBj4bqndSB2YWxpZGF0aW9uIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hyB0aGVvIHZhbGlkYXRpb24iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgdmFsaWRhdGUgam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBUaeG6v3AgdOG7pWMgbuG6v3UgdmFsaWRhdGUgbOG7l2kKICAgIAogICAgZGVmIHVwZGF0ZV9kZXZpY2VfbWVzc2FnZV9mb3Jfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgZGV2aWNlIG1lc3NhZ2UgY2hvIGpvYiBoaeG7h24gdOG6oWkKICAgICAgICBBcHAgY8OzIHRo4buDIG92ZXJyaWRlIMSR4buDIGN1c3RvbSBtZXNzYWdlIGZvcm1hdAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxpbmsgPSBqb2IuZ2V0KCdsaW5rJywgJycpCiAgICAgICAgICAgICMgQ2xlYW4gdXAgbGluayDEkeG7gyBoaeG7g24gdGjhu4sgbmfhuq9uIGfhu41uIGjGoW4KICAgICAgICAgICAgaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycpOgogICAgICAgICAgICAgICAgbGluayA9IGxpbmsucmVwbGFjZSgnaHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS8nLCAnJykKICAgICAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy50aWt0b2suY29tLycsICcnKQogICAgICAgICAgICAKICAgICAgICAgICAgbWVzc2FnZSA9IGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZSB0aMO0bmcgcXVhIGRiIHNlcnZpY2UKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIG1lc3NhZ2UpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZToge2V9IikKICAgIAogICAgZGVmIHZhbGlkYXRlX2pvYl93aXRoX2hhbmRsZXIoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgam9iIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duIC0gc+G7rSBk4bulbmcgYWJzdHJhY3QgbWV0aG9kIHZhbGlkYXRpb24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGPhuqduIHNraXAgaG/hurdjIGNvbnRpbnVlCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWxpZGF0aW9uX3Jlc3VsdCA9IHNlbGYudmFsaWRhdGVfam9iX2JlZm9yZV9leGVjdXRpb24oYWNjb3VudCwgam9iKQogICAgICAgICAgICBpZiBub3QgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJ2YWxpZCIsIFRydWUpOgogICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAjIFNraXAgam9iCiAgICAgICAgICAgICAgICAgICAgc2tpcF9tZXNzYWdlID0gdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIkpvYiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlNraXAgam9iOiB7c2tpcF9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIEdoaSBs4bqhaSBoaXN0b3J5IGNobyBqb2IgYuG7iyBza2lwCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHNraXBfbWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAjIELDoW8gc2tpcCBqb2IgduG7gSBHb0xpa2UKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiU2tpcCBqb2IgbOG7l2k6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBTbGVlcCBuZ+G6r24gxJHhu4MgdHLDoW5oIHNwYW0KICAgICAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zbGVlcF9mdW5jKHNraXBfc2xlZXBfdGltZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hzoge3ZhbGlkYXRpb25fcmVzdWx0LmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIHZhbGlkYXRlIGpvYjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgVGnhur9wIHThu6VjIG7hur91IHZhbGlkYXRlIGzhu5dpCiAgICAKICAgIGRlZiB1cGRhdGVfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sLCBqb2JfdHlwZTogc3RyLCBqb2JfcmVzdWx0OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYiAtIGFwcCBjw7MgdGjhu4Mgb3ZlcnJpZGUgxJHhu4MgY3VzdG9tIGxvZ2ljCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc3VjY2VzczogSm9iIGPDsyB0aMOgbmggY8O0bmcga2jDtG5nCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iCiAgICAgICAgICAgIGpvYl9yZXN1bHQ6IEvhur90IHF14bqjIGpvYgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgIyBUxINuZyBqb2IgY291bnQgY2hvIGFjY291bnQKICAgICAgICAgICAgICAgIGN1cnJlbnRfY291bnQgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICAgICAgICAgIG5ld19jb3VudCA9IGN1cnJlbnRfY291bnQgKyAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMSDbmcgdG90YWwgam9icwogICAgICAgICAgICAgICAgY3VycmVudF90b3RhbCA9IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkKICAgICAgICAgICAgICAgIG5ld190b3RhbCA9IGN1cnJlbnRfdG90YWwgKyAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGpvYiBjb3VudCB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IG5ld19jb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBuZXdfdG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJD4bqtcCBuaOG6rXQgam9iIGNvdW50IGNobyBhY2NvdW50IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9OiB0b2RheT17bmV3X2NvdW50fSwgdG90YWw9e25ld190b3RhbH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBj4bqtcCBuaOG6rXQgam9iIHN0YXRzOiB7ZX0iKQ==').decode('utf-8'))
