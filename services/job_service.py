import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIERFRkFVTFRfTUFYX0ZPTExPV19EQVkgPSAyMAogICAgREVGQVVMVF9NQVhfRk9MTE9XX1NFU1NJT04gPSA1CiAgICBNQVhfV0FSTklOR19MT0dTID0gMjAKICAgIAogICAgIyBTdGF0dXMgbWVzc2FnZXMKICAgIE1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUiA9ICJU4bqhbSBk4burbmcgKFNldmVyIHnDqnUgY+G6p3UpIgogICAgTVNHX0RFVklDRV9OT19BQ0NPVU5UUyA9ICJU4bqhbSBuZ2jhu4kgKEtow7RuZyBjw7MgdMOgaSBraG/huqNuKSIKICAgIE1TR19XQUlUSU5HX1BST1hZID0gIsSQYW5nIGNo4budIHByb3h5IgogICAgTVNHX1dPUktJTkdfU0VTU0lPTiA9ICLEkGFuZyB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiCiAgICBNU0dfU0VTU0lPTl9DT09MRE9XTiA9ICJOZ2jhu4kgbmfGoWkgZ2nhu69hIGPDoWMgcGhpw6puIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX1NFU1NJT05fTElNSVQgPSAixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIKICAgIFJFQVNPTl9GT0xMT1dfREFJTFlfTElNSVQgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xvdyB0cm9uZyBwaGnDqm4iCiAgICBSRUFTT05fRk9MTE9XX1NFU1NJT05fTElNSVQgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xsb3cgdHJvbmcgcGhpw6puIgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLmpvYl9oYW5kbGVycyA9IHt9CiAgICAgICAgCiAgICAgICAgIyBGbGFnIMSRaeG7gXUga2hp4buDbgogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgVGjDtG5nIHRpbiB24buBIGPDoWMgYXBwIMSRxrDhu6NjIGvDrWNoIGhv4bqhdCAtIGzhuqV5IHThu6sgZGF0YWJhc2UgaG/hurdjIGNvbmZpZwogICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBMb2NrIMSR4buDIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpCiAgICAgICAgc2VsZi5fbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICAKICAgICAgICAjIERpY3Rpb25hcnkgxJHhu4MgbMawdSBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBqb2IgZm9sbG93IHRy4bqjIHbhu4Egc3RhdHVzIDQgKHBlbmRpbmcpCiAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMgPSB7fQogICAgICAgIAogICAgICAgICMgVHLhuqFuZyB0aMOhaSBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfaWQgPSBOb25lCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBOb25lCiAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gdGjhuqV0IGLhuqFpIGtoaSBzZXR1cCBwcm94eQogICAgICAgIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA9IDAKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMga2hpIGZvcmNlX3N0b3AgxJHGsOG7o2MgxJHhurd0IHRow6BuaCBUcnVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGNoZWNrX2ludGVydmFsID0gSm9iU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMICAjIEtp4buDbSB0cmEgbeG7l2kgMC41IGdpw6J5CiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyB5w6p1IGPhuqd1IGThu6tuZwogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmfhu6cgbeG7mXQga2hv4bqjbmcgbmfhuq9uCiAgICAgICAgICAgIHNsZWVwX3RpbWUgPSBtaW4oY2hlY2tfaW50ZXJ2YWwsIHNlY29uZHMgLSAodGltZS50aW1lKCkgLSBzdGFydF90aW1lKSkKICAgICAgICAgICAgaWYgc2xlZXBfdGltZSA+IDA6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHNsZWVwX3RpbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBpbml0aWFsaXplKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSB04bqhbyB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICAgICAgIyAxLiBLaeG7g20gdHJhIEhlbHBlclNlcnZpY2UKICAgICAgICBoZWxwZXJfc3VjY2VzcywgaGVscGVyX2RhdGEgPSB1dGlscy5jaGVja19oZWxwZXJfc2VydmljZShzZWxmLmhlbHBlcikKICAgICAgICBpZiBub3QgaGVscGVyX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGvhur90IG7hu5FpIMSR4bq/biBIZWxwZXJTZXJ2aWNlLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBMxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIG7hur91IGPDswogICAgICAgIGlmIGhlbHBlcl9kYXRhIGFuZCAiZGF0YSIgaW4gaGVscGVyX2RhdGE6CiAgICAgICAgICAgIHNlbGYuZGIuc2F2ZV9kZXZpY2VfaW5mbyhoZWxwZXJfZGF0YSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4s6IHtoZWxwZXJfZGF0YVsnZGF0YSddLmdldCgnZGV2aWNlX21vZGVsJywgJ1Vua25vd24nKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgIyAzLiBMxrB1IGPDoWMgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIG7hur91IGNoxrBhIGPDswogICAgICAgIHNlbGYuX3NhdmVfZGVmYXVsdF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgIyA0LiBLaeG7g20gdHJhIHbDoCBs4bqleSBHb0xpa2UgaGVhZGVycyBu4bq/dSBj4bqnbgogICAgICAgIGdvbGlrZV9zdWNjZXNzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KCkKICAgICAgICBpZiBub3QgZ29saWtlX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIDUuIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5faW5pdF9qb2JfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgNi4gS2jhu59pIHThuqFvIG5nw6B5IGN14buRaSBjw7luZyDEkcOjIHJlc2V0IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgICMgTuG6v3UgaGnhu4duIHThuqFpIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5LCDEkcOhbmggZOG6pXUgxJHDoyByZXNldAogICAgICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE7hur91IGNoxrBhIMSR4bq/biBnaeG7nSByZXNldCwgxJHDoW5oIGThuqV1IGzDoCDEkcOjIHJlc2V0IG5nw6B5IGjDtG0gcXVhCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheSAtIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIGxhc3RfcmVzZXRfZGF0ZS5pc29mb3JtYXQoKSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gbmfDoHkgcmVzZXQ6IHtsYXN0X3Jlc2V0X2RhdGV9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgIAogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBKb2JTZXJ2aWNlIHRow6BuaCBjw7RuZy4iKQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24ga2nhu4NtIHRyYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaSwgRmFsc2UgbuG6v3Uga2jDtG5nIGPhuqduCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB04burIGRhdGFiYXNlCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIHN5bmNfc3RhdHVzID0gc2VsZi5kYi5nZXQoc3luY19zdGF0dXNfa2V5LCBGYWxzZSkgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG7k25nIGLhu5kgdGjDrCBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWkKICAgICAgICByZXR1cm4gbm90IHN5bmNfc3RhdHVzCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIHN0YXR1czogYm9vbCA9IFRydWUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIHN0YXR1czogVHJ1ZSBu4bq/dSDEkcOjIMSR4buTbmcgYuG7mSwgRmFsc2UgbuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgIiIiCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgc2VsZi5kYi5zZXQoc3luY19zdGF0dXNfa2V5LCBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfToge3N0YXR1c30iKQogICAgICAgIAogICAgZGVmIF9zeW5jX2FjY291bnRzX2Zvcl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8gbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gxJHhu5NuZyBi4buZCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CgogICAgICAgICAgICAjIDEuIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gTWFwIHTDoGkga2hv4bqjbiBHb0xpa2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBnb2xpa2VfYWNjb3VudHMgPSBoYW5kbGVyLmdldF9nb2xpa2VfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IHtsZW4oZ29saWtlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgw4FuaCB44bqhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgbWFwcGVkX2FjY291bnRzID0gaGFuZGxlci5tYXBfZ29saWtlX2FjY291bnRzKGdvbGlrZV9hY2NvdW50cywgZGV2aWNlX2FjY291bnRzKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mgw6FuaCB44bqhIHtsZW4obWFwcGVkX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0gduG7m2kgR29MaWtlIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBHb0xpa2UgbsOgbyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSwgVHJ1ZSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBGYWxzZSkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3NhdmVfZGVmYXVsdF9jb25maWdzKHNlbGYpOgogICAgICAgICIiIkzGsHUgY8OhYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgbuG6v3UgY2jGsGEgY8OzIiIiCiAgICAgICAgZGVmYXVsdF9jb25maWdzID0gewogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHRo4budaSBnaWFuIGzDoG0gam9iCiAgICAgICAgICAgICJqb2JfaG91ciI6IGNvbmZpZy5KT0JfSE9VUiwKICAgICAgICAgICAgImpvYl9jb29sZG93bl9taW51dGVzIjogY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUywKICAgICAgICAgICAgImpvYl9jaGVja19pbnRlcnZhbCI6IGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwsCiAgICAgICAgICAgICJjb29sZG93bl9nZXRfam9iX2dvbGlrZSI6IDMwLCAgIyBUaOG7nWkgZ2lhbiBjaOG7nSAocGjDunQpIGtoaSBraMO0bmcgdMOsbSB0aOG6pXkgam9iIEdvTGlrZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBsacOqbiBxdWFuIMSR4bq/biBz4buRIGzGsOG7o25nIGpvYgogICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZLAogICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaGnhur90IGzhuq1wIGNobyBwaMOpcCBjaMSDbSBzw7NjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAiY2FyZV9pbl93b3JraW5nX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBnacOhIHThu5FpIHRoaeG7g3UgY2hvIGpvYiBmb2xsb3cKICAgICAgICAgICAgIm1pbl9mb2xsb3dfcHJpY2UiOiAyMCwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggcHJveHkKICAgICAgICAgICAgInVzZV9wcm94eSI6IEZhbHNlLCAgIyBDw7Mgc+G7rSBk4bulbmcgcHJveHkga2jDtG5nCiAgICAgICAgICAgICJwcm94eV9yZXF1ZXN0ZWQiOiAwLCAgIyDEkMOjIGfhu61pIHnDqnUgY+G6p3UgcHJveHkgY2jGsGEgKDA9Y2jGsGEsIDE9xJHDoyBn4butaSkKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGVmYXVsdF9jb25maWdzLml0ZW1zKCk6CiAgICAgICAgICAgICMgQ2jhu4kgbMawdSBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoa2V5KSBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6MgbMawdSBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oOiB7a2V5fT17dmFsdWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPhuqV1IGjDrG5oIHtrZXl9IMSRw6MgdOG7k24gdOG6oWk6IHtzZWxmLmRiLmdldChrZXkpfSIpCiAgICAgICAgCiAgICBkZWYgX2luaXRfam9iX2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyIiIiCiAgICAgICAgIyBpbml0IHRow6wgc+G6vSBpbml0IGhhbmRsZXJzIGNobyB04bqldCBj4bqjIGPDoWMgYXBwLCBsw6BtIGFwcCBuw6BvIHRow6wgc+G6vSB0aGVvIGPhuqV1IGjDrG5oIGzhuqV5IHThu6sgZGF0YWJhc2UKICAgICAgICBmb3IgYXBwX25hbWUgaW4gY29uZmlnLkVOQUJMRURfQVBQUzoKICAgICAgICAgICAgaWYgYXBwX25hbWUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2tKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gSW5zdGFncmFtSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBraOG7n2kgdOG6oW8ge2xlbihzZWxmLmpvYl9oYW5kbGVycyl9IGpvYiBoYW5kbGVyOiB7JywgJy5qb2luKHNlbGYuam9iX2hhbmRsZXJzLmtleXMoKSl9IikKICAgICAgICAKICAgIGRlZiBfcmVzZXRfZGFpbHlfY291bnRlcnMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgdsOgbyBnaeG7nSDEkcaw4bujYyBj4bqldSBow6xuaCIiIgogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBnaeG7nSByZXNldCB04burIGPhuqV1IGjDrG5oIGhv4bq3YyB04burIGRhdGFiYXNlIG7hur91IGPDswogICAgICAgIGpvYl9ob3VyID0gc2VsZi5kYi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgIAogICAgICAgICMgVMOtbmggdGjhu51pIMSRaeG7g20gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgaWYgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gZGF0ZXRpbWUuZGF0ZS5mcm9taXNvZm9ybWF0KGxhc3RfcmVzZXRfZGF0ZV9zdHIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYixJDhu4tuaCBk4bqhbmcgbmfDoHkgcmVzZXQga2jDtG5nIGjhu6NwIGzhu4c6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIHF1YSBnaeG7nSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heSBjaMawYSB2w6AgY2jGsGEgcmVzZXQgdHJvbmcgbmfDoHkgaMO0bSBuYXkKICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZSBhbmQgKGxhc3RfcmVzZXRfZGF0ZSBpcyBOb25lIG9yIGxhc3RfcmVzZXRfZGF0ZSA8IHRvZGF5KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IChnaeG7nSByZXNldDoge2pvYl9ob3VyfTowMCkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGLhu5kgxJHhur9tIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbgogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBz4buRIGpvYiBow7RtIG5heSB2w6Agc+G7kSBqb2IgdHJvbmcgcGhpw6puCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImxhc3Rfdmlld19zdG9yaWVzIjogMAogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUgdsOsIMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHksCiAgICAgICAgICAgICAgICAgICAgIyDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSB0aMOgbmggYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoInN0YXR1cyIpID09ICJpbmFjdGl2ZSIgYW5kIGFjY291bnQuZ2V0KCJpbmFjdGl2ZV9yZWFzb24iKSA9PSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvYl9kaXNhYmxlX3VudGlsIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIGFjdGl2ZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHNhdSBraGkgcmVzZXQiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTeG7nyBraMOzYSBmb2xsb3cgbuG6v3UgYuG7iyBraMOzYSBkbyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBuZ8OgeQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBt4bufIGtow7NhIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHNhdSBraGkgcmVzZXQiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6BvIHtub3cuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG5nw6B5IMSRw6MgcmVzZXQgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkuaXNvZm9ybWF0KCkpCiAgICAgICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBjaOG6oXkgam9iIGNobyB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgY2jhuqF5IGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMi4gS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBj4bqnbiB0aGnhur90CiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMy4gxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5CiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4KICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIGpvYiB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0ixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuIGPhu6dhIHTDoGkga2hv4bqjbiIiIgogICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIGLhu4sgZGlzYWJsZWQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJkaXNhYmxlZCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyBpbmFjdGl2ZSwga2nhu4NtIHRyYSB0aOG7nWkgZ2lhbiBjb29sZG93bgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJY4butIGzDvSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiIiIKICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjb29sZG93biwgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSB0aW1lLnRpbWUoKToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsic3RhdHVzIjogImFjdGl2ZSIsICJsYXN0X2NhcmVfdGltZSI6IDB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgaW5hY3RpdmVfZm9sbG93X3JlYXNvbiBjaOG7qWEgInVuZm9sbG93IiB0aMOsIG3hu58ga2jDs2EgZm9sbG93CiAgICAgICAgICAgIGluYWN0aXZlX2ZvbGxvd19yZWFzb24gPSBhY2NvdW50LmdldCgiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiIsICIiKQogICAgICAgICAgICBpZiAidW5mb2xsb3ciIG5vdCBpbiBpbmFjdGl2ZV9mb2xsb3dfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiAiIgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBDaMawYSBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBjb29sZG93bl9yZW1haW4gPSBpbnQoKGpvYl9kaXNhYmxlX3VudGlsIC0gdGltZS50aW1lKCkpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50gKGPDsm4ge2Nvb2xkb3duX3JlbWFpbn0gcGjDunQpIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYQogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiBj4bunYSB0w6BpIGtob+G6o24gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcCB24bubaSBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgaWYgYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0gPSBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIGpvYl9tYXhfZGF5CiAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImpvYl9tYXhfZGF5Il0gPSBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgIGlmIHVwZGF0ZV9kYXRhOgogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBhY2NvdW50LnVwZGF0ZSh1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAKICAgIGRlZiBfY2xvc2VfYXBwX2Zvcl9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIMSQw7NuZyBhcHAgdMawxqFuZyDhu6luZyB24bubaSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIGNvbmZpZy5BUFBfUEFDS0FHRVM6CiAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChjb25maWcuQVBQX1BBQ0tBR0VTW2FwcF9uYW1lXSkKICAgICAgICAgICAgCiAgICBkZWYgX2lzX2FjY291bnRfYXRfZGFpbHlfbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICByZXR1cm4gam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5CiAgICAgICAgCiAgICBkZWYgX2lzX2FjY291bnRfYXRfc2Vzc2lvbl9saW1pdChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHBoacOqbiBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgIHJldHVybiBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbgogICAgICAgIAogICAgZGVmIF91cGRhdGVfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sID0gVHJ1ZSwgam9iX3R5cGU6IHN0ciA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzdWNjZXNzOiBUcnVlIG7hur91IGpvYiB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICAgICBqb2JfdHlwZTogTG/huqFpIGpvYiAoZm9sbG93LCBsaWtlLCBldGMuKQogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIGpvYiBjxqEgYuG6o24KICAgICAgICBzZWxmLl91cGRhdGVfYmFzaWNfam9iX3N0YXRzKGFjY291bnQsIHN1Y2Nlc3MpCiAgICAgICAgCiAgICAgICAgIyBSZXNldCBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgbuG6v3Ugam9iIHRow6BuaCBjw7RuZwogICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAKICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiDEkcaw4bujYyB0aGnhur90IGzhuq1wCiAgICAgICAgYWNjb3VudCA9IHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGdp4bubaSBo4bqhbiBwaGnDqm4KICAgICAgICBzZWxmLl9jaGVja19zZXNzaW9uX2xpbWl0X2FmdGVyX2pvYihhY2NvdW50KQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5CiAgICAgICAgc2VsZi5fY2hlY2tfZGFpbHlfbGltaXRfYWZ0ZXJfam9iKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSB0aOG7kW5nIGvDqiByacOqbmcgY2hvIGpvYiBmb2xsb3cKICAgICAgICBpZiBzdWNjZXNzIGFuZCBqb2JfdHlwZSBhbmQgam9iX3R5cGUubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2ZvbGxvd19zdGF0cyhhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2Jhc2ljX2pvYl9zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgc3VjY2VzczogYm9vbCk6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYiBjxqEgYuG6o24iIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImpvYl90b2RheSI6IGpvYl90b2RheSArIDEsCiAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMSwKICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBhY2NvdW50LmdldCgidG90YWxfam9icyIsIDApICsgMQogICAgICAgIH0KICAgICAgICAKICAgICAgICBpZiBub3Qgc3VjY2VzczoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImZhaWxlZF9qb2JzIl0gPSBhY2NvdW50LmdldCgiZmFpbGVkX2pvYnMiLCAwKSArIDEKICAgICAgICAgICAgCiAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICBhY2NvdW50LnVwZGF0ZSh1cGRhdGVfZGF0YSkgICMgQ+G6rXAgbmjhuq10IGxvY2FsIGRhdGEKICAgICAgICAKICAgIGRlZiBfY2hlY2tfc2Vzc2lvbl9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIHBoacOqbiBzYXUga2hpIGzDoG0gam9iIiIiCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgbMOgbSDEkeG7pyB7bWF4X2pvYnNfcGVyX3Nlc3Npb259IGpvYiB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0ixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfY2hlY2tfZGFpbHlfbGltaXRfYWZ0ZXJfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiJLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeSBzYXUga2hpIGzDoG0gam9iIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9iX21heF9kYXkgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICBpZiBqb2JfdG9kYXkgPj0gam9iX21heF9kYXk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBuZ8OgeSAoe2pvYl90b2RheX0ve2pvYl9tYXhfZGF5fSkiKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoYWNjb3VudFsiaWQiXSwgIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiKQogICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9mb2xsb3dfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiByacOqbmcgY2hvIGZvbGxvdyBqb2IiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgZm9sbG93X3RvZGF5ID0gYWNjb3VudC5nZXQoImZvbGxvd190b2RheSIsIDApICsgMQogICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkgKyAxCiAgICAgICAgbWF4X2ZvbGxvd19kYXkgPSBhY2NvdW50LmdldCgibWF4X2ZvbGxvd19kYXkiLCAyMCkKICAgICAgICBtYXhfZm9sbG93X3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2ZvbGxvd19zZXNzaW9uIiwgNSkKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCBz4buRIGxp4buHdSBmb2xsb3cKICAgICAgICB1cGRhdGVfZm9sbG93ID0gewogICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogZm9sbG93X3RvZGF5LAogICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiBmb2xsb3dfaW5fc2Vzc2lvbiwKICAgICAgICAgICAgImxhc3RfZm9sbG93X3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfQogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2ZvbGxvdykKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBuZ8OgeQogICAgICAgIGlmIGZvbGxvd190b2RheSA+PSBtYXhfZm9sbG93X2RheToKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3dfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xvdyB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgbmfDoHkgKHtmb2xsb3dfdG9kYXl9L3ttYXhfZm9sbG93X2RheX0pIikKICAgICAgICAjIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBwaGnDqm4KICAgICAgICBlbGlmIGZvbGxvd19pbl9zZXNzaW9uID49IG1heF9mb2xsb3dfc2Vzc2lvbjoKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3coYWNjb3VudFsiaWQiXSwgcmVhc29uPSLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbGxvdyB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puICh7Zm9sbG93X2luX3Nlc3Npb259L3ttYXhfZm9sbG93X3Nlc3Npb259KSIpCiAgICAgICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIMSR4buZbmcgSm9iU2VydmljZSB0cm9uZyB0aHJlYWQgcmnDqm5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgdGhyZWFkaW5nLlRocmVhZDogVGhyZWFkIMSRYW5nIGNo4bqheSBKb2JTZXJ2aWNlIGhv4bq3YyBOb25lIG7hur91IGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bq3dCB0cuG6oW5nIHRow6FpIHJ1bm5pbmcKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aHJlYWQKICAgICAgICAgICAgdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5ydW4pCiAgICAgICAgICAgIHRocmVhZC5kYWVtb24gPSBUcnVlCiAgICAgICAgICAgIHRocmVhZC5zdGFydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdGhyZWFkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgSm9iU2VydmljZSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgZGVmIHJlc2V0X2luYWN0aXZlX2FjY291bnRzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24g4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgaW5hY3RpdmVfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUsIHN0YXR1cz0iaW5hY3RpdmUiKSBvciBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBpbmFjdGl2ZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPD0gY3VycmVudF90aW1lOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsic3RhdHVzIjogImFjdGl2ZSJ9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoam9iX2Rpc2FibGVfdW50aWwgLSBjdXJyZW50X3RpbWUpIC8gNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjw7JuIHtyZW1haW5pbmdfbWludXRlc30gcGjDunQg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMga2jDs2EgRk9MTE9XCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKSBvciBbXQogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImRpc2FibGVfZm9sbG93Iik6CiAgICAgICAgICAgICAgICAgICAgICAgIHVudGlsX3RzID0gYWNjb3VudC5nZXQoImZvbGxvd19kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdW50aWxfdHMgPD0gY3VycmVudF90aW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7ImRpc2FibGVfZm9sbG93IjogRmFsc2UsICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIjogIiIsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIG3hu58ga2jDs2EgRk9MTE9XIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nID0gaW50KCh1bnRpbF90cyAtIGN1cnJlbnRfdGltZSkgLyA2MCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjw7JuIHtyZW1haW5pbmd9IHBow7p0IGtow7NhIEZPTExPVyIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSIpCiAgICAKICAgIGRlZiBpc19hY2NvdW50X2Nhbl9ydW5fam9iKHNlbGYsIGFwcF9uYW1lOnN0ciApIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBjaOG6oXkgam9iIGtow7RuZwogICAgICAgICIiIgogICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICBpZihzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENo4bqheSBKb2JTZXJ2aWNlIHRyb25nIG3hu5l0IHbDsm5nIGzhurdwIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHRoZW8gcGhpw6puCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBKb2JTZXJ2aWNlIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHRoZW8gcGhpw6puLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgeMOhYyDEkeG7i25oIGRldmljZV9pZCBoaeG7h24gdOG6oWksIEpvYlNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICB3aGlsZSBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICMgUmVzZXQgYmnhur9uIGZvcmNlX3N0b3AgbuG6v3UgY8OzCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIsIHThuqFtIGThu6tuZyB44butIGzDvSBqb2IiKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUikKICAgICAgICAgICAgICAgIGpvYl9jaGVja19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIHNlbGYucmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiBraMO0bmcKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2lzX2luX3Nlc3Npb25fY29vbGRvd24oKToKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lIC0gaW50KHRpbWUudGltZSgpKSkgLyA2MCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIntKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19TRVNTSU9OX0NPT0xET1dOfSAoY8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0KSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg2MCk6ICAjIEtp4buDbSB0cmEgbeG7l2kgcGjDunQKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9oYXNfYWNjb3VudHNfcmVhZHlfZm9yX3dvcmsoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX05PX0FDQ09VTlRTKQogICAgICAgICAgICAgICAgICAgIGpvYl9jaGVja19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSBwcm94eQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX3Byb3h5X3JlcXVpcmVtZW50KCk6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgY8OzLCBjaOG7nSAzMCBnacOieSBy4buTaSBraeG7g20gdHJhIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgzMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJD4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgY8OzLCBjaOG7nSAzMCBnacOieSBy4buTaSBraeG7g20gdHJhIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRoaeG6v3QgbOG6rXAgcHJveHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fc2V0dXBfcHJveHlfZm9yX3Nlc3Npb24oKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgdGhp4bq/dCBs4bqtcCBwcm94eSwgYuG7jyBxdWEgcGhpw6puIG7DoHkiKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDYwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjb3VudGVyIGtoaSBzZXR1cCB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ID0gMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELhuq90IMSR4bqndSBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYuX3dvcmtfc2Vzc2lvbigpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR2nhuqNpIHBow7NuZyBwcm94eSB2w6AgYuG6r3QgxJHhuqd1IHRo4budaSBnaWFuIG5naOG7iQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3JlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbigpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLl9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmgiKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiSm9iU2VydmljZSDEkcOjIGThu6tuZyIpCiAgICAgICAgICAgIAogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgIiIiROG7q25nIEpvYlNlcnZpY2UiIiIKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGThu6tuZyBKb2JTZXJ2aWNlLi4uIikKICAgICAgICAKICAgIGRlZiBmb3JjZV9zdG9wX2FsbChzZWxmKToKICAgICAgICAiIiJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmciIiIKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IFRydWUKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKCiAgICBkZWYgc2h1dGRvd24oc2VsZik6CiAgICAgICAgIiIixJDDs25nIGThu4tjaCB24bulLCBk4burbmcgdOG6pXQgY+G6oyB3b3JrZXIgdGhyZWFkcyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBk4burbmcKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IG7hur91IGPDswogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLl9yZWxlYXNlX3Byb3h5X2FmdGVyX3Nlc3Npb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2UgxJHhu4MgdHLDoW5oIGzhu5dpIHRocmVhZAogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdkYicpIGFuZCBzZWxmLmRiOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuY2xvc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSDEkcOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2U6IHtzdHIoZSl9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgc2h1dGRvd24gSm9iU2VydmljZSIpCiAgICAKICAgIGRlZiBfY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gcHJveHkgxJHhu4MgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgcHJveHkgaG/hurdjIGtow7RuZyBj4bqnbiBwcm94eSwgRmFsc2UgbuG6v3UgY+G6p24gcHJveHkgbmjGsG5nIGNoxrBhIGPDswogICAgICAgICIiIgogICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAKICAgICAgICBpZiBub3QgdXNlX3Byb3h5OgogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBLaMO0bmcgY+G6p24gcHJveHkKICAgICAgICAgICAgCiAgICAgICAgIyBD4bqnbiBwcm94eSwga2nhu4NtIHRyYSB4ZW0gY8OzIHByb3h5IGNvbmZpZyBraMO0bmcKICAgICAgICBwcm94eV9jb25maWcgPSBzZWxmLmRiLmdldCgicHJveHlfY29uZmlnIikKICAgICAgICAKICAgICAgICBpZiBub3QgcHJveHlfY29uZmlnOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgZ+G7rWkgecOqdSBj4bqndSBwcm94eSBjaMawYQogICAgICAgICAgICBwcm94eV9yZXF1ZXN0ZWQgPSBzZWxmLmRiLmdldCgicHJveHlfcmVxdWVzdGVkIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHByb3h5X3JlcXVlc3RlZCA9PSAwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPhuqduIHByb3h5IMSR4buDIGzDoG0gdmnhu4djIG5oxrBuZyBjaMawYSBjw7MgcHJveHkgY29uZmlnLCBn4butaSB5w6p1IGPhuqd1IHByb3h5IikKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX1dBSVRJTkdfUFJPWFkpCiAgICAgICAgICAgICAgICAjIEfhu61pIE1RVFQgdGjDtG5nIGLDoW8gxJFhbmcgY2jhu50gcHJveHkKICAgICAgICAgICAgICAgIHNlbGYuX3NlbmRfbXF0dF9wcm94eV9yZXF1ZXN0KCkKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRw6MgZ+G7rWkgecOqdSBj4bqndQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X3JlcXVlc3RlZCIsIDEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQw6MgZ+G7rWkgecOqdSBj4bqndSBwcm94eSwgxJFhbmcgY2jhu50gc2VydmVyIHBo4bqjbiBo4buTaSIpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19XQUlUSU5HX1BST1hZKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9zZW5kX21xdHRfcHJveHlfcmVxdWVzdChzZWxmKToKICAgICAgICAiIiJH4butaSBNUVRUIHnDqnUgY+G6p3UgcHJveHkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIG1xdHRfc2VydmljZSBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5tcXR0X3NlcnZpY2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAicmVxdWVzdF9wcm94eSIsCiAgICAgICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi5tcXR0X3NlcnZpY2UuX3NhZmVfcHVibGlzaChjb25maWcuTVFUVF9UT1BJQ19TRVJWRVJfUFJPWFksIGpzb24uZHVtcHMobWVzc2FnZSkpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBn4butaSB5w6p1IGPhuqd1IHByb3h5IHF1YSBNUVRUIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGfhu61pIHnDqnUgY+G6p3UgcHJveHkgcXVhIE1RVFQ6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9nZXRfcHJveHlfZGlzcGxheV9uYW1lKHNlbGYsIHByb3h5X2NvbmZpZzogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0w6puIGhp4buDbiB0aOG7iyBjaG8gcHJveHkgdOG7qyBjb25maWcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcm94eV9jb25maWc6IEPhuqV1IGjDrG5oIHByb3h5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVMOqbiBoaeG7g24gdGjhu4sgY+G7p2EgcHJveHkgKG5hbWUgaG/hurdjIGlkQGhvc3Q6cG9ydCkKICAgICAgICAiIiIKICAgICAgICBpZiBub3QgcHJveHlfY29uZmlnOgogICAgICAgICAgICByZXR1cm4gIlVua25vd24iCiAgICAgICAgICAgIAogICAgICAgICMgxq91IHRpw6puIHPhu60gZOG7pW5nIG5hbWUgbuG6v3UgY8OzLCBu4bq/dSBraMO0bmcgdGjDrCBkw7luZyBpZEBob3N0OnBvcnQKICAgICAgICBwcm94eV9uYW1lID0gcHJveHlfY29uZmlnLmdldCgibmFtZSIpCiAgICAgICAgaWYgcHJveHlfbmFtZToKICAgICAgICAgICAgcmV0dXJuIHByb3h5X25hbWUKICAgICAgICAgICAgCiAgICAgICAgcHJveHlfaWQgPSBwcm94eV9jb25maWcuZ2V0KCJpZCIsICJ1bmtub3duIikKICAgICAgICBob3N0ID0gcHJveHlfY29uZmlnLmdldCgiaG9zdCIsICIiKQogICAgICAgIHBvcnQgPSBwcm94eV9jb25maWcuZ2V0KCJwb3J0IiwgIiIpCiAgICAgICAgCiAgICAgICAgaWYgaG9zdCBhbmQgcG9ydDoKICAgICAgICAgICAgcmV0dXJuIGYie3Byb3h5X2lkfUB7aG9zdH06e3BvcnR9IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBwcm94eV9pZAogICAgICAgICAgICAKICAgIGRlZiBfc2V0dXBfcHJveHlfZm9yX3Nlc3Npb24oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaGnhur90IGzhuq1wIHByb3h5IGNobyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRoaeG6v3QgbOG6rXAgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBwcm94eV9jb25maWcgPSBzZWxmLmRiLmdldCgicHJveHlfY29uZmlnIikKICAgICAgICAKICAgICAgICBpZiBub3QgcHJveHlfY29uZmlnOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzGsHUgSUQgdsOgIHTDqm4gcHJveHkgaGnhu4duIHThuqFpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9pZCA9IHByb3h5X2NvbmZpZy5nZXQoInByb3h5X2lkIikKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBzZWxmLl9nZXRfcHJveHlfZGlzcGxheV9uYW1lKHByb3h5X2NvbmZpZykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBwcm94eSB0aMO0bmcgcXVhIGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5oZWxwZXIsICdzZXR1cF9wcm94eScpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyB0aGnhur90IGzhuq1wIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0iKQogICAgICAgICAgICAgICAgc2V0dXBfcmVzdWx0ID0gc2VsZi5oZWxwZXIuc2V0dXBfcHJveHkocHJveHlfY29uZmlnKQogICAgICAgICAgICAgICAgaWYgbm90IHNldHVwX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgdGhp4bq/dCBs4bqtcCBwcm94eSB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTEg25nIGNvdW50ZXIgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlByb3h5IHNldHVwIHRo4bqldCBi4bqhaSBs4bqnbiB7c2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50fS8zIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHRo4bqldCBi4bqhaSAzIGzhuqduIGxpw6puIHRp4bq/cCwgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaQogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA+PSAzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIlByb3h5IHNldHVwIHRo4bqldCBi4bqhaSAzIGzhuqduIGxpw6puIHRp4bq/cCwgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFyX3Byb3h5X2FuZF9yZXF1ZXN0X25ldygpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiSGVscGVyIHNlcnZpY2Uga2jDtG5nIGjhu5cgdHLhu6Mgc2V0dXAgcHJveHkiKQogICAgICAgICAgICAgICAgIyBUxINuZyBjb3VudGVyIHRo4bqldCBi4bqhaQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSB0aOG6pXQgYuG6oWkgMyBs4bqnbiBsacOqbiB0aeG6v3AsIHjDs2EgcHJveHkgdsOgIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kKICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA+PSAzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiSGVscGVyIHNlcnZpY2Uga2jDtG5nIGjhu5cgdHLhu6MgcHJveHkgMyBs4bqnbiBsacOqbiB0aeG6v3AsIHjDs2EgcHJveHkgdsOgIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFyX3Byb3h5X2FuZF9yZXF1ZXN0X25ldygpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0aGnhur90IGzhuq1wIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0gY2hvIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aGnhur90IGzhuq1wIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSBvciAndW5rbm93bid9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMSDbmcgY291bnRlciB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ICs9IDEKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJQcm94eSBzZXR1cCBs4buXaSBleGNlcHRpb24gbOG6p24ge3NlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudH0vMyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IHRo4bqldCBi4bqhaSAzIGzhuqduIGxpw6puIHRp4bq/cCwgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaQogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3NldHVwX2ZhaWxfY291bnQgPj0gMzoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiUHJveHkgc2V0dXAgbOG7l2kgZXhjZXB0aW9uIDMgbOG6p24gbGnDqm4gdGnhur9wLCB4w7NhIHByb3h5IHbDoCB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFyX3Byb3h5X2FuZF9yZXF1ZXN0X25ldygpCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NldHVwX2ZhaWxfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF9jbGVhcl9wcm94eV9hbmRfcmVxdWVzdF9uZXcoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgWMOzYSBwcm94eSBoaeG7h24gdOG6oWkgdsOgIHnDqnUgY+G6p3Ugc2VydmVyIGPhuqVwIHByb3h5IG3hu5tpIGtoaSBzZXR1cCB0aOG6pXQgYuG6oWkgMyBs4bqnbiBsacOqbiB0aeG6v3AKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJYw7NhIHByb3h5IGhp4buHbiB04bqhaSB2w6AgecOqdSBj4bqndSBzZXJ2ZXIgY+G6pXAgcHJveHkgbeG7m2kiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHByb3h5IGNvbmZpZyBoaeG7h24gdOG6oWkKICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X2NvbmZpZyIsIE5vbmUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHRy4bqhbmcgdGjDoWkgecOqdSBj4bqndSBwcm94eSDEkeG7gyBjw7MgdGjhu4MgecOqdSBj4bqndSBwcm94eSBt4bubaQogICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfcmVxdWVzdGVkIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7rWkgdGjDtG5nIGLDoW8gcmVsZWFzZSBwcm94eSBoaeG7h24gdOG6oWkgKG7hur91IGPDsykKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X2lkIGFuZCBzZWxmLm1xdHRfc2VydmljZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAgICAgbWVzc2FnZSA9IHsKICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJyZWxlYXNlX3Byb3h5X2ZhaWxlZCIsCiAgICAgICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICAgICAicHJveHlfaWQiOiBzZWxmLmN1cnJlbnRfcHJveHlfaWQsCiAgICAgICAgICAgICAgICAgICAgInJlYXNvbiI6ICJTZXR1cCBmYWlsZWQgMyB0aW1lcyIsCiAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYubXF0dF9zZXJ2aWNlLl9zYWZlX3B1Ymxpc2goY29uZmlnLk1RVFRfVE9QSUNfU0VSVkVSX1BST1hZLCBqc29uLmR1bXBzKG1lc3NhZ2UpKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHRow7RuZyBiw6FvIHJlbGVhc2UgcHJveHkgdGjhuqV0IGLhuqFpOiB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWUgb3Igc2VsZi5jdXJyZW50X3Byb3h5X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHByb3h5IGhp4buHbiB04bqhaQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfaWQgPSBOb25lCiAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9uYW1lID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGV2aWNlIG1lc3NhZ2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgIlByb3h5IGzhu5dpLCDEkcOjIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgeMOzYSBwcm94eSBjxakgdsOgIHPhurVuIHPDoG5nIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSB4w7NhIHByb3h5IHbDoCB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgCiAgICBkZWYgX3JlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiJHaeG6o2kgcGjDs25nIHByb3h5IHNhdSBraGkga+G6v3QgdGjDumMgcGhpw6puIGzDoG0gdmnhu4djIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfaWQ6CiAgICAgICAgICAgICAgICAjIFjDs2EgcHJveHkgY29uZmlnIHbDoCByZXNldCB0cuG6oW5nIHRow6FpIHnDqnUgY+G6p3UKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJwcm94eV9jb25maWciLCBOb25lKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X3JlcXVlc3RlZCIsIDApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR+G7rWkgTVFUVCB0aMO0bmcgYsOhbyBraMO0bmcgZMO5bmcgcHJveHkgbsOgeSBu4buvYQogICAgICAgICAgICAgICAgaWYgc2VsZi5tcXR0X3NlcnZpY2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAicmVsZWFzZV9wcm94eSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICJwcm94eV9pZCI6IHNlbGYuY3VycmVudF9wcm94eV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc2VsZi5tcXR0X3NlcnZpY2UuX3NhZmVfcHVibGlzaChjb25maWcuTVFUVF9UT1BJQ19TRVJWRVJfUFJPWFksIGpzb24uZHVtcHMobWVzc2FnZSkpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHRow7RuZyBiw6FvIGdp4bqjaSBwaMOzbmcgcHJveHkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lIG9yIHNlbGYuY3VycmVudF9wcm94eV9pZH0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2lkID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgZ2nhuqNpIHBow7NuZyBwcm94eSB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWUgb3Igc2VsZi5jdXJyZW50X3Byb3h5X2lkIG9yICd1bmtub3duJ30iKQogICAgICAgICAgICAKICAgIGRlZiBfY2xlYXJfcHJveHlfYW5kX3JlcXVlc3RfbmV3KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjDs2EgcHJveHkgaGnhu4duIHThuqFpIHbDoCB5w6p1IGPhuqd1IHNlcnZlciBj4bqlcCBwcm94eSBt4bubaSBraGkgc2V0dXAgdGjhuqV0IGLhuqFpIDMgbOG6p24gbGnDqm4gdGnhur9wCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiWMOzYSBwcm94eSBoaeG7h24gdOG6oWkgdsOgIHnDqnUgY+G6p3Ugc2VydmVyIGPhuqVwIHByb3h5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSBwcm94eSBjb25maWcgaGnhu4duIHThuqFpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJwcm94eV9jb25maWciLCBOb25lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIHnDqnUgY+G6p3UgcHJveHkgxJHhu4MgY8OzIHRo4buDIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kKICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X3JlcXVlc3RlZCIsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIHRow7RuZyBiw6FvIHJlbGVhc2UgcHJveHkgaGnhu4duIHThuqFpIChu4bq/dSBjw7MpCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV9pZCBhbmQgc2VsZi5tcXR0X3NlcnZpY2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAicmVsZWFzZV9wcm94eV9mYWlsZWQiLAogICAgICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAgICAgInByb3h5X2lkIjogc2VsZi5jdXJyZW50X3Byb3h5X2lkLAogICAgICAgICAgICAgICAgICAgICJyZWFzb24iOiAiU2V0dXAgZmFpbGVkIDMgdGltZXMiLAogICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLm1xdHRfc2VydmljZS5fc2FmZV9wdWJsaXNoKGNvbmZpZy5NUVRUX1RPUElDX1NFUlZFUl9QUk9YWSwganNvbi5kdW1wcyhtZXNzYWdlKSkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0aMO0bmcgYsOhbyByZWxlYXNlIHByb3h5IHRo4bqldCBi4bqhaToge3NlbGYuY3VycmVudF9wcm94eV9uYW1lIG9yIHNlbGYuY3VycmVudF9wcm94eV9pZH0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2lkID0gTm9uZQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsICJQcm94eSBs4buXaSwgxJHDoyB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIHjDs2EgcHJveHkgY8WpIHbDoCBz4bq1biBzw6BuZyB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaSIpCgogICAgZGVmIF9oYXNfYWNjb3VudHNfcmVhZHlfZm9yX3dvcmsoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgICIiIgogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGlmIHNlbGYuaXNfYWNjb3VudF9jYW5fcnVuX2pvYihhcHBfbmFtZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3dvcmtfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIG3hu5l0IHBoacOqbiBsw6BtIHZp4buHYyBob8OgbiBjaOG7iW5oIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgIAogICAgICAgICMgxJDDoW5oIGThuqV1IMSRYW5nIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIFRydWUpCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfV09SS0lOR19TRVNTSU9OKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gdmnhu4djIHR14bqnbiB04buxIHThu6tuZyBhcHAKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIG7hur91IGPhuqduCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudHNfZm9yX2FwcChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgYXBwIG7DoHkKICAgICAgICAgICAgICAgIHNlbGYuX3dvcmtfd2l0aF9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDs25nIGFwcCBzYXUga2hpIGhvw6BuIHRow6BuaAogICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgYXBwCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGvhur90IHRow7pjIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgCiAgICBkZWYgX3dvcmtfd2l0aF9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAgY+G6p24gbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBsw6BtIHZp4buHYyB24bubaSB7YXBwX25hbWV9IikKICAgICAgICAKICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgCiAgICAgICAgIyBM4buNYyBjw6FjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgICAgIAogICAgICAgIGlmIG5vdCB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAjIEzDoG0gdmnhu4djIHR14bqnbiB04buxIHbhu5tpIHThu6tuZyB0w6BpIGtob+G6o24KICAgICAgICBmb3IgYWNjb3VudCBpbiB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9zdG9wIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24gbsOgeQogICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICBpZiBub3Qgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMOgbSDEkeG7pyBz4buRIGpvYiB0cm9uZyBwaGnDqm4gY2hvIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgIHNlbGYuX3dvcmtfYWNjb3VudF9zZXNzaW9uKGFjY291bnQsIGhhbmRsZXIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gY2jEg20gc8OzYyBzYXUga2hpIGjhur90IGpvYgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICJwZXJmb3JtX2NhcmUiKSBhbmQgY2FsbGFibGUoaGFuZGxlci5wZXJmb3JtX2NhcmUpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBjaMSDbSBzw7NjIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICBkZWYgX3dvcmtfYWNjb3VudF9zZXNzaW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyKToKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCB0w6BpIGtob+G6o24gdHJvbmcgcGhpw6puCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICBqb2JzX2RvbmUgPSAwCiAgICAgICAgY2FyZV9jb3VudGVyID0gMAogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYiTMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIHt1c2VybmFtZX0sIG3hu6VjIHRpw6p1OiB7bWF4X2pvYnNfcGVyX3Nlc3Npb259IGpvYiIpCiAgICAgICAgCiAgICAgICAgd2hpbGUgam9ic19kb25lIDwgbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgY2jhuqF5IGpvYiBraMO0bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBraMO0bmcgdGjhu4MgY2jhuqF5IGpvYiBu4buvYSIpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgTOG6pXkgam9iCiAgICAgICAgICAgICAgICBqb2IgPSBoYW5kbGVyLmZldGNoX2pvYihhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3Qgam9iOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCBi4buPIHF1YSBwaGnDqm4gbsOgeSIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlCiAgICAgICAgICAgICAgICBsaW5rID0gam9iLmdldCgnbGluaycsICcnKQogICAgICAgICAgICAgICAgaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycpOgogICAgICAgICAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgICAgICAgICBlbGlmIGxpbmsuc3RhcnRzd2l0aCgnaHR0cHM6Ly93d3cudGlrdG9rLmNvbS8nKToKICAgICAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy50aWt0b2suY29tLycsICcnKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJbe2FjY291bnQuZ2V0KCdhcHAnKX1dW3t1c2VybmFtZX1dW3tqb2IuZ2V0KCd0eXBlJyl9XVt7bGlua31dIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSBqb2IKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gaGFuZGxlci52YWxpZGF0ZV9qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInZhbGlkIiwgVHJ1ZSk6CiAgICAgICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgIyBTa2lwIGpvYgogICAgICAgICAgICAgICAgICAgICAgICBza2lwX21lc3NhZ2UgPSB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiSm9iIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTa2lwIGpvYjoge3NraXBfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc2tpcF9tZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU2tpcCBqb2IgbOG7l2k6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEdpw6NuIHRo4budaSBnaWFuIHNhdSBraGkgc2tpcCBqb2IgxJHhu4MgdHLDoW5oIHNwYW0gbOG6pXkvaOG7p3kgam9iIGxpw6puIHThu6VjCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBfc2xlZXBfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDEwKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBza2lwIGpvYiDEkeG7gyB0csOhbmggc3BhbSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoc2tpcF9zbGVlcF90aW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJKb2Iga2jDtG5nIGjhu6NwIGzhu4c6IHt2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnVW5rbm93biBlcnJvcicpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGpvYgogICAgICAgICAgICAgICAgam9iX3Jlc3VsdCA9IGhhbmRsZXIuZXhlY3V0ZV9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjCiAgICAgICAgICAgICAgICBqb2Jfc3RhdHVzID0gam9iX3Jlc3VsdFsic3RhdHVzIl0KICAgICAgICAgICAgICAgIGpvYl9zdWNjZXNzID0gam9iX3Jlc3VsdFsic3VjY2VzcyJdCiAgICAgICAgICAgICAgICBqb2JfbWVzc2FnZSA9IGpvYl9yZXN1bHRbIm1lc3NhZ2UiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGzhu5dpIGZvbGxvdyBwZW5kaW5nCiAgICAgICAgICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDQgYW5kIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgICAgICBjbnQgPSBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHNbYWNjb3VudFsiaWQiXV0gPSBjbnQKICAgICAgICAgICAgICAgICAgICBpZiBjbnQgPj0gNToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIDUgbOG6p24gbGnDqm4gdGnhur9wIGZvbGxvdyBwZW5kaW5nLCBraMOzYSBGT0xMT1ciKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvd191bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICJMacOqbiB0aeG6v3AgbOG7l2kgZm9sbG93IHBlbmRpbmciKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCw6FvIGPDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqCiAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfam9iX3N0YXRzKGFjY291bnQsIGpvYl9zdWNjZXNzLCBqb2IuZ2V0KCJ0eXBlIiwgIiIpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkvhur90IHF14bqjIGpvYiB7am9ic19kb25lICsgMX0ve21heF9qb2JzX3Blcl9zZXNzaW9ufToge2pvYl9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGpvYl9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgIGpvYnNfZG9uZSArPSAxCiAgICAgICAgICAgICAgICAgICAgY2FyZV9jb3VudGVyICs9IDEKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIENoxINtIHPDs2Mgc2F1IG3hu5dpIDMtNSBqb2IgKHJhbmRvbSkKICAgICAgICAgICAgICAgICAgICBpZiBjYXJlX2NvdW50ZXIgPj0gcmFuZG9tLnJhbmRpbnQoMywgNSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoaGFuZGxlciwgInBlcmZvcm1fY2FyZSIpIGFuZCBjYWxsYWJsZShoYW5kbGVyLnBlcmZvcm1fY2FyZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgbmjhurkgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcmVfY291bnRlciA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgY2jEg20gc8OzYyBuaOG6uToge2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuq9uIGdp4buvYSBjw6FjIGpvYgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChyYW5kb20ucmFuZGludCgyLCA1KSk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggcGhpw6puIGzDoG0gdmnhu4djIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge2pvYnNfZG9uZX0ve21heF9qb2JzX3Blcl9zZXNzaW9ufSBqb2IiKQogICAgICAgIAogICAgZGVmIF9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKHNlbGYpOgogICAgICAgICIiIkLhuq90IMSR4bqndSB0aOG7nWkgZ2lhbiBuZ2jhu4kgZ2nhu69hIGPDoWMgcGhpw6puIiIiCiAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJqb2JfY29vbGRvd25fbWludXRlcyIsIDYwKQogICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkgKyAoY29vbGRvd25fbWludXRlcyAqIDYwKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IG5naOG7iSBuZ8ahaSB7Y29vbGRvd25fbWludXRlc30gcGjDunQgZ2nhu69hIGPDoWMgcGhpw6puIikKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIntKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19TRVNTSU9OX0NPT0xET1dOfSAoe2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0KSIpCiAgICAgICAgCiAgICBkZWYgX2lzX2luX3Nlc3Npb25fY29vbGRvd24oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRYW5nIHRyb25nIHRo4budaSBnaWFuIG5naOG7iQogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA8PSAwOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIGlmIGN1cnJlbnRfdGltZSA8IHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZToKICAgICAgICAgICAgcmVtYWluaW5nX21pbnV0ZXMgPSBpbnQoKHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSAtIGN1cnJlbnRfdGltZSkgLyA2MCkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0IG5naOG7iSBuZ8ahaSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgICAgICByZXR1cm4gRmFsc2U=').decode('utf-8'))
