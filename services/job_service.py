import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKZnJvbSBzZXJ2aWNlcy5wcm94eV9zZXJ2aWNlIGltcG9ydCBQcm94eVNlcnZpY2UKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19DT05USU5VT1VTID0gIsSQYW5nIGzDoG0gdmnhu4djIGxpw6puIHThu6VjIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIG5nw6B5IgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgLSBs4bqleSB04burIGRhdGFiYXNlIGhv4bq3YyBjb25maWcKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIHRoZW8gYWNjb3VudF9pZAogICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Agam9iIGZvbGxvdyB0cuG6oyB24buBIHN0YXR1cyA0IChwZW5kaW5nKQogICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBi4buLIHVuZm9sbG93L3VubGlrZSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBs4buXaSBmZXRjaCBqb2IgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyBxdXnhur90IMSR4buLbmggbmjhuqMgcHJveHkKICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJHDoyByZXNldCBJUCBwcm94eSDEkeG7gyB0csOhbmggcmVzZXQgbOG6t3AgbOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcCDEkeG7gyB0csOhbmggc3dpdGNoIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyA9IHt9ICAjIHthcHBfbmFtZTogYWNjb3VudF9pZH0KICAgICAgICAKICAgICAgICAjIEZsYWcgxJHhu4MgdHJhY2sgeGVtIMSRw6MgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCBjaMawYSBraGkga2jhu59pIMSR4buZbmcKICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCA9IHt9ICAjIHthcHBfbmFtZTogYm9vbH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgbMOgbSB2aeG7h2MgxJHhu4MgdHLDoW5oIHF1w6l0IGzhuqFpIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgIGRlZiBfdmVyaWZ5X2N1cnJlbnRfYWNjb3VudF9vbl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0ciwgaGFuZGxlcikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyIGPhu6dhIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4gYXBwLCBOb25lIG7hur91IGtow7RuZyBjw7MgaG/hurdjIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihoYW5kbGVyLCAnZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lJyk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkhhbmRsZXIge2FwcF9uYW1lfSBraMO0bmcgaOG7lyB0cuG7oyBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB04burIFVJCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJykgPT0gY3VycmVudF9hY2NvdW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZpZWQ6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50X3VzZXJuYW1lfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBuaMawbmcga2jDtG5nIGPDsyB0cm9uZyBEQiIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBjdXJyZW50IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiB0cm9uZyBEQiB24bubaSB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIgY+G7p2EgYXBwCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIHZlcmlmeSBhY2NvdW50IChu4bq/dSBj4bqnbikKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKGYiVmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX0sIGLhu48gcXVhIHZlcmlmeSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLl92ZXJpZnlfY3VycmVudF9hY2NvdW50X29uX2FwcChhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgYXBwIG7DoHkgduG7gSBsb2dnZWRfaW4gPSBGYWxzZSB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgcmVzZXRfY291bnQgPSAwCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImxvZ2dlZF9pbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsibG9nZ2VkX2luIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgIHJlc2V0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBsb2dnZWRfaW4gPSBGYWxzZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc2V0X2NvdW50ID4gMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQge3Jlc2V0X2NvdW50fSB0w6BpIGtob+G6o24gduG7gSBsb2dnZWRfaW4gPSBGYWxzZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4KICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChjdXJyZW50X2FjY291bnRbImlkIl0sIHsibG9nZ2VkX2luIjogVHJ1ZX0pCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGN1cnJlbnRfYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IMSRYW5nIGxvZ2luIHRo4bqtdCB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBsb2dpbgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyB0cuG6oW5nIHRow6FpOiBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgc3luYyBsb2dpbiBzdGF0dXMgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9mb3JjZV92ZXJpZnlfYWNjb3VudHNfd2l0aF9wcm94eShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBGb3JjZSB2ZXJpZnkgdOG6pXQgY+G6oyBhY2NvdW50IGtoaSDEkcOjIGPDsyBwcm94eSAoZ+G7jWkga2hpIHRo4buxYyBz4buxIGPhuqduIHRoaeG6v3QpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzIGFuZCBhcHBfbmFtZSBub3QgaW4gc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJGb3JjZSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX0gduG7m2kgcHJveHkuLi4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50X2xvZ2luX3N0YXR1c193aXRoX3JlYWxpdHkoYXBwX25hbWUsIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmb3JjZSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGZvcmNlIHZlcmlmeSBhY2NvdW50czoge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX2lzX2N1cnJlbnRfYWNjb3VudF9zdGlsbF93b3JrYWJsZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgY8OzIGPDsm4gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB24bqrbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MsIEZhbHNlIG7hur91IGPhuqduIHTDrG0gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gbeG7m2kgbmjhuqV0IHThu6sgREIKICAgICAgICAgICAgYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24gSUQge2FjY291bnRfaWR9IGtow7RuZyBjw7JuIHThu5NuIHThuqFpIHRyb25nIERCIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyBjw7JuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgY2FuX3dvcmsgPSBzZWxmLl9jYW5fcnVuX2pvYihjdXJyZW50X2FjY291bnQpCiAgICAgICAgICAgIGlmIGNhbl93b3JrOgogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHbhu5tpIGRhdGEgbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gY3VycmVudF9hY2NvdW50CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgdGjhu4MgbMOgbSB2aeG7h2MgbuG7r2EsIGPhuqduIHTDrG0gdMOgaSBraG/huqNuIGtow6FjIikKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaToge2V9IikKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgc2FmZV9zbGVlcChzZWxmLCBzZWNvbmRzOiBmbG9hdCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBOZ+G7pyBhbiB0b8OgbiwgY8OzIHRo4buDIGThu6tuZyBs4bqhaSBuZ2F5IGzhuq1wIHThu6ljIGtoaSBmb3JjZV9zdG9wIMSRxrDhu6NjIMSR4bq3dCB0aMOgbmggVHJ1ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNlY29uZHM6IFPhu5EgZ2nDonkgY+G6p24gbmfhu6cKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuZ+G7pyDEkeG7pyB0aOG7nWkgZ2lhbiwgRmFsc2UgbuG6v3UgYuG7iyBk4burbmcgbOG6oWkKICAgICAgICAiIiIKICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICBjaGVja19pbnRlcnZhbCA9IEpvYlNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9DSEVDS19JTlRFUlZBTCAgIyBLaeG7g20gdHJhIG3hu5dpIDAuNSBnacOieQogICAgICAgIAogICAgICAgIHdoaWxlIHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSA8IHNlY29uZHM6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBjw7MgecOqdSBj4bqndSBk4burbmcKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9zdG9wIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE5n4bunIG3hu5l0IGtob+G6o25nIG5n4bqvbgogICAgICAgICAgICBzbGVlcF90aW1lID0gbWluKGNoZWNrX2ludGVydmFsLCBzZWNvbmRzIC0gKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkpCiAgICAgICAgICAgIGlmIHNsZWVwX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChzbGVlcF90aW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSBIZWxwZXJTZXJ2aWNlCiAgICAgICAgaGVscGVyX3N1Y2Nlc3MsIGhlbHBlcl9kYXRhID0gdXRpbHMuY2hlY2tfaGVscGVyX3NlcnZpY2Uoc2VsZi5oZWxwZXIpCiAgICAgICAgaWYgbm90IGhlbHBlcl9zdWNjZXNzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBr4bq/dCBu4buRaSDEkeG6v24gSGVscGVyU2VydmljZS4gVnVpIGzDsm5nIGtp4buDbSB0cmEgbOG6oWkuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyBu4bq/dSBjw7MKICAgICAgICBpZiBoZWxwZXJfZGF0YSBhbmQgImRhdGEiIGluIGhlbHBlcl9kYXRhOgogICAgICAgICAgICBzZWxmLmRiLnNhdmVfZGV2aWNlX2luZm8oaGVscGVyX2RhdGEpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBsxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLOiB7aGVscGVyX2RhdGFbJ2RhdGEnXS5nZXQoJ2RldmljZV9tb2RlbCcsICdVbmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICMgMy4gTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MKICAgICAgICBzZWxmLl9zYXZlX2RlZmF1bHRfY29uZmlncygpCiAgICAgICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgICMgNS4gS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLl9pbml0X2pvYl9oYW5kbGVycygpCiAgICAgICAgCiAgICAgICAgIyA2LiBLaOG7n2kgdOG6oW8gbmfDoHkgY3Xhu5FpIGPDuW5nIMSRw6MgcmVzZXQgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICAKICAgICAgICBpZiBub3QgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgIyBO4bq/dSBoaeG7h24gdOG6oWkgxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXksIMSRw6FuaCBk4bqldSDEkcOjIHJlc2V0CiAgICAgICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lOgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gdG9kYXkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTuG6v3UgY2jGsGEgxJHhur9uIGdp4budIHJlc2V0LCDEkcOhbmggZOG6pXUgbMOgIMSRw6MgcmVzZXQgbmfDoHkgaMO0bSBxdWEKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5IC0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgbGFzdF9yZXNldF9kYXRlLmlzb2Zvcm1hdCgpKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkto4bufaSB04bqhbyBuZ8OgeSByZXNldDoge2xhc3RfcmVzZXRfZGF0ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmc6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgCiAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IFRydWUKICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIEpvYlNlcnZpY2UgdGjDoG5oIGPDtG5nLiIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6p24gxJHhu5NuZyBi4buZIGzhuqFpLCBGYWxzZSBu4bq/dSBraMO0bmcgY+G6p24KICAgICAgICAiIiIKICAgICAgICAjIEzhuqV5IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgZGF0YWJhc2UKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgc3luY19zdGF0dXMgPSBzZWxmLmRiLmdldChzeW5jX3N0YXR1c19rZXksIEZhbHNlKSAgIyBN4bq3YyDEkeG7i25oIGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICAjIE7hur91IGNoxrBhIMSR4buTbmcgYuG7mSB0aMOsIGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaQogICAgICAgIHJldHVybiBub3Qgc3luY19zdGF0dXMKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgc3RhdHVzOiBib29sID0gVHJ1ZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgc3RhdHVzOiBUcnVlIG7hur91IMSRw6MgxJHhu5NuZyBi4buZLCBGYWxzZSBu4bq/dSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAiIiIKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICBzZWxmLmRiLnNldChzeW5jX3N0YXR1c19rZXksIHN0YXR1cykKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiB7c3RhdHVzfSIpCiAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudHNfZm9yX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCB0w6BpIGtob+G6o24gR29MaWtlIGNobyBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiDEkeG7k25nIGLhu5kKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkeG7k25nIGLhu5kgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKCiAgICAgICAgICAgICMgMS4gxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4buTbmcgYuG7mSB7bGVuKGFjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBUcnVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIEZhbHNlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MiIiIKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gdGjhu51pIGdpYW4gbMOgbSBqb2IKICAgICAgICAgICAgImpvYl9ob3VyIjogY29uZmlnLkpPQl9IT1VSLAogICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIFRo4budaSBnaWFuIGNo4budIChwaMO6dCkga2hpIGtow7RuZyB0w6xtIHRo4bqleSBqb2IgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaGnhur90IGzhuq1wIGNobyBwaMOpcCBjaMSDbSBzw7NjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAiY2FyZV9pbl93b3JraW5nX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBnacOhIHThu5FpIHRoaeG7g3UgY2hvIGpvYiBmb2xsb3cKICAgICAgICAgICAgIm1pbl9mb2xsb3dfcHJpY2UiOiAyMCwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggeOG7rSBsw70gdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICJtYXhfdW5mb2xsb3dfYXR0ZW1wdHMiOiBjb25maWcuTUFYX1VORk9MTE9XX0FUVEVNUFRTLAogICAgICAgICAgICAidW5mb2xsb3dfcGVuYWx0eV9taW51dGVzIjogNzIwLCAgIyBN4bq3YyDEkeG7i25oIDEyIGdp4budLCBjw7MgdGjhu4MgxJFp4buBdSBjaOG7iW5oIHThu6sgc2VydmVyCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIHByb3h5CiAgICAgICAgICAgICJ1c2VfcHJveHkiOiBGYWxzZSwgICMgQ8OzIHPhu60gZOG7pW5nIHByb3h5IGtow7RuZwogICAgICAgICAgICAicHJveHlfc2VydmVyIjogImh0dHA6Ly8xMC4wLjAuNTo5MDMyIiwgICMgU2VydmVyIHByb3h5IG3hurdjIMSR4buLbmgKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGVmYXVsdF9jb25maWdzLml0ZW1zKCk6CiAgICAgICAgICAgICMgQ2jhu4kgbMawdSBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoa2V5KSBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6MgbMawdSBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oOiB7a2V5fT17dmFsdWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPhuqV1IGjDrG5oIHtrZXl9IMSRw6MgdOG7k24gdOG6oWk6IHtzZWxmLmRiLmdldChrZXkpfSIpCiAgICAgICAgCiAgICBkZWYgX2luaXRfam9iX2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyIiIiCiAgICAgICAgIyBpbml0IHRow6wgc+G6vSBpbml0IGhhbmRsZXJzIGNobyB04bqldCBj4bqjIGPDoWMgYXBwLCBsw6BtIGFwcCBuw6BvIHRow6wgc+G6vSB0aGVvIGPhuqV1IGjDrG5oIGzhuqV5IHThu6sgZGF0YWJhc2UKICAgICAgICBmb3IgYXBwX25hbWUgaW4gY29uZmlnLkVOQUJMRURfQVBQUzoKICAgICAgICAgICAgaWYgYXBwX25hbWUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2tKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoCBwcm94eV9zZXJ2aWNlIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAiaW5zdGFncmFtIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IEluc3RhZ3JhbUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgIHByb3h5X3NlcnZpY2UgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGto4bufaSB04bqhbyB7bGVuKHNlbGYuam9iX2hhbmRsZXJzKX0gam9iIGhhbmRsZXI6IHsnLCAnLmpvaW4oc2VsZi5qb2JfaGFuZGxlcnMua2V5cygpKX0iKQogICAgICAgIAogICAgZGVmIF9yZXNldF9kYWlseV9jb3VudGVycyhzZWxmKToKICAgICAgICAiIiJSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSB2w6BvIGdp4budIMSRxrDhu6NjIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICAKICAgICAgICAjIEzhuqV5IGdp4budIHJlc2V0IHThu6sgY+G6pXUgaMOsbmggaG/hurdjIHThu6sgZGF0YWJhc2UgbuG6v3UgY8OzCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgCiAgICAgICAgIyBUw61uaCB0aOG7nWkgxJFp4buDbSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heQogICAgICAgIHJlc2V0X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5jb21iaW5lKHRvZGF5LCBkYXRldGltZS50aW1lKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wKSkKICAgICAgICAKICAgICAgICAjIEzhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZyB04burIGRhdGFiYXNlCiAgICAgICAgbGFzdF9yZXNldF9kYXRlX3N0ciA9IHNlbGYuZGIuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICBpZiBsYXN0X3Jlc2V0X2RhdGVfc3RyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBkYXRldGltZS5kYXRlLmZyb21pc29mb3JtYXQobGFzdF9yZXNldF9kYXRlX3N0cikKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLEkOG7i25oIGThuqFuZyBuZ8OgeSByZXNldCBraMO0bmcgaOG7o3AgbOG7hzoge2xhc3RfcmVzZXRfZGF0ZV9zdHJ9IikKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5IGNoxrBhIHbDoCBjaMawYSByZXNldCB0cm9uZyBuZ8OgeSBow7RtIG5heQogICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lIGFuZCAobGFzdF9yZXNldF9kYXRlIGlzIE5vbmUgb3IgbGFzdF9yZXNldF9kYXRlIDwgdG9kYXkpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gcmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgKGdp4budIHJlc2V0OiB7am9iX2hvdXJ9OjAwKSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgYuG7mSDEkeG6v20gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHPhu5Egam9iIGjDtG0gbmF5IHbDoCBzZXNzaW9uIGNvdW50ZXJzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImxhc3Rfdmlld19zdG9yaWVzIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaMO0bmcgcmVzZXQgdHLhuqFuZyB0aMOhaSBmb2xsb3cgLSBjaOG7iSByZXNldCBraGkgaOG6v3QgdGjhu51pIGdpYW4KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB2w6wgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSwKICAgICAgICAgICAgICAgICAgICAjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIHRow6BuaCBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgic3RhdHVzIikgPT0gImluYWN0aXZlIiBhbmQgYWNjb3VudC5nZXQoImluYWN0aXZlX3JlYXNvbiIpID09ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgYWN0aXZlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyByZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gdsOgbyB7bm93LnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBuZ8OgeSDEkcOjIHJlc2V0IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIHRvZGF5Lmlzb2Zvcm1hdCgpKQogICAgICAgIAogICAgZGVmIF9jYW5fcnVuX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdGjhu4MgY2jhuqF5IGpvYiBjaG8gdMOgaSBraG/huqNuIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGNo4bqheSBqb2IsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIDEuIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24KICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfYmFzaWNfYWNjb3VudF9zdGF0dXMoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDIuIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gY+G6p24gdGhp4bq/dAogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDMuIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiDEkcaw4bujYyB0aGnhur90IGzhuq1wCiAgICAgICAgYWNjb3VudCA9IHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIDQuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeQogICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfYXRfZGFpbHlfbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyA1LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgc2Vzc2lvbgogICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfYXRfc2Vzc2lvbl9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICMgLi4uS0jDlE5HIGtp4buDbSB0cmEgZm9sbG93IOG7nyDEkcOieSwgY2jhu4kga2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiBjaHVuZy4uLgogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2Jhc2ljX2FjY291bnRfc3RhdHVzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIktp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24gY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gYuG7iyBkaXNhYmxlZCwga2jDtG5nIGNobyBjaOG6oXkgam9iCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImRpc2FibGVkIjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRw6MgbG9nb3V0LCBraMO0bmcgY2hvIGNo4bqheSBqb2IKICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAibG9nb3V0IjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIGluYWN0aXZlLCBraeG7g20gdHJhIHRo4budaSBnaWFuIGNvb2xkb3duCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2hhbmRsZV9pbmFjdGl2ZV9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2hhbmRsZV9pbmFjdGl2ZV9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIljhu60gbMO9IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSIiIgogICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNvb2xkb3duLCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IHRpbWUudGltZSgpOgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHbhu4EgYWN0aXZlCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgImxhc3RfY2FyZV90aW1lIjogMAogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jDtG5nIHThu7EgxJHhu5luZyBlbmFibGUgZm9sbG93IC0gY2jhu4kgZW5hYmxlIGtoaSBo4bq/dCB0aOG7nWkgZ2lhbiBkaXNhYmxlX2ZvbGxvdwogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCDEkcOjIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgQ2jGsGEgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgY29vbGRvd25fcmVtYWluID0gaW50KChqb2JfZGlzYWJsZV91bnRpbCAtIHRpbWUudGltZSgpKSAvIDYwKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budIChjw7JuIHtjb29sZG93bl9yZW1haW59IHBow7p0KSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgYWNjb3VudF9pZDogaW50LCBpc19sb2dnZWRfaW46IGJvb2wpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIHTDoGkga2hv4bqjbiAKICAgICAgICAgICAgaXNfbG9nZ2VkX2luOiBUcnVlIG7hur91IMSRw6MgxJHEg25nIG5o4bqtcCwgRmFsc2UgbuG6v3UgbG9nb3V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJsb2dnZWRfaW4iOiBpc19sb2dnZWRfaW4sCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyB0cm9uZyBtZW1vcnkKICAgICAgICAgICAgaWYgaXNfbG9nZ2VkX2luOgogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGtow6FjIGPhu6dhIGPDuW5nIGFwcCBsw6AgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIG9sZF9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBpZiBvbGRfYWNjb3VudF9pZCAhPSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KG9sZF9hY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibG9nZ2VkX2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gY8WpIHtvbGRfYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGxvZ291dCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSB0w6BpIGtob+G6o24gbeG7m2kKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIMSRw6MgxJHEg25nIG5o4bqtcCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFjDs2Ega2jhu49pIHRyYWNraW5nIG7hur91IGxvZ291dAogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyBhbmQgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcDoge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIGPDoWMgxJFp4buBdSBraeG7h24gdGnDqm4gcXV54bq/dCBj4bunYSB0w6BpIGtob+G6o24iIiIKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHGsOG7o2MgYuG6rXQgam9iIGtow7RuZwogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2MgbGnDqm4ga+G6v3QgduG7m2kgR29MaWtlIGNoxrBhCiAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIGPhu6dhIHTDoGkga2hv4bqjbiDEkcaw4bujYyB0aGnhur90IGzhuq1wIHbhu5tpIGdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdAogICAgICAgICIiIgogICAgICAgIHVwZGF0ZV9kYXRhID0ge30KICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRoaeG6v3QgbOG6rXAgam9iX21heF9kYXkKICAgICAgICBpZiBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSA8PSAwOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiam9iX21heF9kYXkiXSA9IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgdGhp4bq/dCBs4bqtcCBtYXhfam9ic19wZXJfc2Vzc2lvbgogICAgICAgIGlmIGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIDw9IDA6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdID0gY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gZGF0YWJhc2UgbuG6v3UgY8OzIHRoYXkgxJHhu5VpCiAgICAgICAgaWYgdXBkYXRlX2RhdGE6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBhY2NvdW50LnVwZGF0ZSh1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAKICAgIGRlZiBfY2xvc2VfYXBwX2Zvcl9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIMSQw7NuZyBhcHAgdMawxqFuZyDhu6luZyB24bubaSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIGNvbmZpZy5BUFBfUEFDS0FHRVM6CiAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChjb25maWcuQVBQX1BBQ0tBR0VTW2FwcF9uYW1lXSkKICAgICAgICAgICAgCiAgICBkZWYgX2lzX2FjY291bnRfYXRfZGFpbHlfbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICByZXR1cm4gam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5CiAgICAgICAgCiAgICBkZWYgX2lzX2FjY291bnRfYXRfc2Vzc2lvbl9saW1pdChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHNlc3Npb24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gc2Vzc2lvbgogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAKICAgICAgICBpZiBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHNlc3Npb24gKHtqb2JzX2RvbmVfaW5fc2Vzc2lvbn0ve21heF9qb2JzX3Blcl9zZXNzaW9ufSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaG8gdMOgaSBraG/huqNuIG5naOG7iSB0aGVvIHRo4budaSBnaWFuIGpvYl9jb29sZG93bl9taW51dGVzCiAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmRiLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSBuZ2jhu4kge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IHNhdSBraGkgaG/DoG4gdGjDoG5oIHNlc3Npb24iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY8OzIHPhurVuIHRyb25nIGRiX3NlcnZpY2UgxJHhu4MgxJHhurd0IHTDoGkga2hv4bqjbiBpbmFjdGl2ZQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz1jb29sZG93bl9taW51dGVzLAogICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiSG/DoG4gdGjDoG5oIHNlc3Npb24gKHtqb2JzX2RvbmVfaW5fc2Vzc2lvbn0gam9icyksIG5naOG7iSB7Y29vbGRvd25fbWludXRlc30gcGjDunQiCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBjb3VudGVyIHNhdSBraGkgxJHhurd0IGluYWN0aXZlCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2pvYl9zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgc3VjY2VzczogYm9vbCA9IFRydWUsIGpvYl90eXBlOiBzdHIgPSBOb25lLCBqb2JfcmVzdWx0OiBkaWN0ID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIHN1Y2Nlc3M6IFRydWUgbuG6v3Ugam9iIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iIChmb2xsb3csIGxpa2UsIGV0Yy4pCiAgICAgICAgICAgIGpvYl9yZXN1bHQ6IEvhur90IHF14bqjIGpvYiAoZMO5bmcgxJHhu4MgeOG7rSBsw70gdW5mb2xsb3cpCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gam9iIGPGoSBi4bqjbiAoYmFvIGfhu5NtIGPhuqMgZm9sbG93IHN0YXRzIG7hur91IGzDoCBmb2xsb3cgam9iKQogICAgICAgIHNlbGYuX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoYWNjb3VudCwgc3VjY2Vzcywgam9iX3R5cGUpCiAgICAgICAgCiAgICAgICAgIyBSZXNldCBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgbuG6v3Ugam9iIHRow6BuaCBjw7RuZwogICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgIyBSZXNldCB1bmZvbGxvdyBhdHRlbXB0cyBraGkgam9iIHRow6BuaCBjw7RuZyAoa2jDtG5nIHBo4bqjaSBi4buLIHVuZm9sbG93KQogICAgICAgICAgICBpZiBub3QgKGpvYl9yZXN1bHQgYW5kIGpvYl9yZXN1bHQuZ2V0KCJ1bmZvbGxvdyIsIEZhbHNlKSk6CiAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgQuG7jyBxdWEga2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gc2Vzc2lvbiB2w6wgxJHDoyBjaHV54buDbiBzYW5nIGNvbnRpbnVvdXMgcHJvY2Vzc2luZwogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5CiAgICAgICAgc2VsZi5fY2hlY2tfZGFpbHlfbGltaXRfYWZ0ZXJfam9iKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSB1bmZvbGxvdyBjaG8gam9iIGZvbGxvdwogICAgICAgIGlmIGpvYl90eXBlIGFuZCBqb2JfdHlwZS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICAjIE7hur91IGLhu4sgdW5mb2xsb3cgKGpvYl9yZXN1bHQgY8OzIGtleSAndW5mb2xsb3cnIGhv4bq3YyBzdGF0dXMgxJHhurdjIGJp4buHdCkKICAgICAgICAgICAgaWYgam9iX3Jlc3VsdCBhbmQgam9iX3Jlc3VsdC5nZXQoInVuZm9sbG93IiwgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBUxINuZyBz4buRIGzhuqduIGLhu4sgdW5mb2xsb3cgY2hvIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgICAgICB1bmZvbGxvd19jb3VudCA9IHNlbGYudW5mb2xsb3dfYXR0ZW1wdHMuZ2V0KGFjY291bnRbImlkIl0sIDApICsgMQogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IHVuZm9sbG93X2NvdW50CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIG1heF91bmZvbGxvd19hdHRlbXB0cyA9IHNlbGYuZGIuZ2V0KCJtYXhfdW5mb2xsb3dfYXR0ZW1wdHMiLCBjb25maWcuTUFYX1VORk9MTE9XX0FUVEVNUFRTKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBi4buLIHVuZm9sbG93IGzhuqduIHt1bmZvbGxvd19jb3VudH0ve21heF91bmZvbGxvd19hdHRlbXB0c30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buJIGtow7NhIHTDoGkga2hv4bqjbiBraGkgxJHhuqF0IGdp4bubaSBo4bqhbiBz4buRIGzhuqduIHVuZm9sbG93CiAgICAgICAgICAgICAgICBpZiB1bmZvbGxvd19jb3VudCA+PSBtYXhfdW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzID0gc2VsZi5kYi5nZXQoInVuZm9sbG93X3BlbmFsdHlfbWludXRlcyIsIDcyMCkgICMgTeG6t2MgxJHhu4tuaCAxMiBnaeG7nSA9IDcyMCBwaMO6dAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBi4buLIHVuZm9sbG93IHt1bmZvbGxvd19jb3VudH0gbOG6p24sIGtow7NhIGZvbGxvdyB7cGVuYWx0eV9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRbImlkIl0sCiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbj1mIkLhu4sgdW5mb2xsb3cge3VuZm9sbG93X2NvdW50fSBs4bqnbiIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjb3VudGVyIHNhdSBraGkga2jDs2EKICAgICAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgbMOgIHRpa3RvayB0aMOsIGThu6tuZyB0w6BpIGtob+G6o24gbHXDtG4gduG7m2kgdGjhu51pIGdpYW4gcGVuYWx0eSB0xrDGoW5nIOG7qW5nCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImFwcCIpID09ICJ0aWt0b2siOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudFsiaWQiXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkLhu4sgdW5mb2xsb3cge3VuZm9sbG93X2NvdW50fSBs4bqnbiAoVGlrVG9rKSIKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBi4buLIHVuZm9sbG93IG5oxrBuZyBjaMawYSDEkeG6oXQgZ2nhu5tpIGjhuqFuICh7dW5mb2xsb3dfY291bnR9L3ttYXhfdW5mb2xsb3dfYXR0ZW1wdHN9KSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEpvYiB0aMOgbmggY8O0bmcgdsOgIGtow7RuZyBi4buLIHVuZm9sbG93LCByZXNldCBjb3VudGVyCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzIGFuZCBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wsIGpvYl90eXBlOiBzdHIgPSBOb25lKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iIGPGoSBi4bqjbiAtIGfhu5lwIGPhuqMgZm9sbG93IHN0YXRzIMSR4buDIHRyw6FuaCBj4bqtcCBuaOG6rXQgdHLDuW5nIGzhurdwIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgImxhc3Rfam9iX3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgQ2jhu4kgdMSDbmcgY291bnRlcnMga2hpIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgImpvYl90b2RheSI6IGpvYl90b2RheSArIDEsCiAgICAgICAgICAgICAgICAidG90YWxfam9icyI6IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkgKyAxLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogam9ic19kb25lX2luX3Nlc3Npb24gKyAxCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGzDoCBmb2xsb3cgam9iLCBj4bqtcCBuaOG6rXQgbHXDtG4gZm9sbG93IHN0YXRzIMSR4buDIHRyw6FuaCAyIGzhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICBpZiBqb2JfdHlwZSBhbmQgam9iX3R5cGUubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKSArIDEKICAgICAgICAgICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkgKyAxCiAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiBmb2xsb3dfdG9kYXksCiAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogZm9sbG93X2luX3Nlc3Npb24sCiAgICAgICAgICAgICAgICAgICAgImxhc3RfZm9sbG93X3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIHRo4buxYyBoaeG7h24gZm9sbG93IHRow6BuaCBjw7RuZyAtIFNlc3Npb246IHtmb2xsb3dfaW5fc2Vzc2lvbn0sIEjDtG0gbmF5OiB7Zm9sbG93X3RvZGF5fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZyB0aMO0bmcgdGluIHThu5VuZyBxdWFuIHbhu4Egam9icwogICAgICAgICAgICBqb2JzX2RvbmVfc2Vzc2lvbiA9IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMQogICAgICAgICAgICBqb2JzX3RvZGF5ID0gam9iX3RvZGF5ICsgMQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGhvw6BuIHRow6BuaCBqb2IgLSBTZXNzaW9uOiB7am9ic19kb25lX3Nlc3Npb259L3thY2NvdW50LmdldCgnbWF4X2pvYnNfcGVyX3Nlc3Npb24nLCBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04pfSwgSMO0bSBuYXk6IHtqb2JzX3RvZGF5fS97YWNjb3VudC5nZXQoJ2pvYl9tYXhfZGF5JywgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkpfSIpCiAgICAgICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpICAjIEPhuq1wIG5o4bqtdCBsb2NhbCBkYXRhCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkgc2F1IGtoaSBsw6BtIGpvYiIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5OgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgbmfDoHkgKHtqb2JfdG9kYXl9L3tqb2JfbWF4X2RheX0pIikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9sb2dvdXQoc2VsZiwgYWNjb3VudF9pZDogaW50LCB1c2VybmFtZTogc3RyID0gTm9uZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIMSRw6MgbG9nb3V0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVzZXJuYW1lOiBVc2VybmFtZSDEkeG7gyBsb2cgKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBU4bqhbyBtZXNzYWdlIHbhu5tpIG5nw6B5IGdp4budIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKQogICAgICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYiUGjDoXQgaGnhu4duIGxvZ291dDoge2N1cnJlbnRfdGltZX0iCiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IHTDoGkga2hv4bqjbiB7dXNlcm5hbWUgb3IgYWNjb3VudF9pZH0gbMOgIGxvZ291dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nb3V0IGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lIG9yIGFjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAKICAgIGRlZiByZXNldF9pbmFjdGl2ZV9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGluYWN0aXZlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImluYWN0aXZlIikgb3IgW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gaW5hY3RpdmVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgduG6q24gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyB0w6BpIGtob+G6o24gaW5hY3RpdmUiKQogICAgICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UgdHJvbmcgdGhyZWFkIHJpw6puZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQ6IFRocmVhZCDEkWFuZyBjaOG6oXkgSm9iU2VydmljZSBob+G6t2MgTm9uZSBu4bq/dSBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6t3QgdHLhuqFuZyB0aMOhaSBydW5uaW5nCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcgxJHhu4MgdmVyaWZ5IGzhuqFpIHThu6sgxJHhuqd1CiAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZC5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgY291bnRlcnMga2hpIGLhuq90IMSR4bqndSBwaGnDqm4gbeG7m2kKICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDbGVhciBhY2NvdW50IHRyYWNraW5nIHbDoCByZXNldCBlcnJvciBjb3VudGVycyDEkeG7gyB2ZXJpZnkgbOG6oWkgdOG7qyDEkeG6p3Uga2hpIGto4bufaSDEkeG7mW5nIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgbGFzdF9jYXJlX3RpbWUgdsOgIHNlc3Npb24gY291bnRlcnMgY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIMSR4buDIGLhuq90IMSR4bqndSBwaGnDqm4gbeG7m2kKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlJlc2V0IGxhc3RfY2FyZV90aW1lIHbDoCBzZXNzaW9uIGNvdW50ZXJzIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDEkeG7gyBi4bqvdCDEkeG6p3UgcGhpw6puIG3hu5tpIikKICAgICAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7fQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgibGFzdF9jYXJlX3RpbWUiLCAwKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsibGFzdF9jYXJlX3RpbWUiXSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBzZXNzaW9uIGNvdW50ZXJzIGtoaSBi4bqvdCDEkeG6p3UgcGhpw6puIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhLnVwZGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSByZXNldCBsYXN0X2NhcmVfdGltZSB2w6Agc2Vzc2lvbiBjb3VudGVyczoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gdGhyZWFkCiAgICAgICAgICAgIHRocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYucnVuKQogICAgICAgICAgICB0aHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgICB0aHJlYWQuc3RhcnQoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHRocmVhZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgIGRlZiByZXNldF9sb2dvdXRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgcmVzZXQgY8OhYyB0w6BpIGtob+G6o24gbG9nb3V0IHbhu4EgYWN0aXZlIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgQ2jhu4kgbsOqbiBn4buNaSBtZXRob2QgbsOgeSBraGkgY8OzIHnDqnUgY+G6p3UgxJHhurdjIGJp4buHdCB04burIGFkbWluCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24g4bufIHRy4bqhbmcgdGjDoWkgbG9nb3V0CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ291dF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJsb2dvdXQiKSBvciBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBsb2dvdXRfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCB0w6BpIGtob+G6o24gbG9nb3V0IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBmZXRjaCBqb2IgZXJyb3IgY291bnRzIGtoaSByZXNldCB0w6BpIGtob+G6o24gbG9nb3V0CiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLCAKICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSByZXNldCB0w6BpIGtob+G6o24gbG9nb3V0IikKICAgIAogICAgZGVmIGlzX2FjY291bnRfY2FuX3J1bl9qb2Ioc2VsZiwgYXBwX25hbWU6c3RyICkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGNo4bqheSBqb2Iga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgIGlmKHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhuqF5IEpvYlNlcnZpY2UgdHJvbmcgdsOybmcgbOG6t3AgxJHGoW4gZ2nhuqNuIC0gbOG6pXkgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBKb2JTZXJ2aWNlIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHThu7EgxJHhu5luZy4uLiIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGRldmljZV9pZAogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQgaGnhu4duIHThuqFpLCBKb2JTZXJ2aWNlIGtow7RuZyB0aOG7gyBjaOG6oXkiKQogICAgICAgICAgICByZXR1cm4KIAogICAgICAgIHdoaWxlIHNlbGYucnVubmluZzoKICAgICAgICAgICAgIyBSZXNldCBiaeG6v24gZm9yY2Vfc3RvcCBu4bq/dSBjw7MKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICBpZiBzZWxmLmRiLmdldCgicGF1c2Vfam9iIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPDsyB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciwgdOG6oW0gZOG7q25nIHjhu60gbMO9IGpvYiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBraGkgYuG7iyB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdHJhY2tpbmcgdmFyaWFibGUga2hpIHVucmVnaXN0ZXIgcHJveHkKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUikKICAgICAgICAgICAgICAgIGpvYl9jaGVja19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBzZWxmLnJlc2V0X2luYWN0aXZlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiDEkcSDbmcga8O9IHByb3h5IGtow7RuZwogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB0csaw4bubYywgY2jhu4kgcXXDqXQgbOG6oWkga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9pc19jdXJyZW50X2FjY291bnRfc3RpbGxfd29ya2FibGUoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkPhuqduIHTDrG0gdMOgaSBraG/huqNuIG3hu5tpIMSR4buDIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X3RvX3dvcmsgPSBzZWxmLl9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50KCkKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50X3RvX3dvcms6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBhY2NvdW50X3RvX3dvcmsKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBt4bubaToge2FjY291bnRfdG9fd29yay5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUaeG6v3AgdOG7pWMgduG7m2kgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaToge2FjY291bnRfdG9fd29yay5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3RvX3dvcms6CiAgICAgICAgICAgICAgICAgICAgIyBUxINuZyBjb3VudGVyIGtow7RuZyBjw7Mgam9iCiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyAobOG6p24ge3NlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50fSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVW5yZWdpc3RlciBwcm94eSBuZ2F5IGtoaSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyB0aeG6v3Qga2nhu4dtCiAgICAgICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJVbnJlZ2lzdGVyIHByb3h5IGRvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHRyYWNraW5nIHZhcmlhYmxlIGtoaSB1bnJlZ2lzdGVyIHByb3h5CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgxJDDs25nIHThuqV0IGPhuqMgYXBwIHNhdSAzIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID49IDM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOzbmcgdOG6pXQgY+G6oyBhcHAgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MgdHJvbmcgdGjhu51pIGdpYW4gZMOgaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSwgaGFuZGxlciBpbiBzZWxmLmpvYl9oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IGRvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoaGFuZGxlciwgYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIMSRw7NuZyBhcHA6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX05PX0FDQ09VTlRTKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmdo4buJIG3hu5l0IGtob+G6o25nIG5n4bqvbiB0csaw4bubYyBraGkga2nhu4NtIHRyYSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBraGkgY8OzIHTDoGkga2hv4bqjbiDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRmV0Y2ggR29MaWtlIGhlYWRlcnMgLSDEkeG6o20gYuG6o28gY8OzIHByb3h5IG7hur91IGPhuqduIGZldGNoIGhlYWRlcnMgbeG7m2kKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBsw6BtIG3hu5tpIEdvTGlrZSBoZWFkZXJzIGtow7RuZwogICAgICAgICAgICAgICAgICAgIG5lZWRzX2hlYWRlcnNfcmVmcmVzaCA9IHNlbGYuZ29saWtlX3NlcnZpY2UubmVlZHNfaGVhZGVyc19yZWZyZXNoKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgbuG6v3UgY+G6p24gZmV0Y2ggaGVhZGVycyBt4bubaQogICAgICAgICAgICAgICAgICAgIGlmIG5lZWRzX2hlYWRlcnNfcmVmcmVzaDoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKCJGZXRjaCBHb0xpa2UgaGVhZGVycyIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIGZldGNoIEdvTGlrZSBoZWFkZXJzLCBuZ2jhu4kgMTBzIHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBuZWVkc19oZWFkZXJzX3JlZnJlc2g6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiR29MaWtlIGhlYWRlcnMgY8OybiBo4bujcCBs4buHLCBraMO0bmcgY+G6p24gxJHEg25nIGvDvSBwcm94eSDEkeG7gyBmZXRjaCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGludGVybmV0IHNhdSBraGkgeOG7rSBsw70gcHJveHkgKHbDrCBwcm94eSBjw7MgdGjhu4Mg4bqjbmggaMaw4bufbmcgxJHhur9uIGvhur90IG7hu5FpKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmhlbHBlci5jaGVja19pbnRlcm5ldCgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIGPDsyBr4bq/dCBu4buRaSBpbnRlcm5ldCwgbmdo4buJIDIwcyB2w6AgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDIwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZ29saWtlX2hlYWRlcnMgPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLmZldGNoX2dvbGlrZV9oZWFkZXJzX3dpdGhfcmV0cnkoKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBnb2xpa2VfaGVhZGVyczoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkdvTGlrZSBoZWFkZXJzIGtow7RuZyBo4bujcCBs4buHLCBuZ2jhu4kgNXMgdsOgIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg1KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGZldGNoIEdvTGlrZSBoZWFkZXJzOiB7ZX0sIG5naOG7iSA1cyB2w6AgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBGb3JjZSB2ZXJpZnkgYWNjb3VudCBu4bq/dSBjaMawYSDEkcaw4bujYyB2ZXJpZnkgdsOgIGPDsyBwcm94eSBu4bq/dSBj4bqnbgogICAgICAgICAgICAgICAgc2VsZi5fZm9yY2VfdmVyaWZ5X2FjY291bnRzX3dpdGhfcHJveHkoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gbuG6v3UgY+G6p24gdHLGsOG7m2Mga2hpIGzDoG0gam9iCiAgICAgICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnMgYW5kIHNlbGYuX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRzX2Zvcl9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICMgU2F1IGtoaSDEkeG7k25nIGLhu5ksIGNsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSR4buDIHF1w6l0IGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgYW5kIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJhcHAiKSA9PSBhcHBfbmFtZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2xlYXIgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSBzYXUga2hpIMSR4buTbmcgYuG7mSB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcgdHLGsOG7m2Mga2hpIGzDoG0gam9iCiAgICAgICAgICAgICAgICBhY2NvdW50X3RvX3dvcmsgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfdG9fd29ya1siaWQiXSkKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3RvX3dvcmsgb3Igbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnRfdG9fd29yayk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ga2jDtG5nIHRo4buDIGzDoG0gdmnhu4djIG7hu69hLCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCB2w6wga2jDtG5nIHRo4buDIGzDoG0gdmnhu4djIG7hu69hCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBuw6puIMSRw7NuZyBhcHAga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYW5kX2Nsb3NlX2FwcF9pZl9uZWVkZWQoYWNjb3VudF90b193b3JrLmdldCgiYXBwIikgaWYgYWNjb3VudF90b193b3JrIGVsc2UgTm9uZSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCB24bubaSB0aMO0bmcgdGluIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIGzDoG0gam9iIChu4bq/dSBj4bqnbikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiTMOgbSBqb2IiKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgbMOgbSBqb2IsIG5naOG7iSAxMHMgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgICAgICBqb2JfcmVzdWx0ID0gc2VsZi5fd29ya193aXRoX3NpbmdsZV9hY2NvdW50KGFjY291bnRfdG9fd29yaykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgbsOqbiDEkcOzbmcgYXBwIHNhdSBraGkgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgICAgICBpZiBub3Qgam9iX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGPDsyBs4buXaSwgY2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgcXXDqXQgbOG6oWkKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRo4buDIGPhuqduIMSRw7NuZyBhcHAKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChhY2NvdW50X3RvX3dvcmsuZ2V0KCJhcHAiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuq9uIGdp4buvYSBjw6FjIGzhuqduIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldCgiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCIpCiAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICMgTmjhuqMgcHJveHkga2hpIHRob8OhdAogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGtoaSBKb2JTZXJ2aWNlIGThu6tuZyIpCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAjIFJlc2V0IHRyYWNraW5nIHZhcmlhYmxlIGtoaSB1bnJlZ2lzdGVyIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIG5o4bqjIHByb3h5OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcCBraGkgdGhvw6F0IEpvYlNlcnZpY2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSwgaGFuZGxlciBpbiBzZWxmLmpvYl9oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOzbmcgYXBwIHthcHBfbmFtZX0ga2hpIEpvYlNlcnZpY2UgZOG7q25nIikKICAgICAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9hbmRfdXBkYXRlX3N0YXR1cyhoYW5kbGVyLCBhcHBfbmFtZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIMSRw7NuZyBhcHA6IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJKb2JTZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgICAgICAgICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgSm9iU2VydmljZSIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgZGVmIGZvcmNlX3N0b3BfYWxsKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZyIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQoKICAgIGRlZiBoYW5kbGVfbXF0dF9hY2NvdW50X3VwZGF0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBj4bqtcCBuaOG6rXQgYWNjb3VudCB04burIE1RVFQgc2VydmVyCiAgICAgICAgQWNjb3VudCBz4bq9IMSRxrDhu6NjIHJlbG9hZCBzYXUgbeG7l2kgam9iIHRyb25nIGNvbnRpbnVvdXMgcHJvY2Vzc2luZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgdGjDtG5nIGLDoW8gY+G6rXAgbmjhuq10IGFjY291bnQgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgCiAgICBkZWYgaGFuZGxlX21xdHRfZm9yY2Vfc3RhcnRfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB5w6p1IGPhuqd1IGLhuq90IMSR4bqndSBsw6BtIHZp4buHYyBuZ2F5IGzhuq1wIHThu6ljIHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBMb2dpYyBt4bubaSBraMO0bmcgY8OzIHNlc3Npb24gY29vbGRvd24gbsOqbiBraMO0bmcgY+G6p24geOG7rSBsw70gZ8OsIMSR4bq3YyBiaeG7h3QKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIG5nYXkgbOG6rXAgdOG7qWMgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgICAgICMgVHJvbmcgbG9naWMgbeG7m2ksIEpvYlNlcnZpY2Ugc+G6vSB04buxIMSR4buZbmcgbOG6pXkgam9iIGxpw6puIHThu6VjIG7Dqm4ga2jDtG5nIGPhuqduIHjhu60gbMO9IGfDrCB0aMOqbQogICAgICAgICAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9jb25maWdfdXBkYXRlKHNlbGYsIGNvbmZpZ19jaGFuZ2VzOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPhuq1wIG5o4bqtdCBjb25maWcgdOG7qyBNUVRUIHNlcnZlcgogICAgICAgIExvZ2ljIG3hu5tpIGtow7RuZyBj4bqnbiByZXN0YXJ0IHNlc3Npb24sIGNvbmZpZyBz4bq9IMSRxrDhu6NjIMOhcCBk4bulbmcgbmdheSBs4bqtcCB04bupYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZ19jaGFuZ2VzOiBEaWN0aW9uYXJ5IGNo4bupYSBjw6FjIHRoYXkgxJHhu5VpIGNvbmZpZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgdGjDtG5nIGLDoW8gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAgICAgIyBMb2dpYyBt4bubaSBraMO0bmcgY+G6p24geOG7rSBsw70gxJHhurdjIGJp4buHdCwgY29uZmlnIHPhur0gxJHGsOG7o2MgxJHhu41jIGzhuqFpIHThu6sgREIgbeG7l2kgbOG6p24gbOG6t3AKCiAgICBkZWYgc2h1dGRvd24oc2VsZik6CiAgICAgICAgIiIixJDDs25nIGThu4tjaCB24bulLCBk4burbmcgdOG6pXQgY+G6oyB3b3JrZXIgdGhyZWFkcyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBk4burbmcKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTaHV0ZG93biBQcm94eVNlcnZpY2UgKHPhur0gdOG7sSDEkeG7mW5nIHVucmVnaXN0ZXIgcHJveHkgdsOgIGThu6tuZyB1cGRhdGUgdGhyZWFkKQogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdwcm94eV9zZXJ2aWNlJykgYW5kIHNlbGYucHJveHlfc2VydmljZToKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS5zaHV0ZG93bigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSDEkeG7gyB0csOhbmggbOG7l2kgdGhyZWFkCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2RiJykgYW5kIHNlbGYuZGI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBzaHV0ZG93biBKb2JTZXJ2aWNlIikKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PSBQUk9YWSBDT05WRU5JRU5DRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09CiAgICBkZWYgcmVzZXRfY3VycmVudF9wcm94eV9pcChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IElQIGNobyBwcm94eSBoaeG7h24gdOG6oWkgKGPDsyB0aOG7gyBn4buNaSB0cm9uZyBxdcOhIHRyw6xuaCBsw6BtIHZp4buHYykKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHJlc2V0IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5mb3JjZV9yZXNldF9jdXJyZW50X2lwKCkKICAgIAogICAgZGVmIGdldF9wcm94eV9zdGF0dXMoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRy4bqhbmcgdGjDoWkgcHJveHkgaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBUcuG6oW5nIHRow6FpIHByb3h5CiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5nZXRfcHJveHlfc3RhdHVzKCkKICAgIAogICAgZGVmIGdldF9wcm94eV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gcHJveHkgaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRow7RuZyB0aW4gcHJveHkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9pbmZvKCkKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PSBFTkQgUFJPWFkgQ09OVkVOSUVOQ0UgTUVUSE9EUyA9PT09PT09PT09PT09PT09PT09PQogICAgICAgICAgICAKICAgICMgREVQUkVDQVRFRDogS2jDtG5nIGTDuW5nIG7hu69hLCB0aGF5IGLhurFuZyBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAjIGRlZiBfaGFzX2FjY291bnRzX3JlYWR5X2Zvcl93b3JrKHNlbGYpIC0+IGJvb2w6CiAgICAjICAgICAiIiIKICAgICMgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcKICAgICMgICAgIAogICAgIyAgICAgUmV0dXJuczoKICAgICMgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAiIiIKICAgICMgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgIyAgICAgCiAgICAjICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgIyAgICAgICAgIGlmIHNlbGYuaXNfYWNjb3VudF9jYW5fcnVuX2pvYihhcHBfbmFtZSk6CiAgICAjICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHThu6sgdOG6pXQgY+G6oyBhcHAgdsOgIHPhuq9wIHjhur9wIHRoZW8gYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIHPhuq9wIHjhur9wCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gW10KICAgICAgICAKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhur9tIHPhu5EgbMaw4bujbmcgdMOgaSBraG/huqNuIHRoZW8gdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzdGF0dXNfY291bnRzID0ge30KICAgICAgICAgICAgZm9yIGFjYyBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIHN0YXR1cyA9IGFjYy5nZXQoJ3N0YXR1cycsICdhY3RpdmUnKQogICAgICAgICAgICAgICAgc3RhdHVzX2NvdW50c1tzdGF0dXNdID0gc3RhdHVzX2NvdW50cy5nZXQoc3RhdHVzLCAwKSArIDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG9nIHRo4buRbmcga8OqIHRy4bqhbmcgdGjDoWkKICAgICAgICAgICAgc3RhdHVzX2luZm8gPSAiLCAiLmpvaW4oW2Yie3N0YXR1c306IHtjb3VudH0iIGZvciBzdGF0dXMsIGNvdW50IGluIHN0YXR1c19jb3VudHMuaXRlbXMoKV0pCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthcHBfbmFtZX0gLSB7c3RhdHVzX2luZm99IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG7jWMgY8OhYyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbih3b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLmV4dGVuZCh3b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgIAogICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbzoKICAgICAgICAjIDEuIEFwcCBuYW1lICjEkeG7gyBuaMOzbSBjw7luZyBhcHAgbOG6oWkgduG7m2kgbmhhdSkKICAgICAgICAjIDIuIE5nw6B5IHThuqFvIHTDoGkga2hv4bqjbiAoY3JlYXRlZF9hdCkgLSBjxakgbmjhuqV0IHRyxrDhu5tjCiAgICAgICAgIyAzLiBT4buRIGpvYiDEkcOjIGzDoG0gaMO0bSBuYXkgKMOtdCBuaOG6pXQgdHLGsOG7m2MpIC0gdGhheSBjaG8gam9ic19kb25lX2luX3Nlc3Npb24KICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgeC5nZXQoImNyZWF0ZWRfYXQiLCAwKSwKICAgICAgICAgICAgeC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgKSkKICAgICAgICAKICAgICAgICByZXR1cm4gYWxsX3dvcmthYmxlX2FjY291bnRzCiAgICAgICAgCiAgICBkZWYgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjoKICAgICAgICAxLiBUw6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCAobG9nZ2VkX2luID0gVHJ1ZSkKICAgICAgICAyLiBUw6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHRoZW8gdGjhu6kgdOG7sSBhcHAsIG5nw6B5IHThuqFvCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogQWNjb3VudCBkYXRhIG7hur91IHTDrG0gdGjhuqV5LCBOb25lIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMTogVMOsbSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB0csaw4bubYyAoZMO5bmcgdHJhY2tpbmcgaGnhu4duIHThuqFpKQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyBraGkgbOG6p24gxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIGFwcCBuw6B5IChjaOG7iSBraGkgY+G6p24pCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAjIENo4buJIHZlcmlmeSBraGkga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyB0cm9uZyB0cmFja2luZyBob+G6t2Mga2hpIHRyYWNraW5nIGtow7RuZyBo4bujcCBs4buHCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBs4bqnbiDEkeG6p3UuLi4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50X2xvZ2luX3N0YXR1c193aXRoX3JlYWxpdHkoYXBwX25hbWUsIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJHDoyB0aOG7rSB2ZXJpZnkgxJHhu4Mga2jDtG5nIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBDw7MgdHJhY2tpbmcgcuG7k2ksIGtow7RuZyBj4bqnbiB2ZXJpZnkgbmdheQogICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB04burIHRyYWNraW5nCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZWRfaW5fYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgIGlmIGFjY291bnQgYW5kIHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgY8OzIHRo4buDIGzDoG0gdmnhu4djOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIGjhu6NwIGzhu4csIHjDs2Ega2jhu49pIHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCwgeyJsb2dnZWRfaW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIGRvIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMjogVMOsbSB0w6BpIGtob+G6o24gxJHEg25nIG5o4bqtcCB04burIGRhdGFiYXNlIChmYWxsYmFjaykKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAjIMavdSB0acOqbiB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB04burIERCCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgibG9nZ2VkX2luIiwgRmFsc2UpIGFuZCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXAgdHJvbmcgREI6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMzogTuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgbOG6pXkgdMOgaSBraG/huqNuIHRoZW8gdGjhu6kgdOG7sQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5leHRlbmQod29ya2FibGVfYWNjb3VudHMpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGFsbF93b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBT4bqvcCB44bq/cCB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puOiBhcHAsIG5nw6B5IHThuqFvLCBz4buRIGpvYiBow7RtIG5heQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICB4LmdldCgiY3JlYXRlZF9hdCIsIDApLAogICAgICAgICAgICB4LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIGFjY291bnQgPSBhbGxfd29ya2FibGVfYWNjb3VudHNbMF0KICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2M6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YWNjb3VudC5nZXQoJ2FwcCcpfSkiKQogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX3dvcmtfd2l0aF9zaW5nbGVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCB0w6BpIGtob+G6o24gLSB0aOG7sWMgaGnhu4duIG3hu5l0IGpvYiBkdXkgbmjhuqV0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIAogICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBQcm94eSDEkcOjIMSRxrDhu6NjIHjhu60gbMO9IOG7nyBuZ2/DoGksIGtow7RuZyBj4bqnbiBraeG7g20gdHJhIGzhuqFpIOG7nyDEkcOieQogICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBjaHV54buDbiB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgICAgIG5lZWRzX2FjY291bnRfc3dpdGNoID0gbm90IGFjY291bnQuZ2V0KCJsb2dnZWRfaW4iLCBGYWxzZSkKICAgICAgICAgICAgY3VycmVudF9hY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgSVAgcHJveHkgY2jhu4kga2hpIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgIyBDaOG7iSByZXNldCBJUCBraGkgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ga2jDoWMgaG/hurdjIGzhuqduIMSR4bqndSB0acOqbgogICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgIT0gY3VycmVudF9hY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgSVAgcHJveHkgY2hvIHTDoGkga2hv4bqjbiBt4bubaToge3VzZXJuYW1lfSAoSUQ6IHtjdXJyZW50X2FjY291bnRfaWR9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBJUCDEkeG7gyBjw7MgSVAgbeG7m2kgY2hvIHTDoGkga2hv4bqjbiBt4bubaSAgCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBJUCB0aMOgbmggY8O0bmcgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAgICAgICAgICMgTMawdSBs4bqhaSBhY2NvdW50X2lkIMSRw6MgcmVzZXQgxJHhu4MgdHLDoW5oIHJlc2V0IGzhurdwIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gY3VycmVudF9hY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJSZXNldCBJUCB0aOG6pXQgYuG6oWkgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCB0aeG6v3AgdOG7pWMgduG7m2kgSVAgaGnhu4duIHThuqFpIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkcaw4bujYyByZXNldCBJUCB0csaw4bubYyDEkcOzLCBi4buPIHF1YSByZXNldCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4buJIGNodXnhu4NuIHTDoGkga2hv4bqjbiBraGkgY+G6p24gdGhp4bq/dAogICAgICAgICAgICBpZiBuZWVkc19hY2NvdW50X3N3aXRjaDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX21hcmtfYWNjb3VudF9sb2dvdXQoYWNjb3VudCwgIktow7RuZyB0aOG7gyBjaHV54buDbiB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBUcuG6oyB24buBIEZhbHNlIMSR4buDIGLDoW8gaGnhu4d1IGzhu5dpIGNodXnhu4NuIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgc2F1IGtoaSBjaHV54buDbiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhhcHBfbmFtZSwgY3VycmVudF9hY2NvdW50X2lkLCBUcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSRxINuZyBuaOG6rXAsIGLhu48gcXVhIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGpvYiB24bubaSBlcnJvciBoYW5kbGluZwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkzhuqV5IGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBqb2IgPSBoYW5kbGVyLmZldGNoX2pvYihhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlc2V0IGVycm9yIGNvdW50IGtoaSBmZXRjaCBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X2FjY291bnRfaWQgaW4gc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7Mgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgS2jDtG5nIGPDsyBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaSwga2jDtG5nIMSRw7NuZyBhcHAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgIyBUxINuZyBlcnJvciBjb3VudCBraGkgZmV0Y2ggam9iIGzhu5dpCiAgICAgICAgICAgICAgICBlcnJvcl9jb3VudCA9IHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50cy5nZXQoY3VycmVudF9hY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gZXJyb3JfY291bnQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGzhuqV5IGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gKGzhuqduIHtlcnJvcl9jb3VudH0vNSk6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTuG6v3UgbOG7l2kgNSBs4bqnbiBsacOqbiB0aeG6v3AsIGNobyB0w6BpIGtob+G6o24gbmdo4buJIDMwIHBow7p0CiAgICAgICAgICAgICAgICBpZiBlcnJvcl9jb3VudCA+PSA1OgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gbOG7l2kgZmV0Y2ggam9iIHtlcnJvcl9jb3VudH0gbOG6p24gbGnDqm4gdGnhur9wLCBjaG8gbmdo4buJIDMwIHBow7p0IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWN1cnJlbnRfYWNjb3VudF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz0zMCwKICAgICAgICAgICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiTOG7l2kgZmV0Y2ggam9iIHtlcnJvcl9jb3VudH0gbOG6p24gbGnDqm4gdGnhur9wIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGVycm9yIGNvdW50IHNhdSBraGkgxJHhurd0IGluYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2N1cnJlbnRfYWNjb3VudF9pZF0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY+G6p24gdMOsbSB0w6BpIGtob+G6o24ga2jDoWMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgTOG7l2kgbmjGsG5nIGNoxrBhIMSR4bq/biBnaeG7m2kgaOG6oW4sIHRo4butIGzhuqFpIHNhdQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGV2aWNlIG1lc3NhZ2UKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2RldmljZV9tZXNzYWdlX2Zvcl9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYiBmb2xsb3cgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAgICAgaWYgbm90IHNlbGYuX3ZhbGlkYXRlX2ZvbGxvd19qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IsIGhhbmRsZXIsIHVzZXJuYW1lKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIFNraXAgam9iIGtow7RuZyBwaOG6o2kgbOG7l2ksIGtow7RuZyDEkcOzbmcgYXBwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIGpvYiBi4bqxbmcgaGFuZGxlcgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fdmFsaWRhdGVfam9iX3dpdGhfaGFuZGxlcihhY2NvdW50LCBqb2IsIGhhbmRsZXIpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaSwga2jDtG5nIMSRw7NuZyBhcHAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtqb2IuZ2V0KCd0eXBlJywgJ3Vua25vd24nKX0iKQogICAgICAgICAgICBqb2JfcmVzdWx0ID0gaGFuZGxlci5leGVjdXRlX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjIGpvYiAoYmFvIGfhu5NtIGLDoW8gY8OhbyB2w6AgY+G6rXAgbmjhuq10IHRo4buRbmcga8OqKQogICAgICAgICAgICBzZWxmLl9oYW5kbGVfam9iX3Jlc3VsdChhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQsIGhhbmRsZXIsIHVzZXJuYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMw6BtIGNoxINtIHPDs2Mgc2F1IGtoaSBo4bq/dCBqb2IgKG7hur91IMSRxrDhu6NjIGLhuq10IHbDoCBjaMawYSBsw6BtIHRyb25nIHBoacOqbiBuw6B5KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjYXJlX2luX3dvcmtpbmdfam9iID0gc2VsZi5kYi5nZXQoImNhcmVfaW5fd29ya2luZ19qb2IiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIGNhcmVfaW5fd29ya2luZ19qb2IgYW5kIGhhc2F0dHIoaGFuZGxlciwgInBlcmZvcm1fY2FyZSIpIGFuZCBjYWxsYWJsZShoYW5kbGVyLnBlcmZvcm1fY2FyZSk6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIGzDoG0gY2jEg20gc8OzYyB0cm9uZyBwaGnDqm4gbsOgeSBjaMawYQogICAgICAgICAgICAgICAgICAgIGxhc3RfY2FyZV90aW1lID0gYWNjb3VudC5nZXQoImxhc3RfY2FyZV90aW1lIiwgMCkKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgY2jGsGEgbMOgbSBjaMSDbSBzw7NjIHRyb25nIHBoacOqbiBuw6B5IChsYXN0X2NhcmVfdGltZSA9IDAgaG/hurdjIGtow6FjIHNlc3Npb24gaGnhu4duIHThuqFpKQogICAgICAgICAgICAgICAgICAgIGlmIGxhc3RfY2FyZV90aW1lID09IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBjaMSDbSBzw7NjIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAobOG6p24gxJHhuqd1IHRyb25nIHBoacOqbikiKQogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjhu51pIGdpYW4gbMOgbSBjaMSDbSBzw7NjCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImxhc3RfY2FyZV90aW1lIjogaW50KGN1cnJlbnRfdGltZSkKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGzDoG0gY2jEg20gc8OzYyB0cm9uZyBwaGnDqm4gbsOgeSwgYuG7jyBxdWEiKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBjaMSDbSBzw7NjIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLSMOUTkcgxJHDs25nIGFwcCBzYXUgbeG7l2kgam9iIC0gY2jhu4kgxJHDs25nIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIGpvYiB24bubaSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSBsw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBUcuG6oyB24buBIEZhbHNlIMSR4buDIGLDoW8gaGnhu4d1IGPDsyBs4buXaQogICAgICAgICAgICAKICAgIGRlZiBfY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKHNlbGYsIGhhbmRsZXIsIGFwcF9uYW1lOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIMSQw7NuZyBhcHAgdsOgIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlcgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGhhbmRsZXIuY2xvc2VfYXBwKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaSBsb2dnZWRfaW4gY+G7p2EgdMOgaSBraG/huqNuIHRyb25nIGFwcCBuw6B5CiAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgICAgICJsb2dnZWRfaW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2hpIMSRw7NuZyBhcHAiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw7NuZyBhcHAgdsOgIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpOiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfY2hlY2tfYW5kX2Nsb3NlX2FwcF9pZl9uZWVkZWQoc2VsZiwgYXBwX25hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgxJHDs25nIGFwcCBu4bq/dSBraMO0bmcgY8OybiB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAgY+G6p24ga2nhu4NtIHRyYQogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBhcHBfbmFtZToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8gYXBwIG7DoHkga2jDtG5nCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHdvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OybiB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0sIMSRw7NuZyBhcHAiKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9hbmRfdXBkYXRlX3N0YXR1cyhoYW5kbGVyLCBhcHBfbmFtZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPDsm4ge2xlbih3b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0sIGdp4buvIGFwcCBt4bufIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBraeG7g20gdHJhIHbDoCDEkcOzbmcgYXBwIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgCiAgICBkZWYgX21hcmtfYWNjb3VudF9sb2dvdXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHJlYXNvbjogc3RyID0gIlBow6F0IGhp4buHbiBsb2dvdXQiKToKICAgICAgICAiIiIKICAgICAgICDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGxvZ291dCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcAogICAgICAgICIiIgogICAgICAgIGltcG9ydCBkYXRldGltZQogICAgICAgIGN1cnJlbnRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgbG9nb3V0X21lc3NhZ2UgPSBmIntyZWFzb259OiB7Y3VycmVudF90aW1lfSIKICAgICAgICAKICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogbG9nb3V0X21lc3NhZ2UsCiAgICAgICAgICAgICJsb2dnZWRfaW4iOiBGYWxzZSwKICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0pCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcgdHJvbmcgbWVtb3J5CiAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPT0gYWNjb3VudFsiaWQiXToKICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRbJ2lkJ119ICh7YXBwX25hbWV9KSBraOG7j2kgdHJhY2tpbmcgZG8gbG9nb3V0IikKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2RldmljZV9tZXNzYWdlX2Zvcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZSBjaG8gam9iIGhp4buHbiB04bqhaQogICAgICAgICIiIgogICAgICAgIGxpbmsgPSBqb2IuZ2V0KCdsaW5rJywgJycpCiAgICAgICAgaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycpOgogICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycsICcnKQogICAgICAgIGVsaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy50aWt0b2suY29tLycpOgogICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy50aWt0b2suY29tLycsICcnKQogICAgICAgIAogICAgICAgIG1lc3NhZ2UgPSBmIlt7YWNjb3VudC5nZXQoJ2FwcCcpfV1be2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX1dW3tqb2IuZ2V0KCd0eXBlJyl9XVt7bGlua31dIgogICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIG1lc3NhZ2UpCiAgICAgICAgCiAgICBkZWYgX2hhbmRsZV9qb2JfcmVzdWx0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCBqb2JfcmVzdWx0OiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlciwgdXNlcm5hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBr4bq/dCBxdeG6oyBj4bunYSBqb2Igc2F1IGtoaSB0aOG7sWMgaGnhu4duCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGPDsyBs4buXaQogICAgICAgICIiIgogICAgICAgIGpvYl9zdGF0dXMgPSBqb2JfcmVzdWx0WyJzdGF0dXMiXQogICAgICAgIGpvYl9zdWNjZXNzID0gam9iX3Jlc3VsdFsic3VjY2VzcyJdCiAgICAgICAgam9iX21lc3NhZ2UgPSBqb2JfcmVzdWx0WyJtZXNzYWdlIl0KICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IGZvbGxvdyBqb2IgxJHhurdjIGJp4buHdAogICAgICAgIGlmIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2hhbmRsZV9mb2xsb3dfam9iX3Jlc3VsdChhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQsIGhhbmRsZXIsIHVzZXJuYW1lKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEThu6tuZyB24bubaSB0w6BpIGtob+G6o24gbsOgeSBuaMawbmcgdGnhur9wIHThu6VjIGzDoG0gdmnhu4djCiAgICAgICAgCiAgICAgICAgIyBCw6FvIGPDoW8ga+G6v3QgcXXhuqMKICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCBqb2JfcmVzdWx0KQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqCiAgICAgICAgc2VsZi5fdXBkYXRlX2pvYl9zdGF0cyhhY2NvdW50LCBqb2Jfc3VjY2Vzcywgam9iLmdldCgidHlwZSIsICIiKSwgam9iX3Jlc3VsdCkKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZSAgIyBUaMOgbmggY8O0bmcKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2ZvbGxvd19qb2JfcmVzdWx0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCBqb2JfcmVzdWx0OiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlciwgdXNlcm5hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBr4bq/dCBxdeG6oyDEkeG6t2MgYmnhu4d0IGNobyBmb2xsb3cgam9iCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aeG6v3AgdOG7pWMgduG7m2kgdMOgaSBraG/huqNuIG7DoHksIEZhbHNlIG7hur91IGPhuqduIGThu6tuZwogICAgICAgICIiIgogICAgICAgIGpvYl9zdGF0dXMgPSBqb2JfcmVzdWx0WyJzdGF0dXMiXQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gbOG7l2kgZm9sbG93IHBlbmRpbmcgKHN0YXR1cyA0KSB2w6AgZ+G7rWkgecOqdSBj4bqndSBjaOG7nSBkdXnhu4d0IChzdGF0dXMgNSkKICAgICAgICBpZiBqb2Jfc3RhdHVzIGluIFs0LCA1XToKICAgICAgICAgICAgY250ID0gc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMuZ2V0KGFjY291bnRbImlkIl0sIDApICsgMQogICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IGNudAogICAgICAgICAgICBpZiBjbnQgPj0gNToKICAgICAgICAgICAgICAgIHN0YXR1c19tc2cgPSAiZm9sbG93IHBlbmRpbmciIGlmIGpvYl9zdGF0dXMgPT0gNCBlbHNlICJn4butaSB5w6p1IGPhuqd1IGNo4budIGR1eeG7h3QiCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgNSBs4bqnbiBsacOqbiB0aeG6v3Age3N0YXR1c19tc2d9LCB04bqhbSBk4burbmcgdMOgaSBraG/huqNuIikKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPWYiTGnDqm4gdGnhur9wIGzhu5dpIHtzdGF0dXNfbXNnfSIpCiAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBE4burbmcgduG7m2kgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGRpc2FibGUgZm9sbG93IG7hur91IMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICBzZWxmLl9jaGVja19hbmRfZGlzYWJsZV9mb2xsb3dfYWZ0ZXJfam9iKGFjY291bnQsIHVzZXJuYW1lKQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FuZF9kaXNhYmxlX2ZvbGxvd19hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHVzZXJuYW1lOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIGRpc2FibGUgZm9sbG93IG7hur91IMSR4bqhdCBnaeG7m2kgaOG6oW4gc2F1IGtoaSBsw6BtIGpvYgogICAgICAgICIiIgogICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkKICAgICAgICBtYXhfZm9sbG93X3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2ZvbGxvd19zZXNzaW9uIiwgNSkKICAgICAgICBmb2xsb3dfdG9kYXkgPSBhY2NvdW50LmdldCgiZm9sbG93X3RvZGF5IiwgMCkKICAgICAgICBtYXhfZm9sbG93X2RheSA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X2RheSIsIDIwKQogICAgICAgIAogICAgICAgICMgTuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbiBwaGnDqm4gaG/hurdjIG5nw6B5IHRow6wgZGlzYWJsZSBmb2xsb3cKICAgICAgICBpZiBmb2xsb3dfaW5fc2Vzc2lvbiA+PSBtYXhfZm9sbG93X3Nlc3Npb24gb3IgZm9sbG93X3RvZGF5ID49IG1heF9mb2xsb3dfZGF5OgogICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXMgPSBzZWxmLmRiLmdldCgidW5mb2xsb3dfcGVuYWx0eV9taW51dGVzIiwgNzIwKSAgIyBN4bq3YyDEkeG7i25oIDEyIGdp4budID0gNzIwIHBow7p0CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgLSBwZW5hbHR5X21pbnV0ZXMgdOG7qyBEQjoge3BlbmFsdHlfbWludXRlc30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHThu6sgZGJfc2VydmljZSB0aGF5IHbDrCB1cGRhdGVfYWNjb3VudCB0cuG7sWMgdGnhur9wCiAgICAgICAgICAgIHNlbGYuZGIuZGlzYWJsZV9hY2NvdW50X2ZvbGxvdygKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudFsiaWQiXSwKICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICByZWFzb249IsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3ciCiAgICAgICAgICAgICkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93LCBraMOzYSBmb2xsb3cgxJHhur9uIHtwZW5hbHR5X21pbnV0ZXN9IHBow7p0IikKICAgICAgICAgICAgCiAgICBkZWYgX3ZhbGlkYXRlX2pvYl93aXRoX2hhbmRsZXIoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGhhbmRsZXIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgam9iIGLhurFuZyBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBqb2IgaOG7o3AgbOG7hywgRmFsc2UgbuG6v3UgY+G6p24gc2tpcCBob+G6t2MgY29udGludWUKICAgICAgICAiIiIKICAgICAgICB2YWxpZGF0aW9uX3Jlc3VsdCA9IGhhbmRsZXIudmFsaWRhdGVfam9iX2JlZm9yZV9leGVjdXRpb24oYWNjb3VudCwgam9iKQogICAgICAgIGlmIG5vdCB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInZhbGlkIiwgVHJ1ZSk6CiAgICAgICAgICAgIGlmIHZhbGlkYXRpb25fcmVzdWx0LmdldCgic2hvdWxkX3NraXAiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIFNraXAgam9iCiAgICAgICAgICAgICAgICBza2lwX21lc3NhZ2UgPSB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiSm9iIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU2tpcCBqb2I6IHtza2lwX21lc3NhZ2V9IikKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsIAogICAgICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBza2lwX21lc3NhZ2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU2tpcCBqb2IgbOG7l2k6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNraXBfc2xlZXBfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDEwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOZ2jhu4kge3NraXBfc2xlZXBfdGltZX1zIHNhdSBraGkgc2tpcCBqb2IgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJKb2Iga2jDtG5nIGjhu6NwIGzhu4c6IHt2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnVW5rbm93biBlcnJvcicpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX3ZhbGlkYXRlX2ZvbGxvd19qb2JfYmVmb3JlX2V4ZWN1dGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlciwgdXNlcm5hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBWYWxpZGF0ZSBmb2xsb3cgam9iIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgdGjhu7FjIGhp4buHbiwgRmFsc2UgbuG6v3UgY+G6p24gc2tpcAogICAgICAgICIiIgogICAgICAgICMgQ2jhu4kgdmFsaWRhdGUgY2hvIGpvYiBmb2xsb3cKICAgICAgICBpZiBqb2IuZ2V0KCJ0eXBlIiwgIiIpLmxvd2VyKCkgIT0gImZvbGxvdyI6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkKICAgICAgICBtYXhfZm9sbG93X3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2ZvbGxvd19zZXNzaW9uIiwgNSkKICAgICAgICBkaXNhYmxlX2ZvbGxvdyA9IGFjY291bnQuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIsIEZhbHNlKQogICAgICAgIGZvbGxvd19kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImZvbGxvd19kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICBub3cgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgYuG7iyBraMOzYSBmb2xsb3cga2jDtG5nCiAgICAgICAgaWYgZGlzYWJsZV9mb2xsb3c6CiAgICAgICAgICAgIGlmIGZvbGxvd19kaXNhYmxlX3VudGlsID4gMCBhbmQgZm9sbG93X2Rpc2FibGVfdW50aWwgPD0gbm93OgogICAgICAgICAgICAgICAgIyBI4bq/dCB0aOG7nWkgZ2lhbiBraMOzYSwgZW5hYmxlIGzhuqFpIGZvbGxvdwogICAgICAgICAgICAgICAgc2VsZi5kYi5lbmFibGVfYWNjb3VudF9mb2xsb3coYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVuG6q24gxJFhbmcgYuG7iyBraMOzYSBmb2xsb3cKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJFhbmcgYuG7iyBraMOzYSBmb2xsb3csIGjhu6d5IGpvYiIpCiAgICAgICAgICAgICAgICByZXN1bHRfc2tpcCA9IHsKICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIlTDoGkga2hv4bqjbiDEkWFuZyBi4buLIGtow7NhIGZvbGxvdyIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICMgcmVwb3J0X2pvYiBz4bq9IHThu7EgxJHhu5luZyBza2lwIGpvYiBraGkgc3RhdHVzID0gMgogICAgICAgICAgICAgICAgaGFuZGxlci5yZXBvcnRfam9iKGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCByZXN1bHRfc2tpcCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlJlY29yZCBqb2IgaGlzdG9yeSBs4buXaToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBo4buneSBqb2IgZm9sbG93IMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoc2tpcF9zbGVlcF90aW1lKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbgogICAgICAgIGlmIGZvbGxvd19pbl9zZXNzaW9uID49IG1heF9mb2xsb3dfc2Vzc2lvbjoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbiAoe2ZvbGxvd19pbl9zZXNzaW9ufS97bWF4X2ZvbGxvd19zZXNzaW9ufSksIGjhu6d5IGpvYiIpCiAgICAgICAgICAgIHJlc3VsdF9za2lwID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsCiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBwaGnDqm4iCiAgICAgICAgICAgIH0KICAgICAgICAgICAgIyByZXBvcnRfam9iIHPhur0gdOG7sSDEkeG7mW5nIHNraXAgam9iIGtoaSBzdGF0dXMgPSAyCiAgICAgICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlJlY29yZCBqb2IgaGlzdG9yeSBs4buXaToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNraXBfc2xlZXBfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDEwKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBo4buneSBqb2IgZm9sbG93IMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQ==').decode('utf-8'))
