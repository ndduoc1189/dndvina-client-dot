import base64
exec(base64.b64decode('aW1wb3J0IHNxbGl0ZTMKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHV1aWQKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwsIFVuaW9uCmltcG9ydCBjb25maWcKCmNsYXNzIERhdGFiYXNlU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9wYXRoOiBzdHIgPSAiZGF0YS5kYiIsIGRlZmF1bHRfY29uZmlnX3BhdGg6IHN0ciA9ICJkZWZhdWx0Q29uZmlnLmpzb24iKToKICAgICAgICBzZWxmLmRiX3BhdGggPSBkYl9wYXRoCiAgICAgICAgc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoID0gZGVmYXVsdF9jb25maWdfcGF0aAogICAgICAgIHNlbGYubG9jYWwgPSB0aHJlYWRpbmcubG9jYWwoKSAgIyBMxrB1IHRy4buvIHJpw6puZyBjaG8gbeG7l2kgdGhyZWFkCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBzZWxmLl9pbml0X2RiKCkKICAgICAgICAKICAgIGRlZiBfZ2V0X2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIiIiTOG6pXkga+G6v3QgbuG7kWkgU1FMaXRlIGNobyB0aHJlYWQgaGnhu4duIHThuqFpIiIiCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZi5sb2NhbCwgJ2Nvbm4nKSBvciBzZWxmLmxvY2FsLmNvbm4gaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5sb2NhbC5jb25uID0gc3FsaXRlMy5jb25uZWN0KHNlbGYuZGJfcGF0aCkKICAgICAgICByZXR1cm4gc2VsZi5sb2NhbC5jb25uCiAgICAgICAgCiAgICBkZWYgX2luaXRfZGIoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPhuqV1IHRyw7pjIGRhdGFiYXNlIG7hur91IGNoxrBhIHThu5NuIHThuqFpIiIiCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLmRiX3BhdGgpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIGNvbmZpZwogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGNvbmZpZyAoCiAgICAgICAgICAgIGtleSBURVhUIFBSSU1BUlkgS0VZLAogICAgICAgICAgICB2YWx1ZSBURVhUCiAgICAgICAgKQogICAgICAgICcnJykKICAgICAgICAKICAgICAgICAjIFThuqFvIGLhuqNuZyBhY2NvdW50IHbhu5tpIHV1aWQKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnJycKICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBhY2NvdW50cyAoCiAgICAgICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVksCiAgICAgICAgICAgIGFjY291bnRfdXVpZCBURVhUIFVOSVFVRSwKICAgICAgICAgICAgYXBwIFRFWFQsCiAgICAgICAgICAgIG5pY2tuYW1lIFRFWFQsCiAgICAgICAgICAgIHVuaXF1ZV9pZCBURVhULAogICAgICAgICAgICB1bmlxdWVfdXNlcm5hbWUgVEVYVCwKICAgICAgICAgICAgc3RhdHVzIFRFWFQsCiAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbiBURVhULAogICAgICAgICAgICBpc19sb2dpbiBJTlRFR0VSLAogICAgICAgICAgICBhdmF0YXJfdGh1bWIgVEVYVCwKICAgICAgICAgICAgdG90YWxfam9icyBJTlRFR0VSLAogICAgICAgICAgICBqb2JfZW5hYmxlIElOVEVHRVIsCiAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsIElOVEVHRVIsCiAgICAgICAgICAgIGpvYl90b2RheSBJTlRFR0VSLAogICAgICAgICAgICBqb2JfbWF4X2RheSBJTlRFR0VSLAogICAgICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiBJTlRFR0VSLAogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiBJTlRFR0VSLAogICAgICAgICAgICBsYXN0X2pvYl90aW1lIElOVEVHRVIsCiAgICAgICAgICAgIGxhc3RfdXBkYXRlIElOVEVHRVIsCiAgICAgICAgICAgIGNhcmVfdG9kYXkgSU5URUdFUiwKICAgICAgICAgICAgaXNfZ29saWtlX2xpbmtlZCBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZ29saWtlX2lkIFRFWFQsCiAgICAgICAgICAgIGRldmljZV9pZCBURVhULAogICAgICAgICAgICBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBkYXRhIFRFWFQKICAgICAgICApCiAgICAgICAgJycnKQogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIGpvYnNfaGlzdG9yeSDEkeG7gyBsxrB1IGzhu4tjaCBz4butIGpvYgogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGpvYnNfaGlzdG9yeSAoCiAgICAgICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVksCiAgICAgICAgICAgIGpvYl91dWlkIFRFWFQgVU5JUVVFLAogICAgICAgICAgICBhY2NvdW50X3V1aWQgVEVYVCwKICAgICAgICAgICAgZGV2aWNlX2lkIFRFWFQsCiAgICAgICAgICAgIGFwcCBURVhULAogICAgICAgICAgICBqb2JfaWQgVEVYVCwKICAgICAgICAgICAgam9iX3R5cGUgVEVYVCwKICAgICAgICAgICAgb2JqZWN0X2lkIFRFWFQsCiAgICAgICAgICAgIGxpbmsgVEVYVCwKICAgICAgICAgICAgc3RhdHVzIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBzdWNjZXNzIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBwcmljZSBSRUFMIERFRkFVTFQgMCwKICAgICAgICAgICAgZXJyb3JfbWVzc2FnZSBURVhULAogICAgICAgICAgICBjcmVhdGVkX2F0IElOVEVHRVIsCiAgICAgICAgICAgIGxhc3RfdXBkYXRlIElOVEVHRVIsCiAgICAgICAgICAgIGlzX3N5bmMgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGRhdGEgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBhY2NvdW50X3V1aWQgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiUFJBR01BIHRhYmxlX2luZm8oYWNjb3VudHMpIikKICAgICAgICBjb2x1bW5zID0gW3Jvd1sxXSBmb3Igcm93IGluIGN1cnNvci5mZXRjaGFsbCgpXQogICAgICAgIGlmICJhY2NvdW50X3V1aWQiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBhY2NvdW50X3V1aWQgVEVYVCBVTklRVUUiKQogICAgICAgICAgICAjIFThuqFvIFVVSUQgY2hvIGPDoWMgdMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWkKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBpZCBGUk9NIGFjY291bnRzIikKICAgICAgICAgICAgYWNjb3VudHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WzBdCiAgICAgICAgICAgICAgICBhY2NvdW50X3V1aWQgPSBzdHIodXVpZC51dWlkNCgpKQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlVQREFURSBhY2NvdW50cyBTRVQgYWNjb3VudF91dWlkID0gPyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF91dWlkLCBhY2NvdW50X2lkKSkKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgYWNjb3VudF91dWlkIHbDoG8gYuG6o25nIGFjY291bnRzIHbDoCB04bqhbyBVVUlEIGNobyBjw6FjIHTDoGkga2hv4bqjbiBoaeG7h24gY8OzIikKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBpc19zeW5jIG7hur91IGNoxrBhIHThu5NuIHThuqFpCiAgICAgICAgaWYgImlzX3N5bmMiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgaXNfc3luYyB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBj4buZdCBkaXNhYmxlX2ZvbGxvdyBu4bq/dSBjaMawYSBjw7MKICAgICAgICBpZiAiZGlzYWJsZV9mb2xsb3ciIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBkaXNhYmxlX2ZvbGxvdyBJTlRFR0VSIERFRkFVTFQgMCIpCiAgICAgICAgICAgIHByaW50KCLEkMOjIHRow6ptIGPhu5l0IGRpc2FibGVfZm9sbG93IHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAKICAgICAgICAjIFRow6ptIGPhu5l0IGZvbGxvd19kaXNhYmxlX3VudGlsIG7hur91IGNoxrBhIGPDswogICAgICAgIGlmICJmb2xsb3dfZGlzYWJsZV91bnRpbCIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGZvbGxvd19kaXNhYmxlX3VudGlsIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgZm9sbG93X2Rpc2FibGVfdW50aWwgdsOgbyBi4bqjbmcgYWNjb3VudHMiKQogICAgICAgIAogICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHThu6sgY29uZmlnLnB5CiAgICAgICAgc2VsZi5pbml0X2RlZmF1bHRfY29uZmlnKCkKICAgICAgICAKICAgIGRlZiBsb2FkX2RlZmF1bHRfY29uZmlnKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIsSQ4buNYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHThu6sgZmlsZSIiIgogICAgICAgIGlmIG9zLnBhdGguZXhpc3RzKHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihzZWxmLmRlZmF1bHRfY29uZmlnX3BhdGgsICdyJykgYXMgZjoKICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWQoZikKICAgICAgICByZXR1cm4ge30KICAgICAgICAKICAgIGRlZiBnZXQoc2VsZiwga2V5OiBzdHIsIGRlZmF1bHQ9Tm9uZSkgLT4gQW55OgogICAgICAgICIiIkzhuqV5IGdpw6EgdHLhu4sgY+G6pXUgaMOsbmggdOG7qyBEQiwgbuG6v3Uga2jDtG5nIGPDsyB0aMOsIGzhuqV5IHThu6sgZGVmYXVsdCBjb25maWciIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIHZhbHVlIEZST00gY29uZmlnIFdIRVJFIGtleSA9ID8iLCAoa2V5LCkpCiAgICAgICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAKICAgICAgICBpZiByZXN1bHQ6CiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIHbhu4Ega2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICAgICAgdmFsdWUgPSByZXN1bHRbMF0KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHModmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgTOG6pXkgdOG7qyBkZWZhdWx0IGNvbmZpZwogICAgICAgICAgICBkZWZhdWx0X2NvbmZpZyA9IHNlbGYubG9hZF9kZWZhdWx0X2NvbmZpZygpCiAgICAgICAgICAgIGlmIGtleSBpbiBkZWZhdWx0X2NvbmZpZzoKICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0X2NvbmZpZ1trZXldCiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0CiAgICAKICAgIGRlZiBzZXQoc2VsZiwga2V5OiBzdHIsIHZhbHVlOiBBbnkpIC0+IGJvb2w6CiAgICAgICAgIiIiTMawdSBnacOhIHRy4buLIGPhuqV1IGjDrG5oIHbDoG8gREIiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBk4buvIGxp4buHdSBwaOG7qWMgdOG6oXAgdGjDoG5oIEpTT04KICAgICAgICBpZiBpc2luc3RhbmNlKHZhbHVlLCAoZGljdCwgbGlzdCkpOgogICAgICAgICAgICB2YWx1ZSA9IGpzb24uZHVtcHModmFsdWUpCiAgICAgICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBjb25maWcgKGtleSwgdmFsdWUpIFZBTFVFUyAoPywgPykiLAogICAgICAgICAgICAgICAgKGtleSwgdmFsdWUpCiAgICAgICAgICAgICkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbMawdSBj4bqldSBow6xuaDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBkZWxldGUoc2VsZiwga2V5OiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiWMOzYSBt4buZdCBj4bqldSBow6xuaCBraOG7j2kgZGF0YWJhc2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBrZXk6IEtow7NhIGPhuqV1IGjDrG5oIGPhuqduIHjDs2EKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGNvbmZpZyBXSEVSRSBrZXkgPSA/IiwgKGtleSwpKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB4w7NhIGPhuqV1IGjDrG5oIHtrZXl9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHNhdmVfZGV2aWNlX2luZm8oc2VsZiwgZGV2aWNlX2luZm86IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIkzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4sgdsOgbyBj4bqldSBow6xuaCIiIgogICAgICAgIHJldHVybiBzZWxmLnNldCgiZGV2aWNlX2luZm8iLCBkZXZpY2VfaW5mbykKICAgIAogICAgZGVmIGdldF9kZXZpY2VfaW5mbyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiJM4bqleSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyDEkcOjIGzGsHUiIiIKICAgICAgICBkZXZpY2VfaW5mbyA9IHNlbGYuZ2V0KCJkZXZpY2VfaW5mbyIsIHt9KQogICAgICAgIHJldHVybiBkZXZpY2VfaW5mbwogICAgCiAgICBkZWYgYWRkX2FjY291bnQoc2VsZiwgYWNjb3VudF9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJUaMOqbSB0w6BpIGtob+G6o24gbeG7m2kgdsOgbyBkYXRhYmFzZSIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgSW1wb3J0IGNvbmZpZyBtb2R1bGUKICAgICAgICBpbXBvcnQgY29uZmlnIGFzIGNvbmZpZ19tb2R1bGUKICAgICAgICAKICAgICAgICAjIE7hur91IGtow7RuZyBjw7MgZGV2aWNlX2lkLCBz4butIGThu6VuZyBkZXZpY2VfaWQgaGnhu4duIHThuqFpCiAgICAgICAgZGV2aWNlX2lkID0gYWNjb3VudF9kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAKICAgICAgICAjIFTDoWNoIGThu68gbGnhu4d1IGNow61uaCB2w6AgZOG7ryBsaeG7h3UgcGjhu6UKICAgICAgICBtYWluX2RhdGEgPSB7CiAgICAgICAgICAgICJhcHAiOiBhY2NvdW50X2RhdGEuZ2V0KCJhcHAiLCAiIiksCiAgICAgICAgICAgICJuaWNrbmFtZSI6IGFjY291bnRfZGF0YS5nZXQoIm5pY2tuYW1lIiwgIiIpLAogICAgICAgICAgICAidW5pcXVlX2lkIjogYWNjb3VudF9kYXRhLmdldCgidW5pcXVlX2lkIiwgIiIpLAogICAgICAgICAgICAidW5pcXVlX3VzZXJuYW1lIjogYWNjb3VudF9kYXRhLmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLAogICAgICAgICAgICAic3RhdHVzIjogYWNjb3VudF9kYXRhLmdldCgic3RhdHVzIiwgImluYWN0aXZlIiksCiAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJpbmFjdGl2ZV9yZWFzb24iLCAiIiksCiAgICAgICAgICAgICJpc19sb2dpbiI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiaXNfbG9naW4iLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiYXZhdGFyX3RodW1iIjogYWNjb3VudF9kYXRhLmdldCgiYXZhdGFyX3RodW1iIiwgIiIpLAogICAgICAgICAgICAidG90YWxfam9icyI6IGFjY291bnRfZGF0YS5nZXQoInRvdGFsX2pvYnMiLCAwKSwKICAgICAgICAgICAgImpvYl9lbmFibGUiOiAxIGlmIGFjY291bnRfZGF0YS5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApLAogICAgICAgICAgICAiam9iX3RvZGF5IjogYWNjb3VudF9kYXRhLmdldCgiam9iX3RvZGF5IiwgMCksCiAgICAgICAgICAgICJqb2JfbWF4X2RheSI6IGFjY291bnRfZGF0YS5nZXQoImpvYl9tYXhfZGF5IiwgY29uZmlnX21vZHVsZS5NQVhfSk9CU19QRVJfREFZKSwKICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogYWNjb3VudF9kYXRhLmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKSwKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogYWNjb3VudF9kYXRhLmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCBjb25maWdfbW9kdWxlLk1BWF9KT0JTX1BFUl9TRVNTSU9OKSwKICAgICAgICAgICAgImxhc3Rfam9iX3RpbWUiOiBhY2NvdW50X2RhdGEuZ2V0KCJsYXN0X2pvYl90aW1lIiwgMCksCiAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICJjYXJlX3RvZGF5IjogYWNjb3VudF9kYXRhLmdldCgiY2FyZV90b2RheSIsIDApLAogICAgICAgICAgICAiaXNfZ29saWtlX2xpbmtlZCI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJnb2xpa2VfaWQiOiBhY2NvdW50X2RhdGEuZ2V0KCJnb2xpa2VfaWQiLCAiIiksCiAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICJpc19zeW5jIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJpc19zeW5jIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IGFjY291bnRfZGF0YS5nZXQoImZvbGxvd19kaXNhYmxlX3VudGlsIiwgMCksCiAgICAgICAgICAgICJhY2NvdW50X3V1aWQiOiBhY2NvdW50X2RhdGEuZ2V0KCJhY2NvdW50X3V1aWQiLCBzdHIodXVpZC51dWlkNCgpKSksICAjIFThuqFvIFVVSUQgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgTMawdSBJRCB04burIGThu68gbGnhu4d1IMSR4bqndSB2w6BvIG7hur91IGPDswogICAgICAgIGlmICJpZCIgaW4gYWNjb3VudF9kYXRhOgogICAgICAgICAgICBtYWluX2RhdGFbImlkIl0gPSBhY2NvdW50X2RhdGFbImlkIl0KICAgICAgICAKICAgICAgICAjIEzGsHUgZOG7ryBsaeG7h3UgcGjhu6UgZMaw4bubaSBk4bqhbmcgSlNPTgogICAgICAgIGV4dHJhX2RhdGEgPSB7azogdiBmb3IgaywgdiBpbiBhY2NvdW50X2RhdGEuaXRlbXMoKSBpZiBrIG5vdCBpbiBtYWluX2RhdGF9CiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb2x1bW5zID0gIiwgIi5qb2luKG1haW5fZGF0YS5rZXlzKCkpCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyA9ICIsICIuam9pbihbIj8iXSAqIGxlbihtYWluX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgdmFsdWVzID0gbGlzdChtYWluX2RhdGEudmFsdWVzKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHbDoG8gY3Xhu5FpCiAgICAgICAgICAgIGNvbHVtbnMgKz0gIiwgZGF0YSIKICAgICAgICAgICAgcGxhY2Vob2xkZXJzICs9ICIsID8iCiAgICAgICAgICAgIHZhbHVlcy5hcHBlbmQoanNvbi5kdW1wcyhleHRyYV9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGFjY291bnRzICh7Y29sdW1uc30pIFZBTFVFUyAoe3BsYWNlaG9sZGVyc30pIgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgdmFsdWVzKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB0aMOqbSB0w6BpIGtob+G6o246IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHVwZGF0ZV9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCwgZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpCiAgICAgICAgYWNjb3VudCA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgZOG7ryBsaeG7h3UKICAgICAgICBhY2NvdW50LnVwZGF0ZShkYXRhKQogICAgICAgIGFjY291bnRbImxhc3RfdXBkYXRlIl0gPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgCiAgICAgICAgIyBMxrB1IGzhuqFpCiAgICAgICAgcmV0dXJuIHNlbGYuYWRkX2FjY291bnQoYWNjb3VudCkKICAgIAogICAgZGVmIGdldF9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gY+G7p2EgbeG7mXQgdMOgaSBraG/huqNuIHRoZW8gSUQiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF9pZCwpKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICBhY2NvdW50ID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgYWNjb3VudFsiaXNfbG9naW4iXSA9IGJvb2woYWNjb3VudFsiaXNfbG9naW4iXSkKICAgICAgICBhY2NvdW50WyJqb2JfZW5hYmxlIl0gPSBib29sKGFjY291bnRbImpvYl9lbmFibGUiXSkKICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBib29sKGFjY291bnRbImlzX3N5bmMiXSkKICAgICAgICBpZiAiZGlzYWJsZV9mb2xsb3ciIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImRpc2FibGVfZm9sbG93Il0gPSBib29sKGFjY291bnRbImRpc2FibGVfZm9sbG93Il0pCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9ieV91dWlkKHNlbGYsIGFjY291bnRfdXVpZDogc3RyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgdGjDtG5nIHRpbiBj4bunYSBt4buZdCB0w6BpIGtob+G6o24gdGhlbyBVVUlEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgYWNjb3VudF91dWlkID0gPyIsIChhY2NvdW50X3V1aWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgaWYgImRpc2FibGVfZm9sbG93IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgIAogICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbImRhdGEiXSkKICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgCiAgICBkZWYgZ2V0X2FjY291bnRzKHNlbGYsIGFwcDogc3RyID0gTm9uZSwgc3RhdHVzOiBzdHIgPSBOb25lLCBqb2JfZW5hYmxlOiBib29sID0gTm9uZSwgZGV2aWNlX2lkOiBBbnkgPSBUcnVlKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiJM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiB0aGVvIMSRaeG7gXUga2nhu4duIGzhu41jCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwOiBUw6puIOG7qW5nIGThu6VuZyDEkeG7gyBs4buNYwogICAgICAgICAgICBzdGF0dXM6IFRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIMSR4buDIGzhu41jCiAgICAgICAgICAgIGpvYl9lbmFibGU6IEzhu41jIHRoZW8gdHLhuqFuZyB0aMOhaSBi4bqtdC904bqvdCBqb2IKICAgICAgICAgICAgZGV2aWNlX2lkOiBM4buNYyB0aGVvIGRldmljZV9pZCwgY8OzIHRo4buDIGzDoDoKICAgICAgICAgICAgICAgIC0gVHJ1ZTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaSAobeG6t2MgxJHhu4tuaCkKICAgICAgICAgICAgICAgIC0gRmFsc2UvTm9uZTogS2jDtG5nIGzhu41jIHRoZW8gZGV2aWNlX2lkCiAgICAgICAgICAgICAgICAtIENodeG7l2k6IEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6UgdGjhu4MgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbwogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHF1ZXJ5ID0gIlNFTEVDVCAqIEZST00gYWNjb3VudHMiCiAgICAgICAgcGFyYW1zID0gW10KICAgICAgICAKICAgICAgICAjIFRow6ptIMSRaeG7gXUga2nhu4duIGzhu41jCiAgICAgICAgY29uZGl0aW9ucyA9IFtdCiAgICAgICAgaWYgYXBwOgogICAgICAgICAgICBjb25kaXRpb25zLmFwcGVuZCgiYXBwID0gPyIpCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoYXBwKQogICAgICAgIGlmIHN0YXR1czoKICAgICAgICAgICAgY29uZGl0aW9ucy5hcHBlbmQoInN0YXR1cyA9ID8iKQogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKHN0YXR1cykKICAgICAgICBpZiBqb2JfZW5hYmxlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBjb25kaXRpb25zLmFwcGVuZCgiam9iX2VuYWJsZSA9ID8iKQogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKDEgaWYgam9iX2VuYWJsZSBlbHNlIDApCiAgICAgICAgICAgIAogICAgICAgIGlmIGNvbmRpdGlvbnM6CiAgICAgICAgICAgIHF1ZXJ5ICs9ICIgV0hFUkUgIiArICIgQU5EICIuam9pbihjb25kaXRpb25zKQogICAgICAgICAgICAKICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgcGFyYW1zKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgIGFjY291bnRzID0gW10KICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgICAgIGFjY291bnQgPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgICAgICBhY2NvdW50WyJpc19sb2dpbiJdID0gYm9vbChhY2NvdW50WyJpc19sb2dpbiJdKQogICAgICAgICAgICBhY2NvdW50WyJqb2JfZW5hYmxlIl0gPSBib29sKGFjY291bnRbImpvYl9lbmFibGUiXSkKICAgICAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgICAgIGFjY291bnRbImlzX3N5bmMiXSA9IGJvb2woYWNjb3VudFsiaXNfc3luYyJdKQogICAgICAgICAgICBpZiAiZGlzYWJsZV9mb2xsb3ciIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgTOG7jWMgdGhlbyBkZXZpY2VfaWQgbuG6v3UgY+G6p24KICAgICAgICBpZiBkZXZpY2VfaWQgaXMgVHJ1ZToKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X2RldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGN1cnJlbnRfZGV2aWNlX2lkOgogICAgICAgICAgICAgICAgIyBM4buNYyB0w6BpIGtob+G6o24gdGhlbyBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgYWNjLmdldCgiZGV2aWNlX2lkIikgPT0gY3VycmVudF9kZXZpY2VfaWRdCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRldmljZV9pZCwgc3RyKSBhbmQgZGV2aWNlX2lkOgogICAgICAgICAgICAjIEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6UgdGjhu4MgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbwogICAgICAgICAgICBhY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBhY2MuZ2V0KCJkZXZpY2VfaWQiKSA9PSBkZXZpY2VfaWRdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50cwogICAgCiAgICBkZWYgZGVsZXRlX2FjY291bnQoc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBib29sOgogICAgICAgICIiIljDs2EgdMOgaSBraG/huqNuIGto4buPaSBkYXRhYmFzZSIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGFjY291bnRzIFdIRVJFIGlkID0gPyIsIChhY2NvdW50X2lkLCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5yb3djb3VudCA+IDAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIsSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSBj4bunYSB0aHJlYWQgaGnhu4duIHThuqFpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYubG9jYWwsICdjb25uJykgYW5kIHNlbGYubG9jYWwuY29ubjoKICAgICAgICAgICAgICAgIHNlbGYubG9jYWwuY29ubi5jbG9zZSgpCiAgICAgICAgICAgICAgICBzZWxmLmxvY2FsLmNvbm4gPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIGPDoWMgdGhhbSBjaGnhur91IHRocmVhZCDEkeG7gyB0csOhbmggbOG7l2kKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnbG9jYWwnKToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5sb2NhbCwgJ19sb2NhbF9faW1wbCcpOgogICAgICAgICAgICAgICAgICAgICMgWMOzYSB0aGFtIGNoaeG6v3UgdHJvbmcgVGhyZWFkTG9jYWwKICAgICAgICAgICAgICAgICAgICBkZWxhdHRyKHNlbGYubG9jYWwsICdfbG9jYWxfX2ltcGwnKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgxJHDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlOiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgICIiIkjhu6d5IMSR4buRaSB0xrDhu6NuZyIiIgogICAgICAgIHNlbGYuY2xvc2UoKQogICAgCiAgICBkZWYgdXBkYXRlX29yX2luc2VydF9hY2NvdW50KHNlbGYsIGFwcF9uYW1lOiBzdHIsIHVuaXF1ZV9pZDogc3RyLCBkYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgaG/hurdjIHRow6ptIG3hu5tpIG3hu5l0IHTDoGkga2hv4bqjbiB2w6BvIGRhdGFiYXNlCiAgICAgICAgIiIiCiAgICAgICAgIyDEkOG6o20gYuG6o28gY29ubmVjdGlvbiBsw6AgY+G7p2EgdGhyZWFkIGhp4buHbiB04bqhaQogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIHThu5NuIHThuqFpIGNoxrBhCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgIiIiU0VMRUNUIGlkIEZST00gYWNjb3VudHMgV0hFUkUgYXBwX25hbWUgPSA/IEFORCB1bmlxdWVfaWQgPSA/IiIiLCAKICAgICAgICAgICAgICAgIChhcHBfbmFtZSwgdW5pcXVlX2lkKQogICAgICAgICAgICApCiAgICAgICAgICAgIGFjY291bnQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYWNjb3VudDoKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiBoaeG7h24gY8OzCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudFswXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IGThu68gbGnhu4d1IGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiU0VMRUNUIGRhdGEgRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iIiIsCiAgICAgICAgICAgICAgICAgICAgKGFjY291bnRfaWQsKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY3VycmVudF9kYXRhX3JvdyA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgICAgICAgICBjdXJyZW50X2RhdGEgPSBqc29uLmxvYWRzKGN1cnJlbnRfZGF0YV9yb3dbMF0pIGlmIGN1cnJlbnRfZGF0YV9yb3cgZWxzZSB7fQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEjhu6NwIG5o4bqldCBk4buvIGxp4buHdSBjxakgdsOgIG3hu5tpCiAgICAgICAgICAgICAgICBtZXJnZWRfZGF0YSA9IHsqKmN1cnJlbnRfZGF0YSwgKipkYXRhfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdAogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiVVBEQVRFIGFjY291bnRzIFNFVCAKICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gPywKICAgICAgICAgICAgICAgICAgICAgICBuaWNrbmFtZSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0gPywKICAgICAgICAgICAgICAgICAgICAgICBpc19sb2dpbiA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgam9iX2VuYWJsZSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgam9iX21heF9kYXkgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIGxhc3RfdXBkYXRlID0gPwogICAgICAgICAgICAgICAgICAgICAgIFdIRVJFIGlkID0gPyIiIiwKICAgICAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgICAgIGpzb24uZHVtcHMobWVyZ2VkX2RhdGEpLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgibmlja25hbWUiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIiksCiAgICAgICAgICAgICAgICAgICAgICAgIDEgaWYgZGF0YS5nZXQoImlzX2xvZ2luIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgICAgICAgICAgICAgMSBpZiBkYXRhLmdldCgiam9iX2VuYWJsZSIsIFRydWUpIGVsc2UgMCwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoImpvYl9tYXhfZGF5IiwgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkpLAogICAgICAgICAgICAgICAgICAgICAgICBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUaMOqbSB0w6BpIGtob+G6o24gbeG7m2kKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIklOU0VSVCBJTlRPIGFjY291bnRzICgKICAgICAgICAgICAgICAgICAgICAgICBhcHBfbmFtZSwgdW5pcXVlX2lkLCBuaWNrbmFtZSwgZGF0YSwgc3RhdHVzLCBpc19sb2dpbiwgam9iX2VuYWJsZSwgam9iX21heF9kYXksIGlzX2dvbGlrZV9saW5rZWQsIGdvbGlrZV9pZCwgbGFzdF91cGRhdGUKICAgICAgICAgICAgICAgICAgICApIFZBTFVFUyAoPywgPywgPywgPywgPywgPywgPywgPywgPywgPywgPykiIiIsCiAgICAgICAgICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgICAgICAgICBhcHBfbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgdW5pcXVlX2lkLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgibmlja25hbWUiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgIGpzb24uZHVtcHMoZGF0YSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIiksCiAgICAgICAgICAgICAgICAgICAgICAgIDEgaWYgZGF0YS5nZXQoImlzX2xvZ2luIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgICAgICAgICAgICAgMSBpZiBkYXRhLmdldCgiam9iX2VuYWJsZSIsIFRydWUpIGVsc2UgMCwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoImpvYl9tYXhfZGF5IiwgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkpLAogICAgICAgICAgICAgICAgICAgICAgICAwLCAgIyBpc19nb2xpa2VfbGlua2VkCiAgICAgICAgICAgICAgICAgICAgICAgICIiLCAjIGdvbGlrZV9pZAogICAgICAgICAgICAgICAgICAgICAgICBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGPhuq1wIG5o4bqtdC90aMOqbSB0w6BpIGtob+G6o246IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJlc2V0X2xvZ2luX3N0YXR1c19ieV9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgbeG7mXQg4bupbmcgZOG7pW5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIChhcHAsIGtow7RuZyBwaOG6o2kgYXBwX25hbWUpCiAgICAgICAgIiIiCiAgICAgICAgIyDEkOG6o20gYuG6o28gY29ubmVjdGlvbiBsw6AgY+G7p2EgdGhyZWFkIGhp4buHbiB04bqhaQogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6AgxJHDoW5oIGThuqV1IGPhuqduIMSR4buTbmcgYuG7mQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICIiIlVQREFURSBhY2NvdW50cyBTRVQgaXNfbG9naW4gPSAwLCBpc19zeW5jID0gMCBXSEVSRSBhcHAgPSA/IiIiLAogICAgICAgICAgICAgICAgKGFwcF9uYW1lLCkKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDxaluZyBj4bqtcCBuaOG6rXQgdHLGsOG7nW5nIGlzX2xvZ2luIHRyb25nIGRhdGEgSlNPTgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICIiIlNFTEVDVCBpZCwgZGF0YSBGUk9NIGFjY291bnRzIFdIRVJFIGFwcCA9ID8iIiIsCiAgICAgICAgICAgICAgICAoYXBwX25hbWUsKQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbMV0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gdHJvbmcgZGF0YQogICAgICAgICAgICAgICAgZGF0YVsiaXNfbG9naW4iXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgICAgIGRhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSBs4bqhaSBkYXRhCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiIiJVUERBVEUgYWNjb3VudHMgU0VUIGRhdGEgPSA/IFdIRVJFIGlkID0gPyIiIiwKICAgICAgICAgICAgICAgICAgICAoanNvbi5kdW1wcyhkYXRhKSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbjoge2V9IikKICAgICAgICAgICAgY29ubi5yb2xsYmFjaygpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKCiAgICBkZWYgYWRkX2pvYl9oaXN0b3J5KHNlbGYsIGpvYl9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIFRow6ptIG3hu5l0IGLhuqNuIGdoaSBs4buLY2ggc+G7rSBqb2IgbeG7m2kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfZGF0YTogROG7ryBsaeG7h3Ugam9iIGPhuqduIGzGsHUKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVVUlEIGPhu6dhIGpvYiDEkcOjIHRow6ptCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIGpvYl91dWlkID0gam9iX2RhdGEuZ2V0KCJqb2JfdXVpZCIsIHN0cih1dWlkLnV1aWQ0KCkpKQogICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBkZXZpY2VfaWQsIHPhu60gZOG7pW5nIGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICBkZXZpY2VfaWQgPSBqb2JfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgCiAgICAgICAgIyBUw6FjaCBk4buvIGxp4buHdSBjaMOtbmggdsOgIGThu68gbGnhu4d1IHBo4bulCiAgICAgICAgbWFpbl9kYXRhID0gewogICAgICAgICAgICAiam9iX3V1aWQiOiBqb2JfdXVpZCwKICAgICAgICAgICAgImFjY291bnRfdXVpZCI6IGpvYl9kYXRhLmdldCgiYWNjb3VudF91dWlkIiwgIiIpLAogICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAiYXBwIjogam9iX2RhdGEuZ2V0KCJhcHAiLCAiIiksCiAgICAgICAgICAgICJqb2JfaWQiOiBqb2JfZGF0YS5nZXQoImpvYl9pZCIsICIiKSwKICAgICAgICAgICAgImpvYl90eXBlIjogam9iX2RhdGEuZ2V0KCJqb2JfdHlwZSIsICIiKSwKICAgICAgICAgICAgIm9iamVjdF9pZCI6IGpvYl9kYXRhLmdldCgib2JqZWN0X2lkIiwgIiIpLAogICAgICAgICAgICAibGluayI6IGpvYl9kYXRhLmdldCgibGluayIsICIiKSwKICAgICAgICAgICAgInN0YXR1cyI6IGpvYl9kYXRhLmdldCgic3RhdHVzIiwgMCksCiAgICAgICAgICAgICJzdWNjZXNzIjogMSBpZiBqb2JfZGF0YS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAicHJpY2UiOiBqb2JfZGF0YS5nZXQoInByaWNlIiwgMC4wKSwKICAgICAgICAgICAgImVycm9yX21lc3NhZ2UiOiBqb2JfZGF0YS5nZXQoImVycm9yX21lc3NhZ2UiLCAiIiksCiAgICAgICAgICAgICJjcmVhdGVkX2F0Ijogam9iX2RhdGEuZ2V0KCJjcmVhdGVkX2F0IiwgY3VycmVudF90aW1lKSwKICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogY3VycmVudF90aW1lLAogICAgICAgICAgICAiaXNfc3luYyI6IDAgICMgTeG6t2MgxJHhu4tuaCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgIyBMxrB1IElEIHThu6sgZOG7ryBsaeG7h3UgxJHhuqd1IHbDoG8gbuG6v3UgY8OzCiAgICAgICAgaWYgImlkIiBpbiBqb2JfZGF0YToKICAgICAgICAgICAgbWFpbl9kYXRhWyJpZCJdID0gam9iX2RhdGFbImlkIl0KICAgICAgICAKICAgICAgICAjIEzGsHUgZOG7ryBsaeG7h3UgcGjhu6UgZMaw4bubaSBk4bqhbmcgSlNPTgogICAgICAgIGV4dHJhX2RhdGEgPSB7azogdiBmb3IgaywgdiBpbiBqb2JfZGF0YS5pdGVtcygpIGlmIGsgbm90IGluIG1haW5fZGF0YSBhbmQgayAhPSAiZGF0YSJ9CiAgICAgICAgaWYgImRhdGEiIGluIGpvYl9kYXRhIGFuZCBpc2luc3RhbmNlKGpvYl9kYXRhWyJkYXRhIl0sIGRpY3QpOgogICAgICAgICAgICBleHRyYV9kYXRhLnVwZGF0ZShqb2JfZGF0YVsiZGF0YSJdKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY29sdW1ucyA9ICIsICIuam9pbihtYWluX2RhdGEua2V5cygpKQogICAgICAgICAgICBwbGFjZWhvbGRlcnMgPSAiLCAiLmpvaW4oWyI/Il0gKiBsZW4obWFpbl9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhbHVlcyA9IGxpc3QobWFpbl9kYXRhLnZhbHVlcygpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB2w6BvIGN14buRaQogICAgICAgICAgICBjb2x1bW5zICs9ICIsIGRhdGEiCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyArPSAiLCA/IgogICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKGpzb24uZHVtcHMoZXh0cmFfZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBxdWVyeSA9IGYiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBqb2JzX2hpc3RvcnkgKHtjb2x1bW5zfSkgVkFMVUVTICh7cGxhY2Vob2xkZXJzfSkiCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCB2YWx1ZXMpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIGpvYl91dWlkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB0aMOqbSBs4buLY2ggc+G7rSBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiIgogICAgCiAgICBkZWYgdXBkYXRlX2pvYl9oaXN0b3J5KHNlbGYsIGpvYl91dWlkOiBzdHIsIGRhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIGzhu4tjaCBz4butIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl91dWlkOiBVVUlEIGPhu6dhIGpvYiBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgZGF0YTogROG7ryBsaeG7h3UgY+G6rXAgbmjhuq10CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgam9iID0gc2VsZi5nZXRfam9iX2hpc3Rvcnkoam9iX3V1aWQpCiAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgZOG7ryBsaeG7h3UKICAgICAgICBqb2IudXBkYXRlKGRhdGEpCiAgICAgICAgam9iWyJsYXN0X3VwZGF0ZSJdID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgTMawdSBs4bqhaQogICAgICAgIHJldHVybiBib29sKHNlbGYuYWRkX2pvYl9oaXN0b3J5KGpvYikpCiAgICAKICAgIGRlZiBnZXRfam9iX2hpc3Rvcnkoc2VsZiwgam9iX3V1aWQ6IHN0cikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gbOG7i2NoIHPhu60gam9iIHRoZW8gVVVJRAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl91dWlkOiBVVUlEIGPhu6dhIGpvYiBj4bqnbiBs4bqleQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0IGhv4bq3YyBOb25lOiBUaMO0bmcgdGluIGpvYiBu4bq/dSB0w6xtIHRo4bqleSwgTm9uZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogRlJPTSBqb2JzX2hpc3RvcnkgV0hFUkUgam9iX3V1aWQgPSA/IiwgKGpvYl91dWlkLCkpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAKICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgIGpvYiA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGpvYlsic3VjY2VzcyJdID0gYm9vbChqb2JbInN1Y2Nlc3MiXSkKICAgICAgICBqb2JbImlzX3N5bmMiXSA9IGJvb2woam9iWyJpc19zeW5jIl0pCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGpvYiBhbmQgam9iWyJkYXRhIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGpvYlsiZGF0YSJdKQogICAgICAgICAgICAgICAgam9iLnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgaWYgImRhdGEiIGluIGpvYjoKICAgICAgICAgICAgZGVsIGpvYlsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBqb2IKICAgIAogICAgZGVmIGdldF9qb2JfaGlzdG9yeV9ieV9hY2NvdW50KHNlbGYsIGFjY291bnRfdXVpZDogc3RyLCBsaW1pdDogaW50ID0gNTApIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGzhu4tjaCBz4butIGpvYiBj4bunYSBt4buZdCB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X3V1aWQ6IFVVSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGxpbWl0OiBT4buRIGzGsOG7o25nIGLhuqNuIGdoaSB04buRaSDEkWEgdHLhuqMgduG7gQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCBs4buLY2ggc+G7rSBqb2IKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgIlNFTEVDVCAqIEZST00gam9ic19oaXN0b3J5IFdIRVJFIGFjY291bnRfdXVpZCA9ID8gT1JERVIgQlkgY3JlYXRlZF9hdCBERVNDIExJTUlUID8iLCAKICAgICAgICAgICAgKGFjY291bnRfdXVpZCwgbGltaXQpCiAgICAgICAgKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgIGpvYnMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgam9iID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICAgICAgam9iWyJzdWNjZXNzIl0gPSBib29sKGpvYlsic3VjY2VzcyJdKQogICAgICAgICAgICBqb2JbImlzX3N5bmMiXSA9IGJvb2woam9iWyJpc19zeW5jIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGpvYiBhbmQgam9iWyJkYXRhIl06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoam9iWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgam9iLnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgICAgICBpZiAiZGF0YSIgaW4gam9iOgogICAgICAgICAgICAgICAgZGVsIGpvYlsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgam9icy5hcHBlbmQoam9iKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gam9icwogICAgCiAgICBkZWYgZ2V0X3BlbmRpbmdfc3luY19pdGVtcyhzZWxmLCB0YWJsZTogc3RyLCBsaW1pdDogaW50ID0gMTAwLCBkZXZpY2VfaWQ6IEFueSA9IFRydWUpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRhbmggc8OhY2ggY8OhYyBi4bqjbiBnaGkgY2jGsGEgxJHGsOG7o2MgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFibGU6IFTDqm4gYuG6o25nICgnYWNjb3VudHMnIGhv4bq3YyAnam9ic19oaXN0b3J5JykKICAgICAgICAgICAgbGltaXQ6IFPhu5EgbMaw4bujbmcgYuG6o24gZ2hpIHThu5FpIMSRYSB0cuG6oyB24buBCiAgICAgICAgICAgIGRldmljZV9pZDogVGhp4bq/dCBi4buLIElEIMSR4buDIGzhu41jOgogICAgICAgICAgICAgICAgLSBUcnVlOiBM4buNYyB0aGVvIGRldmljZV9pZCBoaeG7h24gdOG6oWkgKG3hurdjIMSR4buLbmgpCiAgICAgICAgICAgICAgICAtIEZhbHNlL05vbmU6IEtow7RuZyBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgICAgICAgICAgLSBDaHXhu5dpOiBM4buNYyB0aGVvIGRldmljZV9pZCBj4bulIHRo4buDIMSRxrDhu6NjIHRydXnhu4FuIHbDoG8KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggYuG6o24gZ2hpIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICIiIgogICAgICAgIGlmIHRhYmxlIG5vdCBpbiBbJ2FjY291bnRzJywgJ2pvYnNfaGlzdG9yeSddOgogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdXVpZF9maWVsZCA9ICJhY2NvdW50X3V1aWQiIGlmIHRhYmxlID09ICJhY2NvdW50cyIgZWxzZSAiam9iX3V1aWQiCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSDEkWnhu4F1IGtp4buHbiBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgIGlmIGRldmljZV9pZCBpcyBUcnVlOgogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY3VycmVudF9kZXZpY2VfaWQgPSBzZWxmLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgcXVlcnkgPSBmIlNFTEVDVCAqIEZST00ge3RhYmxlfSBXSEVSRSBpc19zeW5jID0gMCBBTkQgZGV2aWNlX2lkID0gPyBMSU1JVCA/IgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgKGN1cnJlbnRfZGV2aWNlX2lkLCBsaW1pdCkpCiAgICAgICAgZWxpZiBkZXZpY2VfaWQ6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgZGV2aWNlX2lkIMSRxrDhu6NjIHRydXnhu4FuIHbDoG8KICAgICAgICAgICAgcXVlcnkgPSBmIlNFTEVDVCAqIEZST00ge3RhYmxlfSBXSEVSRSBpc19zeW5jID0gMCBBTkQgZGV2aWNlX2lkID0gPyBMSU1JVCA/IgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgKGRldmljZV9pZCwgbGltaXQpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgS2jDtG5nIGzhu41jIHRoZW8gZGV2aWNlX2lkCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJTRUxFQ1QgKiBGUk9NIHt0YWJsZX0gV0hFUkUgaXNfc3luYyA9IDAgTElNSVQgPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIChsaW1pdCwpKQogICAgICAgICAgICAKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICBpdGVtcyA9IFtdCiAgICAgICAgZm9yIHJlc3VsdCBpbiByZXN1bHRzOgogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgICAgICBpdGVtID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgICAgICBpZiAiZGF0YSIgaW4gaXRlbSBhbmQgaXRlbVsiZGF0YSJdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGl0ZW1bImRhdGEiXSkKICAgICAgICAgICAgICAgICAgICBpdGVtLnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgICAgICBpZiAiZGF0YSIgaW4gaXRlbToKICAgICAgICAgICAgICAgIGRlbCBpdGVtWyJkYXRhIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpdGVtcy5hcHBlbmQoaXRlbSkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGl0ZW1zCiAgICAKICAgIGRlZiBtYXJrX2FzX3N5bmNlZChzZWxmLCB0YWJsZTogc3RyLCB1dWlkX3ZhbHVlOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IGLhuqNuIGdoaSDEkcOjIMSRxrDhu6NjIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhYmxlOiBUw6puIGLhuqNuZyAoJ2FjY291bnRzJyBob+G6t2MgJ2pvYnNfaGlzdG9yeScpCiAgICAgICAgICAgIHV1aWRfdmFsdWU6IEdpw6EgdHLhu4sgVVVJRCBj4bunYSBi4bqjbiBnaGkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqtcCBuaOG6rXQgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiB0YWJsZSBub3QgaW4gWydhY2NvdW50cycsICdqb2JzX2hpc3RvcnknXToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHV1aWRfZmllbGQgPSAiYWNjb3VudF91dWlkIiBpZiB0YWJsZSA9PSAiYWNjb3VudHMiIGVsc2UgImpvYl91dWlkIgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICBmIlVQREFURSB7dGFibGV9IFNFVCBpc19zeW5jID0gMSBXSEVSRSB7dXVpZF9maWVsZH0gPSA/IiwKICAgICAgICAgICAgICAgICh1dWlkX3ZhbHVlLCkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBjdXJzb3Iucm93Y291bnQgPiAwCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgxJHDoyDEkeG7k25nIGLhu5k6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKCiAgICBkZWYgZ2V0X2RldmljZV9jb25maWcoc2VsZiwga2V5OiBzdHIsIGRlZmF1bHQ9Tm9uZSkgLT4gQW55OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogS2jDs2EgY+G6pXUgaMOsbmgKICAgICAgICAgICAgZGVmYXVsdDogR2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyB0w6xtIHRo4bqleQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBBbnk6IEdpw6EgdHLhu4sgY+G6pXUgaMOsbmggaG/hurdjIGdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaAogICAgICAgICIiIgogICAgICAgICMgTOG6pXkgY+G6pXUgaMOsbmggdOG7qyBkYXRhYmFzZQogICAgICAgIHJldHVybiBzZWxmLmdldChrZXksIGRlZmF1bHQpCgogICAgZGVmIHNldF9kZXZpY2VfY29uZmlnKHNlbGYsIGtleTogc3RyLCB2YWx1ZTogQW55KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFNldCBhIGRldmljZSBjb25maWd1cmF0aW9uIHZhbHVlIGluIHRoZSBjb25maWcgdGFibGUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBrZXk6IFRoZSBjb25maWd1cmF0aW9uIGtleQogICAgICAgICAgICB2YWx1ZTogVGhlIHZhbHVlIHRvIHNldAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIGlmIHN1Y2Nlc3NmdWwsIEZhbHNlIG90aGVyd2lzZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnNldChrZXksIHZhbHVlKQoKICAgIGRlZiBnZXRfYWxsX2RldmljZV9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgR2V0IGFsbCBkZXZpY2UgY29uZmlndXJhdGlvbiBzZXR0aW5ncwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBEaWN0aW9uYXJ5IG9mIGFsbCBkZXZpY2UgY29uZmlndXJhdGlvbiBzZXR0aW5ncwogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgR2V0IGFsbCBrZXlzIHN0YXJ0aW5nIHdpdGggImRldmljZV8iIGJ1dCBleGNsdWRlIGRldmljZV9pbmZvCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBrZXksIHZhbHVlIEZST00gY29uZmlnIFdIRVJFIGtleSAhPSAnZGV2aWNlX2luZm8nIEFORCBrZXkgIT0gJ2RldmljZV9pZCciKQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgICMgQnVpbGQgY29uZmlnIGRpY3Rpb25hcnksIHJlbW92aW5nICJkZXZpY2VfIiBwcmVmaXggZnJvbSBrZXlzCiAgICAgICAgZGV2aWNlX2NvbmZpZyA9IHt9CiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gcmVzdWx0czoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZ1trZXldID0ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZ1trZXldID0gdmFsdWUKICAgICAgICAKICAgICAgICAjIEltcG9ydCBjb25maWcgbW9kdWxlCiAgICAgICAgaW1wb3J0IGNvbmZpZyBhcyBjb25maWdfbW9kdWxlCiAgICAgICAgCiAgICAgICAgIyBBZGQgZGVmYXVsdCB2YWx1ZXMgZm9yIG1pc3NpbmcgY29uZmlnIGl0ZW1zCiAgICAgICAgZGVmYXVsdF9jb25maWdzID0gewogICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX0RBWSwKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogY29uZmlnX21vZHVsZS5NQVhfSk9CU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgImpvYl9pbnRlcnZhbF9zZWNvbmRzIjogY29uZmlnX21vZHVsZS5KT0JfQ0hFQ0tfSU5URVJWQUwsCiAgICAgICAgICAgICJyZXBvcnRfaW50ZXJ2YWwiOiBjb25maWdfbW9kdWxlLk1RVFRfUkVQT1JUX0lOVEVSVkFMCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciBrZXksIGRlZmF1bHRfdmFsdWUgaW4gZGVmYXVsdF9jb25maWdzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGtleSBub3QgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWdba2V5XSA9IGRlZmF1bHRfdmFsdWUKICAgICAgICAKICAgICAgICAjIExv4bqhaSBi4buPIGPDoWMgdHLGsOG7nW5nIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAga2V5c190b19yZW1vdmUgPSBbImlkIiwgImdvbGlrZV9hcGlfYmFzZSJdCiAgICAgICAgZm9yIGtleSBpbiBrZXlzX3RvX3JlbW92ZToKICAgICAgICAgICAgaWYga2V5IGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBkZWwgZGV2aWNlX2NvbmZpZ1trZXldCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGRldmljZV9jb25maWcKCiAgICBkZWYgc2F2ZV9kZXZpY2VfY29uZmlnKHNlbGYsIGNvbmZpZ19kaWN0OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IG5oaeG7gXUgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIGPDuW5nIGzDumMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfZGljdDogRGljdGlvbmFyeSBjaOG7qWEgY8OhYyBj4bq3cCBrZXktdmFsdWUgY+G6pXUgaMOsbmgKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX2RpY3QuaXRlbXMoKToKICAgICAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGzGsHUgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGluaXRfZGVmYXVsdF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggY2hvIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBD4bqldSBow6xuaCDEkcOjIGto4bufaSB04bqhbwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBU4bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gewogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBjaHVuZwogICAgICAgICAgICAgICAgInN5bmNfaW50ZXJ2YWwiOiBjb25maWcuU1lOQ19JTlRFUlZBTCwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBjaG8gam9iCiAgICAgICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgICAgICJqb2JfaG91ciI6IGNvbmZpZy5KT0JfSE9VUiwKICAgICAgICAgICAgICAgICJqb2JfY29vbGRvd25fbWludXRlcyI6IGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMsCiAgICAgICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZLAogICAgICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICAgICAiZW5hYmxlZF9hcHBzIjogY29uZmlnLkVOQUJMRURfQVBQUywKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZy5pdGVtcygpOgogICAgICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgc2VsZi5nZXRfZGV2aWNlX2NvbmZpZyhrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZyhrZXksIHZhbHVlKQogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoIsSQw6Mga2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggY2hvIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0X2NvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkga2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgIGRlZiBnZXRfb3JfY3JlYXRlX2RldmljZV9pZChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgaG/hurdjIHThuqFvIGRldmljZV9pZAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkCiAgICAgICAgIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgZGV2aWNlX2lkIHRyb25nIGRhdGFiYXNlIGtow7RuZwogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsICIiKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIFRo4butIGzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZwogICAgICAgIGRldmljZV9pZCA9IHNlbGYuX2dldF9kZXZpY2VfaWRfZnJvbV9zeXN0ZW0oKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmggdsOgIHRy4bqjIHbhu4EKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZzoge2RldmljZV9pZH0iKQogICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKCJkZXZpY2VfaWQiLCBkZXZpY2VfaWQpCiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAgICAgCiAgICAgICAgIyBUaOG7rSBs4bqleSBkZXZpY2VfaWQgdOG7qyBoZWxwZXIgc2VydmljZQogICAgICAgIGRldmljZV9pZCA9IHNlbGYuX2dldF9kZXZpY2VfaWRfZnJvbV9oZWxwZXIoKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmggdsOgIHRy4bqjIHbhu4EKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlOiB7ZGV2aWNlX2lkfSIpCiAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIE7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYywgdOG6oW8gbeG7m2kKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgaW1wb3J0IHN0cmluZwogICAgICAgIHJhbmRvbV9pZCA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX2xvd2VyY2FzZSArIHN0cmluZy5kaWdpdHMsIGs9MTApKQogICAgICAgIGRldmljZV9pZCA9IGYicmFuZG9tX3tyYW5kb21faWR9IgogICAgICAgIHByaW50KGYiS2jDtG5nIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCBi4bqxbmcgY8OhYyBjw6FjaCB0csOqbiwgdOG6oW8gbeG7m2k6IHtkZXZpY2VfaWR9IikKICAgICAgICAKICAgICAgICAjIEzGsHUgdsOgbyBj4bqldSBow6xuaAogICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgCiAgICBkZWYgX2dldF9kZXZpY2VfaWRfZnJvbV9zeXN0ZW0oc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZyAoc+G7rSBk4bulbmcgbOG7h25oIGdldHByb3ApCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBkZXZpY2VfaWQgaG/hurdjIGNodeG7l2kgcuG7l25nIG7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHN1YnByb2Nlc3MKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWyJnZXRwcm9wIiwgInJvLnNlcmlhbG5vIl0sIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSkKICAgICAgICAgICAgZGV2aWNlX2lkID0gcmVzdWx0LnN0ZG91dC5zdHJpcCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkZXZpY2VfaWQgYW5kIGRldmljZV9pZCAhPSAidW5rbm93biI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbOG6pXkgZGV2aWNlX2lkIHThu6sgaOG7hyB0aOG7kW5nOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgCiAgICBkZWYgX2dldF9kZXZpY2VfaWRfZnJvbV9oZWxwZXIoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlIChhbmRyb2lkX2lkKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkIGhv4bq3YyBjaHXhu5dpIHLhu5duZyBu4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ+G6p24gaW1wb3J0IEhlbHBlclNlcnZpY2UgdOG6oWkgxJHDonkgxJHhu4MgdHLDoW5oIGltcG9ydCB2w7JuZwogICAgICAgICAgICBmcm9tIHNlcnZpY2VzLmhlbHBlcl9zZXJ2aWNlIGltcG9ydCBIZWxwZXJTZXJ2aWNlCiAgICAgICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGhlbHBlciA9IEhlbHBlclNlcnZpY2UoYmFzZV91cmw9Y29uZmlnLkhFTFBFUl9TRVJWSUNFX1VSTCkKICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBoZWxwZXIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRldmljZV9pbmZvIGFuZCAic3RhdHVzIiBpbiBkZXZpY2VfaW5mbyBhbmQgZGV2aWNlX2luZm9bInN0YXR1cyJdID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgIGRhdGEgPSBkZXZpY2VfaW5mby5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgICAgIGFuZHJvaWRfaWQgPSBkYXRhLmdldCgiYW5kcm9pZF9pZCIsICIiKQogICAgICAgICAgICAgICAgaWYgYW5kcm9pZF9pZDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5kcm9pZF9pZAogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGzhuqV5IGRldmljZV9pZCB04burIGhlbHBlcjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgIAogICAgZGVmIG1pZ3JhdGVfZ29saWtlX2NvbmZpZyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjDs2EgY8OhYyBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwIGtow7RuZyBjw7JuIGPhuqduIHRoaeG6v3QKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmludCgixJBhbmcgeMOzYSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyBr4bq/dCBu4buRaSBEQgogICAgICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBrZXkgY+G6p24geMOzYQogICAgICAgICAgICBrZXlzX3RvX2RlbGV0ZSA9IFsKICAgICAgICAgICAgICAgICJnb2xpa2VfaGVhZGVycyIsIAogICAgICAgICAgICAgICAgImdvbGlrZV9oZWFkZXJzX3VwZGF0ZWQiLAogICAgICAgICAgICAgICAgImdvbGlrZV9hcGlfYmFzZSIKICAgICAgICAgICAgXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIGPDoWMga2V5IHRyw7luZyBs4bq3cCBjxakKICAgICAgICAgICAgZGVsZXRlZF9jb3VudCA9IDAKICAgICAgICAgICAgZm9yIGtleSBpbiBrZXlzX3RvX2RlbGV0ZToKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJERUxFVEUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICAgICAgICAgIGRlbGV0ZWRfY291bnQgKz0gY3Vyc29yLnJvd2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENvbW1pdCB0aGF5IMSR4buVaQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBwcmludChmIsSQw6MgeMOzYSB7ZGVsZXRlZF9jb3VudH0gY+G6pXUgaMOsbmggR29MaWtlIHRyw7luZyBs4bq3cCIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgeMOzYSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoc2VsZiwgYWNjb3VudF9pZDogaW50LCBpbmFjdGl2ZV9yZWFzb246IHN0ciA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikgLT4gYm9vbDoKICAgICAgICAiIiLEkOG6t3QgdMOgaSBraG/huqNuIHbDoG8gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSDEkeG6v24gZ2nhu50gcmVzZXQgdGnhur9wIHRoZW8iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBkYXRldGltZSwgY29uZmlnLCB0aW1lCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgSUQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAjIEdp4budIHJlc2V0CiAgICAgICAgICAgIGpvYl9ob3VyID0gc2VsZi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbm93LnJlcGxhY2UoaG91cj1qb2JfaG91ciwgbWludXRlPTAsIHNlY29uZD0wLCBtaWNyb3NlY29uZD0wKQogICAgICAgICAgICBpZiBub3cgPj0gbmV4dF9yZXNldDoKICAgICAgICAgICAgICAgIG5leHRfcmVzZXQgPSBuZXh0X3Jlc2V0ICsgZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBpbnQobmV4dF9yZXNldC50aW1lc3RhbXAoKSkKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGpvYl9kaXNhYmxlX3VudGlsLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBpbmFjdGl2ZV9yZWFzb24KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZXRfYWNjb3VudF9pbmFjdGl2ZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGNvb2xkb3duX21pbnV0ZXM6IGludCA9IE5vbmUsIGluYWN0aXZlX3JlYXNvbjogc3RyID0gIsSQw6MgaG/DoG4gdGjDoG5oIHPhu5Egam9iIHRyb25nIHBoacOqbiIpIC0+IGJvb2w6CiAgICAgICAgIiIixJDhurd0IHTDoGkga2hv4bqjbiB2w6BvIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUgdHJvbmcga2hv4bqjbmcgdGjhu51pIGdpYW4gKHBow7p0KSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHRpbWUsIGNvbmZpZwogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIGPDsyBJRCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGlmIGNvb2xkb3duX21pbnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGludCh0aW1lLnRpbWUoKSArIGNvb2xkb3duX21pbnV0ZXMgKiA2MCkKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGpvYl9kaXNhYmxlX3VudGlsLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBpbmFjdGl2ZV9yZWFzb24KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvd191bnRpbF9uZXh0X3Jlc2V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgcmVhc29uOiBzdHIgPSAiRm9sbG93IHBlbmRpbmcvbGltaXQiKSAtPiBib29sOgogICAgICAgICIiIkNo4buJIGtow7NhIGNo4bupYyBuxINuZyBGT0xMT1cgY+G7p2EgdMOgaSBraG/huqNuIHThu5tpIGdp4budIHJlc2V0IHRp4bq/cCB0aGVvIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUsIGNvbmZpZywgdGltZQogICAgICAgICAgICBhY2MgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2M6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGpvYl9ob3VyID0gc2VsZi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbm93LnJlcGxhY2UoaG91cj1qb2JfaG91ciwgbWludXRlPTAsIHNlY29uZD0wLCBtaWNyb3NlY29uZD0wKQogICAgICAgICAgICBpZiBub3cgPj0gbmV4dF9yZXNldDoKICAgICAgICAgICAgICAgIG5leHRfcmVzZXQgKz0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBUcnVlLAogICAgICAgICAgICAgICAgImZvbGxvd19kaXNhYmxlX3VudGlsIjogaW50KG5leHRfcmVzZXQudGltZXN0YW1wKCkpLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IHJlYXNvbiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RCXSBM4buXaSBzZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3dfdW50aWxfbmV4dF9yZXNldDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvdyhzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGNvb2xkb3duX21pbnV0ZXM6IGludCA9IE5vbmUsIHJlYXNvbjogc3RyID0gIkZvbGxvdyBwZW5kaW5nL2xpbWl0IikgLT4gYm9vbDoKICAgICAgICAiIiJLaMOzYSBGT0xMT1cgdHJvbmcgbeG7mXQga2hv4bqjbmcgdGjhu51pIGdpYW4gKHBow7p0KSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHRpbWUsIGNvbmZpZwogICAgICAgICAgICBhY2MgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2M6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGlmIGNvb2xkb3duX21pbnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IFRydWUsCiAgICAgICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiBpbnQodGltZS50aW1lKCkgKyBjb29sZG93bl9taW51dGVzICogNjApLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IHJlYXNvbiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RCXSBM4buXaSBzZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3c6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSA=').decode('utf-8'))
