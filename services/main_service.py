import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgZGF0ZSwgdGltZWRlbHRhCmltcG9ydCByYW5kb20KaW1wb3J0IGpzb24KZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwKaW1wb3J0IGNvbmZpZwppbXBvcnQgdXRpbHMKZnJvbSB1dGlscyBpbXBvcnQgTG9nTGV2ZWwsIExvZ2dlcgpmcm9tIGpvYnMgaW1wb3J0IFRpa3Rva0pvYiwgVGlrdG9rMkpvYiwgSW5zdGFncmFtSm9iLCBZb3V0dWJlSm9iCmZyb20gc2VydmljZXMucHJveHlfc2VydmljZSBpbXBvcnQgUHJveHlTZXJ2aWNlCgojIFThuqFvIGxvZ2dlciBjaG8gTWFpblNlcnZpY2UKbG9nZ2VyID0gdXRpbHMuZ2V0X2xvZ2dlcigiTWFpblNlcnZpY2UiKQoKIyBDb25zdGFudHMgY2hvIE1haW5TZXJ2aWNlCmNsYXNzIE1haW5TZXJ2aWNlQ29uc3RhbnRzOgogICAgIiIiQ29uc3RhbnRzIGNobyBNYWluU2VydmljZSAtIGNo4buJIGNo4bupYSBzdHJpbmcvZW51bSBjb25zdGFudHMsIHPhu5EgbGnhu4d1IGzhuqV5IHThu6sgY29uZmlnIiIiCiAgICAKICAgICMgQ8OhYyBsb+G6oWkgaMOgbmggxJHhu5luZyAoZW51bSkKICAgIEFDVElPTl9ORVdTRkVFRCA9ICJuZXdzZmVlZCIgICAgICAgICAgIAogICAgQUNUSU9OX1JFRUxTID0gInJlZWxzIiAgICAgICAgICAgICAgICAgCiAgICBBQ1RJT05fTk9USUZJQ0FUSU9OID0gIm5vdGlmaWNhdGlvbiIgICAgCiAgICBBQ1RJT05fUFJPRklMRSA9ICJwcm9maWxlIiAgICAgICAgICAgICAKICAgIEFDVElPTl9KT0IgPSAiam9iIiAgICAgICAgICAgICAgICAgICAgIAogICAgQUNUSU9OX0VYUExPUkUgPSAiZXhwbG9yZSIgICAgICAgICAgICAgCiAgICBBQ1RJT05fU0VBUkNIID0gInNlYXJjaCIgICAgICAgICAgICAgICAKICAgIAogICAgIyBTdGF0dXMgbWVzc2FnZXMKICAgIE1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUiA9ICJU4bqhbSBk4burbmcgKFNldmVyIHnDqnUgY+G6p3UpIgogICAgTVNHX0RFVklDRV9OT19BQ0NPVU5UUyA9ICJU4bqhbSBuZ2jhu4kgKEtow7RuZyBjw7MgdMOgaSBraG/huqNuKSIKICAgIE1TR19XQUlUSU5HX1BST1hZID0gIsSQYW5nIGNo4budIHByb3h5IgogICAgTVNHX1dPUktJTkdfSEFSTU9OSU9VUyA9ICLEkGFuZyBsw6BtIHZp4buHYyBow6BpIGjDsmEiCiAgICBNU0dfQ0FSSU5HX0FDQ09VTlQgPSAixJBhbmcgY2jEg20gc8OzYyB0w6BpIGtob+G6o24iCiAgICBNU0dfRE9JTkdfSk9CID0gIsSQYW5nIGzDoG0gam9iIgoKY2xhc3MgTWFpblNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfc2VydmljZSwgaGVscGVyX3NlcnZpY2UsIGdvbGlrZV9zZXJ2aWNlLCBtcXR0X3NlcnZpY2U9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIE1haW5TZXJ2aWNlIC0gU2VydmljZSB0w61jaCBo4bujcCBjaMSDbSBzw7NjIHbDoCBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgKHThu6sgZ2xvYmFsIGNvbmZpZykKICAgICAgICBnbG9iYWxfY29uZmlnID0gc2VsZi5kYi5nZXRfZ2xvYmFsX2NvbmZpZyh7fSkKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IGdsb2JhbF9jb25maWcuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIMSR4bq/bSBz4buRIGjDoG5oIMSR4buZbmcgY2FyZSB0cm9uZyBzZXNzaW9uCiAgICAgICAgc2VsZi5jYXJlX2FjdGlvbl9jb3VudHMgPSB7fSAgIyB7YWNjb3VudF9pZDogY291bnR9CiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgbOG7i2NoIHPhu60gaMOgbmggxJHhu5luZyBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnkgPSB7fSAgIyB7YWNjb3VudF9pZDogW2FjdGlvbnNdfQogICAgICAgIAogICAgICAgICMgU2Vzc2lvbiBtYW5hZ2VtZW50IHBlciBhY2NvdW50CiAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zID0ge30gICMge2FjY291bnRfaWQ6IHNlc3Npb25fZGF0YX0KICAgICAgICAKICAgICAgICAjIFRyYWNrIGNvbnNlY3V0aXZlIGZhaWx1cmVzIHBlciBhY2NvdW50CiAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzID0ge30gICMge2FjY291bnRfaWQ6IGNvdW50fQogICAgICAgIAogICAgICAgICMgVHJhY2sgY29uc2VjdXRpdmUgbm8tam9iIGF0dGVtcHRzIHBlciBhY2NvdW50CiAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0cyA9IHt9ICAjIHthY2NvdW50X2lkOiBjb3VudH0KICAgICAgICAKICAgICAgICAjIEFjY291bnQgcmVzdCBwZXJpb2RzIC0gREVQUkVDQVRFRDogbm93IHVzaW5nIERCIHN0YXR1cyA9IGluYWN0aXZlICsgam9iX2Rpc2FibGVfdW50aWwKICAgICAgICAjIHNlbGYuYWNjb3VudF9sYXN0X3dvcmtfdGltZSA9IHt9ICAjIHthY2NvdW50X2lkOiB0aW1lc3RhbXB9CiAgICAgICAgIyBzZWxmLmFjY291bnRfcmVzdF91bnRpbCA9IHt9ICAjIHthY2NvdW50X2lkOiB0aW1lc3RhbXB9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Aga2jDtG5nIHTDrG0gdGjhuqV5IGpvYgogICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgIAogICAgICAgICMgVHJhY2sgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSDEkeG7gyB0csOhbmggcmVzZXQgSVAgcHJveHkgbGnDqm4gdOG7pWMKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcAogICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMgPSB7fSAgIyB7YXBwX25hbWU6IGFjY291bnRfaWR9CiAgICAgICAgCiAgICAgICAgIyBGbGFnIMSR4buDIHRyYWNrIHhlbSDEkcOjIHZlcmlmeSBjdXJyZW50IGFjY291bnQgY2jGsGEga2hpIGto4bufaSDEkeG7mW5nIChnaeG7kW5nIEpvYlNlcnZpY2UpCiAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQgPSB7fSAgIyB7YXBwX25hbWU6IGJvb2x9CiAgICAgICAgCiAgICAgICAgIyBUcmFjayB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIGNvbnNlY3V0aXZlIG5vLWpvYiBhdHRlbXB0cyBwZXIgYWNjb3VudCAodOG7qyBKb2JTZXJ2aWNlKQogICAgICAgIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMgPSB7fSAgIyB7YWNjb3VudF9pZDogY291bnR9CiAgICAgICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Nlc3Npb25fbGltaXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgaW50XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBnaeG7m2kgaOG6oW4gc2Vzc2lvbiBjaG8gYWNjb3VudCB04burIGRhdGFiYXNlIGNvbmZpZyB2w6Agam9iLXNwZWNpZmljIGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIChwaOG6o2kgY8OzICdhcHAnIGZpZWxkKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBTZXNzaW9uIGxpbWl0cyBjaG8gYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBtYXhfam9ic19wZXJfc2Vzc2lvbiB04burIGFjY291bnQgY29uZmlnIGhv4bq3YyBkZWZhdWx0IGhhcmRjb2RlCiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgMTAgICMgRGVmYXVsdDogMTAgam9icwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiDEkeG7mW5nIGThu7FhIHRyw6puIG1heF9qb2JzX3Blcl9zZXNzaW9uIHbDoCBhcHAgY29uZmlnCiAgICAgICAgICAgIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uID0gc2VsZi5fY2FsY3VsYXRlX2R5bmFtaWNfYWN0aW9uc19saW1pdChtYXhfam9ic19wZXJfc2Vzc2lvbiwgYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgc2Vzc2lvbiBkdXJhdGlvbiB04burIGpvYi1zcGVjaWZpYyBjb25maWcgdGhheSB2w6wgZ2xvYmFsIGNvbmZpZwogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBqb2JfaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyByYW5kb20gc2Vzc2lvbiBkdXJhdGlvbiB04burIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICByYW5kb21fc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzID0gam9iX2hhbmRsZXIuZ2V0X3JhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMoKQogICAgICAgICAgICAgICAgbWF4X3Nlc3Npb25fZHVyYXRpb24gPSByYW5kb21fc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzICogNjAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ2lkJyl9ICh7YXBwX25hbWV9KTogUmFuZG9tIHNlc3Npb24gZHVyYXRpb246IHtyYW5kb21fc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiBz4butIGThu6VuZyBnacOhIHRy4buLIG3hurdjIMSR4buLbmggdOG7qyBKb2JCYXNlCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0sIHPhu60gZOG7pW5nIGRlZmF1bHQgSm9iQmFzZSBjb25maWciKQogICAgICAgICAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBkZWZhdWx0IHThu6sgSm9iQmFzZTogMzAtNjAgcGjDunQKICAgICAgICAgICAgICAgIHJhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMgPSByYW5kb20ucmFuZGludCgzMCwgNjApCiAgICAgICAgICAgICAgICBtYXhfc2Vzc2lvbl9kdXJhdGlvbiA9IHJhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMgKiA2MAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ2lkJyl9OiBtYXhfam9icz17bWF4X2pvYnNfcGVyX3Nlc3Npb259LCBjYWxjdWxhdGVkX21heF9hY3Rpb25zPXttYXhfYWN0aW9uc19wZXJfc2Vzc2lvbn0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IG1heF9qb2JzX3Blcl9zZXNzaW9uLAogICAgICAgICAgICAgICAgIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIjogbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24sCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb24iOiBtYXhfc2Vzc2lvbl9kdXJhdGlvbgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHNlc3Npb24gbGltaXRzOiB7ZX0iKQogICAgICAgICAgICAjIEZhbGxiYWNrIHPhu60gZOG7pW5nIGhhcmRjb2RlIHZhbHVlcyB0aGF5IHbDrCBnbG9iYWwgY29uZmlnCiAgICAgICAgICAgIGltcG9ydCByYW5kb20KICAgICAgICAgICAgZmFsbGJhY2tfZHVyYXRpb24gPSByYW5kb20ucmFuZGludCgzMCwgNjApICogNjAgICMgSm9iQmFzZSBkZWZhdWx0OiAzMC02MCBwaMO6dAogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IDEwLCAgIyBIYXJkY29kZSBkZWZhdWx0CiAgICAgICAgICAgICAgICAibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iOiAzMCwgICMgSGFyZGNvZGUgZGVmYXVsdCAgCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb24iOiBmYWxsYmFja19kdXJhdGlvbgogICAgICAgICAgICB9CiAgICAKICAgIGRlZiBfY2FsY3VsYXRlX2R5bmFtaWNfYWN0aW9uc19saW1pdChzZWxmLCBtYXhfam9ic19wZXJfc2Vzc2lvbjogaW50LCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUw61uaCB0b8OhbiBkeW5hbWljIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIGThu7FhIHRyw6puIGFwcCBjb25maWcgaG/hurdjIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgCiAgICAgICAgTG9naWM6CiAgICAgICAgLSDGr3UgdGnDqm4gbOG6pXkgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gdOG7qyBhcHAgY29uZmlnCiAgICAgICAgLSBO4bq/dSBraMO0bmcgY8OzIHRow6wgdMOtbmggdG/DoW4gZOG7sWEgdHLDqm4gbWF4X2pvYnNfcGVyX3Nlc3Npb24gduG7m2kgcmF0aW8KICAgICAgICAtIMOBcCBk4bulbmcgZ2nhu5tpIGjhuqFuIHThu5FpIHRoaeG7g3UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbjogU+G7kSBqb2JzIHThu5FpIMSRYSB0cm9uZyBzZXNzaW9uCiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIMSR4buDIGzhuqV5IGNvbmZpZyBhcHAgY+G7pSB0aOG7gyAob3B0aW9uYWwpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogU+G7kSBhY3Rpb25zIHThu5FpIMSRYSB0w61uaCB0b8OhbiDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBnaeG7m2kgaOG6oW4gdOG7qyBhcHAgY29uZmlnIG7hur91IGPDsyBhY2NvdW50CiAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBhcHBfY29uZmlnID0gaGFuZGxlci5nZXRfYXBwX2NvbmZpZygpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBtaW5fYWN0aW9ucyB04burIGFwcCBjb25maWcgaG/hurdjIGhhcmRjb2RlIGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICBtaW5fYWN0aW9ucyA9IGFwcF9jb25maWcuZ2V0KCJtaW5fYWN0aW9uc19wZXJfc2Vzc2lvbiIsIDgpICAjIERlZmF1bHQ6IDgKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIMavVSBUScOKTjogTOG6pXkgbWF4X2FjdGlvbnMgdHLhu7FjIHRp4bq/cCB04burIGFwcCBjb25maWcKICAgICAgICAgICAgICAgICAgICBhcHBfbWF4X2FjdGlvbnMgPSBhcHBfY29uZmlnLmdldCgibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iKQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9tYXhfYWN0aW9uczoKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxfYWN0aW9ucyA9IG1heChtaW5fYWN0aW9ucywgYXBwX21heF9hY3Rpb25zKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJT4butIGThu6VuZyBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiB04burIHthcHBfbmFtZX0gY29uZmlnOiB7ZmluYWxfYWN0aW9uc30iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmluYWxfYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFwcCB7YXBwX25hbWV9IGtow7RuZyBjw7MgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24sIHTDrW5oIHRvw6FuIMSR4buZbmciKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIHbhu4EgaGFyZGNvZGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gOCAgIyBEZWZhdWx0OiB04buRaSB0aGnhu4N1IDggYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkZhbGxiYWNrIHbhu4EgaGFyZGNvZGUgZGVmYXVsdDogbWluPXttaW5fYWN0aW9uc30iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIGFjY291bnQsIGTDuW5nIGhhcmRjb2RlIGRlZmF1bHQKICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gOCAgIyBEZWZhdWx0OiB04buRaSB0aGnhu4N1IDggYWN0aW9ucwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0b8OhbiBhY3Rpb25zIGPhuqduIHRoaeG6v3QgZOG7sWEgdHLDqm4gc+G7kSBqb2JzIChmYWxsYmFjaykKICAgICAgICAgICAgZGVmYXVsdF9yYXRpbyA9IDIuNQogICAgICAgICAgICBjYWxjdWxhdGVkX2FjdGlvbnMgPSBpbnQobWF4X2pvYnNfcGVyX3Nlc3Npb24gKiBkZWZhdWx0X3JhdGlvKQogICAgICAgICAgICBtYXhfYWN0aW9ucyA9IDMwICAjIEhhcmRjb2RlIGRlZmF1bHQgbWF4IGFjdGlvbnMKICAgICAgICAgICAgCiAgICAgICAgICAgICMgw4FwIGThu6VuZyBnaeG7m2kgaOG6oW4gdOG7kWkgdGhp4buDdSB2w6AgdOG7kWkgxJFhCiAgICAgICAgICAgIGZpbmFsX2FjdGlvbnMgPSBtYXgobWluX2FjdGlvbnMsIG1pbihjYWxjdWxhdGVkX2FjdGlvbnMsIG1heF9hY3Rpb25zKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkR5bmFtaWMgYWN0aW9ucyBjYWxjdWxhdGlvbjoge21heF9qb2JzX3Blcl9zZXNzaW9ufSBqb2JzICoge2RlZmF1bHRfcmF0aW99IHJhdGlvID0ge2NhbGN1bGF0ZWRfYWN0aW9uc30g4oaSIGZpbmFsOiB7ZmluYWxfYWN0aW9uc30gKG1pbjoge21pbl9hY3Rpb25zfSwgbWF4OiB7bWF4X2FjdGlvbnN9KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZmluYWxfYWN0aW9ucwogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNhbGN1bGF0ZSBkeW5hbWljIGFjdGlvbnMgbGltaXQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAzMCAgIyBIYXJkY29kZSBkZWZhdWx0IGZhbGxiYWNrCiAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbihzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gbmdo4buJIG5nxqFpIHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUaOG7nWkgZ2lhbiBuZ2jhu4kgbmfGoWkgKGdpw6J5KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMgdOG7qyBkYXRhYmFzZSBjb25maWcgdsOgIGNvbnZlcnQgc2FuZyBnacOieQogICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygic2Vzc2lvbl9jb29sZG93bl9taW51dGVzIiwgMzApICAjIE3hurdjIMSR4buLbmggMzAgcGjDunQKICAgICAgICAgICAgYmFzZV9kdXJhdGlvbiA9IGNvb2xkb3duX21pbnV0ZXMgKiA2MAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSByYW5kb20gbmjhu48gwrExMCUgxJHhu4MgdHLDoW5oIGPDoWMgYWNjb3VudCBuZ2jhu4kgY8O5bmcgbMO6YwogICAgICAgICAgICB2YXJpYXRpb24gPSBpbnQoYmFzZV9kdXJhdGlvbiAqIDAuMSkgIAogICAgICAgICAgICByZXN0X2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQoYmFzZV9kdXJhdGlvbiAtIHZhcmlhdGlvbiwgYmFzZV9kdXJhdGlvbiArIHZhcmlhdGlvbikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN0X2R1cmF0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHJlc3QgZHVyYXRpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAzMCAqIDYwICAjIEZhbGxiYWNrOiAzMCBwaMO6dAogICAgCiAgICBkZWYgX2dldF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBz4buRIGzGsOG7o25nIGjDoG5oIMSR4buZbmcgY2FyZSDEkcOjIHRo4buxYyBoaeG7h24gdHJvbmcgc2Vzc2lvbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFPhu5EgaMOgbmggxJHhu5luZyBjYXJlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLmdldChhY2NvdW50X2lkLCAwKQogICAgCiAgICBkZWYgX2luY3JlbWVudF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIFTEg25nIHPhu5EgbMaw4bujbmcgaMOgbmggxJHhu5luZyBjYXJlIGNobyB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBzZWxmLmNhcmVfYWN0aW9uX2NvdW50c1thY2NvdW50X2lkXSA9IHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICBsb2dnZXIuZGVidWcoZiJDYXJlIGFjdGlvbiBjb3VudCBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH06IHtzZWxmLmNhcmVfYWN0aW9uX2NvdW50c1thY2NvdW50X2lkXX0iKQogICAgCiAgICBkZWYgX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCk6CiAgICAgICAgIiIiCiAgICAgICAgUmVzZXQgc+G7kSBsxrDhu6NuZyBow6BuaCDEkeG7mW5nIGNhcmUgduG7gSAwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5jYXJlX2FjdGlvbl9jb3VudHNbYWNjb3VudF9pZF0gPSAwCiAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgY2FyZSBhY3Rpb24gY291bnQgY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgIAogICAgZGVmIF9jaG9vc2VfcmFuZG9tX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIENo4buNbiBow6BuaCDEkeG7mW5nIHRow7RuZyBxdWEgSm9iQmFzZSBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBMb+G6oWkgaMOgbmggxJHhu5luZyDEkcaw4bujYyBjaOG7jW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSwgZMO5bmcgZGVmYXVsdCBhY3Rpb24iKQogICAgICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9ORVdTRkVFRAogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBKb2JCYXNlIMSR4buDIGNo4buNbiBhY3Rpb24gdGhlbyBjb25maWcKICAgICAgICAgICAgY2hvc2VuX2FjdGlvbiA9IGhhbmRsZXIuY2hvb3NlX3dlaWdodGVkX2FjdGlvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJKb2JCYXNlIGNo4buNbiBhY3Rpb24gJ3tjaG9zZW5fYWN0aW9ufScgY2hvIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgIHJldHVybiBjaG9zZW5fYWN0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2jhu41uIGFjdGlvbiBxdWEgSm9iQmFzZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9ORVdTRkVFRCAgIyBGYWxsYmFjawogICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIHNlc3Npb24gY+G7p2EgYWNjb3VudCB04burIERCIChwZXJzaXN0ZW50IHNlc3Npb24pCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Q6IFNlc3Npb24gZGF0YSB04burIERCCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGFjY291bnQgZGF0YSBt4bubaSBuaOG6pXQgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2FjY291bnRfaWR9IHRyb25nIERCIikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXJ0X3RpbWUnOiB0aW1lLnRpbWUoKSwKICAgICAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnam9iX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnY2FyZV9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2xhc3RfYWN0aW9uX3RpbWUnOiB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBhY3Rpb25fY291bnQgdsOgIGNhcmVfY291bnQgdOG7qyBjw6FjIGZpZWxkIERCIGhp4buHbiBjw7MKICAgICAgICAgICAgam9iX2NvdW50ID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgY2FyZV9jb3VudCA9IGFjY291bnQuZ2V0KCJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiIsIDApICAjIFPhur0gdGjDqm0gZmllbGQgbsOgeQogICAgICAgICAgICBhY3Rpb25fY291bnQgPSBqb2JfY291bnQgKyBjYXJlX2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrW5oIHN0YXJ0X3RpbWU6IE7hur91IHNlc3Npb24gY2jGsGEgY8OzIHN0YXJ0X3RpbWUgdHJvbmcgbWVtb3J5IHRow6wgdOG6oW8gbeG7m2kKICAgICAgICAgICAgIyBLSMOUTkcgZMO5bmcgbGFzdF9qb2JfdGltZSB2w6wgxJHDsyBsw6AgdGjhu51pIMSRaeG7g20gam9iIGN14buRaSAoY8OzIHRo4buDIGPFqSkKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnMgYW5kICdzdGFydF90aW1lJyBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF06CiAgICAgICAgICAgICAgICAjIETDuW5nIHN0YXJ0X3RpbWUgdOG7qyBtZW1vcnkgc2Vzc2lvbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF1bJ3N0YXJ0X3RpbWUnXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBU4bqhbyBzdGFydF90aW1lIG3hu5tpIGNobyBzZXNzaW9uIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAnc3RhcnRfdGltZSc6IHN0YXJ0X3RpbWUsCiAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogYWN0aW9uX2NvdW50LAogICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IGpvYl9jb3VudCwKICAgICAgICAgICAgICAgICdjYXJlX2NvdW50JzogY2FyZV9jb3VudCwKICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDYWNoZSB2w6BvIG1lbW9yeSDEkeG7gyB0csOhbmggcXVlcnkgbGnDqm4gdOG7pWMKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gc2Vzc2lvbl9kYXRhCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gc2Vzc2lvbl9kYXRhCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IGFjY291bnQgc2Vzc2lvbiB04burIERCOiB7ZX0iKQogICAgICAgICAgICAjIEZhbGxiYWNrIHbhu4EgbWVtb3J5IHNlc3Npb24KICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBub3QgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50LCBhY3Rpb25fdHlwZTogc3RyLCBzdWNjZXNzOiBib29sKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgc2Vzc2lvbiBkYXRhIGPhu6dhIGFjY291bnQgdsOgbyBEQiAocGVyc2lzdGVudCBzZXNzaW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY3Rpb25fdHlwZTogTG/huqFpIGjDoG5oIMSR4buZbmcKICAgICAgICAgICAgc3VjY2VzczogVGjDoG5oIGPDtG5nIGhheSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGF0YSBoaeG7h24gdOG6oWkgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2FjY291bnRfaWR9IMSR4buDIHVwZGF0ZSBzZXNzaW9uIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0b8OhbiBjw6FjIGNvdW50ZXJzIG3hu5tpCiAgICAgICAgICAgIGN1cnJlbnRfam9iX2NvdW50ID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgY3VycmVudF9jYXJlX2NvdW50ID0gYWNjb3VudC5nZXQoImNhcmVfYWN0aW9uc19pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgImxhc3RfYWN0aW9uX3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJqb2JzX2RvbmVfaW5fc2Vzc2lvbiJdID0gY3VycmVudF9qb2JfY291bnQgKyAxCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgQ2FyZSBhY3Rpb24KICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsiY2FyZV9hY3Rpb25zX2luX3Nlc3Npb24iXSA9IGN1cnJlbnRfY2FyZV9jb3VudCArIDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gREIKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG1lbW9yeSBjYWNoZQogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9mcm9tX21lbW9yeShhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9CIGFuZCBzdWNjZXNzOgogICAgICAgICAgICAgICAgc2Vzc2lvblsnam9iX2NvdW50J10gKz0gMQogICAgICAgICAgICBlbGlmIGFjdGlvbl90eXBlICE9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICBzZXNzaW9uWydjYXJlX2NvdW50J10gKz0gMQogICAgICAgICAgICAKICAgICAgICAgICAgc2Vzc2lvblsnYWN0aW9uX2NvdW50J10gPSBzZXNzaW9uWydqb2JfY291bnQnXSArIHNlc3Npb25bJ2NhcmVfY291bnQnXQogICAgICAgICAgICBzZXNzaW9uWydsYXN0X2FjdGlvbl90aW1lJ10gPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgY29uc2VjdXRpdmUgZmFpbHVyZXMgKHbhuqtuIGTDuW5nIG1lbW9yeSB2w6wga2jDtG5nIGPhuqduIHBlcnNpc3QpCiAgICAgICAgICAgIGlmIG5vdCBzdWNjZXNzOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgIGlmIGFjdGlvbl90eXBlID09IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMuZ2V0KGFjY291bnRfaWQsIDApICsgMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgaWYgYWN0aW9uX3R5cGUgPT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdXBkYXRlIGFjY291bnQgc2Vzc2lvbjoge2V9IikKICAgIAogICAgZGVmIF9nZXRfYWNjb3VudF9zZXNzaW9uX2Zyb21fbWVtb3J5KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgc2Vzc2lvbiB04burIG1lbW9yeSBjYWNoZSAoaGVscGVyIGZ1bmN0aW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBTZXNzaW9uIGRhdGEgdOG7qyBtZW1vcnkKICAgICAgICAiIiIKICAgICAgICBpZiBhY2NvdW50X2lkIG5vdCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXSA9IHsKICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICdqb2JfY291bnQnOiAwLAogICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgJ2xhc3RfYWN0aW9uX3RpbWUnOiB0aW1lLnRpbWUoKQogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgCiAgICBkZWYgX3Jlc2V0X2FjY291bnRfc2Vzc2lvbihzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IHNlc3Npb24gZGF0YSBj4bunYSBhY2NvdW50IHRyb25nIERCCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIHJlc2V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gZGF0YSB0cm9uZyBEQgogICAgICAgICAgICByZXNldF9kYXRhID0gewogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAibGFzdF9hY3Rpb25fdGltZSI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCByZXNldF9kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBtZW1vcnkgY2FjaGUKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHNlc3Npb24gY2hvIGFjY291bnQge2FjY291bnRfaWR9LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBhY2NvdW50IHNlc3Npb246IHtlfSIpCgogICAgZGVmIF9yZXNldF9hY2NvdW50X3Nlc3Npb25fc3RhcnRfdGltZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IGNo4buJIHNlc3Npb24gc3RhcnRfdGltZSDEkeG7gyBi4bqvdCDEkeG6p3Ugc2Vzc2lvbiBt4bubaSBtw6Aga2jDtG5nIG3huqV0IHByb2dyZXNzCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIHJlc2V0IHN0YXJ0X3RpbWUKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVzZXQgbWVtb3J5IGNhY2hlIHNlc3Npb24gc3RhcnRfdGltZQogICAgICAgICAgICBpZiBhY2NvdW50X2lkIGluIHNlbGYuYWNjb3VudF9zZXNzaW9uczoKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXVsnc3RhcnRfdGltZSddID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+UhCBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQge2FjY291bnRfaWR9LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVOG6oW8gbeG7m2kgc2Vzc2lvbiB24bubaSBzdGFydF90aW1lIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+GlSBU4bqhbyBt4bubaSBzZXNzaW9uIGNobyBhY2NvdW50IHthY2NvdW50X2lkfS4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IGFjY291bnQgc2Vzc2lvbiBzdGFydF90aW1lOiB7ZX0iKQoKICAgIGRlZiBfc2V0X2FjY291bnRfcmVzdChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBuZ2jhu4kgbmfGoWkgc+G7rSBk4bulbmcgc3RhdHVzID0gaW5hY3RpdmUgdsOgIGpvYl9kaXNhYmxlX3VudGlsCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIG5naOG7iSBuZ8ahaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0aOG7nWkgZ2lhbiBuZ2jhu4kgdOG7qyBjb25maWcKICAgICAgICAgICAgcmVzdF9taW51dGVzID0gc2VsZi5fZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbigpIC8vIDYwICAjIENvbnZlcnQgc2Vjb25kcyB0byBtaW51dGVzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBjaHXhuqluIGPhu6dhIERhdGFiYXNlU2VydmljZQogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9cmVzdF9taW51dGVzLAogICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiQWNjb3VudCByZXN0OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBkYXRhIHRyb25nIERCCiAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgZiJBY2NvdW50IHJlc3Q6IHtyZWFzb259IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBjb25zZWN1dGl2ZSBjb3VudGVycyAobWVtb3J5KQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSDEkcaw4bujYyDEkeG6t3Qgbmdo4buJIG5nxqFpIHtyZXN0X21pbnV0ZXN9IHBow7p0LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyDEkeG6t3QgYWNjb3VudCB7YWNjb3VudF9pZH0gbmdo4buJIG5nxqFpIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzZXQgYWNjb3VudCByZXN0OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9mb2xsb3dfcGVuYWx0eShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBuZ+G7q25nIGZvbGxvdyB2w6wgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gbmfhu6tuZyBmb2xsb3cKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjhu51pIGdpYW4gcGVuYWx0eSB04burIGNvbmZpZyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50KICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGNodeG6qW4gY+G7p2EgRGF0YWJhc2VTZXJ2aWNlCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLmRpc2FibGVfYWNjb3VudF9mb2xsb3coCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRfaWQsCiAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9cGVuYWx0eV9taW51dGVzLAogICAgICAgICAgICAgICAgcmVhc29uPWYiRm9sbG93IHBlbmFsdHk6IHtyZWFzb259IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSBi4buLIG5n4burbmcgZm9sbG93IHtwZW5hbHR5X21pbnV0ZXN9IHBow7p0LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBuZ+G7q25nIGZvbGxvdyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc2V0IGZvbGxvdyBwZW5hbHR5OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9kYWlseV9saW1pdF9yZWFjaGVkKHNlbGYsIGFjY291bnRfaWQ6IGludCwgcmVhc29uOiBzdHIgPSAiIik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhurd0IGFjY291bnQgdsOgbyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHVudGlsIG5leHQgcmVzZXQga2hpIMSR4bqhdCBnaeG7m2kgaOG6oW4gZGFpbHkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY2h14bqpbiBj4bunYSBEYXRhYmFzZVNlcnZpY2UKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldCgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkRhaWx5IGxpbWl0OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gxJHhuqF0IGdp4bubaSBo4bqhbiBkYWlseSwgbmdo4buJIMSR4bq/biBuZ8OgeSBtYWkuIEzDvSBkbzoge3JlYXNvbn0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIHNldCBkYWlseSBsaW1pdCBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHNldCBkYWlseSBsaW1pdDoge2V9IikKICAgICAgICAKICAgIGRlZiBfYXBwbHlfYXBwcm9wcmlhdGVfcmVzdF90eXBlKHNlbGYsIGFjY291bnRfaWQ6IGludCwgc3dpdGNoX3JlYXNvbjogc3RyLCBzZXNzaW9uOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgw4FwIGThu6VuZyBsb+G6oWkgbmdo4buJIG5nxqFpIHBow7kgaOG7o3AgZOG7sWEgdHLDqm4gbMO9IGRvIHN3aXRjaCBhY2NvdW50CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgYWNjb3VudAogICAgICAgICAgICBzd2l0Y2hfcmVhc29uOiBMw70gZG8gc3dpdGNoCiAgICAgICAgICAgIHNlc3Npb246IFNlc3Npb24gZGF0YQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFBow6JuIGxv4bqhaSBsw70gZG8gdsOgIMOhcCBk4bulbmcgcmVzdCB0eXBlIHBow7kgaOG7o3AKICAgICAgICAgICAgaWYgImRhaWx5IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCkgb3IgIm5nw6B5IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAjIERhaWx5IGxpbWl0IHJlYWNoZWQgLSBpbmFjdGl2ZSB1bnRpbCBuZXh0IHJlc2V0CiAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9kYWlseV9saW1pdF9yZWFjaGVkKGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiAidGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cCIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJjb25zZWN1dGl2ZSIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpOgogICAgICAgICAgICAgICAgIyBDb25zZWN1dGl2ZSBmYWlsdXJlcyAtIGPDsyB0aOG7gyBsw6AgZm9sbG93IHBlbmFsdHkKICAgICAgICAgICAgICAgIGlmICJmb2xsb3ciIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKSBvciAidW5mb2xsb3ciIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9mb2xsb3dfcGVuYWx0eShhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEdlbmVyaWMgc2Vzc2lvbiByZXN0CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbGlmICJraMO0bmcgY8OzIGpvYiIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJubyBqb2IiIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICMgTm8gam9icyBhdmFpbGFibGUgLSBzaG9ydGVyIHJlc3QKICAgICAgICAgICAgICAgIGNvb2xkb3duX25vX2pvYiA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImNvb2xkb3duX2dldF9qb2JfZ29saWtlIiwgMzApICAjIDMwIHBow7p0IG3hurdjIMSR4buLbmgKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPWNvb2xkb3duX25vX2pvYiwKICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJObyBqb2IgY29vbGRvd246IHtzd2l0Y2hfcmVhc29ufSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSBuZ2jhu4kge2Nvb2xkb3duX25vX2pvYn0gcGjDunQgKGtow7RuZyBjw7Mgam9iKSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFNlc3Npb24gY29tcGxldGVkIG5vcm1hbGx5IC0gc3RhbmRhcmQgc2Vzc2lvbiBjb29sZG93bgogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBhcHBseSBhcHByb3ByaWF0ZSByZXN0IHR5cGU6IHtlfSIpCiAgICAgICAgICAgICMgRmFsbGJhY2sgdG8gc3RhbmRhcmQgcmVzdAogICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24pCiAgICAgICAgICAgIAogICAgZGVmIF9lbnN1cmVfYWNjb3VudF9zd2l0Y2hlZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gYWNjb3VudCDEkcaw4bujYyBzd2l0Y2ggdGjhu7FjIHThur8gdHLDqm4gbcOheSAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IEFjY291bnQgY+G6p24gc3dpdGNoCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyBzd2l0Y2ggdGjDoG5oIGPDtG5nIGhv4bq3YyDEkcOjIMSRw7puZyBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBzd2l0Y2gga2jDtG5nIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGN1cnJlbnRfbG9nZ2VkX2luX2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIG5lZWRzX2FjY291bnRfc3dpdGNoID0gY3VycmVudF9sb2dnZWRfaW5faWQgIT0gYWNjb3VudF9pZAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbmVlZHNfYWNjb3VudF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkPhuqduIGNodXnhu4NuIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiBoaeG7h24gdOG6oWkgSUQ9e2N1cnJlbnRfbG9nZ2VkX2luX2lkfSwgY+G6p24gY2h1eeG7g24gc2FuZyBJRD17YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRow7RuZyBiw6FvIGNobyB1c2VyCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGNodXnhu4NuIGFjY291bnQ6IHt1c2VybmFtZX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50CiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc3dpdGNoX3Jlc3VsdCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCdzdWNjZXNzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICByZWFzb24gPSBzd2l0Y2hfcmVzdWx0LmdldCgncmVhc29uJywgJ3Vua25vd24nKQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gc3dpdGNoX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnTOG7l2kga2jDtG5nIHjDoWMgxJHhu4tuaCcpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiByZWFzb24gPT0gJ2FjY291bnRfbm90X2ZvdW5kJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoLCDEkcOhbmggZOG6pXUgbG9nb3V0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGxvZ291dCB2w6Agc3luYyBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fbWFya19hY2NvdW50X2xvZ291dChhY2NvdW50LCAiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nIHNhdSBraGkgc3dpdGNoIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoYWNjb3VudF9pZCwgIkFjY291bnQgc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBD4bqtcCBuaOG6rXQgaXNfbG9naW4gc3RhdHVzIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGluZyBhY2NvdW50IGRhdGEgc2F1IGtoaSBzd2l0Y2ggY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGzDoG0gdmnhu4djOiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVMawxqFuZyB0aMOtY2ggduG7m2kgaW1wbGVtZW50YXRpb24gY8WpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoYWNjb3VudF9pZCwgIkFjY291bnQgc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBD4bqtcCBuaOG6rXQgaXNfbG9naW4gc3RhdHVzIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGluZyBhY2NvdW50IGRhdGEgc2F1IGtoaSBzd2l0Y2ggY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGzDoG0gdmnhu4djOiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSRxINuZyBuaOG6rXAsIGLhu48gcXVhIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBlbnN1cmUgYWNjb3VudCBzd2l0Y2hlZDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfbG9naW5fc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGxvZ2dlZF9pbl9hY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBsb2dpbiBzdGF0dXMgdHJvbmcgREIgc2F1IGtoaSBzd2l0Y2ggYWNjb3VudCB0aMOgbmggY8O0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQ6IElEIGPhu6dhIGFjY291bnQgxJHDoyBsb2dpbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCB04bqldCBj4bqjIGFjY291bnRzIGPhu6dhIGFwcCB24buBIGlzX2xvZ2luID0gRmFsc2UKICAgICAgICAgICAgYXBwX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhcHBfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkgYW5kIGFjY291bnRbImlkIl0gIT0gbG9nZ2VkX2luX2FjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBpc19sb2dpbj1GYWxzZSBjaG8gYWNjb3VudCBJRCB7YWNjb3VudFsnaWQnXX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgYWNjb3VudCBoaeG7h24gdOG6oWkgduG7gSBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU2V0IGlzX2xvZ2luPVRydWUgY2hvIGFjY291bnQgSUQge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdXBkYXRlIGFjY291bnQgbG9naW4gc3RhdHVzOiB7ZX0iKQoKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSBhY2NvdW50IGxvZ291dCB2w6Agc3luYyBs4bqhaSB0cuG6oW5nIHRow6FpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogQWNjb3VudCBi4buLIGxvZ291dAogICAgICAgICAgICByZWFzb246IEzDvSBkbyBsb2dvdXQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgREIKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdmVyaWZpZWQgc3RhdGUKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3ZlcmlmaWVkX3N0YXRlc1thY2NvdW50X2lkXSA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFudXAgc2Vzc2lvbgogICAgICAgICAgICBzZWxmLl9jbGVhbnVwX2FjY291bnRfc2Vzc2lvbl9vbl9sb2dvdXQoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkcOhbmggZOG6pXUgbG9nb3V0IGNobyBhY2NvdW50IHt1c2VybmFtZX06IHtyZWFzb259IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBtYXJrIGFjY291bnQgbG9nb3V0OiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbihzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gbmdo4buJIG5nxqFpIGPhu6dhIGFjY291bnQgdOG7qyBjb25maWcgZGF0YWJhc2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSB0w61uaCBi4bqxbmcgZ2nDonkgKG3hurdjIMSR4buLbmggdOG7qyBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIHNlc3Npb25fY29vbGRvd25fbWludXRlcyB0aGF5IHbDrCBqb2JfY29vbGRvd25fbWludXRlcwogICAgICAgICAgICByZXN0X21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMiLCAzMCkKICAgICAgICAgICAgcmV0dXJuIGludChyZXN0X21pbnV0ZXMpICogNjAgICMgQ29udmVydCBtaW51dGVzIHRvIHNlY29uZHMKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGzhuqV5IGFjY291bnQgcmVzdCBkdXJhdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIDMwICogNjAgICMgRGVmYXVsdCAzMCBtaW51dGVzCgogICAgZGVmIF9jbGVhbnVwX2FjY291bnRfc2Vzc2lvbl9vbl9sb2dvdXQoc2VsZiwgYWNjb3VudF9pZDogaW50KToKICAgICAgICAiIiIKICAgICAgICBDbGVhbnVwIHNlc3Npb24gZGF0YSBraGkgbG9nb3V0IGFjY291bnQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiB0cm9uZyBEQgogICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgIkFjY291bnQgbG9nb3V0IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgd29ya2luZyBzdGF0dXMKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCBhbmQgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImlkIikgPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHRyYWNraW5nCiAgICAgICAgICAgIGFwcF9uYW1lID0gTm9uZQogICAgICAgICAgICBmb3IgYXBwLCBhY2NfaWQgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgYWNjX2lkID09IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUgPSBhcHAKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYXBwX25hbWU6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdmVyaWZpZWQgc3RhdGUKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3ZlcmlmaWVkX3N0YXRlc1thY2NvdW50X2lkXSA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNsZWFuZWQgdXAgc2Vzc2lvbiBkYXRhIGZvciBsb2dvdXQgYWNjb3VudCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNsZWFudXAgYWNjb3VudCBzZXNzaW9uOiB7ZX0iKQoKICAgIGRlZiBfc2hvdWxkX3Jlc2V0X3Nlc3Npb25fb25fbmV3X2RheShzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSBjw7MgbsOqbiByZXNldCBzZXNzaW9uIGtoaSBxdWEgbmfDoHkgbeG7m2kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqnbiByZXNldCBzZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3Qgc2Vzc2lvbjoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxhc3RfYWN0aW9uX3RpbWUgPSBzZXNzaW9uLmdldCgibGFzdF9hY3Rpb25fdGltZSIsIDApCiAgICAgICAgICAgIGlmIGxhc3RfYWN0aW9uX3RpbWUgPT0gMDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBxdWEgbmfDoHkgbeG7m2kKICAgICAgICAgICAgbGFzdF9kYXRlID0gZGF0ZXRpbWUuZnJvbXRpbWVzdGFtcChsYXN0X2FjdGlvbl90aW1lKS5kYXRlKCkKICAgICAgICAgICAgY3VycmVudF9kYXRlID0gZGF0ZXRpbWUubm93KCkuZGF0ZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gY3VycmVudF9kYXRlID4gbGFzdF9kYXRlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSByZXNldCBzZXNzaW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIG7Dqm4gY2h1eeG7g24gYWNjb3VudCBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgbsOqbiBjaHV54buDbiBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gYWNjb3VudAogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHNlc3Npb24gbGltaXRzIHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICAgICAgICAgIHNlc3Npb25fbGltaXRzID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoYWNjb3VudCkKICAgICAgICAgICAgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iXQogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdIAogICAgICAgICAgICBtYXhfc2Vzc2lvbl9kdXJhdGlvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfc2Vzc2lvbl9kdXJhdGlvbiJdCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkKQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAxLiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiB0aOG7nWkgZ2lhbiBzZXNzaW9uCiAgICAgICAgICAgIHNlc3Npb25fZHVyYXRpb24gPSBjdXJyZW50X3RpbWUgLSBzZXNzaW9uWydzdGFydF90aW1lJ10KICAgICAgICAgICAgaWYgc2Vzc2lvbl9kdXJhdGlvbiA+PSBtYXhfc2Vzc2lvbl9kdXJhdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IMSQw6MgbMOgbSB2aeG7h2Mge3Nlc3Npb25fZHVyYXRpb24vNjA6LjFmfSBwaMO6dCwgY+G6p24gbmdo4buJIChsaW1pdDoge21heF9zZXNzaW9uX2R1cmF0aW9uLzYwOi4xZn0gcGjDunQpIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDIuIEtp4buDbSB0cmEgc+G7kSBsxrDhu6NuZyBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIGlmIHNlc3Npb25bJ2FjdGlvbl9jb3VudCddID49IG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyB0aOG7sWMgaGnhu4duIHtzZXNzaW9uWydhY3Rpb25fY291bnQnXX0gaMOgbmggxJHhu5luZywgY+G6p24gbmdo4buJIChsaW1pdDoge21heF9hY3Rpb25zX3Blcl9zZXNzaW9ufSkiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gS2nhu4NtIHRyYSBz4buRIGzGsOG7o25nIGpvYgogICAgICAgICAgICBpZiBzZXNzaW9uWydqb2JfY291bnQnXSA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IMSQw6MgbMOgbSB7c2Vzc2lvblsnam9iX2NvdW50J119IGpvYnMsIGPhuqduIG5naOG7iSAobGltaXQ6IHttYXhfam9ic19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDQuIEtp4buDbSB0cmEgdGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cAogICAgICAgICAgICBjb25zZWN1dGl2ZV9mYWlsdXJlcyA9IHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlcy5nZXQoYWNjb3VudF9pZCwgMCkKICAgICAgICAgICAgbWF4X2NvbnNlY3V0aXZlX2ZhaWxzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygic3dpdGNoX2FjY291bnRfYWZ0ZXJfY29uc2VjdXRpdmVfZmFpbHMiLCAzKQogICAgICAgICAgICBpZiBjb25zZWN1dGl2ZV9mYWlsdXJlcyA+PSBtYXhfY29uc2VjdXRpdmVfZmFpbHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9OiB7Y29uc2VjdXRpdmVfZmFpbHVyZXN9IGzhuqduIHRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AsIGNodXnhu4NuIGFjY291bnQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNS4gS2nhu4NtIHRyYSBraMO0bmcgY8OzIGpvYiBsacOqbiB0aeG6v3AKICAgICAgICAgICAgbm9fam9iX2F0dGVtcHRzID0gc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0cy5nZXQoYWNjb3VudF9pZCwgMCkKICAgICAgICAgICAgbWF4X25vX2pvYl9hdHRlbXB0cyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoInN3aXRjaF9hY2NvdW50X2FmdGVyX25vX2pvYnMiLCA1KQogICAgICAgICAgICBpZiBub19qb2JfYXR0ZW1wdHMgPj0gbWF4X25vX2pvYl9hdHRlbXB0czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IHtub19qb2JfYXR0ZW1wdHN9IGzhuqduIGtow7RuZyBjw7Mgam9iLCBjaHV54buDbiBhY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDYuIEtp4buDbSB0cmEgZGFpbHkgbGltaXQKICAgICAgICAgICAgZGFpbHlfbGltaXQgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAxMDApICAjIFPhu60gZOG7pW5nIGpvYl9tYXhfZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9saW1pdAogICAgICAgICAgICBkYWlseV9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKSAgIyBT4butIGThu6VuZyBqb2JfdG9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2NvdW50CiAgICAgICAgICAgIGlmIGRhaWx5X2NvdW50ID49IGRhaWx5X2xpbWl0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyDEkeG6oXQgZGFpbHkgbGltaXQgKHtkYWlseV9jb3VudH0ve2RhaWx5X2xpbWl0fSksIGNodXnhu4NuIGFjY291bnQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNoZWNrIHNob3VsZCBzd2l0Y2ggYWNjb3VudDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9yZXN0aW5nKHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBhY2NvdW50IGPDsyDEkWFuZyBuZ2jhu4kgbmfGoWkga2jDtG5nIChz4butIGThu6VuZyBEQiBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJFhbmcgbmdo4buJIG5nxqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzdGF0dXMgPSBpbmFjdGl2ZSB2w6Agam9iX2Rpc2FibGVfdW50aWwKICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoInN0YXR1cyIpID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA+IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IChqb2JfZGlzYWJsZV91bnRpbCAtIGN1cnJlbnRfdGltZSkgLyA2MAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge2FjY291bnRfaWR9IGPDsm4gbmdo4buJIHtyZW1haW5pbmdfbWludXRlczouMWZ9IHBow7p0IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEjhur90IHRo4budaSBnaWFuIG5naOG7iSwgdOG7sSDEkeG7mW5nIGNodXnhu4NuIHbhu4EgYWN0aXZlIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSDEkcOjIGjhur90IHRo4budaSBnaWFuIG5naOG7iSwgY2h1eeG7g24gduG7gSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGFjY291bnQgcmVzdDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfZ2V0X25leHRfYXZhaWxhYmxlX2FjY291bnQoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGFjY291bnQgdGnhur9wIHRoZW8gY8OzIHRo4buDIGzDoG0gdmnhu4djIChraMO0bmcgbmdo4buJIG5nxqFpKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIE9wdGlvbmFsW0RpY3RdOiBBY2NvdW50IGPDsyB0aOG7gyBsw6BtIHZp4buHYyBob+G6t2MgTm9uZQogICAgICAgICIiIgogICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgCiAgICAgICAgIyBM4buNYyBi4buPIGPDoWMgYWNjb3VudCDEkWFuZyBuZ2jhu4kgbmfGoWkKICAgICAgICBhdmFpbGFibGVfYWNjb3VudHMgPSBbXQogICAgICAgIGZvciBhY2NvdW50IGluIHdvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhhY2NvdW50X2lkKToKICAgICAgICAgICAgICAgIGF2YWlsYWJsZV9hY2NvdW50cy5hcHBlbmQoYWNjb3VudCkKICAgICAgICAKICAgICAgICBpZiBub3QgYXZhaWxhYmxlX2FjY291bnRzOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgICMgxq91IHRpw6puIGFjY291bnQgY2jGsGEgbMOgbSB2aeG7h2MgZ+G6p24gxJHDonkKICAgICAgICBkZWYgc29ydF9rZXkoYWNjKToKICAgICAgICAgICAgYWNjX2lkID0gYWNjLmdldCgiaWQiKQogICAgICAgICAgICBsYXN0X3dvcmtfdGltZSA9IHNlbGYuYWNjb3VudF9sYXN0X3dvcmtfdGltZS5nZXQoYWNjX2lkLCAwKQogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgYWNjLmdldCgiaXNfbG9naW4iLCBGYWxzZSksICAjIMavdSB0acOqbiDEkcOjIGxvZ2luCiAgICAgICAgICAgICAgICAtbGFzdF93b3JrX3RpbWUsICAjIMavdSB0acOqbiBsw6J1IGtow7RuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgLWFjYy5nZXQoImpvYl90b2RheSIsIDApICAjIMavdSB0acOqbiDDrXQgam9iIGjGoW4gKGTDuW5nIGpvYl90b2RheSB0aGF5IHbDrCBkYWlseV9qb2JfY291bnQpCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBhdmFpbGFibGVfYWNjb3VudHMuc29ydChrZXk9c29ydF9rZXksIHJldmVyc2U9VHJ1ZSkKICAgICAgICByZXR1cm4gYXZhaWxhYmxlX2FjY291bnRzWzBdCiAgICAKICAgIGRlZiBfcmVjb3JkX2FjdGlvbl9oaXN0b3J5KHNlbGYsIGFjY291bnRfaWQ6IGludCwgYWN0aW9uOiBzdHIsIHN1Y2Nlc3M6IGJvb2wpOgogICAgICAgICIiIgogICAgICAgIEdoaSBs4bqhaSBs4buLY2ggc+G7rSBow6BuaCDEkeG7mW5nIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY3Rpb246IExv4bqhaSBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIHN1Y2Nlc3M6IEPDsyB0aMOgbmggY8O0bmcga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgaWYgYWNjb3VudF9pZCBub3QgaW4gc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5OgogICAgICAgICAgICBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnlbYWNjb3VudF9pZF0gPSBbXQogICAgICAgIAogICAgICAgIGhpc3RvcnlfZW50cnkgPSB7CiAgICAgICAgICAgICdhY3Rpb24nOiBhY3Rpb24sCiAgICAgICAgICAgICdzdWNjZXNzJzogc3VjY2VzcywKICAgICAgICAgICAgJ3RpbWVzdGFtcCc6IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpCiAgICAgICAgfQogICAgICAgIAogICAgICAgIHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXS5hcHBlbmQoaGlzdG9yeV9lbnRyeSkKICAgICAgICAKICAgICAgICAjIEdp4buvIHThu5FpIMSRYSA1MCBlbnRyaWVzIGNobyBt4buXaSBhY2NvdW50CiAgICAgICAgaWYgbGVuKHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXSkgPiA1MDoKICAgICAgICAgICAgc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdID0gc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdWy01MDpdCiAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFNsZWVwIGFuIHRvw6BuIHbhu5tpIGto4bqjIG7Eg25nIGLhu4sgZ2nDoW4gxJFv4bqhbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNlY29uZHM6IFPhu5EgZ2nDonkgY+G6p24gc2xlZXAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBzbGVlcCBob8OgbiB0aMOgbmgsIEZhbHNlIG7hur91IGLhu4sgZm9yY2Ugc3RvcAogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIAogICAgICAgIHdoaWxlIHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSA8IHNlY29uZHM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnJ1bm5pbmcgb3Igc2VsZi5mb3JjZV9zdG9wOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGNoZWNrX2ludGVydmFsID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiY2hlY2tfaW50ZXJ2YWwiLCAwLjUpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoY2hlY2tfaW50ZXJ2YWwpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgZGVmIF92YWxpZGF0ZV9hbmRfdXBkYXRlX2VuYWJsZWRfYXBwcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCBj4bqtcCBuaOG6rXQgZGFuaCBzw6FjaCBlbmFibGVkX2FwcHMgYuG6sW5nIGPDoWNoIGxv4bqhaSBi4buPIGPDoWMgYXBwIGNoxrBhIGPDoGkgxJHhurd0CiAgICAgICAgU+G7rSBk4bulbmcgbWFwcGluZyB0xKluaCB0aGF5IHbDrCB04bqhbyBqb2IgaGFuZGxlcnMgdOG6oW0gdGjhu51pIMSR4buDIHRyw6FuaCBjb25mbGljdAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIktp4buDbSB0cmEgdsOgIGPhuq1wIG5o4bqtdCBkYW5oIHPDoWNoIGVuYWJsZWRfYXBwcy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE1hcHBpbmcgdMSpbmggYXBwX25hbWUgLT4gYXBwX3BhY2thZ2UgKGzhuqV5IHThu6sgY8OhYyBqb2IgaGFuZGxlcnMpCiAgICAgICAgICAgIGFwcF9wYWNrYWdlcyA9IHsKICAgICAgICAgICAgICAgICJ0aWt0b2siOiAiY29tLnNzLmFuZHJvaWQudWdjLnRyaWxsIiwKICAgICAgICAgICAgICAgICJ0aWt0b2syIjogImNvbS56aGlsaWFvYXBwLm11c2ljYWxseSIsIAogICAgICAgICAgICAgICAgImluc3RhZ3JhbSI6ICJjb20uaW5zdGFncmFtLmFuZHJvaWQiLAogICAgICAgICAgICAgICAgInlvdXR1YmUiOiAiY29tLmdvb2dsZS5hbmRyb2lkLnlvdXR1YmUiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGN1cnJlbnRfZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXRfZ2xvYmFsX2NvbmZpZyh7fSkuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICB2YWxpZGF0ZWRfYXBwcyA9IFtdCiAgICAgICAgICAgIHJlbW92ZWRfYXBwcyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gY3VycmVudF9lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYXBwX3BhY2thZ2UgPSBhcHBfcGFja2FnZXMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgYXBwIGPDsyDEkcaw4bujYyBjw6BpIMSR4bq3dCBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuaXNfYXBwX2luc3RhbGxlZChhcHBfcGFja2FnZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZWRfYXBwcy5hcHBlbmQoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLinJMge2FwcF9uYW1lfSAoe2FwcF9wYWNrYWdlfSkgxJHDoyBjw6BpIMSR4bq3dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinJcge2FwcF9uYW1lfSAoe2FwcF9wYWNrYWdlfSkgY2jGsGEgY8OgaSDEkeG6t3QsIHPhur0gYuG7iyBsb+G6oWkgYuG7jyIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgcGFja2FnZSBtYXBwaW5nIGNobyBhcHA6IHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGFwcCB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIHJlbW92ZWRfYXBwcy5hcHBlbmQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgbuG6v3UgY8OzIHRoYXkgxJHhu5VpCiAgICAgICAgICAgIGlmIHJlbW92ZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTG/huqFpIGLhu48ge2xlbihyZW1vdmVkX2FwcHMpfSBhcHAgY2jGsGEgY8OgaSDEkeG6t3Q6IHsnLCAnLmpvaW4ocmVtb3ZlZF9hcHBzKX0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJHaeG7ryBs4bqhaSB7bGVuKHZhbGlkYXRlZF9hcHBzKX0gYXBwIMSRw6MgY8OgaSDEkeG6t3Q6IHsnLCAnLmpvaW4odmFsaWRhdGVkX2FwcHMpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gZGF0YWJhc2UgKGdsb2JhbCBjb25maWcpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9nbG9iYWxfY29uZmlnKHsiZW5hYmxlZF9hcHBzIjogdmFsaWRhdGVkX2FwcHN9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBsb2NhbCBjYWNoZQogICAgICAgICAgICAgICAgc2VsZi5lbmFibGVkX2FwcHMgPSB2YWxpZGF0ZWRfYXBwcwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJU4bqldCBj4bqjIHtsZW4odmFsaWRhdGVkX2FwcHMpfSBhcHAgdHJvbmcgZW5hYmxlZF9hcHBzIMSR4buBdSDEkcOjIMSRxrDhu6NjIGPDoGkgxJHhurd0IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdmFsaWRhdGUgZW5hYmxlZF9hcHBzOiB7ZX0iKQoKICAgIGRlZiBpbml0aWFsaXplKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIE1haW5TZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIE1haW5TZXJ2aWNlLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgY+G6rXAgbmjhuq10IGVuYWJsZWRfYXBwcyBUUsav4buaQyBraGkga2jhu59pIHThuqFvIGpvYiBoYW5kbGVycwogICAgICAgICAgICBzZWxmLl92YWxpZGF0ZV9hbmRfdXBkYXRlX2VuYWJsZWRfYXBwcygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEto4bufaSB04bqhbyBqb2IgaGFuZGxlcnMKICAgICAgICAgICAgc2VsZi5faW5pdF9qb2JfaGFuZGxlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaOG7n2kgdOG6oW8gY29uZmlnIG3hurdjIMSR4buLbmggY2hvIGPDoWMgYXBwCiAgICAgICAgICAgIHNlbGYuX2luaXRfYXBwX2NvbmZpZ3MoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGPDoWMgY29uZmlnIG3hurdjIMSR4buLbmgKICAgICAgICAgICAgc2VsZi5fc2F2ZV9kZWZhdWx0X2NvbmZpZ3MoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBkYWlseSBjb3VudGVycyBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEZldGNoIEdvTGlrZSBoZWFkZXJzIHRyxrDhu5tjIGtoaSBzeW5jIGFjY291bnRzIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9lbnN1cmVfZ29saWtlX2hlYWRlcnMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbOG6pXkgR29MaWtlIGhlYWRlcnMsIHN5bmMgYWNjb3VudHMgc+G6vSBi4buLIGdp4bubaSBo4bqhbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4buTbmcgYuG7mSBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyB2w6AgbWFwcGluZyBHb0xpa2UgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgc2VsZi5fc3luY19hbGxfYWNjb3VudHNfYW5kX21hcHBpbmcoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaMO0bmcgc3luYyB0cuG6oW5nIHRow6FpIGxvZ2luIG5nYXkgbOG6rXAgdOG7qWMgbmjGsCBKb2JTZXJ2aWNlCiAgICAgICAgICAgICMgU+G6vSBsYXp5IHN5bmMga2hpIGPhuqduIHRoaeG6v3QgdHJvbmcgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IFRydWUKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk1haW5TZXJ2aWNlIGto4bufaSB04bqhbyB0aMOgbmggY8O0bmciKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGto4bufaSB04bqhbyBNYWluU2VydmljZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfZW5zdXJlX2dvbGlrZV9oZWFkZXJzKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgR29MaWtlIGhlYWRlcnMga2hpIGto4bufaSDEkeG7mW5nIHRvb2wgKGZldGNoIHbhu5tpIHJldHJ5KQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIGhlYWRlcnMgaOG7o3AgbOG7hyBob+G6t2MgbOG6pXkgxJHGsOG7o2MgaGVhZGVycyBt4bubaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGtp4buDbSB0cmEgdsOgIGzhuqV5IEdvTGlrZSBoZWFkZXJzLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBoZWFkZXJzIGhp4buHbiBjw7MgdHLGsOG7m2MKICAgICAgICAgICAgaWYgc2VsZi5nb2xpa2Vfc2VydmljZS5pc19nb2xpa2VfYXV0aGVudGljYXRlZCgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkdvTGlrZSBoZWFkZXJzIMSRw6MgY8OzIHPhurVuIHbDoCBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbygiQ2jGsGEgY8OzIEdvTGlrZSBoZWFkZXJzLCDEkWFuZyBj4buRIGfhuq9uZyBs4bqleSBt4bubaS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSRxINuZyBrw70gcHJveHkgbuG6v3UgY+G6p24gdHLGsOG7m2Mga2hpIGZldGNoIEdvTGlrZSBoZWFkZXJzCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoKToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbOG6pXkgcHJveHkgY2hvIHZp4buHYyBmZXRjaCBHb0xpa2UgaGVhZGVycyIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu7FjIHPhu7EgZmV0Y2ggaGVhZGVycyB24bubaSByZXRyeQogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KGZvcmNlX3JlZnJlc2g9RmFsc2UpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIuKchSDEkMOjIGzhuqV5IEdvTGlrZSBoZWFkZXJzIHRow6BuaCBjw7RuZyBraGkga2jhu59pIMSR4buZbmciKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCLimqDvuI8gS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzIGtoaSBraOG7n2kgxJHhu5luZyIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBs4bqleSBHb0xpa2UgaGVhZGVycyBraGkga2jhu59pIMSR4buZbmc6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2NoZWNrX2dvbGlrZV9oZWFkZXJzKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhu4kga2nhu4NtIHRyYSBHb0xpa2UgaGVhZGVycyBoaeG7h24gY8OzIChraMO0bmcgZmV0Y2ggbeG7m2kpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgaGVhZGVycyBo4bujcCBs4buHCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5nb2xpa2Vfc2VydmljZS5pc19nb2xpa2VfYXV0aGVudGljYXRlZCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIEdvTGlrZSBoZWFkZXJzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9zeW5jX2FsbF9hY2NvdW50c19hbmRfbWFwcGluZyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4sgdsOgIG1hcHBpbmcgR29MaWtlIGNobyB04bqldCBj4bqjIGFwcHMgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgxJHhu5NuZyBi4buZIGFjY291bnRzIHbDoCBtYXBwaW5nIEdvTGlrZS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkcSDbmcga8O9IHByb3h5IG7hur91IGPhuqduIHRyxrDhu5tjIGtoaSBzeW5jIGFjY291bnRzCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5jaGVja19wcm94eV9yZXF1aXJlbWVudCgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBs4bqleSBwcm94eSBjaG8gdmnhu4djIMSR4buTbmcgYuG7mSB7YXBwX25hbWV9LCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyAxLiDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhu5NuZyBi4buZIHtsZW4oYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIHRow6wgYuG7jyBxdWEgbWFwcGluZwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIMSRxrDhu6NjIMSR4buTbmcgYuG7mSBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgbWFwcGluZyBHb0xpa2UiKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgMi4gTWFwIHTDoGkga2hv4bqjbiBHb0xpa2UgKGNo4buJIGtoaSBjw7MgR29MaWtlIGhlYWRlcnMgaOG7o3AgbOG7hykKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9jaGVja19nb2xpa2VfaGVhZGVycygpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyBEQgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIMOBbmggeOG6oSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcHBlZF9hY2NvdW50cyA9IGhhbmRsZXIubWFwX2dvbGlrZV9hY2NvdW50cyhnb2xpa2VfYWNjb3VudHMsIGRldmljZV9hY2NvdW50cykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMOhbmggeOG6oSB7bGVuKG1hcHBlZF9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IHbhu5tpIEdvTGlrZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgR29MaWtlIGhlYWRlcnMgaOG7o3AgbOG7hywgYuG7jyBxdWEgbWFwcGluZyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIMSR4buTbmcgYuG7mSB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbygiSG/DoG4gdGjDoG5oIMSR4buTbmcgYuG7mSBhY2NvdW50cyB2w6AgbWFwcGluZyBHb0xpa2UiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIMSR4buTbmcgYuG7mSBhY2NvdW50cyB2w6AgbWFwcGluZzoge2V9IikKCiAgICBkZWYgX2luaXRfam9iX2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyIGNobyB04burbmcgYXBwIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIHNlbGYuZW5hYmxlZF9hcHBzIMSRw6MgxJHGsOG7o2MgdmFsaWRhdGUgdGhheSB2w6wgbOG6pXkgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmVuYWJsZWRfYXBwcwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkto4bufaSB04bqhbyBqb2IgaGFuZGxlcnMgY2hvIGPDoWMgYXBwcyDEkcOjIHZhbGlkYXRlOiB7JywgJy5qb2luKGVuYWJsZWRfYXBwcyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2tKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gInRpa3RvazIiOgogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFRpa3RvazJKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gImluc3RhZ3JhbSI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gSW5zdGFncmFtSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJ5b3V0dWJlIjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBZb3V0dWJlSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiQXBwIHthcHBfbmFtZX0gY2jGsGEgxJHGsOG7o2MgaOG7lyB0cuG7oyIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzOiB7ZX0iKQogICAgCiAgICBkZWYgX2luaXRfYXBwX2NvbmZpZ3Moc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gY29uZmlnIG3hurdjIMSR4buLbmggY2hvIHThuqV0IGPhuqMgYXBwcwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyBhcHBzLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jhu59pIHThuqFvIGNvbmZpZyBjaG8gdOG7q25nIGpvYiBoYW5kbGVyCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSwgaGFuZGxlciBpbiBzZWxmLmpvYl9oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBoYW5kbGVyLmluaXRfZGVmYXVsdF9hcHBfY29uZmlnKCkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBsb2dnZXIuaW5mbyhmIsSQw6Mga2jhu59pIHThuqFvIGNvbmZpZyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBjb25maWcgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGto4bufaSB04bqhbyBjb25maWcgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2jhu59pIHThuqFvIGFwcCBjb25maWdzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9zYXZlX2RlZmF1bHRfY29uZmlncyhzZWxmKToKICAgICAgICAiIiJMxrB1IGPDoWMgY29uZmlnIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSB0aGVvIHN0cnVjdHVyZSBt4bubaSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBJbXBvcnQgY29uZmlnIMSR4buDIGzhuqV5IGRlZmF1bHQgdmFsdWVzCiAgICAgICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSBkZWZhdWx0IGdsb2JhbCBjb25maWcgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgICAgIGN1cnJlbnRfZ2xvYmFsX2NvbmZpZyA9IHNlbGYuZGIuZ2V0X2dsb2JhbF9jb25maWcoe30pCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2dsb2JhbF9jb25maWc6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIGdsb2JhbCBjb25maWcgbeG6t2MgxJHhu4tuaC4uLiIpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9nbG9iYWxfY29uZmlnKGNvbmZpZy5ERUZBVUxUX0dMT0JBTF9DT05GSUcpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBsxrB1IGdsb2JhbCBjb25maWcgbeG6t2MgxJHhu4tuaCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgZGVmYXVsdCBnb2xpa2UgY29uZmlnIG7hur91IGNoxrBhIGPDswogICAgICAgICAgICBjdXJyZW50X2dvbGlrZV9jb25maWcgPSBzZWxmLmRiLmdldF9nb2xpa2VfY29uZmlnKHt9KQogICAgICAgICAgICBpZiBub3QgY3VycmVudF9nb2xpa2VfY29uZmlnOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBnb2xpa2UgY29uZmlnIG3hurdjIMSR4buLbmguLi4iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfZ29saWtlX2NvbmZpZyhjb25maWcuREVGQVVMVF9HT0xJS0VfQ09ORklHKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgbMawdSBnb2xpa2UgY29uZmlnIG3hurdjIMSR4buLbmgiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGRlZmF1bHQgcHJveHkgY29uZmlnIG7hur91IGNoxrBhIGPDswogICAgICAgICAgICBjdXJyZW50X3Byb3h5X2NvbmZpZyA9IHNlbGYuZGIuZ2V0X3Byb3h5X2NvbmZpZyh7fSkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfcHJveHlfY29uZmlnOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBwcm94eSBjb25maWcgbeG6t2MgxJHhu4tuaC4uLiIpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9wcm94eV9jb25maWcoY29uZmlnLkRFRkFVTFRfUFJPWFlfQ09ORklHKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgbMawdSBwcm94eSBjb25maWcgbeG6t2MgxJHhu4tuaCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQw6Mga2nhu4NtIHRyYSB2w6AgbMawdSBjw6FjIGRlZmF1bHQgY29uZmlncyIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgbMawdSBkZWZhdWx0IGNvbmZpZ3M6IHtlfSIpCiAgICAKICAgIGRlZiBnZXRfZ2xvYmFsX2NvbmZpZyhzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdF92YWx1ZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBjb25maWcgdOG7qyBnbG9iYWxfY29uZmlnIHbhu5tpIGZhbGxiYWNrIHbhu4EgZGVmYXVsdCB2YWx1ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogVMOqbiBjb25maWcgY+G6p24gbOG6pXkgIAogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlOiBHacOhIHRy4buLIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIEdpw6EgdHLhu4sgY29uZmlnIGhv4bq3YyBkZWZhdWx0X3ZhbHVlCiAgICAgICAgIiIiCiAgICAgICAgZ2xvYmFsX2NvbmZpZyA9IHNlbGYuZGIuZ2V0X2dsb2JhbF9jb25maWcoe30pCiAgICAgICAgcmV0dXJuIGdsb2JhbF9jb25maWcuZ2V0KGtleSwgZGVmYXVsdF92YWx1ZSkKICAgIAogICAgZGVmIF9yZXNldF9kYWlseV9jb3VudGVycyhzZWxmKToKICAgICAgICAiIiJSZXNldCBjw6FjIGNvdW50ZXIgaMOgbmcgbmfDoHkgdGhlbyBnaeG7nSDEkcaw4bujYyBj4bqldSBow6xuaCAobeG6t2MgxJHhu4tuaCA3aCBzw6FuZykiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vdyA9IGRhdGV0aW1lLm5vdygpCiAgICAgICAgICAgIHJlc2V0X2hvdXIgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJkYWlseV9yZXNldF9ob3VyIiwgNykgICMgTeG6t2MgxJHhu4tuaCA3aCBzw6FuZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aW1lc3RhbXAgY2hvIGdp4budIHJlc2V0IGjDtG0gbmF5CiAgICAgICAgICAgIHRvZGF5X3Jlc2V0X3RpbWUgPSBub3cucmVwbGFjZShob3VyPXJlc2V0X2hvdXIsIG1pbnV0ZT0wLCBzZWNvbmQ9MCwgbWljcm9zZWNvbmQ9MCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgZ2nhu50gaGnhu4duIHThuqFpIGNoxrBhIMSR4bq/biBnaeG7nSByZXNldCBow7RtIG5heSwgdGjDrCBnaeG7nSByZXNldCBjdeG7kWkgY8O5bmcgbMOgIGjDtG0gcXVhCiAgICAgICAgICAgIGlmIG5vdyA8IHRvZGF5X3Jlc2V0X3RpbWU6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X3RpbWUgPSB0b2RheV9yZXNldF90aW1lIC0gdGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfdGltZSA9IHRvZGF5X3Jlc2V0X3RpbWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdGjhu51pIGdpYW4gcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgREIKICAgICAgICAgICAgbGFzdF9yZXNldF90aW1lc3RhbXAgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJsYXN0X2RhaWx5X3Jlc2V0X3RpbWVzdGFtcCIsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNvIHPDoW5oIHRpbWVzdGFtcCDEkeG7gyBxdXnhur90IMSR4buLbmggY8OzIGPhuqduIHJlc2V0IGtow7RuZwogICAgICAgICAgICBpZiBsYXN0X3Jlc2V0X3RpbWVzdGFtcCA8IGxhc3RfcmVzZXRfdGltZS50aW1lc3RhbXAoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgZGFpbHkgY291bnRlcnMgbMO6YyB7bm93LnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfSAoZ2nhu50gcmVzZXQ6IHtyZXNldF9ob3VyfWgpIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBqb2IgY291bnRlcnMgLSBs4bqleSB04bqldCBj4bqjIGFjY291bnRzIChraMO0bmcgZmlsdGVyKQogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhkZXZpY2VfaWQ9RmFsc2UpICAjIGRldmljZV9pZD1GYWxzZSDEkeG7gyBraMO0bmcgZmlsdGVyIHRoZW8gZGV2aWNlCiAgICAgICAgICAgICAgICByZXNldF9jb3VudCA9IDAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpZCIpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAwLCAgIyBT4butIGThu6VuZyBqb2JfdG9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogMCAgIyBT4butIGThu6VuZyBmb2xsb3dfdG9kYXkgdGhheSB2w6wgZGFpbHlfZm9sbG93X2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc2V0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IHRpbWVzdGFtcCByZXNldCBt4bubaQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfZ2xvYmFsX2NvbmZpZyh7CiAgICAgICAgICAgICAgICAgICAgImxhc3RfZGFpbHlfcmVzZXRfZGF0ZSI6IG5vdy5zdHJmdGltZSgiJVktJW0tJWQiKSwgICMgR2nhu68gxJHhu4MgYmFja3dhcmQgY29tcGF0aWJpbGl0eQogICAgICAgICAgICAgICAgICAgICJsYXN0X2RhaWx5X3Jlc2V0X3RpbWVzdGFtcCI6IGludChsYXN0X3Jlc2V0X3RpbWUudGltZXN0YW1wKCkpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgcmVzZXQgZGFpbHkgY291bnRlcnMgY2hvIHtyZXNldF9jb3VudH0gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkRhaWx5IGNvdW50ZXJzIMSRw6MgxJHGsOG7o2MgcmVzZXQgcuG7k2kgKGzhuqduIGN14buRaToge2RhdGV0aW1lLmZyb210aW1lc3RhbXAobGFzdF9yZXNldF90aW1lc3RhbXApLnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfSkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBkYWlseSBjb3VudGVyczoge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgZGFpbHkgY291bnRlcnM6IHtlfSIpCiAgICAKICAgIGRlZiBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgaG/hurdjIGNoxINtIHPDs2MKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3RdOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgYXBwX3dvcmthYmxlX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgYXBwX3dvcmthYmxlX2NvdW50ICs9IDEKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gxJHGsOG7o2Mge2xlbih3b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdOG7qyB7bGVuKGVuYWJsZWRfYXBwcyl9IGFwcHMiKQogICAgICAgIAogICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbiBz4butIGThu6VuZyDEkcO6bmcgdMOqbiB0csaw4budbmcgZGF0YWJhc2UKICAgICAgICB3b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiaXNfbG9naW4iLCBGYWxzZSksICAjIMavdSB0acOqbiBhY2NvdW50IMSRw6MgbG9naW4KICAgICAgICAgICAgLXguZ2V0KCJqb2JfdG9kYXkiLCAwKSwgICMgxq91IHRpw6puIGFjY291bnQgw610IGpvYiBoxqFuIChkw7luZyBqb2JfdG9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2NvdW50KQogICAgICAgICAgICAteC5nZXQoImxhc3Rfam9iX3RpbWUiLCAwKSAgIyDGr3UgdGnDqm4gYWNjb3VudCBsw6J1IGtow7RuZyBsw6BtIGpvYiAodGltZXN0YW1wIG5nxrDhu6NjKQogICAgICAgICksIHJldmVyc2U9VHJ1ZSkKICAgICAgICAKICAgICAgICByZXR1cm4gd29ya2FibGVfYWNjb3VudHMKICAgIAogICAgZGVmIF9jYW5fd29ya193aXRoX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHRo4buDIGzDoG0gdmnhu4djIGhv4bq3YyBjaMSDbSBzw7NjIHbhu5tpIHTDoGkga2hv4bqjbiBraMO0bmcKICAgICAgICAow4FwIGThu6VuZyBjaG8gY+G6oyBKT0IgdsOgIENBUkUpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHJlc2V0IHNlc3Npb24gbuG6v3UgcXVhIG5nw6B5IG3hu5tpCiAgICAgICAgICAgIGlmIHNlbGYuX3Nob3VsZF9yZXNldF9zZXNzaW9uX29uX25ld19kYXkoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgIk5nw6B5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzdGF0dXMgKHPhu60gZOG7pW5nIGxvZ2ljIG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzIGluIFsiZGlzYWJsZWQiLCAibG9nb3V0Il06CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgaW5hY3RpdmUsIGtp4buDbSB0cmEgam9iX2Rpc2FibGVfdW50aWwgKGdp4buRbmcgSm9iU2VydmljZSkKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsID4gdGltZS50aW1lKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFbhuqtuIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgam9iX2VuYWJsZSA9IDEgKGJvb2xlYW4gY2hlY2spCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFwcCBjw7MgxJHGsOG7o2MgZW5hYmxlIGtow7RuZwogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgY8OzIGpvYiBoYW5kbGVyIGtow7RuZwogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBhY2NvdW50IGPDsyDEkWFuZyBuZ2jhu4kgbmfGoWkga2jDtG5nCiAgICAgICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhhY2NvdW50X2lkKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS0jDlE5HIGtp4buDbSB0cmEgaXNfZ29saWtlX2xpbmtlZCDhu58gxJHDonkgLSDEkeG7gyBjaG8gX2Nhbl9ydW5fam9iKCkgY2hlY2sKICAgICAgICAgICAgIyBBY2NvdW50IGPDsyB0aOG7gyDEkcaw4bujYyBjaMSDbSBzw7NjIG3DoCBraMO0bmcgY+G6p24gbGluayBHb0xpa2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBhY2NvdW50IHdvcmthYmxlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2Nhbl9kb19qb2Jfd2l0aF9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBsw6BtIEpPQiB24bubaSB0w6BpIGtob+G6o24ga2jDtG5nIChyacOqbmcgYmnhu4d0IHbhu5tpIGNhcmUpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjxqEgYuG6o24gdHLGsOG7m2MKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudChhY2NvdW50KToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgZGFpbHkgam9iIGxpbWl0IC0gc+G7rSBk4bulbmcgZmllbGQgbmFtZXMgxJHDum5nIG5oxrAgREIgc2NoZW1hCiAgICAgICAgICAgIGRhaWx5X2pvYl9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKSAgIyBGaWVsZCB0aOG6rXQgdHJvbmcgREIKICAgICAgICAgICAgZGFpbHlfam9iX2xpbWl0ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgICMgRmllbGQgdGjhuq10IHRyb25nIERCCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gam9iIGxpbWl0IGNoZWNrOiBqb2JfdG9kYXk9e2RhaWx5X2pvYl9jb3VudH0sIGpvYl9tYXhfZGF5PXtkYWlseV9qb2JfbGltaXR9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRhaWx5X2pvYl9saW1pdCA+IDAgYW5kIGRhaWx5X2pvYl9jb3VudCA+PSBkYWlseV9qb2JfbGltaXQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZGFpbHkgam9iIGxpbWl0ICh7ZGFpbHlfam9iX2NvdW50fS97ZGFpbHlfam9iX2xpbWl0fSkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgYWNjb3VudCBjw7MgxJFhbmcgcmVzdGluZyBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9yZXN0aW5nKGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IMSRYW5nIHJlc3RpbmciKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIEdvTGlrZSBsaW5rIChj4bqnbiBjaG8gam9iKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gY2jGsGEgbGluayBHb0xpa2UiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gY8OzIHRo4buDIGzDoG0gam9iOiBqb2JzPXtkYWlseV9qb2JfY291bnR9L3tkYWlseV9qb2JfbGltaXR9LCBnb2xpa2U9e2FjY291bnQuZ2V0KCdpc19nb2xpa2VfbGlua2VkJywgRmFsc2UpfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBjYW4gZG8gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyBsb2dpYyB04buRaSDGsHUgdOG7qyBKb2JTZXJ2aWNlOgogICAgICAgIDEuIFTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wICh04burIHRyYWNraW5nKQogICAgICAgIDIuIFTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyB0aOG7qSB04buxIGFwcCwgbmfDoHkgdOG6oW8KICAgICAgICAKICAgICAgICBDaOG7iSB2ZXJpZnkgbG9naW4gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBob+G6t2Mga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBPcHRpb25hbFtEaWN0XTogVMOgaSBraG/huqNuIMSRxrDhu6NjIGNo4buNbiBob+G6t2MgTm9uZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IEtp4buDbSB0cmEgY3VycmVudCB3b3JraW5nIGFjY291bnQgdHLGsOG7m2MKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudDoKICAgICAgICAgICAgICAgIGN1cnJlbnRfaWQgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJLaeG7g20gdHJhIGN1cnJlbnQgYWNjb3VudDoge2N1cnJlbnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSBkYXRhIG3hu5tpIG5o4bqldCB04burIGRhdGFiYXNlCiAgICAgICAgICAgICAgICB1cGRhdGVkX2N1cnJlbnRfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoY3VycmVudF9pZCkKICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY3VycmVudCBhY2NvdW50IGPDsyBjw7JuIMSR4bunIMSRaeG7gXUga2nhu4duIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgICAgICAgICAgICAgIGNhbl9jb250aW51ZSA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KHVwZGF0ZWRfY3VycmVudF9hY2NvdW50KSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgbm90IHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhjdXJyZW50X2lkKSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgbm90IHNlbGYuX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChjdXJyZW50X2lkKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBjYW5fY29udGludWU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlRp4bq/cCB04bulYyB24bubaSBjdXJyZW50IGFjY291bnQ6IHtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICMgVXBkYXRlIHdvcmtpbmcgYWNjb3VudCB24bubaSBkYXRhIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gdXBkYXRlZF9jdXJyZW50X2FjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRfY3VycmVudF9hY2NvdW50CiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDdXJyZW50IGFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IGtow7RuZyBjw7JuIGzDoG0gdmnhu4djIMSRxrDhu6NjLCB0w6xtIGFjY291bnQgbeG7m2kiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyDEkOG6t3QgYWNjb3VudCBoaeG7h24gdOG6oWkgbmdo4buJIG5nxqFpIG7hur91IGPhuqduCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChjdXJyZW50X2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGN1cnJlbnRfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb24gPSBmIlNlc3Npb24gbGltaXQ6IHtzZXNzaW9uWydhY3Rpb25fY291bnQnXX0gYWN0aW9ucywge3Nlc3Npb25bJ2pvYl9jb3VudCddfSBqb2JzIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChjdXJyZW50X2lkLCByZWFzb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4bq3dCBhY2NvdW50IHtjdXJyZW50X3VzZXJuYW1lfSBuZ2jhu4kgbmfGoWkgLSB7cmVhc29ufSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIENsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiQ3VycmVudCBhY2NvdW50IHtjdXJyZW50X2lkfSBraMO0bmcgdOG7k24gdOG6oWkgdHJvbmcgREIiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogVMOsbSBhY2NvdW50IMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyB0cmFja2luZyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAjIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBsw6BtIHZp4buHYyB24bubaSBhcHAgbsOgeSAoY2jhu4kga2hpIGPhuqduKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICAjIENo4buJIHZlcmlmeSBraGkga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyB0cm9uZyB0cmFja2luZyBob+G6t2Mga2hpIHRyYWNraW5nIGtow7RuZyBo4bujcCBs4buHCiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IGzhuqduIMSR4bqndS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSDEkcOjIHRo4butIHZlcmlmeSDEkeG7gyBraMO0bmcgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEPDsyB0cmFja2luZyBy4buTaSwga2jDtG5nIGPhuqduIHZlcmlmeSBuZ2F5CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIHThu6sgdHJhY2tpbmcKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGxvZ2dlZF9pbl9hY2NvdW50X2lkKQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQgYW5kIHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgIyBWZXJpZnkgYWNjb3VudCB0aOG7sWMgdOG6vyB0csOqbiBhcHAgKHF1YW4gdHLhu41uZyBzYXUga2hpIHJlc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3ZlcmlmeV9hY2NvdW50X2luX2FwcChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdsOgIHZlcmlmaWVkIHTDoGkga2hv4bqjbiB04burIHRyYWNraW5nOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB0cmFja2luZyB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgdmVyaWZ5IMSRxrDhu6NjLCB4w7NhIHRyYWNraW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVmVyaWZ5IGZ1bmN0aW9uIMSRw6MgdOG7sSDEkeG7mW5nIHjDs2EgdHJhY2tpbmcgdsOgIHN5bmMsIHRp4bq/cCB04bulYyB0w6xtIGFjY291bnQga2jDoWMKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBraMO0bmcgY8OybiBo4bujcCBs4buHLCB4w7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQsIHsiaXNfbG9naW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHtsb2dnZWRfaW5fYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMzogVMOsbSB0w6BpIGtob+G6o24gxJHEg25nIG5o4bqtcCB04burIGRhdGFiYXNlIHbhu5tpIHZlcmlmaWNhdGlvbiB0aOG7sWMgdOG6vwogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICMgxq91IHRpw6puIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIHThu6sgREIgLSBz4butIGThu6VuZyBmaWVsZCAiaXNfbG9naW4iIG5oxrAgSm9iU2VydmljZQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBhbmQgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogVmVyaWZ5IHRo4buxYyB04bq/IHRyw6puIGFwcCB0csaw4bubYyBraGkgdGluIHTGsOG7n25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3ZlcmlmeV9hY2NvdW50X2luX2FwcChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdsOgIHZlcmlmaWVkIHTDoGkga2hv4bqjbiDEkcSDbmcgbmjhuq1wOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgdmVyaWZ5IMSRxrDhu6NjLCB0aeG6v3AgdOG7pWMgdMOsbS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFZlcmlmeSBz4bq9IHThu7EgxJHhu5luZyBzeW5jIHbDoCBj4bqtcCBuaOG6rXQgdHJhY2tpbmcsIHRp4bq/cCB04bulYyB24bubaSBhY2NvdW50IGtow6FjCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgNDogTuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgbOG6pXkgdMOgaSBraG/huqNuIHRoZW8gdGjhu6kgdOG7sQogICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBEZWJ1ZzogVGjhu5FuZyBrw6ogY2hpIHRp4bq/dCBhY2NvdW50cyB0aGVvIGFwcAogICAgICAgICAgICB0b3RhbF9hY2NvdW50cyA9IDAKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICB0b3RhbF9hY2NvdW50cyArPSBsZW4oYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIvCfk7EgQXBwIHthcHBfbmFtZX06IHtsZW4oYWNjb3VudHMpfSB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFBow6JuIHTDrWNoIHThu6tuZyB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIHdvcmthYmxlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgZm9yIGFjYyBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGFjYy5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICd1bmtub3duJykKICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSBhY2MuZ2V0KCdzdGF0dXMnLCAndW5rbm93bicpCiAgICAgICAgICAgICAgICAgICAgam9iX2VuYWJsZSA9IGFjYy5nZXQoJ2pvYl9lbmFibGUnLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpc19sb2dpbiA9IGFjYy5nZXQoJ2lzX2xvZ2luJywgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaXNfZ29saWtlX2xpbmtlZCA9IGFjYy5nZXQoJ2lzX2dvbGlrZV9saW5rZWQnLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBqb2JfdG9kYXkgPSBhY2MuZ2V0KCdqb2JfdG9kYXknLCAwKQogICAgICAgICAgICAgICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjLmdldCgnam9iX21heF9kYXknLCAwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjw7Mgd29ya2FibGUga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgY2FuX3dvcmsgPSBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIiAgIHt1c2VybmFtZX06IHN0YXR1cz17c3RhdHVzfSwgam9iX2VuYWJsZT17am9iX2VuYWJsZX0sICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiaXNfbG9naW49e2lzX2xvZ2lufSwgZ29saWtlPXtpc19nb2xpa2VfbGlua2VkfSwgIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZiJqb2JzPXtqb2JfdG9kYXl9L3tqb2JfbWF4X2RheX0sIGNhbl93b3JrPXtjYW5fd29ya30iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGNhbl93b3JrOgogICAgICAgICAgICAgICAgICAgICAgICB3b3JrYWJsZV9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5hcHBlbmQoYWNjKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiIgICDihpIge3dvcmthYmxlX2NvdW50fS97bGVuKGFjY291bnRzKX0gY8OzIHRo4buDIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+UjSBU4buVbmcga+G6v3Q6IHtsZW4oYWxsX3dvcmthYmxlX2FjY291bnRzKX0ve3RvdGFsX2FjY291bnRzfSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHThu6sge2xlbihzZWxmLmVuYWJsZWRfYXBwcyl9IGFwcHMiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGFsbF93b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLinYwgS2jDtG5nIGPDsyBhY2NvdW50IG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIC0ga2nhu4NtIHRyYSBsb2cgY2hpIHRp4bq/dCDhu58gdHLDqm4iKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm46IGFwcCBuYW1lLCBjcmVhdGVkX2RhdGUKICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLnNvcnQoCiAgICAgICAgICAgICAgICBrZXk9bGFtYmRhIHg6ICh4LmdldCgiYXBwIiwgIiIpLCB4LmdldCgiY3JlYXRlZF9kYXRlIiwgIiIpKQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqjIHbhu4EgYWNjb3VudCDEkeG6p3UgdGnDqm4KICAgICAgICAgICAgc2VsZWN0ZWRfYWNjb3VudCA9IGFsbF93b3JrYWJsZV9hY2NvdW50c1swXQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNo4buNbiBhY2NvdW50IHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm46IHtzZWxlY3RlZF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7c2VsZWN0ZWRfYWNjb3VudC5nZXQoJ2FwcCcpfSkiKQogICAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRfYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHRyb25nIF9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfdmVyaWZ5X2FjY291bnRfaW5fYXBwKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSBhY2NvdW50IHRo4buxYyB04bq/IHRyw6puIGFwcCBjw7MgxJHDum5nIGFjY291bnQgxJFhbmcgbG9naW4gdHJvbmcgREIga2jDtG5nCiAgICAgICAgTuG6v3Uga2jDtG5nIMSRw7puZyB0aMOsIHN5bmMgbOG6oWkgYWNjb3VudCB04burIGFwcCB24buBIERCCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogQWNjb3VudCB04burIERCIGPDsyBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBhY2NvdW50IMSRw7puZyBob+G6t2Mgc3luYyB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGPDsyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgZXhwZWN0ZWRfdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZ5IGFjY291bnQge2V4cGVjdGVkX3VzZXJuYW1lfSB0csOqbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBN4bufIGFwcCB2w6Aga2nhu4NtIHRyYSBhY2NvdW50IGhp4buHbiB04bqhaQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBhcHAgxJHGsOG7o2MgbeG7nwogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnZW5zdXJlX2FwcF9vcGVuJyk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5lbnN1cmVfYXBwX29wZW4oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHVzZXJuYW1lIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIGFwcAogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgbOG6pXkgxJHGsOG7o2MgdXNlcm5hbWUgaGnhu4duIHThuqFpIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgU2V0IGFjY291bnQgduG7gSBpc19sb2dpbiA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7ImlzX2xvZ2luIjogRmFsc2UsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgICMgWMOzYSBraOG7j2kgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBTbyBzw6FuaCB24bubaSBhY2NvdW50IHRyb25nIERCCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lLmxvd2VyKCkgPT0gZXhwZWN0ZWRfdXNlcm5hbWUubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBWZXJpZmllZDogQWNjb3VudCB7ZXhwZWN0ZWRfdXNlcm5hbWV9IMSRw7puZyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4p2MIEFjY291bnQgbWlzbWF0Y2g6IERCPXtleHBlY3RlZF91c2VybmFtZX0sIEFwcD17Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgQ+G6p24gc3luYyBs4bqhaSB04burIGFwcCB24buBIERCCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3N5bmNfYWNjb3VudF9mcm9tX2FwcF90b19kYihhcHBfbmFtZSwgY3VycmVudF91c2VybmFtZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX3ZlcmlmeV9hY2NvdW50X2luX2FwcDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9zeW5jX2FjY291bnRfZnJvbV9hcHBfdG9fZGIoc2VsZiwgYXBwX25hbWU6IHN0ciwgY3VycmVudF91c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFN5bmMgYWNjb3VudCB04burIGFwcCB24buBIERCIGtoaSBwaMOhdCBoaeG7h24gbWlzbWF0Y2gKICAgICAgICBT4butIGThu6VuZyBsb2dpYyB04burIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgY3VycmVudF91c2VybmFtZTogVXNlcm5hbWUgxJFhbmcgbG9naW4gdGjhu7FjIHThur8gdHLDqm4gYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugc3luYyB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgYWNjb3VudCB04burIHthcHBfbmFtZX0gduG7gSBEQi4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSRxINuZyBrw70gcHJveHkgbuG6v3UgY+G6p24gdHLGsOG7m2Mga2hpIHN5bmMgYWNjb3VudHMKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5jaGVja19wcm94eV9yZXF1aXJlbWVudCgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgbOG6pXkgcHJveHkgY2hvIHZp4buHYyDEkeG7k25nIGLhu5kge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBTeW5jIHThuqV0IGPhuqMgYWNjb3VudHMgdOG7qyBhcHAgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHN5bmMge2xlbihhY2NvdW50cyl9IGFjY291bnRzIHThu6sge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHN5bmMgYWNjb3VudHMgdOG7qyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogUmVzZXQgdOG6pXQgY+G6oyBhY2NvdW50cyBj4bunYSBhcHAgduG7gSBpc19sb2dpbiA9IEZhbHNlCiAgICAgICAgICAgIGFwcF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYXBwX2FjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMzogVMOsbSB2w6AgY+G6rXAgbmjhuq10IGFjY291bnQgxJFhbmcgbG9naW4gdGjhu7FjIHThur8KICAgICAgICAgICAgY3VycmVudF9hY2NvdW50ID0gTm9uZQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhcHBfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkgPT0gY3VycmVudF91c2VybmFtZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IGFjY291bnQKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgYWNjb3VudCBoaeG7h24gdOG6oWkgduG7gSBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoY3VycmVudF9hY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBjdXJyZW50X2FjY291bnRbImlkIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUgU3luYyB0aMOgbmggY8O0bmc6IEFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IMSRw6MgxJHGsOG7o2MgY+G6rXAgbmjhuq10IGxvZ2luIHN0YXR1cyIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinYwgS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IHRyb25nIERCIHNhdSBzeW5jIikKICAgICAgICAgICAgICAgICMgWMOzYSB0cmFja2luZwogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzeW5jIGFjY291bnQgdOG7qyBhcHAgduG7gSBEQjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgdHLhuqFuZyB0aMOhaSBsb2dpbiB0aOG7sWMgdOG6vyB0csOqbiDEkWnhu4duIHRob+G6oWkgc+G7rSBk4bulbmcgaMOgbSBjw7Mgc+G6tW4gY+G7p2EgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyBsb2dpbiB0aOG7sWMgdOG6vyB0csOqbiDEkWnhu4duIHRob+G6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY8OzIHPhurVuIMSR4buDIGNoZWNrIGxvZ2luIHN0YXR1cwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgaWYgY3VycmVudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBcHAge2FwcF9uYW1lfSDEkcOjIGxvZ2luIHbhu5tpIHVzZXJuYW1lOiB7Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFwcCB7YXBwX25hbWV9IGNoxrBhIGxvZ2luIGhv4bq3YyBraMO0bmcgbOG6pXkgxJHGsOG7o2MgdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBraeG7g20gdHJhIGxvZ2luIHN0YXR1cyBjaG8ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICMgRmFsbGJhY2s6IHPhu60gZOG7pW5nIHRy4bqhbmcgdGjDoWkgdOG7qyBEQgogICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB2YWxpZGF0ZSBhY3R1YWwgbG9naW4gc3RhdHVzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9pc19jb3JyZWN0X2FjY291bnRfbG9nZ2VkX2luKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIMSRw7puZyBhY2NvdW50IG7DoHkgxJFhbmcgxJHEg25nIG5o4bqtcCB0csOqbiDEkWnhu4duIHRob+G6oWkga2jDtG5nCiAgICAgICAgU+G7rSBk4bulbmcgaMOgbSBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY8OzIHPhurVuIGPhu6dhIGhhbmRsZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw7puZyBhY2NvdW50IG7DoHkgxJFhbmcgxJHEg25nIG5o4bqtcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgdGFyZ2V0X3VzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY8OzIHPhurVuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lIGFuZCB0YXJnZXRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgaXNfY29ycmVjdCA9IGN1cnJlbnRfdXNlcm5hbWUubG93ZXIoKSA9PSB0YXJnZXRfdXNlcm5hbWUubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkN1cnJlbnQgbG9nZ2VkOiB7Y3VycmVudF91c2VybmFtZX0sIFRhcmdldDoge3RhcmdldF91c2VybmFtZX0sIE1hdGNoOiB7aXNfY29ycmVjdH0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc19jb3JyZWN0CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIktow7RuZyBs4bqleSDEkcaw4bujYyBjdXJyZW50IHVzZXJuYW1lIGhv4bq3YyB0YXJnZXQgdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBs4bqleSBjdXJyZW50IHVzZXJuYW1lIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogYXNzdW1lIGNvcnJlY3QgbuG6v3Uga2jDtG5nIGNoZWNrIMSRxrDhu6NjCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjaGVjayBjb3JyZWN0IGFjY291bnQgbG9nZ2VkIGluOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gY2h1eeG7g24gxJHhu5VpIHTDoGkga2hv4bqjbiBz4butIGThu6VuZyBsb2dpYyBjw7Mgc+G6tW4gdHJvbmcgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIGPhuqduIGNodXnhu4NuIHThu5tpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY2h1eeG7g24gxJHhu5VpIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBzd2l0Y2ggc2FuZyBhY2NvdW50IHt1c2VybmFtZX0gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGNhcmUgYWN0aW9uIGNvdW50ZXIga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzZWxmLl9yZXNldF9jYXJlX2FjdGlvbl9jb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgY3VycmVudCBsb2dnZWQgYWNjb3VudCB0csaw4bubYyBraGkgc3dpdGNoCiAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50IGLhurFuZyBoYW5kbGVyIC0gc+G7rSBk4bulbmcgaMOgbSBjw7Mgc+G6tW4KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHN3aXRjaF90b19hY2NvdW50IGPDsyBz4bq1biB0cm9uZyBoYW5kbGVyCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICdzd2l0Y2hfdG9fYWNjb3VudCcpOgogICAgICAgICAgICAgICAgICAgIHN3aXRjaF9yZXN1bHQgPSBoYW5kbGVyLnN3aXRjaF90b19hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBY4butIGzDvSBr4bq/dCBxdeG6oyBzd2l0Y2gKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHN3aXRjaF9yZXN1bHQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAjIEhhbmRsZXIgdHLhuqMgduG7gSByZXN1bHQgZGljdAogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gc3dpdGNoX3Jlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHN3aXRjaF9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTd2l0Y2ggYWNjb3VudCB0aMOgbmggY8O0bmc6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBsb2dpbiB0cm9uZyBEQiB2w6AgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKGFwcF9uYW1lLCBhY2NvdW50X2lkLCBUcnVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU3dpdGNoIGFjY291bnQgdGjhuqV0IGLhuqFpOiB7dXNlcm5hbWV9IC0ge21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgSGFuZGxlciB0cuG6oyB24buBIGJvb2xlYW4gKGxlZ2FjeSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3dpdGNoIGFjY291bnQgdGjDoG5oIGPDtG5nOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gdHJvbmcgREIgdsOgIHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCwgVHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlN3aXRjaCBhY2NvdW50IHRo4bqldCBi4bqhaToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBGYWxsYmFjazogc+G7rSBk4bulbmcgZW5zdXJlX2FjY291bnRfbG9nZ2VkX2luCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiSGFuZGxlciB7YXBwX25hbWV9IGtow7RuZyBjw7Mgc3dpdGNoX3RvX2FjY291bnQsIGTDuW5nIGVuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbiIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbihhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgc3dpdGNoIGFjY291bnQge3VzZXJuYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtIGFjY291bnQgc3dpdGNoOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gdMOgaSBraG/huqNuIMSRw6MgxJHEg25nIG5o4bqtcCB0csOqbiBhcHAgduG7m2kgbG9naWMgdOG7kWkgxrB1CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB0YXJnZXRfdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBzd2l0Y2ggYWNjb3VudCBraMO0bmcKICAgICAgICAgICAgY3VycmVudF9sb2dnZWRfYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBuZWVkc19hY2NvdW50X3N3aXRjaCA9IChjdXJyZW50X2xvZ2dlZF9hY2NvdW50X2lkICE9IGFjY291bnRfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBuZWVkc19hY2NvdW50X3N3aXRjaDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6p24gY2h1eeG7g24gYWNjb3VudDogY3VycmVudD17Y3VycmVudF9sb2dnZWRfYWNjb3VudF9pZH0gLT4gdGFyZ2V0PXthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAyOiBWYWxpZGF0ZSBs4bqhaSB24bubaSBhcHAgdGjhu7FjIHThur8gdHLGsOG7m2Mga2hpIHN3aXRjaAogICAgICAgICAgICAgICAgc2hvdWxkX3N3aXRjaCA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgVOG7kEkgxq9VOiBDaOG7iSB2ZXJpZnkga2hpIHRo4buxYyBz4buxIG5naGkgbmfhu50gY+G6p24gc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBtZW1vcnkgdHJhY2tpbmcgY2hvIGJp4bq/dCDEkcOjIMSRw7puZyBhY2NvdW50LCBza2lwIHZlcmlmaWNhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMgYW5kIFwKICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJNZW1vcnkgdHJhY2tpbmcgY2hvIGJp4bq/dCDEkcOjIMSRw7puZyBhY2NvdW50IHt0YXJnZXRfdXNlcm5hbWV9LCBza2lwIHZlcmlmaWNhdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjdXJyZW50IHVzZXJuYW1lIHRyw6puIGFwcCB0aOG7sWMgdOG6vyBz4butIGThu6VuZyBow6BtIGPDsyBz4bq1bgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJWZXJpZnkgY3VycmVudCB1c2VybmFtZSB0csOqbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9hcHBfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYXBwX3VzZXJuYW1lIGFuZCBjdXJyZW50X2FwcF91c2VybmFtZS5sb3dlcigpID09IHRhcmdldF91c2VybmFtZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBcHAgxJHDoyDEkcO6bmcgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9LCBraMO0bmcgY+G6p24gc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbWVtb3J5IHRyYWNraW5nIGNobyDEkcO6bmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBcHAgaGnhu4duIHThuqFpOiAne2N1cnJlbnRfYXBwX3VzZXJuYW1lfScsIGPhuqduIGNodXnhu4NuIHNhbmc6ICd7dGFyZ2V0X3VzZXJuYW1lfSciKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kgY2hlY2sgY3VycmVudCB1c2VybmFtZToge2V9IikKICAgICAgICAgICAgICAgICAgICAjIFbhuqtuIHRp4bq/cCB04bulYyBzd2l0Y2ggbuG6v3Uga2jDtG5nIGNoZWNrIMSRxrDhu6NjCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAzOiBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50IGNo4buJIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgICAgICAgICBpZiBzaG91bGRfc3dpdGNoOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjYXJlIGFjdGlvbiBjb3VudGVyIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9jYXJlX2FjdGlvbl9jb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGN1cnJlbnQgbG9nZ2VkIGFjY291bnQgdHLGsOG7m2Mga2hpIHN3aXRjaAogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBzd2l0Y2ggYWNjb3VudCAtIGhhbmRsZXIgc+G6vSB04buxIMSR4bqjbSBi4bqjbyBhcHAgbeG7nwogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHN3aXRjaF90b19hY2NvdW50IGPDsyBz4bq1biB0cm9uZyBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaF9yZXN1bHQgPSBoYW5kbGVyLnN3aXRjaF90b19hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjIHN3aXRjaAogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHN3aXRjaF9yZXN1bHQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU3dpdGNoIGFjY291bnQgdGjhuqV0IGLhuqFpOiB7c3dpdGNoX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnVW5rbm93biBlcnJvcicpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlN3aXRjaCBhY2NvdW50IHRo4bqldCBi4bqhaSBjaG8ge3RhcmdldF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHN3aXRjaCBhY2NvdW50OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiS2jDtG5nIGPhuqduIHN3aXRjaCBhY2NvdW50IGNobyB7dGFyZ2V0X3VzZXJuYW1lfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt0YXJnZXRfdXNlcm5hbWV9IMSRw6MgbMOgIGN1cnJlbnQgbG9nZ2VkIGFjY291bnQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IMSQ4bqjbSBi4bqjbyDhu58gaG9tZSBzY3JlZW4gKGhhbmRsZXIgc+G6vSB04buxIG3hu58gYXBwIG7hur91IGPhuqduKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIGFic3RyYWN0IG1ldGhvZCBlbnN1cmVfaG9tZV9zY3JlZW4gLSBuw7Mgc+G6vSB04buxIGNoZWNrIHbDoCBt4bufIGFwcAogICAgICAgICAgICAgICAgaWYgbm90IGhhbmRsZXIuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIGhvbWUgc2NyZWVuIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmV0dXJuIHRy4bqhbmcgdGjDoWkgbG9naW4KICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3IgYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkhhbmRsZXIge2FwcF9uYW1lfSBjaMawYSBpbXBsZW1lbnQgYXBwIG1hbmFnZW1lbnQgbWV0aG9kczoge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBleGNlcHQgTm90SW1wbGVtZW50ZWRFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiSGFuZGxlciB7YXBwX25hbWV9IGNoxrBhIGltcGxlbWVudCBhcHAgbWFuYWdlbWVudCBtZXRob2RzOiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZW5zdXJlIGFjY291bnQgbG9nZ2VkIGluOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jYW5fcnVuX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gam9iIGtow7RuZyAoc+G7rSBk4bulbmcgbG9naWMgbmjGsCBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIDEuIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24gKGdp4buRbmcgSm9iU2VydmljZSkKICAgICAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzIGluIFsiZGlzYWJsZWQiLCAibG9nb3V0Il06CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgaW5hY3RpdmUsIGtp4buDbSB0cmEgam9iX2Rpc2FibGVfdW50aWwKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsID4gdGltZS50aW1lKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDIuIEtp4buDbSB0cmEgam9iX2VuYWJsZQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gS2nhu4NtIHRyYSDEkcOjIGxpw6puIGvhur90IEdvTGlrZSAoY+G6p24gY2hvIGpvYnMpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA0LiBLaeG7g20gdHJhIMSRw6MgbG9naW4KICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA1LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBkYWlseQogICAgICAgICAgICBkYWlseV9saW1pdCA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDEwMCkgICMgU+G7rSBk4bulbmcgam9iX21heF9kYXkgbmjGsCBKb2JTZXJ2aWNlCiAgICAgICAgICAgIGRhaWx5X2NvdW50ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApICAjIFPhu60gZOG7pW5nIGpvYl90b2RheSBuaMawIEpvYlNlcnZpY2UKICAgICAgICAgICAgaWYgZGFpbHlfY291bnQgPj0gZGFpbHlfbGltaXQ6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNi4gS2nhu4NtIHRyYSBhcHAgY8OzIMSRxrDhu6NjIGVuYWJsZSBraMO0bmcKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGNhbiBydW4gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgdMOgaSBraG/huqNuIC0gdGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIMSRxrDhu6NjIGNo4buNbiB24bubaSBsb2dpYyB04buRaSDGsHUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGtow7RuZyBjw7MgbOG7l2kgbmdoacOqbSB0cuG7jW5nIChhY3Rpb24gY8OzIHRo4buDIHRo4bqldCBi4bqhaSBuaMawbmcgYWNjb3VudCB24bqrbiDhu5VuKQogICAgICAgICAgICAgICAgICBGYWxzZSBjaOG7iSBraGkgY8OzIGzhu5dpIG5naGnDqm0gdHLhu41uZyBj4bqnbiBjbGVhciBjdXJyZW50IGFjY291bnQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRVUFOIFRS4buMTkc6IFJlbG9hZCBhY2NvdW50IGRhdGEgdOG7qyBEQiDEkeG7gyDEkeG6o20gYuG6o28gdGjDtG5nIHRpbiBt4bubaSBuaOG6pXQgKHNhdSBzd2l0Y2gpCiAgICAgICAgICAgIGZyZXNoX2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIGZyZXNoX2FjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50ID0gZnJlc2hfYWNjb3VudAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVsb2FkZWQgZnJlc2ggYWNjb3VudCBkYXRhIGZvciB7dXNlcm5hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIHJlbG9hZCBhY2NvdW50IGRhdGEgY2hvIHt1c2VybmFtZX0sIHPhu60gZOG7pW5nIGRhdGEgY8WpIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSRxrDhu6NjIHNldCDEkcO6bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgb3Igc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImlkIikgIT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBhY2NvdW50CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJD4bqtcCBuaOG6rXQgY3VycmVudCB3b3JraW5nIGFjY291bnQ6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRVUFOIFRS4buMTkc6IMSQ4bqjbSBi4bqjbyBhY2NvdW50IMSRxrDhu6NjIHN3aXRjaCB0aOG7sWMgdOG6vyB0csOqbiBtw6F5CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9lbnN1cmVfYWNjb3VudF9zd2l0Y2hlZChhY2NvdW50KToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIHN3aXRjaCBzYW5nIGFjY291bnQge3VzZXJuYW1lfSwgxJHDoW5oIGThuqV1IHByb2JsZW1hdGljIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgYWNjb3VudCBjw7MgduG6pW4gxJHhu4EgdsOgIHNldCBuZ2jhu4kgbmfGoWkKICAgICAgICAgICAgICAgIHNlbGYuX3NldF9hY2NvdW50X3Jlc3QoYWNjb3VudF9pZCwgZiJTd2l0Y2ggZmFpbGVkOiBLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyBhY2NvdW50IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEzhu5dpIG5naGnDqm0gdHLhu41uZywgY2xlYXIgY3VycmVudCBhY2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGFjY291bnQgY8OzIMSRYW5nIG5naOG7iSBuZ8ahaSBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9yZXN0aW5nKGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHt1c2VybmFtZX0gxJFhbmcgbmdo4buJIG5nxqFpLCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBLaMO0bmcgcGjhuqNpIGzhu5dpIG5naGnDqm0gdHLhu41uZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7jW4gaMOgbmggxJHhu5luZyBuZ+G6q3Ugbmhpw6puIHRow7RuZyBxdWEgSm9iQmFzZQogICAgICAgICAgICBjaG9zZW5fYWN0aW9uID0gc2VsZi5fY2hvb3NlX3JhbmRvbV9hY3Rpb24oYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgc2Vzc2lvbiBpbmZvIHbDoCBsaW1pdHMgxJHhu4MgaGnhu4NuIHRo4buLCiAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQpCiAgICAgICAgICAgIHNlc3Npb25fbGltaXRzID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoYWNjb3VudCkKICAgICAgICAgICAgc2Vzc2lvbl9pbmZvID0gZiIoe3Nlc3Npb25bJ2FjdGlvbl9jb3VudCddfS97c2Vzc2lvbl9saW1pdHNbJ21heF9hY3Rpb25zX3Blcl9zZXNzaW9uJ119IGFjdGlvbnMsICIgXAogICAgICAgICAgICAgICAgICAgICAgICAgIGYie3Nlc3Npb25bJ2pvYl9jb3VudCddfS97c2Vzc2lvbl9saW1pdHNbJ21heF9qb2JzX3Blcl9zZXNzaW9uJ119IGpvYnMpIgogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgJ3tjaG9zZW5fYWN0aW9ufScgY2hvIHt1c2VybmFtZX0ge3Nlc3Npb25faW5mb30iKQogICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIntjaG9zZW5fYWN0aW9ufToge3VzZXJuYW1lfSB7c2Vzc2lvbl9pbmZvfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBhY3Rpb25fc3VjY2VzcyA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyDEkcaw4bujYyBjaOG7jW4gdGjDtG5nIHF1YSBKb2JCYXNlCiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBoYW5kbGVyOgogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgcGVyZm9ybV9hY3Rpb24gdOG7lW5nIHF1w6F0IHThu6sgSm9iQmFzZQogICAgICAgICAgICAgICAgYWN0aW9uX3N1Y2Nlc3MgPSBoYW5kbGVyLnBlcmZvcm1fYWN0aW9uKGNob3Nlbl9hY3Rpb24sIGFjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGNhcmUgYWN0aW9uIGNvdW50IHbDoCBqb2IgcmF0aW8gY2hvIGPDoWMgYWN0aW9uIGNhcmUKICAgICAgICAgICAgICAgICMgQ2jhu4kgxJHhur9tIGNhcmUgYWN0aW9ucywga2jDtG5nIMSRaeG7gXUgY2jhu4luaCBqb2IgcmF0aW8gbuG7r2EKICAgICAgICAgICAgICAgIGlmIGFjdGlvbl9zdWNjZXNzIGFuZCBjaG9zZW5fYWN0aW9uICE9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW5jcmVtZW50X2NhcmVfYWN0aW9uX2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBlbGlmIGFjdGlvbl9zdWNjZXNzIGFuZCBjaG9zZW5fYWN0aW9uID09IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjYXJlIGFjdGlvbiBjb3VudCBzYXUga2hpIGzDoG0gam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgYWN0aW9uX3N1Y2Nlc3MgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgc2Vzc2lvbiBkYXRhCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgY2hvc2VuX2FjdGlvbiwgYWN0aW9uX3N1Y2Nlc3MpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdoaSBs4bqhaSBs4buLY2ggc+G7rSBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIHNlbGYuX3JlY29yZF9hY3Rpb25faGlzdG9yeShhY2NvdW50X2lkLCBjaG9zZW5fYWN0aW9uLCBhY3Rpb25fc3VjY2VzcykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIG7Dqm4gY2h1eeG7g24gYWNjb3VudCBraMO0bmcgc2F1IGFjdGlvbiBuw6B5CiAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBzZWxmLl9zaG91bGRfc3dpdGNoX2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgc2hvdWxkX3N3aXRjaDoKICAgICAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVhc29uID0gc2VsZi5fZ2V0X3N3aXRjaF9yZWFzb24oYWNjb3VudF9pZCwgc2Vzc2lvbikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJT4bq9IGNodXnhu4NuIGFjY291bnQgc2F1IGFjdGlvbiBuw6B5LiBMw70gZG86IHtzd2l0Y2hfcmVhc29ufSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBT4butIGThu6VuZyDEkcO6bmcgbG/huqFpIHJlc3QgZOG7sWEgdHLDqm4gbMO9IGRvCiAgICAgICAgICAgICAgICBzZWxmLl9hcHBseV9hcHByb3ByaWF0ZV9yZXN0X3R5cGUoYWNjb3VudF9pZCwgc3dpdGNoX3JlYXNvbiwgc2Vzc2lvbikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBTZXQgbWVzc2FnZSBjaG8gZGV2aWNlCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIk5naOG7iSBuZ8ahaToge3VzZXJuYW1lfSAoe3N3aXRjaF9yZWFzb259KSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgZm9yY2UgdMOsbSBhY2NvdW50IG3hu5tpIGzhuqduIHNhdQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXR1cm4gRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY+G6p24gdMOsbSBhY2NvdW50IG3hu5tpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIFRydWUgdsOsIGtow7RuZyBjw7MgbOG7l2kgbmdoacOqbSB0cuG7jW5nCiAgICAgICAgICAgICMgKGFjdGlvbiBjw7MgdGjhu4MgdGjhuqV0IGLhuqFpIG5oxrBuZyBhY2NvdW50IHbhuqtuIOG7lW4pCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgd29yayB3aXRoIHNpbmdsZSBhY2NvdW50OiB7ZX0iKQogICAgICAgICAgICAjIENo4buJIHJldHVybiBGYWxzZSBraGkgY8OzIGV4Y2VwdGlvbiBuZ2hpw6ptIHRy4buNbmcKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfZ2V0X3N3aXRjaF9yZWFzb24oc2VsZiwgYWNjb3VudF9pZDogaW50LCBzZXNzaW9uOiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGzDvSBkbyBjaHV54buDbiBhY2NvdW50CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgYWNjb3VudAogICAgICAgICAgICBzZXNzaW9uOiBTZXNzaW9uIGRhdGEKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBMw70gZG8gY2h1eeG7g24gYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBjb25maWcgbGltaXRzCiAgICAgICAgICAgIG1heF9jb25zZWN1dGl2ZV9mYWlscyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoInN3aXRjaF9hY2NvdW50X2FmdGVyX2NvbnNlY3V0aXZlX2ZhaWxzIiwgMykKICAgICAgICAgICAgbWF4X25vX2pvYl9hdHRlbXB0cyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoInN3aXRjaF9hY2NvdW50X2FmdGVyX25vX2pvYnMiLCA1KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIGFjY291bnQgdsOgIHNlc3Npb24gbGltaXRzCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcmV0dXJuICJBY2NvdW50IGtow7RuZyB04buTbiB04bqhaSIKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlc3Npb25fbGltaXRzID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoYWNjb3VudCkKICAgICAgICAgICAgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iXQogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdCiAgICAgICAgICAgIG1heF9zZXNzaW9uX2R1cmF0aW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9zZXNzaW9uX2R1cmF0aW9uIl0KICAgICAgICAgICAgCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHNlc3Npb25fZHVyYXRpb24gPSBjdXJyZW50X3RpbWUgLSBzZXNzaW9uWydzdGFydF90aW1lJ10KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlc3Npb25fZHVyYXRpb24gPj0gbWF4X3Nlc3Npb25fZHVyYXRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gZiJI4bq/dCB0aOG7nWkgZ2lhbiBzZXNzaW9uICh7c2Vzc2lvbl9kdXJhdGlvbi82MDouMWZ9L3ttYXhfc2Vzc2lvbl9kdXJhdGlvbi82MDouMWZ9IHBow7p0KSIKICAgICAgICAgICAgZWxpZiBzZXNzaW9uWydhY3Rpb25fY291bnQnXSA+PSBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIHJldHVybiBmIsSQ4bqhdCBnaeG7m2kgaOG6oW4gYWN0aW9ucyAoe3Nlc3Npb25bJ2FjdGlvbl9jb3VudCddfS97bWF4X2FjdGlvbnNfcGVyX3Nlc3Npb259KSIKICAgICAgICAgICAgZWxpZiBzZXNzaW9uWydqb2JfY291bnQnXSA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIHJldHVybiBmIsSQ4bqhdCBnaeG7m2kgaOG6oW4gam9icyAoe3Nlc3Npb25bJ2pvYl9jb3VudCddfS97bWF4X2pvYnNfcGVyX3Nlc3Npb259KSIKICAgICAgICAgICAgZWxpZiBzZWxmLmFjY291bnRfY29uc2VjdXRpdmVfZmFpbHVyZXMuZ2V0KGFjY291bnRfaWQsIDApID49IG1heF9jb25zZWN1dGl2ZV9mYWlsczoKICAgICAgICAgICAgICAgIHJldHVybiBmIlRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AgKHtzZWxmLmFjY291bnRfY29uc2VjdXRpdmVfZmFpbHVyZXNbYWNjb3VudF9pZF19KSIKICAgICAgICAgICAgZWxpZiBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzLmdldChhY2NvdW50X2lkLCAwKSA+PSBtYXhfbm9fam9iX2F0dGVtcHRzOgogICAgICAgICAgICAgICAgcmV0dXJuIGYiS2jDtG5nIGPDsyBqb2IgbGnDqm4gdGnhur9wICh7c2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXX0pIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuICJLaMOhYyIKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHN3aXRjaCByZWFzb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiTOG7l2kgeMOhYyDEkeG7i25oIGzDvSBkbyIKICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIkto4bufaSDEkeG7mW5nIE1haW5TZXJ2aWNlIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSDEkeG7mW5nIE1haW5TZXJ2aWNlLi4uIikKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgCiAgICAgICAgIyBLaOG7n2kgdOG6oW8gbuG6v3UgY2jGsGEgxJHGsOG7o2Mga2jhu59pIHThuqFvCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBNYWluU2VydmljZSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICAjIENo4bqheSBtYWluIGxvb3AgdHJvbmcgdGhyZWFkCiAgICAgICAgc2VsZi5ydW4oKQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENo4bqheSBNYWluU2VydmljZSAtIGxvb3AgY2jDrW5oIGvhur90IGjhu6NwIGNoxINtIHPDs2MgdsOgIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBNYWluU2VydmljZS4gS2jDtG5nIHRo4buDIGNo4bqheS4iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBjaOG6oXkgTWFpblNlcnZpY2UgduG7m2kgbG9naWMgaMOgaSBow7JhIGNoxINtIHPDs2MgdsOgIGzDoG0gdmnhu4djLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyB4w6FjIMSR4buLbmggZGV2aWNlX2lkIGhp4buHbiB04bqhaSwgTWFpblNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHdoaWxlIHNlbGYucnVubmluZzoKICAgICAgICAgICAgIyBSZXNldCBiaeG6v24gZm9yY2Vfc3RvcCBu4bq/dSBjw7MKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciAoY29uZmlnIMSR4buZYyBs4bqtcCwga2jDtG5nIG7hurFtIHRyb25nIGdsb2JhbF9jb25maWcpCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyLCB04bqhbSBk4burbmcgeOG7rSBsw70iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG5nYXkga2hpIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICBwcm94eV9jb25maWcgPSBzZWxmLmRiLmdldF9wcm94eV9jb25maWcoe30pCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBwcm94eV9jb25maWcuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGludGVybmV0CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuY2hlY2tfaW50ZXJuZXQoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIGPDsyBr4bq/dCBu4buRaSBpbnRlcm5ldCwgbmdo4buJIDIwcyB2w6AgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMjApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2hvbWUoKQogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MgKGzhuqduIHtzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudH0pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICAgICAgcHJveHlfY29uZmlnID0gc2VsZi5kYi5nZXRfcHJveHlfY29uZmlnKHt9KQogICAgICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHByb3h5X2NvbmZpZy5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBOZ2jhu4kgdHLGsOG7m2Mga2hpIGtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIga2hpIGPDsyB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB3b3JraW5nIGFjY291bnQKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBhY2NvdW50X3RvX3dvcmsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gY8OzIHByb3h5IHRyxrDhu5tjIGtoaSBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKCJMw6BtIHZp4buHYyBow6BpIGjDsmEiKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTVNHX1dPUktJTkdfSEFSTU9OSU9VUykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIHdvcmtfcmVzdWx0ID0gc2VsZi5fd29ya193aXRoX3NpbmdsZV9hY2NvdW50KGFjY291bnRfdG9fd29yaykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSB3b3JrX3Jlc3VsdCA9IEZhbHNlLCBuZ2jEqWEgbMOgIGFjY291bnQgY+G6p24gbmdo4buJIG5nxqFpCiAgICAgICAgICAgICAgICAjIFRp4bq/cCB04bulYyB0w6xtIGFjY291bnQga2jDoWMgbmdheSBs4bqtcCB04bupYwogICAgICAgICAgICAgICAgaWYgbm90IHdvcmtfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJBY2NvdW50IMSRw6MgxJHGsOG7o2MgxJHhurd0IG5naOG7iSBuZ8ahaSwgdMOsbSBhY2NvdW50IGtow6FjLi4uIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgbOG6p24gbMOgbSB2aeG7h2MgduG7m2kgY8O5bmcgYWNjb3VudAogICAgICAgICAgICAgICAgYWN0aW9uX2RlbGF5X21pbiA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImFjdGlvbl9kZWxheV9taW4iLCAzKQogICAgICAgICAgICAgICAgYWN0aW9uX2RlbGF5X21heCA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImFjdGlvbl9kZWxheV9tYXgiLCA4KQogICAgICAgICAgICAgICAgZGVsYXlfdGltZSA9IHJhbmRvbS5yYW5kaW50KGFjdGlvbl9kZWxheV9taW4sIGFjdGlvbl9kZWxheV9tYXgpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7ZGVsYXlfdGltZX1zIHRyxrDhu5tjIGtoaSBsw6BtIHZp4buHYyB0aeG6v3AgdGhlbyIpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKGRlbGF5X3RpbWUpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kgdHJvbmcgdsOybmcgbOG6t3AgY2jDrW5oIE1haW5TZXJ2aWNlIikKICAgICAgICAgICAgICAgICMgTmdo4buJIG3hu5l0IGNow7p0IHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgzMCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAKICAgICAgICAjIENsZWFudXAga2hpIHRob8OhdAogICAgICAgIHNlbGYuX2NsZWFudXBfb25fZXhpdCgpCiAgICAgICAgbG9nZ2VyLmluZm8oIk1haW5TZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgIAogICAgZGVmIF9jbGVhbnVwX29uX2V4aXQoc2VsZik6CiAgICAgICAgIiIiQ2xlYW51cCBraGkgTWFpblNlcnZpY2UgZOG7q25nIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE5o4bqjIHByb3h5CiAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBraGkgTWFpblNlcnZpY2UgZOG7q25nIikKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOzbmcgdOG6pXQgY+G6oyBhcHAKICAgICAgICAgICAgZm9yIGFwcF9uYW1lLCBoYW5kbGVyIGluIHNlbGYuam9iX2hhbmRsZXJzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAge2FwcF9uYW1lfSBraGkgTWFpblNlcnZpY2UgZOG7q25nIikKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoaGFuZGxlciwgJ2Nsb3NlX2FwcCcpOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2xvc2VfYXBwKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kgY2xlYW51cDoge2V9IikKICAgIAogICAgZGVmIF92ZXJpZnlfY3VycmVudF9hY2NvdW50X29uX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyLCBoYW5kbGVyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbiB0csOqbiBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIgY+G7p2EgYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Q6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIMSRYW5nIGxvZ2luIHRo4bqtdCB0csOqbiBhcHAsIE5vbmUgbuG6v3Uga2jDtG5nIGPDsyBob+G6t2MgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKGhhbmRsZXIsICdnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUnKToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSGFuZGxlciB7YXBwX25hbWV9IGtow7RuZyBo4buXIHRy4bujIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHThu6sgVUkKICAgICAgICAgICAgY3VycmVudF9hY2NvdW50X3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICBpZiBub3QgY3VycmVudF9hY2NvdW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdMOgaSBraG/huqNuIHRyb25nIERCCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKSA9PSBjdXJyZW50X2FjY291bnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZmllZDogVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnRfdXNlcm5hbWV9IMSRYW5nIGxvZ2luIHRo4bqtdCB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50X3VzZXJuYW1lfSDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IG5oxrBuZyBraMO0bmcgY8OzIHRyb25nIERCIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfc3luY19hY2NvdW50X2xvZ2luX3N0YXR1c193aXRoX3JlYWxpdHkoc2VsZiwgYXBwX25hbWU6IHN0ciwgaGFuZGxlcik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhu5NuZyBi4buZIHRy4bqhbmcgdGjDoWkgaXNfbG9naW4gdHJvbmcgREIgduG7m2kgdGjhu7FjIHThur8gdHLDqm4gYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyIGPhu6dhIGFwcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gY8OzIHByb3h5IHRyxrDhu5tjIGtoaSB2ZXJpZnkgYWNjb3VudCAobuG6v3UgY+G6p24pCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZChmIlZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX0iKToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyB2ZXJpZnkgYWNjb3VudCB0csOqbiB7YXBwX25hbWV9LCBi4buPIHF1YSB2ZXJpZnkiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4KICAgICAgICAgICAgY3VycmVudF9hY2NvdW50ID0gc2VsZi5fdmVyaWZ5X2N1cnJlbnRfYWNjb3VudF9vbl9hcHAoYXBwX25hbWUsIGhhbmRsZXIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPhu6dhIGFwcCBuw6B5IHbhu4EgaXNfbG9naW4gPSBGYWxzZSB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgcmVzZXRfY291bnQgPSAwCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgcmVzZXRfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IGlzX2xvZ2luID0gRmFsc2UgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNldF9jb3VudCA+IDA6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHtyZXNldF9jb3VudH0gdMOgaSBraG/huqNuIHbhu4EgaXNfbG9naW4gPSBGYWxzZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4KICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChjdXJyZW50X2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGN1cnJlbnRfYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IMSRYW5nIGxvZ2luIHRo4bqtdCB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBsb2dpbgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyB0cuG6oW5nIHRow6FpOiBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgc3luYyBsb2dpbiBzdGF0dXMgY2hvIHthcHBfbmFtZX06IHtlfSIpCgogICAgZGVmIF9pbml0aWFsX3N5bmNfYWxsX2FjY291bnRzX2xvZ2luX3N0YXR1cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gYmFuIMSR4bqndTogxJHhu41jIHThuqV0IGPhuqMgYXBwcyB2w6Agc3luYyB0cuG6oW5nIHRow6FpIGlzX2xvZ2luIGNobyBjaHXhuqluIHjDoWMKICAgICAgICBDaOG7iSBn4buNaSBt4buZdCBs4bqnbiBraGkga2jhu59pIMSR4buZbmcgTWFpblNlcnZpY2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLwn5SNIELhuq90IMSR4bqndSBraOG7n2kgdOG6oW86IFN5bmMgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdOG6pXQgY+G6oyBhcHBzLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcgxJHhu4MgYuG6r3QgxJHhuqd1IGZyZXNoCiAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZC5jbGVhcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFN5bmMgdOG7q25nIGFwcAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfk7EgU3luYyB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50X2xvZ2luX3N0YXR1c193aXRoX3JlYWxpdHkoYXBwX25hbWUsIGhhbmRsZXIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUgSG/DoG4gdGjDoG5oIHN5bmMge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLinYwgTOG7l2kgc3luYyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBGYWxzZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIuKaoO+4jyBLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIHN5bmMiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfjq8gSG/DoG4gdGjDoG5oIGto4bufaSB04bqhbyBzeW5jIGxvZ2luIHN0YXR1cy4gVHJhY2tpbmc6IHtzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYi4p2MIEzhu5dpIHRyb25nIGluaXRpYWwgc3luYyBhY2NvdW50czoge2V9IikKCiAgICBkZWYgX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGFjY291bnRfaWQ6IGludCwgaXNfbG9naW46IGJvb2wpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgY+G7p2EgdMOgaSBraG/huqNuICh0xrDGoW5nIHThu7EgSm9iU2VydmljZSkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgdMOgaSBraG/huqNuIAogICAgICAgICAgICBpc19sb2dpbjogVHJ1ZSBu4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAsIEZhbHNlIG7hur91IGxvZ291dAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBpc19sb2dpbiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nIHRyb25nIG1lbW9yeQogICAgICAgICAgICBpZiBpc19sb2dpbjoKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBraMOhYyBj4bunYSBjw7luZyBhcHAgbMOgIGxvZ291dAogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBvbGRfYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgaWYgb2xkX2FjY291bnRfaWQgIT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChvbGRfYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gY8WpIHtvbGRfYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGxvZ291dCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSB0w6BpIGtob+G6o24gbeG7m2kKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFjDs2Ega2jhu49pIHRyYWNraW5nIG7hur91IGxvZ291dAogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyBhbmQgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcDoge2V9IikKCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgTWFpblNlcnZpY2UiIiIKICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIE1haW5TZXJ2aWNlLi4uIikKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgCiAgICBkZWYgZm9yY2Vfc3RvcF9hbGwoc2VsZik6CiAgICAgICAgIiIiRm9yY2Ugc3RvcCB04bqldCBj4bqjIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIkZvcmNlIHN0b3AgTWFpblNlcnZpY2UuLi4iKQogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAKICAgIGRlZiBnZXRfc2VydmljZV9zdGF0cyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aOG7kW5nIGvDqiBj4bunYSBNYWluU2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Q6IFRo4buRbmcga8OqIHNlcnZpY2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBzdGF0cyA9IHsKICAgICAgICAgICAgICAgICJzZXJ2aWNlX3R5cGUiOiAiTWFpblNlcnZpY2UiLAogICAgICAgICAgICAgICAgImlzX3J1bm5pbmciOiBzZWxmLnJ1bm5pbmcsCiAgICAgICAgICAgICAgICAiaXNfaW5pdGlhbGl6ZWQiOiBzZWxmLmlzX2luaXRpYWxpemVkLAogICAgICAgICAgICAgICAgInRvdGFsX3dvcmthYmxlX2FjY291bnRzIjogbGVuKHdvcmthYmxlX2FjY291bnRzKSwKICAgICAgICAgICAgICAgICJjdXJyZW50X3dvcmtpbmdfYWNjb3VudCI6IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKSBpZiBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50IGVsc2UgTm9uZSwKICAgICAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBzZWxmLmdldF9lbmFibGVkX2FwcHMoKSwKICAgICAgICAgICAgICAgICJjYXJlX2FjdGlvbl9jb3VudHMiOiBzZWxmLmNhcmVfYWN0aW9uX2NvdW50cywKICAgICAgICAgICAgICAgICJub19qb2JfY29uc2VjdXRpdmVfY291bnQiOiBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCwKICAgICAgICAgICAgICAgICJwcm94eV9hY3RpdmUiOiBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCkgaWYgaGFzYXR0cihzZWxmLnByb3h5X3NlcnZpY2UsICdpc19wcm94eV9hY3RpdmUnKSBlbHNlIEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBzdGF0cwogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGdldCBzZXJ2aWNlIHN0YXRzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4ge30KICAgIAogICAgIyBNZXRob2RzIMSR4buDIHTGsMahbmcgdGjDrWNoIHbhu5tpIEpvYlNlcnZpY2UgaW50ZXJmYWNlIGNobyBNUVRUIHNlcnZpY2UKICAgIGRlZiBoYW5kbGVfbXF0dF9jb25maWdfdXBkYXRlKHNlbGYsIGNvbmZpZ19jaGFuZ2VzOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPhuq1wIG5o4bqtdCBjb25maWcgdOG7qyBNUVRUCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnX2NoYW5nZXM6IEPDoWMgdGhheSDEkeG7lWkgY29uZmlnCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2Ugbmjhuq1uIGNvbmZpZyB1cGRhdGUgdOG7qyBNUVRUIikKICAgICAgICAgICAgaWYgY29uZmlnX2NoYW5nZXM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNvbmZpZyBjaGFuZ2VzOiB7Y29uZmlnX2NoYW5nZXN9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZW5hYmxlZF9hcHBzIG7hur91IGPDsyB0aGF5IMSR4buVaSB0cm9uZyBnbG9iYWxfY29uZmlnCiAgICAgICAgICAgICAgICBpZiAiZ2xvYmFsX2NvbmZpZyIgaW4gY29uZmlnX2NoYW5nZXM6CiAgICAgICAgICAgICAgICAgICAgb2xkX2VuYWJsZWRfYXBwcyA9IHNlbGYuZW5hYmxlZF9hcHBzLmNvcHkoKSAgIyBDYWNoZSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGdsb2JhbF9jb25maWcgbeG7m2kgdOG7qyBkYXRhYmFzZSBzYXUga2hpIMSRw6MgbMawdQogICAgICAgICAgICAgICAgICAgIG5ld19nbG9iYWxfY29uZmlnID0gc2VsZi5kYi5nZXRfZ2xvYmFsX2NvbmZpZyh7fSkKICAgICAgICAgICAgICAgICAgICBuZXdfZW5hYmxlZF9hcHBzID0gbmV3X2dsb2JhbF9jb25maWcuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gZW5hYmxlZF9hcHBzIGPDsyB0aGF5IMSR4buVaSBraMO0bmcKICAgICAgICAgICAgICAgICAgICBpZiBzZXQob2xkX2VuYWJsZWRfYXBwcykgIT0gc2V0KG5ld19lbmFibGVkX2FwcHMpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlBow6F0IGhp4buHbiB0aGF5IMSR4buVaSBlbmFibGVkX2FwcHM6IHtvbGRfZW5hYmxlZF9hcHBzfSAtPiB7bmV3X2VuYWJsZWRfYXBwc30iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBY4butIGzDvSB0aGF5IMSR4buVaSBlbmFibGVkX2FwcHMKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5faGFuZGxlX2VuYWJsZWRfYXBwc19jaGFuZ2Uob2xkX2VuYWJsZWRfYXBwcywgbmV3X2VuYWJsZWRfYXBwcykKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgU3luYyBjYWNoZSB24bubaSBnbG9iYWxfY29uZmlnIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gbmV3X2VuYWJsZWRfYXBwcwogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mgc3luYyBlbmFibGVkX2FwcHMgY2FjaGU6IHtzZWxmLmVuYWJsZWRfYXBwc30iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiZW5hYmxlZF9hcHBzIGtow7RuZyB0aGF5IMSR4buVaSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzeW5jX3N0YXR1cyBjaGFuZ2VzIHbDoCByZWxvYWQgYWNjb3VudHMgbuG6v3UgY+G6p24KICAgICAgICAgICAgICAgIHN5bmNfc3RhdHVzX2NoYW5nZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgZm9yIGtleSBpbiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgICAgICBpZiBrZXkuZW5kc3dpdGgoJ19zeW5jX3N0YXR1cycpOgogICAgICAgICAgICAgICAgICAgICAgICBzeW5jX3N0YXR1c19jaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlBow6F0IGhp4buHbiB0aGF5IMSR4buVaSBzeW5jIHN0YXR1czoge2tleX0gPSB7Y29uZmlnX2NoYW5nZXNba2V5XX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBzeW5jX3N0YXR1c19jaGFuZ2VkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLwn5SEIFN5bmMgc3RhdHVzIMSRw6MgdGhheSDEkeG7lWksIHJlbG9hZCBhY2NvdW50cyB2w6AgcmUtc2NhbiB04burIHRoaeG6v3QgYuG7iy4uLiIpCiAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBmb3JjZSByZWZyZXNoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAjIENsZWFyIGxvZ2luIHRyYWNraW5nIMSR4buDIGZvcmNlIHJlLXZlcmlmaWNhdGlvbgogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuY2xlYXIoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkLmNsZWFyKCkKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGPDoWMgY291bnRlciDEkeG7gyBi4bqvdCDEkeG6p3UgY3ljbGUgbeG7m2kKICAgICAgICAgICAgICAgICAgICBzZWxmLm5vX2FjY291bnRfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUcmlnZ2VyIHJlLXNjYW4gYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4sgY2hvIGPDoWMgYXBwIMSRxrDhu6NjIGVuYWJsZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jlc2Nhbl9kZXZpY2VfYWNjb3VudHNfYXN5bmMoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLinIUgxJDDoyByZXNldCB3b3JraW5nIGFjY291bnQsIGxvZ2luIHRyYWNraW5nIHbDoCB0cmlnZ2VyIHJlLXNjYW4gc2F1IHN5bmMgc3RhdHVzIGNoYW5nZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGhhbmRsZSBtcXR0IGNvbmZpZyB1cGRhdGU6IHtlfSIpCiAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9hY2NvdW50X3VwZGF0ZShzZWxmKToKICAgICAgICAiIiJY4butIGzDvSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHThu6sgTVFUVCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk1haW5TZXJ2aWNlIG5o4bqtbiBhY2NvdW50IHVwZGF0ZSB04burIE1RVFQiKQogICAgICAgICAgICAjIENsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSR4buDIGZvcmNlIHJlZnJlc2gKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBoYW5kbGUgbXF0dCBhY2NvdW50IHVwZGF0ZToge2V9IikKICAgIAogICAgZGVmIGhhbmRsZV9tcXR0X2ZvcmNlX3N0YXJ0X3Nlc3Npb24oc2VsZik6CiAgICAgICAgIiIiWOG7rSBsw70gecOqdSBj4bqndSBi4bqvdCDEkeG6p3Ugc2Vzc2lvbiB04burIE1RVFQiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBuaOG6rW4gZm9yY2Ugc3RhcnQgc2Vzc2lvbiB04burIE1RVFQiKQogICAgICAgICAgICAjIFJlc2V0IGPDoWMgY291bnRlcgogICAgICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBoYW5kbGUgbXF0dCBmb3JjZSBzdGFydCBzZXNzaW9uOiB7ZX0iKQogICAgCiAgICBkZWYgc2h1dGRvd24oc2VsZik6CiAgICAgICAgIiIiU2h1dGRvd24gTWFpblNlcnZpY2UiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTaHV0ZG93biBNYWluU2VydmljZS4uLiIpCiAgICAgICAgICAgIHNlbGYuc3RvcCgpCiAgICAgICAgICAgIHNlbGYuX2NsZWFudXBfb25fZXhpdCgpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc2h1dGRvd24gTWFpblNlcnZpY2U6IHtlfSIpCiAgICAKICAgICMgVGjDqm0gY8OhYyBtZXRob2Qga2jDoWMgxJHhu4MgdMawxqFuZyB0aMOtY2ggduG7m2kgSm9iU2VydmljZQogICAgZGVmIHJlc2V0X2N1cnJlbnRfcHJveHlfaXAoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiJSZXNldCBJUCBwcm94eSBoaeG7h24gdOG6oWkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5wcm94eV9zZXJ2aWNlLCAncmVzZXRfY3VycmVudF9wcm94eV9pcCcpOgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5yZXNldF9jdXJyZW50X3Byb3h5X2lwKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgcHJveHkgSVA6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X3N0YXR1cyhzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiTOG6pXkgdHLhuqFuZyB0aMOhaSBwcm94eSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLnByb3h5X3NlcnZpY2UsICdnZXRfcHJveHlfc3RhdHVzJyk6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9zdGF0dXMoKQogICAgICAgICAgICByZXR1cm4gIlVua25vd24iCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHByb3h5IHN0YXR1czoge2V9IikKICAgICAgICAgICAgcmV0dXJuICJFcnJvciIKICAgIAogICAgZGVmIGdldF9wcm94eV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gcHJveHkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5wcm94eV9zZXJ2aWNlLCAnZ2V0X3Byb3h5X2luZm8nKToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZ2V0X3Byb3h5X2luZm8oKQogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBnZXQgcHJveHkgaW5mbzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAKICAgIGRlZiBfaGFuZGxlX2VuYWJsZWRfYXBwc19jaGFuZ2Uoc2VsZiwgb2xkX2VuYWJsZWRfYXBwczogTGlzdFtzdHJdLCBuZXdfZW5hYmxlZF9hcHBzOiBMaXN0W3N0cl0pIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70ga2hpIGPDsyB0aGF5IMSR4buVaSBlbmFibGVkX2FwcHMgdOG7qyBNUVRUIGNvbmZpZyB1cGRhdGUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBvbGRfZW5hYmxlZF9hcHBzOiBEYW5oIHPDoWNoIGFwcCDEkcaw4bujYyBlbmFibGUgdHLGsOG7m2MgxJHDswogICAgICAgICAgICBuZXdfZW5hYmxlZF9hcHBzOiBEYW5oIHPDoWNoIGFwcCDEkcaw4bujYyBlbmFibGUgbeG7m2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgWMOhYyDEkeG7i25oIGFwcHMgYuG7iyBkaXNhYmxlCiAgICAgICAgICAgIGRpc2FibGVkX2FwcHMgPSBzZXQob2xkX2VuYWJsZWRfYXBwcykgLSBzZXQobmV3X2VuYWJsZWRfYXBwcykKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2V0KG5ld19lbmFibGVkX2FwcHMpIC0gc2V0KG9sZF9lbmFibGVkX2FwcHMpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkaXNhYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5qrIEFwcHMgYuG7iyBkaXNhYmxlOiB7bGlzdChkaXNhYmxlZF9hcHBzKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIDEuIFJlc2V0IGN1cnJlbnRfd29ya2luZ19hY2NvdW50IG7hur91IHRodeG7mWMgYXBwIGLhu4sgZGlzYWJsZQogICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2FwcCA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYXBwIGluIGRpc2FibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgInVua25vd24iKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCflIQgUmVzZXQgY3VycmVudCB3b3JraW5nIGFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9ICh7Y3VycmVudF9hcHB9KSBkbyBhcHAgYuG7iyBkaXNhYmxlIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyAyLiBDbGVhciBsb2dpbiB0cmFja2luZyBj4bunYSBhcHAgYuG7iyBkaXNhYmxlCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZGlzYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+nuSBDbGVhciBsb2dpbiB0cmFja2luZyBjaG8ge2FwcF9uYW1lfSAoYWNjb3VudF9pZDoge2FjY291bnRfaWR9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBpbml0aWFsX2FjY291bnRfdmVyaWZpZWQgxJHhu4MgZm9yY2UgcmUtdmVyaWZ5IG7hur91IGFwcCDEkcaw4bujYyBlbmFibGUgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZDoKICAgICAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfp7kgQ2xlYXIgdmVyaWZpZWQgc3RhdHVzIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyAzLiBTZXQgdOG6pXQgY+G6oyBhY2NvdW50cyBj4bunYSBhcHAgYuG7iyBkaXNhYmxlIHbhu4EgaXNfbG9naW49RmFsc2UKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBkaXNhYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5SEIFNldCBpc19sb2dpbj1GYWxzZSBjaG8gYWNjb3VudCB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHJlc2V0IGFjY291bnRzIGPhu6dhIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgcmVzZXQgdHLhuqFuZyB0aMOhaSBjaG8ge2xlbihkaXNhYmxlZF9hcHBzKX0gYXBwcyBi4buLIGRpc2FibGUiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUgQXBwcyDEkcaw4bujYyBlbmFibGU6IHtsaXN0KGVuYWJsZWRfYXBwcyl9IikKICAgICAgICAgICAgICAgICMgQXBwcyBt4bubaSDEkcaw4bujYyBlbmFibGUgc+G6vSB04buxIMSR4buZbmcgxJHGsOG7o2MgeOG7rSBsw70gdHJvbmcgX3Jlc2Nhbl9kZXZpY2VfYWNjb3VudHNfYXN5bmMKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBfaGFuZGxlX2VuYWJsZWRfYXBwc19jaGFuZ2U6IHtlfSIpCgogICAgZGVmIF9yZXNjYW5fZGV2aWNlX2FjY291bnRzX2FzeW5jKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFJlLXNjYW4gYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4sgbeG7mXQgY8OhY2ggYXN5bmMgxJHhu4Mga2jDtG5nIGJsb2NrIG1haW4gdGhyZWFkCiAgICAgICAgIiIiCiAgICAgICAgZGVmIF9yZXNjYW5fd29ya2VyKCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLwn5SNIELhuq90IMSR4bqndSByZS1zY2FuIGFjY291bnRzIHThu6sgdGhp4bq/dCBi4buLLi4uIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZS1zY2FuIGNobyB04burbmcgYXBwIMSRxrDhu6NjIGVuYWJsZQogICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfk7EgUmUtc2NhbiBhY2NvdW50cyB04burIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSRxINuZyBrw70gcHJveHkgbuG6v3UgY+G6p24gdHLGsOG7m2Mga2hpIHN5bmMgYWNjb3VudHMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBs4bqleSBwcm94eSBjaG8gdmnhu4djIHJlLXNjYW4ge2FwcF9uYW1lfSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIHN5bmNfYWNjb3VudHNfdG9fZGIgdOG7qyBCYXNlSm9iIHRoYXkgdsOsIHThu7EgaW1wbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUge2FwcF9uYW1lfTogxJDDoyBzeW5jIHtsZW4oZGV2aWNlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5OxIHthcHBfbmFtZX06IEtow7RuZyB0w6xtIHRo4bqleSBhY2NvdW50IG7DoG8gdOG7qyB0aGnhur90IGLhu4sgaG/hurdjIGzhu5dpIHN5bmMiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZS1zY2FuIGFjY291bnRzIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi8J+OryBIb8OgbiB0aMOgbmggcmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX3Jlc2Nhbl93b3JrZXI6IHtlfSIpCiAgICAgICAgCiAgICAgICAgIyBDaOG6oXkgdHJvbmcgdGhyZWFkIHJpw6puZyDEkeG7gyBraMO0bmcgYmxvY2sgbWFpbiBsb29wCiAgICAgICAgcmVzY2FuX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PV9yZXNjYW5fd29ya2VyLCBkYWVtb249VHJ1ZSkKICAgICAgICByZXNjYW5fdGhyZWFkLnN0YXJ0KCkKICAgICAgICBsb2dnZXIuaW5mbygi8J+agCDEkMOjIGto4bufaSDEkeG7mW5nIHJlLXNjYW4gdGhyZWFkIikKICAgIAogICAgZGVmIHJlc2V0X2V4cGlyZWRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgY8OhYyB0w6BpIGtob+G6o24gZXhwaXJlZCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIGFjY291bnRzIGV4cGlyZWQgdsOgIHJlc2V0IG7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hbGxfYWNjb3VudHMoKQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfZXhwaXJlZCIpOgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budIGNoxrBhICh2w60gZOG7pSAxIGdp4budKQogICAgICAgICAgICAgICAgICAgIGV4cGlyZWRfdGltZSA9IGFjY291bnQuZ2V0KCJleHBpcmVkX3RpbWUiLCAwKQogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdGltZSAtIGV4cGlyZWRfdGltZSA+IDM2MDA6ICAjIDEgZ2nhu50KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBleHBpcmVkIGFjY291bnQ6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfZXhwaXJlZCI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4cGlyZWRfdGltZSI6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaGFzX2Vycm9yIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBleHBpcmVkIGFjY291bnRzOiB7ZX0iKQogICAgCiAgICBkZWYgcmVzZXRfbG9nb3V0X2FjY291bnRzKHNlbGYpOgogICAgICAgICIiIlJlc2V0IGPDoWMgdMOgaSBraG/huqNuIGxvZ291dCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2luIGPhu6dhIGPDoWMgYWNjb3VudCBu4bq/dSBj4bqnbgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FsbF9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfbG9naW4iKSBhbmQgYWNjb3VudC5nZXQoImlzX2FjdGl2ZSIpOgogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRo4buDIHRow6ptIGxvZ2ljIMSR4buDIHRo4butIGxvZ2luIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgbG9nb3V0IGFjY291bnRzOiB7ZX0iKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIGpvYiBjaG8gYXBwIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjaGVjayBhY2NvdW50IGNhbiBydW4gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHdvcmsoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgTWFpbiB3b3JrIGxvb3AgduG7m2kgbG9naWMgY2h1eeG7g24gYWNjb3VudCB0aMO0bmcgbWluaAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBi4bqvdCDEkeG6p3UgaG/huqF0IMSR4buZbmcgduG7m2kgbG9naWMgc2Vzc2lvbiBtYW5hZ2VtZW50IikKICAgICAgICAKICAgICAgICBjdXJyZW50X2FjY291bnQgPSBOb25lCiAgICAgICAgd29ya19zdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGFjY291bnQgxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnQgb3Igc2VsZi5fc2hvdWxkX3N3aXRjaF9hY2NvdW50KGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikpOgogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXQgbmdo4buJIG5nxqFpIGNobyBhY2NvdW50IGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIExvZyBsw70gZG8gY2h1eeG7g24KICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oY3VycmVudF9hY2NvdW50LmdldCgiaWQiKSkKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoX3JlYXNvbiA9IHNlbGYuX2dldF9zd2l0Y2hfcmVhc29uKGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIiksIHNlc3Npb24pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gdOG7qyBhY2NvdW50IHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0uIEzDvSBkbzoge3N3aXRjaF9yZWFzb259IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuX2dldF9uZXh0X2F2YWlsYWJsZV9hY2NvdW50KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyBhY2NvdW50IGto4bqjIGThu6VuZywgY2jhu50gNjBzLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgIkNo4budIGFjY291bnQga2jhuqMgZOG7pW5nLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDYwKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBjaG8gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBjdXJyZW50X2FjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBzZXNzaW9uIG3hu5tpIHbhu5tpIGFjY291bnQge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgYWNjb3VudCBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoY3VycmVudF9hY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gZOG7q25nIChu4bq/dSBj4bqnbikKICAgICAgICAgICAgICAgIHdvcmtfZHVyYXRpb24gPSB0aW1lLnRpbWUoKSAtIHdvcmtfc3RhcnRfdGltZQogICAgICAgICAgICAgICAgaWYgd29ya19kdXJhdGlvbiA+IDg2NDAwOiAgIyAyNCBnaeG7nQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGzDoG0gdmnhu4djIDI0IGdp4budLCBuZ2jhu4kgbmfGoWkuLi4iKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiB0w61uIGhp4buHdSBk4burbmcgdOG7qyBuZ8aw4budaSBkw7luZyIpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyB3b3JrIGxvb3A6IHtlfSIpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMzApICAjIE5naOG7iSAzMHMga2hpIGPDsyBs4buXaQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBr4bq/dCB0aMO6YyBob+G6oXQgxJHhu5luZyIpCg==').decode('utf-8'))
