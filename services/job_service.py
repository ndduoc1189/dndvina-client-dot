import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19TRVNTSU9OID0gIsSQYW5nIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYyIKICAgIE1TR19TRVNTSU9OX0NPT0xET1dOID0gIk5naOG7iSBuZ8ahaSBnaeG7r2EgY8OhYyBwaGnDqm4iCiAgICAKICAgICMgQWNjb3VudCBzdGF0dXMgcmVhc29ucwogICAgUkVBU09OX0RBSUxZX0xJTUlUID0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiCiAgICBSRUFTT05fU0VTU0lPTl9MSU1JVCA9ICLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIHBoacOqbiIKICAgIFJFQVNPTl9GT0xMT1dfU0VTU0lPTl9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbGxvdyB0cm9uZyBwaGnDqm4iCgpjbGFzcyBKb2JTZXJ2aWNlOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSwgbXF0dF9zZXJ2aWNlPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGJfc2VydmljZTogRGF0YWJhc2VTZXJ2aWNlIMSR4buDIGzGsHUgdHLhu68gZOG7ryBsaeG7h3UKICAgICAgICAgICAgaGVscGVyX3NlcnZpY2U6IEhlbHBlclNlcnZpY2UgxJHhu4MgdMawxqFuZyB0w6FjIHbhu5tpIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBnb2xpa2Vfc2VydmljZTogR29MaWtlU2VydmljZSDEkeG7gyBn4buNaSBBUEkgR29MaWtlCiAgICAgICAgICAgIG1xdHRfc2VydmljZTogTVFUVFNlcnZpY2UgxJHhu4MgZ+G7rWkgdGjDtG5nIGLDoW8gKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHNlbGYuZGIgPSBkYl9zZXJ2aWNlCiAgICAgICAgc2VsZi5oZWxwZXIgPSBoZWxwZXJfc2VydmljZQogICAgICAgIHNlbGYuZ29saWtlX3NlcnZpY2UgPSBnb2xpa2Vfc2VydmljZQogICAgICAgIHNlbGYubXF0dF9zZXJ2aWNlID0gbXF0dF9zZXJ2aWNlCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlcgogICAgICAgIHNlbGYuam9iX2hhbmRsZXJzID0ge30KICAgICAgICAKICAgICAgICAjIEZsYWcgxJFp4buBdSBraGnhu4NuCiAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBUaMO0bmcgdGluIHbhu4EgY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0IC0gbOG6pXkgdOG7qyBkYXRhYmFzZSBob+G6t2MgY29uZmlnCiAgICAgICAgc2VsZi5lbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICAjIExvY2sgxJHhu4MgxJHhu5NuZyBi4buZIHRy4bqhbmcgdGjDoWkKICAgICAgICBzZWxmLl9sb2NrID0gdGhyZWFkaW5nLkxvY2soKQogICAgICAgIAogICAgICAgICMgRGljdGlvbmFyeSDEkeG7gyBsxrB1IHPhu5EgbOG6p24gdGjhu60gam9iIHRo4bqldCBi4bqhaSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHMgPSB7fQogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gbGnDqm4gdGnhur9wIGpvYiBmb2xsb3cgdHLhuqMgduG7gSBzdGF0dXMgNCAocGVuZGluZykKICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyBUcuG6oW5nIHRow6FpIHByb3h5IGhp4buHbiB04bqhaQogICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9pZCA9IE5vbmUKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IE5vbmUKICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSAwCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlID0gTm9uZSAgIyBUYWJsZSBuYW1lIMSRxrDhu6NjIGPhuqVwIHThu6sgcHJveHkgc2VydmVyCiAgICAgICAgc2VsZi5wcm94eV9sYXN0X3VwZGF0ZSA9IDAgICMgVGjhu51pIGdpYW4gdXBkYXRlIGN14buRaSBjw7luZwogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gdGjhuqV0IGLhuqFpIGtoaSBzZXR1cCBwcm94eQogICAgICAgIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFjDs2EgcHJveHkgdGFibGUgbmFtZSBjxakga2jhu49pIGRldmljZSBjb25maWcga2hpIGto4bufaSB04bqhbwogICAgICAgIHNlbGYuZGIuc2V0X2RldmljZV9jb25maWcoInByb3h5X3RhYmxlX25hbWUiLCBOb25lKQogICAgICAgIAogICAgZGVmIHNhZmVfc2xlZXAoc2VsZiwgc2Vjb25kczogZmxvYXQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTmfhu6cgYW4gdG/DoG4sIGPDsyB0aOG7gyBk4burbmcgbOG6oWkgbmdheSBs4bqtcCB04bupYyBraGkgZm9yY2Vfc3RvcCDEkcaw4bujYyDEkeG6t3QgdGjDoG5oIFRydWUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBzZWNvbmRzOiBT4buRIGdpw6J5IGPhuqduIG5n4bunCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugbmfhu6cgxJHhu6cgdGjhu51pIGdpYW4sIEZhbHNlIG7hur91IGLhu4sgZOG7q25nIGzhuqFpCiAgICAgICAgIiIiCiAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgY2hlY2tfaW50ZXJ2YWwgPSBKb2JTZXJ2aWNlQ29uc3RhbnRzLkRFRkFVTFRfQ0hFQ0tfSU5URVJWQUwgICMgS2nhu4NtIHRyYSBt4buXaSAwLjUgZ2nDonkKICAgICAgICAKICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUgPCBzZWNvbmRzOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgY8OzIHnDqnUgY+G6p3UgZOG7q25nCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBOZ+G7pyBt4buZdCBraG/huqNuZyBuZ+G6r24KICAgICAgICAgICAgc2xlZXBfdGltZSA9IG1pbihjaGVja19pbnRlcnZhbCwgc2Vjb25kcyAtICh0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUpKQogICAgICAgICAgICBpZiBzbGVlcF90aW1lID4gMDoKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2xlZXBfdGltZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIGluaXRpYWxpemUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIHThuqFvIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLi4uIikKICAgICAgICAKICAgICAgICAjIDEuIEtp4buDbSB0cmEgSGVscGVyU2VydmljZQogICAgICAgIGhlbHBlcl9zdWNjZXNzLCBoZWxwZXJfZGF0YSA9IHV0aWxzLmNoZWNrX2hlbHBlcl9zZXJ2aWNlKHNlbGYuaGVscGVyKQogICAgICAgIGlmIG5vdCBoZWxwZXJfc3VjY2VzczoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga+G6v3QgbuG7kWkgxJHhur9uIEhlbHBlclNlcnZpY2UuIFZ1aSBsw7JuZyBraeG7g20gdHJhIGzhuqFpLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4sgbuG6v3UgY8OzCiAgICAgICAgaWYgaGVscGVyX2RhdGEgYW5kICJkYXRhIiBpbiBoZWxwZXJfZGF0YToKICAgICAgICAgICAgc2VsZi5kYi5zYXZlX2RldmljZV9pbmZvKGhlbHBlcl9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgbMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7izoge2hlbHBlcl9kYXRhWydkYXRhJ10uZ2V0KCdkZXZpY2VfbW9kZWwnLCAnVW5rbm93bicpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAjIDMuIEzGsHUgY8OhYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgc2VsZi5fc2F2ZV9kZWZhdWx0X2NvbmZpZ3MoKQogICAgICAgICAgICAKICAgICAgICAjIDQuIEtp4buDbSB0cmEgdsOgIGzhuqV5IEdvTGlrZSBoZWFkZXJzIG7hur91IGPhuqduCiAgICAgICAgZ29saWtlX3N1Y2Nlc3MgPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLmZldGNoX2dvbGlrZV9oZWFkZXJzX3dpdGhfcmV0cnkoKQogICAgICAgIGlmIG5vdCBnb2xpa2Vfc3VjY2VzczoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgbOG6pXkgR29MaWtlIGhlYWRlcnMuIFZ1aSBsw7JuZyBraeG7g20gdHJhIGzhuqFpLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgNS4gS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLl9pbml0X2pvYl9oYW5kbGVycygpCiAgICAgICAgCiAgICAgICAgIyA2LiBLaOG7n2kgdOG6oW8gbmfDoHkgY3Xhu5FpIGPDuW5nIMSRw6MgcmVzZXQgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICAKICAgICAgICBpZiBub3QgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgIyBO4bq/dSBoaeG7h24gdOG6oWkgxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXksIMSRw6FuaCBk4bqldSDEkcOjIHJlc2V0CiAgICAgICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lOgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gdG9kYXkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTuG6v3UgY2jGsGEgxJHhur9uIGdp4budIHJlc2V0LCDEkcOhbmggZOG6pXUgbMOgIMSRw6MgcmVzZXQgbmfDoHkgaMO0bSBxdWEKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5IC0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgbGFzdF9yZXNldF9kYXRlLmlzb2Zvcm1hdCgpKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkto4bufaSB04bqhbyBuZ8OgeSByZXNldDoge2xhc3RfcmVzZXRfZGF0ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmc6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgCiAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IFRydWUKICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIEpvYlNlcnZpY2UgdGjDoG5oIGPDtG5nLiIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6p24gxJHhu5NuZyBi4buZIGzhuqFpLCBGYWxzZSBu4bq/dSBraMO0bmcgY+G6p24KICAgICAgICAiIiIKICAgICAgICAjIEzhuqV5IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgZGF0YWJhc2UKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgc3luY19zdGF0dXMgPSBzZWxmLmRiLmdldChzeW5jX3N0YXR1c19rZXksIEZhbHNlKSAgIyBN4bq3YyDEkeG7i25oIGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICAjIE7hur91IGNoxrBhIMSR4buTbmcgYuG7mSB0aMOsIGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaQogICAgICAgIHJldHVybiBub3Qgc3luY19zdGF0dXMKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgc3RhdHVzOiBib29sID0gVHJ1ZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgc3RhdHVzOiBUcnVlIG7hur91IMSRw6MgxJHhu5NuZyBi4buZLCBGYWxzZSBu4bq/dSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAiIiIKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICBzZWxmLmRiLnNldChzeW5jX3N0YXR1c19rZXksIHN0YXR1cykKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiB7c3RhdHVzfSIpCiAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudHNfZm9yX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCB0w6BpIGtob+G6o24gR29MaWtlIGNobyBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiDEkeG7k25nIGLhu5kKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkeG7k25nIGLhu5kgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKCiAgICAgICAgICAgICMgMS4gxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4buTbmcgYuG7mSB7bGVuKGFjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBUcnVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIEZhbHNlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MiIiIKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gdGjhu51pIGdpYW4gbMOgbSBqb2IKICAgICAgICAgICAgImpvYl9ob3VyIjogY29uZmlnLkpPQl9IT1VSLAogICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIFRo4budaSBnaWFuIGNo4budIChwaMO6dCkga2hpIGtow7RuZyB0w6xtIHRo4bqleSBqb2IgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLhuqFuZyB0aMOhaSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgInBhdXNlX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdGhp4bq/dCBi4buLIMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICJkZXZpY2VfaXNfd29ya2luZyI6IEZhbHNlLAogICAgICAgICAgICAiZGV2aWNlX21lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRGFuaCBzw6FjaCBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQKICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IGNvbmZpZy5FTkFCTEVEX0FQUFMsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRoaeG6v3QgbOG6rXAgY2hvIHBow6lwIGNoxINtIHPDs2Mga2hpIGzDoG0gam9iCiAgICAgICAgICAgICJjYXJlX2luX3dvcmtpbmdfam9iIjogRmFsc2UsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGdpw6EgdOG7kWkgdGhp4buDdSBjaG8gam9iIGZvbGxvdwogICAgICAgICAgICAibWluX2ZvbGxvd19wcmljZSI6IDIwLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBwcm94eQogICAgICAgICAgICAidXNlX3Byb3h5IjogRmFsc2UsICAjIEPDsyBz4butIGThu6VuZyBwcm94eSBraMO0bmcKICAgICAgICAgICAgInByb3h5X3NlcnZlciI6ICJodHRwOi8vMTAuMC4wLjU6OTAzMiIsICAjIFNlcnZlciBwcm94eSBt4bq3YyDEkeG7i25oCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRlZmF1bHRfY29uZmlncy5pdGVtcygpOgogICAgICAgICAgICAjIENo4buJIGzGsHUgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KGtleSkgaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOjIGzGsHUgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaDoge2tleX09e3ZhbHVlfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJD4bqldSBow6xuaCB7a2V5fSDEkcOjIHThu5NuIHThuqFpOiB7c2VsZi5kYi5nZXQoa2V5KX0iKQogICAgICAgIAogICAgZGVmIF9pbml0X2pvYl9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlciIiIgogICAgICAgICMgaW5pdCB0aMOsIHPhur0gaW5pdCBoYW5kbGVycyBjaG8gdOG6pXQgY+G6oyBjw6FjIGFwcCwgbMOgbSBhcHAgbsOgbyB0aMOsIHPhur0gdGhlbyBj4bqldSBow6xuaCBs4bqleSB04burIGRhdGFiYXNlCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGNvbmZpZy5FTkFCTEVEX0FQUFM6CiAgICAgICAgICAgIGlmIGFwcF9uYW1lID09ICJ0aWt0b2siOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAiaW5zdGFncmFtIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IEluc3RhZ3JhbUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mga2jhu59pIHThuqFvIHtsZW4oc2VsZi5qb2JfaGFuZGxlcnMpfSBqb2IgaGFuZGxlcjogeycsICcuam9pbihzZWxmLmpvYl9oYW5kbGVycy5rZXlzKCkpfSIpCiAgICAgICAgCiAgICBkZWYgX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKHNlbGYpOgogICAgICAgICIiIlJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IHbDoG8gZ2nhu50gxJHGsOG7o2MgY+G6pXUgaMOsbmgiIiIKICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIHRvZGF5ID0gbm93LmRhdGUoKQogICAgICAgIAogICAgICAgICMgTOG6pXkgZ2nhu50gcmVzZXQgdOG7qyBj4bqldSBow6xuaCBob+G6t2MgdOG7qyBkYXRhYmFzZSBu4bq/dSBjw7MKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICAKICAgICAgICAjIFTDrW5oIHRo4budaSDEkWnhu4NtIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5CiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gTm9uZQogICAgICAgIAogICAgICAgIGlmIGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IGRhdGV0aW1lLmRhdGUuZnJvbWlzb2Zvcm1hdChsYXN0X3Jlc2V0X2RhdGVfc3RyKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIsSQ4buLbmggZOG6oW5nIG5nw6B5IHJlc2V0IGtow7RuZyBo4bujcCBs4buHOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gTm9uZQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkgY2jGsGEgdsOgIGNoxrBhIHJlc2V0IHRyb25nIG5nw6B5IGjDtG0gbmF5CiAgICAgICAgaWYgbm93ID49IHJlc2V0X3RpbWUgYW5kIChsYXN0X3Jlc2V0X2RhdGUgaXMgTm9uZSBvciBsYXN0X3Jlc2V0X2RhdGUgPCB0b2RheSk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiByZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSAoZ2nhu50gcmVzZXQ6IHtqb2JfaG91cn06MDApIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgY8OhYyBi4buZIMSR4bq/bSBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24KICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgc+G7kSBqb2IgaMO0bSBuYXkgdsOgIHPhu5Egam9iIHRyb25nIHBoacOqbgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAiam9iX3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd190b2RheSI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3ZpZXdfc3RvcmllcyI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB2w6wgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSwKICAgICAgICAgICAgICAgICAgICAjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIHRow6BuaCBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgic3RhdHVzIikgPT0gImluYWN0aXZlIiBhbmQgYWNjb3VudC5nZXQoImluYWN0aXZlX3JlYXNvbiIpID09ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgYWN0aXZlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyByZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gdsOgbyB7bm93LnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBuZ8OgeSDEkcOjIHJlc2V0IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIHRvZGF5Lmlzb2Zvcm1hdCgpKQogICAgICAgIAogICAgZGVmIF9jYW5fcnVuX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdGjhu4MgY2jhuqF5IGpvYiBjaG8gdMOgaSBraG/huqNuIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGNo4bqheSBqb2IsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIDEuIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24KICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfYmFzaWNfYWNjb3VudF9zdGF0dXMoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDIuIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gY+G6p24gdGhp4bq/dAogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDMuIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiDEkcaw4bujYyB0aGnhur90IGzhuq1wCiAgICAgICAgYWNjb3VudCA9IHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIDQuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeQogICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfYXRfZGFpbHlfbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyA1LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgcGhpw6puCiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9zZXNzaW9uX2xpbWl0KGFjY291bnQpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgbMOgbSDEkeG7pyBqb2IgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249IsSQw6MgaG/DoG4gdGjDoG5oIHPhu5Egam9iIHThu5FpIMSRYSB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYmFzaWNfYWNjb3VudF9zdGF0dXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbiBj4bunYSB0w6BpIGtob+G6o24iIiIKICAgICAgICBhY2NvdW50X3N0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiBi4buLIGRpc2FibGVkLCBraMO0bmcgY2hvIGNo4bqheSBqb2IKICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiZGlzYWJsZWQiOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJFhbmcgaW5hY3RpdmUsIGtp4buDbSB0cmEgdGjhu51pIGdpYW4gY29vbGRvd24KICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICByZXR1cm4gc2VsZi5faGFuZGxlX2luYWN0aXZlX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2luYWN0aXZlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiWOG7rSBsw70gdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIiIiCiAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY29vbGRvd24sIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHbhu4EgYWN0aXZlCiAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPD0gdGltZS50aW1lKCk6CiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiAwLAogICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogRmFsc2UsCiAgICAgICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiAiIgogICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCDEkcOjIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgQ2jGsGEgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgY29vbGRvd25fcmVtYWluID0gaW50KChqb2JfZGlzYWJsZV91bnRpbCAtIHRpbWUudGltZSgpKSAvIDYwKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budIChjw7JuIHtjb29sZG93bl9yZW1haW59IHBow7p0KSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9wcmVyZXF1aXNpdGVzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIktp4buDbSB0cmEgY8OhYyDEkWnhu4F1IGtp4buHbiB0acOqbiBxdXnhur90IGPhu6dhIHTDoGkga2hv4bqjbiIiIgogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkcaw4bujYyBi4bqtdCBqb2Iga2jDtG5nCiAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJqb2JfZW5hYmxlIiwgRmFsc2UpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBsacOqbiBr4bq/dCB24bubaSBHb0xpa2UgY2jGsGEKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gY+G7p2EgdMOgaSBraG/huqNuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAgduG7m2kgZ2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2MgY+G6rXAgbmjhuq10CiAgICAgICAgIiIiCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7fQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgdGhp4bq/dCBs4bqtcCBtYXhfam9ic19wZXJfc2Vzc2lvbgogICAgICAgIGlmIGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIDw9IDA6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdID0gY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgdGhp4bq/dCBs4bqtcCBqb2JfbWF4X2RheQogICAgICAgIGlmIGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIDw9IDA6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJqb2JfbWF4X2RheSJdID0gY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdsOgbyBkYXRhYmFzZSBu4bq/dSBjw7MgdGhheSDEkeG7lWkKICAgICAgICBpZiB1cGRhdGVfZGF0YToKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfZm9yX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB0xrDGoW5nIOG7qW5nIHbhu5tpIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gY29uZmlnLkFQUF9QQUNLQUdFUzoKICAgICAgICAgICAgc2VsZi5oZWxwZXIuY2xvc2VfYXBwKGNvbmZpZy5BUFBfUEFDS0FHRVNbYXBwX25hbWVdKQogICAgICAgICAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuCiAgICAgICAgIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9iX21heF9kYXkgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgIHJldHVybiBqb2JfdG9kYXkgPj0gam9iX21heF9kYXkKICAgICAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9hdF9zZXNzaW9uX2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgcGhpw6puIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuCiAgICAgICAgIiIiCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgcmV0dXJuIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wgPSBUcnVlLCBqb2JfdHlwZTogc3RyID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIHN1Y2Nlc3M6IFRydWUgbuG6v3Ugam9iIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iIChmb2xsb3csIGxpa2UsIGV0Yy4pCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gam9iIGPGoSBi4bqjbgogICAgICAgIHNlbGYuX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoYWNjb3VudCwgc3VjY2VzcykKICAgICAgICAKICAgICAgICAjIFJlc2V0IHPhu5EgbOG6p24gdGjhu60gam9iIHRo4bqldCBi4bqhaSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZ2nhu5tpIGjhuqFuIHBoacOqbgogICAgICAgIHNlbGYuX2NoZWNrX3Nlc3Npb25fbGltaXRfYWZ0ZXJfam9iKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB44butIGzDvSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkKICAgICAgICBzZWxmLl9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2IoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IHRo4buRbmcga8OqIHJpw6puZyBjaG8gam9iIGZvbGxvdwogICAgICAgIGlmIHN1Y2Nlc3MgYW5kIGpvYl90eXBlIGFuZCBqb2JfdHlwZS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICBzZWxmLl91cGRhdGVfZm9sbG93X3N0YXRzKGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfYmFzaWNfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iIGPGoSBi4bqjbiAtIGNo4buJIMSR4bq/bSBqb2IgdGjDoG5oIGPDtG5nIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIAogICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgIyBDaOG7iSB0xINuZyBjb3VudGVycyBraGkgam9iIHRow6BuaCBjw7RuZwogICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhLnVwZGF0ZSh7CiAgICAgICAgICAgICAgICAiam9iX3RvZGF5Ijogam9iX3RvZGF5ICsgMSwKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMSwKICAgICAgICAgICAgICAgICJ0b3RhbF9qb2JzIjogYWNjb3VudC5nZXQoInRvdGFsX2pvYnMiLCAwKSArIDEKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICBhY2NvdW50LnVwZGF0ZSh1cGRhdGVfZGF0YSkgICMgQ+G6rXAgbmjhuq10IGxvY2FsIGRhdGEKICAgICAgICAKICAgIGRlZiBfY2hlY2tfc2Vzc2lvbl9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIHBoacOqbiBzYXUga2hpIGzDoG0gam9iIiIiCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgbMOgbSDEkeG7pyB7bWF4X2pvYnNfcGVyX3Nlc3Npb259IGpvYiB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0ixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfY2hlY2tfZGFpbHlfbGltaXRfYWZ0ZXJfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiJLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeSBzYXUga2hpIGzDoG0gam9iIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9iX21heF9kYXkgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICBpZiBqb2JfdG9kYXkgPj0gam9iX21heF9kYXk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBuZ8OgeSAoe2pvYl90b2RheX0ve2pvYl9tYXhfZGF5fSkiKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoYWNjb3VudFsiaWQiXSwgIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiKQogICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9mb2xsb3dfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiByacOqbmcgY2hvIGZvbGxvdyBqb2IgdGjDoG5oIGPDtG5nICjEkcOjIGLhu48gZ2nhu5tpIGjhuqFuIGZvbGxvdykiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgZm9sbG93X3RvZGF5ID0gYWNjb3VudC5nZXQoImZvbGxvd190b2RheSIsIDApICsgMQogICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkgKyAxCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgc+G7kSBsaeG7h3UgZm9sbG93IHRow6BuaCBjw7RuZwogICAgICAgIHVwZGF0ZV9mb2xsb3cgPSB7CiAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiBmb2xsb3dfdG9kYXksCiAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGZvbGxvd19pbl9zZXNzaW9uLAogICAgICAgICAgICAibGFzdF9mb2xsb3dfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLCAgIyBMdcO0biBsdcO0biDEkeG7gyBGYWxzZSB2w6wgxJHDoyBi4buPIGdp4bubaSBo4bqhbgogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfQogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2ZvbGxvdykKICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgdGjhu7FjIGhp4buHbiBmb2xsb3cgdGjDoG5oIGPDtG5nICh7Zm9sbG93X3RvZGF5fSBmb2xsb3cgaMO0bSBuYXkpIikKICAgICAgICAKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIHRyb25nIHRocmVhZCByacOqbmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkOiBUaHJlYWQgxJFhbmcgY2jhuqF5IEpvYlNlcnZpY2UgaG/hurdjIE5vbmUgbuG6v3UgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IHRy4bqhbmcgdGjDoWkgcnVubmluZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHRocmVhZAogICAgICAgICAgICB0aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLnJ1bikKICAgICAgICAgICAgdGhyZWFkLmRhZW1vbiA9IFRydWUKICAgICAgICAgICAgdGhyZWFkLnN0YXJ0KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0aHJlYWQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgcmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJpbmFjdGl2ZSIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGluYWN0aXZlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgeyJzdGF0dXMiOiAiYWN0aXZlIiwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IChJRDoge2FjY291bnRbJ2lkJ119KSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCDEkcOjIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChqb2JfZGlzYWJsZV91bnRpbCAtIGN1cnJlbnRfdGltZSkgLyA2MCkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGPDsm4ge3JlbWFpbmluZ19taW51dGVzfSBwaMO6dCDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSIpCiAgICAKICAgIGRlZiBpc19hY2NvdW50X2Nhbl9ydW5fam9iKHNlbGYsIGFwcF9uYW1lOnN0ciApIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBjaOG6oXkgam9iIGtow7RuZwogICAgICAgICIiIgogICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICBpZihzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENo4bqheSBKb2JTZXJ2aWNlIHRyb25nIG3hu5l0IHbDsm5nIGzhurdwIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHRoZW8gcGhpw6puCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBKb2JTZXJ2aWNlIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHRoZW8gcGhpw6puLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgeMOhYyDEkeG7i25oIGRldmljZV9pZCBoaeG7h24gdOG6oWksIEpvYlNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICB3aGlsZSBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICMgUmVzZXQgYmnhur9uIGZvcmNlX3N0b3AgbuG6v3UgY8OzCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIsIHThuqFtIGThu6tuZyB44butIGzDvSBqb2IiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG5nYXkga2hpIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3JlZ2lzdGVyZWQnKSBhbmQgc2VsZi5wcm94eV9yZWdpc3RlcmVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX1BBVVNFRF9TRVJWRVIpCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldCgiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBzZWxmLnJlc2V0X2luYWN0aXZlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIG5naOG7iSBnaeG7r2EgY8OhYyBwaGnDqm4ga2jDtG5nCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9pc19pbl9zZXNzaW9uX2Nvb2xkb3duKCk6CiAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nX21pbnV0ZXMgPSBpbnQoKHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSAtIGludCh0aW1lLnRpbWUoKSkpIC8gNjApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJ7Sm9iU2VydmljZUNvbnN0YW50cy5NU0dfU0VTU0lPTl9DT09MRE9XTn0gKGPDsm4ge3JlbWFpbmluZ19taW51dGVzfSBwaMO6dCkiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNjApOiAgIyBLaeG7g20gdHJhIG3hu5dpIHBow7p0CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHRyxrDhu5tjIHRpw6puCiAgICAgICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnMgYW5kIHNlbGYuX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRzX2Zvcl9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIChzYXUga2hpIMSRw6MgxJHhu5NuZyBi4buZKQogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBhbGxfd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBu4bq/dSDEkWFuZyBz4butIGThu6VuZwogICAgICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3JlZ2lzdGVyZWQnKSBhbmQgc2VsZi5wcm94eV9yZWdpc3RlcmVkOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBC4bqvdCDEkeG6p3Ugc2Vzc2lvbiBjb29sZG93biB0aGF5IHbDrCBzbGVlcCBuZ+G6r24KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MsIGLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkgbmjGsCBzYXUgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buJIGzhuqV5IHByb3h5IGtoaSDEkcOjIGNo4bqvYyBjaOG6r24gY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX3Byb3h5X3JlcXVpcmVtZW50KCk6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgY8OzLCBjaOG7nSAxMCBnacOieSBy4buTaSBraeG7g20gdHJhIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfV0FJVElOR19QUk9YWSkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELhuq90IMSR4bqndSBwaGnDqm4gbMOgbSB2aeG7h2MgduG7m2kgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyBz4bq1biBzw6BuZwogICAgICAgICAgICAgICAgc2VsZi5fd29ya19zZXNzaW9uKGFsbF93b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IHbDoCBi4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVsZWFzZV9wcm94eV9hZnRlcl9zZXNzaW9uKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXJ0X3Nlc3Npb25fY29vbGRvd24oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCIpCiAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJKb2JTZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgICAgICAgICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgSm9iU2VydmljZSIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgZGVmIGZvcmNlX3N0b3BfYWxsKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZyIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiLEkMOzbmcgZOG7i2NoIHbhu6UsIGThu6tuZyB04bqldCBj4bqjIHdvcmtlciB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGThu6tuZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdp4bqjaSBwaMOzbmcgcHJveHkgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV90YWJsZToKICAgICAgICAgICAgICAgIHNlbGYuX3JlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSDEkeG7gyB0csOhbmggbOG7l2kgdGhyZWFkCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2RiJykgYW5kIHNlbGYuZGI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBzaHV0ZG93biBKb2JTZXJ2aWNlIikKICAgIAogICAgZGVmIF9wcm94eV9hcGlfY2FsbChzZWxmLCBlbmRwb2ludDogc3RyLCBkYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEfhu41pIEFQSSBwcm94eSBzZXJ2ZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBlbmRwb2ludDogRW5kcG9pbnQgQVBJIChyZWdpc3RlciwgdXBkYXRlLCB1bnJlZ2lzdGVyLCByZXNldC1pcCkKICAgICAgICAgICAgZGF0YTogROG7ryBsaeG7h3UgZ+G7rWkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCByZXNwb25zZSBob+G6t2MgTm9uZSBu4bq/dSBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHJlcXVlc3RzCiAgICAgICAgICAgIAogICAgICAgICAgICBwcm94eV9zZXJ2ZXIgPSBzZWxmLmRiLmdldCgicHJveHlfc2VydmVyIiwgImh0dHA6Ly8xMC4wLjAuNTo5MDMyIikKICAgICAgICAgICAgdXJsID0gZiJ7cHJveHlfc2VydmVyfS97ZW5kcG9pbnR9IgogICAgICAgICAgICAKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1kYXRhLCB0aW1lb3V0PTEwKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiUHJveHkgQVBJIHtlbmRwb2ludH0gZmFpbGVkIHdpdGggc3RhdHVzIHtyZXNwb25zZS5zdGF0dXNfY29kZX06IHtyZXNwb25zZS50ZXh0fSIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7jWkgUHJveHkgQVBJIHtlbmRwb2ludH06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBfcmVnaXN0ZXJfcHJveHkoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkMSDbmcga8O9IHbhu5tpIHByb3h5IHNlcnZlciDEkeG7gyDEkcaw4bujYyBj4bqlcCBwaMOhdCB0YWJsZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHGsOG7o2MgY+G6pXAgdGFibGUgaG/hurdjIMSRw6MgY8OzIHRhYmxlLCBGYWxzZSBu4bq/dSB2w6BvIHF1ZXVlIGhv4bq3YyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBsb2NhbCBJUCB04burIGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGxvY2FsX2lwID0gc2VsZi5oZWxwZXIuZ2V0X2xvY2FsX2lwKCkKICAgICAgICAgICAgaWYgbm90IGxvY2FsX2lwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgbOG6pXkgbG9jYWwgSVAsIGLhu48gcXVhIMSRxINuZyBrw70gcHJveHkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBkYXRhID0geyJsb2NhbF9pcCI6IGxvY2FsX2lwfQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuX3Byb3h5X2FwaV9jYWxsKCJyZWdpc3RlciIsIGRhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgcmVzcG9uc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzdGF0dXMgPSByZXNwb25zZS5nZXQoInN0YXR1cyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdGF0dXMgPT0gInN1Y2Nlc3MiOgogICAgICAgICAgICAgICAgIyDEkMaw4bujYyBj4bqlcCB0YWJsZSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHRhYmxlX25hbWUgPSByZXNwb25zZS5nZXQoImRhdGEiLCB7fSkuZ2V0KCJ0YWJsZV9uYW1lIikKICAgICAgICAgICAgICAgIGFjdGlvbiA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIHt9KS5nZXQoImFjdGlvbiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV90YWJsZSA9IHRhYmxlX25hbWUKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9uYW1lID0gZiJ7dGFibGVfbmFtZX0iCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSBwcm94eSB0YWJsZSBuYW1lIHbDoG8gZGV2aWNlIGNvbmZpZyDEkeG7gyBn4butaSBsw6puIHNlcnZlcgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfZGV2aWNlX2NvbmZpZygicHJveHlfdGFibGVfbmFtZSIsIHRhYmxlX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUHJveHkgxJHDoyDEkcaw4bujYyBj4bqlcCB0YWJsZToge3RhYmxlX25hbWV9IChhY3Rpb246IHthY3Rpb259KSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR+G7jWkgcmVzZXQtaXAgxJHhu4MgxJHhu5VpIElQIG3hu5tpCiAgICAgICAgICAgICAgICBpZiB0YWJsZV9uYW1lOgogICAgICAgICAgICAgICAgICAgIHBwb2VfbmFtZSA9IHRhYmxlX25hbWUucmVwbGFjZSgidG9fIiwgIiIpICAjIENodXnhu4NuICJ0b19wcHBvZTIiIHRow6BuaCAicHBwb2UyIgogICAgICAgICAgICAgICAgICAgIHJlc2V0X2RhdGEgPSB7InBwb2VfbmFtZSI6IGYie3Bwb2VfbmFtZX0ifSAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmVzZXRfcmVzcG9uc2UgPSBzZWxmLl9wcm94eV9hcGlfY2FsbCgicmVzZXQtaXAiLCByZXNldF9kYXRhKQogICAgICAgICAgICAgICAgICAgIGlmIHJlc2V0X3Jlc3BvbnNlIGFuZCByZXNldF9yZXNwb25zZS5nZXQoInN0YXR1cyIpID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IElQIGNobyB7cmVzZXRfZGF0YVsncHBvZV9uYW1lJ119IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyByZXNldCBJUCBjaG8ge3Jlc2V0X2RhdGFbJ3Bwb2VfbmFtZSddfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiBzdGF0dXMgPT0gInF1ZXVlZCI6CiAgICAgICAgICAgICAgICAjIFbDoG8gcXVldWUgY2jhu50KICAgICAgICAgICAgICAgIHF1ZXVlX3Bvc2l0aW9uID0gcmVzcG9uc2UuZ2V0KCJkYXRhIiwge30pLmdldCgicXVldWVfcG9zaXRpb24iLCAwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm94eSBzZXJ2ZXIgZnVsbCwgdsOgbyBow6BuZyDEkeG7o2kgduG7iyB0csOtIHtxdWV1ZV9wb3NpdGlvbn0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIlByb3h5IHJlZ2lzdGVyIHRo4bqldCBi4bqhaToge3Jlc3BvbnNlLmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgxJHEg25nIGvDvSBwcm94eSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3VwZGF0ZV9wcm94eShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aW1lc3RhbXAgc+G7rSBk4bulbmcgcHJveHkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHVwZGF0ZSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgbG9jYWwgSVAgdOG7qyBoZWxwZXIgc2VydmljZQogICAgICAgICAgICBsb2NhbF9pcCA9IHNlbGYuaGVscGVyLmdldF9sb2NhbF9pcCgpCiAgICAgICAgICAgIGlmIG5vdCBsb2NhbF9pcDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbOG6pXkgbG9jYWwgSVAsIGLhu48gcXVhIHVwZGF0ZSBwcm94eSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGRhdGEgPSB7ImxvY2FsX2lwIjogbG9jYWxfaXB9CiAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5fcHJveHlfYXBpX2NhbGwoInVwZGF0ZSIsIGRhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdGF0dXMiKSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X2xhc3RfdXBkYXRlID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgICMgTG9nIHRow7RuZyB0aW4gdOG7qyByZXNwb25zZSBu4bq/dSBjw7MKICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgICAgIHRhYmxlX25hbWUgPSBkYXRhLmdldCgidGFibGVfbmFtZSIsICJ1bmtub3duIikKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlByb3h5IHVwZGF0ZSB0aMOgbmggY8O0bmcgY2hvIHRhYmxlOiB7dGFibGVfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUHJveHkgdXBkYXRlIHRo4bqldCBi4bqhaToge3Jlc3BvbnNlLmdldCgnbWVzc2FnZScpIGlmIHJlc3BvbnNlIGVsc2UgJ05vIHJlc3BvbnNlJ30iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHVwZGF0ZSBwcm94eToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfdW5yZWdpc3Rlcl9wcm94eShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEjhu6d5IMSRxINuZyBrw70gdsOgIGdp4bqjaSBwaMOzbmcgdGFibGUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHVucmVnaXN0ZXIgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGxvY2FsIElQIHThu6sgaGVscGVyIHNlcnZpY2UKICAgICAgICAgICAgbG9jYWxfaXAgPSBzZWxmLmhlbHBlci5nZXRfbG9jYWxfaXAoKQogICAgICAgICAgICBpZiBub3QgbG9jYWxfaXA6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGzhuqV5IGxvY2FsIElQLCBi4buPIHF1YSB1bnJlZ2lzdGVyIHByb3h5IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgZGF0YSA9IHsibG9jYWxfaXAiOiBsb2NhbF9pcH0KICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLl9wcm94eV9hcGlfY2FsbCgidW5yZWdpc3RlciIsIGRhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdGF0dXMiKSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICByZWxlYXNlZF90YWJsZSA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIHt9KS5nZXQoInJlbGVhc2VkX3RhYmxlIikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB1bnJlZ2lzdGVyIHByb3h5IHbDoCBnaeG6o2kgcGjDs25nIHRhYmxlOiB7cmVsZWFzZWRfdGFibGV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGUgPSBOb25lCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfbGFzdF91cGRhdGUgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgWMOzYSBwcm94eSB0YWJsZSBuYW1lIGto4buPaSBkZXZpY2UgY29uZmlnCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9kZXZpY2VfY29uZmlnKCJwcm94eV90YWJsZV9uYW1lIiwgTm9uZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUHJveHkgdW5yZWdpc3RlciB0aOG6pXQgYuG6oWk6IHtyZXNwb25zZS5nZXQoJ21lc3NhZ2UnKSBpZiByZXNwb25zZSBlbHNlICdObyByZXNwb25zZSd9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB1bnJlZ2lzdGVyIHByb3h5OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jaGVja19wcm94eV9yZXF1aXJlbWVudChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIMSRxINuZyBrw70gcHJveHkgbuG6v3UgY+G6p24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyBwcm94eSBob+G6t2Mga2jDtG5nIGPhuqduIHByb3h5LCBGYWxzZSBu4bq/dSBj4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgxJHGsOG7o2MgY+G6pXAKICAgICAgICAiIiIKICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHVzZV9wcm94eToKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgS2jDtG5nIGPhuqduIHByb3h5CiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBjw7MgdGFibGUgdGjDrCByZXR1cm4gVHJ1ZQogICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV90YWJsZToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgIyBDaMawYSBjw7MgdGFibGUsIHRo4butIMSRxINuZyBrw70KICAgICAgICByZXR1cm4gc2VsZi5fcmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAKICAgIGRlZiBfZ2V0X3Byb3h5X2Rpc3BsYXlfbmFtZShzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdMOqbiBoaeG7g24gdGjhu4sgY2hvIHByb3h5IGhp4buHbiB04bqhaQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVMOqbiBoaeG7g24gdGjhu4sgY+G7p2EgcHJveHkKICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY3VycmVudF9wcm94eV9uYW1lCiAgICAgICAgZWxpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgIHJldHVybiBmIntzZWxmLmN1cnJlbnRfcHJveHlfdGFibGV9IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiAiVW5rbm93biIKICAgICAgICAgICAgCiAgICBkZWYgX3NldHVwX3Byb3h5X2Zvcl9zZXNzaW9uKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGhp4bq/dCBs4bqtcCBwcm94eSBjaG8gcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aGnhur90IGzhuq1wIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBO4bq/dSDEkcOjIGPDsyB0YWJsZSBwcm94eSB0aMOsIHNldHVwIHhvbmcgcuG7k2kKICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgIHByb3h5X25hbWUgPSBzZWxmLl9nZXRfcHJveHlfZGlzcGxheV9uYW1lKCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm94eSB7cHJveHlfbmFtZX0gxJHDoyBz4bq1biBzw6BuZyBjaG8gcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSBjw7MgdGjDrCDEkcSDbmcga8O9CiAgICAgICAgcmV0dXJuIHNlbGYuX3JlZ2lzdGVyX3Byb3h5KCkKICAgIGRlZiBfcmVsZWFzZV9wcm94eV9hZnRlcl9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIkdp4bqjaSBwaMOzbmcgcHJveHkgc2F1IGtoaSBr4bq/dCB0aMO6YyBwaGnDqm4gbMOgbSB2aeG7h2MiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV90YWJsZToKICAgICAgICAgICAgICAgIHByb3h5X25hbWUgPSBzZWxmLl9nZXRfcHJveHlfZGlzcGxheV9uYW1lKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgZ2nhuqNpIHBow7NuZyBwcm94eSB7cHJveHlfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu41pIEFQSSB1bnJlZ2lzdGVyCiAgICAgICAgICAgICAgICBpZiBzZWxmLl91bnJlZ2lzdGVyX3Byb3h5KCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGdp4bqjaSBwaMOzbmcgcHJveHkge3Byb3h5X25hbWV9IHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiR2nhuqNpIHBow7NuZyBwcm94eSB7cHJveHlfbmFtZX0gdGjhuqV0IGLhuqFpIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgZ2nhuqNpIHBow7NuZyBwcm94eSIpCiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgZ2nhuqNpIHBow7NuZyBwcm94eSB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWUgb3Igc2VsZi5jdXJyZW50X3Byb3h5X2lkIG9yICd1bmtub3duJ30iKQogICAgICAgICAgICAKICAgICMgREVQUkVDQVRFRDogS2jDtG5nIGTDuW5nIG7hu69hLCB0aGF5IGLhurFuZyBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAjIGRlZiBfaGFzX2FjY291bnRzX3JlYWR5X2Zvcl93b3JrKHNlbGYpIC0+IGJvb2w6CiAgICAjICAgICAiIiIKICAgICMgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcKICAgICMgICAgIAogICAgIyAgICAgUmV0dXJuczoKICAgICMgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAiIiIKICAgICMgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgIyAgICAgCiAgICAjICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgIyAgICAgICAgIGlmIHNlbGYuaXNfYWNjb3VudF9jYW5fcnVuX2pvYihhcHBfbmFtZSk6CiAgICAjICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHThu6sgdOG6pXQgY+G6oyBhcHAgdsOgIHPhuq9wIHjhur9wIHRoZW8gYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIHPhuq9wIHjhur9wCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gW10KICAgICAgICAKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG7jWMgY8OhYyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbih3b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLmV4dGVuZCh3b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAKICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW86CiAgICAgICAgIyAxLiBBcHAgbmFtZSAoxJHhu4MgbmjDs20gY8O5bmcgYXBwIGzhuqFpIHbhu5tpIG5oYXUpCiAgICAgICAgIyAyLiBOZ8OgeSB04bqhbyB0w6BpIGtob+G6o24gKGNyZWF0ZWRfYXQpIC0gY8WpIG5o4bqldCB0csaw4bubYwogICAgICAgICMgMy4gU+G7kSBqb2IgxJHDoyBsw6BtIHRyb25nIHBoacOqbiAow610IG5o4bqldCB0csaw4bubYykKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgeC5nZXQoImNyZWF0ZWRfYXQiLCAwKSwKICAgICAgICAgICAgeC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIHJldHVybiBhbGxfd29ya2FibGVfYWNjb3VudHMKICAgICAgICAKICAgIGRlZiBfd29ya19zZXNzaW9uKHNlbGYsIGFsbF93b3JrYWJsZV9hY2NvdW50czogTGlzdFtEaWN0W3N0ciwgQW55XV0gPSBOb25lKToKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIG3hu5l0IHBoacOqbiBsw6BtIHZp4buHYyBob8OgbiBjaOG7iW5oIHbhu5tpIGPGoSBjaOG6vyBt4bubaSIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAKICAgICAgICAjIMSQw6FuaCBk4bqldSDEkWFuZyB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX1dPUktJTkdfU0VTU0lPTikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHRydXnhu4FuIGRhbmggc8OhY2ggdMOgaSBraG/huqNuLCBs4bqleSBs4bqhaSB04burIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIGFsbF93b3JrYWJsZV9hY2NvdW50cyBpcyBOb25lOgogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKGFsbF93b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gdmnhu4djIHR14bqnbiB04buxIHbhu5tpIHThu6tuZyB0w6BpIGtob+G6o24KICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gbeG7m2kgbmjhuqV0IHThu6sgZGF0YWJhc2UKICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIG7hur91IHNlcnZlciB5w6p1IGPhuqd1CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNlcnZlciB5w6p1IGPhuqd1IMSR4buTbmcgYuG7mSBs4bqhaSB0w6BpIGtob+G6o24gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudHNfZm9yX2FwcChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGzhuqFpIHRow7RuZyB0aW4gdMOgaSBraG/huqNuIHNhdSBraGkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudCBvciBub3Qgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGFjY291bnRfcmVzdWx0ID0gc2VsZi5fd29ya19hY2NvdW50X3Nlc3Npb24oYWNjb3VudCwgaGFuZGxlcikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOzbmcgYXBwIHNhdSBraGkgbMOgbSB4b25nIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gY2jEg20gc8OzYyBzYXUga2hpIGjhur90IGpvYiAobuG6v3UgxJHGsOG7o2MgYuG6rXQpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY2FyZV9pbl93b3JraW5nX2pvYiA9IHNlbGYuZGIuZ2V0KCJjYXJlX2luX3dvcmtpbmdfam9iIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaWYgY2FyZV9pbl93b3JraW5nX2pvYiBhbmQgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgY2FyZV9pbl93b3JraW5nX2pvYjoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ2jEg20gc8OzYyBi4buLIHThuq90LCBi4buPIHF1YSBjaMSDbSBzw7NjIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGLhu4sgZ2nDoW4gxJFv4bqhbiwgZOG7q25nIHBoacOqbgogICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnRfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMyk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUga+G6v3QgdGjDumMgcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAKICAgICMgREVQUkVDQVRFRDogUGjGsMahbmcgdGjhu6ljIG7DoHkga2jDtG5nIGTDuW5nIG7hu69hIGRvIGNodXnhu4NuIHNhbmcgY8ahIGNo4bq/IG3hu5tpCiAgICAjIGRlZiBfd29ya193aXRoX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgIyAgICAgIiIiCiAgICAjICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgIyAgICAgCiAgICAjICAgICBBcmdzOgogICAgIyAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBsw6BtIHZp4buHYwogICAgIyAgICAgICAgIAogICAgIyAgICAgUmV0dXJuczoKICAgICMgICAgICAgICBib29sOiBUcnVlIG7hur91IGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBnacOhbiDEkW/huqFuCiAgICAjICAgICAiIiIKICAgICMgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIHthcHBfbmFtZX0iKQogICAgIyAgICAgCiAgICAjICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAjICAgICAKICAgICMgICAgICMgTMOgbSB2aeG7h2MgdHXhuqduIHThu7EgduG7m2kgdOG7q25nIHTDoGkga2hv4bqjbiAocmVhbC10aW1lIHJlbG9hZCkKICAgICMgICAgIHdoaWxlIFRydWU6CiAgICAjICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgIyAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICMgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgIyAgICAgICAgICAgICAgICAgCiAgICAjICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAjICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICMgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQaMOhdCBoaeG7h24gecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIga2hpIGzDoG0gdmnhu4djIHbhu5tpIHthcHBfbmFtZX0iKQogICAgIyAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICMgICAgICAgICAKICAgICMgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldCAoY8OzIHRo4buDIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyKQogICAgIyAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgICMgTOG7jWMgY8OhYyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICMgICAgICAgICAKICAgICMgICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAjICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgIyAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgICAgICAjIFTDrG0gdMOgaSBraG/huqNuIGPDsyBqb2JzX2RvbmVfaW5fc2Vzc2lvbiB0aOG6pXAgbmjhuqV0IMSR4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAgICAgd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6IHguZ2V0KCdqb2JzX2RvbmVfaW5fc2Vzc2lvbicsIDApKQogICAgIyAgICAgICAgIGFjY291bnQgPSB3b3JrYWJsZV9hY2NvdW50c1swXQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAjICAgICAgICAgCiAgICAjICAgICAgICAgIyBDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBuw6B5CiAgICAjICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICMgICAgICAgICBpZiBub3Qgc3dpdGNoX3Jlc3VsdDoKICAgICMgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICMgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIG7DoHkgY8OzIHbhuqVuIMSR4buBIHbDoCB0aOG7rSB0w6BpIGtob+G6o24ga2jDoWMKICAgICMgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249Ikzhu5dpIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAjICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgICAgICMgTMOgbSDEkeG7pyBz4buRIGpvYiB0cm9uZyBwaGnDqm4gY2hvIHTDoGkga2hv4bqjbiBuw6B5CiAgICAjICAgICAgICAgYWNjb3VudF9yZXN1bHQgPSBzZWxmLl93b3JrX2FjY291bnRfc2Vzc2lvbihhY2NvdW50LCBoYW5kbGVyKQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgICMgTMOgbSBjaMSDbSBzw7NjIHNhdSBraGkgaOG6v3Qgam9iCiAgICAjICAgICAgICAgdHJ5OgogICAgIyAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICJwZXJmb3JtX2NhcmUiKSBhbmQgY2FsbGFibGUoaGFuZGxlci5wZXJmb3JtX2NhcmUpOgogICAgIyAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAjICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgIyAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICMgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgY2jEg20gc8OzYyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX06IHtlfSIpCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgICAgICMgTuG6v3UgYuG7iyBnacOhbiDEkW/huqFuLCByZXR1cm4gRmFsc2UKICAgICMgICAgICAgICBpZiBub3QgYWNjb3VudF9yZXN1bHQ6CiAgICAjICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZwogICAgIyAgICAgICAgICMgKGPDsyB0aOG7gyBjw7MgdGhheSDEkeG7lWkgdOG7qyBzZXJ2ZXIgdHJvbmcgbMO6YyBsw6BtIHZp4buHYykKICAgICMgICAgICAgICB1cGRhdGVkX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgIyAgICAgICAgIHJlbWFpbmluZ193b3JrYWJsZSA9IFthY2MgZm9yIGFjYyBpbiB1cGRhdGVkX2FjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAjICAgICAgICAgCiAgICAjICAgICAgICAgaWYgbm90IHJlbWFpbmluZ193b3JrYWJsZToKICAgICMgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGhvw6BuIHRow6BuaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgIyAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICBkZWYgX3dvcmtfYWNjb3VudF9zZXNzaW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzDoG0gdmnhu4djIHbhu5tpIG3hu5l0IHTDoGkga2hv4bqjbiB0cm9uZyBwaGnDqm4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlcgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBnacOhbiDEkW/huqFuCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGpvYnNfZG9uZSA9IDAKICAgICAgICBjYXJlX2NvdW50ZXIgPSAwCiAgICAgICAgY29uZmlnX3JlbG9hZF9jb3VudGVyID0gMCAgIyDEkOG6v20gxJHhu4MgcmVsb2FkIGPhuqV1IGjDrG5oIMSR4buLbmgga+G7swogICAgICAgIG5vX2pvYl9jb3VudCA9IDAgICMgxJDhur9tIHPhu5EgbOG6p24ga2jDtG5nIGzhuqV5IMSRxrDhu6NjIGpvYiBsacOqbiB0aeG6v3AKICAgICAgICBtYXhfbm9fam9iX2F0dGVtcHRzID0gMyAgIyBT4buRIGzhuqduIHThu5FpIMSRYSB0aOG7rSBs4bqleSBqb2Iga2hpIGtow7RuZyBjw7MKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBuw6B5IGPDsyB24bqlbiDEkeG7gQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0iTOG7l2kgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgUmV0dXJuIFRydWUgxJHhu4MgdGnhur9wIHThu6VjIHbhu5tpIHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbwogICAgICAgIAogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUGjDoXQgaGnhu4duIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIGtoaSBsw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgcHJveHkgdGltZXN0YW1wIG3hu5dpIDIwIGdpw6J5IG7hur91IMSRYW5nIHPhu60gZOG7pW5nIHByb3h5CiAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgaWYgY3VycmVudF90aW1lIC0gc2VsZi5wcm94eV9sYXN0X3VwZGF0ZSA+PSAyMDoKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl91cGRhdGVfcHJveHkoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCLEkMOjIHVwZGF0ZSBwcm94eSB0aW1lc3RhbXAiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJVcGRhdGUgcHJveHkgdGltZXN0YW1wIHRo4bqldCBi4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVsb2FkIGPhuqV1IGjDrG5oIHTDoGkga2hv4bqjbiB04burIGRhdGFiYXNlIG3hu5dpIDUgam9iIMSR4buDIHBo4bqjbiDDoW5oIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyCiAgICAgICAgICAgIGNvbmZpZ19yZWxvYWRfY291bnRlciArPSAxCiAgICAgICAgICAgIGlmIGNvbmZpZ19yZWxvYWRfY291bnRlciA+PSA1OgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVsb2FkIGPhuqV1IGjDrG5oIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IHThu6sgZGF0YWJhc2UiKQogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgIGNvbmZpZ19yZWxvYWRfY291bnRlciA9IDAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gbeG7m2kgbmjhuqV0IChiYW8gZ+G7k20gdGjhu5FuZyBrw6ogam9iKQogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBjaOG6oXkgam9iIGtow7RuZyAoY8OzIHRo4buDIGLhu4sgdGhheSDEkeG7lWkgdOG7qyBzZXJ2ZXIpCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0ga2jDtG5nIHRo4buDIGNo4bqheSBqb2IgbuG7r2EiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIHBoacOqbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgaG/DoG4gdGjDoG5oIMSR4bunIGpvYiB0cm9uZyBwaGnDqm4gKHtqb2JzX2RvbmVfaW5fc2Vzc2lvbn0ve21heF9qb2JzX3Blcl9zZXNzaW9ufSkiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGpvYgogICAgICAgICAgICAgICAgam9iID0gaGFuZGxlci5mZXRjaF9qb2IoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgICAgICAgICBub19qb2JfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChs4bqnbiB7bm9fam9iX2NvdW50fS97bWF4X25vX2pvYl9hdHRlbXB0c30pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYyBqb2IgcXXDoSBuaGnhu4F1IGzhuqduLCBk4burbmcgcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICAgICAgaWYgbm9fam9iX2NvdW50ID49IG1heF9ub19qb2JfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0ga2jDtG5nIGzhuqV5IMSRxrDhu6NjIGpvYiBzYXUge21heF9ub19qb2JfYXR0ZW1wdHN9IGzhuqduIHRo4butLCBk4burbmcgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS5yYW5kaW50KDEwLCAyMCkpOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIga2hpIGzhuqV5IMSRxrDhu6NjIGpvYgogICAgICAgICAgICAgICAgbm9fam9iX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGV2aWNlIG1lc3NhZ2UKICAgICAgICAgICAgICAgIGxpbmsgPSBqb2IuZ2V0KCdsaW5rJywgJycpCiAgICAgICAgICAgICAgICBpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJyk6CiAgICAgICAgICAgICAgICAgICAgbGluayA9IGxpbmsucmVwbGFjZSgnaHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS8nLCAnJykKICAgICAgICAgICAgICAgIGVsaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy50aWt0b2suY29tLycpOgogICAgICAgICAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJywgJycpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIlt7YWNjb3VudC5nZXQoJ2FwcCcpfV1be3VzZXJuYW1lfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFZhbGlkYXRlIGpvYgogICAgICAgICAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBoYW5kbGVyLnZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IHZhbGlkYXRpb25fcmVzdWx0LmdldCgidmFsaWQiLCBUcnVlKToKICAgICAgICAgICAgICAgICAgICBpZiB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInNob3VsZF9za2lwIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICAjIFNraXAgam9iCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBfbWVzc2FnZSA9IHZhbGlkYXRpb25fcmVzdWx0LmdldCgibWVzc2FnZSIsICJKb2Iga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNraXAgam9iOiB7c2tpcF9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBza2lwX21lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTa2lwIGpvYiBs4buXaToge2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgR2nDo24gdGjhu51pIGdpYW4gc2F1IGtoaSBza2lwIGpvYiDEkeG7gyB0csOhbmggc3BhbSBs4bqleS9o4buneSBqb2IgbGnDqm4gdOG7pWMKICAgICAgICAgICAgICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJKb2Iga2jDtG5nIGjhu6NwIGzhu4c6IHt2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnVW5rbm93biBlcnJvcicpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGpvYgogICAgICAgICAgICAgICAgam9iX3Jlc3VsdCA9IGhhbmRsZXIuZXhlY3V0ZV9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjCiAgICAgICAgICAgICAgICBqb2Jfc3RhdHVzID0gam9iX3Jlc3VsdFsic3RhdHVzIl0KICAgICAgICAgICAgICAgIGpvYl9zdWNjZXNzID0gam9iX3Jlc3VsdFsic3VjY2VzcyJdCiAgICAgICAgICAgICAgICBqb2JfbWVzc2FnZSA9IGpvYl9yZXN1bHRbIm1lc3NhZ2UiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGzhu5dpIGZvbGxvdyBwZW5kaW5nCiAgICAgICAgICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDQgYW5kIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgICAgICBjbnQgPSBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHNbYWNjb3VudFsiaWQiXV0gPSBjbnQKICAgICAgICAgICAgICAgICAgICBpZiBjbnQgPj0gNToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIDUgbOG6p24gbGnDqm4gdGnhur9wIGZvbGxvdyBwZW5kaW5nLCB04bqhbSBk4burbmcgdMOgaSBraG/huqNuIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249Ikxpw6puIHRp4bq/cCBs4buXaSBmb2xsb3cgcGVuZGluZyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxpZiBqb2IuZ2V0KCJ0eXBlIiwgIiIpLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELDoW8gY8OhbyBr4bq/dCBxdeG6owogICAgICAgICAgICAgICAgaGFuZGxlci5yZXBvcnRfam9iKGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6oKICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9qb2Jfc3RhdHMoYWNjb3VudCwgam9iX3N1Y2Nlc3MsIGpvYi5nZXQoInR5cGUiLCAiIikpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVsb2FkIGFjY291bnQgc2F1IGtoaSB1cGRhdGUgxJHhu4MgY8OzIGThu68gbGnhu4d1IG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJL4bq/dCBxdeG6oyBqb2Ige2pvYnNfZG9uZV9pbl9zZXNzaW9ufS97bWF4X2pvYnNfcGVyX3Nlc3Npb259OiB7am9iX21lc3NhZ2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaOG7iSB0xINuZyBjYXJlX2NvdW50ZXIga2hpIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIGlmIGpvYl9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgIGpvYnNfZG9uZSArPSAxCiAgICAgICAgICAgICAgICAgICAgY2FyZV9jb3VudGVyICs9IDEKICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDaMSDbSBzw7NjIHNhdSBt4buXaSAzLTUgam9iIHRow6BuaCBjw7RuZyAocmFuZG9tKQogICAgICAgICAgICAgICAgICAgICMgaWYgY2FyZV9jb3VudGVyID49IHJhbmRvbS5yYW5kaW50KDMsIDUpOgogICAgICAgICAgICAgICAgICAgICMgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBjaMSDbSBzw7NjIG5o4bq5IGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgY2FyZV9jb3VudGVyID0gMAogICAgICAgICAgICAgICAgICAgICMgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAjICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgY2jEg20gc8OzYyBuaOG6uToge2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuq9uIGdp4buvYSBjw6FjIGpvYgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChyYW5kb20ucmFuZGludCgyLCA1KSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX3N0YXJ0X3Nlc3Npb25fY29vbGRvd24oc2VsZik6CiAgICAgICAgIiIiQuG6r3QgxJHhuqd1IHRo4budaSBnaWFuIG5naOG7iSBnaeG7r2EgY8OhYyBwaGnDqm4iIiIKICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5kYi5nZXQoImpvYl9jb29sZG93bl9taW51dGVzIiwgNjApCiAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gaW50KHRpbWUudGltZSgpKSArIChjb29sZG93bl9taW51dGVzICogNjApCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3Ugbmdo4buJIG5nxqFpIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCBnaeG7r2EgY8OhYyBwaGnDqm4iKQogICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYie0pvYlNlcnZpY2VDb25zdGFudHMuTVNHX1NFU1NJT05fQ09PTERPV059ICh7Y29vbGRvd25fbWludXRlc30gcGjDunQpIikKICAgICAgICAKICAgICAgICAjIELhuqVtIG7DunQgSG9tZSB2w6AgbeG7nyBUZXJtdXgga2hpIGLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJC4bqlbSBuw7p0IEhvbWUgdsOgIG3hu58gVGVybXV4IMSR4buDIG5naOG7iSBuZ8ahaSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELhuqVtIG7DunQgSG9tZQogICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu50gbeG7mXQgY2jDunQgcuG7k2kgbeG7nyBUZXJtdXgKICAgICAgICAgICAgdGltZS5zbGVlcCgyKQogICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcCgiY29tLnRlcm11eCIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgYuG6pW0gSG9tZSB2w6AgbeG7nyBUZXJtdXg6IHtlfSIpCiAgICAgICAgCiAgICBkZWYgX2lzX2luX3Nlc3Npb25fY29vbGRvd24oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRYW5nIHRyb25nIHRo4budaSBnaWFuIG5naOG7iQogICAgICAgICIiIgogICAgICAgIGlmIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA8PSAwOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIGlmIGN1cnJlbnRfdGltZSA8IHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZToKICAgICAgICAgICAgcmVtYWluaW5nX21pbnV0ZXMgPSBpbnQoKHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSAtIGN1cnJlbnRfdGltZSkgLyA2MCkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0IG5naOG7iSBuZ8ahaSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgICAgICByZXR1cm4gRmFsc2U=').decode('utf-8'))
