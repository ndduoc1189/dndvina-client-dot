import base64
exec(base64.b64decode('aW1wb3J0IGRhdGV0aW1lCmltcG9ydCB0aW1lCmltcG9ydCByYW5kb20KaW1wb3J0IHJlCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsCmZyb20gam9icy5qb2JfYmFzZSBpbXBvcnQgQmFzZUpvYgoKY2xhc3MgVGlrdG9rSm9iKEJhc2VKb2IpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSkKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gImNvbS5zcy5hbmRyb2lkLnVnYy50cmlsbCIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gInRpa3RvayIKICAgICAgICAKICAgICAgICAjIE92ZXJyaWRlIGRlZmF1bHQgY29uZmlnIGNobyBUaWtUb2sKICAgICAgICBzZWxmLl9kZWZhdWx0X2NvbmZpZy51cGRhdGUoewogICAgICAgICAgICAiYWN0aW9uX3dlaWdodHMiOiB7CiAgICAgICAgICAgICAgICAibmV3c2ZlZWQiOiAxMCwgICAgICAjIDEwJSB2deG7kXQgYuG6o25nIHRpbiAow610IGjGoW4gdsOsIFRpa1RvayBjaOG7pyB54bq/dSBsw6AgdmlkZW8pCiAgICAgICAgICAgICAgICAicmVlbHMiOiAyNSwgICAgICAgICAjIDI1JSB4ZW0gdmlkZW8gKGNow61uaCBj4bunYSBUaWtUb2spIAogICAgICAgICAgICAgICAgIm5vdGlmaWNhdGlvbiI6IDgsICAgIyA4JSB4ZW0gdGjDtG5nIGLDoW8KICAgICAgICAgICAgICAgICJwcm9maWxlIjogMTIsICAgICAgICMgMTIlIHhlbSBwcm9maWxlCiAgICAgICAgICAgICAgICAiam9iIjogMjAsICAgICAgICAgICAjIDIwJSBsw6BtIGpvYiAoZ2nhu68gbmd1ecOqbikKICAgICAgICAgICAgICAgICJleHBsb3JlIjogMTUsICAgICAgICMgMTUlIGtow6FtIHBow6EgKGNhbyBoxqFuIHbDrCBUaWtUb2sgaGF5IHN1Z2dlc3QpCiAgICAgICAgICAgICAgICAic2VhcmNoIjogNSwgICAgICAgICAjIDUlIHTDrG0ga2nhur9tICjDrXQgaMahbiB2w6wgVGlrVG9rIGThu7FhIHbDoG8gYWxnb3JpdGhtKQogICAgICAgICAgICAgICAgInBvc3QiOiA1ICAgICAgICAgICAgIyA1JSB4ZW0gbGl2ZXN0cmVhbSAoYWN0aW9uIHJpw6puZyBj4bunYSBUaWtUb2spCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiI6IDM1LCAgIyBUaWtUb2sgY8OzIHRo4buDIG5oaeG7gXUgYWN0aW9ucyBoxqFuIFlvdVR1YmUgKDM1KQogICAgICAgICAgICAiZGVsYXlfcG9zdF92aWRlb19taW51dGUiOiAxNDQwLCAgIyBUaOG7nWkgZ2lhbiBjaOG7nSBnaeG7r2EgY8OhYyBs4bqnbiDEkcSDbmcgdmlkZW8gKHBow7p0KSAtIG3hurdjIMSR4buLbmggMjQgZ2nhu50KICAgICAgICB9KQogICAgICAgIAogICAgICAgICMgQ2FjaGUgY2hvIGN1cnJlbnQgdXNlcm5hbWUgxJHhu4MgdHLDoW5oIGNoZWNrIHF1w6Egbmhp4buBdQogICAgICAgIHNlbGYuX2NhY2hlZF91c2VybmFtZSA9IE5vbmUKICAgICAgICBzZWxmLl91c2VybmFtZV9jYWNoZV90aW1lID0gMAogICAgICAgIHNlbGYuX3VzZXJuYW1lX2NhY2hlX3R0bCA9IDYwICAjIENhY2hlIDYwIGdpw6J5CiAgICAKICAgIGRlZiBnZXRfc3VwcG9ydGVkX2FjdGlvbnMoc2VsZikgLT4gTGlzdFtzdHJdOgogICAgICAgICIiIgogICAgICAgIE92ZXJyaWRlIGRhbmggc8OhY2ggYWN0aW9ucyDEkcaw4bujYyBUaWtUb2sgaOG7lyB0cuG7owogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3Rbc3RyXTogRGFuaCBzw6FjaCBhY3Rpb25zIFRpa1RvayBo4buXIHRy4bujCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGxpc3Qoc2VsZi5nZXRfYWN0aW9uX3dlaWdodHMoKS5rZXlzKCkpCiAgICAgICAgCiAgICBkZWYgZ2V0X2FjY291bnRzX2Zyb21fZGV2aWNlKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIFRpa3RvayB04burIHRoaeG6v3QgYuG7iyIiIgogICAgICAgIGFjY291bnRzID0gW10KICAgICAgICAKICAgICAgICB0cnk6CgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGVuc3VyZV9ob21lX3NjcmVlbigpIHRoYXkgdsOsIGNo4buJIHdhaXRfZm9yX2VsZW1lbnQKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHThuqNpIG3DoG4gaMOsbmggY2jDrW5oIFRpa1RvayBzYXUgMjAgZ2nDonkiKQogICAgICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgIkjhu5Mgc8ahIiB2w6AgbmjhuqVwIHbDoG8KICAgICAgICAgICAgaWYgbm90IHNlbGYuX25hdmlnYXRlX3RvX3Byb2ZpbGVfdGFiKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE3hu58gbWVudSBo4buTIHPGoSDEkeG7gyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fb3Blbl9wcm9maWxlX21lbnUoKToKICAgICAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBYTUwgbcOgbiBow6xuaCBzYXUga2hpIG3hu58gbWVudQogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBuw7p0ICJUaMOqbSB0w6BpIGtob+G6o24iCiAgICAgICAgICAgIGFkZF9hY2NvdW50X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPSJUaMOqbSB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYWRkX2FjY291bnRfYnV0dG9uOgogICAgICAgICAgICAgICAgIyBUw6xtIGRhbmggc8OhY2ggdMOgaSBraG/huqNuIChSZWN5Y2xlclZpZXcpIC0gbMOgIGNoYSBj4bunYSBuw7p0ICJUaMOqbSB0w6BpIGtob+G6o24iCiAgICAgICAgICAgICAgICByZWN5Y2xlcl92aWV3ID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gdOG6pXQgY+G6oyBSZWN5Y2xlclZpZXcKICAgICAgICAgICAgICAgIGFsbF9yZWN5Y2xlcl92aWV3cyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLCAKICAgICAgICAgICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkeC5yZWN5Y2xlcnZpZXcud2lkZ2V0LlJlY3ljbGVyVmlldyIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIFJlY3ljbGVyVmlldyBjaOG7qWEgY8OhYyB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGZvciBydiBpbiBhbGxfcmVjeWNsZXJfdmlld3M6CiAgICAgICAgICAgICAgICAgICAgcnZfYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKHJ2KQogICAgICAgICAgICAgICAgICAgIGFkZF9hY2NvdW50X2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhhZGRfYWNjb3VudF9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBhZGRfYWNjb3VudF9idXR0b24gY8OzIG7hurFtIHRyb25nIHJlY3ljbGVyX3ZpZXcga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgaWYgKHJ2X2JvdW5kc1swXSA8PSBhZGRfYWNjb3VudF9ib3VuZHNbMF0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHJ2X2JvdW5kc1sxXSA8PSBhZGRfYWNjb3VudF9ib3VuZHNbMV0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHJ2X2JvdW5kc1syXSA+PSBhZGRfYWNjb3VudF9ib3VuZHNbMl0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIHJ2X2JvdW5kc1szXSA+PSBhZGRfYWNjb3VudF9ib3VuZHNbM10pOgogICAgICAgICAgICAgICAgICAgICAgICByZWN5Y2xlcl92aWV3ID0gcnYKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgcmVjeWNsZXJfdmlldzoKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gdOG6pXQgY+G6oyBuw7p0IChCdXR0b24pIHRyb25nIFJlY3ljbGVyVmlldyBi4bqxbmcgY2xhc3MgdGhheSB2w6wgcmVzb3VyY2UtaWQKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2J1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm9yIGJ1dHRvbiBpbiBhY2NvdW50X2J1dHRvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQuG7jyBxdWEgbsO6dCAiVGjDqm0gdMOgaSBraG/huqNuIgogICAgICAgICAgICAgICAgICAgICAgICBpZiBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiKSA9PSAiVGjDqm0gdMOgaSBraG/huqNuIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IHTDqm4gdMOgaSBraG/huqNuIHThu6sgY29udGVudC1kZXNjCiAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gYnV0dG9uLmdldCgiY29udGVudC1kZXNjIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVMOsbSBUZXh0VmlldyB0cm9uZyBidXR0b24gYuG6sW5nIGNsYXNzIHRoYXkgdsOsIHJlc291cmNlLWlkCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0dmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5UZXh0VmlldyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBM4buNYyB0ZXh0dmlldyB0aGVvIGJvdW5kcyDEkeG7gyB0w6xtIMSRw7puZyBjw6FpIHRodeG7mWMgduG7gSBidXR0b24gbsOgeQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhidXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgdHYgaW4gdGV4dHZpZXdzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyh0dikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHZfYm91bmRzWzBdID49IGJ1dHRvbl9ib3VuZHNbMF0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kc1sxXSA+PSBidXR0b25fYm91bmRzWzFdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHNbMl0gPD0gYnV0dG9uX2JvdW5kc1syXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzWzNdIDw9IGJ1dHRvbl9ib3VuZHNbM10pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dCh0dikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIMSR4buDIGtow7RuZyBs4bqleSBwaOG6o2kgdGV4dCBy4buXbmcgaG/hurdjICJudWxsIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0ZXh0IGFuZCB0ZXh0ICE9ICJudWxsIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQuG7jyBxdWEgbsO6dCAixJDDs25nIgogICAgICAgICAgICAgICAgICAgICAgICBpZiB1c2VybmFtZSA9PSAixJDDs25nIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJFhbmcgxJHEg25nIG5o4bqtcCBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgaXNfY3VycmVudCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFTDrG0gZOG6pXUga2nhu4NtIHRyb25nIGJ1dHRvbiBi4bqxbmcgY29udGVudC1kZXNjCiAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrbWFya3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGVudF9kZXNjPSJE4bqldSBraeG7g20iCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gZOG6pXUga2nhu4NtIGPDsyB0aHXhu5ljIHbhu4EgYnV0dG9uIG7DoHkga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHMoYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgY2hlY2sgaW4gY2hlY2ttYXJrczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrX2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhjaGVjaykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjaGVja19ib3VuZHNbMF0gPj0gYnV0dG9uX2JvdW5kc1swXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja19ib3VuZHNbMV0gPj0gYnV0dG9uX2JvdW5kc1sxXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja19ib3VuZHNbMl0gPD0gYnV0dG9uX2JvdW5kc1syXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja19ib3VuZHNbM10gPD0gYnV0dG9uX2JvdW5kc1szXSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfY3VycmVudCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBDxaluZyBjw7MgdGjhu4Mga2nhu4NtIHRyYSB0aHXhu5ljIHTDrW5oIHNlbGVjdGVkCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJ1dHRvbi5nZXQoInNlbGVjdGVkIikgPT0gInRydWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXNfY3VycmVudCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB1c2VybmFtZSBo4bujcCBs4buHIHRyxrDhu5tjIGtoaSB0aMOqbSB2w6BvIGRhbmggc8OhY2gKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlcm5hbWUgYW5kIHVzZXJuYW1lICE9ICJudWxsIiBhbmQgdXNlcm5hbWUuc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTOG7jWMgdGjDqm0gY8OhYyB0w6puIGtow7RuZyBwaOG6o2kgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB1c2VybmFtZSBub3QgaW4gWyJDw6BpIMSR4bq3dCIsICJDw6BpIMSR4bq3dCB0w6BpIGtob+G6o24iLCAiVMO5eSBjaOG7jW4iLCAiTWVudSJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnQgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJuaWNrbmFtZSI6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidW5pcXVlX3VzZXJuYW1lIjogdXNlcm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlxdWVfaWQiOiB1c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBpc19jdXJyZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXZhdGFyX3RodW1iIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZW5hYmxlIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImxldmVsIjogMSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50cy5hcHBlbmQoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBRdWF5IGzhuqFpIG3DoG4gaMOsbmggY2jDrW5oCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgwLjUpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBUaWtUb2siKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudHMKICAgIAogICAgZGVmIHBlcmZvcm1fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIGPDtG5nIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24gVGlrVG9rIiIiCiAgICAgICAgIyBT4butIGThu6VuZyBwaMawxqFuZyB0aOG7qWMgY+G7p2EgbOG7m3AgY2hhCiAgICAgICAgc3VwZXIoKS5wZXJmb3JtX2pvYihhY2NvdW50KQogICAgICAgIAogICAgZGVmIHBlcmZvcm1fY2FyZShzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgTnXDtGkgdMOgaSBraG/huqNuIFRpa1RvayAtIExlZ2FjeSBtZXRob2QsIHPhu60gZOG7pW5nIFNtYXJ0IENhcmUgbeG7m2kKICAgICAgICBCYWNrd2FyZCBjb21wYXRpYmlsaXR5OiBjaHV54buDbiBoxrDhu5tuZyBzYW5nIFNtYXJ0IENhcmUgbWV0aG9kcwogICAgICAgICIiIgogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkGFuZyBudcO0aSB0w6BpIGtob+G6o24gVGlrVG9rOiB7YWNjb3VudFsndW5pcXVlX3VzZXJuYW1lJ119IChsZWdhY3kgbWV0aG9kKSIpCiAgICAgICAgCiAgICAgICAgIyBT4butIGThu6VuZyBTbWFydCBDYXJlIG1ldGhvZCB0aGF5IHbDrCBtaW5pIGNhcmUgY8WpCiAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgIGNhcmVfbWV0aG9kcyA9IFsiX2NhcmVfc3dpcGVfZmVlZCIsICJfY2FyZV93YXRjaF92aWRlb3MiXQogICAgICAgIHNlbGVjdGVkX21ldGhvZCA9IHJhbmRvbS5jaG9pY2UoY2FyZV9tZXRob2RzKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgbWV0aG9kID0gZ2V0YXR0cihzZWxmLCBzZWxlY3RlZF9tZXRob2QpCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBtZXRob2QoYWNjb3VudCkKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkxlZ2FjeSBjYXJlIHVzaW5nIHtzZWxlY3RlZF9tZXRob2R9OiB7J3N1Y2Nlc3MnIGlmIHN1Y2Nlc3MgZWxzZSAnZmFpbGVkJ30iKQogICAgICAgICAgICByZXR1cm4gc3VjY2VzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJMZWdhY3kgY2FyZSBlcnJvcjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgcGVyZm9ybV9taW5pX2NhcmUoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBtaW5pIGNhcmUgY2hvIHTDoGkga2hv4bqjbiBUaWtUb2s6CiAgICAgICAgMS4gVuG7gSB0cmFuZyBjaOG7pywgeMOhYyBuaOG6rW4gdGFiIMSR4buBIHh14bqldAogICAgICAgIDIuIEzGsOG7m3QgxJHhu4EgeHXhuqV0IHRyb25nIDItMyBwaMO6dAogICAgICAgIDMuIE5n4bqrdSBuaGnDqm4gYuG6pW0gdsOgbyBI4buZcCB0aMawLCBk4burbmcgMi01cywgdnXhu5F0IGzDqm4sIHF1YXkgbOG6oWkgdHJhbmcgY2jhu6cKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IG1pbmkgY2FyZSBjaG8gdMOgaSBraG/huqNuIFRpa1Rvazoge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDEuIMSQ4bqjbSBi4bqjbyB24buBIHRyYW5nIGNo4bunIHbDoCB4w6FjIG5o4bqtbiB0YWIgxJHhu4EgeHXhuqV0CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB24buBIHRyYW5nIGNo4bunIFRpa1RvayIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdsOgIGNsaWNrIHbDoG8gdGFiICJEw6BuaCBjaG8gYuG6oW4iICh0YWIgxJHhu4EgeHXhuqV0KQogICAgICAgICAgICBmb3JfeW91X3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJEw6BuaCBjaG8gYuG6oW4iKQogICAgICAgICAgICBpZiBub3QgZm9yX3lvdV90YWI6CiAgICAgICAgICAgICAgICBmb3JfeW91X3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IkTDoG5oIGNobyBi4bqhbiIpCiAgICAgICAgICAgIGlmIG5vdCBmb3JfeW91X3RhYjoKICAgICAgICAgICAgICAgIGZvcl95b3VfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IkZvciBZb3UiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGZvcl95b3VfdGFiOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgdGFiIMSR4buBIHh14bqldCwgxJFhbmcgY2xpY2sgdsOgby4uLiIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoZm9yX3lvdV90YWIpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSB0YWIgxJHhu4EgeHXhuqV0LCBnaeG6oyDEkeG7i25oIMSRYW5nIOG7nyB0YWIgxJHDum5nIikKCiAgICAgICAgICAgICMgMi4gTMaw4bubdCDEkeG7gSB4deG6pXQgdHJvbmcgMS0zIHBow7p0CiAgICAgICAgICAgIHNjcm9sbF9kdXJhdGlvbiA9IHJhbmRvbS5yYW5kaW50KDYwLCAxODApICAjIDEtMyBwaMO6dAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IGzGsOG7m3QgxJHhu4EgeHXhuqV0IHRyb25nIHtzY3JvbGxfZHVyYXRpb259IGdpw6J5Li4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICB2aWRlb19jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgIHdoaWxlICh0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUpIDwgc2Nyb2xsX2R1cmF0aW9uOgogICAgICAgICAgICAgICAgIyBMxrDhu5t0IGzDqm4gxJHhu4MgY2h1eeG7g24gdmlkZW8gdGnhur9wIHRoZW8KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHZpZGVvX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuqt1IG5oacOqbiAzLTggZ2nDonkgZ2nhu69hIGPDoWMgdmlkZW8gKG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjhuq10KQogICAgICAgICAgICAgICAgd2F0Y2hfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDgpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2F0Y2hfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSYW5kb20gY8OzIDEwJSBraOG6oyBuxINuZyBi4bqlbSBsaWtlIHZpZGVvCiAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZG9tKCkgPCAwLjE6ICAjIDEwJSBjaGFuY2UKICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuX2ZpbmRfbGlrZV9idXR0b24oKQogICAgICAgICAgICAgICAgICAgIGlmIGxpa2VfYnV0dG9uIGFuZCBub3Qgc2VsZi5oZWxwZXIuaXNfZWxlbWVudF9zZWxlY3RlZChsaWtlX2J1dHRvbik6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlJhbmRvbSBsaWtlIHZpZGVvIHRyb25nIGtoaSBtaW5pIGNhcmUiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIobGlrZV9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJhbmRvbSBjw7MgNSUga2jhuqMgbsSDbmcgYuG6pW0gc2hhcmUKICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IDAuMDU6ICAjIDUlIGNoYW5jZQogICAgICAgICAgICAgICAgICAgIHNoYXJlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IkNoaWEgc+G6uyIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNoYXJlX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2hhcmVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iU2hhcmUiKQogICAgICAgICAgICAgICAgICAgIGlmIHNoYXJlX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUmFuZG9tIGNsaWNrIHNoYXJlIHRyb25nIGtoaSBtaW5pIGNhcmUiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2hhcmVfYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgIyBOaOG6pW4gYmFjayDEkeG7gyDEkcOzbmcgZGlhbG9nIHNoYXJlCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGzGsOG7m3Qge3ZpZGVvX2NvdW50fSB2aWRlbyB0cm9uZyB7c2Nyb2xsX2R1cmF0aW9ufSBnacOieSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDMuIE5n4bqrdSBuaGnDqm4gYuG6pW0gdsOgbyBI4buZcCB0aMawICg1MCUga2jhuqMgbsSDbmcpCiAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IDAuNTogICMgNTAlIGNoYW5jZQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUmFuZG9tIHRydXkgY+G6rXAgSOG7mXAgdGjGsC4uLiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSB2w6AgY2xpY2sgdsOgbyBI4buZcCB0aMawCiAgICAgICAgICAgICAgICBpbmJveF9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJI4buZcCB0aMawIikKICAgICAgICAgICAgICAgIGlmIGluYm94X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSBI4buZcCB0aMawLCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoaW5ib3hfYnV0dG9uKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgROG7q25nIGzhuqFpIDItNSBnacOieQogICAgICAgICAgICAgICAgICAgIHdhaXRfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkThu6tuZyBs4bqhaSB7d2FpdF90aW1lfSBnacOieSB0cm9uZyBI4buZcCB0aMawLi4uIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2FpdF90aW1lKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gdHJvbmcgSOG7mXAgdGjGsAogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlZ14buRdCBsw6puIHRyb25nIEjhu5lwIHRoxrAuLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFF1YXkgbOG6oWkgdHJhbmcgY2jhu6cKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJRdWF5IGzhuqFpIHRyYW5nIGNo4bunIHThu6sgSOG7mXAgdGjGsC4uLiIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuYmFja190b19ob21lKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyBxdWF5IHbhu4EgdHJhbmcgY2jhu6cgdOG7qyBI4buZcCB0aMawIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgSOG7mXAgdGjGsCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJTa2lwIHRydXkgY+G6rXAgSOG7mXAgdGjGsCBs4bqnbiBuw6B5IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgY3Xhu5FpIGPDuW5nCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyB24buBIHRyYW5nIGNo4bunIHNhdSBtaW5pIGNhcmUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggbWluaSBjYXJlIGNobyB0w6BpIGtob+G6o24gVGlrVG9rOiB7YWNjb3VudFsndW5pcXVlX3VzZXJuYW1lJ119IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBtaW5pIGNhcmUgY2hvIHTDoGkga2hv4bqjbiBUaWtUb2s6IHthY2NvdW50Wyd1bmlxdWVfdXNlcm5hbWUnXX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4buRIGfhuq9uZyB24buBIHRyYW5nIGNo4bunIG7hur91IGPDsyBs4buXaQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9yZXN0YXJ0X2FwcChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQw7NuZyBhcHAgdsOgIG3hu58gbOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkGFuZyDEkcOzbmcgYXBwIFRpa1Rvay4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyBhcHAKICAgICAgICAgICAgc2VsZi5oZWxwZXIuZm9yY2Vfc3RvcF9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE3hu58gbOG6oWkgYXBwCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQYW5nIG3hu58gbOG6oWkgYXBwIFRpa1Rvay4uLiIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4budIGFwcCB04bqjaSB4b25nCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg1KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFwcCDEkcOjIG3hu58gdGjDoG5oIGPDtG5nIGNoxrBhCiAgICAgICAgICAgIGlmIHNlbGYuaGVscGVyLmdldF9jdXJyZW50X2FwcCgpID09IHNlbGYuYXBwX3BhY2thZ2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIHJlc3RhcnQgYXBwIFRpa1RvayB0aMOgbmggY8O0bmciKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJSZXN0YXJ0IGFwcCBUaWtUb2sgdGjhuqV0IGLhuqFpIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSByZXN0YXJ0IGFwcCIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfc2Nyb2xsX2Zvcl95b3VfZmVlZChzZWxmLCBkdXJhdGlvbl9zZWNvbmRzOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMaw4bubdCBmZWVkIMSR4buBIHh14bqldCB0cm9uZyBraG/huqNuZyB0aOG7nWkgZ2lhbiBuaOG6pXQgxJHhu4tuaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGR1cmF0aW9uX3NlY29uZHM6IFRo4budaSBnaWFuIGzGsOG7m3QgKGdpw6J5KQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgc2Nyb2xsX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgZHVyYXRpb25fc2Vjb25kczoKICAgICAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gxJHhu4MgY2h1eeG7g24gdmlkZW8gdGnhur9wIHRoZW8KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNjcm9sbF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqrdSBuaGnDqm4gMi02IGdpw6J5IG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjhuq10IHhlbSB2aWRlbwogICAgICAgICAgICAgICAgd2F0Y2hfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDYpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2F0Y2hfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSYW5kb20gdGjhu4luaCB0aG/huqNuZyBk4burbmcgbMOidSBoxqFuIChuaMawIMSRYW5nIHhlbSB2aWRlbyB0aMO6IHbhu4spCiAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZGludCgxLCAxMCkgPT0gMTogICMgMTAlIHjDoWMgc3XhuqV0CiAgICAgICAgICAgICAgICAgICAgbG9uZ193YXRjaF90aW1lID0gcmFuZG9tLnJhbmRpbnQoOCwgMTUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkThu6tuZyB4ZW0gdmlkZW8gbMOidSBoxqFuOiB7bG9uZ193YXRjaF90aW1lfXMiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChsb25nX3dhdGNoX3RpbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTG9nIHRp4bq/biB0csOsbmggbeG7l2kgMzAgZ2nDonkKICAgICAgICAgICAgICAgIGVsYXBzZWQgPSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUKICAgICAgICAgICAgICAgIGlmIGVsYXBzZWQgPiAwIGFuZCBpbnQoZWxhcHNlZCkgJSAzMCA9PSAwIGFuZCBzY3JvbGxfY291bnQgPiAwOgogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZyA9IGR1cmF0aW9uX3NlY29uZHMgLSBlbGFwc2VkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbMaw4bubdCB7c2Nyb2xsX2NvdW50fSB2aWRlbywgY8OybiBs4bqhaSB7aW50KHJlbWFpbmluZyl9cyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIGzGsOG7m3QgxJHhu4EgeHXhuqV0OiB7c2Nyb2xsX2NvdW50fSB2aWRlbyB0cm9uZyB7ZHVyYXRpb25fc2Vjb25kc31zIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBsxrDhu5t0IGZlZWQgxJHhu4EgeHXhuqV0IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfaW50ZXJhY3Rfd2l0aF9pbmJveChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFTGsMahbmcgdMOhYyB24bubaSBI4buZcCB0aMawOiBi4bqlbSB2w6BvLCBk4burbmcgMi01cywgdnXhu5F0IGzDqm4KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFTDrG0gbsO6dCBI4buZcCB0aMawCiAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9Ikjhu5lwIHRoxrAiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGluYm94X2J1dHRvbjoKICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSB0aGVvIHRleHQKICAgICAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJI4buZcCB0aMawIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBpbmJveF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBI4buZcCB0aMawIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGljayB2w6BvIEjhu5lwIHRoxrAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJBhbmcgY2xpY2sgdsOgbyBI4buZcCB0aMawIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGluYm94X2J1dHRvbikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgROG7q25nIGzhuqFpIDItNSBnacOieQogICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCgyLCA1KQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiROG7q25nIHRyb25nIEjhu5lwIHRoxrAge3dhaXRfdGltZX1zIikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfdGltZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gdHJvbmcgSOG7mXAgdGjGsAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJWdeG7kXQgbMOqbiB0cm9uZyBI4buZcCB0aMawIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gdGhhbyB0w6FjIHZ14buRdCBsw6puIHRow6ptIDEtMiBs4bqnbiBu4buvYQogICAgICAgICAgICBhZGRpdGlvbmFsX3N3aXBlcyA9IHJhbmRvbS5yYW5kaW50KDEsIDIpCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKGFkZGl0aW9uYWxfc3dpcGVzKToKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgwLjUsIDEuNSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJIb8OgbiB0aMOgbmggdMawxqFuZyB0w6FjIHbhu5tpIEjhu5lwIHRoxrAiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHTGsMahbmcgdMOhYyB24bubaSBI4buZcCB0aMawIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldF9hdmFpbGFibGVfam9icyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGFuaCBzw6FjaCBjw6FjIGpvYiBraOG6oyBk4bulbmcgdOG7qyBHb0xpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCBqb2IgaG/hurdjIGxpc3QgcuG7l25nIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBs4bqleSBqb2I6IEdvTGlrZVNlcnZpY2UgY2jGsGEgxJHGsOG7o2MgY3VuZyBj4bqlcCIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgR+G7jWkgQVBJIGzhuqV5IGpvYgogICAgICAgICAgICBqb2JfdXJsID0gc2VsZi5nZXRfam9ic191cmwoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aGFtIHPhu5EKICAgICAgICAgICAgcGFyYW1zID0gc2VsZi5nZXRfam9iX3BhcmFtcyhhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KGpvYl91cmwsICJHRVQiLCBwYXJhbXMpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgam9iX2RhdGEgPSByZXNwb25zZS5nZXQoImRhdGEiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgam9iX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3Ugam9iCiAgICAgICAgICAgICAgICAgICAgam9iID0gc2VsZi5tYXBfam9iX2RhdGEoam9iX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgam9iIHtqb2JbJ2lkJ119IGxv4bqhaSB7am9iWyd0eXBlJ119IGNobyB0w6BpIGtob+G6o24ge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtqb2JdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBs4bqleSBkYW5oIHPDoWNoIGpvYiIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgZXhlY3V0ZV9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiBqb2IsIGJhbyBn4buTbToKICAgICAgICAgICAgICAgIC0gc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgICAgICAwOiBDaMawYSB0aOG7sWMgaGnhu4duCiAgICAgICAgICAgICAgICAgICAgMTogVGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgMjogVGjhuqV0IGLhuqFpLCBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgICAgICAgICAgMzogVGjhuqV0IGLhuqFpLCDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICAgICAgICAgNDogVGjhuqV0IGLhuqFpLCB5w6p1IGPhuqd1IMSRYW5nIGNo4budCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICAtIHN1Y2Nlc3MgKGJvb2wpOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBqb2JfdHlwZSA9IGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKQogICAgICAgICAgICBqb2JfbGluayA9IGpvYi5nZXQoImxpbmsiLCAiIikKICAgICAgICAgICAgam9iX2lkID0gam9iLmdldCgiaWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIHRo4buxYyBoaeG7h24gam9iIHtqb2JfaWR9IGxv4bqhaSB7am9iX3R5cGV9IHbhu5tpIGxpbmsge2pvYl9saW5rfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbG/huqFpIGpvYiDEkcaw4bujYyBo4buXIHRy4bujCiAgICAgICAgICAgIGlmIGpvYl90eXBlIG5vdCBpbiBbImZvbGxvdyIsICJsaWtlIl06CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gZiJMb+G6oWkgam9iIHtqb2JfdHlwZX0ga2jDtG5nIMSRxrDhu6NjIGjhu5cgdHLhu6MiCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLAogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogbWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gam9iIHRoZW8gbG/huqFpCiAgICAgICAgICAgIGpvYl9zdGF0dXMgPSAwICAjIE3hurdjIMSR4buLbmggbMOgIGNoxrBhIGzDoG0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGpvYl90eXBlID09ICJmb2xsb3ciOgogICAgICAgICAgICAgICAgam9iX3N0YXR1cyA9IHNlbGYuX3BlcmZvcm1fZm9sbG93X2pvYihqb2JfbGluaykKICAgICAgICAgICAgZWxpZiBqb2JfdHlwZSA9PSAibGlrZSI6CiAgICAgICAgICAgICAgICBqb2Jfc3RhdHVzID0gc2VsZi5fcGVyZm9ybV9saWtlX2pvYihqb2JfbGluaykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVuG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCgogICAgICAgICAgICAjIFThuqFvIGvhur90IHF14bqjIHRy4bqjIHbhu4EgZOG7sWEgdHLDqm4gam9iX3N0YXR1cwogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHRfZnJvbV9zdGF0dXMoam9iX3N0YXR1cywgam9iX3R5cGUpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYjoge3N0cihlKX0iCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBtZXNzYWdlKQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoMiwgbWVzc2FnZSwgRmFsc2UpCiAgICAKICAgIGRlZiBfY3JlYXRlX2pvYl9yZXN1bHRfZnJvbV9zdGF0dXMoc2VsZiwgam9iX3N0YXR1czogaW50LCBqb2JfdHlwZTogc3RyKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBU4bqhbyBr4bq/dCBxdeG6oyBqb2IgdOG7qyBzdGF0dXMgY29kZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9zdGF0dXM6IE3DoyB0cuG6oW5nIHRow6FpIGpvYiB04burIF9wZXJmb3JtX3h4eF9qb2IKICAgICAgICAgICAgam9iX3R5cGU6IExv4bqhaSBqb2IgKGZvbGxvdywgbGlrZSkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEvhur90IHF14bqjIGpvYgogICAgICAgICIiIgogICAgICAgIGlmIGpvYl9zdGF0dXMgPT0gMTogICMgVGjDoG5oIGPDtG5nCiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIsSQw6MgaG/DoG4gdGjDoG5oIGpvYiB7am9iX3R5cGV9IHRow6BuaCBjw7RuZyIKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhtZXNzYWdlKQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoMSwgbWVzc2FnZSwgVHJ1ZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gMjogICMgS2jDtG5nIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZwogICAgICAgICAgICBtZXNzYWdlID0gZiJLaMO0bmcgdGjhu4MgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nIMSR4buDIHRo4buxYyBoaeG7h24gam9iIHtqb2JfdHlwZX0iCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcobWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDIsIG1lc3NhZ2UsIEZhbHNlKQogICAgICAgIGVsaWYgam9iX3N0YXR1cyA9PSAzOiAgIyBC4buLIHVuZm9sbG93L3VubGlrZQogICAgICAgICAgICBtZXNzYWdlID0gZiLEkOG7kWkgdMaw4bujbmcgxJHDoyBi4buLIHVuZm9sbG93L3VubGlrZSIKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhtZXNzYWdlKQogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB1bmZvbGxvdyDEkeG7gyBKb2JTZXJ2aWNlIHjhu60gbMO9CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgzLCBtZXNzYWdlLCBGYWxzZSwgdW5mb2xsb3c9VHJ1ZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gNDogICMgWcOqdSBj4bqndSDEkWFuZyBjaOG7nQogICAgICAgICAgICBtZXNzYWdlID0gZiJZw6p1IGPhuqd1IMSRYW5nIGNo4budIHRyb25nIGpvYiB7am9iX3R5cGV9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCg0LCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICBlbHNlOiAgIyBUaOG6pXQgYuG6oWkgaG/hurdjIHRy4bqhbmcgdGjDoWkga2jDoWMKICAgICAgICAgICAgbWVzc2FnZSA9IGYiVGjhu7FjIGhp4buHbiBqb2Ige2pvYl90eXBlfSB0aOG6pXQgYuG6oWkgduG7m2kgdHLhuqFuZyB0aMOhaSB7am9iX3N0YXR1c30iCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdChqb2Jfc3RhdHVzIGlmIGpvYl9zdGF0dXMgPiAwIGVsc2UgMCwgbWVzc2FnZSwgRmFsc2UpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3N0YXR1c19kaWFsb2coc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIGRpYWxvZyAiVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iIHbDoCB44butIGzDvSBu4bq/dSBjw7MKICAgICAgICBTYXUga2hpIGLhuqVtIE9LLCBraeG7g20gdHJhIHhlbSBjw7MgduG7gSB0cmFuZyBjaOG7pyBraMO0bmcgdsOgIHN5bmMgYWNjb3VudHMKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyBkaWFsb2cgdsOgIGPhuqduIG5n4burbmcgaG/huqF0IMSR4buZbmcgdMOgaSBraG/huqNuLCBGYWxzZSBu4bq/dSBraMO0bmcgY8OzIGRpYWxvZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDaOG7nSBt4buZdCBjaMO6dCDEkeG7gyBkaWFsb2cgY8OzIHRo4buDIHh14bqldCBoaeG7h24KICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gZGlhbG9nIGPDsyB0ZXh0ICJUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIKICAgICAgICAgICAgc3RhdHVzX2RpYWxvZyA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdGF0dXNfZGlhbG9nOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiUGjDoXQgaGnhu4duIGRpYWxvZyAnVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24nIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIGVsZW1lbnQgY8OzIHJlc291cmNlLWlkPSJhbmRyb2lkOmlkL21lc3NhZ2UiCiAgICAgICAgICAgICAgICBtZXNzYWdlX2VsZW1lbnQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQocmVzb3VyY2VfaWQ9ImFuZHJvaWQ6aWQvbWVzc2FnZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG1lc3NhZ2VfZWxlbWVudDoKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KG1lc3NhZ2VfZWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIlRow7RuZyBiw6FvIHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuOiB7bWVzc2FnZV90ZXh0fSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBMxrB1IHRow7RuZyBiw6FvIHbDoG8gZGF0YWJhc2UgaG/hurdjIGxvZwogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiQ1JJVElDQUw6IFTDoGkga2hv4bqjbiBi4buLIGjhuqFuIGNo4bq/IC0ge21lc3NhZ2VfdGV4dH0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVMOsbSB2w6AgY2xpY2sgbsO6dCBPSy/EkMOzbmcgxJHhu4MgxJHDs25nIGRpYWxvZwogICAgICAgICAgICAgICAgICAgIG9rX2NsaWNrZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIG9rX2J1dHRvbnMgPSBbIk9LIiwgIsSQw7NuZyIsICJUw7RpIGhp4buDdSIsICLEkOG7k25nIMO9Il0KICAgICAgICAgICAgICAgICAgICBmb3IgYnRuX3RleHQgaW4gb2tfYnV0dG9uczoKICAgICAgICAgICAgICAgICAgICAgICAgb2tfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9YnRuX3RleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG9rX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihva19idXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBi4bqlbSBuw7p0ICd7YnRuX3RleHR9JyDEkeG7gyDEkcOzbmcgZGlhbG9nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9rX2NsaWNrZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIG9rX2NsaWNrZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2jhu50gNSBnacOieSB2w6Aga2nhu4NtIHRyYSB0cmFuZyBjaOG7pyB0cm9uZyA1IGzhuqduCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkNo4budIDVzIHbDoCBraeG7g20gdHJhIHRyYW5nIGNo4bunIHRyb25nIDUgbOG6p24uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGhvbWVfc2NyZWVuX2RldGVjdGVkID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiS2nhu4NtIHRyYSB0cmFuZyBjaOG7pyBs4bqnbiB7YXR0ZW1wdCArIDF9LzUiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiDEkcOjIHbhu4EgdHJhbmcgY2jhu6cgLSBjw7Mga2jhuqMgbsSDbmcgdMOgaSBraG/huqNuIGLhu4sgbG9nb3V0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBob21lX3NjcmVlbl9kZXRlY3RlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBob21lX3NjcmVlbl9kZXRlY3RlZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBzeW5jIGFjY291bnRzIMSR4buDIGtp4buDbSB0cmEgYWNjb3VudCBjw7MgY8OybiB0cm9uZyBkYW5oIHPDoWNoIGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVGjhu7FjIGhp4buHbiBzeW5jIGFjY291bnRzIMSR4buDIGtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9kZXZpY2VfYWNjb3VudHMgPSBzZWxmLmdldF9hY2NvdW50c19mcm9tX2RldmljZSgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZXMgPSB7YWNjLmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkgZm9yIGFjYyBpbiBjdXJyZW50X2RldmljZV9hY2NvdW50c30KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIFRpa1RvayB04burIERCCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGJfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9c2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY8OhYyB0w6BpIGtob+G6o24gdHJvbmcgREIgY8OzIGPDsm4gdOG7k24gdOG6oWkgdHLDqm4gdGhp4bq/dCBi4buLIGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBkYl9hY2NvdW50IGluIGRiX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYl91c2VybmFtZSA9IGRiX2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIikubG93ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkYl91c2VybmFtZSBhbmQgZGJfdXNlcm5hbWUgbm90IGluIGN1cnJlbnRfdXNlcm5hbWVzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24ga2jDtG5nIGPDsm4gdOG7k24gdOG6oWkgdHLDqm4gdGhp4bq/dCBi4buLIC0gxJHDoW5oIGThuqV1IG5n4burbmcgaG/huqF0IMSR4buZbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge2RiX2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0ga2jDtG5nIGPDsm4gdHJvbmcgZGFuaCBzw6FjaCB0aGnhur90IGLhu4sgLSDEkcOhbmggZOG6pXUgbmfhu6tuZyBob+G6oXQgxJHhu5luZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiaW5hY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZW5hYmxlIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInJlYXNvbiI6ICJUw6BpIGtob+G6o24gYuG7iyBsb2cgb3V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoZGJfYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyDEkcOhbmggZOG6pXUgdMOgaSBraG/huqNuIHtkYl9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IG5n4burbmcgaG/huqF0IMSR4buZbmcgduG7m2kgbMO9IGRvOiBUw6BpIGtob+G6o24gYuG7iyBsb2cgb3V0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFN5bmMgbOG6oWkgYWNjb3VudHMgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBzeW5jX2Vycm9yOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihzeW5jX2Vycm9yLCAiTOG7l2kga2hpIHN5bmMgYWNjb3VudHMgc2F1IGtoaSBwaMOhdCBoaeG7h24gZGlhbG9nIHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJUw6xtIHRo4bqleSBkaWFsb2cgJ1Ry4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuJyBuaMawbmcga2jDtG5nIHTDrG0gdGjhuqV5IG1lc3NhZ2UiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraeG7g20gdHJhIGRpYWxvZyB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfcGVyZm9ybV9mb2xsb3dfam9iKHNlbGYsIHByb2ZpbGVfbGluazogc3RyKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBqb2IgZm9sbG93IHRyw6puIFRpa1RvawogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHByb2ZpbGVfbGluazogTGluayDEkeG6v24gdHJhbmcgY8OhIG5ow6JuIGPhuqduIGZvbGxvdyAoZOG6oW5nOiBodHRwczovL3d3dy50aWt0b2suY29tL0B1c2VybmFtZSkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUcuG6oW5nIHRow6FpIGpvYiAoMDogY2jGsGEgbMOgbSwgMTogaG/DoG4gdGjDoG5oLCAyOiBs4buXaSwgMzogYuG7iyB1bmZvbGxvdywgNDogecOqdSBj4bqndSBjaOG7nSwgNTogZ+G7rWkgecOqdSBj4bqndSkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUcsOtY2ggeHXhuqV0IHVzZXJuYW1lIHThu6sgVVJMIFRpa1RvayDEkeG7gyBz4butIGThu6VuZyBjaG8gbG9nZ2luZwogICAgICAgICAgICB1c2VybmFtZV9tYXRjaCA9IHJlLnNlYXJjaChyJ3Rpa3Rva1wuY29tL0AoW14vP10rKScsIHByb2ZpbGVfbGluaykKICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lX21hdGNoOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgdHLDrWNoIHh14bqldCB1c2VybmFtZSB04burIGxpbms6IHtwcm9maWxlX2xpbmt9IikKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdXNlcm5hbWUgPSB1c2VybmFtZV9tYXRjaC5ncm91cCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIHRyYW5nIGPDoSBuaMOibgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fb3Blbl9wcm9maWxlX3BhZ2UocHJvZmlsZV9saW5rKToKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4budIHRow6ptIGNobyB0cmFuZyBo4buTIHPGoSB04bqjaSB4b25nCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgRm9sbG93IHRoZW8gY8OhYyBjw6FjaCBraMOhYyBuaGF1CiAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBOb25lCiAgICAgICAgICAgICMgTOG6pXkgWE1MIG3hu5l0IGzhuqduIMSR4buDIHNvIHPDoW5oCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQoKICAgICAgICAgICAgIyBDw6FjaCAxOiBUw6xtIHRoZW8gdGV4dCB0aeG6v25nIFZp4buHdCB2w6AgdGnhur9uZyBBbmgKICAgICAgICAgICAgZm9sbG93X3RleHRzID0gWyJUaGVvIGTDtWkiLCAiRm9sbG93IiwgIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciLCAixJDDoyB5w6p1IGPhuqd1IiwgIlJlcXVlc3RlZCIsIkfhu61pIPCfkYsiXQogICAgICAgICAgICBmb3IgdGV4dCBpbiBmb2xsb3dfdGV4dHM6CiAgICAgICAgICAgICAgICBmb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCB0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICBpZiBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAjIEPDoWNoIDI6IFTDrG0gdGhlbyBjb250ZW50LWRlc2MgbuG6v3UgY2jGsGEgdMOsbSB0aOG6pXkKICAgICAgICAgICAgaWYgbm90IGZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBmb2xsb3dfZGVzY3MgPSBbIlRoZW8gZMO1aSIsICJGb2xsb3ciLCAixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyJdCiAgICAgICAgICAgICAgICBmb3IgZGVzYyBpbiBmb2xsb3dfZGVzY3M6CiAgICAgICAgICAgICAgICAgICAgZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPWRlc2MpCiAgICAgICAgICAgICAgICAgICAgaWYgZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu60gbOG6oWkgbOG6p24gbuG7r2EgbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgZm9sbG93CiAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgdGhlbyBkw7VpIOG7nyBs4bqnbiDEkeG6p3UsIHRo4butIHZ14buRdCBtw6BuIGjDrG5oIHbDoCB0w6xtIGzhuqFpIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxLjUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAgICAgIyBUaOG7rSBs4bqhaSB04bqldCBj4bqjIGPDoWMgY8OhY2gKICAgICAgICAgICAgICAgIGZvciB0ZXh0IGluIGZvbGxvd190ZXh0czoKICAgICAgICAgICAgICAgICAgICBmb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCB0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICAgICAgaWYgZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IHRoZW8gZMO1aSBzYXUgbmhp4buBdSBs4bqnbiB0aOG7rSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0ZXh0IGPhu6dhIG7DunQKICAgICAgICAgICAgYnV0dG9uX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KGZvbGxvd19idXR0b24pCiAgICAgICAgICAgIGJ1dHRvbl9yZXNvdXJjZV9pZCA9IGZvbGxvd19idXR0b24uZ2V0KCJyZXNvdXJjZS1pZCIsICIiKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGV4dCBj4bunYSBuw7p0IGZvbGxvdzogJ3tidXR0b25fdGV4dH0nLCByZXNvdXJjZS1pZDogJ3tidXR0b25fcmVzb3VyY2VfaWR9JyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIiwiR+G7rWkg8J+RiyJdOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgdGhlbyBkw7VpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IHThu6sgdHLGsOG7m2MiKQogICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGJ1dHRvbl90ZXh0IGluIFsixJDDoyB5w6p1IGPhuqd1IiwgIlJlcXVlc3RlZCJdOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgecOqdSBj4bqndSB0aGVvIGTDtWkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdOG7qyB0csaw4bubYyIpCiAgICAgICAgICAgICAgICByZXR1cm4gNQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBsw6AgIlRoZW8gZMO1aSIgaG/hurdjICJGb2xsb3ciIHRow6wgY2xpY2sgdsOgbyBuw7p0CiAgICAgICAgICAgIGlmIGJ1dHRvbl90ZXh0IGluIFsiVGhlbyBkw7VpIiwgIkZvbGxvdyJdOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVGjhu7FjIGhp4buHbiBjbGljayB2w6BvIG7DunQgdGhlbyBkw7VpIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGZvbGxvd19idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyAiVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jaGVja19hY2NvdW50X3N0YXR1c19kaWFsb2coKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiVMOgaSBraG/huqNuIGLhu4sgaOG6oW4gY2jhur8sIG5n4burbmcgaG/huqF0IMSR4buZbmcgdsOgIGjhu6d5IGpvYiIpCiAgICAgICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIG5n4burbmcgaG/huqF0IMSR4buZbmcKICAgICAgICAgICAgICAgICAgICAjIFRy4bqjIHbhu4Egc3RhdHVzIDIgxJHhu4MgYsOhbyBs4buXaSB2w6AgaOG7p3kgam9iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWdeG7kXQgeHXhu5FuZyAxIGzhuqduIMSR4buDIHJlZnJlc2ggdHLhuqFuZyB0aMOhaQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfZG93bigpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIGRpYWxvZyBoaeG7h24gbMOqbiBraMO0bmcKICAgICAgICAgICAgICAgICMgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICAjIGlmIHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICAjICAgICAjIEtp4buDbSB0cmEgZGlhbG9nIGPhuqNuaCBiw6FvIGhv4bq3YyBnaeG7m2kgaOG6oW4KICAgICAgICAgICAgICAgICMgICAgIGRpYWxvZ3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoc2NyZWVuX3htbCwgY2xhc3NfbmFtZT0iYW5kcm9pZC5hcHAuRGlhbG9nIikKICAgICAgICAgICAgICAgICMgICAgIGZvciBkaWFsb2cgaW4gZGlhbG9nczoKICAgICAgICAgICAgICAgICMgICAgICAgICBkaWFsb2dfdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQoZGlhbG9nKQogICAgICAgICAgICAgICAgIyAgICAgICAgIGlmIGFueShrZXl3b3JkIGluIGRpYWxvZ190ZXh0Lmxvd2VyKCkgZm9yIGtleXdvcmQgaW4gWyJ0aOG7rSBs4bqhaSBzYXUiLCAiZ2nhu5tpIGjhuqFuIiwgImxpbWl0IiwgInRyeSBhZ2FpbiJdKToKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgIyBUw6xtIHbDoCBuaOG6pW4gbsO6dCBPSy/EkMOzbmcKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgb2tfYnV0dG9ucyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbChzY3JlZW5feG1sLCBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5CdXR0b24iKQogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBmb3IgYnRuIGluIG9rX2J1dHRvbnM6CiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICBidG5fdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQoYnRuKQogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgaWYgYnRuX3RleHQgYW5kIGJ0bl90ZXh0Lmxvd2VyKCkgaW4gWyJvayIsICLEkcOzbmciLCAidMO0aSBoaeG7g3UiLCAixJHhu5NuZyDDvSJdOgogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihidG4pCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiSm9iIGtow7RuZyBob8OgbiB0aMOgbmgsIGLhu4sgZ2nhu5tpIGjhuqFuIHRoZW8gZMO1aSIpCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIHJldHVybiAzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB0ZXh0IHNhdSBraGkgbmjhuqVuIHRoZW8gZMO1aQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBs4bqhaSBuw7p0IGZvbGxvdyDEkeG7gyBraeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgLSDGsHUgdGnDqm4gdGhlbyByZXNvdXJjZS1pZCBu4bq/dSBjw7MKICAgICAgICAgICAgICAgIHVwZGF0ZWRfZm9sbG93X2J1dHRvbiA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBjw7MgcmVzb3VyY2VfaWQsIHTDrG0gdGhlbyByZXNvdXJjZV9pZCB0csaw4bubYwogICAgICAgICAgICAgICAgaWYgYnV0dG9uX3Jlc291cmNlX2lkOgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChyZXNvdXJjZV9pZD1idXR0b25fcmVzb3VyY2VfaWQpCiAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlZF9mb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIGzhuqFpIG7DunQgZm9sbG93IHRoZW8gcmVzb3VyY2UtaWQ6IHtidXR0b25fcmVzb3VyY2VfaWR9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkgdGhlbyByZXNvdXJjZV9pZCBob+G6t2Mga2jDtG5nIGPDsyByZXNvdXJjZV9pZCwgdMOsbSB0aGVvIHRleHQKICAgICAgICAgICAgICAgIGlmIG5vdCB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgZm9sbG93X3RleHRzID0gWyLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIiwgIsSQw6MgecOqdSBj4bqndSIsICJSZXF1ZXN0ZWQiLCAiVGhlbyBkw7VpIiwgIkZvbGxvdyJdCiAgICAgICAgICAgICAgICAgICAgZm9yIHRleHQgaW4gZm9sbG93X3RleHRzOgogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2ZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD10ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiB0w6xtIHRoZW8gY29udGVudC1kZXNjCiAgICAgICAgICAgICAgICBpZiBub3QgdXBkYXRlZF9mb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIGZvbGxvd19kZXNjcyA9IFsiVGhlbyBkw7VpIiwgIkZvbGxvdyIsICLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIl0KICAgICAgICAgICAgICAgICAgICBmb3IgZGVzYyBpbiBmb2xsb3dfZGVzY3M6CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9ZGVzYykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlZF9mb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgdXBkYXRlZF9mb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQodXBkYXRlZF9mb2xsb3dfYnV0dG9uKQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfcmVzb3VyY2VfaWQgPSB1cGRhdGVkX2ZvbGxvd19idXR0b24uZ2V0KCJyZXNvdXJjZS1pZCIsICIiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJTYXUga2hpIGNsaWNrIGZvbGxvdzogdGV4dD0ne3VwZGF0ZWRfdGV4dH0nLCByZXNvdXJjZS1pZD0ne3VwZGF0ZWRfcmVzb3VyY2VfaWR9JyIpCiAgICAgICAgICAgICAgICAgICAgIyBUcmltIHdoaXRlc3BhY2UgdOG7qyB1cGRhdGVkX3RleHQKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX3RleHQgPSB1cGRhdGVkX3RleHQuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjw6FjIHRyxrDhu51uZyBo4bujcCBraMOhYyBuaGF1CiAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlZF90ZXh0IGluIFsixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyIsICJOaOG6r24gdGluIiwgIk1lc3NhZ2UiLCJH4butaSDwn5GLIl06CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkZvbGxvdyB0aMOgbmggY8O0bmchIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgICAgICAgICBlbGlmIHVwZGF0ZWRfdGV4dCBpbiBbIsSQw6MgecOqdSBj4bqndSIsICJSZXF1ZXN0ZWQiXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBn4butaSB5w6p1IGPhuqd1IHRoZW8gZMO1aSB0aMOgbmggY8O0bmchIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDUKICAgICAgICAgICAgICAgICAgICBlbGlmIHVwZGF0ZWRfdGV4dCBpbiBbIlRoZW8gZMO1aSIsICJGb2xsb3ciXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJGb2xsb3cga2jDtG5nIHRow6BuaCBjw7RuZywgdGV4dCBj4bunYSBuw7p0IHbhuqtuIGzDoDoge3VwZGF0ZWRfdGV4dH0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMwogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRm9sbG93IGtow7RuZyB0aMOgbmggY8O0bmcsIHRleHQgY+G7p2EgbsO6dCBsw6A6IHt1cGRhdGVkX3RleHR9IikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDMKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCwgY8OzIHRo4buDIMSRw6MgZm9sbG93IHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGZvbGxvdyBzYXUga2hpIG5o4bqlbiwgZ2nhuqMgxJHhu4tuaCDEkcOjIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiVGV4dCBj4bunYSBuw7p0IGtow7RuZyBraOG7m3AgduG7m2kgJ1RoZW8gZMO1aScgaG/hurdjICdGb2xsb3cnOiB7YnV0dG9uX3RleHR9IikKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiBmb2xsb3c6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIDIKICAgIAogICAgZGVmIF9vcGVuX3Byb2ZpbGVfcGFnZShzZWxmLCBwcm9maWxlX2xpbms6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBN4bufIHRyYW5nIHByb2ZpbGUgVGlrVG9rIGLhurFuZyB0w6xtIGtp4bq/bSBob+G6t2MgbGluayB0cuG7sWMgdGnhur9wCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcHJvZmlsZV9saW5rOiBMaW5rIMSR4bq/biB0cmFuZyBjw6EgbmjDom4KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUcsOtY2ggeHXhuqV0IHVzZXJuYW1lIHThu6sgVVJMIFRpa1RvawogICAgICAgICAgICB1c2VybmFtZV9tYXRjaCA9IHJlLnNlYXJjaChyJ3Rpa3Rva1wuY29tL0AoW14vP10rKScsIHByb2ZpbGVfbGluaykKICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lX21hdGNoOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgdHLDrWNoIHh14bqldCB1c2VybmFtZSB04burIGxpbms6IHtwcm9maWxlX2xpbmt9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHVzZXJuYW1lID0gdXNlcm5hbWVfbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmFuZG9tIGNo4buNbiAxIHRyb25nIDIgY8OhY2g6IHTDrG0ga2nhur9tIGhv4bq3YyBt4bufIHRy4buxYyB0aeG6v3AgbGluawogICAgICAgICAgICBpZiByYW5kb20uY2hvaWNlKFtUcnVlLCBGYWxzZV0pOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk3hu58gdHJhbmcgY8OhIG5ow6JuIGLhurFuZyBjw6FjaCB0w6xtIGtp4bq/bToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAjIFRo4butIG3hu58gYuG6sW5nIHTDrG0ga2nhur9tCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fb3Blbl9wcm9maWxlX2J5X3NlYXJjaCh1c2VybmFtZSk6CiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSB0w6xtIGtp4bq/bSB0aOG6pXQgYuG6oWksIGZhbGxiYWNrIHNhbmcgbeG7nyBsaW5rCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSBraeG6v20gdGjhuqV0IGLhuqFpLCBt4bufIGLhurFuZyBsaW5rIHRy4buxYyB0aeG6v3AiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fdXJsKHByb2ZpbGVfbGluayxzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg0KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBDw6FjaCAyOiBN4bufIHRy4buxYyB0aeG6v3AgVVJMIHRow7RuZyBxdWEgaGVscGVyLm9wZW5fdXJsKCkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJN4bufIHRyYW5nIGPDoSBuaMOibiBi4bqxbmcgbGluayB0cuG7sWMgdGnhur9wOiB7cHJvZmlsZV9saW5rfSIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX3VybChwcm9maWxlX2xpbmssc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7nSB0aMOqbSBjaG8gdHJhbmcgaOG7kyBzxqEgdOG6o2kgeG9uZwogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyB2w6BvIMSRw7puZyBwcm9maWxlIGtow7RuZyBi4bqxbmcgY8OhY2ggdMOsbSBidXR0b24gY8OzIHRleHQgPSBAdXNlcm5hbWUKICAgICAgICAgICAgIyBUw6xtIGJ1dHRvbiBjw7MgdGV4dCBjaMOtbmggeMOhYyBi4bqxbmcgQHVzZXJuYW1lIChUaWtUb2sgbHXDtG4gY8OzIEAgdHLGsOG7m2MgdXNlcm5hbWUpCiAgICAgICAgICAgIGF0X3VzZXJuYW1lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5CdXR0b24iLCB0ZXh0PWYiQHt1c2VybmFtZX0iKQogICAgICAgICAgICBpZiBhdF91c2VybmFtZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB4w6FjIG5o4bqtbiB2w6BvIMSRw7puZyBwcm9maWxlIGPhu6dhIHt1c2VybmFtZX0gKHTDrG0gdGjhuqV5IGJ1dHRvbiBjw7MgdGV4dDogJ0B7dXNlcm5hbWV9JykiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGJ1dHRvbiBjw7MgdGV4dCA9ICdAe3VzZXJuYW1lfScgdHLDqm4gbcOgbiBow6xuaCwgY8OzIHRo4buDIGtow7RuZyB2w6BvIMSRw7puZyBwcm9maWxlIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSBt4bufIHRyYW5nIHByb2ZpbGU6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfb3Blbl9wcm9maWxlX2J5X3NlYXJjaChzZWxmLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE3hu58gdHJhbmcgcHJvZmlsZSBUaWtUb2sgYuG6sW5nIGPDoWNoIHTDrG0ga2nhur9tIHVzZXJuYW1lCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdXNlcm5hbWU6IFVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiBj4bqnbiB0w6xtCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSB0YWIgdMOsbSBraeG6v20gLSB0aOG7rSBwaMawxqFuZyBwaMOhcCB0cuG7sWMgdGnhur9wIHRyxrDhu5tjCiAgICAgICAgICAgIHNlYXJjaF90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJUw6xtIGtp4bq/bSIpCiAgICAgICAgICAgIGlmIHNlYXJjaF90YWI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSB0YWIgdMOsbSBraeG6v20gdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX3RhYikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdMOsbSB0aOG6pXksIGTDuW5nIHBoxrDGoW5nIHBow6FwIGFsdGVybmF0aXZlCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgdGFiIFTDrG0ga2nhur9tIHRy4buxYyB0aeG6v3AsIHRo4butIHBoxrDGoW5nIHBow6FwIGFsdGVybmF0aXZlIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBEdW1wIFhNTCBt4buZdCBs4bqnbiDEkeG7gyB44butIGzDvQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGR1bXAgWE1MIG3DoG4gaMOsbmgiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gY8OhYyB0ZXh0IHRoYXkgdGjhur8gdHJvbmcgWE1MCiAgICAgICAgICAgICAgICBhbHRlcm5hdGl2ZV90ZXh0cyA9IFsiQuG6oW4gYsOoIiwgIsSQYW5nIGZvbGxvdyIsICJEw6BuaCBjaG8gYuG6oW4iXQogICAgICAgICAgICAgICAgZm91bmRfZWxlbWVudCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIHRleHQgaW4gYWx0ZXJuYXRpdmVfdGV4dHM6CiAgICAgICAgICAgICAgICAgICAgZWxlbWVudCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPXRleHQpCiAgICAgICAgICAgICAgICAgICAgaWYgZWxlbWVudDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHRleHQgdGhhbSBjaGnhur91ICd7dGV4dH0nIHRyb25nIFhNTCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2VsZW1lbnQgPSBlbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBmb3VuZF9lbGVtZW50OgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgdGV4dCB0aGFtIGNoaeG6v3UgbsOgbyB0cm9uZyBYTUwiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gZWxlbWVudCBjaGEKICAgICAgICAgICAgICAgIHBhcmVudF9lbGVtZW50ID0gc2VsZi5oZWxwZXIuZmluZF9wYXJlbnRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgZm91bmRfZWxlbWVudCkKICAgICAgICAgICAgICAgIGlmIG5vdCBwYXJlbnRfZWxlbWVudDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IGVsZW1lbnQgY2hhIHRyb25nIFhNTCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGdyYW5kX2VsZW1lbnQgPSBzZWxmLmhlbHBlci5maW5kX3BhcmVudF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBwYXJlbnRfZWxlbWVudCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZ3JhbmRfZWxlbWVudDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB0w6xtIHRo4bqleSBncmFuZF9lbGVtZW50IHRyb25nIFhNTCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrW5oIHRvw6FuIHThu41hIMSR4buZIHbDoCBjbGljawogICAgICAgICAgICAgICAgYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGdyYW5kX2VsZW1lbnQpCiAgICAgICAgICAgICAgICB4MSwgeTEsIHgyLCB5MiA9IGJvdW5kcwogICAgICAgICAgICAgICAgeCA9IHgyICsgNTAKICAgICAgICAgICAgICAgIHkgPSAoeTEgKyB5MikgLy8gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOtbmggdG/DoW4gdOG7jWEgxJHhu5kgdGFiIHTDrG0ga2nhur9tOiB4PXt4fSwgeT17eX0gKHThu6sgYm91bmRzIGNoYToge2JvdW5kc30pIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBC4bqlbSB2w6BvIHThu41hIMSR4buZIMSRw6MgdMOtbmgKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcCh4LCB5KQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCgogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyB2w6BvIMSRxrDhu6NjIHRyYW5nIHTDrG0ga2nhur9tIGtow7RuZwogICAgICAgICAgICBzZWFyY2hfaW5wdXQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuRWRpdFRleHQiKQogICAgICAgICAgICBpZiBub3Qgc2VhcmNoX2lucHV0OgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB2w6BvIHRyYW5nIHTDrG0ga2nhur9tIC0ga2jDtG5nIHTDrG0gdGjhuqV5IMO0IG5o4bqtcCIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmjhuq1wIHVzZXJuYW1lIGPhuqduIHTDrG0KICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlYXJjaF9pbnB1dCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEuNSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgaMOgbSBpbnB1dF90ZXh0IG3hu5l0IGzhuqduIGR1eSBuaOG6pXQKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIG5o4bqtcCB0ZXh0OiAne3VzZXJuYW1lfSciKQogICAgICAgICAgICBzZWxmLmhlbHBlci5pbnB1dF90ZXh0KGYie3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNikKCiAgICAgICAgICAgICMgVMOsbSBuw7p0IFTDrG0ga2nhur9tIHbDoCBjbGljawogICAgICAgICAgICBzZWFyY2hfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIsIHRleHQ9IlTDrG0ga2nhur9tIikKICAgICAgICAgICAgaWYgc2VhcmNoX2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlTDrG0gdGjhuqV5IG7DunQgJ1TDrG0ga2nhur9tJywgxJFhbmcgY2xpY2suLi4iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlYXJjaF9idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0ICdUw6xtIGtp4bq/bSciKQogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHNlYXJjaCB24bubaSBlbnRlciBrZXkKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2VudGVyKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKSAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB0YWIgIk5nxrDhu51pIGTDuW5nIiB2w6AgY2xpY2sgdsOgbyBuw7MgLSDEkeG7o2kgdOG7kWkgxJFhIDEwcwogICAgICAgICAgICB1c2VyX3RhYiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQodGV4dD0iTmfGsOG7nWkgZMO5bmciLCB0aW1lb3V0PTEwKQogICAgICAgICAgICBpZiBub3QgdXNlcl90YWI6CiAgICAgICAgICAgICAgICB1c2VyX3RhYiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoY29udGVudF9kZXNjPSJOZ8aw4budaSBkw7luZyIsIHRpbWVvdXQ9NikKCiAgICAgICAgICAgIGlmIHVzZXJfdGFiOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgdGFiIE5nxrDhu51pIGTDuW5nLCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1c2VyX3RhYikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiBOZ8aw4budaSBkw7luZyBzYXUgMTBzIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gVGV4dFZpZXcgY8OzIHRleHQgY2jDrW5oIHjDoWMgYuG6sW5nIHVzZXJuYW1lIChraMO0bmcgY8OzIEApIC0gxJHhu6NpIHThu5FpIMSRYSA2cwogICAgICAgICAgICB1c2VybmFtZV9lbGVtZW50ID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PXVzZXJuYW1lLCBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5UZXh0VmlldyIsIHRpbWVvdXQ9NikKCiAgICAgICAgICAgIGlmIHVzZXJuYW1lX2VsZW1lbnQ6CiAgICAgICAgICAgICAgICAjIENsaWNrIHbDoG8gZWxlbWVudCDEkeG6p3UgdGnDqm4gdMOsbSDEkcaw4bujYwogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1c2VybmFtZV9lbGVtZW50KQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdHJvbmcga+G6v3QgcXXhuqMgdMOsbSBraeG6v20gc2F1IDEwcyIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHTDrG0ga2nhur9tIHTDoGkga2hv4bqjbjoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9wZXJmb3JtX2xpa2Vfam9iKHNlbGYsIHBvc3RfbGluazogc3RyKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBqb2IgbGlrZSB2aWRlbyB0csOqbiBUaWtUb2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwb3N0X2xpbms6IExpbmsgxJHhur9uIHZpZGVvIGPhuqduIGxpa2UKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUcuG6oW5nIHRow6FpIGpvYiAoMDogY2jGsGEgbMOgbSwgMTogaG/DoG4gdGjDoG5oLCAyOiBs4buXaSwgMzogxJHDoyBsaWtlIHRyxrDhu5tjIMSRw7MpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cKCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTeG7nyB2aWRlbyBUaWtUb2sgYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cDoge3Bvc3RfbGlua30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIHRy4buxYyB0aeG6v3AgVVJMIHRow7RuZyBxdWEgaGVscGVyLm9wZW5fdXJsKCkKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocG9zdF9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCgogICAgICAgICAgICAjIFJhbmRvbSBuZ2jhu4kgMy0xMCBnacOieSBuaMawIG5nxrDhu51pIGTDuW5nIHRow7RuZyB0aMaw4budbmcKICAgICAgICAgICAgd2FpdF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkGFuZyBuZ2jhu4kge3dhaXRfdGltZX1zIG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjDtG5nIHRoxrDhu51uZy4uLiIpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YWl0X3RpbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCBsaWtlIGLhurFuZyBjb250ZW50LWRlc2MgIlRow61jaCB2aWRlby4iCiAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgbGlrZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBsaWtlIHRyw6puIG3DoG4gaMOsbmgiKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiBuw7p0IGxpa2UgYmFuIMSR4bqndQogICAgICAgICAgICBpbml0aWFsX2NvbnRlbnRfZGVzYyA9IGxpa2VfYnV0dG9uLmdldCgiY29udGVudC1kZXNjIiwgIiIpCiAgICAgICAgICAgIGluaXRpYWxfcmVzb3VyY2VfaWQgPSBsaWtlX2J1dHRvbi5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgIGluaXRpYWxfc2VsZWN0ZWQgPSBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGxpa2VfYnV0dG9uKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRy4bqhbmcgdGjDoWkgbsO6dCBsaWtlIGJhbiDEkeG6p3U6IHNlbGVjdGVkPXtpbml0aWFsX3NlbGVjdGVkfSwgY29udGVudC1kZXNjPSd7aW5pdGlhbF9jb250ZW50X2Rlc2N9JywgcmVzb3VyY2UtaWQ9J3tpbml0aWFsX3Jlc291cmNlX2lkfSciKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IMSRw6MgbGlrZSB04burIHRyxrDhu5tjCiAgICAgICAgICAgIGlmIGluaXRpYWxfc2VsZWN0ZWQgb3IgIkLhu48gdGjDrWNoIiBpbiBpbml0aWFsX2NvbnRlbnRfZGVzYyBvciAiVW5saWtlIiBpbiBpbml0aWFsX2NvbnRlbnRfZGVzYzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlZpZGVvIMSRw6MgxJHGsOG7o2MgbGlrZSB04burIHRyxrDhu5tjIikKICAgICAgICAgICAgICAgIHJlc3VsdCA9IDMgICMgxJDDoyBsaWtlIHRyxrDhu5tjIMSRw7MKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBsaWtlIHZpZGVvCiAgICAgICAgICAgICAgICByZXN1bHQgPSBzZWxmLl9hdHRlbXB0X2xpa2VfdmlkZW8obGlrZV9idXR0b24pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdSBraGkgbGlrZSB4b25nLCB2deG7kXQgcmFuZG9tIDItNSB2aWRlbyBy4buTaSB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIGlmIHJlc3VsdCA9PSAxOiAgIyBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHNlbGYuX3Njcm9sbF92aWRlb3NfYW5kX3JldHVybl9ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gam9iIGxpa2U6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIDIKCiAgICBkZWYgX2ZpbmRfbGlrZV9idXR0b24oc2VsZik6CiAgICAgICAgIiIiVMOsbSBuw7p0IGxpa2UgdHLDqm4gdmlkZW8gVGlrVG9rIiIiCiAgICAgICAgIyBUaOG7rSBjw6FjIGPDoWNoIHTDrG0ga2jDoWMgbmhhdSBjaG8gbsO6dCBsaWtlCiAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJUaMOtY2giKQogICAgICAgIGlmIG5vdCBsaWtlX2J1dHRvbjoKICAgICAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJMaWtlIikKICAgICAgICBpZiBub3QgbGlrZV9idXR0b246CiAgICAgICAgICAgICMgVMOsbSB0aGVvIHJlc291cmNlLWlkIGhv4bq3YyB4cGF0aAogICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChyZXNvdXJjZV9pZD0iY29tLnNzLmFuZHJvaWQudWdjLnRyaWxsOmlkL2xpa2VfYnV0dG9uIikKICAgICAgICByZXR1cm4gbGlrZV9idXR0b24KCiAgICBkZWYgX2F0dGVtcHRfbGlrZV92aWRlbyhzZWxmLCBsaWtlX2J1dHRvbik6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiBsaWtlIHZpZGVvLCDGsHUgdGnDqm4gYuG6pW0gcmFuZG9tIHThu41hIMSR4buZLCBmYWxsYmFjayBzYW5nIGLhuqVtIG7DunQgbGlrZSIiIgogICAgICAgICMgTOG6pXkga8OtY2ggdGjGsOG7m2MgbcOgbiBow6xuaCDEkeG7gyB0w61uaCB04buNYSDEkeG7mSByYW5kb20KICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gc2VsZi5oZWxwZXIuZ2V0X3NjcmVlbl9zaXplKCkKICAgICAgICAKICAgICAgICAjIFRo4butIGLhuqVtIHJhbmRvbSB04buNYSDEkeG7mSB0csaw4bubYyAoZG91YmxlIGNsaWNrKQogICAgICAgIHggPSBpbnQod2lkdGggKiByYW5kb20udW5pZm9ybSgwLjUsIDAuNikpCiAgICAgICAgeSA9IGludChoZWlnaHQgKiByYW5kb20udW5pZm9ybSgwLjUsIDAuNikpCiAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRo4butIGRvdWJsZSBjbGljayB04bqhaSB04buNYSDEkeG7mSAoe3h9LCB7eX0pIMSR4buDIGxpa2UgdmlkZW8iKQogICAgICAgIAogICAgICAgICMgVGjhu7FjIGhp4buHbiBkb3VibGUgY2xpY2sKICAgICAgICBzZWxmLmhlbHBlci50YXAoeCwgeSkKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC4xKQogICAgICAgIHNlbGYuaGVscGVyLnRhcCh4LCB5KQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKSAgIyBDaOG7nSBhbmltYXRpb24KICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMgc2F1IGRvdWJsZSBjbGljawogICAgICAgIGlmIHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQw6MgdGjDrWNoIHZpZGVvIik6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgbGlrZSB2aWRlbyB0aMOgbmggY8O0bmcgYuG6sW5nIGRvdWJsZSBjbGljayIpCiAgICAgICAgICAgIHJldHVybiAxCgogICAgICAgIAogICAgICAgICMgTuG6v3UgZG91YmxlIGNsaWNrIGtow7RuZyB0aMOgbmggY8O0bmcsIGLhuqVtIHRy4buxYyB0aeG6v3AgdsOgbyBuw7p0IGxpa2UKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJEb3VibGUgY2xpY2sgY2jGsGEgbGlrZSDEkcaw4bujYywgYuG6pW0gdHLhu7FjIHRp4bq/cCB2w6BvIG7DunQgbGlrZSIpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBs4bqhaSB0aMO0bmcgdGluIG7DunQgbGlrZSBt4bubaSBuaOG6pXQKICAgICAgICBjdXJyZW50X2xpa2VfYnV0dG9uID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgaWYgbm90IGN1cnJlbnRfbGlrZV9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGxpa2UgxJHhu4MgYuG6pW0gdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgCiAgICAgICAgIyBC4bqlbSB2w6BvIG7DunQgbGlrZQogICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50KGN1cnJlbnRfbGlrZV9idXR0b24pCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGvhur90IHF14bqjIHNhdSBraGkgYuG6pW0gbsO6dAogICAgICAgIGxpa2VfYnV0dG9uX2ZpbmFsID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgaWYgbGlrZV9idXR0b25fZmluYWw6CiAgICAgICAgICAgIGlzX3NlbGVjdGVkX2ZpbmFsID0gc2VsZi5oZWxwZXIuaXNfZWxlbWVudF9zZWxlY3RlZChsaWtlX2J1dHRvbl9maW5hbCkKICAgICAgICAgICAgY29udGVudF9kZXNjX2ZpbmFsID0gbGlrZV9idXR0b25fZmluYWwuZ2V0KCJjb250ZW50LWRlc2MiLCAiIikKICAgICAgICAgICAgcmVzb3VyY2VfaWRfZmluYWwgPSBsaWtlX2J1dHRvbl9maW5hbC5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU2F1IGtoaSBi4bqlbSBuw7p0IGxpa2U6IHNlbGVjdGVkPXtpc19zZWxlY3RlZF9maW5hbH0sIGNvbnRlbnQtZGVzYz0ne2NvbnRlbnRfZGVzY19maW5hbH0nLCByZXNvdXJjZS1pZD0ne3Jlc291cmNlX2lkX2ZpbmFsfSciKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgaXNfc2VsZWN0ZWRfZmluYWwgb3IgIkLhu48gdGjDrWNoIiBpbiBjb250ZW50X2Rlc2NfZmluYWwgb3IgIlVubGlrZSIgaW4gY29udGVudF9kZXNjX2ZpbmFsOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBsaWtlIHZpZGVvIHRow6BuaCBjw7RuZyBi4bqxbmcgY2xpY2sgbsO6dCIpCiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGxpa2UgdmlkZW8gc2F1IGtoaSB0aOG7rSBj4bqjIDIgY8OhY2giKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEtow7RuZyB0w6xtIHRo4bqleSBuw7p0IMSR4buDIGtp4buDbSB0cmEsIGdp4bqjIMSR4buLbmggdGjDoG5oIGPDtG5nCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGxpa2UgxJHhu4Mga2nhu4NtIHRyYSwgZ2nhuqMgxJHhu4tuaCB0aMOgbmggY8O0bmciKQogICAgICAgICAgICByZXR1cm4gMQoKICAgIGRlZiBfc2Nyb2xsX3ZpZGVvc19hbmRfcmV0dXJuX2hvbWUoc2VsZik6CiAgICAgICAgIiIiVnXhu5F0IHJhbmRvbSAyLTUgdmlkZW8gcuG7k2kgduG7gSB0cmFuZyBjaOG7pyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSYW5kb20gc+G7kSBsxrDhu6NuZyB2aWRlbyBz4bq9IHZ14buRdCAoMi01KQogICAgICAgICAgICBudW1fdmlkZW9zID0gcmFuZG9tLnJhbmRpbnQoMiwgNSkKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlPhur0gdnXhu5F0IHF1YSB7bnVtX3ZpZGVvc30gdmlkZW8gdHLGsOG7m2Mga2hpIHbhu4EgdHJhbmcgY2jhu6ciKQogICAgICAgICAgICAKICAgICAgICAgICAgd2lkdGgsIGhlaWdodCA9IHNlbGYuaGVscGVyLmdldF9zY3JlZW5fc2l6ZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShudW1fdmlkZW9zKToKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlZ14buRdCB2aWRlbyB0aOG7qSB7aSsxfS97bnVtX3ZpZGVvc30iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSByYW5kb20gMi00IGdpw6J5IG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjhuq10CiAgICAgICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCgyLCA0KQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfdGltZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVuG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJIb8OgbiB0aMOgbmggdnXhu5F0IHZpZGVvLCDEkWFuZyBxdWF5IHbhu4EgdHJhbmcgY2jhu6ciKQogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdnXhu5F0IHZpZGVvOiB7c3RyKGUpfSIpCiAgICAgICAgICAgICMgVuG6q24gY+G7kSBn4bqvbmcgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgZGVmIGdldF9qb2JfcGFyYW1zKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aGFtIHPhu5EgxJHhu4MgZ+G7jWkgQVBJIGzhuqV5IGpvYiBjaG8gVGlrVG9rCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRoYW0gc+G7kQogICAgICAgICIiIgogICAgICAgIGdvbGlrZV9pZCA9IGFjY291bnQuZ2V0KCJnb2xpa2VfaWQiKQogICAgICAgIGlmIG5vdCBnb2xpa2VfaWQ6CiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAiYWNjb3VudF9pZCI6IGdvbGlrZV9pZCwKICAgICAgICAgICAgImRhdGEiOiAibnVsbCIKICAgICAgICB9CiAgICAgICAgCiAgICBkZWYgc3luY19hY2NvdW50c190b19kYihzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIHbDoG8gZGF0YWJhc2UKICAgICAgICBHaGkgxJHDqCBwaMawxqFuZyB0aOG7qWMgY+G7p2EgbOG7m3AgY2hhIMSR4buDIMSR4bqjbSBi4bqjbyBjaOG7iSBjw7MgbeG7mXQgdMOgaSBraG/huqNuIMSRxrDhu6NjIMSRw6FuaCBk4bqldSBsw6AgxJFhbmcgbG9naW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIFRpa1RvayB0cm9uZyBEQgogICAgICAgICAgICBzZWxmLmRiLnJlc2V0X2xvZ2luX3N0YXR1c19ieV9hcHAoc2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5nZXRfYWNjb3VudHNfZnJvbV9kZXZpY2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICBhbmRyb2lkX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIGhp4buHbiBjw7MgdHJvbmcgREIgY2hvIGFwcCBuw6B5CiAgICAgICAgICAgIGV4aXN0aW5nX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPXNlbGYuYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHNldCBjw6FjIHVuaXF1ZV91c2VybmFtZSB04burIHRoaeG6v3QgYuG7iyDEkeG7gyBk4buFIHNvIHPDoW5oCiAgICAgICAgICAgIGRldmljZV91c2VybmFtZXMgPSBzZXQoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX3VzZXJuYW1lcy5hZGQodXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIHRyb25nIERCIG3DoCBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4sgLT4gxJHDoW5oIGThuqV1IGxvZ291dAogICAgICAgICAgICBmb3IgZXhpc3RpbmdfYWNjb3VudCBpbiBleGlzdGluZ19hY2NvdW50czoKICAgICAgICAgICAgICAgIGV4aXN0aW5nX3VzZXJuYW1lID0gZXhpc3RpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiBleGlzdGluZ191c2VybmFtZSBhbmQgZXhpc3RpbmdfdXNlcm5hbWUgbm90IGluIGRldmljZV91c2VybmFtZXM6CiAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24gY8OzIHRyb25nIERCIG5oxrBuZyBraMO0bmcgY8OzIHRyw6puIHRoaeG6v3QgYuG7iyAtPiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgIT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2V4aXN0aW5nX3VzZXJuYW1lfSBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4ssIMSRw6FuaCBk4bqldSBsb2dvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGV4aXN0aW5nX2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGhv4bq3YyB0aMOqbSBt4bubaSB2w6BvIERCCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGRldmljZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICMgVGjDqm0gdGjDtG5nIHRpbiBhcHAgdsOgIGRldmljZV9pZAogICAgICAgICAgICAgICAgYWNjb3VudFsiYXBwIl0gPSBzZWxmLmFwcF9uYW1lCiAgICAgICAgICAgICAgICBhY2NvdW50WyJkZXZpY2VfaWQiXSA9IGFuZHJvaWRfaWQKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kgxJHhu4MgZ+G7rWkgbMOqbiBzZXJ2ZXIKICAgICAgICAgICAgICAgIGFjY291bnRbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSBjaMawYSBk4buxYSB2w6BvIHVuaXF1ZV91c2VybmFtZSArIGFwcAogICAgICAgICAgICAgICAgZXhpc3RpbmdfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnRfYnlfdW5pcXVlX3VzZXJuYW1lKHNlbGYuYXBwX25hbWUsIGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZXhpc3RpbmdfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gaGnhu4duIGPDsyAtIGNo4buJIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGxvZ2luL2xvZ291dAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBleGlzdGluZ19hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3UgY+G6rXAgbmjhuq10IHThu5FpIHRoaeG7g3UKICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBhY2NvdW50LmdldCgibGFzdF91cGRhdGUiLCBpbnQodGltZS50aW1lKCkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgdMOgaSBraG/huqNuIHRyb25nIERCIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGxvZ291dCBuaMawbmcgeHXhuqV0IGhp4buHbiBs4bqhaSB0csOqbiB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgPT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdOG7qyBsb2dvdXQgduG7gSBhY3RpdmUgdsOgIHjDs2EgaW5hY3RpdmVfcmVhc29uCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJzdGF0dXMiXSA9ICJhY3RpdmUiCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJpbmFjdGl2ZV9yZWFzb24iXSA9ICIiCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJHDoyB4deG6pXQgaGnhu4duIGzhuqFpIHRyw6puIHRoaeG6v3QgYuG7iywgcmVzZXQgdOG7qyBsb2dvdXQgduG7gSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBhY3RpdmUgdGjDrCBnaeG7ryBuZ3V5w6puIHN0YXR1cywga2jDtG5nIHRoYXkgxJHhu5VpIGfDrCBraMOhYwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHRyb25nIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVGjDqm0gdMOgaSBraG/huqNuIG3hu5tpIHbhu5tpIHRy4bqhbmcgdGjDoWkgYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudFsic3RhdHVzIl0gPSAiYWN0aXZlIgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuYWRkX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0aMOqbSB0w6BpIGtob+G6o24gbeG7m2kge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gY2hvIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9hY2NvdW50cwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFtdCgogICAgZGVmIG1hcF9nb2xpa2VfYWNjb3VudHMoc2VsZiwgZ29saWtlX2FjY291bnRzOiBMaXN0W0RpY3Rbc3RyLCBBbnldXSwgZGV2aWNlX2FjY291bnRzOiBMaXN0W0RpY3Rbc3RyLCBBbnldXSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgw4FuaCB44bqhIHTDoGkga2hv4bqjbiB04burIEdvTGlrZSB2w6BvIHTDoGkga2hv4bqjbiB0csOqbiB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBnb2xpa2VfYWNjb3VudHM6IERhbmggc8OhY2ggdMOgaSBraG/huqNuIHThu6sgR29MaWtlIEFQSQogICAgICAgICAgICBkZXZpY2VfYWNjb3VudHM6IERhbmggc8OhY2ggdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyDDoW5oIHjhuqEKICAgICAgICAiIiIKICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3UgdOG7qyBHb0xpa2UKICAgICAgICAgICAgZ29saWtlX2RhdGEgPSB7fQogICAgICAgICAgICBmb3IgYWNjIGluIGdvbGlrZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICMgVHLDrWNoIHh14bqldCB0aMO0bmcgdGluIHThu6sgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICAgICAgZ29saWtlX2FjY291bnQgPSB7CiAgICAgICAgICAgICAgICAgICAgImdvbGlrZV9pZCI6IGFjYy5nZXQoImlkIiksCiAgICAgICAgICAgICAgICAgICAgIm5pY2tuYW1lIjogYWNjLmdldCgibmlja25hbWUiKSwKICAgICAgICAgICAgICAgICAgICAidW5pcXVlX2lkIjogYWNjLmdldCgidW5pcXVlX2lkIiksCiAgICAgICAgICAgICAgICAgICAgInVuaXF1ZV91c2VybmFtZSI6IGFjYy5nZXQoInVuaXF1ZV91c2VybmFtZSIpLAogICAgICAgICAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBhY2MuZ2V0KCJhdmF0YXJfdGh1bWIiKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIHVuaXF1ZV91c2VybmFtZSBsw6BtIGtow7NhIMSR4buDIGThu4Ugw6FuaCB44bqhCiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGdvbGlrZV9hY2NvdW50WyJ1bmlxdWVfdXNlcm5hbWUiXQogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgZ29saWtlX2RhdGFbdXNlcm5hbWUubG93ZXIoKV0gPSBnb2xpa2VfYWNjb3VudAogICAgICAgICAgICAKICAgICAgICAgICAgIyDDgW5oIHjhuqEgduG7m2kgdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBmb3IgZGV2aWNlX2FjY291bnQgaW4gZGV2aWNlX2FjY291bnRzOgogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBkZXZpY2VfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lIGluIGdvbGlrZV9kYXRhOgogICAgICAgICAgICAgICAgICAgICMgxJDDoyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gdHJvbmcgZGFuaCBzw6FjaCBHb0xpa2UKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHThu6sgR29MaWtlIHbDoG8gdMOgaSBraG/huqNuIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgICAgIGdvbGlrZV9pbmZvID0gZ29saWtlX2RhdGFbdXNlcm5hbWVdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICAiZ29saWtlX2lkIjogZ29saWtlX2luZm9bImdvbGlrZV9pZCJdLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfZ29saWtlX2xpbmtlZCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBnb2xpa2VfaW5mb1siYXZhdGFyX3RodW1iIl0gb3IgZGV2aWNlX2FjY291bnQuZ2V0KCJhdmF0YXJfdGh1bWIiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBnb2xpa2VfaW5mb1sidW5pcXVlX2lkIl0gb3IgZGV2aWNlX2FjY291bnQuZ2V0KCJ1bmlxdWVfaWQiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIElEIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBkZXZpY2VfYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHbDoG8gZGV2aWNlX2FjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2FjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMuYXBwZW5kKGRldmljZV9hY2NvdW50KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6Mgw6FuaCB44bqhIHTDoGkga2hv4bqjbiBUaWtUb2s6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIG1hcHBlZF9hY2NvdW50cwogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSDDoW5oIHjhuqEgdMOgaSBraG/huqNuIFRpa1RvayIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgX25hdmlnYXRlX3RvX3Byb2ZpbGVfdGFiKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJBp4buBdSBoxrDhu5tuZyDEkeG6v24gdGFiIGjhu5Mgc8ahIFRpa1RvawogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHbDoCBi4bqlbSB2w6BvIG7DunQgIkjhu5Mgc8ahIgogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgcHJvZmlsZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iSOG7kyBzxqEiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHByb2ZpbGVfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IEjhu5Mgc8ahIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihwcm9maWxlX2J1dHRvbikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGRpYWxvZyAiS2jDtG5nIGNobyBwaMOpcCIgbuG6v3UgY8OzCiAgICAgICAgICAgIG5vdF9hbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iS2jDtG5nIGNobyBwaMOpcCIpCiAgICAgICAgICAgIGlmIG5vdF9hbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gZGlhbG9nICdLaMO0bmcgY2hvIHBow6lwJywgxJFhbmcgY2xpY2sgxJHhu4MgxJHDs25nLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihub3RfYWxsb3dfYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGRpYWxvZyAiTMawdSBs4bqhaSDEkcSDbmcgbmjhuq1wIGzhuqduIHNhdSIgbuG6v3UgY8OzCiAgICAgICAgICAgIHNhdmVfbG9naW5fYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IkzGsHUgdGjDtG5nIHRpbiDEkcSDbmcgbmjhuq1wIikKICAgICAgICAgICAgaWYgc2F2ZV9sb2dpbl9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gZGlhbG9nICdMxrB1IGzhuqFpIMSRxINuZyBuaOG6rXAgbOG6p24gc2F1JywgxJFhbmcgY2xpY2sgxJHhu4MgxJHDs25nLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzYXZlX2xvZ2luX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQoKCiAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gMSBs4bqnbiDEkeG7gyB04bqjaSDEkeG6p3kgxJHhu6cgbuG7mWkgZHVuZwogICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMSRaeG7gXUgaMaw4bubbmcgxJHhur9uIHRhYiBo4buTIHPGoSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX29wZW5fcHJvZmlsZV9tZW51KHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTeG7nyBtZW51IGjhu5Mgc8ahIChkYW5oIHPDoWNoIHTDoGkga2hv4bqjbikKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFZ14buRdCBsw6puIDEgbOG6p24gxJHhu4MgbMOgbSBt4bubaSBnaWFvIGRp4buHbiB0csaw4bubYyBraGkgdMOsbSBuw7p0IG1lbnUKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICMgVMOsbSBuw7p0IG1lbnUgaOG7kyBzxqEKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgIG1lbnVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9Ik1lbnUgaOG7kyBzxqEiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IG1lbnVfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IE1lbnUgaOG7kyBzxqEiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB04buNYSDEkeG7mSBj4bunYSBuw7p0IG1lbnUgdsOgIGNsaWNrIHbhu5tpIMSR4buZIGzhu4djaCBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgIGJvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhtZW51X2J1dHRvbikKICAgICAgICAgICAgeDEsIHkxLCB4MiwgeTIgPSBib3VuZHMKICAgICAgICAgICAgeSA9ICgoeTIgLSB5MSkgLy8gMikgKyB5MQogICAgICAgICAgICB4ID0geDIgLy8gMgogICAgICAgICAgICB4ICs9IHJhbmRvbS5yYW5kaW50KC0xMCwgMTApCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmhlbHBlci50YXAoeCwgeSkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgogICAgICAgICAgICAjIGtp4buDbSB0cmEgZGlhbG9nIHRleHQ9IkZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4iCgogICAgICAgICAgICBmb2xsb3dfZnJpZW5kc19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iRm9sbG93IGLhuqFuIGLDqCBj4bunYSBi4bqhbiIpCiAgICAgICAgICAgIGlmIGZvbGxvd19mcmllbmRzX2RpYWxvZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgJ0ZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4nLCDEkWFuZyBjbGljayDEkeG7gyDEkcOzbmcuLi4iKQogICAgICAgICAgICAgICAgY2xvc2VfZGlhbG9nID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0ixJDDs25nIikKICAgICAgICAgICAgICAgIGlmIGNsb3NlX2RpYWxvZzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoY2xvc2VfZGlhbG9nKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBt4bufIG1lbnUgaOG7kyBzxqEiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgaXNfaG9tZV9zY3JlZW4oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcg4bufIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgVGlrVG9rIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJFhbmcg4bufIHRyYW5nIGNo4bunLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBwYWNrYWdlIGhp4buHbiB04bqhaSB0csaw4bubYyB0acOqbgogICAgICAgICAgICBjdXJyZW50X3BhY2thZ2UgPSBzZWxmLmhlbHBlci5nZXRfY3VycmVudF9wYWNrYWdlKCkKICAgICAgICAgICAgaWYgY3VycmVudF9wYWNrYWdlICE9IHNlbGYuYXBwX3BhY2thZ2U6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjw7MgbsO6dCAiVHJhbmcgY2jhu6ciIMSRxrDhu6NjIGNo4buNbiAoc2VsZWN0ZWQ9dHJ1ZSkgdHJvbmcgdGhhbmggdGFiIGtow7RuZwogICAgICAgICAgICBob21lX3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgaWYgaG9tZV90YWI6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGhvbWVfdGFiKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDrG0gdGjhuqV5IHRhYiAiVHJhbmcgY2jhu6ciIG5oxrBuZyBjaMawYSDEkcaw4bujYyBjaOG7jW4sIGNsaWNrIHbDoG8gxJHDswogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX3RhYikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMS41KQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jDtG5nIHTDrG0gdGjhuqV5IGPDoWMgeeG6v3UgdOG7kSBj4bunYSB0cmFuZyBjaOG7pwogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraeG7g20gdHJhIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBlbnN1cmVfaG9tZV9zY3JlZW4oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gxJFhbmcg4bufIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgVGlrVG9rCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpIHRyxrDhu5tjIHRpw6puCiAgICAgICAgICAgIGN1cnJlbnRfcGFja2FnZSA9IHNlbGYuaGVscGVyLmdldF9jdXJyZW50X3BhY2thZ2UoKQogICAgICAgICAgICBpZiBjdXJyZW50X3BhY2thZ2UgIT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJBcHAgaGnhu4duIHThuqFpICh7Y3VycmVudF9wYWNrYWdlfSkga2jDtG5nIHBo4bqjaSBUaWtUb2ssIG3hu58gYXBwIFRpa1Rvay4uLiIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEwKSAgIyBUxINuZyBsw6puIDEwIGdpw6J5IMSR4buDIGFwcCBraOG7n2kgxJHhu5luZyBob8OgbiB0b8OgbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgcG9wdXAgUElOIHRyb25nIDVzIHNhdSBraGkgbeG7nyBhcHAKICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX3Bpbl9wb3B1cCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVmFsaWRhdGUgYXBwIGtow7RuZyBi4buLIGJhbm5lZCBzYXUga2hpIG3hu58KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnZhbGlkYXRlX2FwcF9ub3RfYmFubmVkKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIkFwcCBUaWtUb2sgY8OzIHbhuqVuIMSR4buBIChiYW5uZWQvY+G6o25oIGLDoW8pIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQw7NuZyIsIHRpbWVvdXQ9MykKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIOG7nyB0cmFuZyBjaOG7pyBjaMawYQogICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIOG7nyB0cmFuZyBjaOG7pyBUaWtUb2siKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGNoxrBhLCBj4buRIGfhuq9uZyB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHJldHVybiBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgxJHhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiB2YWxpZGF0ZV9hcHBfbm90X2Jhbm5lZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBi4buLIGJhbm5lZAogICAgICAgICIiIgogICAgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgY+G6o25oIGLDoW8gY2h1bmcKICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAjIEtp4buDbSB0cmEgZGlhbG9nICJD4bqtcCBuaOG6rXQgQ2jDrW5oIHPDoWNoIHF1eeG7gW4gcmnDqm5nIHTGsCIKICAgICAgICBwcml2YWN5X3VwZGF0ZV9lbGVtZW50cyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgdGV4dD0iQ+G6rXAgbmjhuq10IENow61uaCBzw6FjaCBxdXnhu4FuIHJpw6puZyB0xrAiCiAgICAgICAgKQoKICAgICAgICBpZiBwcml2YWN5X3VwZGF0ZV9lbGVtZW50czoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIGRpYWxvZyAnQ+G6rXAgbmjhuq10IENow61uaCBzw6FjaCBxdXnhu4FuIHJpw6puZyB0xrAnLCDEkWFuZyB44butIGzDvS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCAixJDDoyBoaeG7g3UiIHbDoCBi4bqlbSB0cuG7sWMgdGnhur9wCiAgICAgICAgICAgIHVuZGVyc3RhbmRfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IsSQw6MgaGnhu4N1IikKICAgICAgICAgICAgaWYgdW5kZXJzdGFuZF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIodW5kZXJzdGFuZF9idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUaOG7rSB0w6xtIHbhu5tpIGPDoWMgdGV4dCBraMOhYwogICAgICAgICAgICAgICAgZm9yIHRleHQgaW4gWyJUaeG6v3AgdOG7pWMiLCAixJDhu5NuZyDDvSIsICJDb250aW51ZSIsICJBZ3JlZSIsICJDaOG6pXAgbmjhuq1uIiwgIkFjY2VwdCJdOgogICAgICAgICAgICAgICAgICAgIGJ1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICAgICAgaWYgYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyAiVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iCiAgICAgICAgYWNjb3VudF9zdGF0dXNfZWxlbWVudHMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgIHRleHQ9IlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIgogICAgICAgICkKCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXNfZWxlbWVudHM6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgxJHEg25nIHh14bqldCB0w6BpIGtob+G6o24uLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgY8OzIGlkIGzDoCBidXR0b24xIHbDoCBi4bqlbQogICAgICAgICAgICBidXR0b24xID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHJlc291cmNlX2lkPSJhbmRyb2lkOmlkL2J1dHRvbjEiKQogICAgICAgICAgICBpZiBidXR0b24xOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGJ1dHRvbjEpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMTApCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKCiAgICAgICAgIyBUw6xtIGRpYWxvZyBj4bqjbmggYsOhbyBi4bqxbmcgSUQgaG/hurdjIGNvbnRlbnQtZGVzYyBjw7MgY2jhu6lhICJj4bqjbmggYsOhbyIsICJs4buXaSIsICJ0aMO0bmcgYsOhbyIKICAgICAgICBhbGVydF9kaWFsb2dzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkLmFwcC5EaWFsb2ciCiAgICAgICAgKQogICAgICAgIAogICAgICAgIGZvciBkaWFsb2cgaW4gYWxlcnRfZGlhbG9nczoKICAgICAgICAgICAgIyBUw6xtIHRleHQgdHJvbmcgZGlhbG9nCiAgICAgICAgICAgIHRleHRfdmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuVGV4dFZpZXciCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciB0ZXh0X3ZpZXcgaW4gdGV4dF92aWV3czoKICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHRleHRfdmlldykKICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIGFueShrZXl3b3JkIGluIHRleHQubG93ZXIoKSBmb3Iga2V5d29yZCBpbiBbImPhuqNuaCBiw6FvIiwgImzhu5dpIiwgInRow7RuZyBiw6FvIiwgImLhu4sga2jDs2EiLCAidmkgcGjhuqFtIl0pOgogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCBj4bqjbmggYsOhbyBoaeG7h24gdOG6oWkgdOG7qyBkYgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfd2FybmluZ3MgPSBzZWxmLmRiLmdldCgibG9ncy13YXJuaW5nLW1lc3NhZ2UiLCBbXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRow6ptIGPhuqNuaCBiw6FvIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgY3VycmVudF93YXJuaW5ncy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAidGltZSI6IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAibWVzcyI6IHRleHQKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ2jhu4kgZ2nhu68gbOG6oWkgdOG7kWkgxJFhIDIwIGxvZyBn4bqnbiBuaOG6pXQKICAgICAgICAgICAgICAgICAgICBpZiBsZW4oY3VycmVudF93YXJuaW5ncykgPiAyMDoKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF93YXJuaW5ncyA9IGN1cnJlbnRfd2FybmluZ3NbLTIwOl0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgdsOgbyBkYgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsb2dzLXdhcm5pbmctbWVzc2FnZSIsIGN1cnJlbnRfd2FybmluZ3MpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIsSQw6MgbMawdSBj4bqjbmggYsOhbyBUaWtUb2s6IHt0ZXh0fSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIG7DunQgT0sgaG/hurdjIMSQw7NuZyDEkeG7gyDEkcOzbmcgZGlhbG9nCiAgICAgICAgICAgICAgICAgICAgYnV0dG9ucyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3IgYnV0dG9uIGluIGJ1dHRvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl90ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChidXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJ1dHRvbl90ZXh0IGFuZCBidXR0b25fdGV4dC5sb3dlcigpIGluIFsib2siLCAixJHDs25nIiwgInTDtGkgaGnhu4N1IiwgIsSR4buTbmcgw70iXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihidXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEPDsyBj4bqjbmggYsOhbyB0aMOsIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBjw7MgY+G6o25oIGLDoW8KICAgIAogICAgZGVmIF9oYW5kbGVfZGlhbG9nc19hbmRfbmF2aWdhdGVfaG9tZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBPdmVycmlkZSDEkeG7gyB44butIGzDvSBkaWFsb2cgc3BlY2lmaWMgY+G7p2EgVGlrVG9rIHbDoCBuYXZpZ2F0ZSB24buBIGhvbWUKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZygixJBhbmcgeOG7rSBsw70gVGlrVG9rIGRpYWxvZ3MgdsOgIG5hdmlnYXRlIHbhu4EgaG9tZS4uLiIpCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSBjw6FjIGRpYWxvZyBUaWtUb2sgc3BlY2lmaWMKICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGlhbG9nICJD4bqtcCBuaOG6rXQgQ2jDrW5oIHPDoWNoIHF1eeG7gW4gcmnDqm5nIHTGsCIKICAgICAgICB1bmRlcnN0YW5kX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSLEkMOjIGhp4buDdSIpCiAgICAgICAgaWYgdW5kZXJzdGFuZF9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw7NuZyBkaWFsb2cgJ8SQw6MgaGnhu4N1JyIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1bmRlcnN0YW5kX2J1dHRvbikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyAiTMawdSB0aMO0bmcgdGluIMSRxINuZyBuaOG6rXAiCiAgICAgICAgc2F2ZV9sb2dpbl9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iTMawdSB0aMO0bmcgdGluIMSRxINuZyBuaOG6rXAiKQogICAgICAgIGlmIHNhdmVfbG9naW5fYnV0dG9uOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOzbmcgZGlhbG9nICdMxrB1IHRow7RuZyB0aW4gxJHEg25nIG5o4bqtcCciKQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2F2ZV9sb2dpbl9idXR0b24pCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgIkZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4iCiAgICAgICAgY2xvc2VfZnJpZW5kc19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSLEkMOzbmciKQogICAgICAgIGlmIGNsb3NlX2ZyaWVuZHNfZGlhbG9nOgogICAgICAgICAgICBmb2xsb3dfZnJpZW5kc19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iRm9sbG93IGLhuqFuIGLDqCBj4bunYSBi4bqhbiIpCiAgICAgICAgICAgIGlmIGZvbGxvd19mcmllbmRzX2RpYWxvZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw7NuZyBkaWFsb2cgJ0ZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4nIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihjbG9zZV9mcmllbmRzX2RpYWxvZykKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgICAgICMgU2F1IGtoaSB44butIGzDvSBkaWFsb2csIHRo4butIG5hdmlnYXRlIHbhu4EgaG9tZQogICAgICAgIGlmIG5vdCBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICMgVMOsbSBuw7p0ICJUcmFuZyBjaOG7pyIKICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iVHJhbmcgY2jhu6ciKQogICAgICAgICAgICBpZiBub3QgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgaWYgbm90IGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iSG9tZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJC4bqlbSBuw7p0IFRyYW5nIGNo4bunIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogbmjhuqVuIGJhY2sgbeG7mXQgdsOgaSBs4bqnbgogICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMyk6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgZGVmIGJhY2tfdG9faG9tZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFF1YXkgduG7gSB0cmFuZyBjaOG7pyBUaWtUb2sgdOG7qyBi4bqldCBr4buzIG3DoG4gaMOsbmggbsOgbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nIHbhu4EgdHJhbmcgY2jhu6cKICAgICAgICAiIiIKICAgICAgICBtYXhfYXR0ZW1wdHMgPSA1CiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUXVheSB24buBIHRyYW5nIGNo4bunIFRpa1RvayIpCiAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UobWF4X2F0dGVtcHRzKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIOG7nyB0cmFuZyBjaOG7pyBjaMawYQogICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6Mg4bufIHRyYW5nIGNo4bunIFRpa1RvayIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duIHRoYW8gdMOhYwogICAgICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3BhY2thZ2UgIT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQXBwIGhp4buHbiB04bqhaSAoe2N1cnJlbnRfcGFja2FnZX0pIGtow7RuZyBwaOG6o2kgVGlrVG9rLCBt4bufIGzhuqFpIGFwcCBUaWtUb2suLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEwKSAgIyBUxINuZyBsw6puIDEwIGdpw6J5IMSR4buDIGFwcCBraOG7n2kgxJHhu5luZyBob8OgbiB0b8OgbgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSBzYXUga2hpIG3hu58gYXBwCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBuw7p0ICJUcmFuZyBjaOG7pyIg4bufIGJvdHRvbSBuYXZpZ2F0aW8KICAgICAgICAgICAgICAgIGhvbWVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgICAgIGlmIG5vdCBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgICAgIGlmIG5vdCBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJIb21lIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX2J1dHRvbikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgaG9tZSwgdGjhu60gbmjhuqVuIGJhY2sKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBj4buRIGfhuq9uZyB24buBIHRyYW5nIGNo4bunIChs4bqnbiB7YXR0ZW1wdCArIDF9KToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgcXVheSB24buBIHRyYW5nIGNo4bunIFRpa1RvayBzYXUgbmhp4buBdSBs4bqnbiB0aOG7rSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBzd2l0Y2hfYWNjb3VudChzZWxmLCB0YXJnZXRfYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIENodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1RvayBraMOhYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhcmdldF9hY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBib29sLAogICAgICAgICAgICAgICAgJ3JlYXNvbic6IHN0ciAobuG6v3UgdGjhuqV0IGLhuqFpKSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJzogc3RyCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0YXJnZXRfdXNlcm5hbWUgPSB0YXJnZXRfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1Rvazoge3RhcmdldF91c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBJbnZhbGlkYXRlIHVzZXJuYW1lIGNhY2hlIGtoaSBi4bqvdCDEkeG6p3Ugc3dpdGNoCiAgICAgICAgICAgIHNlbGYuaW52YWxpZGF0ZV91c2VybmFtZV9jYWNoZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cgKHJldHJ5IG1lY2hhbmlzbSkKICAgICAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMyk6ICAjIFRo4butIDMgbOG6p24KICAgICAgICAgICAgICAgIGlmIHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgYXR0ZW1wdCA9PSAyOiAgIyBM4bqnbiBjdeG7kWkgY8O5bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyDEkeG6v24gdHJhbmcgY2jhu6cgVGlrVG9rIHNhdSAzIGzhuqduIHRo4butIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICduYXZpZ2F0aW9uX2Vycm9yJywKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnS2jDtG5nIHRo4buDIMSR4bq/biB0cmFuZyBjaOG7pyBUaWtUb2sgc2F1IG5oaeG7gXUgbOG6p24gdGjhu60nCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVGjhu60gbOG6p24ge2F0dGVtcHQgKyAxfTogS2jDtG5nIHRo4buDIMSR4bq/biB0cmFuZyBjaOG7pywgdGjhu60gbOG6oWkuLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWw6BvIHRyYW5nIGjhu5Mgc8ahCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9uYXZpZ2F0ZV90b19wcm9maWxlX3RhYigpOgogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAncmVhc29uJzogJ25hdmlnYXRpb25fZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0aOG7gyB2w6BvIHRyYW5nIGjhu5Mgc8ahIFRpa1RvaycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgI2tp4buDbSB0cmEgxJHDum5nIHVzZXJuYW1lIHLhu5NpIHRow6wgcmV0dXJuIHRydWUKICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9ZiJAe3RhcmdldF91c2VybmFtZX0iKToKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogZiLEkMOjIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1Rvazoge3RhcmdldF91c2VybmFtZX0iCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAjIFZ14buRdCBsw6puIDEgbOG6p24KICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIG1lbnUgaOG7kyBzxqEKICAgICAgICAgICAgaWYgbm90IHNlbGYuX29wZW5fcHJvZmlsZV9tZW51KCk6CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAndWlfZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0aOG7gyBt4bufIG1lbnUgaOG7kyBzxqEgVGlrVG9rJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgYWRkX2FjY291bnRfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9IlRow6ptIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWRkX2FjY291bnRfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBtZW51IHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAndWlfZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0w6xtIHRo4bqleSBtZW51IHTDoGkga2hv4bqjbiBUaWtUb2snCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbgogICAgICAgICAgICBhY2NvdW50X2J1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICB0YXJnZXRfaXRlbSA9IE5vbmUKICAgICAgICAgICAgZm9yIGJ1dHRvbiBpbiBhY2NvdW50X2J1dHRvbnM6CiAgICAgICAgICAgICAgICBpZiBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiKSA9PSAiVGjDqm0gdMOgaSBraG/huqNuIiBvciBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiKSA9PSAixJDDs25nIjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiLCAiIikKICAgICAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICB0ZXh0dmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LlRleHRWaWV3IgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBidXR0b25fYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGJ1dHRvbikKICAgICAgICAgICAgICAgICAgICBmb3IgdHYgaW4gdGV4dHZpZXdzOgogICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHModHYpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dl9ib3VuZHNbMF0gPj0gYnV0dG9uX2JvdW5kc1swXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kc1sxXSA+PSBidXR0b25fYm91bmRzWzFdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzWzJdIDw9IGJ1dHRvbl9ib3VuZHNbMl0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHNbM10gPD0gYnV0dG9uX2JvdW5kc1szXSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dCh0dikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIHRleHQgIT0gIm51bGwiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICB0YXJnZXRfaXRlbSA9IGJ1dHRvbgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB0YXJnZXRfaXRlbToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGzDoCBi4buLIHbDtCBoaeG7h3UgaMOzYSB0cm9uZyBEQgogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudCh0YXJnZXRfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiZGlzYWJsZWQiLAogICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX3JlYXNvbiI6ICJUw6BpIGtob+G6o24ga2jDtG5nIGPDsyB0csOqbiB0aGnhur90IGLhu4siLAogICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOaOG6pW4gQmFjayDEkeG7gyDEkcOzbmcgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUXVheSB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdhY2NvdW50X25vdF9mb3VuZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ0tow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdHJvbmcgZGFuaCBzw6FjaCBUaWtUb2snCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBOaOG6pXAgdsOgbyB0w6BpIGtob+G6o24gbeG7pWMgdGnDqnUKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHRhcmdldF9pdGVtKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20KICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg2KTogICMgxJDhu6NpIGNodXnhu4NuIHTDoGkga2hv4bqjbiBob8OgbiB04bqldAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgZOG7q25nIHRyb25nIHN3aXRjaF90b19hY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdpbnRlcnJ1cHRlZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnQuG7iyBk4burbmcgdHJvbmcgcXXDoSB0csOsbmggY2h1eeG7g24gdMOgaSBraG/huqNuIFRpa1RvaycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBjaHV54buDbiB0w6BpIGtob+G6o24gdGjDoG5oIGPDtG5nIGNoxrBhCiAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBzZWxmLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGNodXnhu4NuIHTDoGkga2hv4bqjbiB0aMOgbmggY8O0bmcgc2FuZyB7dGFyZ2V0X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogVHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ8SQw6MgY2h1eeG7g24gdMOgaSBraG/huqNuIHRow6BuaCBjw7RuZyBzYW5nIHt0YXJnZXRfdXNlcm5hbWV9JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiLEkMOjIGLhuqVtIHbDoG8gdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IG5oxrBuZyBraeG7g20gdHJhIGzhuqFpIHRo4bqleSDEkWFuZyDEkcSDbmcgbmjhuq1wIGzDoCB7Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAncmVhc29uJzogJ3N3aXRjaF92ZXJpZmljYXRpb25fZmFpbGVkJywKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnxJDDoyBi4bqlbSB2w6BvIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSBuaMawbmcga2nhu4NtIHRyYSBs4bqhaSB0aOG6pXkgxJFhbmcgxJHEg25nIG5o4bqtcCBsw6Age2N1cnJlbnRfdXNlcm5hbWV9JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIHF1YXkgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAncmVhc29uJzogJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnTOG7l2kga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbiBUaWtUb2s6IHtzdHIoZSl9JwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgZGVmIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoKHNlbGYsIHRhcmdldF9hY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBjw6FjIHRoYW8gdMOhYyBVSSDEkeG7gyBjaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFyZ2V0X2FjY291bnQ6IFTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbiDEkeG6v24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IHsKICAgICAgICAgICAgICAgICdzdWNjZXNzJzogYm9vbCwKICAgICAgICAgICAgICAgICdyZWFzb24nOiBzdHIgKG7hur91IHRo4bqldCBi4bqhaSksCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IHN0cgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gc2VsZi5zd2l0Y2hfYWNjb3VudCh0YXJnZXRfYWNjb3VudCkKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzd2l0Y2hfcmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgIHJldHVybiBzd2l0Y2hfcmVzdWx0CiAgICAgICAgICAgIGVsaWYgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBUcnVlLCAnbWVzc2FnZSc6ICdDaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rIHRow6BuaCBjw7RuZyd9CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAnc3dpdGNoX2ZhaWxlZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnS2jDtG5nIHRo4buDIGNodXnhu4NuIHTDoGkga2hv4bqjbiBUaWtUb2snCiAgICAgICAgICAgICAgICB9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGNodXnhu4NuIHTDoGkga2hv4bqjbiBUaWtUb2siKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAncmVhc29uJzogJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnTOG7l2kga2hpIHRo4buxYyBoaeG7h24gY2h1eeG7g24gdMOgaSBraG/huqNuIFRpa1Rvazoge3N0cihlKX0nCiAgICAgICAgICAgIH0KICAgIAogICAgZGVmIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZShzZWxmKSAtPiBPcHRpb25hbFtzdHJdOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiBUaWtUb2sgxJFhbmcgxJHEg25nIG5o4bqtcCAoduG7m2kgY2FjaGUpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyIGhv4bq3YyBOb25lOiBVc2VybmFtZSBj4bunYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgaG/hurdjIE5vbmUgbuG6v3Uga2jDtG5nIGPDswogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGNhY2hlIHRyxrDhu5tjCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIGlmIChzZWxmLl9jYWNoZWRfdXNlcm5hbWUgYW5kIAogICAgICAgICAgICAgICAgY3VycmVudF90aW1lIC0gc2VsZi5fdXNlcm5hbWVfY2FjaGVfdGltZSA8IHNlbGYuX3VzZXJuYW1lX2NhY2hlX3R0bCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIlPhu60gZOG7pW5nIGNhY2hlZCB1c2VybmFtZToge3NlbGYuX2NhY2hlZF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhY2hlZF91c2VybmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFwcCBjw7MgxJFhbmcgbeG7nyBraMO0bmcgdHLGsOG7m2MKICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIkFwcCBUaWtUb2sgY2jGsGEgbeG7nywga2jDtG5nIHRo4buDIGzhuqV5IHVzZXJuYW1lIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICAjIEzGsHUgdHLhuqFuZyB0aMOhaSBoaeG7h24gdOG6oWkgKGtow7RuZyBmb3JjZSB24buBIGhvbWUgxJHhu4MgdHLDoW5oIGNvbmZsaWN0KQogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgaWYgbm90IHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUcsaw4bubYyB0acOqbiB0aOG7rSB0w6xtIHVzZXJuYW1lIOG7nyBtw6BuIGjDrG5oIGhp4buHbiB04bqhaQogICAgICAgICAgICB1c2VybmFtZSA9IHNlbGYuX2V4dHJhY3RfdXNlcm5hbWVfZnJvbV9zY3JlZW4oc2NyZWVuX3htbCkKICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjYWNoZQogICAgICAgICAgICAgICAgc2VsZi5fY2FjaGVkX3VzZXJuYW1lID0gdXNlcm5hbWUKICAgICAgICAgICAgICAgIHNlbGYuX3VzZXJuYW1lX2NhY2hlX3RpbWUgPSBjdXJyZW50X3RpbWUKICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdMOsbSB0aOG6pXksIHRo4butIG5hdmlnYXRlIMSR4bq/biBwcm9maWxlIChjaOG7iSBraGkgY+G6p24gdGhp4bq/dCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX25hdmlnYXRlX3RvX3Byb2ZpbGVfdGFiKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWdeG7kXQgeHXhu5FuZyB2w6AgY2jhu50KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX2Rvd24oKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpICAjIEdp4bqjbSB0aOG7nWkgZ2lhbiBjaOG7nQoKICAgICAgICAgICAgICAgICMgVMOsbSB1c2VybmFtZSB0cm9uZyB0cmFuZyBo4buTIHPGoQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHNlbGYuX2V4dHJhY3RfdXNlcm5hbWVfZnJvbV9zY3JlZW4oc2NyZWVuX3htbCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBRdWF5IGzhuqFpIHRyYW5nIGNo4bunIG5oYW5oCiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYiTOG6pXkgdXNlcm5hbWUgdOG7qyBwcm9maWxlOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjYWNoZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhY2hlZF91c2VybmFtZSA9IHVzZXJuYW1lCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXNlcm5hbWVfY2FjaGVfdGltZSA9IGN1cnJlbnRfdGltZQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbOG6pXkgdXNlcm5hbWUgdOG7qyBwcm9maWxlIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgbmF2aWdhdGUgcHJvZmlsZSDEkeG7gyBs4bqleSB1c2VybmFtZToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbOG6pXkgdXNlcm5hbWU6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBpbnZhbGlkYXRlX3VzZXJuYW1lX2NhY2hlKHNlbGYpOgogICAgICAgICIiIljDs2EgY2FjaGUgdXNlcm5hbWUgKGfhu41pIGtoaSBzd2l0Y2ggYWNjb3VudCkiIiIKICAgICAgICBzZWxmLl9jYWNoZWRfdXNlcm5hbWUgPSBOb25lCiAgICAgICAgc2VsZi5fdXNlcm5hbWVfY2FjaGVfdGltZSA9IDAKICAgIAogICAgZGVmIF9leHRyYWN0X3VzZXJuYW1lX2Zyb21fc2NyZWVuKHNlbGYsIHNjcmVlbl94bWw6IHN0cikgLT4gT3B0aW9uYWxbc3RyXToKICAgICAgICAiIiIKICAgICAgICBFeHRyYWN0IHVzZXJuYW1lIHThu6sgWE1MIG3DoG4gaMOsbmggaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2NyZWVuX3htbDogWE1MIGPhu6dhIG3DoG4gaMOsbmgKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgVXNlcm5hbWUgaG/hurdjIE5vbmUKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSB0cm9uZyBjw6FjIEJ1dHRvbiBjw7MgdGjhu4MgY2jhu6lhIHVzZXJuYW1lCiAgICAgICAgICAgIGJ1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYnV0dG9uIGluIGJ1dHRvbnM6CiAgICAgICAgICAgICAgICB0ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChidXR0b24pCiAgICAgICAgICAgICAgICBpZiB0ZXh0IGFuZCB0ZXh0LnN0YXJ0c3dpdGgoIkAiKSBhbmQgbGVuKHRleHQpID4gMToKICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHRleHRbMTpdICAjIELhu48ga8O9IHThu7EgQAogICAgICAgICAgICAgICAgICAgIGlmIGxlbih1c2VybmFtZSkgPiAyOiAgIyBVc2VybmFtZSBo4bujcCBs4buHCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSB0w6xtIHRyb25nIFRleHRWaWV3CiAgICAgICAgICAgIHRleHRfdmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuVGV4dFZpZXciCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciB0ZXh0X3ZpZXcgaW4gdGV4dF92aWV3czoKICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHRleHRfdmlldykKICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIHRleHQuc3RhcnRzd2l0aCgiQCIpIGFuZCBsZW4odGV4dCkgPiAxOgogICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gdGV4dFsxOl0gICMgQuG7jyBrw70gdOG7sSBACiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHVzZXJuYW1lKSA+IDI6ICAjIFVzZXJuYW1lIGjhu6NwIGzhu4cKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVzZXJuYW1lCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBleHRyYWN0IHVzZXJuYW1lOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT0gU01BUlQgQ0FSRSBNRVRIT0RTICjEkOG7k25nIG5o4bqldCB24bubaSBJbnN0YWdyYW0pID09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIF9jYXJlX3N3aXBlX2ZlZWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMaw4bubdCBmZWVkIFRpa1RvayBuaOG6uSBuaMOgbmcgLSB0xrDGoW5nIMSRxrDGoW5nIEluc3RhZ3JhbSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGzGsOG7m3QgZmVlZCBUaWtUb2suLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgIyBC4bqlbSB2w6BvIGNo4buvIMSQ4buBIHh14bqldCBob+G6t2MgRMOgbmggY2hvIGLhuqFuCiAgICAgICAgICAgIGJ0bl9mb3J5b3UgPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9IsSQ4buBIHh14bqldCIsIHRpbWVvdXQ9MikKICAgICAgICAgICAgaWYgbm90IGJ0bl9mb3J5b3U6CiAgICAgICAgICAgICAgICBidG5fZm9yeW91ID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PSJEw6BuaCBjaG8gYuG6oW4iLCB0aW1lb3V0PTIpCiAgICAgICAgICAgIGlmIGJ0bl9mb3J5b3U6CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnRuX2ZvcnlvdSkKCiAgICAgICAgICAgICMgTMaw4bubdCA1LTEwIHZpZGVvIG5n4bqrdSBuaGnDqm4KICAgICAgICAgICAgbnVtX3N3aXBlcyA9IHJhbmRvbS5yYW5kaW50KDUsIDEwKQogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShudW1fc3dpcGVzKToKICAgICAgICAgICAgICAgICMgVGjhu51pIGdpYW4geGVtIG5n4bqrdSBuaGnDqm4gMi01IGdpw6J5CiAgICAgICAgICAgICAgICB3YXRjaF90aW1lID0gcmFuZG9tLnVuaWZvcm0oMiwgNSkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYiTMaw4bubdCB2aWRlbyB7aSsxfS97bnVtX3N3aXBlc30sIHhlbSB7d2F0Y2hfdGltZTouMWZ9cyIpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2F0Y2hfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDw7MgMTAlIGto4bqjIG7Eg25nIGxpa2UgdmlkZW8ga2hpIHhlbSA+PSAzIGdpw6J5IChnaeG6o20gdOG7qyAxNSUpCiAgICAgICAgICAgICAgICBpZiB3YXRjaF90aW1lID49IDMgYW5kIHJhbmRvbS5yYW5kb20oKSA8IDAuMTA6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuX2ZpbmRfbGlrZV9idXR0b24oKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsaWtlX2J1dHRvbiBhbmQgbm90IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUaOG7rSBkb3VibGUgdGFwIMSR4buDIGxpa2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoLCBoZWlnaHQgPSBzZWxmLmhlbHBlci5nZXRfc2NyZWVuX3NpemUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGludCh3aWR0aCAqIHJhbmRvbS51bmlmb3JtKDAuNSwgMC42KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBpbnQoaGVpZ2h0ICogcmFuZG9tLnVuaWZvcm0oMC41LCAwLjYpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC4xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiLEkMOjIGxpa2UgdmlkZW8ge2krMX0gdHJvbmcgY2FyZSBmZWVkIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MgICMgQuG7jyBxdWEgbOG7l2kgbGlrZSwgdGnhur9wIHThu6VjIHhlbQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBmb3JjZSBzdG9wCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDAuMSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBsxrDhu5t0IHtudW1fc3dpcGVzfSB2aWRlbyBUaWtUb2siKQogICAgICAgICAgICAjIFbhu4EgdHJhbmcgY2jhu6cgc2F1IGtoaSBjYXJlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbMaw4bubdCBmZWVkIFRpa1Rvazoge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2NhcmVfd2F0Y2hfdmlkZW9zKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlhlbSB2aWRlbyBUaWtUb2sgdHJvbmcgdGjhu51pIGdpYW4gZMOgaSAtIHTGsMahbmcgxJHGsMahbmcgd2F0Y2hfcmVlbHMgSW5zdGFncmFtIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgeGVtIHZpZGVvIFRpa1Rvay4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHRvdGFsX3dhdGNoX3RpbWUgPSByYW5kb20ucmFuZGludCg2MCwgMTUwKSAgIyAxLTIuNSBwaMO6dAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU+G6vSB4ZW0gdmlkZW8gVGlrVG9rIHRyb25nIHt0b3RhbF93YXRjaF90aW1lfSBnacOieSIpCiAgICAgICAgICAgIAogICAgICAgICAgICB2aWRlb19jb3VudCA9IDAKICAgICAgICAgICAgd2hpbGUgKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkgPCB0b3RhbF93YXRjaF90aW1lOgogICAgICAgICAgICAgICAgdmlkZW9fY291bnQgKz0gMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFhlbSB2aWRlbyBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHdhdGNoX2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQoMywgMTIpICAjIDMtMTIgZ2nDonkgbeG7l2kgdmlkZW8KICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYiWGVtIHZpZGVvIHt2aWRlb19jb3VudH0gdHJvbmcge3dhdGNoX2R1cmF0aW9ufXMiKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhdGNoX2R1cmF0aW9uKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPDsyAyNSUga2jhuqMgbsSDbmcgbGlrZSB2aWRlbyBraGkgeGVtID49IDUgZ2nDonkgKGdp4bqjbSB04burIDIwJSkKICAgICAgICAgICAgICAgIGlmIHdhdGNoX2R1cmF0aW9uID49IDUgYW5kIHJhbmRvbS5yYW5kb20oKSA8IDAuMjU6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuX2ZpbmRfbGlrZV9idXR0b24oKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsaWtlX2J1dHRvbiBhbmQgbm90IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUaOG7rSBkb3VibGUgdGFwIMSR4buDIGxpa2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoLCBoZWlnaHQgPSBzZWxmLmhlbHBlci5nZXRfc2NyZWVuX3NpemUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGludCh3aWR0aCAqIHJhbmRvbS51bmlmb3JtKDAuNSwgMC42KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBpbnQoaGVpZ2h0ICogcmFuZG9tLnVuaWZvcm0oMC41LCAwLjYpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC4xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiLEkMOjIGxpa2UgdmlkZW8ge3ZpZGVvX2NvdW50fSB0cm9uZyBjYXJlIHdhdGNoIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MgICMgQuG7jyBxdWEgbOG7l2kgbGlrZSwgdGnhur9wIHThu6VjIHhlbQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFZ14buRdCBzYW5nIHZpZGVvIHRp4bq/cCB0aGVvCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgZm9yY2Ugc3RvcAogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgwLjEpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgeGVtIHt2aWRlb19jb3VudH0gdmlkZW8gVGlrVG9rIHRyb25nIHtpbnQodGltZS50aW1lKCkgLSBzdGFydF90aW1lKX1zIikKICAgICAgICAgICAgIyBW4buBIHRyYW5nIGNo4bunIHNhdSBraGkgY2FyZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHhlbSB2aWRlbyBUaWtUb2s6IHtlfSIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jYXJlX3ZpZXdfbm90aWZpY2F0aW9ucyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJYZW0gdGjDtG5nIGLDoW8gVGlrVG9rIC0gdMawxqFuZyDEkcawxqFuZyBJbnN0YWdyYW0iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSB4ZW0gdGjDtG5nIGLDoW8gVGlrVG9rLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIHbDoG8gSOG7mXAgdGjGsCAoaW5ib3gpCiAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoCiAgICAgICAgICAgICAgICB0aW1lb3V0PTUsCiAgICAgICAgICAgICAgICBjb250ZW50X2Rlc2M9Ikjhu5lwIHRoxrAiCiAgICAgICAgICAgICkgb3Igc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCgKICAgICAgICAgICAgICAgIHRpbWVvdXQ9NSwKICAgICAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uc3MuYW5kcm9pZC51Z2MudHJpbGw6aWQvY3U5IiAgIyBUaWtUb2sgaW5ib3ggYnV0dG9uCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBpbmJveF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBI4buZcCB0aMawIFRpa1RvayIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihpbmJveF9idXR0b24pCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYZW0gdGjDtG5nIGLDoW8gdHJvbmcgMTAtMjAgZ2nDonkKICAgICAgICAgICAgdmlld190aW1lID0gcmFuZG9tLnJhbmRpbnQoMTAsIDIwKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIlhlbSB0aMO0bmcgYsOhbyB0cm9uZyB7dmlld190aW1lfXMiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiB4deG7kW5nIMSR4buDIHhlbSB0aMO0bmcgYsOhbwogICAgICAgICAgICBmb3IgXyBpbiByYW5nZShyYW5kb20ucmFuZGludCgyLCA0KSk6CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oMSwgMykpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAodmlld190aW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRdWF5IGzhuqFpIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgeGVtIHRow7RuZyBiw6FvIFRpa1RvayIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB4ZW0gdGjDtG5nIGLDoW8gVGlrVG9rOiB7ZX0iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PSBFTkQgU01BUlQgQ0FSRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIF9jaGVja19waW5fcG9wdXAoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSBwb3B1cCBQSU4gdsOgIG5o4bqtcCBtw6MgUElOIG7hur91IGPDswogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIktp4buDbSB0cmEgcG9wdXAgUElOIFRpa1RvayB0cm9uZyA1IGdpw6J5Li4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgd2FpdF9mb3JfZWxlbWVudCDEkeG7gyBraeG7g20gdHJhIHBvcHVwIHRyb25nIDUgZ2nDonkKICAgICAgICAgICAgcGluX3BvcHVwID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCgKICAgICAgICAgICAgICAgIGNvbnRlbnRfZGVzYz0iQuG6oW4gxJHDoyBz4bq1biBzw6BuZyDEkcOzbmcgVGlrVG9rPyIsCiAgICAgICAgICAgICAgICB0aW1lb3V0PTUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcGluX3BvcHVwOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIHBvcHVwIFBJTiBUaWtUb2ssIMSRYW5nIG5o4bqtcCBtw6MuLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIHbDoG8gc+G7kSAiMSIgCiAgICAgICAgICAgICAgICBkaWdpdF8xID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IjEiKQogICAgICAgICAgICAgICAgaWYgZGlnaXRfMToKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoZGlnaXRfMSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmjhuq1wIG3DoyBQSU4gMTIzNAogICAgICAgICAgICAgICAgICAgIGZvciBkaWdpdCBpbiBbIjEiLCIyIiwgIjMiLCAiNCJdOgogICAgICAgICAgICAgICAgICAgICAgICBkaWdpdF9lbGVtZW50ID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50cyh0ZXh0PWRpZ2l0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBkaWdpdF9lbGVtZW50IGFuZCBsZW4oZGlnaXRfZWxlbWVudCkgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGRpZ2l0X2VsZW1lbnRbbGVuKGRpZ2l0X2VsZW1lbnQpLTFdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDAuNSkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgc+G7kSB7ZGlnaXR9IHRyb25nIHBvcHVwIFBJTiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQodGV4dD0iUXVheSBs4bqhaSB0aWt0b2siLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBuaOG6rXAgbcOjIFBJTiAxMjM0IikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikgICMgQ2jhu50gcG9wdXAgxJHDs25nCgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJUw6xtIHRo4bqleSBwb3B1cCBQSU4gbmjGsG5nIGtow7RuZyB0w6xtIHRo4bqleSBz4buRIDEiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIktow7RuZyBjw7MgcG9wdXAgUElOIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkga2nhu4NtIHRyYSBwb3B1cCBQSU46IHtlfSIpCiAgICAKICAgIGRlZiBwZXJmb3JtX3Bvc3RfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQxINuZyB2aWRlbyBjaG8gVGlrVG9rIHbhu5tpIGtp4buDbSB0cmEgdGjhu51pIGdpYW4gZGVsYXkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZyDEkcSDbmcgdmlkZW8gaG/hurdjIMSRw6MgxJHEg25nIGfhuqduIMSRw6J5CiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBhY2MgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgnaWQnKQogICAgICAgIAogICAgICAgIGlmIGFjYyA9PSAibmRkMTE4OTAiOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdGjhu51pIGdpYW4gcG9zdCBn4bqnbiBuaOG6pXQKICAgICAgICBkZWxheV9taW51dGVzID0gc2VsZi5nZXRfY29uZmlnKCJkZWxheV9wb3N0X3ZpZGVvX21pbnV0ZSIpCiAgICAgICAgaWYgZGVsYXlfbWludXRlcyBhbmQgYWNjb3VudF9pZDoKICAgICAgICAgICAgbGFzdF9wb3N0X3RpbWUgPSBzZWxmLmRiLmdldF9hY2NvdW50X2xhc3RfcG9zdF90aW1lKGFjY291bnRfaWQsIHNlbGYuYXBwX25hbWUpCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGxhc3RfcG9zdF90aW1lOgogICAgICAgICAgICAgICAgdGltZV9kaWZmX21pbnV0ZXMgPSAoY3VycmVudF90aW1lIC0gbGFzdF9wb3N0X3RpbWUpIC8gNjAKICAgICAgICAgICAgICAgIGlmIHRpbWVfZGlmZl9taW51dGVzIDwgZGVsYXlfbWludXRlczoKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGRlbGF5X21pbnV0ZXMgLSB0aW1lX2RpZmZfbWludXRlcwogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY30gxJHDoyDEkcSDbmcgdmlkZW8gZ+G6p24gxJHDonksIGPhuqduIGNo4budIHRow6ptIHtyZW1haW5pbmdfbWludXRlczouMWZ9IHBow7p0IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBUcuG6oyB24buBIFRydWUgxJHhu4Mga2jDtG5nIGNvaSBsw6AgbOG7l2kKICAgICAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSDEkcSDbmcgdmlkZW8gY2hvIFRpa1RvayB0w6BpIGtob+G6o246IHthY2N9IikKCiAgICAgICAgIyBCxrDhu5tjIDE6IELhuqVtIHF1YXkKICAgICAgICBuZXh0X2J1dHRvbjIgPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iUXVheSIsIHRpbWVvdXQ9NSkKICAgICAgICBpZiBub3QgbmV4dF9idXR0b24yOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgUXVheSDEkeG7gyDEkcSDbmcgdmlkZW8iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMiBi4bqlbSBjaG8gcGjDqXAKICAgICAgICB3aGlsZSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHJlc291cmNlX2lkPSJjb20uYW5kcm9pZC5wYWNrYWdlaW5zdGFsbGVyOmlkL3Blcm1pc3Npb25fYWxsb3dfYnV0dG9uIiwgdGltZW91dD01KToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6pW0gbsO6dCBjaG8gcGjDqXAuLi4iKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKCiAgICAgICAgI0LGsOG7m2MgMyBi4bqlbSB2w6BvIGLhu5kgc8awdSB04bqtcAogICAgICAgIHJlY29yZF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KGNvbnRlbnRfZGVzYz0iUXVheSB2aWRlbyIsIHRpbWVvdXQ9MTApCiAgICAgICAgaWYgbm90IHJlY29yZF9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCAnUXVheSB2aWRlbyciKQogICAgICAgICAgICBjbG9zZV9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0ixJDDs25nIiwgdGltZW91dD0yKQogICAgICAgICAgICBpZiBjbG9zZV9idXR0b246CiAgICAgICAgICAgICAgICBjbG9zZV9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0ixJDDs25nIiwgdGltZW91dD0yKQogICAgICAgICAgICBpZiBjbG9zZV9idXR0b246CiAgICAgICAgICAgICAgICBjbG9zZV9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0ixJDDs25nIiwgdGltZW91dD0yKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMjogUmFuZG9tIHPhu5EgbMaw4bujbmcg4bqjbmggdsOgIHThuqNpIHbhu4EKICAgICAgICBpbWFnZV9jb3VudCA9IHJhbmRvbS5yYW5kaW50KDMsIDUpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlJhbmRvbSB7aW1hZ2VfY291bnR9IOG6o25oIMSR4buDIMSRxINuZyBiw6BpIikKICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuZG93bmxvYWRfaW1hZ2UoY291bnQ9aW1hZ2VfY291bnQpOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJU4bqjaSDhuqNuaCB0aOG6pXQgYuG6oWksIGLhu48gcXVhIMSRxINuZyBiw6BpIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCgogICAgICAgICMgTOG6pXkgYm91bmRzIGPhu6dhIHJlY29yZF9idXR0b24gdsOgIHTDrW5oIHRvw6FuIHThu41hIMSR4buZCiAgICAgICAgYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKHJlY29yZF9idXR0b24pCiAgICAgICAgeDEsIHkxLCB4MiwgeTIgPSBib3VuZHMKICAgICAgICB5ID0gKHkxICsgeTIpIC8vIDIgICMgeSDhu58gZ2nhu69hIGPhu6dhIGVsZW1lbnQKICAgICAgICB4ID0geDIgICMgeCDhu58gY+G6oW5oIHBo4bqjaQogICAgICAgIHRhcF94ID0geCArIDYwICAjIHggKyA2MAogICAgICAgIHRhcF95ID0geQoKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGFwIHbDoG8gdOG7jWEgxJHhu5kgKHt0YXBfeH0sIHt0YXBfeX0pIC0gY+G6oW5oIHBo4bqjaSBj4bunYSBuw7p0IFF1YXkgdmlkZW8gKyA2MHB4IikKICAgICAgICBzZWxmLmhlbHBlci50YXAodGFwX3gsIHRhcF95KQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgIAogICAgICAgICMgQsaw4bubYyA0IGLhuqVtIGNobyBwaMOpcAogICAgICAgIHdoaWxlIHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQocmVzb3VyY2VfaWQ9ImNvbS5hbmRyb2lkLnBhY2thZ2VpbnN0YWxsZXI6aWQvcGVybWlzc2lvbl9hbGxvd19idXR0b24iLCB0aW1lb3V0PTUpOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJC4bqlbSBuw7p0IGNobyBwaMOpcC4uLiIpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgICAgICMgQsaw4bubYyA1IGNo4buNbiDhuqNuaAogICAgICAgICMgVMOsbSBHcmlkVmlldyDEkeG7gyBjaOG7jW4g4bqjbmgKICAgICAgICBncmlkX3ZpZXcgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuR3JpZFZpZXciKQogICAgICAgIGlmIG5vdCBncmlkX3ZpZXc6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgR3JpZFZpZXcgxJHhu4MgY2jhu41uIOG6o25oIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgIyBM4bqleSB04bqldCBj4bqjIGPDoWMgYnV0dG9uIGzDoCBjb24gY+G7p2EgR3JpZFZpZXcKICAgICAgICBidXR0b25zX2luX2dyaWQgPSBzZWxmLmhlbHBlci5maW5kX2NoaWxkX2VsZW1lbnRzKGdyaWRfdmlldywgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIikKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbihidXR0b25zX2luX2dyaWQpfSBidXR0b24gdHJvbmcgR3JpZFZpZXciKQogICAgICAgIGlmIG5vdCBidXR0b25zX2luX2dyaWQgb3IgbGVuKGJ1dHRvbnNfaW5fZ3JpZCkgPT0gMDoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyBjw7Mg4bqjbmggbsOgbyB0cm9uZyBHcmlkVmlldyDEkeG7gyBjaOG7jW4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIENo4buNbiB04burIGl0ZW0gdOG7qyAwIMSR4bq/biBpbWFnZV9jb3VudC0xCiAgICAgICAgaXRlbXNfdG9fc2VsZWN0ID0gbWluKGltYWdlX2NvdW50LCBsZW4oYnV0dG9uc19pbl9ncmlkKSkKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQ2jhu41uIHtpdGVtc190b19zZWxlY3R9IOG6o25oIHThu6sgR3JpZFZpZXciKQogICAgICAgIGZvciBpIGluIHJhbmdlKGl0ZW1zX3RvX3NlbGVjdCk6CiAgICAgICAgICAgIGJ1dHRvbiA9IGJ1dHRvbnNfaW5fZ3JpZFtpXQogICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIkNo4buNbiDhuqNuaCB0aOG7qSB7aSsxfSIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihidXR0b24pCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgwLjUpCgogICAgICAgICMgVMOsbSB2w6AgYuG6pW0gbsO6dCBBdXRvQ3V0CiAgICAgICAgbmV4dF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHRleHQ9IkF1dG9DdXQiLCB0aW1lb3V0PTUpCiAgICAgICAgaWYgbm90IG5leHRfYnV0dG9uOgogICAgICAgICAgICBuZXh0X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQoY29udGVudF9kZXNjPSJBdXRvQ3V0IiwgdGltZW91dD01KQogICAgICAgIGlmIG5vdCBuZXh0X2J1dHRvbjoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0ICdBdXRvQ3V0JyBzYXUga2hpIGNo4buNbiDhuqNuaCIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKCiAgICAgICAgIyBDaOG7nSBoaeG7h3Ug4bupbmcgIsSQYW5nIHjhu60gbMO9Li4uIiBob8OgbiB04bqldAogICAgICAgIHdhaXRfY291bnQ9MAogICAgICAgIHdoaWxlIHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQodGV4dD0ixJBhbmcgeOG7rSBsw70uLi4iLCB0aW1lb3V0PTIpIDoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJBhbmcgeOG7rSBsw70uLi4iKQogICAgICAgICAgICB3YWl0X2NvdW50ICs9IDEKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIGlmIHdhaXRfY291bnQgPj0gMjAwOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIkNo4budIHF1w6EgbMOidSBjaG8gaGnhu4d1IOG7qW5nICfEkGFuZyB44butIGzDvS4uLicsIGLhu48gcXVhIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKSAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpCiAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgaWYgY3VycmVudF9wYWNrYWdlICE9IHNlbGYuYXBwX3BhY2thZ2U6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJQYWNrYWdlIGhp4buHbiB04bqhaSAoe2N1cnJlbnRfcGFja2FnZX0pIGtow7RuZyDEkcO6bmcsIG3hu58gbOG6oWkgYXBwIFRpa1Rvay4uLiIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHBhY2thZ2Ugc2F1IGtoaSBt4bufIGFwcAogICAgICAgICAgICBjdXJyZW50X3BhY2thZ2UgPSBzZWxmLmhlbHBlci5nZXRfY3VycmVudF9wYWNrYWdlKCkKICAgICAgICAgICAgaWYgY3VycmVudF9wYWNrYWdlICE9IHNlbGYuYXBwX3BhY2thZ2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIlbhuqtuIGtow7RuZyBt4bufIMSRxrDhu6NjIGFwcCBUaWtUb2sgxJHDum5nIGPDoWNoLCBwYWNrYWdlIGhp4buHbiB04bqhaToge2N1cnJlbnRfcGFja2FnZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIG3hu58gbOG6oWkgYXBwIFRpa1RvayB0aMOgbmggY8O0bmciKQoKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGPDsyB0ZXh0ICJOaOG6rXQga8O9IGPhu6dhIGLhuqFuIiB2w6AgInRp4bq/cCIgxJHhu4MgdGnhur9wIHThu6VjCiAgICAgICAgZGlhcnlfdGV4dCA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQodGV4dD0iTmjhuq10IGvDvSBj4bunYSBi4bqhbiIsIHRpbWVvdXQ9NSkKICAgICAgICBjb250aW51ZV9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9IlRp4bq/cCIsIHRpbWVvdXQ9MikKCiAgICAgICAgaWYgbm90IGRpYXJ5X3RleHQgb3Igbm90IGNvbnRpbnVlX2J1dHRvbjoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSAnTmjhuq10IGvDvSBj4bunYSBi4bqhbicgaG/hurdjIG7DunQgJ3Rp4bq/cCcsIGtow7RuZyB0aOG7gyB0aeG6v3AgdOG7pWMiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgIyBDaOG7nSBSZWN5Y2xlclZpZXcgeHXhuqV0IGhp4buHbiB2w6AgdGFwIHbDoG8gbsOzCiAgICAgICAgcmVjeWNsZXJfdmlldyA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoY2xhc3NfbmFtZT0iYW5kcm9pZHgucmVjeWNsZXJ2aWV3LndpZGdldC5SZWN5Y2xlclZpZXciLCB0aW1lb3V0PTUpCiAgICAgICAgaWYgcmVjeWNsZXJfdmlldzoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgUmVjeWNsZXJWaWV3LCDEkWFuZyB0YXAgdsOgby4uLiIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihyZWN5Y2xlcl92aWV3KQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMTApCgogICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihjb250aW51ZV9idXR0b24pCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCgoKICAgICAgICAjIEtp4buDbSB0cmEgY8OzIHRleHQgIlRow6ptIG3DtCB04bqjLi4uIiB2w6AgYuG6pW0gdsOgbyDEkcOzIMSR4buDIHRow6ptIGhhc2h0YWcKICAgICAgICBhZGRfZGVzY3JpcHRpb24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iVGjDqm0gbcO0IHThuqMuLi4iKQogICAgICAgIGlmIGFkZF9kZXNjcmlwdGlvbjoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgJ3Row6ptIG3DtCB04bqjLi4uJywgxJFhbmcgYuG6pW0gdsOgbyDEkeG7gyB0aMOqbSBoYXNodGFnIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGFkZF9kZXNjcmlwdGlvbikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJhbmRvbSBjaOG7jW4gMSBoYXNodGFnIHThu6sgZGFuaCBzw6FjaAogICAgICAgICAgICBoYXNodGFncyA9IFsKICAgICAgICAgICAgICAgICIjeHVodW9uZyIsICIjdGlrdG9rdm4iLCAiI3RyZW5kaW5nIiwgIiNsaWZldm4iLCAiI2N1b2Nzb25nIiwgCiAgICAgICAgICAgICAgICAiI2FtbmhhYyIsICIjdGluaHlldSIsICIjbmhvIiwgIiN0aGFuaHh1YW4iLCAiI2J1b24iLCAiI3Z1aSIsIAogICAgICAgICAgICAgICAgIiNoYW5ocGh1YyIsICIjY2FteHVjIiwgIiNuZ2F5bW9pIiwgIiNtdWFoZSIsICIjdGh1Z2lhbiIsIAogICAgICAgICAgICAgICAgIiNjaGlsbCIsICIjbW90bmdheWN1YXRvaSIKICAgICAgICAgICAgXQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZWN0ZWRfaGFzaHRhZyA9IHJhbmRvbS5jaG9pY2UoaGFzaHRhZ3MpCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJOaOG6rXAgaGFzaHRhZzoge3NlbGVjdGVkX2hhc2h0YWd9IikKICAgICAgICAgICAgc2VsZi5oZWxwZXIuaW5wdXRfdGV4dChzZWxlY3RlZF9oYXNodGFnKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfZW50ZXIoKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJLaMO0bmcgdMOsbSB0aOG6pXkgJ3Row6ptIG3DtCB04bqjLi4uJywgYuG7jyBxdWEgYsaw4bubYyB0aMOqbSBoYXNodGFnIikKCiAgICAgICAgIyBUw6xtIHbDoCBi4bqlbSBuw7p0IMSQxINuZwogICAgICAgIHBvc3RfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQxINuZyIsIHRpbWVvdXQ9MTApCiAgICAgICAgaWYgbm90IHBvc3RfYnV0dG9uOgogICAgICAgICAgICBwb3N0X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQodGV4dD0ixJDEg25nIiwgdGltZW91dD01KQogICAgICAgICAgICBpZiBub3QgcG9zdF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgJ8SQxINuZycgxJHhu4MgaG/DoG4gdGjDoG5oIMSRxINuZyB2aWRlbyIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEwKQogICAgICAgIHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCkKICAgICAgICAKICAgICAgICAjIEzGsHUgdGjhu51pIGdpYW4gxJHEg25nIHZpZGVvIHRow6BuaCBjw7RuZyB2w6BvIERCCiAgICAgICAgaWYgYWNjb3VudF9pZDoKICAgICAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2xhc3RfcG9zdF90aW1lKGFjY291bnRfaWQsIHNlbGYuYXBwX25hbWUsIGN1cnJlbnRfdGltZSkKICAgICAgICAKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIMSRxINuZyB2aWRlbyBjaG8gVGlrVG9rIHTDoGkga2hv4bqjbjoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpfSIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBDQVJFIEFDVElPTlMgSU1QTEVNRU5UQVRJT04gKEFCU1RSQUNUIE1FVEhPRFMgRlJPTSBCQVNFKQogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBkZWYgcGVyZm9ybV9uZXdzZmVlZF9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiB2deG7kXQgbmV3c2ZlZWQvRm9yIFlvdSBmZWVkIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBjw7Mgc+G6tW4gX2NhcmVfc3dpcGVfZmVlZAogICAgICAgICAgICByZXR1cm4gc2VsZi5fY2FyZV9zd2lwZV9mZWVkKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtX25ld3NmZWVkX2FjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3JlZWxzX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIHhlbSB2aWRlby9yZWVscyAoVGlrVG9rIG3hurdjIMSR4buLbmggbMOgIHZpZGVvKSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY8OzIHPhurVuIF9jYXJlX3dhdGNoX3ZpZGVvcwogICAgICAgICAgICByZXR1cm4gc2VsZi5fY2FyZV93YXRjaF92aWRlb3MoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIHBlcmZvcm1fcmVlbHNfYWN0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fbm90aWZpY2F0aW9uX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIHhlbSB0aMO0bmcgYsOhby9pbmJveCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY8OzIHPhurVuIF9jYXJlX3ZpZXdfbm90aWZpY2F0aW9ucwogICAgICAgICAgICByZXR1cm4gc2VsZi5fY2FyZV92aWV3X25vdGlmaWNhdGlvbnMoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIHBlcmZvcm1fbm90aWZpY2F0aW9uX2FjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3Byb2ZpbGVfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRo4buxYyBoaeG7h24geGVtIHByb2ZpbGUiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTmF2aWdhdGUgxJHhur9uIHByb2ZpbGUgdGFiCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9uYXZpZ2F0ZV90b19wcm9maWxlX3RhYigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIHRo4budaSBnaWFuIHhlbSBwcm9maWxlCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSg1LCAxNSkpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtX3Byb2ZpbGVfYWN0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fZXhwbG9yZV9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiBraMOhbSBwaMOhIChEaXNjb3ZlciB0YWIpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE5hdmlnYXRlIMSR4bq/biBEaXNjb3ZlciB0YWIgKG7hur91IGPDsykKICAgICAgICAgICAgZGlzY292ZXJfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudChjb250ZW50X2Rlc2M9Iktow6FtIHBow6EiLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIGlmIG5vdCBkaXNjb3Zlcl9idXR0b246CiAgICAgICAgICAgICAgICBkaXNjb3Zlcl9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9Iktow6FtIHBow6EiLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkaXNjb3Zlcl9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoZGlzY292ZXJfYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU2Nyb2xsIHRyb25nIGRpc2NvdmVyIGZlZWQgLSB0aGF5IHN3aXBlX2Rvd24gYuG6sW5nIHN3aXBlX3VwCiAgICAgICAgICAgICAgICBzY3JvbGxfY291bnQgPSByYW5kb20ucmFuZGludCg1LCAxNSkKICAgICAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKHNjcm9sbF9jb3VudCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgxLCA1KSkKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiBzY3JvbGwgRm9yIFlvdSBmZWVkCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wZXJmb3JtX25ld3NmZWVkX2FjdGlvbihhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgcGVyZm9ybV9leHBsb3JlX2FjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3NlYXJjaF9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiB0w6xtIGtp4bq/bSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUw6xtIHNlYXJjaCBidXR0b24KICAgICAgICAgICAgc2VhcmNoX2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoY29udGVudF9kZXNjPSJUw6xtIGtp4bq/bSIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgaWYgbm90IHNlYXJjaF9idXR0b246CiAgICAgICAgICAgICAgICBzZWFyY2hfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PSJUw6xtIGtp4bq/bSIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlYXJjaF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEdp4bqjIGzhuq1wIHTDrG0ga2nhur9tCiAgICAgICAgICAgICAgICBzZWFyY2hfdGVybXMgPSBbImdhaXhpbmgiLCJnYWlfeGluaCIsImhvdGdpcmwiLCJob3RnaXJsdm4iLCJ2aWV0bmFtZ2lybCIsInByZXR0eWdpcmwiLAoiY3V0ZWdpcmwiLCJ4aW5oZ2FpIiwibW9kZWwiLCJpbmZsdWVuY2VyIiwic2VsZmllIiwibWFrZXVwIiwic2tpbmNhcmUiLCJvb3RkIiwiZmFzaGlvbiIsCiJzdHlsZSIsImhhaXIiLCJnbG93dXAiLCJ2aXJhbGdpcmwiLCJ0aWt0b2tnaXJscyIsInRpa3Rva2dpcmwiLCJ2aWV0bmFtZXNlIiwicG9ydHJhaXQiLAoiZGFuY2VnaXJsIiwiY29zcGxheWdpcmwiLCJjb2xsZWdlZ2lybCIsInN0dWRlbnRnaXJsIiwiYmVhdXR5IiwiYmVhdXRpZnVsIiwiY3V0ZSIsInNtaWxlIl0KICAgICAgICAgICAgICAgIHNlYXJjaF90ZXJtID0gcmFuZG9tLmNob2ljZShzZWFyY2hfdGVybXMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBzZWFyY2ggYm94CiAgICAgICAgICAgICAgICBzZWFyY2hfYm94ID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudChjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5FZGl0VGV4dCIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgIGlmIHNlYXJjaF9ib3g6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlYXJjaF9ib3gpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuaW5wdXRfdGV4dChzZWFyY2hfdGVybSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gVHV4VGV4dExheW91dFZpZXcgc2F1IGtoaSBuaOG6rXAgdGV4dAogICAgICAgICAgICAgICAgICAgIHR1eF90ZXh0X2VsZW1lbnRzID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50cyhjbGFzc19uYW1lPSJjb20uYnl0ZWRhbmNlLnR1eC5pbnB1dC5UdXhUZXh0TGF5b3V0VmlldyIpCiAgICAgICAgICAgICAgICAgICAgaWYgdHV4X3RleHRfZWxlbWVudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKHR1eF90ZXh0X2VsZW1lbnRzKX0ga+G6v3QgcXXhuqMgZ+G7o2kgw70iKQogICAgICAgICAgICAgICAgICAgICAgICAjIENsaWNrIHbDoG8gZWxlbWVudCDEkeG6p3UgdGnDqm4gKHRoxrDhu51uZyBsw6Agc3VnZ2VzdGlvbiDEkeG6p3UgdGnDqm4pCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2xpY2sgdsOgbyBlbGVtZW50IG5n4bqrdSBuaGnDqm4KICAgICAgICAgICAgICAgICAgICAgICAgcmFuZG9tX2VsZW1lbnQgPSByYW5kb20uY2hvaWNlKHR1eF90ZXh0X2VsZW1lbnRzKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIocmFuZG9tX2VsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2VudGVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBTY3JvbGwga+G6v3QgcXXhuqMgc2VhcmNoIC0gdGhheSBzd2lwZV9kb3duIGLhurFuZyBzd2lwZV91cAogICAgICAgICAgICAgICAgICAgIHNjcm9sbF9jb3VudCA9IHJhbmRvbS5yYW5kaW50KDEsIDgpCiAgICAgICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2Uoc2Nyb2xsX2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oMSwgMikpCiAgICAgICAgICAgICAgICAgICAgICAgICMgUmFuZG9tIDUwJSB0YXAgdsOgbyBhbmRyb2lkLndpZGdldC5HcmlkVmlldyB2w6AgZOG7q25nIHThu6sgMTAtMzBzCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IDAuNTogICMgNTAlIHByb2JhYmlsaXR5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBncmlkX3ZpZXcgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuR3JpZFZpZXciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZ3JpZF92aWV3OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlJhbmRvbSB0YXAgdsOgbyBHcmlkVmlldy4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGdyaWRfdmlldykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCgxMCwgMzApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkThu6tuZyB7d2FpdF90aW1lfXMgc2F1IGtoaSB0YXAgR3JpZFZpZXciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YWl0X3RpbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjawogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDEwLCAzMCkpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgcGVyZm9ybV9zZWFyY2hfYWN0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAjIEFQUCBNQU5BR0VNRU5UIElNUExFTUVOVEFUSU9OIChBQlNUUkFDVCBNRVRIT0RTIEZST00gQkFTRSkKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIG9wZW5fYXBwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiTeG7nyBUaWtUb2sgYXBwIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gYXBwIMSRw6MgbeG7nyBjaMawYQogICAgICAgICAgICBjdXJyZW50X3BhY2thZ2UgPSBzZWxmLmhlbHBlci5nZXRfY3VycmVudF9wYWNrYWdlKCkKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfcGFja2FnZSA9PSBzZWxmLmFwcF9wYWNrYWdlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBvcGVuX2FwcDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX2xpdmVfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEFjdGlvbiByacOqbmcgY+G7p2EgVGlrVG9rOiBYZW0gbGl2ZXN0cmVhbQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiWGVtIGxpdmVzdHJlYW0gVGlrVG9rIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIOG7nyBob21lIHNjcmVlbgogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gaG9tZSBzY3JlZW4iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdsOgIGNsaWNrIHbDoG8gdGFiIExJVkUgbuG6v3UgY8OzCiAgICAgICAgICAgIGxpdmVfdGFiX2ZvdW5kID0gRmFsc2UKICAgICAgICAgICAgbGl2ZV9zZWxlY3RvcnMgPSBbCiAgICAgICAgICAgICAgICB7InRleHQiOiAiTElWRSJ9LAogICAgICAgICAgICAgICAgeyJ0ZXh0IjogIkxpdmUifSwKICAgICAgICAgICAgICAgIHsiY29udGVudF9kZXNjIjogIkxJVkUifSwKICAgICAgICAgICAgICAgIHsiY29udGVudF9kZXNjIjogIkxpdmUifQogICAgICAgICAgICBdCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3Igc2VsZWN0b3IgaW4gbGl2ZV9zZWxlY3RvcnM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KCoqc2VsZWN0b3IsIHRpbWVvdXQ9Myk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuY2xpY2tfZWxlbWVudCgqKnNlbGVjdG9yKQogICAgICAgICAgICAgICAgICAgIGxpdmVfdGFiX2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgY2xpY2sgdsOgbyB0YWIgTElWRSIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBsaXZlX3RhYl9mb3VuZDoKICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IHRhYiBMSVZFLCBzY3JvbGwgZG93biDEkeG7gyB0w6xtIGxpdmVzdHJlYW0gdHJvbmcgRm9yIFlvdQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiBMSVZFLCB0w6xtIGxpdmVzdHJlYW0gdHJvbmcgRm9yIFlvdSIpCiAgICAgICAgICAgICAgICBzY3JvbGxfYXR0ZW1wdHMgPSAwCiAgICAgICAgICAgICAgICBtYXhfc2Nyb2xscyA9IDUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgd2hpbGUgc2Nyb2xsX2F0dGVtcHRzIDwgbWF4X3Njcm9sbHM6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgbGl2ZSBpbmRpY2F0b3Iga2jDtG5nIChk4bqldSBoaeG7h3UgbGl2ZXN0cmVhbSkKICAgICAgICAgICAgICAgICAgICBsaXZlX2luZGljYXRvcnMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIHsidGV4dCI6ICJMSVZFIn0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsiY29udGVudF9kZXNjIjogIkxJVkUifSwKICAgICAgICAgICAgICAgICAgICAgICAgeyJ0ZXh0IjogIsSRYW5nIHBow6F0IHRy4buxYyB0aeG6v3AifSwKICAgICAgICAgICAgICAgICAgICAgICAgeyJ0ZXh0IjogInZpZXdlcnMifQogICAgICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3VuZF9saXZlID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBmb3IgaW5kaWNhdG9yIGluIGxpdmVfaW5kaWNhdG9yczoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCgqKmluZGljYXRvciwgdGltZW91dD0xKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvdW5kX2xpdmUgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSBsaXZlc3RyZWFtIHRyb25nIEZvciBZb3UiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBmb3VuZF9saXZlOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgU2Nyb2xsIGRvd24gxJHhu4MgdMOsbSB2aWRlbyB0aeG6v3AgdGhlbwogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX2Rvd24oKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgyLCA0KSkKICAgICAgICAgICAgICAgICAgICBzY3JvbGxfYXR0ZW1wdHMgKz0gMQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYZW0gbGl2ZXN0cmVhbSB0cm9uZyBt4buZdCBraG/huqNuZyB0aOG7nWkgZ2lhbiBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgIHdhdGNoX2R1cmF0aW9uID0gcmFuZG9tLnVuaWZvcm0oMTAsIDMwKSAgIyAxMC0zMCBnacOieQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiWGVtIGxpdmVzdHJlYW0gdHJvbmcge3dhdGNoX2R1cmF0aW9uOi4xZn0gZ2nDonkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDw7MgdGjhu4MgdGjhu7FjIGhp4buHbiBt4buZdCBz4buRIHTGsMahbmcgdMOhYyBuaOG6uQogICAgICAgICAgICBpZiByYW5kb20ucmFuZG9tKCkgPCAwLjM6ICAjIDMwJSBjxqEgaOG7mWkgdMawxqFuZyB0w6FjCiAgICAgICAgICAgICAgICBpbnRlcmFjdGlvbl9hY3Rpb25zID0gWwogICAgICAgICAgICAgICAgICAgIGxhbWJkYTogc2VsZi5oZWxwZXIudGFwX3NjcmVlbihyYW5kb20ucmFuZGludCgyMDAsIDgwMCksIHJhbmRvbS5yYW5kaW50KDQwMCwgODAwKSksICAjIFRhcCBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgICAgICAgICAgbGFtYmRhOiBOb25lICAjIEtow7RuZyBsw6BtIGfDrAogICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhY3Rpb24gPSByYW5kb20uY2hvaWNlKGludGVyYWN0aW9uX2FjdGlvbnMpCiAgICAgICAgICAgICAgICBhY3Rpb24oKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNsZWVwIMSR4buDIHhlbSBsaXZlc3RyZWFtCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YXRjaF9kdXJhdGlvbikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggeGVtIGxpdmVzdHJlYW0gVGlrVG9rIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB4ZW0gbGl2ZXN0cmVhbSBUaWtUb2s6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICByZXR1cm4gRmFsc2U=').decode('utf-8'))
