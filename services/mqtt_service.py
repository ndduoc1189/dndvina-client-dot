import base64
exec(base64.b64decode('aW1wb3J0IHBhaG8ubXF0dC5jbGllbnQgYXMgbXF0dAppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBqc29uCmltcG9ydCB0aW1lCmltcG9ydCB1dWlkCmltcG9ydCBvcwpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbCwgQ2FsbGFibGUsIFVuaW9uCmltcG9ydCBjb25maWcKaW1wb3J0IHV0aWxzCgojIExvZ2dlcgpsb2dnZXIgPSB1dGlscy5nZXRfbG9nZ2VyKCJNUVRUU2VydmljZSIpCgpjbGFzcyBNUVRUU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBkZXZpY2VfaWQsIGhlbHBlcl9zZXJ2aWNlPU5vbmUpOgogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgc2VydmljZQogICAgICAgIHNlbGYuZGIgPSBkYl9zZXJ2aWNlCiAgICAgICAgc2VsZi5oZWxwZXJfc2VydmljZSA9IGhlbHBlcl9zZXJ2aWNlCiAgICAgICAgCiAgICAgICAgIyBD4bqldSBow6xuaCBNUVRUCiAgICAgICAgc2VsZi5jbGllbnRfaWQgPSBmIntjb25maWcuTVFUVF9DTElFTlRfSURfUFJFRklYfV97ZGV2aWNlX2lkfSIKICAgICAgICBzZWxmLmJyb2tlcl91cmwgPSBjb25maWcuTVFUVF9TRVJWRVJTW2NvbmZpZy5NT0RFXQogICAgICAgIHNlbGYuYnJva2VyX2FkZHJlc3MgPSBzZWxmLmJyb2tlcl91cmwucmVwbGFjZSgibXF0dDovLyIsICIiKS5zcGxpdCgiOiIpWzBdCiAgICAgICAgc2VsZi5icm9rZXJfcG9ydCA9IGludChzZWxmLmJyb2tlcl91cmwuc3BsaXQoIjoiKVstMV0pIGlmICI6IiBpbiBzZWxmLmJyb2tlcl91cmwgZWxzZSAxODgzCiAgICAgICAgc2VsZi51c2VybmFtZSA9IGNvbmZpZy5NUVRUX1VTRVJOQU1FCiAgICAgICAgc2VsZi5wYXNzd29yZCA9IGNvbmZpZy5NUVRUX1BBU1NXT1JECiAgICAgICAgCiAgICAgICAgIyBUcuG6oW5nIHRow6FpIGvhur90IG7hu5FpCiAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgIHNlbGYuY2xpZW50ID0gTm9uZQogICAgICAgIHNlbGYuZGV2aWNlX2lkID0gZGV2aWNlX2lkCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyBUb3BpY3MKICAgICAgICBzZWxmLnRvcGljX2NsaWVudF9zeW5jID0gY29uZmlnLk1RVFRfVE9QSUNfQ0xJRU5UX1NZTkMKICAgICAgICBzZWxmLnRvcGljX3NlcnZlcl90YXNrID0gZiJ7Y29uZmlnLk1RVFRfVE9QSUNfU0VSVkVSX1RBU0tfUFJFRklYfS97c2VsZi5kZXZpY2VfaWR9IgogICAgICAgIAogICAgICAgICMgUXXhuqNuIGzDvSB0YXNrIHbDoCBzeW5jCiAgICAgICAgc2VsZi50YXNrX2hhbmRsZXJzID0ge30KICAgICAgICBzZWxmLnN5bmNfdGhyZWFkID0gTm9uZQogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgc2VsZi5zdG9wX2V2ZW50ID0gdGhyZWFkaW5nLkV2ZW50KCkKICAgICAgICBzZWxmLnN5bmNfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldF9kZXZpY2VfY29uZmlnKCJzeW5jX2ludGVydmFsIiwgY29uZmlnLlNZTkNfSU5URVJWQUwpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIG3DtGkgdHLGsOG7nW5nIFRlcm11eAogICAgICAgIHNlbGYuaXNfdGVybXV4ID0gJ1RFUk1VWF9WRVJTSU9OJyBpbiBvcy5lbnZpcm9uIG9yICcvZGF0YS9kYXRhL2NvbS50ZXJtdXgnIGluIG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpCiAgICAgICAgaWYgc2VsZi5pc190ZXJtdXg6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBjaOG6oXkgdHJvbmcgbcO0aSB0csaw4budbmcgVGVybXV4IikKCiAgICBkZWYgX2NyZWF0ZV9jbGllbnQoc2VsZikgLT4gbXF0dC5DbGllbnQ6CiAgICAgICAgIiIiVOG6oW8gdsOgIGPhuqV1IGjDrG5oIE1RVFQgY2xpZW50IiIiCiAgICAgICAgY2xpZW50ID0gTm9uZQoKICAgICAgICAjIFRo4butIHThuqFvIHbhu5tpIEFQSSB2MgogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpZW50ID0gbXF0dC5DbGllbnQoCiAgICAgICAgICAgICAgICBjbGllbnRfaWQ9c2VsZi5jbGllbnRfaWQsCiAgICAgICAgICAgICAgICBjbGVhbl9zZXNzaW9uPVRydWUsCiAgICAgICAgICAgICAgICBwcm90b2NvbD1tcXR0Lk1RVFR2MzExLAogICAgICAgICAgICAgICAgY2FsbGJhY2tfYXBpX3ZlcnNpb249Z2V0YXR0cihtcXR0LkNhbGxiYWNrQVBJVmVyc2lvbiwgJ1ZFUlNJT04yJywgTm9uZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYyIikKICAgICAgICBleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBUeXBlRXJyb3IpOgogICAgICAgICAgICAjIEZhbGxiYWNrIEFQSSB2MQogICAgICAgICAgICBjbGllbnQgPSBtcXR0LkNsaWVudCgKICAgICAgICAgICAgICAgIGNsaWVudF9pZD1zZWxmLmNsaWVudF9pZCwKICAgICAgICAgICAgICAgIGNsZWFuX3Nlc3Npb249VHJ1ZSwKICAgICAgICAgICAgICAgIHByb3RvY29sPW1xdHQuTVFUVHYzMTEKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYxIikKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIHjDoWMgdGjhu7FjIG7hur91IGPDswogICAgICAgIGlmIHNlbGYudXNlcm5hbWUgYW5kIHNlbGYucGFzc3dvcmQ6CiAgICAgICAgICAgIGNsaWVudC51c2VybmFtZV9wd19zZXQoc2VsZi51c2VybmFtZSwgc2VsZi5wYXNzd29yZCkKICAgICAgICAKICAgICAgICAjIMSQxINuZyBrw70gY2FsbGJhY2sKICAgICAgICBjbGllbnQub25fY29ubmVjdCA9IHNlbGYuX29uX2Nvbm5lY3QKICAgICAgICBjbGllbnQub25fbWVzc2FnZSA9IHNlbGYuX29uX21lc3NhZ2UKICAgICAgICBjbGllbnQub25fZGlzY29ubmVjdCA9IHNlbGYuX29uX2Rpc2Nvbm5lY3QKICAgICAgICAKICAgICAgICByZXR1cm4gY2xpZW50CgogICAgZGVmIGNvbm5lY3Qoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiJL4bq/dCBu4buRaSDEkeG6v24gTVFUVCBicm9rZXIiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVOG6oW8gY2xpZW50IG3hu5tpIG7hur91IGNoxrBhIGPDswogICAgICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBzZWxmLl9jcmVhdGVfY2xpZW50KCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzZWxmLnN0b3BfZXZlbnQuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAgIyDEkOG6t3QgcmVjb25uZWN0IGRlbGF5IHRyxrDhu5tjCiAgICAgICAgICAgIHNlbGYuY2xpZW50LnJlY29ubmVjdF9kZWxheV9zZXQobWluX2RlbGF5PTEsIG1heF9kZWxheT02MCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS+G6v3QgbuG7kWkgYuG6pXQgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcga+G6v3QgbuG7kWkgdOG7m2kgTVFUVCBicm9rZXIge3NlbGYuYnJva2VyX2FkZHJlc3N9OntzZWxmLmJyb2tlcl9wb3J0fSIpCiAgICAgICAgICAgIHNlbGYuY2xpZW50LmNvbm5lY3RfYXN5bmMoc2VsZi5icm9rZXJfYWRkcmVzcywgc2VsZi5icm9rZXJfcG9ydCwga2VlcGFsaXZlPTYwKQogICAgICAgICAgICBzZWxmLmNsaWVudC5sb29wX3N0YXJ0KCkKCiAgICAgICAgICAgICMgQ2jhu50ga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nICh04buRaSDEkWEgMTAgZ2nDonkpCiAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKDEwKToKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZyDEkeG6v24gTVFUVCBicm9rZXIiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIkvhur90IG7hu5FpIE1RVFQgdGjhuqV0IGLhuqFpIHNhdSB0aOG7nWkgZ2lhbiBjaOG7nSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBr4bq/dCBu4buRaSBNUVRUOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBlbnN1cmVfY29ubmVjdGVkKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIixJDhuqNtIGLhuqNvIGvhur90IG7hu5FpIE1RVFQgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24gY8OhYyB0aGFvIHTDoWMiIiIKICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBsb2dnZXIud2FybmluZygiTVFUVCBjaMawYSBr4bq/dCBu4buRaSwgxJFhbmcgdGjhu60ga+G6v3QgbuG7kWkgbOG6oWkuLi4iKQogICAgICAgIHJldHVybiBzZWxmLmNvbm5lY3QoKQoKICAgIGRlZiBfb25fY29ubmVjdChzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCBmbGFncywgcmMsIHByb3BlcnRpZXM9Tm9uZSk6CiAgICAgICAgIiIiQ2FsbGJhY2sga2hpIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZyIiIgogICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gVHJ1ZQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcgdOG7m2kgTVFUVCBicm9rZXIiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMSDbmcga8O9IG5o4bqtbiB0YXNrCiAgICAgICAgICAgIHNlbGYuY2xpZW50LnN1YnNjcmliZShzZWxmLnRvcGljX3NlcnZlcl90YXNrLCBxb3M9MSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRxINuZyBrw70gbmjhuq1uIHRhc2sgdOG6oWk6IHtzZWxmLnRvcGljX3NlcnZlcl90YXNrfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpCiAgICAgICAgICAgIHNlbGYuc2VuZF9jb25uZWN0X25vdGlmaWNhdGlvbigpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS+G6v3QgbuG7kWkgTVFUVCB0aOG6pXQgYuG6oWkgduG7m2kgbcOjIGzhu5dpOiB7cmN9IikKCiAgICBkZWYgX29uX2Rpc2Nvbm5lY3Qoc2VsZiwgY2xpZW50LCB1c2VyZGF0YSwgcmMsIHByb3BlcnRpZXM9Tm9uZSwgcmVhc29uX2NvZGU9Tm9uZSwgKiprd2FyZ3MpOgogICAgICAgICIiIkNhbGxiYWNrIGtoaSBuZ+G6r3Qga+G6v3QgbuG7kWkiIiIKICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJOZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCBraMO0bmcgbW9uZyBtdeG7kW4gduG7m2kgbcOjIGzhu5dpOiB7cmN9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBuZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIpCgogICAgZGVmIF9zYWZlX3B1Ymxpc2goc2VsZiwgdG9waWM6IHN0ciwgcGF5bG9hZDogc3RyLCBxb3M6IGludCA9IDEpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgR+G7rWkgbWVzc2FnZSBhbiB0b8OgbiB24bubaSBraeG7g20gdHJhIGvhur90IG7hu5FpIHRyxrDhu5tjIGtoaSBwdWJsaXNoCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdG9waWM6IE1RVFQgdG9waWMKICAgICAgICAgICAgcGF5bG9hZDogTuG7mWkgZHVuZyBtZXNzYWdlIChzdHJpbmcpCiAgICAgICAgICAgIHFvczogUXVhbGl0eSBvZiBTZXJ2aWNlICgwLCAxLCBob+G6t2MgMikKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBn4butaSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2Nvbm5lY3RlZCgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IE1RVFQgY2jGsGEga+G6v3QgbuG7kWkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmNsaWVudC5wdWJsaXNoKHRvcGljLCBwYXlsb2FkLCBxb3M9cW9zKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0LnJjID09IG1xdHQuTVFUVF9FUlJfU1VDQ0VTUzoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBn4butaSBtZXNzYWdlIHRow6BuaCBjw7RuZyDEkeG6v24ge3RvcGljfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IHttcXR0LmVycm9yX3N0cmluZyhyZXN1bHQucmMpfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgbWVzc2FnZSDEkeG6v24ge3RvcGljfToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VuZF90YXNrX3JlcG9ydChzZWxmLCB0YXNrX2lkOiBzdHIsIGRldmljZV9pZDogc3RyLCBzdGF0dXM6IHN0ciwgY2xpZW50X21lc3NhZ2U6IHN0ciA9ICIiKToKICAgICAgICAiIiJH4butaSBiw6FvIGPDoW8ga+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiB0YXNrIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXBvcnRfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJ0YXNrX2lkIjogdGFza19pZCwKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzLAogICAgICAgICAgICAgICAgImNsaWVudF9tZXNzYWdlIjogY2xpZW50X21lc3NhZ2UsCiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBzZWxmLl9zYWZlX3B1Ymxpc2goImRuZHZpbmEvY2xpZW50L3Rhc2tfcmVwb3J0IiwganNvbi5kdW1wcyhyZXBvcnRfZGF0YSkpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGfhu61pIGLDoW8gY8OhbyB0YXNrIHt0YXNrX2lkfSB24bubaSB0cuG6oW5nIHRow6FpIHtzdGF0dXN9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBn4butaSBiw6FvIGPDoW8gdGFzazoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VuZF9jb25uZWN0X25vdGlmaWNhdGlvbihzZWxmKToKICAgICAgICAiIiJH4butaSB0aMO0bmcgYsOhbyBr4bq/dCBu4buRaSDEkeG6v24gc2VydmVyIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25uZWN0X2RhdGEgPSB7CiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogc2VsZi5kZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBzZWxmLl9zYWZlX3B1Ymxpc2goImRuZHZpbmEvY2xpZW50L2Nvbm5lY3QiLCBqc29uLmR1bXBzKGNvbm5lY3RfZGF0YSkpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpIGNobyB0aGnhur90IGLhu4sge3NlbGYuZGV2aWNlX2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgdGjDtG5nIGLDoW8ga+G6v3QgbuG7kWk6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHJlZ2lzdGVyX3Rhc2tfaGFuZGxlcihzZWxmLCB0YXNrX3R5cGU6IHN0ciwgaGFuZGxlcjogQ2FsbGFibGUpOgogICAgICAgICIiIgogICAgICAgIMSQxINuZyBrw70gaGFuZGxlciBjaG8gbG/huqFpIHRhc2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX3R5cGU6IExv4bqhaSB0YXNrCiAgICAgICAgICAgIGhhbmRsZXI6IEjDoG0geOG7rSBsw70gdGFzawogICAgICAgICIiIgogICAgICAgIHNlbGYudGFza19oYW5kbGVyc1t0YXNrX3R5cGVdID0gaGFuZGxlcgogICAgCiAgICBkZWYgc3luY19kYXRhKHNlbGYpOgogICAgICAgICIiIsSQ4buTbmcgYuG7mSBk4buvIGxp4buHdSB24bubaSBzZXJ2ZXIiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTuG6v3UgY2jGsGEga+G6v3QgbuG7kWkgTVFUVCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiBub3Qgc2VsZi5pc19jb25uZWN0ZWQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiQ2jGsGEga+G6v3QgbuG7kWkgTVFUVCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGhlbHBlciA9IHNlbGYuaGVscGVyX3NlcnZpY2UKICAgICAgICAgICAgaWYgbm90IGhlbHBlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIGPDsyBoZWxwZXIgc2VydmljZSwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZAogICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQsIGtow7RuZyB0aOG7gyDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfaW5mbyA9IE5vbmUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlX2luZm9fcmVzcG9uc2UgPSBoZWxwZXIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBs4bqleSB0aMOgbmggY8O0bmcsIGzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgZGV2aWNlX2luZm9fcmVzcG9uc2VbInN0YXR1cyJdID09ICJzdWNjZXNzIiBhbmQgImRhdGEiIGluIGRldmljZV9pbmZvX3Jlc3BvbnNlOgogICAgICAgICAgICAgICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zYXZlX2RldmljZV9pbmZvKGRldmljZV9pbmZvX3Jlc3BvbnNlWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBkZXZpY2VfaW5mb19yZXNwb25zZVsiZGF0YSJdCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBs4bqleSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7izoge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYyB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iywgc+G7rSBk4bulbmcgdGjDtG5nIHRpbiDEkcOjIGzGsHUgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pbmZvOgogICAgICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBzZWxmLmRiLmdldF9kZXZpY2VfaW5mbygpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pbmZvOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyBjw7MgdGjDtG5nIHRpbiB0aGnhur90IGLhu4ssIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSBjw7MgdGjhu4Mga2jDtG5nIMSR4bqneSDEkeG7pyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2NvbmZpZyA9IHNlbGYuZGIuZ2V0X2FsbF9kZXZpY2VfY29uZmlnKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG/huqFpIGLhu48gZ29saWtlX3JlcG9ydCBraOG7j2kgZGV2aWNlX2NvbmZpZyDEkeG7gyBn4butaSByacOqbmcKICAgICAgICAgICAgZ29saWtlX3JlcG9ydCA9IE5vbmUKICAgICAgICAgICAgaWYgImdvbGlrZV9yZXBvcnQiIGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBnb2xpa2VfcmVwb3J0ID0gZGV2aWNlX2NvbmZpZy5wb3AoImdvbGlrZV9yZXBvcnQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBnb2xpa2VfYXBpX2Jhc2Uga2jhu49pIGRldmljZV9jb25maWcKICAgICAgICAgICAgaWYgImdvbGlrZV9hcGlfYmFzZSIgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWcucG9wKCJnb2xpa2VfYXBpX2Jhc2UiKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCLEkMOjIGxv4bqhaSBi4buPIGdvbGlrZV9hcGlfYmFzZSBraOG7j2kgZOG7ryBsaeG7h3UgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGPDoWMgdMOgaSBraG/huqNuIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICBwZW5kaW5nX2FjY291bnRzID0gc2VsZi5kYi5nZXRfcGVuZGluZ19zeW5jX2l0ZW1zKCJhY2NvdW50cyIsIGxpbWl0PTUwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBjw6FjIGpvYiBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgcGVuZGluZ19qb2JzID0gc2VsZi5kYi5nZXRfcGVuZGluZ19zeW5jX2l0ZW1zKCJqb2JzX2hpc3RvcnkiLCBsaW1pdD01MCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHBheWxvYWQKICAgICAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2luZm8iOiBkZXZpY2VfaW5mbywKICAgICAgICAgICAgICAgICJkZXZpY2VfY29uZmlnIjogZGV2aWNlX2NvbmZpZywKICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZ29saWtlX3JlcG9ydCBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgZ29saWtlX3JlcG9ydDoKICAgICAgICAgICAgICAgIHBheWxvYWRbImdvbGlrZV9yZXBvcnQiXSA9IGdvbGlrZV9yZXBvcnQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIHTDoGkga2hv4bqjbiBjaMawYSDEkeG7k25nIGLhu5kgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHBlbmRpbmdfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJhY2NvdW50cyJdID0gcGVuZGluZ19hY2NvdW50cwogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG7k25nIGLhu5kge2xlbihwZW5kaW5nX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGNoxrBhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBqb2IgY2jGsGEgxJHhu5NuZyBi4buZIG7hur91IGPDswogICAgICAgICAgICBpZiBwZW5kaW5nX2pvYnM6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJqb2JzIl0gPSBwZW5kaW5nX2pvYnMKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDhu5NuZyBi4buZIHtsZW4ocGVuZGluZ19qb2JzKX0gam9iIGNoxrBhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBH4butaSBk4buvIGxp4buHdQogICAgICAgICAgICBzZWxmLl9zYWZlX3B1Ymxpc2goY29uZmlnLk1RVFRfVE9QSUNfQ0xJRU5UX1NZTkMsIGpzb24uZHVtcHMocGF5bG9hZCkpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSB24bubaSBzZXJ2ZXIiKQogICAgCiAgICBkZWYgc3RhcnRfc3luY190aHJlYWQoc2VsZik6CiAgICAgICAgIiIiQuG6r3QgxJHhuqd1IHRocmVhZCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIiIiCiAgICAgICAgaWYgc2VsZi5zeW5jX3RocmVhZCBpcyBub3QgTm9uZSBhbmQgc2VsZi5zeW5jX3RocmVhZC5pc19hbGl2ZSgpOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiVGhyZWFkIMSR4buTbmcgYuG7mSDEkcOjIMSRYW5nIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgc2VsZi5zdG9wX2V2ZW50LmNsZWFyKCkKICAgICAgICBzZWxmLnN5bmNfdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5fc3luY19sb29wLCBkYWVtb249VHJ1ZSkKICAgICAgICBzZWxmLnN5bmNfdGhyZWFkLnN0YXJ0KCkKICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBraOG7n2kgxJHhu5luZyB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIpCiAgICAKICAgIGRlZiBfc3luY19sb29wKHNlbGYpOgogICAgICAgICIiIkxvb3AgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIiIgogICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IMSR4buTbmcgYuG7mSB04buxIMSR4buZbmcgbeG7l2kge3NlbGYuc3luY19pbnRlcnZhbH0gZ2nDonkiKQoKICAgICAgICB3aGlsZSBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpIGFuZCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY19kYXRhKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgcXXDoSB0csOsbmggxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZzoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmdo4buJIMSR4bq/biBs4bqnbiDEkeG7k25nIGLhu5kgdGnhur9wIHRoZW8KICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2Uoc2VsZi5zeW5jX2ludGVydmFsKToKICAgICAgICAgICAgICAgIGlmIHNlbGYuc3RvcF9ldmVudC5pc19zZXQoKSBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAKICAgIGRlZiBzdG9wX3N5bmNfdGhyZWFkKHNlbGYpOgogICAgICAgICIiIkThu6tuZyB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIiIgogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgc2VsZi5zdG9wX2V2ZW50LnNldCgpCiAgICAgICAgaWYgc2VsZi5zeW5jX3RocmVhZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5zeW5jX3RocmVhZC5qb2luKHRpbWVvdXQ9Mi4wKQogICAgICAgICAgICBzZWxmLnN5bmNfdGhyZWFkID0gTm9uZQogICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGThu6tuZyB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIpCiAgICAKICAgIGRlZiBkaXNjb25uZWN0KHNlbGYpOgogICAgICAgICIiIk5n4bqvdCBr4bq/dCBu4buRaSBNUVRUIiIiCiAgICAgICAgc2VsZi5zdG9wX3N5bmNfdGhyZWFkKCkKICAgICAgICAKICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5jbGllbnQubG9vcF9zdG9wKCkKICAgICAgICAgICAgc2VsZi5jbGllbnQuZGlzY29ubmVjdCgpCiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gRmFsc2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mgbmfhuq90IGvhur90IG7hu5FpIE1RVFQiKQogICAgCiAgICBkZWYgc2V0dXBfbXF0dF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJUaGnhur90IGzhuq1wIGPDoWMgaGFuZGxlciBjaG8gTVFUVCB0YXNrcyIiIgogICAgICAgICMgxJDEg25nIGvDvSBjw6FjIHRhc2sgaGFuZGxlciBt4bq3YyDEkeG7i25oCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9kZXZpY2VfY29uZmlnIiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9kZXZpY2VfY29uZmlnKQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfc3luY2VkIiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9zeW5jZWQpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoImFjY291bnRfdXBkYXRlIiwgc2VsZi5faGFuZGxlX2FjY291bnRfdXBkYXRlKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIHRoaeG6v3QgbOG6rXAgY8OhYyBNUVRUIHRhc2sgaGFuZGxlciIpCiAgICAgICAgCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfZGV2aWNlX2NvbmZpZyhzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgdOG7qyBzZXJ2ZXIiKQogICAgICAgICAgICBjb25maWdfZGF0YSA9IHRhc2tfZGF0YS5nZXQoImNvbmZpZ19kYXRhIiwge30pCiAgICAgICAgICAgIGlmIG5vdCBjb25maWdfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJE4buvIGxp4buHdSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgcuG7l25nIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHThu6tuZyBj4bqldSBow6xuaCB0aGnhur90IGLhu4sKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2F2ZV9kZXZpY2VfY29uZmlnKGNvbmZpZ19kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7JywgJy5qb2luKGNvbmZpZ19kYXRhLmtleXMoKSl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgc3luY19pbnRlcnZhbCBu4bq/dSBuw7MgdGhheSDEkeG7lWkKICAgICAgICAgICAgICAgIGlmICJzeW5jX2ludGVydmFsIiBpbiBjb25maWdfZGF0YToKICAgICAgICAgICAgICAgICAgICBuZXdfc3luY19pbnRlcnZhbCA9IGNvbmZpZ19kYXRhWyJzeW5jX2ludGVydmFsIl0KICAgICAgICAgICAgICAgICAgICBpZiBuZXdfc3luY19pbnRlcnZhbCAhPSBzZWxmLnN5bmNfaW50ZXJ2YWw6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6rXAgbmjhuq10IHN5bmNfaW50ZXJ2YWwgdOG7qyB7c2VsZi5zeW5jX2ludGVydmFsfSB0aMOgbmgge25ld19zeW5jX2ludGVydmFsfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY19pbnRlcnZhbCA9IG5ld19zeW5jX2ludGVydmFsCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEto4bufaSDEkeG7mW5nIGzhuqFpIHRocmVhZCDEkeG7k25nIGLhu5kgbuG6v3UgxJFhbmcgY2jhuqF5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuc3luY190aHJlYWQgaXMgbm90IE5vbmUgYW5kIHNlbGYuc3luY190aHJlYWQuaXNfYWxpdmUoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgxJHhu5luZyBs4bqhaSB0aHJlYWQgxJHhu5NuZyBi4buZIHbhu5tpIGtob+G6o25nIHRo4budaSBnaWFuIG3hu5tpIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3RvcF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0X3N5bmNfdGhyZWFkKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaMO0bmcgYsOhbyBjaG8gSm9iU2VydmljZSBu4bq/dSBjw7MgdGhheSDEkeG7lWkgbGnDqm4gcXVhbiDEkeG6v24gam9icwogICAgICAgICAgICAgICAgam9iX3JlbGF0ZWRfa2V5cyA9IFsibWF4X2pvYnNfcGVyX2RheSIsICJtYXhfam9ic19wZXJfc2Vzc2lvbiIsICJqb2JfaW50ZXJ2YWxfc2Vjb25kcyJdCiAgICAgICAgICAgICAgICBpZiBhbnkoa2V5IGluIGNvbmZpZ19kYXRhIGZvciBrZXkgaW4gam9iX3JlbGF0ZWRfa2V5cyk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsOBcCBk4bulbmcgY+G6pXUgaMOsbmggbeG7m2kgY2hvIEpvYlNlcnZpY2UiKQogICAgICAgICAgICAgICAgICAgICMgS2jDtG5nIGPhuqduIGto4bufaSDEkeG7mW5nIGzhuqFpLCBKb2JTZXJ2aWNlIHPhur0gbOG6pXkgY+G6pXUgaMOsbmggbeG7m2kga2hpIGPhuqduCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7c3RyKGUpfSIpCgogICAgZGVmIF9oYW5kbGVfdXBkYXRlX3N5bmNlZChzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgc2VydmVyIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiAiYWNjb3VudHMiIGluIGRhdGEgYW5kIGlzaW5zdGFuY2UoZGF0YVsiYWNjb3VudHMiXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudF91dWlkIGluIGRhdGFbImFjY291bnRzIl06CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5tYXJrX2FzX3N5bmNlZCgiYWNjb3VudHMiLCBhY2NvdW50X3V1aWQpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIMSR4buTbmcgYuG7mToge2FjY291bnRfdXVpZH0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB7bGVuKGRhdGFbJ2FjY291bnRzJ10pfSB0w6BpIGtob+G6o24gxJHDoyDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgam9iIMSRw6MgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGlmICJqb2JzIiBpbiBkYXRhIGFuZCBpc2luc3RhbmNlKGRhdGFbImpvYnMiXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3Igam9iX3V1aWQgaW4gZGF0YVsiam9icyJdOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIubWFya19hc19zeW5jZWQoImpvYnNfaGlzdG9yeSIsIGpvYl91dWlkKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSBqb2IgxJHDoyDEkeG7k25nIGLhu5k6IHtqb2JfdXVpZH0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB7bGVuKGRhdGFbJ2pvYnMnXSl9IGpvYiDEkcOjIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEhp4buDbiB0aOG7iyB0aMO0bmcgYsOhbyB04burIHNlcnZlciBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgIm1lc3NhZ2UiIGluIHRhc2tfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjDtG5nIGLDoW8gdOG7qyBzZXJ2ZXI6IHt0YXNrX2RhdGFbJ21lc3NhZ2UnXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5k6IHtzdHIoZSl9IikKICAgICAgICAgICAgCiAgICBkZWYgX2hhbmRsZV9jb25maWdfdXBkYXRlKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gecOqdSBj4bqndSBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdOG7qyBzZXJ2ZXIiKQogICAgICAgICAgICBjb25maWdfZGF0YSA9IHRhc2tfZGF0YS5nZXQoImNvbmZpZ19kYXRhIiwge30pCiAgICAgICAgICAgIGlmIG5vdCBjb25maWdfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJE4buvIGxp4buHdSBj4bqldSBow6xuaCBy4buXbmciKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdHJvbmcgREIKICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX2RhdGEuaXRlbXMoKToKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oOiB7a2V5fSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aMOgbmggY8O0bmciKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oOiB7c3RyKGUpfSIpCiAgICAKICAgIGRlZiBfaGFuZGxlX2FjY291bnRfdXBkYXRlKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIgY8OzIGPhuqV1IHRyw7pjOgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6ICJ0YXNrXzE3NDkzOTk1MzYyNzJfNjQxIiwKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiAiYTEyNWY2MjRmNDFhNGY3YyIsCiAgICAgICAgICAgICAgICAidGFza190eXBlIjogImFjY291bnRfdXBkYXRlIiwKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAgICJhcHAiOiAiaW5zdGFncmFtIiwKICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAiam9iX21heF9kYXkiOiAxMDgsCiAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDMwLAogICAgICAgICAgICAgICAgICAgICJqb2JfZW5hYmxlIjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiYWNjb3VudF91dWlkIjogIjdlZDk1NTdkLTc2YTQtNDdmNy04ODUwLTdjZWVmMGM2OTBhZiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICIiLAogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJwZW5kaW5nIgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIGRhdGEgPSB0YXNrX2RhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGRhdGEgb3IgImFjY291bnRfdXVpZCIgbm90IGluIGRhdGE6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiROG7ryBsaeG7h3UgdMOgaSBraG/huqNuIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiROG7ryBsaeG7h3UgdMOgaSBraG/huqNuIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgREIKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnRfYnlfdXVpZChkYXRhWyJhY2NvdW50X3V1aWQiXSkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gduG7m2kgVVVJRDoge2RhdGFbJ2FjY291bnRfdXVpZCddfSIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgICAgIHZhbGlkX2ZpZWxkcyA9IFsic3RhdHVzIiwgImpvYl9tYXhfZGF5IiwgImpvYl90b2RheSIsICJqb2JfZW5hYmxlIl0KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRhdGEuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGtleSBpbiB2YWxpZF9maWVsZHM6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFba2V5XSA9IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB1cGRhdGVfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIHRow7RuZyB0aW4gY+G6p24gY+G6rXAgbmjhuq10IikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiS2jDtG5nIGPDsyB0aMO0bmcgdGluIGPhuqduIGPhuq1wIG5o4bqtdCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGzhuqFpIHbDoG8gREIKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnJyl9IChVVUlEOiB7ZGF0YVsnYWNjb3VudF91dWlkJ119KSB24bubaSBk4buvIGxp4buHdToge3VwZGF0ZV9kYXRhfSIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIGYixJDDoyBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJycpfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0aOG7gyBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJycpfSIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9tc2cgPSBmIkzhu5dpIHjhu60gbMO9IGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o246IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBNUVRUIHNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSDEkeG7mW5nIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRoaeG6v3QgbOG6rXAgY8OhYyBoYW5kbGVyIHRyxrDhu5tjIGtoaSBr4bq/dCBu4buRaQogICAgICAgICAgICBzZWxmLnNldHVwX21xdHRfaGFuZGxlcnMoKQogICAgICAgICAgICBzZWxmLmNvbm5lY3QoKQogICAgICAgICAgICAjIEto4bufaSDEkeG7mW5nIHN5bmMgdGhyZWFkIHNhdSBraGkga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgIHNlbGYuc3RhcnRfc3luY190aHJlYWQoKQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBraOG7n2kgxJHhu5luZyBNUVRUIHNlcnZpY2UgdsOgIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfb25fbWVzc2FnZShzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCBtc2csIHByb3BlcnRpZXM9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsbGJhY2sga2hpIG5o4bqtbiDEkcaw4bujYyBtZXNzYWdlIHThu6sgTVFUVCBicm9rZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjbGllbnQ6IE1RVFQgY2xpZW50IGluc3RhbmNlCiAgICAgICAgICAgIHVzZXJkYXRhOiBVc2VyIGRhdGEgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbyBjbGllbnQKICAgICAgICAgICAgbXNnOiBNZXNzYWdlIG9iamVjdCBjaOG7qWEgdG9waWMgdsOgIHBheWxvYWQKICAgICAgICAgICAgcHJvcGVydGllczogUHJvcGVydGllcyBj4bunYSBtZXNzYWdlIChNUVRUIHY1KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljOiB7bXNnLnRvcGljfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFBhcnNlIHBheWxvYWQgSlNPTgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXlsb2FkID0ganNvbi5sb2Fkcyhtc2cucGF5bG9hZC5kZWNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIGV4Y2VwdCBqc29uLkpTT05EZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBwYXJzZSBKU09OIHThu6sgcGF5bG9hZDoge21zZy5wYXlsb2FkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70gbWVzc2FnZSBk4buxYSB0csOqbiB0b3BpYwogICAgICAgICAgICBpZiBtc2cudG9waWMgPT0gc2VsZi50b3BpY19zZXJ2ZXJfdGFzazoKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9zZXJ2ZXJfdGFzayhwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljIGtow7RuZyB4w6FjIMSR4buLbmg6IHttc2cudG9waWN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgeOG7rSBsw70gbWVzc2FnZToge3N0cihlKX0iKQoKICAgIGRlZiBfaGFuZGxlX3NlcnZlcl90YXNrKHNlbGYsIHBheWxvYWQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcGF5bG9hZDogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza190eXBlID0gcGF5bG9hZC5nZXQoInRhc2tfdHlwZSIpCiAgICAgICAgICAgIGlmIG5vdCB0YXNrX3R5cGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiTmjhuq1uIHRhc2sga2jDtG5nIGPDsyB0YXNrX3R5cGUiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB0YXNrIHThu6sgc2VydmVyOiB7dGFza190eXBlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIGhhbmRsZXIgdMawxqFuZyDhu6luZyBu4bq/dSDEkcOjIMSRxINuZyBrw70KICAgICAgICAgICAgaWYgdGFza190eXBlIGluIHNlbGYudGFza19oYW5kbGVyczoKICAgICAgICAgICAgICAgIHNlbGYudGFza19oYW5kbGVyc1t0YXNrX3R5cGVdKHBheWxvYWQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBoYW5kbGVyIGNobyB0YXNrX3R5cGU6IHt0YXNrX3R5cGV9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB44butIGzDvSB0YXNrIHThu6sgc2VydmVyOiB7c3RyKGUpfSIp').decode('utf-8'))
