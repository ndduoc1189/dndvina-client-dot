import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgZGF0ZQppbXBvcnQgcmFuZG9tCmltcG9ydCBqc29uCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsCmltcG9ydCBjb25maWcKaW1wb3J0IHV0aWxzCmZyb20gdXRpbHMgaW1wb3J0IExvZ0xldmVsLCBMb2dnZXIKZnJvbSBqb2JzIGltcG9ydCBUaWt0b2tKb2IsIFRpa3RvazJKb2IsIEluc3RhZ3JhbUpvYiwgWW91dHViZUpvYgpmcm9tIHNlcnZpY2VzLnByb3h5X3NlcnZpY2UgaW1wb3J0IFByb3h5U2VydmljZQoKIyBU4bqhbyBsb2dnZXIgY2hvIE1haW5TZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIk1haW5TZXJ2aWNlIikKCiMgQ29uc3RhbnRzIGNobyBNYWluU2VydmljZQpjbGFzcyBNYWluU2VydmljZUNvbnN0YW50czoKICAgICIiIkNvbnN0YW50cyBkw7luZyB0cm9uZyBNYWluU2VydmljZSIiIgogICAgREVGQVVMVF9DSEVDS19JTlRFUlZBTCA9IDAuNSAgIyBTbGVlcCBjaGVjayBpbnRlcnZhbCB0w61uaCBi4bqxbmcgZ2nDonkKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIEPDoWMgbG/huqFpIGjDoG5oIMSR4buZbmcKICAgIEFDVElPTl9ORVdTRkVFRCA9ICJuZXdzZmVlZCIgICAgICAgICAgICMgVnXhu5F0IGLhuqNuZyB0aW4KICAgIEFDVElPTl9SRUVMUyA9ICJyZWVscyIgICAgICAgICAgICAgICAgICMgWGVtIHJlZWxzL3ZpZGVvCiAgICBBQ1RJT05fTk9USUZJQ0FUSU9OID0gIm5vdGlmaWNhdGlvbiIgICAgIyBYZW0gdGjDtG5nIGLDoW8KICAgIEFDVElPTl9QUk9GSUxFID0gInByb2ZpbGUiICAgICAgICAgICAgICMgWGVtIHByb2ZpbGUKICAgIEFDVElPTl9KT0IgPSAiam9iIiAgICAgICAgICAgICAgICAgICAgICMgTMOgbSBqb2IKICAgIEFDVElPTl9FWFBMT1JFID0gImV4cGxvcmUiICAgICAgICAgICAgICMgS2jDoW0gcGjDoQogICAgQUNUSU9OX1NFQVJDSCA9ICJzZWFyY2giICAgICAgICAgICAgICAgIyBUw6xtIGtp4bq/bQogICAgCiAgICAjIFThu4kgbOG7hyBow6BuaCDEkeG7mW5nIG3hurdjIMSR4buLbmggKCUpIC0gREVQUkVDQVRFRDogQWN0aW9uIHByb2Nlc3NpbmcgbW92ZWQgdG8gSm9iQmFzZSBoYW5kbGVycwogICAgIyBFYWNoIGFwcCBub3cgZGVmaW5lcyBpdHMgb3duIGFjdGlvbiB3ZWlnaHRzIHZpYSBnZXRfYWN0aW9uX3dlaWdodHMoKSBtZXRob2QKICAgIERFRkFVTFRfQUNUSU9OX1dFSUdIVFMgPSB7CiAgICAgICAgQUNUSU9OX05FV1NGRUVEOiAxNSwgICAgICAjIDE1JSB2deG7kXQgbmV3c2ZlZWQKICAgICAgICBBQ1RJT05fUkVFTFM6IDIwLCAgICAgICAgICMgMjAlIHhlbSByZWVscwogICAgICAgIEFDVElPTl9OT1RJRklDQVRJT046IDEwLCAgICMgMTAlIHhlbSBub3RpZmljYXRpb24KICAgICAgICBBQ1RJT05fUFJPRklMRTogMTUsICAgICAgICMgMTUlIHhlbSBwcm9maWxlCiAgICAgICAgQUNUSU9OX0pPQjogMjAsICAgICAgICAgICAjIDIwJSBsw6BtIGpvYgogICAgICAgIEFDVElPTl9FWFBMT1JFOiA1LCAgICAgICAgIyA1JSBraMOhbSBwaMOhCiAgICAgICAgQUNUSU9OX1NFQVJDSDogMTUgICAgICAgICAjIDE1JSB0w6xtIGtp4bq/bQogICAgICAgICMgTm90ZTogQXBwcyBtYXkgZGVmaW5lIGFkZGl0aW9uYWwgYWN0aW9ucyAoZS5nLiwgVGlrVG9rICJsaXZlIiwgSW5zdGFncmFtICJzdG9yeSIpCiAgICB9CiAgICAKICAgICMgU3RhdHVzIG1lc3NhZ2VzCiAgICBNU0dfREVWSUNFX1BBVVNFRF9TRVJWRVIgPSAiVOG6oW0gZOG7q25nIChTZXZlciB5w6p1IGPhuqd1KSIKICAgIE1TR19ERVZJQ0VfTk9fQUNDT1VOVFMgPSAiVOG6oW0gbmdo4buJIChLaMO0bmcgY8OzIHTDoGkga2hv4bqjbikiCiAgICBNU0dfV0FJVElOR19QUk9YWSA9ICLEkGFuZyBjaOG7nSBwcm94eSIKICAgIE1TR19XT1JLSU5HX0hBUk1PTklPVVMgPSAixJBhbmcgbMOgbSB2aeG7h2MgaMOgaSBow7JhIgogICAgTVNHX0NBUklOR19BQ0NPVU5UID0gIsSQYW5nIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIgogICAgTVNHX0RPSU5HX0pPQiA9ICLEkGFuZyBsw6BtIGpvYiIKICAgIAogICAgIyBDYXJlIGFjdGlvbiBsaW1pdHMgcGVyIHNlc3Npb24KICAgIE1BWF9DQVJFX0FDVElPTlNfUEVSX1NFU1NJT04gPSA1ICAgICMgVOG7kWkgxJFhIDUgaMOgbmggxJHhu5luZyBjYXJlIHRyxrDhu5tjIGtoaSBsw6BtIGpvYgogICAgCiAgICAjIFNlc3Npb24gbGltaXRzIGFuZCByZXN0IHBlcmlvZHMgLSBz4bq9IGzhuqV5IHThu6sgZGF0YWJhc2UvYWNjb3VudCBjb25maWcKICAgICMgTUFYX0FDVElPTlNfUEVSX1NFU1NJT04gc+G6vSDEkcaw4bujYyB0w61uaCDEkeG7mW5nIGThu7FhIHRyw6puIG1heF9qb2JzX3Blcl9zZXNzaW9uIAogICAgIyBNQVhfSk9CU19QRVJfU0VTU0lPTiBz4bq9IMSRxrDhu6NjIGzhuqV5IHThu6sgYWNjb3VudC5tYXhfam9ic19wZXJfc2Vzc2lvbgogICAgIyBNQVhfU0VTU0lPTl9EVVJBVElPTiBz4bq9IMSRxrDhu6NjIGzhuqV5IHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICBERUZBVUxUX01BWF9BQ1RJT05TX1BFUl9TRVNTSU9OID0gMzAgICAjIE3hurdjIMSR4buLbmggMzAgYWN0aW9ucyB04buRaSDEkWEKICAgIERFRkFVTFRfTUFYX1NFU1NJT05fRFVSQVRJT04gPSAxODAwICAgICMgTeG6t2MgxJHhu4tuaCAzMCBwaMO6dCBu4bq/dSBraMO0bmcgY8OzIGNvbmZpZwogICAgTUlOX1JFU1RfQkVUV0VFTl9BQ0NPVU5UUyA9IDYwICAgICAgICAgIyBOZ2jhu4kgdOG7kWkgdGhp4buDdSAxIHBow7p0IGdp4buvYSBjw6FjIGFjY291bnQKICAgIE1BWF9SRVNUX0JFVFdFRU5fQUNDT1VOVFMgPSAzMDAgICAgICAgICMgTmdo4buJIHThu5FpIMSRYSA1IHBow7p0IGdp4buvYSBjw6FjIGFjY291bnQKICAgIAogICAgIyBHaeG7m2kgaOG6oW4gYWN0aW9ucyBjaG8gZHluYW1pYyBjYWxjdWxhdGlvbgogICAgTUlOX0FDVElPTlNfUEVSX1NFU1NJT04gPSA4ICAgICAgICAgICAgIyBU4buRaSB0aGnhu4N1IDggYWN0aW9ucyBkw7kgYWNjb3VudHMgw610CiAgICBNQVhfQUNUSU9OU19QRVJfU0VTU0lPTiA9IDMwICAgICAgICAgICAjIEdp4bubaSBo4bqhbiB04buRaSDEkWEgMzAgYWN0aW9ucyBjaG8gbeG7l2kgc2Vzc2lvbiAoa2jDtG5nIHTDrW5oIHThu6sgam9iKQogICAgCiAgICAjIFRocmVzaG9sZHMgxJHhu4MgcXV54bq/dCDEkeG7i25oIGNodXnhu4NuIGFjY291bnQKICAgIFNXSVRDSF9BQ0NPVU5UX0FGVEVSX0NPTlNFQ1VUSVZFX0ZBSUxTID0gMyAgIyBDaHV54buDbiBhY2NvdW50IHNhdSAzIGzhuqduIHRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AKICAgIFNXSVRDSF9BQ0NPVU5UX0FGVEVSX05PX0pPQlMgPSA1ICAgICAgICAgICAgIyBDaHV54buDbiBhY2NvdW50IHNhdSA1IGzhuqduIGtow7RuZyBjw7Mgam9iIGxpw6puIHRp4bq/cAoKY2xhc3MgTWFpblNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfc2VydmljZSwgaGVscGVyX3NlcnZpY2UsIGdvbGlrZV9zZXJ2aWNlLCBtcXR0X3NlcnZpY2U9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIE1haW5TZXJ2aWNlIC0gU2VydmljZSB0w61jaCBo4bujcCBjaMSDbSBzw7NjIHbDoCBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBMb2NrIMSR4buDIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpCiAgICAgICAgc2VsZi5fbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICAKICAgICAgICAjIERpY3Rpb25hcnkgxJHhu4MgxJHhur9tIHPhu5EgaMOgbmggxJHhu5luZyBjYXJlIHRyb25nIHNlc3Npb24KICAgICAgICBzZWxmLmNhcmVfYWN0aW9uX2NvdW50cyA9IHt9ICAjIHthY2NvdW50X2lkOiBjb3VudH0KICAgICAgICAKICAgICAgICAjIERpY3Rpb25hcnkgxJHhu4MgbMawdSBs4buLY2ggc+G7rSBow6BuaCDEkeG7mW5nIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeSA9IHt9ICAjIHthY2NvdW50X2lkOiBbYWN0aW9uc119CiAgICAgICAgCiAgICAgICAgIyBTZXNzaW9uIG1hbmFnZW1lbnQgcGVyIGFjY291bnQKICAgICAgICBzZWxmLmFjY291bnRfc2Vzc2lvbnMgPSB7fSAgIyB7YWNjb3VudF9pZDogc2Vzc2lvbl9kYXRhfQogICAgICAgIAogICAgICAgICMgVHJhY2sgY29uc2VjdXRpdmUgZmFpbHVyZXMgcGVyIGFjY291bnQKICAgICAgICBzZWxmLmFjY291bnRfY29uc2VjdXRpdmVfZmFpbHVyZXMgPSB7fSAgIyB7YWNjb3VudF9pZDogY291bnR9CiAgICAgICAgCiAgICAgICAgIyBUcmFjayBjb25zZWN1dGl2ZSBuby1qb2IgYXR0ZW1wdHMgcGVyIGFjY291bnQKICAgICAgICBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzID0ge30gICMge2FjY291bnRfaWQ6IGNvdW50fQogICAgICAgIAogICAgICAgICMgQWNjb3VudCByZXN0IHBlcmlvZHMgLSBERVBSRUNBVEVEOiBub3cgdXNpbmcgREIgc3RhdHVzID0gaW5hY3RpdmUgKyBqb2JfZGlzYWJsZV91bnRpbAogICAgICAgICMgc2VsZi5hY2NvdW50X2xhc3Rfd29ya190aW1lID0ge30gICMge2FjY291bnRfaWQ6IHRpbWVzdGFtcH0KICAgICAgICAjIHNlbGYuYWNjb3VudF9yZXN0X3VudGlsID0ge30gICMge2FjY291bnRfaWQ6IHRpbWVzdGFtcH0KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgdMOsbSB0aOG6pXkgam9iCiAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgCiAgICAgICAgIyBUcmFjayB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIMSR4buDIHRyw6FuaCByZXNldCBJUCBwcm94eSBsacOqbiB04bulYwogICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgIAogICAgICAgICMgVHJhY2sgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSDEkWFuZyDEkcSDbmcgbmjhuq1wIHRoZW8gYXBwCiAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyA9IHt9ICAjIHthcHBfbmFtZTogYWNjb3VudF9pZH0KICAgICAgICAKICAgICAgICAjIEZsYWcgxJHhu4MgdHJhY2sgeGVtIMSRw6MgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCBjaMawYSBraGkga2jhu59pIMSR4buZbmcgKGdp4buRbmcgSm9iU2VydmljZSkKICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCA9IHt9ICAjIHthcHBfbmFtZTogYm9vbH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgbMOgbSB2aeG7h2MKICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgIAogICAgICAgICMgVHJhY2sgY29uc2VjdXRpdmUgbm8tam9iIGF0dGVtcHRzIHBlciBhY2NvdW50ICh04burIEpvYlNlcnZpY2UpCiAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0cyA9IHt9ICAjIHthY2NvdW50X2lkOiBjb3VudH0KICAgICAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBpbnRdOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGdp4bubaSBo4bqhbiBzZXNzaW9uIGNobyBhY2NvdW50IHThu6sgZGF0YWJhc2UgY29uZmlnCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogU2Vzc2lvbiBsaW1pdHMgY2hvIGFjY291bnQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgbWF4X2pvYnNfcGVyX3Nlc3Npb24gdOG7qyBhY2NvdW50IGNvbmZpZyBob+G6t2MgY29uZmlnLnB5CiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrW5oIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIMSR4buZbmcgZOG7sWEgdHLDqm4gbWF4X2pvYnNfcGVyX3Nlc3Npb24gdsOgIGFwcCBjb25maWcKICAgICAgICAgICAgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gPSBzZWxmLl9jYWxjdWxhdGVfZHluYW1pY19hY3Rpb25zX2xpbWl0KG1heF9qb2JzX3Blcl9zZXNzaW9uLCBhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBtYXhfc2Vzc2lvbl9kdXJhdGlvbiB04burIGRhdGFiYXNlIGNvbmZpZyAodMOtbmggYuG6sW5nIHBow7p0LCBjaHV54buDbiB0aMOgbmggZ2nDonkpCiAgICAgICAgICAgIG1heF9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJtYXhfc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzIiwgTWFpblNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9NQVhfU0VTU0lPTl9EVVJBVElPTiAvLyA2MCkKICAgICAgICAgICAgbWF4X3Nlc3Npb25fZHVyYXRpb24gPSBtYXhfc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzICogNjAKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge2FjY291bnQuZ2V0KCdpZCcpfTogbWF4X2pvYnM9e21heF9qb2JzX3Blcl9zZXNzaW9ufSwgY2FsY3VsYXRlZF9tYXhfYWN0aW9ucz17bWF4X2FjdGlvbnNfcGVyX3Nlc3Npb259IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBtYXhfam9ic19wZXJfc2Vzc2lvbiwKICAgICAgICAgICAgICAgICJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiI6IG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uLAogICAgICAgICAgICAgICAgIm1heF9zZXNzaW9uX2R1cmF0aW9uIjogbWF4X3Nlc3Npb25fZHVyYXRpb24KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGdldCBzZXNzaW9uIGxpbWl0czoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgICAgICJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiI6IE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1BWF9BQ1RJT05TX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAgICAgIm1heF9zZXNzaW9uX2R1cmF0aW9uIjogTWFpblNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9NQVhfU0VTU0lPTl9EVVJBVElPTgogICAgICAgICAgICB9CiAgICAKICAgIGRlZiBfY2FsY3VsYXRlX2R5bmFtaWNfYWN0aW9uc19saW1pdChzZWxmLCBtYXhfam9ic19wZXJfc2Vzc2lvbjogaW50LCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUw61uaCB0b8OhbiBkeW5hbWljIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIGThu7FhIHRyw6puIGFwcCBjb25maWcgaG/hurdjIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgCiAgICAgICAgTG9naWM6CiAgICAgICAgLSDGr3UgdGnDqm4gbOG6pXkgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gdOG7qyBhcHAgY29uZmlnCiAgICAgICAgLSBO4bq/dSBraMO0bmcgY8OzIHRow6wgdMOtbmggdG/DoW4gZOG7sWEgdHLDqm4gbWF4X2pvYnNfcGVyX3Nlc3Npb24gduG7m2kgcmF0aW8KICAgICAgICAtIMOBcCBk4bulbmcgZ2nhu5tpIGjhuqFuIHThu5FpIHRoaeG7g3UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbjogU+G7kSBqb2JzIHThu5FpIMSRYSB0cm9uZyBzZXNzaW9uCiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIMSR4buDIGzhuqV5IGNvbmZpZyBhcHAgY+G7pSB0aOG7gyAob3B0aW9uYWwpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogU+G7kSBhY3Rpb25zIHThu5FpIMSRYSB0w61uaCB0b8OhbiDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBnaeG7m2kgaOG6oW4gdOG7qyBhcHAgY29uZmlnIG7hur91IGPDsyBhY2NvdW50CiAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBhcHBfY29uZmlnID0gaGFuZGxlci5nZXRfYXBwX2NvbmZpZygpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBtaW5fYWN0aW9ucyB04burIGFwcCBjb25maWcKICAgICAgICAgICAgICAgICAgICBtaW5fYWN0aW9ucyA9IGFwcF9jb25maWcuZ2V0KCJtaW5fYWN0aW9uc19wZXJfc2Vzc2lvbiIsIE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1JTl9BQ1RJT05TX1BFUl9TRVNTSU9OKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgxq9VIFRJw4pOOiBM4bqleSBtYXhfYWN0aW9ucyB0cuG7sWMgdGnhur9wIHThu6sgYXBwIGNvbmZpZwogICAgICAgICAgICAgICAgICAgIGFwcF9tYXhfYWN0aW9ucyA9IGFwcF9jb25maWcuZ2V0KCJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiIpCiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX21heF9hY3Rpb25zOgogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbF9hY3Rpb25zID0gbWF4KG1pbl9hY3Rpb25zLCBhcHBfbWF4X2FjdGlvbnMpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlPhu60gZOG7pW5nIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIHThu6sge2FwcF9uYW1lfSBjb25maWc6IHtmaW5hbF9hY3Rpb25zfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmaW5hbF9hY3Rpb25zCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQXBwIHthcHBfbmFtZX0ga2jDtG5nIGPDsyBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiwgdMOtbmggdG/DoW4gxJHhu5luZyIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgRmFsbGJhY2sgduG7gSBjb25zdGFudHMKICAgICAgICAgICAgICAgICAgICBtaW5fYWN0aW9ucyA9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1JTl9BQ1RJT05TX1BFUl9TRVNTSU9OCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiRmFsbGJhY2sgduG7gSBjb25zdGFudHM6IG1pbj17bWluX2FjdGlvbnN9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgS2jDtG5nIGPDsyBhY2NvdW50LCBkw7luZyBjb25zdGFudHMKICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gTWFpblNlcnZpY2VDb25zdGFudHMuTUlOX0FDVElPTlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOtbmggdG/DoW4gYWN0aW9ucyBj4bqnbiB0aGnhur90IGThu7FhIHRyw6puIHPhu5Egam9icyAoZmFsbGJhY2spCiAgICAgICAgICAgIGRlZmF1bHRfcmF0aW8gPSAyLjUKICAgICAgICAgICAgY2FsY3VsYXRlZF9hY3Rpb25zID0gaW50KG1heF9qb2JzX3Blcl9zZXNzaW9uICogZGVmYXVsdF9yYXRpbykKICAgICAgICAgICAgbWF4X2FjdGlvbnMgPSBNYWluU2VydmljZUNvbnN0YW50cy5NQVhfQUNUSU9OU19QRVJfU0VTU0lPTgogICAgICAgICAgICAKICAgICAgICAgICAgIyDDgXAgZOG7pW5nIGdp4bubaSBo4bqhbiB04buRaSB0aGnhu4N1IHbDoCB04buRaSDEkWEKICAgICAgICAgICAgZmluYWxfYWN0aW9ucyA9IG1heChtaW5fYWN0aW9ucywgbWluKGNhbGN1bGF0ZWRfYWN0aW9ucywgbWF4X2FjdGlvbnMpKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiRHluYW1pYyBhY3Rpb25zIGNhbGN1bGF0aW9uOiB7bWF4X2pvYnNfcGVyX3Nlc3Npb259IGpvYnMgKiB7ZGVmYXVsdF9yYXRpb30gcmF0aW8gPSB7Y2FsY3VsYXRlZF9hY3Rpb25zfSDihpIgZmluYWw6IHtmaW5hbF9hY3Rpb25zfSAobWluOiB7bWluX2FjdGlvbnN9LCBtYXg6IHttYXhfYWN0aW9uc30pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBmaW5hbF9hY3Rpb25zCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2FsY3VsYXRlIGR5bmFtaWMgYWN0aW9ucyBsaW1pdDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkRFRkFVTFRfTUFYX0FDVElPTlNfUEVSX1NFU1NJT04KICAgIAogICAgZGVmIF9nZXRfYWNjb3VudF9yZXN0X2R1cmF0aW9uKHNlbGYpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aOG7nWkgZ2lhbiBuZ2jhu4kgbmfGoWkgdOG7qyBjb25maWcgZGF0YWJhc2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSAoZ2nDonkpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGpvYl9jb29sZG93bl9taW51dGVzIHThu6sgZGF0YWJhc2UgY29uZmlnCiAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJqb2JfY29vbGRvd25fbWludXRlcyIsIGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENvbnZlcnQgcGjDunQgdGjDoG5oIGdpw6J5CiAgICAgICAgICAgIGJhc2VfZHVyYXRpb24gPSBjb29sZG93bl9taW51dGVzICogNjAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gcmFuZG9tIHRyb25nIGtob+G6o25nIMKxMjAlIG5oxrBuZyBnaeG7m2kgaOG6oW4gaOG7o3AgbMO9CiAgICAgICAgICAgIHZhcmlhdGlvbiA9IGludChiYXNlX2R1cmF0aW9uICogMC4yKQogICAgICAgICAgICBtaW5fZHVyYXRpb24gPSBtYXgoTWFpblNlcnZpY2VDb25zdGFudHMuTUlOX1JFU1RfQkVUV0VFTl9BQ0NPVU5UUywgYmFzZV9kdXJhdGlvbiAtIHZhcmlhdGlvbikKICAgICAgICAgICAgbWF4X2R1cmF0aW9uID0gbWluKE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1BWF9SRVNUX0JFVFdFRU5fQUNDT1VOVFMgKiA2LCBiYXNlX2R1cmF0aW9uICsgdmFyaWF0aW9uKSAgIyBDaG8gcGjDqXAgdOG7kWkgxJFhIDMwIHBow7p0CiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBtaW4gPD0gbWF4CiAgICAgICAgICAgIGlmIG1pbl9kdXJhdGlvbiA+PSBtYXhfZHVyYXRpb246CiAgICAgICAgICAgICAgICBtaW5fZHVyYXRpb24gPSBNYWluU2VydmljZUNvbnN0YW50cy5NSU5fUkVTVF9CRVRXRUVOX0FDQ09VTlRTCiAgICAgICAgICAgICAgICBtYXhfZHVyYXRpb24gPSBNYWluU2VydmljZUNvbnN0YW50cy5NQVhfUkVTVF9CRVRXRUVOX0FDQ09VTlRTCiAgICAgICAgICAgIAogICAgICAgICAgICByZXN0X2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQobWluX2R1cmF0aW9uLCBtYXhfZHVyYXRpb24pCiAgICAgICAgICAgIHJldHVybiByZXN0X2R1cmF0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHJlc3QgZHVyYXRpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiByYW5kb20ucmFuZGludCgKICAgICAgICAgICAgICAgIE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1JTl9SRVNUX0JFVFdFRU5fQUNDT1VOVFMsCiAgICAgICAgICAgICAgICBNYWluU2VydmljZUNvbnN0YW50cy5NQVhfUkVTVF9CRVRXRUVOX0FDQ09VTlRTCiAgICAgICAgICAgICkKICAgIAogICAgZGVmIF9nZXRfY2FyZV9hY3Rpb25fY291bnQoc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgc+G7kSBsxrDhu6NuZyBow6BuaCDEkeG7mW5nIGNhcmUgxJHDoyB0aOG7sWMgaGnhu4duIHRyb25nIHNlc3Npb24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBT4buRIGjDoG5oIMSR4buZbmcgY2FyZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmNhcmVfYWN0aW9uX2NvdW50cy5nZXQoYWNjb3VudF9pZCwgMCkKICAgIAogICAgZGVmIF9pbmNyZW1lbnRfY2FyZV9hY3Rpb25fY291bnQoc2VsZiwgYWNjb3VudF9pZDogaW50KToKICAgICAgICAiIiIKICAgICAgICBUxINuZyBz4buRIGzGsOG7o25nIGjDoG5oIMSR4buZbmcgY2FyZSBjaG8gdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5jYXJlX2FjdGlvbl9jb3VudHNbYWNjb3VudF9pZF0gPSBzZWxmLmNhcmVfYWN0aW9uX2NvdW50cy5nZXQoYWNjb3VudF9pZCwgMCkgKyAxCiAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ2FyZSBhY3Rpb24gY291bnQgY2hvIGFjY291bnQge2FjY291bnRfaWR9OiB7c2VsZi5jYXJlX2FjdGlvbl9jb3VudHNbYWNjb3VudF9pZF19IikKICAgIAogICAgZGVmIF9yZXNldF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IHPhu5EgbMaw4bujbmcgaMOgbmggxJHhu5luZyBjYXJlIHbhu4EgMAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIHNlbGYuY2FyZV9hY3Rpb25fY291bnRzW2FjY291bnRfaWRdID0gMAogICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IGNhcmUgYWN0aW9uIGNvdW50IGNobyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAKICAgIGRlZiBfY2hvb3NlX3JhbmRvbV9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBDaOG7jW4gaMOgbmggxJHhu5luZyB0aMO0bmcgcXVhIEpvYkJhc2UgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogTG/huqFpIGjDoG5oIMSR4buZbmcgxJHGsOG7o2MgY2jhu41uCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0sIGTDuW5nIGRlZmF1bHQgYWN0aW9uIikKICAgICAgICAgICAgICAgIHJldHVybiBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fTkVXU0ZFRUQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgSm9iQmFzZSDEkeG7gyBjaOG7jW4gYWN0aW9uIHRoZW8gY29uZmlnCiAgICAgICAgICAgIGNob3Nlbl9hY3Rpb24gPSBoYW5kbGVyLmNob29zZV93ZWlnaHRlZF9hY3Rpb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiSm9iQmFzZSBjaOG7jW4gYWN0aW9uICd7Y2hvc2VuX2FjdGlvbn0nIGNobyB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICByZXR1cm4gY2hvc2VuX2FjdGlvbgogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNo4buNbiBhY3Rpb24gcXVhIEpvYkJhc2U6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fTkVXU0ZFRUQgICMgRmFsbGJhY2sKICAgIAogICAgZGVmIF9nZXRfYWNjb3VudF9zZXNzaW9uKHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjDtG5nIHRpbiBzZXNzaW9uIGPhu6dhIGFjY291bnQgdOG7qyBEQiAocGVyc2lzdGVudCBzZXNzaW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBTZXNzaW9uIGRhdGEgdOG7qyBEQgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBhY2NvdW50IGRhdGEgbeG7m2kgbmjhuqV0IHThu6sgREIKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBhY2NvdW50IHthY2NvdW50X2lkfSB0cm9uZyBEQiIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOtbmggYWN0aW9uX2NvdW50IHbDoCBjYXJlX2NvdW50IHThu6sgY8OhYyBmaWVsZCBEQiBoaeG7h24gY8OzCiAgICAgICAgICAgIGpvYl9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgICAgIGNhcmVfY291bnQgPSBhY2NvdW50LmdldCgiY2FyZV9hY3Rpb25zX2luX3Nlc3Npb24iLCAwKSAgIyBT4bq9IHRow6ptIGZpZWxkIG7DoHkKICAgICAgICAgICAgYWN0aW9uX2NvdW50ID0gam9iX2NvdW50ICsgY2FyZV9jb3VudAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBzdGFydF90aW1lOiBO4bq/dSBzZXNzaW9uIGNoxrBhIGPDsyBzdGFydF90aW1lIHRyb25nIG1lbW9yeSB0aMOsIHThuqFvIG3hu5tpCiAgICAgICAgICAgICMgS0jDlE5HIGTDuW5nIGxhc3Rfam9iX3RpbWUgdsOsIMSRw7MgbMOgIHRo4budaSDEkWnhu4NtIGpvYiBjdeG7kWkgKGPDsyB0aOG7gyBjxakpCiAgICAgICAgICAgIGlmIGFjY291bnRfaWQgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zIGFuZCAnc3RhcnRfdGltZScgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdOgogICAgICAgICAgICAgICAgIyBEw7luZyBzdGFydF90aW1lIHThu6sgbWVtb3J5IHNlc3Npb24gaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICBzdGFydF90aW1lID0gc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdWydzdGFydF90aW1lJ10KICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVOG6oW8gc3RhcnRfdGltZSBt4bubaSBjaG8gc2Vzc2lvbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgc2Vzc2lvbl9kYXRhID0gewogICAgICAgICAgICAgICAgJ3N0YXJ0X3RpbWUnOiBzdGFydF90aW1lLAogICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IGFjdGlvbl9jb3VudCwKICAgICAgICAgICAgICAgICdqb2JfY291bnQnOiBqb2JfY291bnQsCiAgICAgICAgICAgICAgICAnY2FyZV9jb3VudCc6IGNhcmVfY291bnQsCiAgICAgICAgICAgICAgICAnbGFzdF9hY3Rpb25fdGltZSc6IHRpbWUudGltZSgpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2FjaGUgdsOgbyBtZW1vcnkgxJHhu4MgdHLDoW5oIHF1ZXJ5IGxpw6puIHThu6VjCiAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXSA9IHNlc3Npb25fZGF0YQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHNlc3Npb25fZGF0YQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGdldCBhY2NvdW50IHNlc3Npb24gdOG7qyBEQjoge2V9IikKICAgICAgICAgICAgIyBGYWxsYmFjayB24buBIG1lbW9yeSBzZXNzaW9uCiAgICAgICAgICAgIGlmIGFjY291bnRfaWQgbm90IGluIHNlbGYuYWNjb3VudF9zZXNzaW9uczoKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXSA9IHsKICAgICAgICAgICAgICAgICAgICAnc3RhcnRfdGltZSc6IHRpbWUudGltZSgpLAogICAgICAgICAgICAgICAgICAgICdhY3Rpb25fY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdqb2JfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdjYXJlX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnbGFzdF9hY3Rpb25fdGltZSc6IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF0KICAgIAogICAgZGVmIF91cGRhdGVfYWNjb3VudF9zZXNzaW9uKHNlbGYsIGFjY291bnRfaWQ6IGludCwgYWN0aW9uX3R5cGU6IHN0ciwgc3VjY2VzczogYm9vbCk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHNlc3Npb24gZGF0YSBj4bunYSBhY2NvdW50IHbDoG8gREIgKHBlcnNpc3RlbnQgc2Vzc2lvbikKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgYWN0aW9uX3R5cGU6IExv4bqhaSBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIHN1Y2Nlc3M6IFRow6BuaCBjw7RuZyBoYXkga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRhdGEgaGnhu4duIHThuqFpIHThu6sgREIKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBhY2NvdW50IHthY2NvdW50X2lkfSDEkeG7gyB1cGRhdGUgc2Vzc2lvbiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOtbmggdG/DoW4gY8OhYyBjb3VudGVycyBt4bubaQogICAgICAgICAgICBjdXJyZW50X2pvYl9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgICAgIGN1cnJlbnRfY2FyZV9jb3VudCA9IGFjY291bnQuZ2V0KCJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJsYXN0X2FjdGlvbl90aW1lIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgaWYgYWN0aW9uX3R5cGUgPT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQjoKICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsiam9ic19kb25lX2luX3Nlc3Npb24iXSA9IGN1cnJlbnRfam9iX2NvdW50ICsgMQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIENhcmUgYWN0aW9uCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFbImNhcmVfYWN0aW9uc19pbl9zZXNzaW9uIl0gPSBjdXJyZW50X2NhcmVfY291bnQgKyAxCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIERCCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBtZW1vcnkgY2FjaGUKICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb25fZnJvbV9tZW1vcnkoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgYWN0aW9uX3R5cGUgPT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQiBhbmQgc3VjY2VzczoKICAgICAgICAgICAgICAgIHNlc3Npb25bJ2pvYl9jb3VudCddICs9IDEKICAgICAgICAgICAgZWxpZiBhY3Rpb25fdHlwZSAhPSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgc2Vzc2lvblsnY2FyZV9jb3VudCddICs9IDEKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlc3Npb25bJ2FjdGlvbl9jb3VudCddID0gc2Vzc2lvblsnam9iX2NvdW50J10gKyBzZXNzaW9uWydjYXJlX2NvdW50J10KICAgICAgICAgICAgc2Vzc2lvblsnbGFzdF9hY3Rpb25fdGltZSddID0gdGltZS50aW1lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVXBkYXRlIGNvbnNlY3V0aXZlIGZhaWx1cmVzICh24bqrbiBkw7luZyBtZW1vcnkgdsOsIGtow7RuZyBj4bqnbiBwZXJzaXN0KQogICAgICAgICAgICBpZiBub3Qgc3VjY2VzczoKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlc1thY2NvdW50X2lkXSA9IHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlcy5nZXQoYWNjb3VudF9pZCwgMCkgKyAxCiAgICAgICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHNbYWNjb3VudF9pZF0gPSBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlc1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgIGlmIGFjdGlvbl90eXBlID09IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHVwZGF0ZSBhY2NvdW50IHNlc3Npb246IHtlfSIpCiAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfc2Vzc2lvbl9mcm9tX21lbW9yeShzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHNlc3Npb24gdOG7qyBtZW1vcnkgY2FjaGUgKGhlbHBlciBmdW5jdGlvbikKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogU2Vzc2lvbiBkYXRhIHThu6sgbWVtb3J5CiAgICAgICAgIiIiCiAgICAgICAgaWYgYWNjb3VudF9pZCBub3QgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zOgogICAgICAgICAgICBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF0gPSB7CiAgICAgICAgICAgICAgICAnc3RhcnRfdGltZSc6IHRpbWUudGltZSgpLAogICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAnam9iX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICdjYXJlX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgfQogICAgICAgIHJldHVybiBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF0KICAgIAogICAgZGVmIF9yZXNldF9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50LCByZWFzb246IHN0ciA9ICIiKToKICAgICAgICAiIiIKICAgICAgICBSZXNldCBzZXNzaW9uIGRhdGEgY+G7p2EgYWNjb3VudCB0cm9uZyBEQgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICByZWFzb246IEzDvSBkbyByZXNldAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCBzZXNzaW9uIGRhdGEgdHJvbmcgREIKICAgICAgICAgICAgcmVzZXRfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiY2FyZV9hY3Rpb25zX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImxhc3RfYWN0aW9uX3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgcmVzZXRfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgbWVtb3J5IGNhY2hlCiAgICAgICAgICAgIGlmIGFjY291bnRfaWQgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBzZXNzaW9uIGNobyBhY2NvdW50IHthY2NvdW50X2lkfS4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgYWNjb3VudCBzZXNzaW9uOiB7ZX0iKQoKICAgIGRlZiBfcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoc2VsZiwgYWNjb3VudF9pZDogaW50LCByZWFzb246IHN0ciA9ICIiKToKICAgICAgICAiIiIKICAgICAgICBSZXNldCBjaOG7iSBzZXNzaW9uIHN0YXJ0X3RpbWUgxJHhu4MgYuG6r3QgxJHhuqd1IHNlc3Npb24gbeG7m2kgbcOgIGtow7RuZyBt4bqldCBwcm9ncmVzcwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICByZWFzb246IEzDvSBkbyByZXNldCBzdGFydF90aW1lCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJlc2V0IG1lbW9yeSBjYWNoZSBzZXNzaW9uIHN0YXJ0X3RpbWUKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF1bJ3N0YXJ0X3RpbWUnXSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCflIQgUmVzZXQgc2Vzc2lvbiBzdGFydF90aW1lIGNobyBhY2NvdW50IHthY2NvdW50X2lkfS4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFThuqFvIG3hu5tpIHNlc3Npb24gduG7m2kgc3RhcnRfdGltZSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXSA9IHsKICAgICAgICAgICAgICAgICAgICAnc3RhcnRfdGltZSc6IHRpbWUudGltZSgpLAogICAgICAgICAgICAgICAgICAgICdhY3Rpb25fY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdqb2JfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdjYXJlX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnbGFzdF9hY3Rpb25fdGltZSc6IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfhpUgVOG6oW8gbeG7m2kgc2Vzc2lvbiBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH0uIEzDvSBkbzoge3JlYXNvbn0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBhY2NvdW50IHNlc3Npb24gc3RhcnRfdGltZToge2V9IikKCiAgICBkZWYgX3NldF9hY2NvdW50X3Jlc3Qoc2VsZiwgYWNjb3VudF9pZDogaW50LCByZWFzb246IHN0ciA9ICIiKToKICAgICAgICAiIiIKICAgICAgICDEkOG6t3QgYWNjb3VudCB2w6BvIHRy4bqhbmcgdGjDoWkgbmdo4buJIG5nxqFpIHPhu60gZOG7pW5nIHN0YXR1cyA9IGluYWN0aXZlIHbDoCBqb2JfZGlzYWJsZV91bnRpbAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICByZWFzb246IEzDvSBkbyBuZ2jhu4kgbmfGoWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjhu51pIGdpYW4gbmdo4buJIHThu6sgY29uZmlnCiAgICAgICAgICAgIHJlc3RfbWludXRlcyA9IHNlbGYuX2dldF9hY2NvdW50X3Jlc3RfZHVyYXRpb24oKSAvLyA2MCAgIyBDb252ZXJ0IHNlY29uZHMgdG8gbWludXRlcwogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY2h14bqpbiBj4bunYSBEYXRhYmFzZVNlcnZpY2UKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRfaWQsCiAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPXJlc3RfbWludXRlcywKICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkFjY291bnQgcmVzdDoge3JlYXNvbn0iCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gZGF0YSB0cm9uZyBEQgogICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQsIGYiQWNjb3VudCByZXN0OiB7cmVhc29ufSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY29uc2VjdXRpdmUgY291bnRlcnMgKG1lbW9yeSkKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlc1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHNbYWNjb3VudF9pZF0gPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gxJHGsOG7o2MgxJHhurd0IG5naOG7iSBuZ8ahaSB7cmVzdF9taW51dGVzfSBwaMO6dC4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgxJHhurd0IGFjY291bnQge2FjY291bnRfaWR9IG5naOG7iSBuZ8ahaSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc2V0IGFjY291bnQgcmVzdDoge2V9IikKICAgICAgICAKICAgIGRlZiBfc2V0X2FjY291bnRfZm9sbG93X3BlbmFsdHkoc2VsZiwgYWNjb3VudF9pZDogaW50LCByZWFzb246IHN0ciA9ICIiKToKICAgICAgICAiIiIKICAgICAgICDEkOG6t3QgYWNjb3VudCB2w6BvIHRy4bqhbmcgdGjDoWkgbmfhu6tuZyBmb2xsb3cgdsOsIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIG5n4burbmcgZm9sbG93CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IHRo4budaSBnaWFuIHBlbmFsdHkgdOG7qyBjb25maWcgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygidW5mb2xsb3dfcGVuYWx0eV9taW51dGVzIiwgNzIwKSAgIyBN4bq3YyDEkeG7i25oIDEyIGdp4budCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBjaHXhuqluIGPhu6dhIERhdGFiYXNlU2VydmljZQogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj1mIkZvbGxvdyBwZW5hbHR5OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gYuG7iyBuZ+G7q25nIGZvbGxvdyB7cGVuYWx0eV9taW51dGVzfSBwaMO6dC4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4Mgbmfhu6tuZyBmb2xsb3cgYWNjb3VudCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHNldCBmb2xsb3cgcGVuYWx0eToge2V9IikKICAgICAgICAKICAgIGRlZiBfc2V0X2FjY291bnRfZGFpbHlfbGltaXRfcmVhY2hlZChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB1bnRpbCBuZXh0IHJlc2V0IGtoaSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGRhaWx5CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGNodeG6qW4gY+G7p2EgRGF0YWJhc2VTZXJ2aWNlCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRfaWQsCiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJEYWlseSBsaW1pdDoge3JlYXNvbn0iCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9IMSR4bqhdCBnaeG7m2kgaOG6oW4gZGFpbHksIG5naOG7iSDEkeG6v24gbmfDoHkgbWFpLiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBzZXQgZGFpbHkgbGltaXQgY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzZXQgZGFpbHkgbGltaXQ6IHtlfSIpCiAgICAgICAgCiAgICBkZWYgX2FwcGx5X2FwcHJvcHJpYXRlX3Jlc3RfdHlwZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHN3aXRjaF9yZWFzb246IHN0ciwgc2Vzc2lvbjogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIgogICAgICAgIMOBcCBk4bulbmcgbG/huqFpIG5naOG7iSBuZ8ahaSBwaMO5IGjhu6NwIGThu7FhIHRyw6puIGzDvSBkbyBzd2l0Y2ggYWNjb3VudAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGFjY291bnQKICAgICAgICAgICAgc3dpdGNoX3JlYXNvbjogTMO9IGRvIHN3aXRjaAogICAgICAgICAgICBzZXNzaW9uOiBTZXNzaW9uIGRhdGEKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBQaMOibiBsb+G6oWkgbMO9IGRvIHbDoCDDoXAgZOG7pW5nIHJlc3QgdHlwZSBwaMO5IGjhu6NwCiAgICAgICAgICAgIGlmICJkYWlseSIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJuZ8OgeSIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpOgogICAgICAgICAgICAgICAgIyBEYWlseSBsaW1pdCByZWFjaGVkIC0gaW5hY3RpdmUgdW50aWwgbmV4dCByZXNldAogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfZGFpbHlfbGltaXRfcmVhY2hlZChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsaWYgInRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AiIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKSBvciAiY29uc2VjdXRpdmUiIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICMgQ29uc2VjdXRpdmUgZmFpbHVyZXMgLSBjw7MgdGjhu4MgbMOgIGZvbGxvdyBwZW5hbHR5CiAgICAgICAgICAgICAgICBpZiAiZm9sbG93IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCkgb3IgInVuZm9sbG93IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfZm9sbG93X3BlbmFsdHkoYWNjb3VudF9pZCwgc3dpdGNoX3JlYXNvbikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBHZW5lcmljIHNlc3Npb24gcmVzdAogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NldF9hY2NvdW50X3Jlc3QoYWNjb3VudF9pZCwgc3dpdGNoX3JlYXNvbikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiAia2jDtG5nIGPDsyBqb2IiIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKSBvciAibm8gam9iIiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAjIE5vIGpvYnMgYXZhaWxhYmxlIC0gc2hvcnRlciByZXN0CiAgICAgICAgICAgICAgICBjb29sZG93bl9ub19qb2IgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJjb29sZG93bl9nZXRfam9iX2dvbGlrZSIsIDMwKSAgIyAzMCBwaMO6dCBt4bq3YyDEkeG7i25oCiAgICAgICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRfaWQsCiAgICAgICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz1jb29sZG93bl9ub19qb2IsCiAgICAgICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiTm8gam9iIGNvb2xkb3duOiB7c3dpdGNoX3JlYXNvbn0iCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gbmdo4buJIHtjb29sZG93bl9ub19qb2J9IHBow7p0IChraMO0bmcgY8OzIGpvYikiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBTZXNzaW9uIGNvbXBsZXRlZCBub3JtYWxseSAtIHN0YW5kYXJkIHNlc3Npb24gY29vbGRvd24KICAgICAgICAgICAgICAgIHNlbGYuX3NldF9hY2NvdW50X3Jlc3QoYWNjb3VudF9pZCwgc3dpdGNoX3JlYXNvbikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgYXBwbHkgYXBwcm9wcmlhdGUgcmVzdCB0eXBlOiB7ZX0iKQogICAgICAgICAgICAjIEZhbGxiYWNrIHRvIHN0YW5kYXJkIHJlc3QKICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAKICAgIGRlZiBfZW5zdXJlX2FjY291bnRfc3dpdGNoZWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIGFjY291bnQgxJHGsOG7o2Mgc3dpdGNoIHRo4buxYyB04bq/IHRyw6puIG3DoXkgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBBY2NvdW50IGPhuqduIHN3aXRjaAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6Mgc3dpdGNoIHRow6BuaCBjw7RuZyBob+G6t2MgxJHDoyDEkcO6bmcgYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gc3dpdGNoIGtow7RuZyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBjdXJyZW50X2xvZ2dlZF9pbl9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBuZWVkc19hY2NvdW50X3N3aXRjaCA9IGN1cnJlbnRfbG9nZ2VkX2luX2lkICE9IGFjY291bnRfaWQKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5lZWRzX2FjY291bnRfc3dpdGNoOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJD4bqnbiBjaHV54buDbiB0w6BpIGtob+G6o24ge2FwcF9uYW1lfTogaGnhu4duIHThuqFpIElEPXtjdXJyZW50X2xvZ2dlZF9pbl9pZH0sIGPhuqduIGNodXnhu4NuIHNhbmcgSUQ9e2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaMO0bmcgYsOhbyBjaG8gdXNlcgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiLEkGFuZyBjaHV54buDbiBhY2NvdW50OiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBzd2l0Y2ggYWNjb3VudAogICAgICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHN3aXRjaF9yZXN1bHQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0LmdldCgnc3VjY2VzcycsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uID0gc3dpdGNoX3Jlc3VsdC5nZXQoJ3JlYXNvbicsICd1bmtub3duJykKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHN3aXRjaF9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ0zhu5dpIGtow7RuZyB4w6FjIMSR4buLbmgnKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVhc29uID09ICdhY2NvdW50X25vdF9mb3VuZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdHJvbmcgZGFuaCBzw6FjaCwgxJHDoW5oIGThuqV1IGxvZ291dCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBsb2dvdXQgdsOgIHN5bmMgbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX21hcmtfYWNjb3VudF9sb2dvdXQoYWNjb3VudCwgIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gdHJvbmcgZGFuaCBzw6FjaCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHttZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyBzYXUga2hpIHN3aXRjaCB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogUmVzZXQgc2Vzc2lvbiBzdGFydF90aW1lIGNobyBhY2NvdW50IG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2FjY291bnRfc2Vzc2lvbl9zdGFydF90aW1lKGFjY291bnRfaWQsICJBY2NvdW50IHN3aXRjaCIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogQ+G6rXAgbmjhuq10IGlzX2xvZ2luIHN0YXR1cyB0cm9uZyBEQgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9sb2dpbl9zdGF0dXMoYXBwX25hbWUsIGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogUmVsb2FkIGFjY291bnQgZGF0YSB04burIERCIMSR4buDIMSR4bqjbSBi4bqjbyB0aMO0bmcgdGluIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZWxvYWRpbmcgYWNjb3VudCBkYXRhIHNhdSBraGkgc3dpdGNoIGNobyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSDEkMOjIGNodXnhu4NuIHRow6BuaCBjw7RuZyBzYW5nIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiLEkGFuZyBsw6BtIHZp4buHYzoge3VzZXJuYW1lfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFTGsMahbmcgdGjDrWNoIHbhu5tpIGltcGxlbWVudGF0aW9uIGPFqQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogUmVzZXQgc2Vzc2lvbiBzdGFydF90aW1lIGNobyBhY2NvdW50IG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2FjY291bnRfc2Vzc2lvbl9zdGFydF90aW1lKGFjY291bnRfaWQsICJBY2NvdW50IHN3aXRjaCIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogQ+G6rXAgbmjhuq10IGlzX2xvZ2luIHN0YXR1cyB0cm9uZyBEQgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9sb2dpbl9zdGF0dXMoYXBwX25hbWUsIGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogUmVsb2FkIGFjY291bnQgZGF0YSB04burIERCIMSR4buDIMSR4bqjbSBi4bqjbyB0aMO0bmcgdGluIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZWxvYWRpbmcgYWNjb3VudCBkYXRhIHNhdSBraGkgc3dpdGNoIGNobyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSDEkMOjIGNodXnhu4NuIHRow6BuaCBjw7RuZyBzYW5nIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiLEkGFuZyBsw6BtIHZp4buHYzoge3VzZXJuYW1lfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkcSDbmcgbmjhuq1wLCBi4buPIHF1YSBjaHV54buDbiB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZW5zdXJlIGFjY291bnQgc3dpdGNoZWQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyLCBsb2dnZWRfaW5fYWNjb3VudF9pZDogaW50KToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgbG9naW4gc3RhdHVzIHRyb25nIERCIHNhdSBraGkgc3dpdGNoIGFjY291bnQgdGjDoG5oIGPDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGxvZ2dlZF9pbl9hY2NvdW50X2lkOiBJRCBj4bunYSBhY2NvdW50IMSRw6MgbG9naW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVzZXQgdOG6pXQgY+G6oyBhY2NvdW50cyBj4bunYSBhcHAgduG7gSBpc19sb2dpbiA9IEZhbHNlCiAgICAgICAgICAgIGFwcF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYXBwX2FjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpIGFuZCBhY2NvdW50WyJpZCJdICE9IGxvZ2dlZF9pbl9hY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgaXNfbG9naW49RmFsc2UgY2hvIGFjY291bnQgSUQge2FjY291bnRbJ2lkJ119IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGFjY291bnQgaGnhu4duIHThuqFpIHbhu4EgaXNfbG9naW4gPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IFRydWUsCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlNldCBpc19sb2dpbj1UcnVlIGNobyBhY2NvdW50IElEIHtsb2dnZWRfaW5fYWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHVwZGF0ZSBhY2NvdW50IGxvZ2luIHN0YXR1czoge2V9IikKCiAgICBkZWYgX21hcmtfYWNjb3VudF9sb2dvdXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHJlYXNvbjogc3RyKToKICAgICAgICAiIiIKICAgICAgICDEkMOhbmggZOG6pXUgYWNjb3VudCBsb2dvdXQgdsOgIHN5bmMgbOG6oWkgdHLhuqFuZyB0aMOhaQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IEFjY291bnQgYuG7iyBsb2dvdXQKICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gbG9nb3V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVXBkYXRlIERCCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgImlzX2xvZ2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHRyYWNraW5nCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHZlcmlmaWVkIHN0YXRlCiAgICAgICAgICAgIHNlbGYuYWNjb3VudF92ZXJpZmllZF9zdGF0ZXNbYWNjb3VudF9pZF0gPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhbnVwIHNlc3Npb24KICAgICAgICAgICAgc2VsZi5fY2xlYW51cF9hY2NvdW50X3Nlc3Npb25fb25fbG9nb3V0KGFjY291bnRfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IGxvZ291dCBjaG8gYWNjb3VudCB7dXNlcm5hbWV9OiB7cmVhc29ufSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgbWFyayBhY2NvdW50IGxvZ291dDoge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Jlc3RfZHVyYXRpb24oc2VsZikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSBj4bunYSBhY2NvdW50IHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUaOG7nWkgZ2lhbiBuZ2jhu4kgbmfGoWkgdMOtbmggYuG6sW5nIGdpw6J5ICht4bq3YyDEkeG7i25oIHThu6sgam9iX2Nvb2xkb3duX21pbnV0ZXMpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGpvYl9jb29sZG93bl9taW51dGVzIG5oxrAgSm9iU2VydmljZQogICAgICAgICAgICByZXN0X21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJqb2JfY29vbGRvd25fbWludXRlcyIsIDMwKQogICAgICAgICAgICByZXR1cm4gaW50KHJlc3RfbWludXRlcykgKiA2MCAgIyBDb252ZXJ0IG1pbnV0ZXMgdG8gc2Vjb25kcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgbOG6pXkgYWNjb3VudCByZXN0IGR1cmF0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gMzAgKiA2MCAgIyBEZWZhdWx0IDMwIG1pbnV0ZXMKCiAgICBkZWYgX2NsZWFudXBfYWNjb3VudF9zZXNzaW9uX29uX2xvZ291dChzZWxmLCBhY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIENsZWFudXAgc2Vzc2lvbiBkYXRhIGtoaSBsb2dvdXQgYWNjb3VudAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCBzZXNzaW9uIHRyb25nIERCCiAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkLCAiQWNjb3VudCBsb2dvdXQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhciB3b3JraW5nIHN0YXR1cwogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50IGFuZCBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiaWQiKSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcKICAgICAgICAgICAgYXBwX25hbWUgPSBOb25lCiAgICAgICAgICAgIGZvciBhcHAsIGFjY19pZCBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBhY2NfaWQgPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICBhcHBfbmFtZSA9IGFwcAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBhcHBfbmFtZToKICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhciB2ZXJpZmllZCBzdGF0ZQogICAgICAgICAgICBzZWxmLmFjY291bnRfdmVyaWZpZWRfc3RhdGVzW2FjY291bnRfaWRdID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2xlYW5lZCB1cCBzZXNzaW9uIGRhdGEgZm9yIGxvZ291dCBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2xlYW51cCBhY2NvdW50IHNlc3Npb246IHtlfSIpCgogICAgZGVmIF9zaG91bGRfcmVzZXRfc2Vzc2lvbl9vbl9uZXdfZGF5KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIGPDsyBuw6puIHJlc2V0IHNlc3Npb24ga2hpIHF1YSBuZ8OgeSBt4bubaQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIHJlc2V0IHNlc3Npb24KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBzZXNzaW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbGFzdF9hY3Rpb25fdGltZSA9IHNlc3Npb24uZ2V0KCJsYXN0X2FjdGlvbl90aW1lIiwgMCkKICAgICAgICAgICAgaWYgbGFzdF9hY3Rpb25fdGltZSA9PSAwOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IHF1YSBuZ8OgeSBt4bubaQogICAgICAgICAgICBsYXN0X2RhdGUgPSBkYXRldGltZS5mcm9tdGltZXN0YW1wKGxhc3RfYWN0aW9uX3RpbWUpLmRhdGUoKQogICAgICAgICAgICBjdXJyZW50X2RhdGUgPSBkYXRldGltZS5ub3coKS5kYXRlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBjdXJyZW50X2RhdGUgPiBsYXN0X2RhdGUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIHJlc2V0IHNlc3Npb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfc2hvdWxkX3N3aXRjaF9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgbsOqbiBjaHV54buDbiBhY2NvdW50IGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuw6puIGNodXnhu4NuIGFjY291bnQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiBhY2NvdW50CiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgc2Vzc2lvbiBsaW1pdHMgdOG7qyBjb25maWcgZGF0YWJhc2UKICAgICAgICAgICAgc2Vzc2lvbl9saW1pdHMgPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uX2xpbWl0cyhhY2NvdW50KQogICAgICAgICAgICBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiJdCiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0gCiAgICAgICAgICAgIG1heF9zZXNzaW9uX2R1cmF0aW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9zZXNzaW9uX2R1cmF0aW9uIl0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQpCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDEuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIHRo4budaSBnaWFuIHNlc3Npb24KICAgICAgICAgICAgc2Vzc2lvbl9kdXJhdGlvbiA9IGN1cnJlbnRfdGltZSAtIHNlc3Npb25bJ3N0YXJ0X3RpbWUnXQogICAgICAgICAgICBpZiBzZXNzaW9uX2R1cmF0aW9uID49IG1heF9zZXNzaW9uX2R1cmF0aW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyBsw6BtIHZp4buHYyB7c2Vzc2lvbl9kdXJhdGlvbi82MDouMWZ9IHBow7p0LCBj4bqnbiBuZ2jhu4kgKGxpbWl0OiB7bWF4X3Nlc3Npb25fZHVyYXRpb24vNjA6LjFmfSBwaMO6dCkiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gS2nhu4NtIHRyYSBz4buRIGzGsOG7o25nIGjDoG5oIMSR4buZbmcKICAgICAgICAgICAgaWYgc2Vzc2lvblsnYWN0aW9uX2NvdW50J10gPj0gbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9OiDEkMOjIHRo4buxYyBoaeG7h24ge3Nlc3Npb25bJ2FjdGlvbl9jb3VudCddfSBow6BuaCDEkeG7mW5nLCBj4bqnbiBuZ2jhu4kgKGxpbWl0OiB7bWF4X2FjdGlvbnNfcGVyX3Nlc3Npb259KSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBLaeG7g20gdHJhIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgIGlmIHNlc3Npb25bJ2pvYl9jb3VudCddID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyBsw6BtIHtzZXNzaW9uWydqb2JfY291bnQnXX0gam9icywgY+G6p24gbmdo4buJIChsaW1pdDoge21heF9qb2JzX3Blcl9zZXNzaW9ufSkiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNC4gS2nhu4NtIHRyYSB0aOG6pXQgYuG6oWkgbGnDqm4gdGnhur9wCiAgICAgICAgICAgIGNvbnNlY3V0aXZlX2ZhaWx1cmVzID0gc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzLmdldChhY2NvdW50X2lkLCAwKQogICAgICAgICAgICBpZiBjb25zZWN1dGl2ZV9mYWlsdXJlcyA+PSBNYWluU2VydmljZUNvbnN0YW50cy5TV0lUQ0hfQUNDT1VOVF9BRlRFUl9DT05TRUNVVElWRV9GQUlMUzoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IHtjb25zZWN1dGl2ZV9mYWlsdXJlc30gbOG6p24gdGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cCwgY2h1eeG7g24gYWNjb3VudCIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA1LiBLaeG7g20gdHJhIGtow7RuZyBjw7Mgam9iIGxpw6puIHRp4bq/cAogICAgICAgICAgICBub19qb2JfYXR0ZW1wdHMgPSBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzLmdldChhY2NvdW50X2lkLCAwKQogICAgICAgICAgICBpZiBub19qb2JfYXR0ZW1wdHMgPj0gTWFpblNlcnZpY2VDb25zdGFudHMuU1dJVENIX0FDQ09VTlRfQUZURVJfTk9fSk9CUzoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IHtub19qb2JfYXR0ZW1wdHN9IGzhuqduIGtow7RuZyBjw7Mgam9iLCBjaHV54buDbiBhY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDYuIEtp4buDbSB0cmEgZGFpbHkgbGltaXQKICAgICAgICAgICAgZGFpbHlfbGltaXQgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAxMDApICAjIFPhu60gZOG7pW5nIGpvYl9tYXhfZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9saW1pdAogICAgICAgICAgICBkYWlseV9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKSAgIyBT4butIGThu6VuZyBqb2JfdG9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2NvdW50CiAgICAgICAgICAgIGlmIGRhaWx5X2NvdW50ID49IGRhaWx5X2xpbWl0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyDEkeG6oXQgZGFpbHkgbGltaXQgKHtkYWlseV9jb3VudH0ve2RhaWx5X2xpbWl0fSksIGNodXnhu4NuIGFjY291bnQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNoZWNrIHNob3VsZCBzd2l0Y2ggYWNjb3VudDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9yZXN0aW5nKHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBhY2NvdW50IGPDsyDEkWFuZyBuZ2jhu4kgbmfGoWkga2jDtG5nIChz4butIGThu6VuZyBEQiBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJFhbmcgbmdo4buJIG5nxqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzdGF0dXMgPSBpbmFjdGl2ZSB2w6Agam9iX2Rpc2FibGVfdW50aWwKICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoInN0YXR1cyIpID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA+IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IChqb2JfZGlzYWJsZV91bnRpbCAtIGN1cnJlbnRfdGltZSkgLyA2MAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge2FjY291bnRfaWR9IGPDsm4gbmdo4buJIHtyZW1haW5pbmdfbWludXRlczouMWZ9IHBow7p0IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEjhur90IHRo4budaSBnaWFuIG5naOG7iSwgdOG7sSDEkeG7mW5nIGNodXnhu4NuIHbhu4EgYWN0aXZlIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSDEkcOjIGjhur90IHRo4budaSBnaWFuIG5naOG7iSwgY2h1eeG7g24gduG7gSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGFjY291bnQgcmVzdDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfZ2V0X25leHRfYXZhaWxhYmxlX2FjY291bnQoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGFjY291bnQgdGnhur9wIHRoZW8gY8OzIHRo4buDIGzDoG0gdmnhu4djIChraMO0bmcgbmdo4buJIG5nxqFpKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIE9wdGlvbmFsW0RpY3RdOiBBY2NvdW50IGPDsyB0aOG7gyBsw6BtIHZp4buHYyBob+G6t2MgTm9uZQogICAgICAgICIiIgogICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgCiAgICAgICAgIyBM4buNYyBi4buPIGPDoWMgYWNjb3VudCDEkWFuZyBuZ2jhu4kgbmfGoWkKICAgICAgICBhdmFpbGFibGVfYWNjb3VudHMgPSBbXQogICAgICAgIGZvciBhY2NvdW50IGluIHdvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhhY2NvdW50X2lkKToKICAgICAgICAgICAgICAgIGF2YWlsYWJsZV9hY2NvdW50cy5hcHBlbmQoYWNjb3VudCkKICAgICAgICAKICAgICAgICBpZiBub3QgYXZhaWxhYmxlX2FjY291bnRzOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIAogICAgICAgICMgxq91IHRpw6puIGFjY291bnQgY2jGsGEgbMOgbSB2aeG7h2MgZ+G6p24gxJHDonkKICAgICAgICBkZWYgc29ydF9rZXkoYWNjKToKICAgICAgICAgICAgYWNjX2lkID0gYWNjLmdldCgiaWQiKQogICAgICAgICAgICBsYXN0X3dvcmtfdGltZSA9IHNlbGYuYWNjb3VudF9sYXN0X3dvcmtfdGltZS5nZXQoYWNjX2lkLCAwKQogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgICAgYWNjLmdldCgiaXNfbG9naW4iLCBGYWxzZSksICAjIMavdSB0acOqbiDEkcOjIGxvZ2luCiAgICAgICAgICAgICAgICAtbGFzdF93b3JrX3RpbWUsICAjIMavdSB0acOqbiBsw6J1IGtow7RuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgLWFjYy5nZXQoImpvYl90b2RheSIsIDApICAjIMavdSB0acOqbiDDrXQgam9iIGjGoW4gKGTDuW5nIGpvYl90b2RheSB0aGF5IHbDrCBkYWlseV9qb2JfY291bnQpCiAgICAgICAgICAgICkKICAgICAgICAKICAgICAgICBhdmFpbGFibGVfYWNjb3VudHMuc29ydChrZXk9c29ydF9rZXksIHJldmVyc2U9VHJ1ZSkKICAgICAgICByZXR1cm4gYXZhaWxhYmxlX2FjY291bnRzWzBdCiAgICAKICAgIGRlZiBfcmVjb3JkX2FjdGlvbl9oaXN0b3J5KHNlbGYsIGFjY291bnRfaWQ6IGludCwgYWN0aW9uOiBzdHIsIHN1Y2Nlc3M6IGJvb2wpOgogICAgICAgICIiIgogICAgICAgIEdoaSBs4bqhaSBs4buLY2ggc+G7rSBow6BuaCDEkeG7mW5nIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY3Rpb246IExv4bqhaSBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIHN1Y2Nlc3M6IEPDsyB0aMOgbmggY8O0bmcga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgaWYgYWNjb3VudF9pZCBub3QgaW4gc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5OgogICAgICAgICAgICBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnlbYWNjb3VudF9pZF0gPSBbXQogICAgICAgIAogICAgICAgIGhpc3RvcnlfZW50cnkgPSB7CiAgICAgICAgICAgICdhY3Rpb24nOiBhY3Rpb24sCiAgICAgICAgICAgICdzdWNjZXNzJzogc3VjY2VzcywKICAgICAgICAgICAgJ3RpbWVzdGFtcCc6IGRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpCiAgICAgICAgfQogICAgICAgIAogICAgICAgIHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXS5hcHBlbmQoaGlzdG9yeV9lbnRyeSkKICAgICAgICAKICAgICAgICAjIEdp4buvIHThu5FpIMSRYSA1MCBlbnRyaWVzIGNobyBt4buXaSBhY2NvdW50CiAgICAgICAgaWYgbGVuKHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXSkgPiA1MDoKICAgICAgICAgICAgc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdID0gc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdWy01MDpdCiAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFNsZWVwIGFuIHRvw6BuIHbhu5tpIGto4bqjIG7Eg25nIGLhu4sgZ2nDoW4gxJFv4bqhbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNlY29uZHM6IFPhu5EgZ2nDonkgY+G6p24gc2xlZXAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBzbGVlcCBob8OgbiB0aMOgbmgsIEZhbHNlIG7hur91IGLhu4sgZm9yY2Ugc3RvcAogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIAogICAgICAgIHdoaWxlIHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSA8IHNlY29uZHM6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnJ1bm5pbmcgb3Igc2VsZi5mb3JjZV9zdG9wOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHRpbWUuc2xlZXAoTWFpblNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9DSEVDS19JTlRFUlZBTCkKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgX3ZhbGlkYXRlX2FuZF91cGRhdGVfZW5hYmxlZF9hcHBzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIGPhuq1wIG5o4bqtdCBkYW5oIHPDoWNoIGVuYWJsZWRfYXBwcyBi4bqxbmcgY8OhY2ggbG/huqFpIGLhu48gY8OhYyBhcHAgY2jGsGEgY8OgaSDEkeG6t3QKICAgICAgICBT4butIGThu6VuZyBtYXBwaW5nIHTEqW5oIHRoYXkgdsOsIHThuqFvIGpvYiBoYW5kbGVycyB04bqhbSB0aOG7nWkgxJHhu4MgdHLDoW5oIGNvbmZsaWN0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiS2nhu4NtIHRyYSB2w6AgY+G6rXAgbmjhuq10IGRhbmggc8OhY2ggZW5hYmxlZF9hcHBzLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTWFwcGluZyB0xKluaCBhcHBfbmFtZSAtPiBhcHBfcGFja2FnZSAobOG6pXkgdOG7qyBjw6FjIGpvYiBoYW5kbGVycykKICAgICAgICAgICAgYXBwX3BhY2thZ2VzID0gewogICAgICAgICAgICAgICAgInRpa3RvayI6ICJjb20uc3MuYW5kcm9pZC51Z2MudHJpbGwiLAogICAgICAgICAgICAgICAgInRpa3RvazIiOiAiY29tLnpoaWxpYW9hcHAubXVzaWNhbGx5IiwgCiAgICAgICAgICAgICAgICAiaW5zdGFncmFtIjogImNvbS5pbnN0YWdyYW0uYW5kcm9pZCIsCiAgICAgICAgICAgICAgICAieW91dHViZSI6ICJjb20uZ29vZ2xlLmFuZHJvaWQueW91dHViZSIKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgY3VycmVudF9lbmFibGVkX2FwcHMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICB2YWxpZGF0ZWRfYXBwcyA9IFtdCiAgICAgICAgICAgIHJlbW92ZWRfYXBwcyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gY3VycmVudF9lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYXBwX3BhY2thZ2UgPSBhcHBfcGFja2FnZXMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgYXBwIGPDsyDEkcaw4bujYyBjw6BpIMSR4bq3dCBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuaXNfYXBwX2luc3RhbGxlZChhcHBfcGFja2FnZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZWRfYXBwcy5hcHBlbmQoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLinJMge2FwcF9uYW1lfSAoe2FwcF9wYWNrYWdlfSkgxJHDoyBjw6BpIMSR4bq3dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinJcge2FwcF9uYW1lfSAoe2FwcF9wYWNrYWdlfSkgY2jGsGEgY8OgaSDEkeG6t3QsIHPhur0gYuG7iyBsb+G6oWkgYuG7jyIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgcGFja2FnZSBtYXBwaW5nIGNobyBhcHA6IHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGFwcCB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIHJlbW92ZWRfYXBwcy5hcHBlbmQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgbuG6v3UgY8OzIHRoYXkgxJHhu5VpCiAgICAgICAgICAgIGlmIHJlbW92ZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTG/huqFpIGLhu48ge2xlbihyZW1vdmVkX2FwcHMpfSBhcHAgY2jGsGEgY8OgaSDEkeG6t3Q6IHsnLCAnLmpvaW4ocmVtb3ZlZF9hcHBzKX0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJHaeG7ryBs4bqhaSB7bGVuKHZhbGlkYXRlZF9hcHBzKX0gYXBwIMSRw6MgY8OgaSDEkeG6t3Q6IHsnLCAnLmpvaW4odmFsaWRhdGVkX2FwcHMpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgICAgIGN1cnJlbnRfZ2xvYmFsX2NvbmZpZyA9IHNlbGYuZGIuZ2V0X2dsb2JhbF9jb25maWcoKQogICAgICAgICAgICAgICAgY3VycmVudF9nbG9iYWxfY29uZmlnWyJlbmFibGVkX2FwcHMiXSA9IHZhbGlkYXRlZF9hcHBzCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9nbG9iYWxfY29uZmlnKGN1cnJlbnRfZ2xvYmFsX2NvbmZpZykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgY2FjaGUKICAgICAgICAgICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gdmFsaWRhdGVkX2FwcHMKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVOG6pXQgY+G6oyB7bGVuKHZhbGlkYXRlZF9hcHBzKX0gYXBwIHRyb25nIGVuYWJsZWRfYXBwcyDEkeG7gXUgxJHDoyDEkcaw4bujYyBjw6BpIMSR4bq3dCIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHZhbGlkYXRlIGVuYWJsZWRfYXBwczoge2V9IikKCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBNYWluU2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIHThuqFvIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBNYWluU2VydmljZS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgVFLGr+G7mkMga2hpIGto4bufaSB04bqhbyBqb2IgaGFuZGxlcnMKICAgICAgICAgICAgc2VsZi5fdmFsaWRhdGVfYW5kX3VwZGF0ZV9lbmFibGVkX2FwcHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzCiAgICAgICAgICAgIHNlbGYuX2luaXRfam9iX2hhbmRsZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyBjw6FjIGFwcAogICAgICAgICAgICBzZWxmLl9pbml0X2FwcF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSBjw6FjIGNvbmZpZyBt4bq3YyDEkeG7i25oCiAgICAgICAgICAgIHNlbGYuX3NhdmVfZGVmYXVsdF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgZGFpbHkgY291bnRlcnMgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBGZXRjaCBHb0xpa2UgaGVhZGVycyB0csaw4bubYyBraGkgc3luYyBhY2NvdW50cyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5fZW5zdXJlX2dvbGlrZV9oZWFkZXJzKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzLCBzeW5jIGFjY291bnRzIHPhur0gYuG7iyBnaeG7m2kgaOG6oW4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG7k25nIGLhu5kgYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4sgdsOgIG1hcHBpbmcgR29MaWtlIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIHNlbGYuX3N5bmNfYWxsX2FjY291bnRzX2FuZF9tYXBwaW5nKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jDtG5nIHN5bmMgdHLhuqFuZyB0aMOhaSBsb2dpbiBuZ2F5IGzhuq1wIHThu6ljIG5oxrAgSm9iU2VydmljZQogICAgICAgICAgICAjIFPhur0gbGF6eSBzeW5jIGtoaSBj4bqnbiB0aGnhur90IHRyb25nIF9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gTWFpblNlcnZpY2U6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2Vuc3VyZV9nb2xpa2VfaGVhZGVycyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw7MgR29MaWtlIGhlYWRlcnMgaOG7o3AgbOG7hyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgIENo4buJIHThu7EgxJHhu5luZyBs4bqleSBoZWFkZXJzIG7hur91IGPDsyBjb25maWcgaXNfYXV0b19nZXRfZ29saWtlX2hlYWRlciA9IHRydWUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyBoZWFkZXJzIGjhu6NwIGzhu4cKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkOG6o20gYuG6o28gR29MaWtlIGhlYWRlcnMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGNvbmZpZyBjw7MgY2hvIHBow6lwIHThu7EgxJHhu5luZyBs4bqleSBoZWFkZXJzIGtow7RuZwogICAgICAgICAgICBpc19hdXRvX2dldF9oZWFkZXIgPSBzZWxmLmRiLmdldF9kZXZpY2VfY29uZmlnKCJpc19hdXRvX2dldF9nb2xpa2VfaGVhZGVyIiwgRmFsc2UpCiAgICAgICAgICAgIGlmIG5vdCBpc19hdXRvX2dldF9oZWFkZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ29uZmlnIGlzX2F1dG9fZ2V0X2dvbGlrZV9oZWFkZXIgPSBmYWxzZSwgYuG7jyBxdWEgdmnhu4djIHThu7EgxJHhu5luZyBs4bqleSBoZWFkZXJzIikKICAgICAgICAgICAgICAgICMgQ2jhu4kga2nhu4NtIHRyYSB4ZW0gY8OzIGhlYWRlcnMgdOG7qyBzZXJ2ZXIga2jDtG5nCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5nb2xpa2Vfc2VydmljZS5pc19nb2xpa2VfYXV0aGVudGljYXRlZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBsw6BtIG3hu5tpIEdvTGlrZSBoZWFkZXJzIGtow7RuZwogICAgICAgICAgICBuZWVkc19oZWFkZXJzX3JlZnJlc2ggPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLm5lZWRzX2hlYWRlcnNfcmVmcmVzaCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgbuG6v3UgY+G6p24gZmV0Y2ggaGVhZGVycyBt4bubaQogICAgICAgICAgICBpZiBuZWVkc19oZWFkZXJzX3JlZnJlc2g6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIkZldGNoIEdvTGlrZSBoZWFkZXJzIik6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIGZldGNoIEdvTGlrZSBoZWFkZXJzIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBpbnRlcm5ldAogICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuY2hlY2tfaW50ZXJuZXQoKToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIGvhur90IG7hu5FpIGludGVybmV0IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBGZXRjaCBHb0xpa2UgaGVhZGVycwogICAgICAgICAgICBnb2xpa2VfaGVhZGVycyA9IHNlbGYuZ29saWtlX3NlcnZpY2UuZmV0Y2hfZ29saWtlX2hlYWRlcnNfd2l0aF9yZXRyeSgpCiAgICAgICAgICAgIGlmIG5vdCBnb2xpa2VfaGVhZGVyczoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgbOG6pXkgR29MaWtlIGhlYWRlcnMgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBlbnN1cmUgR29MaWtlIGhlYWRlcnM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3N5bmNfYWxsX2FjY291bnRzX2FuZF9tYXBwaW5nKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyB2w6AgbWFwcGluZyBHb0xpa2UgY2hvIHThuqV0IGPhuqMgYXBwcyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSDEkeG7k25nIGLhu5kgYWNjb3VudHMgdsOgIG1hcHBpbmcgR29MaWtlLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIDEuIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gdGjDrCBi4buPIHF1YSBtYXBwaW5nCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJHGsOG7o2MgxJHhu5NuZyBi4buZIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSBtYXBwaW5nIEdvTGlrZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZSAoY2jhu4kga2hpIGPDsyBHb0xpa2UgaGVhZGVycykKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZS5uZWVkc19oZWFkZXJzX3JlZnJlc2goKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBnb2xpa2VfYWNjb3VudHMgPSBoYW5kbGVyLmdldF9nb2xpa2VfYWNjb3VudHMoKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IHtsZW4oZ29saWtlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgREIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIEdvTGlrZSBoZWFkZXJzIGjhu6NwIGzhu4csIGLhu48gcXVhIG1hcHBpbmcgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSDEkeG7k25nIGLhu5kge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkhvw6BuIHRow6BuaCDEkeG7k25nIGLhu5kgYWNjb3VudHMgdsOgIG1hcHBpbmcgR29MaWtlIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSDEkeG7k25nIGLhu5kgYWNjb3VudHMgdsOgIG1hcHBpbmc6IHtlfSIpCgogICAgZGVmIF9pbml0X2pvYl9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlciBjaG8gdOG7q25nIGFwcCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBzZWxmLmVuYWJsZWRfYXBwcyDEkcOjIMSRxrDhu6NjIHZhbGlkYXRlIHRoYXkgdsOsIGzhuqV5IHThu6sgZGF0YWJhc2UKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5lbmFibGVkX2FwcHMKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzIGNobyBjw6FjIGFwcHMgxJHDoyB2YWxpZGF0ZTogeycsICcuam9pbihlbmFibGVkX2FwcHMpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJ0aWt0b2syIjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2sySm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IEluc3RhZ3JhbUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAieW91dHViZSI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gWW91dHViZUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkFwcCB7YXBwX25hbWV9IGNoxrBhIMSRxrDhu6NjIGjhu5cgdHLhu6MiKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkto4bufaSB04bqhbyBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGto4bufaSB04bqhbyBqb2IgaGFuZGxlcnM6IHtlfSIpCiAgICAKICAgIGRlZiBfaW5pdF9hcHBfY29uZmlncyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBjb25maWcgbeG6t2MgxJHhu4tuaCBjaG8gdOG6pXQgY+G6oyBhcHBzCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgdOG6oW8gY29uZmlnIG3hurdjIMSR4buLbmggY2hvIGFwcHMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaOG7n2kgdOG6oW8gY29uZmlnIGNobyB04burbmcgam9iIGhhbmRsZXIKICAgICAgICAgICAgZm9yIGFwcF9uYW1lLCBoYW5kbGVyIGluIHNlbGYuam9iX2hhbmRsZXJzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IGhhbmRsZXIuaW5pdF9kZWZhdWx0X2FwcF9jb25maWcoKQogICAgICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBraOG7n2kgdOG6oW8gY29uZmlnIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBraOG7n2kgdOG6oW8gY29uZmlnIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gY29uZmlnIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGto4bufaSB04bqhbyBhcHAgY29uZmlnczoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGNvbmZpZyBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVOG6oW8gZ2xvYmFsIGNvbmZpZyB0xrDGoW5nIHThu7EgSm9iU2VydmljZQogICAgICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGFjdGlvbiB3ZWlnaHRzIG3hurdjIMSR4buLbmgKICAgICAgICAgICAgICAgICJtYWluX3NlcnZpY2VfYWN0aW9uX3dlaWdodHMiOiBNYWluU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0FDVElPTl9XRUlHSFRTLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGR5bmFtaWMgYWN0aW9ucyBjYWxjdWxhdGlvbgogICAgICAgICAgICAgICAgIm1pbl9hY3Rpb25zX3Blcl9zZXNzaW9uIjogTWFpblNlcnZpY2VDb25zdGFudHMuTUlOX0FDVElPTlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgICAgICAibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iOiBNYWluU2VydmljZUNvbnN0YW50cy5NQVhfQUNUSU9OU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBzZXNzaW9uIGR1cmF0aW9uCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyI6IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkRFRkFVTFRfTUFYX1NFU1NJT05fRFVSQVRJT04gLy8gNjAsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggY29vbGRvd24gdsOgIHJlc3QKICAgICAgICAgICAgICAgICJqb2JfY29vbGRvd25fbWludXRlcyI6IGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMsCiAgICAgICAgICAgICAgICAidW5mb2xsb3dfcGVuYWx0eV9taW51dGVzIjogNzIwLCAgIyBN4bq3YyDEkeG7i25oIDEyIGdp4budCiAgICAgICAgICAgICAgICAiY29vbGRvd25fZ2V0X2pvYl9nb2xpa2UiOiAzMCwgICMgMzAgcGjDunQgbeG6t2MgxJHhu4tuaCBraGkga2jDtG5nIGPDsyBqb2IKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBhcHBzIMSRxrDhu6NjIGvDrWNoIGhv4bqhdAogICAgICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IGNvbmZpZy5FTkFCTEVEX0FQUFMsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggcmVzZXQgZGFpbHkKICAgICAgICAgICAgICAgICJsYXN0X2RhaWx5X3Jlc2V0X2RhdGUiOiAiIiwKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHThu6tuZyBjb25maWcgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRlZmF1bHRfY29uZmlncy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZyhrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOjIGzGsHUgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCBNYWluU2VydmljZToge2tleX09e3ZhbHVlfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPhuqV1IGjDrG5oIE1haW5TZXJ2aWNlIHtrZXl9IMSRw6MgdOG7k24gdOG6oWk6IHtzZWxmLmdldF9nbG9iYWxfY29uZmlnKGtleSl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygixJDDoyBsxrB1IGRlZmF1bHQgY29uZmlncyBjaG8gTWFpblNlcnZpY2UgZHluYW1pYyBzZXNzaW9uIG1hbmFnZW1lbnQiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGzGsHUgZGVmYXVsdCBjb25maWdzOiB7ZX0iKQogICAgCiAgICBkZWYgZ2V0X2dsb2JhbF9jb25maWcoc2VsZiwga2V5OiBzdHIsIGRlZmF1bHRfdmFsdWU9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY29uZmlnIHThu6sgZGF0YWJhc2UgduG7m2kgZmFsbGJhY2sgduG7gSBkZWZhdWx0IHZhbHVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAga2V5OiBUw6puIGNvbmZpZyBj4bqnbiBs4bqleQogICAgICAgICAgICBkZWZhdWx0X3ZhbHVlOiBHacOhIHRy4buLIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIEdpw6EgdHLhu4sgY29uZmlnIGhv4bq3YyBkZWZhdWx0X3ZhbHVlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuZGIuZ2V0KGtleSwgZGVmYXVsdF92YWx1ZSkKICAgIAogICAgZGVmIF9yZXNldF9kYWlseV9jb3VudGVycyhzZWxmKToKICAgICAgICAiIiJSZXNldCBjw6FjIGNvdW50ZXIgaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfZGF0ZSA9IGRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlWS0lbS0lZCIpCiAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImxhc3RfZGFpbHlfcmVzZXRfZGF0ZSIsICIiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgY3VycmVudF9kYXRlICE9IGxhc3RfcmVzZXRfZGF0ZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgZGFpbHkgY291bnRlcnMgY2hvIG5nw6B5IHtjdXJyZW50X2RhdGV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBqb2IgY291bnRlcnMgLSBs4bqleSB04bqldCBj4bqjIGFjY291bnRzIChraMO0bmcgZmlsdGVyKQogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhkZXZpY2VfaWQ9RmFsc2UpICAjIGRldmljZV9pZD1GYWxzZSDEkeG7gyBraMO0bmcgZmlsdGVyIHRoZW8gZGV2aWNlCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaWQiKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX3RvZGF5IjogMCwgICMgU+G7rSBk4bulbmcgam9iX3RvZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9jb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd190b2RheSI6IDAgICMgU+G7rSBk4bulbmcgZm9sbG93X3RvZGF5IHRoYXkgdsOsIGRhaWx5X2ZvbGxvd19jb3VudAogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzGsHUgbmfDoHkgcmVzZXQKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsYXN0X2RhaWx5X3Jlc2V0X2RhdGUiLCBjdXJyZW50X2RhdGUpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyByZXNldCB04bqldCBj4bqjIGRhaWx5IGNvdW50ZXJzIikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgZGFpbHkgY291bnRlcnM6IHtlfSIpCiAgICAKICAgIGRlZiBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgaG/hurdjIGNoxINtIHPDs2MKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3RdOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgYXBwX3dvcmthYmxlX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgYXBwX3dvcmthYmxlX2NvdW50ICs9IDEKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gxJHGsOG7o2Mge2xlbih3b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdOG7qyB7bGVuKGVuYWJsZWRfYXBwcyl9IGFwcHMiKQogICAgICAgIAogICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbiBz4butIGThu6VuZyDEkcO6bmcgdMOqbiB0csaw4budbmcgZGF0YWJhc2UKICAgICAgICB3b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiaXNfbG9naW4iLCBGYWxzZSksICAjIMavdSB0acOqbiBhY2NvdW50IMSRw6MgbG9naW4KICAgICAgICAgICAgLXguZ2V0KCJqb2JfdG9kYXkiLCAwKSwgICMgxq91IHRpw6puIGFjY291bnQgw610IGpvYiBoxqFuIChkw7luZyBqb2JfdG9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2NvdW50KQogICAgICAgICAgICAteC5nZXQoImxhc3Rfam9iX3RpbWUiLCAwKSAgIyDGr3UgdGnDqm4gYWNjb3VudCBsw6J1IGtow7RuZyBsw6BtIGpvYiAodGltZXN0YW1wIG5nxrDhu6NjKQogICAgICAgICksIHJldmVyc2U9VHJ1ZSkKICAgICAgICAKICAgICAgICByZXR1cm4gd29ya2FibGVfYWNjb3VudHMKICAgIAogICAgZGVmIF9jYW5fd29ya193aXRoX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHRo4buDIGzDoG0gdmnhu4djIGhv4bq3YyBjaMSDbSBzw7NjIHbhu5tpIHTDoGkga2hv4bqjbiBraMO0bmcKICAgICAgICAow4FwIGThu6VuZyBjaG8gY+G6oyBKT0IgdsOgIENBUkUpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHJlc2V0IHNlc3Npb24gbuG6v3UgcXVhIG5nw6B5IG3hu5tpCiAgICAgICAgICAgIGlmIHNlbGYuX3Nob3VsZF9yZXNldF9zZXNzaW9uX29uX25ld19kYXkoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgIk5nw6B5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzdGF0dXMgKHPhu60gZOG7pW5nIGxvZ2ljIG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzIGluIFsiZGlzYWJsZWQiLCAibG9nb3V0Il06CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgaW5hY3RpdmUsIGtp4buDbSB0cmEgam9iX2Rpc2FibGVfdW50aWwgKGdp4buRbmcgSm9iU2VydmljZSkKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsID4gdGltZS50aW1lKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFbhuqtuIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgam9iX2VuYWJsZSA9IDEgKGJvb2xlYW4gY2hlY2spCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFwcCBjw7MgxJHGsOG7o2MgZW5hYmxlIGtow7RuZwogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgY8OzIGpvYiBoYW5kbGVyIGtow7RuZwogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBhY2NvdW50IGPDsyDEkWFuZyBuZ2jhu4kgbmfGoWkga2jDtG5nCiAgICAgICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhhY2NvdW50X2lkKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS0jDlE5HIGtp4buDbSB0cmEgaXNfZ29saWtlX2xpbmtlZCDhu58gxJHDonkgLSDEkeG7gyBjaG8gX2Nhbl9ydW5fam9iKCkgY2hlY2sKICAgICAgICAgICAgIyBBY2NvdW50IGPDsyB0aOG7gyDEkcaw4bujYyBjaMSDbSBzw7NjIG3DoCBraMO0bmcgY+G6p24gbGluayBHb0xpa2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBhY2NvdW50IHdvcmthYmxlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2Nhbl9kb19qb2Jfd2l0aF9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBsw6BtIEpPQiB24bubaSB0w6BpIGtob+G6o24ga2jDtG5nIChyacOqbmcgYmnhu4d0IHbhu5tpIGNhcmUpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjxqEgYuG6o24gdHLGsOG7m2MKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudChhY2NvdW50KToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgZGFpbHkgam9iIGxpbWl0IC0gc+G7rSBk4bulbmcgZmllbGQgbmFtZXMgxJHDum5nIG5oxrAgREIgc2NoZW1hCiAgICAgICAgICAgIGRhaWx5X2pvYl9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKSAgIyBGaWVsZCB0aOG6rXQgdHJvbmcgREIKICAgICAgICAgICAgZGFpbHlfam9iX2xpbWl0ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgICMgRmllbGQgdGjhuq10IHRyb25nIERCCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gam9iIGxpbWl0IGNoZWNrOiBqb2JfdG9kYXk9e2RhaWx5X2pvYl9jb3VudH0sIGpvYl9tYXhfZGF5PXtkYWlseV9qb2JfbGltaXR9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRhaWx5X2pvYl9saW1pdCA+IDAgYW5kIGRhaWx5X2pvYl9jb3VudCA+PSBkYWlseV9qb2JfbGltaXQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZGFpbHkgam9iIGxpbWl0ICh7ZGFpbHlfam9iX2NvdW50fS97ZGFpbHlfam9iX2xpbWl0fSkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgYWNjb3VudCBjw7MgxJFhbmcgcmVzdGluZyBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9yZXN0aW5nKGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IMSRYW5nIHJlc3RpbmciKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIEdvTGlrZSBsaW5rIChj4bqnbiBjaG8gam9iKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gY2jGsGEgbGluayBHb0xpa2UiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gY8OzIHRo4buDIGzDoG0gam9iOiBqb2JzPXtkYWlseV9qb2JfY291bnR9L3tkYWlseV9qb2JfbGltaXR9LCBnb2xpa2U9e2FjY291bnQuZ2V0KCdpc19nb2xpa2VfbGlua2VkJywgRmFsc2UpfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBjYW4gZG8gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyBsb2dpYyB04buRaSDGsHUgdOG7qyBKb2JTZXJ2aWNlOgogICAgICAgIDEuIFTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wICh04burIHRyYWNraW5nKQogICAgICAgIDIuIFTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyB0aOG7qSB04buxIGFwcCwgbmfDoHkgdOG6oW8KICAgICAgICAKICAgICAgICBDaOG7iSB2ZXJpZnkgbG9naW4gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBob+G6t2Mga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBPcHRpb25hbFtEaWN0XTogVMOgaSBraG/huqNuIMSRxrDhu6NjIGNo4buNbiBob+G6t2MgTm9uZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IEtp4buDbSB0cmEgY3VycmVudCB3b3JraW5nIGFjY291bnQgdHLGsOG7m2MKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudDoKICAgICAgICAgICAgICAgIGN1cnJlbnRfaWQgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJLaeG7g20gdHJhIGN1cnJlbnQgYWNjb3VudDoge2N1cnJlbnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSBkYXRhIG3hu5tpIG5o4bqldCB04burIGRhdGFiYXNlCiAgICAgICAgICAgICAgICB1cGRhdGVkX2N1cnJlbnRfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoY3VycmVudF9pZCkKICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY3VycmVudCBhY2NvdW50IGPDsyBjw7JuIMSR4bunIMSRaeG7gXUga2nhu4duIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgICAgICAgICAgICAgIGNhbl9jb250aW51ZSA9ICgKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KHVwZGF0ZWRfY3VycmVudF9hY2NvdW50KSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgbm90IHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhjdXJyZW50X2lkKSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgbm90IHNlbGYuX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChjdXJyZW50X2lkKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBjYW5fY29udGludWU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlRp4bq/cCB04bulYyB24bubaSBjdXJyZW50IGFjY291bnQ6IHtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICMgVXBkYXRlIHdvcmtpbmcgYWNjb3VudCB24bubaSBkYXRhIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gdXBkYXRlZF9jdXJyZW50X2FjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRfY3VycmVudF9hY2NvdW50CiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDdXJyZW50IGFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IGtow7RuZyBjw7JuIGzDoG0gdmnhu4djIMSRxrDhu6NjLCB0w6xtIGFjY291bnQgbeG7m2kiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyDEkOG6t3QgYWNjb3VudCBoaeG7h24gdOG6oWkgbmdo4buJIG5nxqFpIG7hur91IGPhuqduCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChjdXJyZW50X2lkKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGN1cnJlbnRfaWQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb24gPSBmIlNlc3Npb24gbGltaXQ6IHtzZXNzaW9uWydhY3Rpb25fY291bnQnXX0gYWN0aW9ucywge3Nlc3Npb25bJ2pvYl9jb3VudCddfSBqb2JzIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChjdXJyZW50X2lkLCByZWFzb24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4bq3dCBhY2NvdW50IHtjdXJyZW50X3VzZXJuYW1lfSBuZ2jhu4kgbmfGoWkgLSB7cmVhc29ufSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIENsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiQ3VycmVudCBhY2NvdW50IHtjdXJyZW50X2lkfSBraMO0bmcgdOG7k24gdOG6oWkgdHJvbmcgREIiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogVMOsbSBhY2NvdW50IMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyB0cmFja2luZyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAjIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBsw6BtIHZp4buHYyB24bubaSBhcHAgbsOgeSAoY2jhu4kga2hpIGPhuqduKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICAjIENo4buJIHZlcmlmeSBraGkga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyB0cm9uZyB0cmFja2luZyBob+G6t2Mga2hpIHRyYWNraW5nIGtow7RuZyBo4bujcCBs4buHCiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IGzhuqduIMSR4bqndS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSDEkcOjIHRo4butIHZlcmlmeSDEkeG7gyBraMO0bmcgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEPDsyB0cmFja2luZyBy4buTaSwga2jDtG5nIGPhuqduIHZlcmlmeSBuZ2F5CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIHThu6sgdHJhY2tpbmcKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGxvZ2dlZF9pbl9hY2NvdW50X2lkKQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQgYW5kIHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgIyBWZXJpZnkgYWNjb3VudCB0aOG7sWMgdOG6vyB0csOqbiBhcHAgKHF1YW4gdHLhu41uZyBzYXUga2hpIHJlc3RhcnQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3ZlcmlmeV9hY2NvdW50X2luX2FwcChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdsOgIHZlcmlmaWVkIHTDoGkga2hv4bqjbiB04burIHRyYWNraW5nOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB0cmFja2luZyB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgdmVyaWZ5IMSRxrDhu6NjLCB4w7NhIHRyYWNraW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVmVyaWZ5IGZ1bmN0aW9uIMSRw6MgdOG7sSDEkeG7mW5nIHjDs2EgdHJhY2tpbmcgdsOgIHN5bmMsIHRp4bq/cCB04bulYyB0w6xtIGFjY291bnQga2jDoWMKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBraMO0bmcgY8OybiBo4bujcCBs4buHLCB4w7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQsIHsiaXNfbG9naW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHtsb2dnZWRfaW5fYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMzogVMOsbSB0w6BpIGtob+G6o24gxJHEg25nIG5o4bqtcCB04burIGRhdGFiYXNlIHbhu5tpIHZlcmlmaWNhdGlvbiB0aOG7sWMgdOG6vwogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICMgxq91IHRpw6puIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIHThu6sgREIgLSBz4butIGThu6VuZyBmaWVsZCAiaXNfbG9naW4iIG5oxrAgSm9iU2VydmljZQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBhbmQgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogVmVyaWZ5IHRo4buxYyB04bq/IHRyw6puIGFwcCB0csaw4bubYyBraGkgdGluIHTGsOG7n25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3ZlcmlmeV9hY2NvdW50X2luX2FwcChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdsOgIHZlcmlmaWVkIHTDoGkga2hv4bqjbiDEkcSDbmcgbmjhuq1wOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgdmVyaWZ5IMSRxrDhu6NjLCB0aeG6v3AgdOG7pWMgdMOsbS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFZlcmlmeSBz4bq9IHThu7EgxJHhu5luZyBzeW5jIHbDoCBj4bqtcCBuaOG6rXQgdHJhY2tpbmcsIHRp4bq/cCB04bulYyB24bubaSBhY2NvdW50IGtow6FjCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgNDogTuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgbOG6pXkgdMOgaSBraG/huqNuIHRoZW8gdGjhu6kgdOG7sQogICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudChhY2MpXQogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLmV4dGVuZCh3b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBhbGxfd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIktow7RuZyBjw7MgYWNjb3VudCBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjogYXBwIG5hbWUsIGNyZWF0ZWRfZGF0ZQogICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydCgKICAgICAgICAgICAgICAgIGtleT1sYW1iZGEgeDogKHguZ2V0KCJhcHAiLCAiIiksIHguZ2V0KCJjcmVhdGVkX2RhdGUiLCAiIikpCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLhuqMgduG7gSBhY2NvdW50IMSR4bqndSB0acOqbgogICAgICAgICAgICBzZWxlY3RlZF9hY2NvdW50ID0gYWxsX3dvcmthYmxlX2FjY291bnRzWzBdCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2jhu41uIGFjY291bnQgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjoge3NlbGVjdGVkX2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHtzZWxlY3RlZF9hY2NvdW50LmdldCgnYXBwJyl9KSIpCiAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZF9hY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF92ZXJpZnlfYWNjb3VudF9pbl9hcHAoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmVyaWZ5IGFjY291bnQgdGjhu7FjIHThur8gdHLDqm4gYXBwIGPDsyDEkcO6bmcgYWNjb3VudCDEkWFuZyBsb2dpbiB0cm9uZyBEQiBraMO0bmcKICAgICAgICBO4bq/dSBraMO0bmcgxJHDum5nIHRow6wgc3luYyBs4bqhaSBhY2NvdW50IHThu6sgYXBwIHbhu4EgREIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBBY2NvdW50IHThu6sgREIgY8OzIGlzX2xvZ2luID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGFjY291bnQgxJHDum5nIGhv4bq3YyBzeW5jIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBleHBlY3RlZF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgYWNjb3VudCB7ZXhwZWN0ZWRfdXNlcm5hbWV9IHRyw6puIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IE3hu58gYXBwIHbDoCBraeG7g20gdHJhIGFjY291bnQgaGnhu4duIHThuqFpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGFwcCDEkcaw4bujYyBt4bufCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICdlbnN1cmVfYXBwX29wZW4nKToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLmVuc3VyZV9hcHBfb3BlbigpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdXNlcm5hbWUgdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgY3VycmVudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBs4bqleSDEkcaw4bujYyB1c2VybmFtZSBoaeG7h24gdOG6oWkgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgIyBTZXQgYWNjb3VudCB24buBIGlzX2xvZ2luID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsiaXNfbG9naW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgIyBYw7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNvIHPDoW5oIHbhu5tpIGFjY291bnQgdHJvbmcgREIKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdXNlcm5hbWUubG93ZXIoKSA9PSBleHBlY3RlZF91c2VybmFtZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIFZlcmlmaWVkOiBBY2NvdW50IHtleHBlY3RlZF91c2VybmFtZX0gxJHDum5nIMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinYwgQWNjb3VudCBtaXNtYXRjaDogREI9e2V4cGVjdGVkX3VzZXJuYW1lfSwgQXBwPXtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgIyBD4bqnbiBzeW5jIGzhuqFpIHThu6sgYXBwIHbhu4EgREIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fc3luY19hY2NvdW50X2Zyb21fYXBwX3RvX2RiKGFwcF9uYW1lLCBjdXJyZW50X3VzZXJuYW1lKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBfdmVyaWZ5X2FjY291bnRfaW5fYXBwOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3N5bmNfYWNjb3VudF9mcm9tX2FwcF90b19kYihzZWxmLCBhcHBfbmFtZTogc3RyLCBjdXJyZW50X3VzZXJuYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgU3luYyBhY2NvdW50IHThu6sgYXBwIHbhu4EgREIga2hpIHBow6F0IGhp4buHbiBtaXNtYXRjaAogICAgICAgIFPhu60gZOG7pW5nIGxvZ2ljIHThu6sgSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lOiBVc2VybmFtZSDEkWFuZyBsb2dpbiB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBzeW5jIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyBhY2NvdW50IHThu6sge2FwcF9uYW1lfSB24buBIERCLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBTeW5jIHThuqV0IGPhuqMgYWNjb3VudHMgdOG7qyBhcHAgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHN5bmMge2xlbihhY2NvdW50cyl9IGFjY291bnRzIHThu6sge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHN5bmMgYWNjb3VudHMgdOG7qyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogUmVzZXQgdOG6pXQgY+G6oyBhY2NvdW50cyBj4bunYSBhcHAgduG7gSBpc19sb2dpbiA9IEZhbHNlCiAgICAgICAgICAgIGFwcF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYXBwX2FjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMzogVMOsbSB2w6AgY+G6rXAgbmjhuq10IGFjY291bnQgxJFhbmcgbG9naW4gdGjhu7FjIHThur8KICAgICAgICAgICAgY3VycmVudF9hY2NvdW50ID0gTm9uZQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhcHBfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkgPT0gY3VycmVudF91c2VybmFtZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IGFjY291bnQKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgYWNjb3VudCBoaeG7h24gdOG6oWkgduG7gSBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoY3VycmVudF9hY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBjdXJyZW50X2FjY291bnRbImlkIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUgU3luYyB0aMOgbmggY8O0bmc6IEFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IMSRw6MgxJHGsOG7o2MgY+G6rXAgbmjhuq10IGxvZ2luIHN0YXR1cyIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinYwgS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IHRyb25nIERCIHNhdSBzeW5jIikKICAgICAgICAgICAgICAgICMgWMOzYSB0cmFja2luZwogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzeW5jIGFjY291bnQgdOG7qyBhcHAgduG7gSBEQjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgdHLhuqFuZyB0aMOhaSBsb2dpbiB0aOG7sWMgdOG6vyB0csOqbiDEkWnhu4duIHRob+G6oWkgc+G7rSBk4bulbmcgaMOgbSBjw7Mgc+G6tW4gY+G7p2EgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyBsb2dpbiB0aOG7sWMgdOG6vyB0csOqbiDEkWnhu4duIHRob+G6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY8OzIHPhurVuIMSR4buDIGNoZWNrIGxvZ2luIHN0YXR1cwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgaWYgY3VycmVudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBcHAge2FwcF9uYW1lfSDEkcOjIGxvZ2luIHbhu5tpIHVzZXJuYW1lOiB7Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFwcCB7YXBwX25hbWV9IGNoxrBhIGxvZ2luIGhv4bq3YyBraMO0bmcgbOG6pXkgxJHGsOG7o2MgdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBraeG7g20gdHJhIGxvZ2luIHN0YXR1cyBjaG8ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICMgRmFsbGJhY2s6IHPhu60gZOG7pW5nIHRy4bqhbmcgdGjDoWkgdOG7qyBEQgogICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB2YWxpZGF0ZSBhY3R1YWwgbG9naW4gc3RhdHVzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9pc19jb3JyZWN0X2FjY291bnRfbG9nZ2VkX2luKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIMSRw7puZyBhY2NvdW50IG7DoHkgxJFhbmcgxJHEg25nIG5o4bqtcCB0csOqbiDEkWnhu4duIHRob+G6oWkga2jDtG5nCiAgICAgICAgU+G7rSBk4bulbmcgaMOgbSBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY8OzIHPhurVuIGPhu6dhIGhhbmRsZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw7puZyBhY2NvdW50IG7DoHkgxJFhbmcgxJHEg25nIG5o4bqtcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgdGFyZ2V0X3VzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY8OzIHPhurVuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lIGFuZCB0YXJnZXRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgaXNfY29ycmVjdCA9IGN1cnJlbnRfdXNlcm5hbWUubG93ZXIoKSA9PSB0YXJnZXRfdXNlcm5hbWUubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkN1cnJlbnQgbG9nZ2VkOiB7Y3VycmVudF91c2VybmFtZX0sIFRhcmdldDoge3RhcmdldF91c2VybmFtZX0sIE1hdGNoOiB7aXNfY29ycmVjdH0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc19jb3JyZWN0CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIktow7RuZyBs4bqleSDEkcaw4bujYyBjdXJyZW50IHVzZXJuYW1lIGhv4bq3YyB0YXJnZXQgdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBs4bqleSBjdXJyZW50IHVzZXJuYW1lIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogYXNzdW1lIGNvcnJlY3QgbuG6v3Uga2jDtG5nIGNoZWNrIMSRxrDhu6NjCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjaGVjayBjb3JyZWN0IGFjY291bnQgbG9nZ2VkIGluOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gY2h1eeG7g24gxJHhu5VpIHTDoGkga2hv4bqjbiBz4butIGThu6VuZyBsb2dpYyBjw7Mgc+G6tW4gdHJvbmcgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIGPhuqduIGNodXnhu4NuIHThu5tpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY2h1eeG7g24gxJHhu5VpIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBzd2l0Y2ggc2FuZyBhY2NvdW50IHt1c2VybmFtZX0gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGNhcmUgYWN0aW9uIGNvdW50ZXIga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzZWxmLl9yZXNldF9jYXJlX2FjdGlvbl9jb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgY3VycmVudCBsb2dnZWQgYWNjb3VudCB0csaw4bubYyBraGkgc3dpdGNoCiAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50IGLhurFuZyBoYW5kbGVyIC0gc+G7rSBk4bulbmcgaMOgbSBjw7Mgc+G6tW4KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHN3aXRjaF90b19hY2NvdW50IGPDsyBz4bq1biB0cm9uZyBoYW5kbGVyCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICdzd2l0Y2hfdG9fYWNjb3VudCcpOgogICAgICAgICAgICAgICAgICAgIHN3aXRjaF9yZXN1bHQgPSBoYW5kbGVyLnN3aXRjaF90b19hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBY4butIGzDvSBr4bq/dCBxdeG6oyBzd2l0Y2gKICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHN3aXRjaF9yZXN1bHQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAjIEhhbmRsZXIgdHLhuqMgduG7gSByZXN1bHQgZGljdAogICAgICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gc3dpdGNoX3Jlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHN3aXRjaF9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTd2l0Y2ggYWNjb3VudCB0aMOgbmggY8O0bmc6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBsb2dpbiB0cm9uZyBEQiB2w6AgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKGFwcF9uYW1lLCBhY2NvdW50X2lkLCBUcnVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU3dpdGNoIGFjY291bnQgdGjhuqV0IGLhuqFpOiB7dXNlcm5hbWV9IC0ge21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgSGFuZGxlciB0cuG6oyB24buBIGJvb2xlYW4gKGxlZ2FjeSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3dpdGNoIGFjY291bnQgdGjDoG5oIGPDtG5nOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gdHJvbmcgREIgdsOgIHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCwgVHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlN3aXRjaCBhY2NvdW50IHRo4bqldCBi4bqhaToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBGYWxsYmFjazogc+G7rSBk4bulbmcgZW5zdXJlX2FjY291bnRfbG9nZ2VkX2luCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiSGFuZGxlciB7YXBwX25hbWV9IGtow7RuZyBjw7Mgc3dpdGNoX3RvX2FjY291bnQsIGTDuW5nIGVuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbiIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbihhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgc3dpdGNoIGFjY291bnQge3VzZXJuYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtIGFjY291bnQgc3dpdGNoOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gdMOgaSBraG/huqNuIMSRw6MgxJHEg25nIG5o4bqtcCB0csOqbiBhcHAgduG7m2kgbG9naWMgdOG7kWkgxrB1CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB0YXJnZXRfdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBzd2l0Y2ggYWNjb3VudCBraMO0bmcKICAgICAgICAgICAgY3VycmVudF9sb2dnZWRfYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBuZWVkc19hY2NvdW50X3N3aXRjaCA9IChjdXJyZW50X2xvZ2dlZF9hY2NvdW50X2lkICE9IGFjY291bnRfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBuZWVkc19hY2NvdW50X3N3aXRjaDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6p24gY2h1eeG7g24gYWNjb3VudDogY3VycmVudD17Y3VycmVudF9sb2dnZWRfYWNjb3VudF9pZH0gLT4gdGFyZ2V0PXthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAyOiBWYWxpZGF0ZSBs4bqhaSB24bubaSBhcHAgdGjhu7FjIHThur8gdHLGsOG7m2Mga2hpIHN3aXRjaAogICAgICAgICAgICAgICAgc2hvdWxkX3N3aXRjaCA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgVOG7kEkgxq9VOiBDaOG7iSB2ZXJpZnkga2hpIHRo4buxYyBz4buxIG5naGkgbmfhu50gY+G6p24gc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBtZW1vcnkgdHJhY2tpbmcgY2hvIGJp4bq/dCDEkcOjIMSRw7puZyBhY2NvdW50LCBza2lwIHZlcmlmaWNhdGlvbgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMgYW5kIFwKICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJNZW1vcnkgdHJhY2tpbmcgY2hvIGJp4bq/dCDEkcOjIMSRw7puZyBhY2NvdW50IHt0YXJnZXRfdXNlcm5hbWV9LCBza2lwIHZlcmlmaWNhdGlvbiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjdXJyZW50IHVzZXJuYW1lIHRyw6puIGFwcCB0aOG7sWMgdOG6vyBz4butIGThu6VuZyBow6BtIGPDsyBz4bq1bgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJWZXJpZnkgY3VycmVudCB1c2VybmFtZSB0csOqbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9hcHBfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYXBwX3VzZXJuYW1lIGFuZCBjdXJyZW50X2FwcF91c2VybmFtZS5sb3dlcigpID09IHRhcmdldF91c2VybmFtZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBcHAgxJHDoyDEkcO6bmcgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9LCBraMO0bmcgY+G6p24gc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbWVtb3J5IHRyYWNraW5nIGNobyDEkcO6bmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBcHAgaGnhu4duIHThuqFpOiAne2N1cnJlbnRfYXBwX3VzZXJuYW1lfScsIGPhuqduIGNodXnhu4NuIHNhbmc6ICd7dGFyZ2V0X3VzZXJuYW1lfSciKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kgY2hlY2sgY3VycmVudCB1c2VybmFtZToge2V9IikKICAgICAgICAgICAgICAgICAgICAjIFbhuqtuIHRp4bq/cCB04bulYyBzd2l0Y2ggbuG6v3Uga2jDtG5nIGNoZWNrIMSRxrDhu6NjCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAzOiBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50IGNo4buJIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgICAgICAgICBpZiBzaG91bGRfc3dpdGNoOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjYXJlIGFjdGlvbiBjb3VudGVyIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9jYXJlX2FjdGlvbl9jb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGN1cnJlbnQgbG9nZ2VkIGFjY291bnQgdHLGsOG7m2Mga2hpIHN3aXRjaAogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBzd2l0Y2ggYWNjb3VudCAtIGhhbmRsZXIgc+G6vSB04buxIMSR4bqjbSBi4bqjbyBhcHAgbeG7nwogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHN3aXRjaF90b19hY2NvdW50IGPDsyBz4bq1biB0cm9uZyBoYW5kbGVyCiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaF9yZXN1bHQgPSBoYW5kbGVyLnN3aXRjaF90b19hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjIHN3aXRjaAogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHN3aXRjaF9yZXN1bHQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU3dpdGNoIGFjY291bnQgdGjhuqV0IGLhuqFpOiB7c3dpdGNoX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnVW5rbm93biBlcnJvcicpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlN3aXRjaCBhY2NvdW50IHRo4bqldCBi4bqhaSBjaG8ge3RhcmdldF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHN3aXRjaCBhY2NvdW50OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiS2jDtG5nIGPhuqduIHN3aXRjaCBhY2NvdW50IGNobyB7dGFyZ2V0X3VzZXJuYW1lfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt0YXJnZXRfdXNlcm5hbWV9IMSRw6MgbMOgIGN1cnJlbnQgbG9nZ2VkIGFjY291bnQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IMSQ4bqjbSBi4bqjbyDhu58gaG9tZSBzY3JlZW4gKGhhbmRsZXIgc+G6vSB04buxIG3hu58gYXBwIG7hur91IGPhuqduKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIGFic3RyYWN0IG1ldGhvZCBlbnN1cmVfaG9tZV9zY3JlZW4gLSBuw7Mgc+G6vSB04buxIGNoZWNrIHbDoCBt4bufIGFwcAogICAgICAgICAgICAgICAgaWYgbm90IGhhbmRsZXIuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIGhvbWUgc2NyZWVuIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmV0dXJuIHRy4bqhbmcgdGjDoWkgbG9naW4KICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgQXR0cmlidXRlRXJyb3IgYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkhhbmRsZXIge2FwcF9uYW1lfSBjaMawYSBpbXBsZW1lbnQgYXBwIG1hbmFnZW1lbnQgbWV0aG9kczoge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBleGNlcHQgTm90SW1wbGVtZW50ZWRFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiSGFuZGxlciB7YXBwX25hbWV9IGNoxrBhIGltcGxlbWVudCBhcHAgbWFuYWdlbWVudCBtZXRob2RzOiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZW5zdXJlIGFjY291bnQgbG9nZ2VkIGluOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jYW5fcnVuX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gam9iIGtow7RuZyAoc+G7rSBk4bulbmcgbG9naWMgbmjGsCBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIDEuIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24gKGdp4buRbmcgSm9iU2VydmljZSkKICAgICAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzIGluIFsiZGlzYWJsZWQiLCAibG9nb3V0Il06CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgaW5hY3RpdmUsIGtp4buDbSB0cmEgam9iX2Rpc2FibGVfdW50aWwKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsID4gdGltZS50aW1lKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDIuIEtp4buDbSB0cmEgam9iX2VuYWJsZQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gS2nhu4NtIHRyYSDEkcOjIGxpw6puIGvhur90IEdvTGlrZSAoY+G6p24gY2hvIGpvYnMpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA0LiBLaeG7g20gdHJhIMSRw6MgbG9naW4KICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA1LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBkYWlseQogICAgICAgICAgICBkYWlseV9saW1pdCA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDEwMCkgICMgU+G7rSBk4bulbmcgam9iX21heF9kYXkgbmjGsCBKb2JTZXJ2aWNlCiAgICAgICAgICAgIGRhaWx5X2NvdW50ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApICAjIFPhu60gZOG7pW5nIGpvYl90b2RheSBuaMawIEpvYlNlcnZpY2UKICAgICAgICAgICAgaWYgZGFpbHlfY291bnQgPj0gZGFpbHlfbGltaXQ6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNi4gS2nhu4NtIHRyYSBhcHAgY8OzIMSRxrDhu6NjIGVuYWJsZSBraMO0bmcKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGNhbiBydW4gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgdMOgaSBraG/huqNuIC0gdGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIMSRxrDhu6NjIGNo4buNbiB24bubaSBsb2dpYyB04buRaSDGsHUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGtow7RuZyBjw7MgbOG7l2kgbmdoacOqbSB0cuG7jW5nIChhY3Rpb24gY8OzIHRo4buDIHRo4bqldCBi4bqhaSBuaMawbmcgYWNjb3VudCB24bqrbiDhu5VuKQogICAgICAgICAgICAgICAgICBGYWxzZSBjaOG7iSBraGkgY8OzIGzhu5dpIG5naGnDqm0gdHLhu41uZyBj4bqnbiBjbGVhciBjdXJyZW50IGFjY291bnQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRVUFOIFRS4buMTkc6IFJlbG9hZCBhY2NvdW50IGRhdGEgdOG7qyBEQiDEkeG7gyDEkeG6o20gYuG6o28gdGjDtG5nIHRpbiBt4bubaSBuaOG6pXQgKHNhdSBzd2l0Y2gpCiAgICAgICAgICAgIGZyZXNoX2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIGZyZXNoX2FjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50ID0gZnJlc2hfYWNjb3VudAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVsb2FkZWQgZnJlc2ggYWNjb3VudCBkYXRhIGZvciB7dXNlcm5hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIHJlbG9hZCBhY2NvdW50IGRhdGEgY2hvIHt1c2VybmFtZX0sIHPhu60gZOG7pW5nIGRhdGEgY8WpIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSRxrDhu6NjIHNldCDEkcO6bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgb3Igc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImlkIikgIT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBhY2NvdW50CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJD4bqtcCBuaOG6rXQgY3VycmVudCB3b3JraW5nIGFjY291bnQ6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRVUFOIFRS4buMTkc6IMSQ4bqjbSBi4bqjbyBhY2NvdW50IMSRxrDhu6NjIHN3aXRjaCB0aOG7sWMgdOG6vyB0csOqbiBtw6F5CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9lbnN1cmVfYWNjb3VudF9zd2l0Y2hlZChhY2NvdW50KToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIHN3aXRjaCBzYW5nIGFjY291bnQge3VzZXJuYW1lfSwgxJHDoW5oIGThuqV1IHByb2JsZW1hdGljIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgYWNjb3VudCBjw7MgduG6pW4gxJHhu4EgdsOgIHNldCBuZ2jhu4kgbmfGoWkKICAgICAgICAgICAgICAgIHNlbGYuX3NldF9hY2NvdW50X3Jlc3QoYWNjb3VudF9pZCwgZiJTd2l0Y2ggZmFpbGVkOiBLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyBhY2NvdW50IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEzhu5dpIG5naGnDqm0gdHLhu41uZywgY2xlYXIgY3VycmVudCBhY2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGFjY291bnQgY8OzIMSRYW5nIG5naOG7iSBuZ8ahaSBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9yZXN0aW5nKGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHt1c2VybmFtZX0gxJFhbmcgbmdo4buJIG5nxqFpLCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBLaMO0bmcgcGjhuqNpIGzhu5dpIG5naGnDqm0gdHLhu41uZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7jW4gaMOgbmggxJHhu5luZyBuZ+G6q3Ugbmhpw6puIHRow7RuZyBxdWEgSm9iQmFzZQogICAgICAgICAgICBjaG9zZW5fYWN0aW9uID0gc2VsZi5fY2hvb3NlX3JhbmRvbV9hY3Rpb24oYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgc2Vzc2lvbiBpbmZvIHbDoCBsaW1pdHMgxJHhu4MgaGnhu4NuIHRo4buLCiAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQpCiAgICAgICAgICAgIHNlc3Npb25fbGltaXRzID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoYWNjb3VudCkKICAgICAgICAgICAgc2Vzc2lvbl9pbmZvID0gZiIoe3Nlc3Npb25bJ2FjdGlvbl9jb3VudCddfS97c2Vzc2lvbl9saW1pdHNbJ21heF9hY3Rpb25zX3Blcl9zZXNzaW9uJ119IGFjdGlvbnMsICIgXAogICAgICAgICAgICAgICAgICAgICAgICAgIGYie3Nlc3Npb25bJ2pvYl9jb3VudCddfS97c2Vzc2lvbl9saW1pdHNbJ21heF9qb2JzX3Blcl9zZXNzaW9uJ119IGpvYnMpIgogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgJ3tjaG9zZW5fYWN0aW9ufScgY2hvIHt1c2VybmFtZX0ge3Nlc3Npb25faW5mb30iKQogICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIntjaG9zZW5fYWN0aW9ufToge3VzZXJuYW1lfSB7c2Vzc2lvbl9pbmZvfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBhY3Rpb25fc3VjY2VzcyA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyDEkcaw4bujYyBjaOG7jW4gdGjDtG5nIHF1YSBKb2JCYXNlCiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBoYW5kbGVyOgogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgcGVyZm9ybV9hY3Rpb24gdOG7lW5nIHF1w6F0IHThu6sgSm9iQmFzZQogICAgICAgICAgICAgICAgYWN0aW9uX3N1Y2Nlc3MgPSBoYW5kbGVyLnBlcmZvcm1fYWN0aW9uKGNob3Nlbl9hY3Rpb24sIGFjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGNhcmUgYWN0aW9uIGNvdW50IHbDoCBqb2IgcmF0aW8gY2hvIGPDoWMgYWN0aW9uIGNhcmUKICAgICAgICAgICAgICAgICMgQ2jhu4kgxJHhur9tIGNhcmUgYWN0aW9ucywga2jDtG5nIMSRaeG7gXUgY2jhu4luaCBqb2IgcmF0aW8gbuG7r2EKICAgICAgICAgICAgICAgIGlmIGFjdGlvbl9zdWNjZXNzIGFuZCBjaG9zZW5fYWN0aW9uICE9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5faW5jcmVtZW50X2NhcmVfYWN0aW9uX2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBlbGlmIGFjdGlvbl9zdWNjZXNzIGFuZCBjaG9zZW5fYWN0aW9uID09IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjYXJlIGFjdGlvbiBjb3VudCBzYXUga2hpIGzDoG0gam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgYWN0aW9uX3N1Y2Nlc3MgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgc2Vzc2lvbiBkYXRhCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgY2hvc2VuX2FjdGlvbiwgYWN0aW9uX3N1Y2Nlc3MpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdoaSBs4bqhaSBs4buLY2ggc+G7rSBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIHNlbGYuX3JlY29yZF9hY3Rpb25faGlzdG9yeShhY2NvdW50X2lkLCBjaG9zZW5fYWN0aW9uLCBhY3Rpb25fc3VjY2VzcykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIG7Dqm4gY2h1eeG7g24gYWNjb3VudCBraMO0bmcgc2F1IGFjdGlvbiBuw6B5CiAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBzZWxmLl9zaG91bGRfc3dpdGNoX2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgc2hvdWxkX3N3aXRjaDoKICAgICAgICAgICAgICAgIHNlc3Npb24gPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVhc29uID0gc2VsZi5fZ2V0X3N3aXRjaF9yZWFzb24oYWNjb3VudF9pZCwgc2Vzc2lvbikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJT4bq9IGNodXnhu4NuIGFjY291bnQgc2F1IGFjdGlvbiBuw6B5LiBMw70gZG86IHtzd2l0Y2hfcmVhc29ufSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBT4butIGThu6VuZyDEkcO6bmcgbG/huqFpIHJlc3QgZOG7sWEgdHLDqm4gbMO9IGRvCiAgICAgICAgICAgICAgICBzZWxmLl9hcHBseV9hcHByb3ByaWF0ZV9yZXN0X3R5cGUoYWNjb3VudF9pZCwgc3dpdGNoX3JlYXNvbiwgc2Vzc2lvbikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBTZXQgbWVzc2FnZSBjaG8gZGV2aWNlCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIk5naOG7iSBuZ8ahaToge3VzZXJuYW1lfSAoe3N3aXRjaF9yZWFzb259KSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgZm9yY2UgdMOsbSBhY2NvdW50IG3hu5tpIGzhuqduIHNhdQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXR1cm4gRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY+G6p24gdMOsbSBhY2NvdW50IG3hu5tpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmV0dXJuIFRydWUgdsOsIGtow7RuZyBjw7MgbOG7l2kgbmdoacOqbSB0cuG7jW5nCiAgICAgICAgICAgICMgKGFjdGlvbiBjw7MgdGjhu4MgdGjhuqV0IGLhuqFpIG5oxrBuZyBhY2NvdW50IHbhuqtuIOG7lW4pCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgd29yayB3aXRoIHNpbmdsZSBhY2NvdW50OiB7ZX0iKQogICAgICAgICAgICAjIENo4buJIHJldHVybiBGYWxzZSBraGkgY8OzIGV4Y2VwdGlvbiBuZ2hpw6ptIHRy4buNbmcKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfZ2V0X3N3aXRjaF9yZWFzb24oc2VsZiwgYWNjb3VudF9pZDogaW50LCBzZXNzaW9uOiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGzDvSBkbyBjaHV54buDbiBhY2NvdW50CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgYWNjb3VudAogICAgICAgICAgICBzZXNzaW9uOiBTZXNzaW9uIGRhdGEKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBMw70gZG8gY2h1eeG7g24gYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIGFjY291bnQgdsOgIHNlc3Npb24gbGltaXRzCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcmV0dXJuICJBY2NvdW50IGtow7RuZyB04buTbiB04bqhaSIKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlc3Npb25fbGltaXRzID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoYWNjb3VudCkKICAgICAgICAgICAgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iXQogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdCiAgICAgICAgICAgIG1heF9zZXNzaW9uX2R1cmF0aW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9zZXNzaW9uX2R1cmF0aW9uIl0KICAgICAgICAgICAgCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHNlc3Npb25fZHVyYXRpb24gPSBjdXJyZW50X3RpbWUgLSBzZXNzaW9uWydzdGFydF90aW1lJ10KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlc3Npb25fZHVyYXRpb24gPj0gbWF4X3Nlc3Npb25fZHVyYXRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gZiJI4bq/dCB0aOG7nWkgZ2lhbiBzZXNzaW9uICh7c2Vzc2lvbl9kdXJhdGlvbi82MDouMWZ9L3ttYXhfc2Vzc2lvbl9kdXJhdGlvbi82MDouMWZ9IHBow7p0KSIKICAgICAgICAgICAgZWxpZiBzZXNzaW9uWydhY3Rpb25fY291bnQnXSA+PSBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIHJldHVybiBmIsSQ4bqhdCBnaeG7m2kgaOG6oW4gYWN0aW9ucyAoe3Nlc3Npb25bJ2FjdGlvbl9jb3VudCddfS97bWF4X2FjdGlvbnNfcGVyX3Nlc3Npb259KSIKICAgICAgICAgICAgZWxpZiBzZXNzaW9uWydqb2JfY291bnQnXSA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIHJldHVybiBmIsSQ4bqhdCBnaeG7m2kgaOG6oW4gam9icyAoe3Nlc3Npb25bJ2pvYl9jb3VudCddfS97bWF4X2pvYnNfcGVyX3Nlc3Npb259KSIKICAgICAgICAgICAgZWxpZiBzZWxmLmFjY291bnRfY29uc2VjdXRpdmVfZmFpbHVyZXMuZ2V0KGFjY291bnRfaWQsIDApID49IE1haW5TZXJ2aWNlQ29uc3RhbnRzLlNXSVRDSF9BQ0NPVU5UX0FGVEVSX0NPTlNFQ1VUSVZFX0ZBSUxTOgogICAgICAgICAgICAgICAgcmV0dXJuIGYiVGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cCAoe3NlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlc1thY2NvdW50X2lkXX0pIgogICAgICAgICAgICBlbGlmIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMuZ2V0KGFjY291bnRfaWQsIDApID49IE1haW5TZXJ2aWNlQ29uc3RhbnRzLlNXSVRDSF9BQ0NPVU5UX0FGVEVSX05PX0pPQlM6CiAgICAgICAgICAgICAgICByZXR1cm4gZiJLaMO0bmcgY8OzIGpvYiBsacOqbiB0aeG6v3AgKHtzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzW2FjY291bnRfaWRdfSkiCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gIktow6FjIgogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBnZXQgc3dpdGNoIHJlYXNvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICJM4buXaSB4w6FjIMSR4buLbmggbMO9IGRvIgogICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIMSR4buZbmcgTWFpblNlcnZpY2UiIiIKICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIMSR4buZbmcgTWFpblNlcnZpY2UuLi4iKQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBu4bq/dSBjaMawYSDEkcaw4bujYyBraOG7n2kgdOG6oW8KICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIE1haW5TZXJ2aWNlIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgQ2jhuqF5IG1haW4gbG9vcCB0cm9uZyB0aHJlYWQKICAgICAgICBzZWxmLnJ1bigpCiAgICAKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhuqF5IE1haW5TZXJ2aWNlIC0gbG9vcCBjaMOtbmgga+G6v3QgaOG7o3AgY2jEg20gc8OzYyB2w6AgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIE1haW5TZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBNYWluU2VydmljZSB24bubaSBsb2dpYyBow6BpIGjDsmEgY2jEg20gc8OzYyB2w6AgbMOgbSB2aeG7h2MuLi4iKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBkZXZpY2VfaWQKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQgaGnhu4duIHThuqFpLCBNYWluU2VydmljZSBraMO0bmcgdGjhu4MgY2jhuqF5IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgd2hpbGUgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAjIFJlc2V0IGJp4bq/biBmb3JjZV9zdG9wIG7hur91IGPDswogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIsIHThuqFtIGThu6tuZyB44butIGzDvSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBraGkgYuG7iyB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGRvIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgaW50ZXJuZXQKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmhlbHBlci5jaGVja19pbnRlcm5ldCgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIGvhur90IG7hu5FpIGludGVybmV0LCBuZ2jhu4kgMjBzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgyMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBGZXRjaCBHb0xpa2UgaGVhZGVycyBu4bq/dSBjw7MgY29uZmlnIGNobyBwaMOpcAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlzX2F1dG9fZ2V0X2hlYWRlciA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoImlzX2F1dG9fZ2V0X2dvbGlrZV9oZWFkZXIiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpZiBpc19hdXRvX2dldF9oZWFkZXI6CiAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRzX2hlYWRlcnNfcmVmcmVzaCA9IHNlbGYuZ29saWtlX3NlcnZpY2UubmVlZHNfaGVhZGVyc19yZWZyZXNoKCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5lZWRzX2hlYWRlcnNfcmVmcmVzaDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiRmV0Y2ggR29MaWtlIGhlYWRlcnMiKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgZmV0Y2ggR29MaWtlIGhlYWRlcnMiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBnb2xpa2VfaGVhZGVycyA9IHNlbGYuZ29saWtlX3NlcnZpY2UuZmV0Y2hfZ29saWtlX2hlYWRlcnNfd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBnb2xpa2VfaGVhZGVyczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJHb0xpa2UgaGVhZGVycyBraMO0bmcgaOG7o3AgbOG7hywgbmdo4buJIDVzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiQ29uZmlnIGlzX2F1dG9fZ2V0X2dvbGlrZV9oZWFkZXIgPSBmYWxzZSwgYuG7jyBxdWEgdmnhu4djIHThu7EgxJHhu5luZyBs4bqleSBoZWFkZXJzIikKICAgICAgICAgICAgICAgICAgICAgICAgIyBDaOG7iSBraeG7g20gdHJhIGPDsyBoZWFkZXJzIHThu6sgc2VydmVyIGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZS5pc19nb2xpa2VfYXV0aGVudGljYXRlZCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNoxrBhIGPDsyBHb0xpa2UgaGVhZGVycyB04burIHNlcnZlciwgbmdo4buJIDMwcyB2w6AgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgzMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmZXRjaCBHb0xpa2UgaGVhZGVyczoge2V9IikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2hvbWUoKQogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MgKGzhuqduIHtzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudH0pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9OT19BQ0NPVU5UUykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSB0csaw4bubYyBraGkga2nhu4NtIHRyYSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBraGkgY8OzIHTDoGkga2hv4bqjbiDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHdvcmtpbmcgYWNjb3VudAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIkzDoG0gdmnhu4djIGjDoGkgaMOyYSIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIFRydWUpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBNYWluU2VydmljZUNvbnN0YW50cy5NU0dfV09SS0lOR19IQVJNT05JT1VTKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgd29ya19yZXN1bHQgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoYWNjb3VudF90b193b3JrKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IHdvcmtfcmVzdWx0ID0gRmFsc2UsIG5naMSpYSBsw6AgYWNjb3VudCBj4bqnbiBuZ2jhu4kgbmfGoWkKICAgICAgICAgICAgICAgICMgVGnhur9wIHThu6VjIHTDrG0gYWNjb3VudCBraMOhYyBuZ2F5IGzhuq1wIHThu6ljCiAgICAgICAgICAgICAgICBpZiBub3Qgd29ya19yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFjY291bnQgxJHDoyDEkcaw4bujYyDEkeG6t3Qgbmdo4buJIG5nxqFpLCB0w6xtIGFjY291bnQga2jDoWMuLi4iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyBs4bqnbiBsw6BtIHZp4buHYyB24bubaSBjw7luZyBhY2NvdW50CiAgICAgICAgICAgICAgICBhY3Rpb25fZGVsYXlfbWluID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiYWN0aW9uX2RlbGF5X21pbiIsIDMpCiAgICAgICAgICAgICAgICBhY3Rpb25fZGVsYXlfbWF4ID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiYWN0aW9uX2RlbGF5X21heCIsIDgpCiAgICAgICAgICAgICAgICBkZWxheV90aW1lID0gcmFuZG9tLnJhbmRpbnQoYWN0aW9uX2RlbGF5X21pbiwgYWN0aW9uX2RlbGF5X21heCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtkZWxheV90aW1lfXMgdHLGsOG7m2Mga2hpIGzDoG0gdmnhu4djIHRp4bq/cCB0aGVvIikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoZGVsYXlfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmggTWFpblNlcnZpY2UiKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgICMgQ2xlYW51cCBraGkgdGhvw6F0CiAgICAgICAgc2VsZi5fY2xlYW51cF9vbl9leGl0KCkKICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2UgxJHDoyBk4burbmciKQogICAgCiAgICBkZWYgX2NsZWFudXBfb25fZXhpdChzZWxmKToKICAgICAgICAiIiJDbGVhbnVwIGtoaSBNYWluU2VydmljZSBk4burbmciIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTmjhuqMgcHJveHkKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGtoaSBNYWluU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcAogICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IGtoaSBNYWluU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnY2xvc2VfYXBwJyk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBjbGVhbnVwOiB7ZX0iKQogICAgCiAgICBkZWYgX3ZlcmlmeV9jdXJyZW50X2FjY291bnRfb25fYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlciBj4bunYSBhcHAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIGFwcCwgTm9uZSBu4bq/dSBraMO0bmcgY8OzIGhv4bq3YyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoaGFuZGxlciwgJ2dldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZScpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJIYW5kbGVyIHthcHBfbmFtZX0ga2jDtG5nIGjhu5cgdHLhu6MgZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgdOG7qyBVSQogICAgICAgICAgICBjdXJyZW50X2FjY291bnRfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gdHJvbmcgREIKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpID09IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlZlcmlmaWVkOiBUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnRfdXNlcm5hbWV9IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbmjGsG5nIGtow7RuZyBjw7MgdHJvbmcgREIiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2ZXJpZnkgY3VycmVudCBhY2NvdW50IHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShzZWxmLCBhcHBfbmFtZTogc3RyLCBoYW5kbGVyKToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaSBpc19sb2dpbiB0cm9uZyBEQiB24bubaSB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIgY+G7p2EgYXBwCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIHZlcmlmeSBhY2NvdW50IChu4bq/dSBj4bqnbikKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKGYiVmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX0sIGLhu48gcXVhIHZlcmlmeSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLl92ZXJpZnlfY3VycmVudF9hY2NvdW50X29uX2FwcChhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgYXBwIG7DoHkgduG7gSBpc19sb2dpbiA9IEZhbHNlIHRyb25nIERCCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICByZXNldF9jb3VudCA9IDAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICByZXNldF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgaXNfbG9naW4gPSBGYWxzZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc2V0X2NvdW50ID4gMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQge3Jlc2V0X2NvdW50fSB0w6BpIGtob+G6o24gduG7gSBpc19sb2dpbiA9IEZhbHNlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBpZiBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGN1cnJlbnRfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gY3VycmVudF9hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgdHLhuqFuZyB0aMOhaTogVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGxvZ2luCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IEtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBzeW5jIGxvZ2luIHN0YXR1cyBjaG8ge2FwcF9uYW1lfToge2V9IikKCiAgICBkZWYgX2luaXRpYWxfc3luY19hbGxfYWNjb3VudHNfbG9naW5fc3RhdHVzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBiYW4gxJHhuqd1OiDEkeG7jWMgdOG6pXQgY+G6oyBhcHBzIHbDoCBzeW5jIHRy4bqhbmcgdGjDoWkgaXNfbG9naW4gY2hvIGNodeG6qW4geMOhYwogICAgICAgIENo4buJIGfhu41pIG3hu5l0IGzhuqduIGtoaSBraOG7n2kgxJHhu5luZyBNYWluU2VydmljZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflI0gQuG6r3QgxJHhuqd1IGto4bufaSB04bqhbzogU3luYyB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB04bqldCBj4bqjIGFwcHMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhciB0cmFja2luZyDEkeG7gyBi4bqvdCDEkeG6p3UgZnJlc2gKICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkLmNsZWFyKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3luYyB04burbmcgYXBwCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TsSBTeW5jIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBIb8OgbiB0aMOgbmggc3luYyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBM4buXaSBzeW5jIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4pqg77iPIEtow7RuZyBjw7MgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgc3luYyIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+OryBIb8OgbiB0aMOgbmgga2jhu59pIHThuqFvIHN5bmMgbG9naW4gc3RhdHVzLiBUcmFja2luZzoge3NlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLinYwgTOG7l2kgdHJvbmcgaW5pdGlhbCBzeW5jIGFjY291bnRzOiB7ZX0iKQoKICAgIGRlZiBfdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgYWNjb3VudF9pZDogaW50LCBpc19sb2dpbjogYm9vbCk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBj4bunYSB0w6BpIGtob+G6o24gKHTGsMahbmcgdOG7sSBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCB0w6BpIGtob+G6o24gCiAgICAgICAgICAgIGlzX2xvZ2luOiBUcnVlIG7hur91IMSRw6MgxJHEg25nIG5o4bqtcCwgRmFsc2UgbuG6v3UgbG9nb3V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGlzX2xvZ2luLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcgdHJvbmcgbWVtb3J5CiAgICAgICAgICAgIGlmIGlzX2xvZ2luOgogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGtow6FjIGPhu6dhIGPDuW5nIGFwcCBsw6AgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIG9sZF9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBpZiBvbGRfYWNjb3VudF9pZCAhPSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KG9sZF9hY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBjxakge29sZF9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkgbG9nb3V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IHTDoGkga2hv4bqjbiBt4bubaQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgWMOzYSBraOG7j2kgdHJhY2tpbmcgbuG6v3UgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzIGFuZCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wOiB7ZX0iKQoKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBNYWluU2VydmljZSIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgTWFpblNlcnZpY2UuLi4iKQogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBmb3JjZV9zdG9wX2FsbChzZWxmKToKICAgICAgICAiIiJGb3JjZSBzdG9wIHThuqV0IGPhuqMiIiIKICAgICAgICBsb2dnZXIuaW5mbygiRm9yY2Ugc3RvcCBNYWluU2VydmljZS4uLiIpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IFRydWUKICAgIAogICAgZGVmIGdldF9zZXJ2aWNlX3N0YXRzKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4buRbmcga8OqIGPhu6dhIE1haW5TZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogVGjhu5FuZyBrw6ogc2VydmljZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBzZWxmLl9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHN0YXRzID0gewogICAgICAgICAgICAgICAgInNlcnZpY2VfdHlwZSI6ICJNYWluU2VydmljZSIsCiAgICAgICAgICAgICAgICAiaXNfcnVubmluZyI6IHNlbGYucnVubmluZywKICAgICAgICAgICAgICAgICJpc19pbml0aWFsaXplZCI6IHNlbGYuaXNfaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgICAgICAidG90YWxfd29ya2FibGVfYWNjb3VudHMiOiBsZW4od29ya2FibGVfYWNjb3VudHMpLAogICAgICAgICAgICAgICAgImN1cnJlbnRfd29ya2luZ19hY2NvdW50Ijogc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgZWxzZSBOb25lLAogICAgICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IHNlbGYuZW5hYmxlZF9hcHBzLAogICAgICAgICAgICAgICAgImNhcmVfYWN0aW9uX2NvdW50cyI6IHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLAogICAgICAgICAgICAgICAgIm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCI6IHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50LAogICAgICAgICAgICAgICAgInByb3h5X2FjdGl2ZSI6IHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKSBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ2lzX3Byb3h5X2FjdGl2ZScpIGVsc2UgRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHN0YXRzCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHNlcnZpY2Ugc3RhdHM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgCiAgICAjIE1ldGhvZHMgxJHhu4MgdMawxqFuZyB0aMOtY2ggduG7m2kgSm9iU2VydmljZSBpbnRlcmZhY2UgY2hvIE1RVFQgc2VydmljZQogICAgZGVmIGhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoc2VsZiwgY29uZmlnX2NoYW5nZXM6IERpY3Rbc3RyLCBBbnldID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIE1RVFQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfY2hhbmdlczogQ8OhYyB0aGF5IMSR4buVaSBjb25maWcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBuaOG6rW4gY29uZmlnIHVwZGF0ZSB04burIE1RVFQiKQogICAgICAgICAgICBpZiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ29uZmlnIGNoYW5nZXM6IHtjb25maWdfY2hhbmdlc30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgbuG6v3UgY8OzCiAgICAgICAgICAgICAgICBpZiAiZW5hYmxlZF9hcHBzIiBpbiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IGNvbmZpZ19jaGFuZ2VzWyJlbmFibGVkX2FwcHMiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6rXAgbmjhuq10IGVuYWJsZWRfYXBwczoge3NlbGYuZW5hYmxlZF9hcHBzfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGFjdGlvbiB3ZWlnaHRzIG7hur91IGPDswogICAgICAgICAgICAgICAgaWYgIm1haW5fc2VydmljZV9hY3Rpb25fd2VpZ2h0cyIgaW4gY29uZmlnX2NoYW5nZXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hY3Rpb25fd2VpZ2h0cyA9IGNvbmZpZ19jaGFuZ2VzWyJtYWluX3NlcnZpY2VfYWN0aW9uX3dlaWdodHMiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6rXAgbmjhuq10IGFjdGlvbiB3ZWlnaHRzOiB7c2VsZi5hY3Rpb25fd2VpZ2h0c30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgc3luY19zdGF0dXMgY2hhbmdlcyB2w6AgcmVsb2FkIGFjY291bnRzIG7hur91IGPhuqduCiAgICAgICAgICAgICAgICBzeW5jX3N0YXR1c19jaGFuZ2VkID0gRmFsc2UKICAgICAgICAgICAgICAgIGZvciBrZXkgaW4gY29uZmlnX2NoYW5nZXM6CiAgICAgICAgICAgICAgICAgICAgaWYga2V5LmVuZHN3aXRoKCdfc3luY19zdGF0dXMnKToKICAgICAgICAgICAgICAgICAgICAgICAgc3luY19zdGF0dXNfY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQaMOhdCBoaeG7h24gdGhheSDEkeG7lWkgc3luYyBzdGF0dXM6IHtrZXl9ID0ge2NvbmZpZ19jaGFuZ2VzW2tleV19IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgc3luY19zdGF0dXNfY2hhbmdlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi8J+UhCBTeW5jIHN0YXR1cyDEkcOjIHRoYXkgxJHhu5VpLCByZWxvYWQgYWNjb3VudHMgdsOgIHJlLXNjYW4gdOG7qyB0aGnhur90IGLhu4suLi4iKQogICAgICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgZm9yY2UgcmVmcmVzaAogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBsb2dpbiB0cmFja2luZyDEkeG7gyBmb3JjZSByZS12ZXJpZmljYXRpb24KICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZC5jbGVhcigpCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjw6FjIGNvdW50ZXIgxJHhu4MgYuG6r3QgxJHhuqd1IGN5Y2xlIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19hY2NvdW50X2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVHJpZ2dlciByZS1zY2FuIGFjY291bnRzIHThu6sgdGhp4bq/dCBi4buLIGNobyBjw6FjIGFwcCDEkcaw4bujYyBlbmFibGUKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZXNjYW5fZGV2aWNlX2FjY291bnRzX2FzeW5jKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi4pyFIMSQw6MgcmVzZXQgd29ya2luZyBhY2NvdW50LCBsb2dpbiB0cmFja2luZyB2w6AgdHJpZ2dlciByZS1zY2FuIHNhdSBzeW5jIHN0YXR1cyBjaGFuZ2UiKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBoYW5kbGUgbXF0dCBjb25maWcgdXBkYXRlOiB7ZX0iKQogICAgCiAgICBkZWYgaGFuZGxlX21xdHRfYWNjb3VudF91cGRhdGUoc2VsZik6CiAgICAgICAgIiIiWOG7rSBsw70gY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB04burIE1RVFQiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBuaOG6rW4gYWNjb3VudCB1cGRhdGUgdOG7qyBNUVRUIikKICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBmb3JjZSByZWZyZXNoCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgaGFuZGxlIG1xdHQgYWNjb3VudCB1cGRhdGU6IHtlfSIpCiAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9mb3JjZV9zdGFydF9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIljhu60gbMO9IHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IHNlc3Npb24gdOG7qyBNUVRUIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2Ugbmjhuq1uIGZvcmNlIHN0YXJ0IHNlc3Npb24gdOG7qyBNUVRUIikKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGNvdW50ZXIKICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgaGFuZGxlIG1xdHQgZm9yY2Ugc3RhcnQgc2Vzc2lvbjoge2V9IikKICAgIAogICAgZGVmIHNodXRkb3duKHNlbGYpOgogICAgICAgICIiIlNodXRkb3duIE1haW5TZXJ2aWNlIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiU2h1dGRvd24gTWFpblNlcnZpY2UuLi4iKQogICAgICAgICAgICBzZWxmLnN0b3AoKQogICAgICAgICAgICBzZWxmLl9jbGVhbnVwX29uX2V4aXQoKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHNodXRkb3duIE1haW5TZXJ2aWNlOiB7ZX0iKQogICAgCiAgICAjIFRow6ptIGPDoWMgbWV0aG9kIGtow6FjIMSR4buDIHTGsMahbmcgdGjDrWNoIHbhu5tpIEpvYlNlcnZpY2UKICAgIGRlZiByZXNldF9jdXJyZW50X3Byb3h5X2lwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiUmVzZXQgSVAgcHJveHkgaGnhu4duIHThuqFpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ3Jlc2V0X2N1cnJlbnRfcHJveHlfaXAnKToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UucmVzZXRfY3VycmVudF9wcm94eV9pcCgpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IHByb3h5IElQOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9wcm94eV9zdGF0dXMoc2VsZikgLT4gc3RyOgogICAgICAgICIiIkzhuqV5IHRy4bqhbmcgdGjDoWkgcHJveHkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5wcm94eV9zZXJ2aWNlLCAnZ2V0X3Byb3h5X3N0YXR1cycpOgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5nZXRfcHJveHlfc3RhdHVzKCkKICAgICAgICAgICAgcmV0dXJuICJVbmtub3duIgogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGdldCBwcm94eSBzdGF0dXM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiRXJyb3IiCiAgICAKICAgIGRlZiBnZXRfcHJveHlfaW5mbyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiJM4bqleSB0aMO0bmcgdGluIHByb3h5IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ2dldF9wcm94eV9pbmZvJyk6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9pbmZvKCkKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHByb3h5IGluZm86IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgCiAgICBkZWYgX3Jlc2Nhbl9kZXZpY2VfYWNjb3VudHNfYXN5bmMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyBt4buZdCBjw6FjaCBhc3luYyDEkeG7gyBraMO0bmcgYmxvY2sgbWFpbiB0aHJlYWQKICAgICAgICAiIiIKICAgICAgICBkZWYgX3Jlc2Nhbl93b3JrZXIoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflI0gQuG6r3QgxJHhuqd1IHJlLXNjYW4gYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4suLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlLXNjYW4gY2hvIHThu6tuZyBhcHAgxJHGsOG7o2MgZW5hYmxlCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TsSBSZS1zY2FuIGFjY291bnRzIHThu6sge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIHN5bmNfYWNjb3VudHNfdG9fZGIgdOG7qyBCYXNlSm9iIHRoYXkgdsOsIHThu7EgaW1wbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUge2FwcF9uYW1lfTogxJDDoyBzeW5jIHtsZW4oZGV2aWNlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5OxIHthcHBfbmFtZX06IEtow7RuZyB0w6xtIHRo4bqleSBhY2NvdW50IG7DoG8gdOG7qyB0aGnhur90IGLhu4sgaG/hurdjIGzhu5dpIHN5bmMiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZS1zY2FuIGFjY291bnRzIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi8J+OryBIb8OgbiB0aMOgbmggcmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX3Jlc2Nhbl93b3JrZXI6IHtlfSIpCiAgICAgICAgCiAgICAgICAgIyBDaOG6oXkgdHJvbmcgdGhyZWFkIHJpw6puZyDEkeG7gyBraMO0bmcgYmxvY2sgbWFpbiBsb29wCiAgICAgICAgcmVzY2FuX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PV9yZXNjYW5fd29ya2VyLCBkYWVtb249VHJ1ZSkKICAgICAgICByZXNjYW5fdGhyZWFkLnN0YXJ0KCkKICAgICAgICBsb2dnZXIuaW5mbygi8J+agCDEkMOjIGto4bufaSDEkeG7mW5nIHJlLXNjYW4gdGhyZWFkIikKICAgIAogICAgZGVmIHJlc2V0X2V4cGlyZWRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgY8OhYyB0w6BpIGtob+G6o24gZXhwaXJlZCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIGFjY291bnRzIGV4cGlyZWQgdsOgIHJlc2V0IG7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hbGxfYWNjb3VudHMoKQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfZXhwaXJlZCIpOgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budIGNoxrBhICh2w60gZOG7pSAxIGdp4budKQogICAgICAgICAgICAgICAgICAgIGV4cGlyZWRfdGltZSA9IGFjY291bnQuZ2V0KCJleHBpcmVkX3RpbWUiLCAwKQogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdGltZSAtIGV4cGlyZWRfdGltZSA+IDM2MDA6ICAjIDEgZ2nhu50KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBleHBpcmVkIGFjY291bnQ6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfZXhwaXJlZCI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4cGlyZWRfdGltZSI6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaGFzX2Vycm9yIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBleHBpcmVkIGFjY291bnRzOiB7ZX0iKQogICAgCiAgICBkZWYgcmVzZXRfbG9nb3V0X2FjY291bnRzKHNlbGYpOgogICAgICAgICIiIlJlc2V0IGPDoWMgdMOgaSBraG/huqNuIGxvZ291dCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2luIGPhu6dhIGPDoWMgYWNjb3VudCBu4bq/dSBj4bqnbgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FsbF9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfbG9naW4iKSBhbmQgYWNjb3VudC5nZXQoImlzX2FjdGl2ZSIpOgogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRo4buDIHRow6ptIGxvZ2ljIMSR4buDIHRo4butIGxvZ2luIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgbG9nb3V0IGFjY291bnRzOiB7ZX0iKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIGpvYiBjaG8gYXBwIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjaGVjayBhY2NvdW50IGNhbiBydW4gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHdvcmsoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgTWFpbiB3b3JrIGxvb3AgduG7m2kgbG9naWMgY2h1eeG7g24gYWNjb3VudCB0aMO0bmcgbWluaAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBi4bqvdCDEkeG6p3UgaG/huqF0IMSR4buZbmcgduG7m2kgbG9naWMgc2Vzc2lvbiBtYW5hZ2VtZW50IikKICAgICAgICAKICAgICAgICBjdXJyZW50X2FjY291bnQgPSBOb25lCiAgICAgICAgd29ya19zdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGFjY291bnQgxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnQgb3Igc2VsZi5fc2hvdWxkX3N3aXRjaF9hY2NvdW50KGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikpOgogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXQgbmdo4buJIG5nxqFpIGNobyBhY2NvdW50IGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIExvZyBsw70gZG8gY2h1eeG7g24KICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oY3VycmVudF9hY2NvdW50LmdldCgiaWQiKSkKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoX3JlYXNvbiA9IHNlbGYuX2dldF9zd2l0Y2hfcmVhc29uKGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIiksIHNlc3Npb24pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gdOG7qyBhY2NvdW50IHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0uIEzDvSBkbzoge3N3aXRjaF9yZWFzb259IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuX2dldF9uZXh0X2F2YWlsYWJsZV9hY2NvdW50KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyBhY2NvdW50IGto4bqjIGThu6VuZywgY2jhu50gNjBzLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgIkNo4budIGFjY291bnQga2jhuqMgZOG7pW5nLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDYwKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBjaG8gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBjdXJyZW50X2FjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBzZXNzaW9uIG3hu5tpIHbhu5tpIGFjY291bnQge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgYWNjb3VudCBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoY3VycmVudF9hY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gZOG7q25nIChu4bq/dSBj4bqnbikKICAgICAgICAgICAgICAgIHdvcmtfZHVyYXRpb24gPSB0aW1lLnRpbWUoKSAtIHdvcmtfc3RhcnRfdGltZQogICAgICAgICAgICAgICAgaWYgd29ya19kdXJhdGlvbiA+IDg2NDAwOiAgIyAyNCBnaeG7nQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGzDoG0gdmnhu4djIDI0IGdp4budLCBuZ2jhu4kgbmfGoWkuLi4iKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiB0w61uIGhp4buHdSBk4burbmcgdOG7qyBuZ8aw4budaSBkw7luZyIpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyB3b3JrIGxvb3A6IHtlfSIpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMzApICAjIE5naOG7iSAzMHMga2hpIGPDsyBs4buXaQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBr4bq/dCB0aMO6YyBob+G6oXQgxJHhu5luZyIpCg==').decode('utf-8'))
