import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIERFRkFVTFRfTUFYX0ZPTExPV19EQVkgPSAyMAogICAgREVGQVVMVF9NQVhfRk9MTE9XX1NFU1NJT04gPSA1CiAgICBNQVhfV0FSTklOR19MT0dTID0gMjAKICAgIAogICAgIyBTdGF0dXMgbWVzc2FnZXMKICAgIE1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUiA9ICJU4bqhbSBk4burbmcgKFNldmVyIHnDqnUgY+G6p3UpIgogICAgTVNHX0RFVklDRV9OT19BQ0NPVU5UUyA9ICJU4bqhbSBuZ2jhu4kgKEtow7RuZyBjw7MgdMOgaSBraG/huqNuKSIKICAgIE1TR19XQUlUSU5HX1BST1hZID0gIsSQYW5nIGNo4budIHByb3h5IgogICAgTVNHX1dPUktJTkdfU0VTU0lPTiA9ICLEkGFuZyB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiCiAgICBNU0dfU0VTU0lPTl9DT09MRE9XTiA9ICJOZ2jhu4kgbmfGoWkgZ2nhu69hIGPDoWMgcGhpw6puIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX1NFU1NJT05fTElNSVQgPSAixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIKICAgIFJFQVNPTl9GT0xMT1dfREFJTFlfTElNSVQgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xvdyB0cm9uZyBwaGnDqm4iCiAgICBSRUFTT05fRk9MTE9XX1NFU1NJT05fTElNSVQgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xsb3cgdHJvbmcgcGhpw6puIgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLmpvYl9oYW5kbGVycyA9IHt9CiAgICAgICAgCiAgICAgICAgIyBGbGFnIMSRaeG7gXUga2hp4buDbgogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgVGjDtG5nIHRpbiB24buBIGPDoWMgYXBwIMSRxrDhu6NjIGvDrWNoIGhv4bqhdCAtIGzhuqV5IHThu6sgZGF0YWJhc2UgaG/hurdjIGNvbmZpZwogICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBMb2NrIMSR4buDIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpCiAgICAgICAgc2VsZi5fbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICAKICAgICAgICAjIERpY3Rpb25hcnkgxJHhu4MgbMawdSBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBqb2IgZm9sbG93IHRy4bqjIHbhu4Egc3RhdHVzIDQgKHBlbmRpbmcpCiAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMgPSB7fQogICAgICAgIAogICAgICAgICMgVHLhuqFuZyB0aMOhaSBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfaWQgPSBOb25lCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBOb25lCiAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gdGjhuqV0IGLhuqFpIGtoaSBzZXR1cCBwcm94eQogICAgICAgIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA9IDAKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMga2hpIGZvcmNlX3N0b3AgxJHGsOG7o2MgxJHhurd0IHRow6BuaCBUcnVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGNoZWNrX2ludGVydmFsID0gSm9iU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMICAjIEtp4buDbSB0cmEgbeG7l2kgMC41IGdpw6J5CiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyB5w6p1IGPhuqd1IGThu6tuZwogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmfhu6cgbeG7mXQga2hv4bqjbmcgbmfhuq9uCiAgICAgICAgICAgIHNsZWVwX3RpbWUgPSBtaW4oY2hlY2tfaW50ZXJ2YWwsIHNlY29uZHMgLSAodGltZS50aW1lKCkgLSBzdGFydF90aW1lKSkKICAgICAgICAgICAgaWYgc2xlZXBfdGltZSA+IDA6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHNsZWVwX3RpbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBpbml0aWFsaXplKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSB04bqhbyB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICAgICAgIyAxLiBLaeG7g20gdHJhIEhlbHBlclNlcnZpY2UKICAgICAgICBoZWxwZXJfc3VjY2VzcywgaGVscGVyX2RhdGEgPSB1dGlscy5jaGVja19oZWxwZXJfc2VydmljZShzZWxmLmhlbHBlcikKICAgICAgICBpZiBub3QgaGVscGVyX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGvhur90IG7hu5FpIMSR4bq/biBIZWxwZXJTZXJ2aWNlLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBMxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIG7hur91IGPDswogICAgICAgIGlmIGhlbHBlcl9kYXRhIGFuZCAiZGF0YSIgaW4gaGVscGVyX2RhdGE6CiAgICAgICAgICAgIHNlbGYuZGIuc2F2ZV9kZXZpY2VfaW5mbyhoZWxwZXJfZGF0YSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4s6IHtoZWxwZXJfZGF0YVsnZGF0YSddLmdldCgnZGV2aWNlX21vZGVsJywgJ1Vua25vd24nKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgIyAzLiBMxrB1IGPDoWMgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIG7hur91IGNoxrBhIGPDswogICAgICAgIHNlbGYuX3NhdmVfZGVmYXVsdF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgIyA0LiBLaeG7g20gdHJhIHbDoCBs4bqleSBHb0xpa2UgaGVhZGVycyBu4bq/dSBj4bqnbgogICAgICAgIGdvbGlrZV9zdWNjZXNzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KCkKICAgICAgICBpZiBub3QgZ29saWtlX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIDUuIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5faW5pdF9qb2JfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgNi4gS2jhu59pIHThuqFvIG5nw6B5IGN14buRaSBjw7luZyDEkcOjIHJlc2V0IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgICMgTuG6v3UgaGnhu4duIHThuqFpIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5LCDEkcOhbmggZOG6pXUgxJHDoyByZXNldAogICAgICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE7hur91IGNoxrBhIMSR4bq/biBnaeG7nSByZXNldCwgxJHDoW5oIGThuqV1IGzDoCDEkcOjIHJlc2V0IG5nw6B5IGjDtG0gcXVhCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheSAtIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIGxhc3RfcmVzZXRfZGF0ZS5pc29mb3JtYXQoKSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gbmfDoHkgcmVzZXQ6IHtsYXN0X3Jlc2V0X2RhdGV9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgIAogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBKb2JTZXJ2aWNlIHRow6BuaCBjw7RuZy4iKQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24ga2nhu4NtIHRyYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaSwgRmFsc2UgbuG6v3Uga2jDtG5nIGPhuqduCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB04burIGRhdGFiYXNlCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIHN5bmNfc3RhdHVzID0gc2VsZi5kYi5nZXQoc3luY19zdGF0dXNfa2V5LCBGYWxzZSkgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG7k25nIGLhu5kgdGjDrCBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWkKICAgICAgICByZXR1cm4gbm90IHN5bmNfc3RhdHVzCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIHN0YXR1czogYm9vbCA9IFRydWUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIHN0YXR1czogVHJ1ZSBu4bq/dSDEkcOjIMSR4buTbmcgYuG7mSwgRmFsc2UgbuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgIiIiCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgc2VsZi5kYi5zZXQoc3luY19zdGF0dXNfa2V5LCBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfToge3N0YXR1c30iKQogICAgICAgIAogICAgZGVmIF9zeW5jX2FjY291bnRzX2Zvcl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8gbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gxJHhu5NuZyBi4buZCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CgogICAgICAgICAgICAjIDEuIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gTWFwIHTDoGkga2hv4bqjbiBHb0xpa2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBnb2xpa2VfYWNjb3VudHMgPSBoYW5kbGVyLmdldF9nb2xpa2VfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IHtsZW4oZ29saWtlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgw4FuaCB44bqhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgbWFwcGVkX2FjY291bnRzID0gaGFuZGxlci5tYXBfZ29saWtlX2FjY291bnRzKGdvbGlrZV9hY2NvdW50cywgZGV2aWNlX2FjY291bnRzKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mgw6FuaCB44bqhIHtsZW4obWFwcGVkX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0gduG7m2kgR29MaWtlIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBHb0xpa2UgbsOgbyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSwgVHJ1ZSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBGYWxzZSkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3NhdmVfZGVmYXVsdF9jb25maWdzKHNlbGYpOgogICAgICAgICIiIkzGsHUgY8OhYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgbuG6v3UgY2jGsGEgY8OzIiIiCiAgICAgICAgZGVmYXVsdF9jb25maWdzID0gewogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHRo4budaSBnaWFuIGzDoG0gam9iCiAgICAgICAgICAgICJqb2JfaG91ciI6IGNvbmZpZy5KT0JfSE9VUiwKICAgICAgICAgICAgImpvYl9jb29sZG93bl9taW51dGVzIjogY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUywKICAgICAgICAgICAgImpvYl9jaGVja19pbnRlcnZhbCI6IGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwsCiAgICAgICAgICAgICJjb29sZG93bl9nZXRfam9iX2dvbGlrZSI6IDMwLCAgIyBUaOG7nWkgZ2lhbiBjaOG7nSAocGjDunQpIGtoaSBraMO0bmcgdMOsbSB0aOG6pXkgam9iIEdvTGlrZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBsacOqbiBxdWFuIMSR4bq/biBz4buRIGzGsOG7o25nIGpvYgogICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZLAogICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaGnhur90IGzhuq1wIGNobyBwaMOpcCBjaMSDbSBzw7NjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAiY2FyZV9pbl93b3JraW5nX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBnacOhIHThu5FpIHRoaeG7g3UgY2hvIGpvYiBmb2xsb3cKICAgICAgICAgICAgIm1pbl9mb2xsb3dfcHJpY2UiOiAyMCwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggcHJveHkKICAgICAgICAgICAgInVzZV9wcm94eSI6IEZhbHNlLCAgIyBDw7Mgc+G7rSBk4bulbmcgcHJveHkga2jDtG5nCiAgICAgICAgICAgICJwcm94eV9yZXF1ZXN0X3RpbWUiOiAwLCAgIyBUaOG7nWkgZ2lhbiBn4butaSB5w6p1IGPhuqd1IHByb3h5IGN14buRaSBjw7luZyAodGltZXN0YW1wKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZ3MuaXRlbXMoKToKICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBpZiBzZWxmLmRiLmdldChrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldChrZXksIHZhbHVlKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoyBsxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtrZXl9PXt2YWx1ZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ+G6pXUgaMOsbmgge2tleX0gxJHDoyB04buTbiB04bqhaToge3NlbGYuZGIuZ2V0KGtleSl9IikKICAgICAgICAKICAgIGRlZiBfaW5pdF9qb2JfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIiIiIKICAgICAgICAjIGluaXQgdGjDrCBz4bq9IGluaXQgaGFuZGxlcnMgY2hvIHThuqV0IGPhuqMgY8OhYyBhcHAsIGzDoG0gYXBwIG7DoG8gdGjDrCBz4bq9IHRoZW8gY+G6pXUgaMOsbmggbOG6pXkgdOG7qyBkYXRhYmFzZQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBjb25maWcuRU5BQkxFRF9BUFBTOgogICAgICAgICAgICBpZiBhcHBfbmFtZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFRpa3Rva0pvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gImluc3RhZ3JhbSI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBJbnN0YWdyYW1Kb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGto4bufaSB04bqhbyB7bGVuKHNlbGYuam9iX2hhbmRsZXJzKX0gam9iIGhhbmRsZXI6IHsnLCAnLmpvaW4oc2VsZi5qb2JfaGFuZGxlcnMua2V5cygpKX0iKQogICAgICAgIAogICAgZGVmIF9yZXNldF9kYWlseV9jb3VudGVycyhzZWxmKToKICAgICAgICAiIiJSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSB2w6BvIGdp4budIMSRxrDhu6NjIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICAKICAgICAgICAjIEzhuqV5IGdp4budIHJlc2V0IHThu6sgY+G6pXUgaMOsbmggaG/hurdjIHThu6sgZGF0YWJhc2UgbuG6v3UgY8OzCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgCiAgICAgICAgIyBUw61uaCB0aOG7nWkgxJFp4buDbSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heQogICAgICAgIHJlc2V0X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5jb21iaW5lKHRvZGF5LCBkYXRldGltZS50aW1lKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wKSkKICAgICAgICAKICAgICAgICAjIEzhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZyB04burIGRhdGFiYXNlCiAgICAgICAgbGFzdF9yZXNldF9kYXRlX3N0ciA9IHNlbGYuZGIuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICBpZiBsYXN0X3Jlc2V0X2RhdGVfc3RyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBkYXRldGltZS5kYXRlLmZyb21pc29mb3JtYXQobGFzdF9yZXNldF9kYXRlX3N0cikKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLEkOG7i25oIGThuqFuZyBuZ8OgeSByZXNldCBraMO0bmcgaOG7o3AgbOG7hzoge2xhc3RfcmVzZXRfZGF0ZV9zdHJ9IikKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5IGNoxrBhIHbDoCBjaMawYSByZXNldCB0cm9uZyBuZ8OgeSBow7RtIG5heQogICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lIGFuZCAobGFzdF9yZXNldF9kYXRlIGlzIE5vbmUgb3IgbGFzdF9yZXNldF9kYXRlIDwgdG9kYXkpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gcmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgKGdp4budIHJlc2V0OiB7am9iX2hvdXJ9OjAwKSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgYuG7mSDEkeG6v20gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHPhu5Egam9iIGjDtG0gbmF5IHbDoCBz4buRIGpvYiB0cm9uZyBwaGnDqm4KICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF92aWV3X3N0b3JpZXMiOiAwCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB2w6wgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSwKICAgICAgICAgICAgICAgICAgICAjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIHRow6BuaCBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgic3RhdHVzIikgPT0gImluYWN0aXZlIiBhbmQgYWNjb3VudC5nZXQoImluYWN0aXZlX3JlYXNvbiIpID09ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgYWN0aXZlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBN4bufIGtow7NhIGZvbGxvdyBu4bq/dSBi4buLIGtow7NhIGRvIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIG5nw6B5CiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImRpc2FibGVfZm9sbG93IiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19kaXNhYmxlX3VudGlsIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIjogIiIKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIG3hu58ga2jDs2EgZm9sbG93IGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgcmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIHbDoG8ge25vdy5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbmfDoHkgxJHDoyByZXNldCB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsYXN0X3Jlc2V0X2RhdGUiLCB0b2RheS5pc29mb3JtYXQoKSkKICAgICAgICAKICAgIGRlZiBfY2FuX3J1bl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHRo4buDIGNo4bqheSBqb2IgY2hvIHTDoGkga2hv4bqjbiBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0aOG7gyBjaOG6oXkgam9iLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyAxLiBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuCiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2Jhc2ljX2FjY291bnRfc3RhdHVzKGFjY291bnQpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyAyLiBLaeG7g20gdHJhIMSRaeG7gXUga2nhu4duIGPhuqduIHRoaeG6v3QKICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfYWNjb3VudF9wcmVyZXF1aXNpdGVzKGFjY291bnQpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyAzLiDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcAogICAgICAgIGFjY291bnQgPSBzZWxmLl9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyA0LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkKICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KGFjY291bnQpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgbmfDoHkiKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoYWNjb3VudFsiaWQiXSwgIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiKQogICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgNS4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHBoacOqbgogICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfYXRfc2Vzc2lvbl9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGzDoG0gxJHhu6cgam9iIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPSLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2Jhc2ljX2FjY291bnRfc3RhdHVzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIktp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24gY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gYuG7iyBkaXNhYmxlZCwga2jDtG5nIGNobyBjaOG6oXkgam9iCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImRpc2FibGVkIjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIGluYWN0aXZlLCBraeG7g20gdHJhIHRo4budaSBnaWFuIGNvb2xkb3duCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2hhbmRsZV9pbmFjdGl2ZV9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2hhbmRsZV9pbmFjdGl2ZV9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIljhu60gbMO9IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSIiIgogICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNvb2xkb3duLCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IHRpbWUudGltZSgpOgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHbhu4EgYWN0aXZlCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0geyJzdGF0dXMiOiAiYWN0aXZlIiwgImxhc3RfY2FyZV90aW1lIjogMH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIGNo4bupYSAidW5mb2xsb3ciIHRow6wgbeG7nyBraMOzYSBmb2xsb3cKICAgICAgICAgICAgaW5hY3RpdmVfZm9sbG93X3JlYXNvbiA9IGFjY291bnQuZ2V0KCJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIiwgIiIpCiAgICAgICAgICAgIGlmICJ1bmZvbGxvdyIgbm90IGluIGluYWN0aXZlX2ZvbGxvd19yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhLnVwZGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgImZvbGxvd19kaXNhYmxlX3VudGlsIjogMCwKICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIENoxrBhIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIGNvb2xkb3duX3JlbWFpbiA9IGludCgoam9iX2Rpc2FibGVfdW50aWwgLSB0aW1lLnRpbWUoKSkgLyA2MCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBjaOG7nSAoY8OybiB7Y29vbGRvd25fcmVtYWlufSBwaMO6dCkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIGPDoWMgxJFp4buBdSBraeG7h24gdGnDqm4gcXV54bq/dCBj4bunYSB0w6BpIGtob+G6o24iIiIKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHGsOG7o2MgYuG6rXQgam9iIGtow7RuZwogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2MgbGnDqm4ga+G6v3QgduG7m2kgR29MaWtlIGNoxrBhCiAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIGPhu6dhIHTDoGkga2hv4bqjbiDEkcaw4bujYyB0aGnhur90IGzhuq1wIHbhu5tpIGdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdAogICAgICAgICIiIgogICAgICAgIHVwZGF0ZV9kYXRhID0ge30KICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRoaeG6v3QgbOG6rXAgbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICBpZiBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSA8PSAwOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsibWF4X2pvYnNfcGVyX3Nlc3Npb24iXSA9IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRoaeG6v3QgbOG6rXAgam9iX21heF9kYXkKICAgICAgICBpZiBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSA8PSAwOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiam9iX21heF9kYXkiXSA9IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gZGF0YWJhc2UgbuG6v3UgY8OzIHRoYXkgxJHhu5VpCiAgICAgICAgaWYgdXBkYXRlX2RhdGE6CiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfZm9yX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB0xrDGoW5nIOG7qW5nIHbhu5tpIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gY29uZmlnLkFQUF9QQUNLQUdFUzoKICAgICAgICAgICAgc2VsZi5oZWxwZXIuY2xvc2VfYXBwKGNvbmZpZy5BUFBfUEFDS0FHRVNbYXBwX25hbWVdKQogICAgICAgICAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuCiAgICAgICAgIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9iX21heF9kYXkgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgIHJldHVybiBqb2JfdG9kYXkgPj0gam9iX21heF9kYXkKICAgICAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9hdF9zZXNzaW9uX2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgcGhpw6puIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuCiAgICAgICAgIiIiCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgcmV0dXJuIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wgPSBUcnVlLCBqb2JfdHlwZTogc3RyID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIHN1Y2Nlc3M6IFRydWUgbuG6v3Ugam9iIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iIChmb2xsb3csIGxpa2UsIGV0Yy4pCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gam9iIGPGoSBi4bqjbgogICAgICAgIHNlbGYuX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoYWNjb3VudCwgc3VjY2VzcykKICAgICAgICAKICAgICAgICAjIFJlc2V0IHPhu5EgbOG6p24gdGjhu60gam9iIHRo4bqldCBi4bqhaSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZ2nhu5tpIGjhuqFuIHBoacOqbgogICAgICAgIHNlbGYuX2NoZWNrX3Nlc3Npb25fbGltaXRfYWZ0ZXJfam9iKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB44butIGzDvSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkKICAgICAgICBzZWxmLl9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2IoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IHRo4buRbmcga8OqIHJpw6puZyBjaG8gam9iIGZvbGxvdwogICAgICAgIGlmIHN1Y2Nlc3MgYW5kIGpvYl90eXBlIGFuZCBqb2JfdHlwZS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICBzZWxmLl91cGRhdGVfZm9sbG93X3N0YXRzKGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfYmFzaWNfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iIGPGoSBi4bqjbiIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAKICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgImxhc3Rfam9iX3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiam9iX3RvZGF5Ijogam9iX3RvZGF5ICsgMSwKICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogam9ic19kb25lX2luX3Nlc3Npb24gKyAxLAogICAgICAgICAgICAidG90YWxfam9icyI6IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkgKyAxCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGlmIG5vdCBzdWNjZXNzOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiZmFpbGVkX2pvYnMiXSA9IGFjY291bnQuZ2V0KCJmYWlsZWRfam9icyIsIDApICsgMQogICAgICAgICAgICAKICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKSAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgZGF0YQogICAgICAgIAogICAgZGVmIF9jaGVja19zZXNzaW9uX2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gcGhpw6puIHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIHttYXhfam9ic19wZXJfc2Vzc2lvbn0gam9iIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPSLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5IHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5ICh7am9iX3RvZGF5fS97am9iX21heF9kYXl9KSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2ZvbGxvd19zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIHJpw6puZyBjaG8gZm9sbG93IGpvYiIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBmb2xsb3dfdG9kYXkgPSBhY2NvdW50LmdldCgiZm9sbG93X3RvZGF5IiwgMCkgKyAxCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKSArIDEKICAgICAgICBtYXhfZm9sbG93X2RheSA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X2RheSIsIDIwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHPhu5EgbGnhu4d1IGZvbGxvdwogICAgICAgIHVwZGF0ZV9mb2xsb3cgPSB7CiAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiBmb2xsb3dfdG9kYXksCiAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGZvbGxvd19pbl9zZXNzaW9uLAogICAgICAgICAgICAibGFzdF9mb2xsb3dfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICB9CiAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZm9sbG93KQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIG5nw6B5CiAgICAgICAgaWYgZm9sbG93X3RvZGF5ID49IG1heF9mb2xsb3dfZGF5OgogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvd191bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBuZ8OgeSAoe2ZvbGxvd190b2RheX0ve21heF9mb2xsb3dfZGF5fSkiKQogICAgICAgICMgS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbgogICAgICAgIGVsaWYgZm9sbG93X2luX3Nlc3Npb24gPj0gbWF4X2ZvbGxvd19zZXNzaW9uOgogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvdyhhY2NvdW50WyJpZCJdLCByZWFzb249IsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgZm9sbG93IHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBwaGnDqm4gKHtmb2xsb3dfaW5fc2Vzc2lvbn0ve21heF9mb2xsb3dfc2Vzc2lvbn0pIikKICAgICAgICAKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIHRyb25nIHRocmVhZCByacOqbmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkOiBUaHJlYWQgxJFhbmcgY2jhuqF5IEpvYlNlcnZpY2UgaG/hurdjIE5vbmUgbuG6v3UgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IHRy4bqhbmcgdGjDoWkgcnVubmluZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHRocmVhZAogICAgICAgICAgICB0aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLnJ1bikKICAgICAgICAgICAgdGhyZWFkLmRhZW1vbiA9IFRydWUKICAgICAgICAgICAgdGhyZWFkLnN0YXJ0KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0aHJlYWQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgcmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJpbmFjdGl2ZSIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGluYWN0aXZlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgeyJzdGF0dXMiOiAiYWN0aXZlIn0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IChJRDoge2FjY291bnRbJ2lkJ119KSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCDEkcOjIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChqb2JfZGlzYWJsZV91bnRpbCAtIGN1cnJlbnRfdGltZSkgLyA2MCkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGPDsm4ge3JlbWFpbmluZ19taW51dGVzfSBwaMO6dCDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBraMOzYSBGT0xMT1cKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpIG9yIFtdCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiZGlzYWJsZV9mb2xsb3ciKToKICAgICAgICAgICAgICAgICAgICAgICAgdW50aWxfdHMgPSBhY2NvdW50LmdldCgiZm9sbG93X2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB1bnRpbF90cyA8PSBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsiZGlzYWJsZV9mb2xsb3ciOiBGYWxzZSwgImZvbGxvd19kaXNhYmxlX3VudGlsIjogMCwgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiAiIiwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgbeG7nyBraMOzYSBGT0xMT1cgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1haW5pbmcgPSBpbnQoKHVudGlsX3RzIC0gY3VycmVudF90aW1lKSAvIDYwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGPDsm4ge3JlbWFpbmluZ30gcGjDunQga2jDs2EgRk9MTE9XIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgdMOgaSBraG/huqNuIGluYWN0aXZlIikKICAgIAogICAgZGVmIGlzX2FjY291bnRfY2FuX3J1bl9qb2Ioc2VsZiwgYXBwX25hbWU6c3RyICkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGNo4bqheSBqb2Iga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgIGlmKHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhuqF5IEpvYlNlcnZpY2UgdHJvbmcgbeG7mXQgdsOybmcgbOG6t3AgduG7m2kgbG9naWMgbMOgbSB2aeG7h2MgdGhlbyBwaGnDqm4KICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuIEtow7RuZyB0aOG7gyBjaOG6oXkuIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgY2jhuqF5IEpvYlNlcnZpY2UgduG7m2kgbG9naWMgbMOgbSB2aeG7h2MgdGhlbyBwaGnDqm4uLi4iKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBkZXZpY2VfaWQKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyB4w6FjIMSR4buLbmggZGV2aWNlX2lkIGhp4buHbiB04bqhaSwgSm9iU2VydmljZSBraMO0bmcgdGjhu4MgY2jhuqF5IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgIHdoaWxlIHNlbGYucnVubmluZzoKICAgICAgICAgICAgIyBSZXNldCBiaeG6v24gZm9yY2Vfc3RvcCBu4bq/dSBjw7MKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICBpZiBzZWxmLmRiLmdldCgicGF1c2Vfam9iIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPDsyB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciwgdOG6oW0gZOG7q25nIHjhu60gbMO9IGpvYiIpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSKQogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKGpvYl9jaGVja19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IG7hur91IGPhuqduCiAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgc2VsZi5yZXNldF9pbmFjdGl2ZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kgZ2nhu69hIGPDoWMgcGhpw6puIGtow7RuZwogICAgICAgICAgICAgICAgaWYgc2VsZi5faXNfaW5fc2Vzc2lvbl9jb29sZG93bigpOgogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBpbnQodGltZS50aW1lKCkpKSAvIDYwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYie0pvYlNlcnZpY2VDb25zdGFudHMuTVNHX1NFU1NJT05fQ09PTERPV059IChjw7JuIHtyZW1haW5pbmdfbWludXRlc30gcGjDunQpIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDYwKTogICMgS2nhu4NtIHRyYSBt4buXaSBwaMO6dAogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHByb3h5CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoKToKICAgICAgICAgICAgICAgICAgICAjIEPhuqduIHByb3h5IG5oxrBuZyBjaMawYSBjw7MsIGNo4budIDMwIGdpw6J5IHLhu5NpIGtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPhuqduIHByb3h5IG5oxrBuZyBjaMawYSBjw7MsIGNo4budIDMwIGdpw6J5IHLhu5NpIGtp4buDbSB0cmEgbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB0csaw4bubYyBraGkga2nhu4NtIHRyYSB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVycyBhbmQgc2VsZi5fY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudHNfZm9yX2FwcChhcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2Mga2jDtG5nIChzYXUga2hpIMSRw6MgxJHhu5NuZyBi4buZKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2hhc19hY2NvdW50c19yZWFkeV9mb3Jfd29yaygpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBwcm94eSBu4bq/dSBj4bqnbgogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5OgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9zZXR1cF9wcm94eV9mb3Jfc2Vzc2lvbigpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB0aGnhur90IGzhuq1wIHByb3h5LCBi4buPIHF1YSBwaGnDqm4gbsOgeSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNjApOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIga2hpIHNldHVwIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NldHVwX2ZhaWxfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQuG6r3QgxJHhuqd1IHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5fd29ya19zZXNzaW9uKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IHbDoCBi4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVsZWFzZV9wcm94eV9hZnRlcl9zZXNzaW9uKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXJ0X3Nlc3Npb25fY29vbGRvd24oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCIpCiAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJKb2JTZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgICAgICAgICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgSm9iU2VydmljZSIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgZGVmIGZvcmNlX3N0b3BfYWxsKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZyIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiLEkMOzbmcgZOG7i2NoIHbhu6UsIGThu6tuZyB04bqldCBj4bqjIHdvcmtlciB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGThu6tuZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdp4bqjaSBwaMOzbmcgcHJveHkgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV9pZDoKICAgICAgICAgICAgICAgIHNlbGYuX3JlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSDEkeG7gyB0csOhbmggbOG7l2kgdGhyZWFkCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2RiJykgYW5kIHNlbGYuZGI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBzaHV0ZG93biBKb2JTZXJ2aWNlIikKICAgIAogICAgZGVmIF9jaGVja19wcm94eV9yZXF1aXJlbWVudChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBwcm94eSDEkeG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyBwcm94eSBob+G6t2Mga2jDtG5nIGPhuqduIHByb3h5LCBGYWxzZSBu4bq/dSBj4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgY8OzCiAgICAgICAgIiIiCiAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgIAogICAgICAgIGlmIG5vdCB1c2VfcHJveHk6CiAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBj4bqnbiBwcm94eQogICAgICAgICAgICAKICAgICAgICAjIEPhuqduIHByb3h5LCBraeG7g20gdHJhIHhlbSBjw7MgcHJveHkgY29uZmlnIGtow7RuZwogICAgICAgIHByb3h5X2NvbmZpZyA9IHNlbGYuZGIuZ2V0KCJwcm94eV9jb25maWciKQogICAgICAgIAogICAgICAgIGlmIG5vdCBwcm94eV9jb25maWc6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBn4butaSB5w6p1IGPhuqd1IHByb3h5IGNoxrBhIHbDoCB0aOG7nWkgZ2lhbiBn4butaSBjdeG7kWkgY8O5bmcKICAgICAgICAgICAgcHJveHlfcmVxdWVzdF90aW1lID0gc2VsZi5kYi5nZXQoInByb3h5X3JlcXVlc3RfdGltZSIsIDApCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGNoxrBhIGfhu61pIGhv4bq3YyDEkcOjIHF1w6EgMTAgcGjDunQgKDYwMCBnacOieSkgdOG7qyBs4bqnbiBn4butaSBjdeG7kWkKICAgICAgICAgICAgaWYgcHJveHlfcmVxdWVzdF90aW1lID09IDAgb3IgKGN1cnJlbnRfdGltZSAtIHByb3h5X3JlcXVlc3RfdGltZSkgPiA2MDA6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ+G6p24gcHJveHkgxJHhu4MgbMOgbSB2aeG7h2MgbmjGsG5nIGNoxrBhIGPDsyBwcm94eSBjb25maWcsIGfhu61pIHnDqnUgY+G6p3UgcHJveHkiKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfV0FJVElOR19QUk9YWSkKICAgICAgICAgICAgICAgICMgR+G7rWkgTVFUVCB0aMO0bmcgYsOhbyDEkWFuZyBjaOG7nSBwcm94eQogICAgICAgICAgICAgICAgc2VsZi5fc2VuZF9tcXR0X3Byb3h5X3JlcXVlc3QoKQogICAgICAgICAgICAgICAgIyBMxrB1IHRo4budaSBnaWFuIGfhu61pIHJlcXVlc3QKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJwcm94eV9yZXF1ZXN0X3RpbWUiLCBjdXJyZW50X3RpbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQw6MgZ+G7rWkgecOqdSBj4bqndSBwcm94eSwgxJFhbmcgY2jhu50gc2VydmVyIHBo4bqjbiBo4buTaSIpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19XQUlUSU5HX1BST1hZKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9zZW5kX21xdHRfcHJveHlfcmVxdWVzdChzZWxmKToKICAgICAgICAiIiJH4butaSBNUVRUIHnDqnUgY+G6p3UgcHJveHkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIG1xdHRfc2VydmljZSBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5tcXR0X3NlcnZpY2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAicmVxdWVzdF9wcm94eSIsCiAgICAgICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc2VsZi5tcXR0X3NlcnZpY2UuX3NhZmVfcHVibGlzaChjb25maWcuTVFUVF9UT1BJQ19TRVJWRVJfUFJPWFksIGpzb24uZHVtcHMobWVzc2FnZSkpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBn4butaSB5w6p1IGPhuqd1IHByb3h5IHF1YSBNUVRUIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGfhu61pIHnDqnUgY+G6p3UgcHJveHkgcXVhIE1RVFQ6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9nZXRfcHJveHlfZGlzcGxheV9uYW1lKHNlbGYsIHByb3h5X2NvbmZpZzogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0w6puIGhp4buDbiB0aOG7iyBjaG8gcHJveHkgdOG7qyBjb25maWcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcm94eV9jb25maWc6IEPhuqV1IGjDrG5oIHByb3h5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVMOqbiBoaeG7g24gdGjhu4sgY+G7p2EgcHJveHkgKG5hbWUgaG/hurdjIGlkQGhvc3Q6cG9ydCkKICAgICAgICAiIiIKICAgICAgICBpZiBub3QgcHJveHlfY29uZmlnOgogICAgICAgICAgICByZXR1cm4gIlVua25vd24iCiAgICAgICAgICAgIAogICAgICAgICMgxq91IHRpw6puIHPhu60gZOG7pW5nIG5hbWUgbuG6v3UgY8OzLCBu4bq/dSBraMO0bmcgdGjDrCBkw7luZyBpZEBob3N0OnBvcnQKICAgICAgICBwcm94eV9uYW1lID0gcHJveHlfY29uZmlnLmdldCgibmFtZSIpCiAgICAgICAgaWYgcHJveHlfbmFtZToKICAgICAgICAgICAgcmV0dXJuIHByb3h5X25hbWUKICAgICAgICAgICAgCiAgICAgICAgcHJveHlfaWQgPSBwcm94eV9jb25maWcuZ2V0KCJpZCIsICJ1bmtub3duIikKICAgICAgICBob3N0ID0gcHJveHlfY29uZmlnLmdldCgiaG9zdCIsICIiKQogICAgICAgIHBvcnQgPSBwcm94eV9jb25maWcuZ2V0KCJwb3J0IiwgIiIpCiAgICAgICAgCiAgICAgICAgaWYgaG9zdCBhbmQgcG9ydDoKICAgICAgICAgICAgcmV0dXJuIGYie3Byb3h5X2lkfUB7aG9zdH06e3BvcnR9IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBwcm94eV9pZAogICAgICAgICAgICAKICAgIGRlZiBfc2V0dXBfcHJveHlfZm9yX3Nlc3Npb24oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaGnhur90IGzhuq1wIHByb3h5IGNobyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRoaeG6v3QgbOG6rXAgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBwcm94eV9jb25maWcgPSBzZWxmLmRiLmdldCgicHJveHlfY29uZmlnIikKICAgICAgICAKICAgICAgICBpZiBub3QgcHJveHlfY29uZmlnOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzGsHUgSUQgdsOgIHTDqm4gcHJveHkgaGnhu4duIHThuqFpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9pZCA9IHByb3h5X2NvbmZpZy5nZXQoInByb3h5X2lkIikKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBzZWxmLl9nZXRfcHJveHlfZGlzcGxheV9uYW1lKHByb3h5X2NvbmZpZykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBwcm94eSB0aMO0bmcgcXVhIGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5oZWxwZXIsICdzZXR1cF9wcm94eScpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyB0aGnhur90IGzhuq1wIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0iKQogICAgICAgICAgICAgICAgc2V0dXBfcmVzdWx0ID0gc2VsZi5oZWxwZXIuc2V0dXBfcHJveHkocHJveHlfY29uZmlnKQogICAgICAgICAgICAgICAgaWYgbm90IHNldHVwX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgdGhp4bq/dCBs4bqtcCBwcm94eSB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTEg25nIGNvdW50ZXIgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlByb3h5IHNldHVwIHRo4bqldCBi4bqhaSBs4bqnbiB7c2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50fS8zIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHRo4bqldCBi4bqhaSAzIGzhuqduIGxpw6puIHRp4bq/cCwgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaQogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA+PSAzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIlByb3h5IHNldHVwIHRo4bqldCBi4bqhaSAzIGzhuqduIGxpw6puIHRp4bq/cCwgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFyX3Byb3h5X2FuZF9yZXF1ZXN0X25ldygpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiSGVscGVyIHNlcnZpY2Uga2jDtG5nIGjhu5cgdHLhu6Mgc2V0dXAgcHJveHkiKQogICAgICAgICAgICAgICAgIyBUxINuZyBjb3VudGVyIHRo4bqldCBi4bqhaQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSB0aOG6pXQgYuG6oWkgMyBs4bqnbiBsacOqbiB0aeG6v3AsIHjDs2EgcHJveHkgdsOgIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kKICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA+PSAzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiSGVscGVyIHNlcnZpY2Uga2jDtG5nIGjhu5cgdHLhu6MgcHJveHkgMyBs4bqnbiBsacOqbiB0aeG6v3AsIHjDs2EgcHJveHkgdsOgIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFyX3Byb3h5X2FuZF9yZXF1ZXN0X25ldygpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0aGnhur90IGzhuq1wIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0gY2hvIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aGnhur90IGzhuq1wIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSBvciAndW5rbm93bid9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMSDbmcgY291bnRlciB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgc2VsZi5wcm94eV9zZXR1cF9mYWlsX2NvdW50ICs9IDEKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJQcm94eSBzZXR1cCBs4buXaSBleGNlcHRpb24gbOG6p24ge3NlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudH0vMyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IHRo4bqldCBi4bqhaSAzIGzhuqduIGxpw6puIHRp4bq/cCwgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaQogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3NldHVwX2ZhaWxfY291bnQgPj0gMzoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiUHJveHkgc2V0dXAgbOG7l2kgZXhjZXB0aW9uIDMgbOG6p24gbGnDqm4gdGnhur9wLCB4w7NhIHByb3h5IHbDoCB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFyX3Byb3h5X2FuZF9yZXF1ZXN0X25ldygpCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NldHVwX2ZhaWxfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF9jbGVhcl9wcm94eV9hbmRfcmVxdWVzdF9uZXcoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgWMOzYSBwcm94eSBoaeG7h24gdOG6oWkgdsOgIHnDqnUgY+G6p3Ugc2VydmVyIGPhuqVwIHByb3h5IG3hu5tpIGtoaSBzZXR1cCB0aOG6pXQgYuG6oWkgMyBs4bqnbiBsacOqbiB0aeG6v3AKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJYw7NhIHByb3h5IGhp4buHbiB04bqhaSB2w6AgecOqdSBj4bqndSBzZXJ2ZXIgY+G6pXAgcHJveHkgbeG7m2kiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBwcm94eSBjb25maWcgdHLGsOG7m2Mga2hpIHjDs2EgxJHhu4MgY8OzIHRo4buDIHVucmVnaXN0ZXIKICAgICAgICAgICAgcHJveHlfY29uZmlnID0gc2VsZi5kYi5nZXQoInByb3h5X2NvbmZpZyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIEFQSSB1bnJlZ2lzdGVyIHByb3h5IG7hur91IGPDsyBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X2lkIGFuZCBoYXNhdHRyKHNlbGYuaGVscGVyLCAndW5yZWdpc3Rlcl9wcm94eScpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgdW5yZWdpc3RlciBwcm94eSB0aOG6pXQgYuG6oWkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgdW5yZWdpc3Rlcl9yZXN1bHQgPSBzZWxmLmhlbHBlci51bnJlZ2lzdGVyX3Byb3h5KHByb3h5X2NvbmZpZykKICAgICAgICAgICAgICAgICAgICBpZiB1bnJlZ2lzdGVyX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHVucmVnaXN0ZXIgcHJveHkgdGjhuqV0IGLhuqFpIHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlVucmVnaXN0ZXIgcHJveHkgdGjhuqV0IGLhuqFpIHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0gdGjhuqV0IGLhuqFpIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB1bnJlZ2lzdGVyIHByb3h5IHRo4bqldCBi4bqhaSB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHByb3h5IGNvbmZpZyBoaeG7h24gdOG6oWkKICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X2NvbmZpZyIsIE5vbmUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHRo4budaSBnaWFuIHnDqnUgY+G6p3UgcHJveHkgxJHhu4MgY8OzIHRo4buDIHnDqnUgY+G6p3UgcHJveHkgbeG7m2kKICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X3JlcXVlc3RfdGltZSIsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIHRow7RuZyBiw6FvIHJlbGVhc2UgcHJveHkgaGnhu4duIHThuqFpIChu4bq/dSBjw7MpCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV9pZCBhbmQgc2VsZi5tcXR0X3NlcnZpY2UgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB7CiAgICAgICAgICAgICAgICAgICAgInR5cGUiOiAicmVsZWFzZV9wcm94eV9mYWlsZWQiLAogICAgICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAgICAgInByb3h5X2lkIjogc2VsZi5jdXJyZW50X3Byb3h5X2lkLAogICAgICAgICAgICAgICAgICAgICJyZWFzb24iOiAiU2V0dXAgZmFpbGVkIDMgdGltZXMiLAogICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzZWxmLm1xdHRfc2VydmljZS5fc2FmZV9wdWJsaXNoKGNvbmZpZy5NUVRUX1RPUElDX1NFUlZFUl9QUk9YWSwganNvbi5kdW1wcyhtZXNzYWdlKSkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0aMO0bmcgYsOhbyByZWxlYXNlIHByb3h5IHRo4bqldCBi4bqhaToge3NlbGYuY3VycmVudF9wcm94eV9uYW1lIG9yIHNlbGYuY3VycmVudF9wcm94eV9pZH0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2lkID0gTm9uZQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsICJQcm94eSBs4buXaSwgxJHDoyB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIHjDs2EgcHJveHkgY8WpIHbDoCBz4bq1biBzw6BuZyB5w6p1IGPhuqd1IHByb3h5IG3hu5tpIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgeMOzYSBwcm94eSB2w6AgecOqdSBj4bqndSBwcm94eSBt4bubaSIpCiAgICAgICAgICAgIAogICAgZGVmIF9yZWxlYXNlX3Byb3h5X2FmdGVyX3Nlc3Npb24oc2VsZik6CiAgICAgICAgIiIiR2nhuqNpIHBow7NuZyBwcm94eSBzYXUga2hpIGvhur90IHRow7pjIHBoacOqbiBsw6BtIHZp4buHYyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X2lkOgogICAgICAgICAgICAgICAgIyBM4bqleSBwcm94eSBjb25maWcgdHLGsOG7m2Mga2hpIHjDs2EKICAgICAgICAgICAgICAgIHByb3h5X2NvbmZpZyA9IHNlbGYuZGIuZ2V0KCJwcm94eV9jb25maWciKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu41pIEFQSSB1bnJlZ2lzdGVyIHByb3h5IHRow7RuZyBxdWEgaGVscGVyIHNlcnZpY2UKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5oZWxwZXIsICd1bnJlZ2lzdGVyX3Byb3h5Jyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIHVucmVnaXN0ZXIgcHJveHkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHVucmVnaXN0ZXJfcmVzdWx0ID0gc2VsZi5oZWxwZXIudW5yZWdpc3Rlcl9wcm94eShwcm94eV9jb25maWcpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVucmVnaXN0ZXJfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHVucmVnaXN0ZXIgcHJveHkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lfSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJVbnJlZ2lzdGVyIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZX0gdGjhuqV0IGLhuqFpIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHVucmVnaXN0ZXIgcHJveHkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkhlbHBlciBzZXJ2aWNlIGtow7RuZyBo4buXIHRy4bujIHVucmVnaXN0ZXIgcHJveHkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFjDs2EgcHJveHkgY29uZmlnIHbDoCByZXNldCB0aOG7nWkgZ2lhbiB5w6p1IGPhuqd1CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfY29uZmlnIiwgTm9uZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJwcm94eV9yZXF1ZXN0X3RpbWUiLCAwKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu61pIE1RVFQgdGjDtG5nIGLDoW8ga2jDtG5nIGTDuW5nIHByb3h5IG7DoHkgbuG7r2EKICAgICAgICAgICAgICAgIGlmIHNlbGYubXF0dF9zZXJ2aWNlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogInJlbGVhc2VfcHJveHkiLAogICAgICAgICAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgICAgICAgICAicHJveHlfaWQiOiBzZWxmLmN1cnJlbnRfcHJveHlfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHNlbGYubXF0dF9zZXJ2aWNlLl9zYWZlX3B1Ymxpc2goY29uZmlnLk1RVFRfVE9QSUNfU0VSVkVSX1BST1hZLCBqc29uLmR1bXBzKG1lc3NhZ2UpKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0aMO0bmcgYsOhbyBnaeG6o2kgcGjDs25nIHByb3h5IHtzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSBvciBzZWxmLmN1cnJlbnRfcHJveHlfaWR9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9pZCA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9uYW1lID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGdp4bqjaSBwaMOzbmcgcHJveHkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lIG9yIHNlbGYuY3VycmVudF9wcm94eV9pZCBvciAndW5rbm93bid9IikKICAgICAgICAgICAgCiAgICBkZWYgX2hhc19hY2NvdW50c19yZWFkeV9mb3Jfd29yayhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgaWYgc2VsZi5pc19hY2NvdW50X2Nhbl9ydW5fam9iKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfd29ya19zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIlRo4buxYyBoaeG7h24gbeG7mXQgcGhpw6puIGzDoG0gdmnhu4djIGhvw6BuIGNo4buJbmgiIiIKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgCiAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgdHJvbmcgcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgVHJ1ZSkKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19XT1JLSU5HX1NFU1NJT04pCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgdHXhuqduIHThu7EgdOG7q25nIGFwcAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gbuG6v3Ugc2VydmVyIHnDqnUgY+G6p3UgKGPDsyB0aOG7gyBjw7MgdMOgaSBraG/huqNuIG3hu5tpIHThu6sgR29MaWtlKQogICAgICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTZXJ2ZXIgecOqdSBj4bqndSDEkeG7k25nIGLhu5kgbOG6oWkgdMOgaSBraG/huqNuIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRzX2Zvcl9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIGFwcCBuw6B5CiAgICAgICAgICAgICAgICBzZWxmLl93b3JrX3dpdGhfYXBwKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw7NuZyBhcHAgc2F1IGtoaSBob8OgbiB0aMOgbmgKICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGhhbmRsZXIuY2xvc2VfYXBwKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuq9uIGdp4buvYSBjw6FjIGFwcAogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg1KToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kgdHJvbmcgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBr4bq/dCB0aMO6YyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgIAogICAgZGVmIF93b3JrX3dpdGhfYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIEzDoG0gdmnhu4djIHbhu5tpIG3hu5l0IGFwcCBj4bulIHRo4buDCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwIGPhuqduIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbMOgbSB2aeG7h2MgduG7m2kge2FwcF9uYW1lfSIpCiAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgIAogICAgICAgICMgTOG7jWMgY8OhYyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICAgICAKICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgIyBMw6BtIHZp4buHYyB0deG6p24gdOG7sSB24bubaSB04burbmcgdMOgaSBraG/huqNuCiAgICAgICAgZm9yIGFjY291bnQgaW4gd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gxJHhu6cgc+G7kSBqb2IgdHJvbmcgcGhpw6puIGNobyB0w6BpIGtob+G6o24gbsOgeQogICAgICAgICAgICBzZWxmLl93b3JrX2FjY291bnRfc2Vzc2lvbihhY2NvdW50LCBoYW5kbGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMw6BtIGNoxINtIHPDs2Mgc2F1IGtoaSBo4bq/dCBqb2IKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gY2jEg20gc8OzYyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBjaMSDbSBzw7NjIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfToge2V9IikKICAgICAgICAgICAgICAgIAogICAgZGVmIF93b3JrX2FjY291bnRfc2Vzc2lvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlcik6CiAgICAgICAgIiIiCiAgICAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgdMOgaSBraG/huqNuIHRyb25nIHBoacOqbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgam9ic19kb25lID0gMAogICAgICAgIGNhcmVfY291bnRlciA9IDAKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCBt4bulYyB0acOqdToge21heF9qb2JzX3Blcl9zZXNzaW9ufSBqb2IiKQogICAgICAgIAogICAgICAgIHdoaWxlIGpvYnNfZG9uZSA8IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldAogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGNo4bqheSBqb2Iga2jDtG5nCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0ga2jDtG5nIHRo4buDIGNo4bqheSBqb2IgbuG7r2EiKQogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGpvYgogICAgICAgICAgICAgICAgam9iID0gaGFuZGxlci5mZXRjaF9qb2IoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7Mgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSwgYuG7jyBxdWEgcGhpw6puIG7DoHkiKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZQogICAgICAgICAgICAgICAgbGluayA9IGpvYi5nZXQoJ2xpbmsnLCAnJykKICAgICAgICAgICAgICAgIGlmIGxpbmsuc3RhcnRzd2l0aCgnaHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS8nKToKICAgICAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycsICcnKQogICAgICAgICAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgICAgICAgICAgbGluayA9IGxpbmsucmVwbGFjZSgnaHR0cHM6Ly93d3cudGlrdG9rLmNvbS8nLCAnJykKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7dXNlcm5hbWV9XVt7am9iLmdldCgndHlwZScpfV1be2xpbmt9XSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVmFsaWRhdGUgam9iCiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uX3Jlc3VsdCA9IGhhbmRsZXIudmFsaWRhdGVfam9iX2JlZm9yZV9leGVjdXRpb24oYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJ2YWxpZCIsIFRydWUpOgogICAgICAgICAgICAgICAgICAgIGlmIHZhbGlkYXRpb25fcmVzdWx0LmdldCgic2hvdWxkX3NraXAiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgU2tpcCBqb2IKICAgICAgICAgICAgICAgICAgICAgICAgc2tpcF9tZXNzYWdlID0gdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIkpvYiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU2tpcCBqb2I6IHtza2lwX21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHNraXBfbWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNraXAgam9iIGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBHacOjbiB0aOG7nWkgZ2lhbiBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIGzhuqV5L2jhu6d5IGpvYiBsacOqbiB04bulYwogICAgICAgICAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOZ2jhu4kge3NraXBfc2xlZXBfdGltZX1zIHNhdSBraGkgc2tpcCBqb2IgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSm9iIGtow7RuZyBo4bujcCBs4buHOiB7dmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGVfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSBr4bq/dCBxdeG6owogICAgICAgICAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgICAgICAgICBqb2Jfc3VjY2VzcyA9IGpvYl9yZXN1bHRbInN1Y2Nlc3MiXQogICAgICAgICAgICAgICAgam9iX21lc3NhZ2UgPSBqb2JfcmVzdWx0WyJtZXNzYWdlIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZwogICAgICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSA0IGFuZCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAgICAgY250ID0gc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMuZ2V0KGFjY291bnRbImlkIl0sIDApICsgMQogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgICAgICAgICAgaWYgY250ID49IDU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCBmb2xsb3cgcGVuZGluZywga2jDs2EgRk9MTE9XIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3dfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAiTGnDqm4gdGnhur9wIGzhu5dpIGZvbGxvdyBwZW5kaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbGlmIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsOhbyBjw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCBqb2JfcmVzdWx0KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqgogICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2pvYl9zdGF0cyhhY2NvdW50LCBqb2Jfc3VjY2Vzcywgam9iLmdldCgidHlwZSIsICIiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJL4bq/dCBxdeG6oyBqb2Ige2pvYnNfZG9uZSArIDF9L3ttYXhfam9ic19wZXJfc2Vzc2lvbn06IHtqb2JfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBqb2Jfc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICBqb2JzX2RvbmUgKz0gMQogICAgICAgICAgICAgICAgICAgIGNhcmVfY291bnRlciArPSAxCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDaMSDbSBzw7NjIHNhdSBt4buXaSAzLTUgam9iIChyYW5kb20pCiAgICAgICAgICAgICAgICAgICAgaWYgY2FyZV9jb3VudGVyID49IHJhbmRvbS5yYW5kaW50KDMsIDUpOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICJwZXJmb3JtX2NhcmUiKSBhbmQgY2FsbGFibGUoaGFuZGxlci5wZXJmb3JtX2NhcmUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBjaMSDbSBzw7NjIG5o4bq5IGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5wZXJmb3JtX2NhcmUoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXJlX2NvdW50ZXIgPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2Mgbmjhurk6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyBqb2IKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnJhbmRpbnQoMiwgNSkpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIHBoacOqbiBsw6BtIHZp4buHYyBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtqb2JzX2RvbmV9L3ttYXhfam9ic19wZXJfc2Vzc2lvbn0gam9iIikKICAgICAgICAKICAgIGRlZiBfc3RhcnRfc2Vzc2lvbl9jb29sZG93bihzZWxmKToKICAgICAgICAiIiJC4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiIiIgogICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmRiLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCA2MCkKICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSBpbnQodGltZS50aW1lKCkpICsgKGNvb2xkb3duX21pbnV0ZXMgKiA2MCkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IGdp4buvYSBjw6FjIHBoacOqbiIpCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJ7Sm9iU2VydmljZUNvbnN0YW50cy5NU0dfU0VTU0lPTl9DT09MRE9XTn0gKHtjb29sZG93bl9taW51dGVzfSBwaMO6dCkiKQogICAgICAgIAogICAgZGVmIF9pc19pbl9zZXNzaW9uX2Nvb2xkb3duKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIG5naOG7iSBnaeG7r2EgY8OhYyBwaGnDqm4ga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kKICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPD0gMDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICBpZiBjdXJyZW50X3RpbWUgPCBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWU6CiAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBjdXJyZW50X3RpbWUpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPDsm4ge3JlbWFpbmluZ19taW51dGVzfSBwaMO6dCBuZ2jhu4kgbmfGoWkiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IDAKICAgICAgICAgICAgcmV0dXJuIEZhbHNl').decode('utf-8'))
