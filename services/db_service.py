import base64
exec(base64.b64decode('aW1wb3J0IHNxbGl0ZTMKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHV1aWQKaW1wb3J0IHV0aWxzCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsLCBVbmlvbgppbXBvcnQgY29uZmlnCgojIFThuqFvIGxvZ2dlciBjaG8gRGF0YWJhc2VTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkRhdGFiYXNlU2VydmljZSIpCgpjbGFzcyBEYXRhYmFzZVNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfcGF0aDogc3RyID0gImRhdGEuZGIiLCBkZWZhdWx0X2NvbmZpZ19wYXRoOiBzdHIgPSAiZGVmYXVsdENvbmZpZy5qc29uIik6CiAgICAgICAgc2VsZi5kYl9wYXRoID0gZGJfcGF0aAogICAgICAgIHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCA9IGRlZmF1bHRfY29uZmlnX3BhdGgKICAgICAgICBzZWxmLmxvY2FsID0gdGhyZWFkaW5nLmxvY2FsKCkgICMgTMawdSB0cuG7ryByacOqbmcgY2hvIG3hu5dpIHRocmVhZAogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIG7hur91IGNoxrBhIHThu5NuIHThuqFpCiAgICAgICAgc2VsZi5faW5pdF9kYigpCiAgICAgICAgCiAgICBkZWYgX2dldF9jb25uZWN0aW9uKHNlbGYpOgogICAgICAgICIiIkzhuqV5IGvhur90IG7hu5FpIFNRTGl0ZSBjaG8gdGhyZWFkIGhp4buHbiB04bqhaSIiIgogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYubG9jYWwsICdjb25uJykgb3Igc2VsZi5sb2NhbC5jb25uIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYubG9jYWwuY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLmRiX3BhdGgpCiAgICAgICAgcmV0dXJuIHNlbGYubG9jYWwuY29ubgogICAgICAgIAogICAgZGVmIF9pbml0X2RiKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBj4bqldSB0csO6YyBkYXRhYmFzZSBu4bq/dSBjaMawYSB04buTbiB04bqhaSIiIgogICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qoc2VsZi5kYl9wYXRoKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICAjIFThuqFvIGLhuqNuZyBjb25maWcKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnJycKICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBjb25maWcgKAogICAgICAgICAgICBrZXkgVEVYVCBQUklNQVJZIEtFWSwKICAgICAgICAgICAgdmFsdWUgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgYWNjb3VudCB24bubaSB1dWlkCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJycnCiAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgYWNjb3VudHMgKAogICAgICAgICAgICBpZCBJTlRFR0VSIFBSSU1BUlkgS0VZLAogICAgICAgICAgICBhY2NvdW50X3V1aWQgVEVYVCBVTklRVUUsCiAgICAgICAgICAgIGFwcCBURVhULAogICAgICAgICAgICBuaWNrbmFtZSBURVhULAogICAgICAgICAgICB1bmlxdWVfaWQgVEVYVCwKICAgICAgICAgICAgdW5pcXVlX3VzZXJuYW1lIFRFWFQsCiAgICAgICAgICAgIHN0YXR1cyBURVhULAogICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb24gVEVYVCwKICAgICAgICAgICAgaXNfbG9naW4gSU5URUdFUiwKICAgICAgICAgICAgYXZhdGFyX3RodW1iIFRFWFQsCiAgICAgICAgICAgIHRvdGFsX2pvYnMgSU5URUdFUiwKICAgICAgICAgICAgam9iX2VuYWJsZSBJTlRFR0VSLAogICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCBJTlRFR0VSLAogICAgICAgICAgICBqb2JfdG9kYXkgSU5URUdFUiwKICAgICAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gSU5URUdFUiwKICAgICAgICAgICAgbGFzdF9qb2JfdGltZSBJTlRFR0VSLAogICAgICAgICAgICBsYXN0X3VwZGF0ZSBJTlRFR0VSLAogICAgICAgICAgICBjYXJlX3RvZGF5IElOVEVHRVIsCiAgICAgICAgICAgIGlzX2dvbGlrZV9saW5rZWQgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGdvbGlrZV9pZCBURVhULAogICAgICAgICAgICBkZXZpY2VfaWQgVEVYVCwKICAgICAgICAgICAgaXNfc3luYyBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZGlzYWJsZV9mb2xsb3cgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGZvbGxvd19kaXNhYmxlX3VudGlsIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBmb2xsb3dfdG9kYXkgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGZvbGxvd19pbl9zZXNzaW9uIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBtYXhfZm9sbG93X2RheSBJTlRFR0VSIERFRkFVTFQgMjAsCiAgICAgICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiBJTlRFR0VSIERFRkFVTFQgNSwKICAgICAgICAgICAgbGFzdF9mb2xsb3dfdGltZSBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgaW5hY3RpdmVfZm9sbG93X3JlYXNvbiBURVhULAogICAgICAgICAgICB1c2VyX2lkIFRFWFQsCiAgICAgICAgICAgIGRhdGEgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgam9ic19oaXN0b3J5IMSR4buDIGzGsHUgbOG7i2NoIHPhu60gam9iCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJycnCiAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgam9ic19oaXN0b3J5ICgKICAgICAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSwKICAgICAgICAgICAgam9iX3V1aWQgVEVYVCBVTklRVUUsCiAgICAgICAgICAgIGFjY291bnRfdXVpZCBURVhULAogICAgICAgICAgICBkZXZpY2VfaWQgVEVYVCwKICAgICAgICAgICAgYXBwIFRFWFQsCiAgICAgICAgICAgIGpvYl9pZCBURVhULAogICAgICAgICAgICBqb2JfdHlwZSBURVhULAogICAgICAgICAgICBvYmplY3RfaWQgVEVYVCwKICAgICAgICAgICAgbGluayBURVhULAogICAgICAgICAgICBzdGF0dXMgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIHN1Y2Nlc3MgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIHByaWNlIFJFQUwgREVGQVVMVCAwLAogICAgICAgICAgICBlcnJvcl9tZXNzYWdlIFRFWFQsCiAgICAgICAgICAgIGNyZWF0ZWRfYXQgSU5URUdFUiwKICAgICAgICAgICAgbGFzdF91cGRhdGUgSU5URUdFUiwKICAgICAgICAgICAgaXNfc3luYyBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZGF0YSBURVhUCiAgICAgICAgKQogICAgICAgICcnJykKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRow6ptIGPhu5l0IGFjY291bnRfdXVpZCBu4bq/dSBjaMawYSB04buTbiB04bqhaQogICAgICAgIGN1cnNvci5leGVjdXRlKCJQUkFHTUEgdGFibGVfaW5mbyhhY2NvdW50cykiKQogICAgICAgIGNvbHVtbnMgPSBbcm93WzFdIGZvciByb3cgaW4gY3Vyc29yLmZldGNoYWxsKCldCiAgICAgICAgaWYgImFjY291bnRfdXVpZCIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGFjY291bnRfdXVpZCBURVhUIFVOSVFVRSIpCiAgICAgICAgICAgICMgVOG6oW8gVVVJRCBjaG8gY8OhYyB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGlkIEZST00gYWNjb3VudHMiKQogICAgICAgICAgICBhY2NvdW50cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgIGFjY291bnRfdXVpZCA9IHN0cih1dWlkLnV1aWQ0KCkpCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiVVBEQVRFIGFjY291bnRzIFNFVCBhY2NvdW50X3V1aWQgPSA/IFdIRVJFIGlkID0gPyIsIChhY2NvdW50X3V1aWQsIGFjY291bnRfaWQpKQogICAgICAgICAgICBwcmludCgixJDDoyB0aMOqbSBj4buZdCBhY2NvdW50X3V1aWQgdsOgbyBi4bqjbmcgYWNjb3VudHMgdsOgIHThuqFvIFVVSUQgY2hvIGPDoWMgdMOgaSBraG/huqNuIGhp4buHbiBjw7MiKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgdGjDqm0gY+G7mXQgdXNlcl9pZCBu4bq/dSBjaMawYSB04buTbiB04bqhaQogICAgICAgIGN1cnNvci5leGVjdXRlKCJQUkFHTUEgdGFibGVfaW5mbyhhY2NvdW50cykiKQogICAgICAgIGNvbHVtbnMgPSBbcm93WzFdIGZvciByb3cgaW4gY3Vyc29yLmZldGNoYWxsKCldCiAgICAgICAgaWYgInVzZXJfaWQiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiB1c2VyX2lkIFRFWFQiKQogICAgICAgICAgICBwcmludCgixJDDoyB0aMOqbSBj4buZdCB1c2VyX2lkIHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBpc19zeW5jIG7hur91IGNoxrBhIHThu5NuIHThuqFpCiAgICAgICAgaWYgImlzX3N5bmMiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgdGjDqm0gY+G7mXQgaXNfc3luYyB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyB1bmlxdWUgaW5kZXggY2hvIChhcHAsIHVuaXF1ZV91c2VybmFtZSkgxJHhu4MgdHLDoW5oIGR1cGxpY2F0ZSBhY2NvdW50cwogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkNSRUFURSBVTklRVUUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfYWNjb3VudHNfYXBwX3VzZXJuYW1lIE9OIGFjY291bnRzKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIHThuqFvIHVuaXF1ZSBpbmRleCBjaG8gKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAjIE7hur91IGPDsyBkdXBsaWNhdGUgZGF0YSwgY+G6p24gY2xlYW51cCB0csaw4bubYwogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkPhuqNuaCBiw6FvIGtoaSB04bqhbyB1bmlxdWUgaW5kZXg6IHtlfSIpCiAgICAgICAgICAgIHNlbGYuX2NsZWFudXBfZHVwbGljYXRlX2FjY291bnRzKGN1cnNvcikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkNSRUFURSBVTklRVUUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfYWNjb3VudHNfYXBwX3VzZXJuYW1lIE9OIGFjY291bnRzKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSIpCiAgICAgICAgICAgICAgICBwcmludCgixJDDoyB04bqhbyB1bmlxdWUgaW5kZXggY2hvIChhcHAsIHVuaXF1ZV91c2VybmFtZSkgc2F1IGtoaSBjbGVhbnVwIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlMjoKICAgICAgICAgICAgICAgIHByaW50KGYiS2jDtG5nIHRo4buDIHThuqFvIHVuaXF1ZSBpbmRleDoge2UyfSIpCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBj4buZdCBkaXNhYmxlX2ZvbGxvdyBu4bq/dSBjaMawYSBjw7MKICAgICAgICBpZiAiZGlzYWJsZV9mb2xsb3ciIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBkaXNhYmxlX2ZvbGxvdyBJTlRFR0VSIERFRkFVTFQgMCIpCiAgICAgICAgICAgIHByaW50KCLEkMOjIHRow6ptIGPhu5l0IGRpc2FibGVfZm9sbG93IHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAKICAgICAgICAjIFRow6ptIGPhu5l0IGZvbGxvd19kaXNhYmxlX3VudGlsIG7hur91IGNoxrBhIGPDswogICAgICAgIGlmICJmb2xsb3dfZGlzYWJsZV91bnRpbCIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGZvbGxvd19kaXNhYmxlX3VudGlsIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgZm9sbG93X2Rpc2FibGVfdW50aWwgdsOgbyBi4bqjbmcgYWNjb3VudHMiKQogICAgICAgIAogICAgICAgICMgVGjDqm0gY8OhYyBj4buZdCBmb2xsb3cgdHJhY2tpbmcgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgZm9sbG93X2NvbHVtbnMgPSBbCiAgICAgICAgICAgICgiZm9sbG93X3RvZGF5IiwgIklOVEVHRVIgREVGQVVMVCAwIiksCiAgICAgICAgICAgICgiZm9sbG93X2luX3Nlc3Npb24iLCAiSU5URUdFUiBERUZBVUxUIDAiKSwKICAgICAgICAgICAgKCJtYXhfZm9sbG93X2RheSIsICJJTlRFR0VSIERFRkFVTFQgMjAiKSwKICAgICAgICAgICAgKCJtYXhfZm9sbG93X3Nlc3Npb24iLCAiSU5URUdFUiBERUZBVUxUIDUiKSwKICAgICAgICAgICAgKCJsYXN0X2ZvbGxvd190aW1lIiwgIklOVEVHRVIgREVGQVVMVCAwIiksCiAgICAgICAgICAgICgiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiIsICJURVhUIikKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgZm9yIGNvbF9uYW1lLCBjb2xfdHlwZSBpbiBmb2xsb3dfY29sdW1uczoKICAgICAgICAgICAgaWYgY29sX25hbWUgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShmIkFMVEVSIFRBQkxFIGFjY291bnRzIEFERCBDT0xVTU4ge2NvbF9uYW1lfSB7Y29sX3R5cGV9IikKICAgICAgICAgICAgICAgIHByaW50KGYixJDDoyB0aMOqbSBj4buZdCB7Y29sX25hbWV9IHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAKICAgICAgICAjIFRow6ptIGPDoWMgY+G7mXQgY2FyZSB0cmFja2luZyBu4bq/dSBjaMawYSBjw7MKICAgICAgICBjYXJlX2NvbHVtbnMgPSBbCiAgICAgICAgICAgICgibGFzdF9jYXJlX3RpbWUiLCAiSU5URUdFUiBERUZBVUxUIDAiKSwKICAgICAgICAgICAgKCJsYXN0X3ZpZXdfc3RvcmllcyIsICJJTlRFR0VSIERFRkFVTFQgMCIpLAogICAgICAgICAgICAoImNhcmVfZGF0YSIsICJURVhUIiksICAjIEzGsHUgSlNPTiBTbWFydCBDYXJlIGNobyB04burbmcgdMOgaSBraG/huqNuCiAgICAgICAgICAgICgibGFzdF9wb3N0X3RpbWUiLCAiSU5URUdFUiBERUZBVUxUIDAiKSAgIyBUaOG7nWkgZ2lhbiDEkcSDbmcgYsOgaSBn4bqnbiBuaOG6pXQKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgZm9yIGNvbF9uYW1lLCBjb2xfdHlwZSBpbiBjYXJlX2NvbHVtbnM6CiAgICAgICAgICAgIGlmIGNvbF9uYW1lIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoZiJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIHtjb2xfbmFtZX0ge2NvbF90eXBlfSIpCiAgICAgICAgICAgICAgICBwcmludChmIsSQw6MgdGjDqm0gY+G7mXQge2NvbF9uYW1lfSB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIAogICAgZGVmIF9jbGVhbnVwX2R1cGxpY2F0ZV9hY2NvdW50cyhzZWxmLCBjdXJzb3IpOgogICAgICAgICIiIgogICAgICAgIEThu41uIGThurlwIGPDoWMgdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBk4buxYSB0csOqbiAoYXBwLCB1bmlxdWVfdXNlcm5hbWUpCiAgICAgICAgR2nhu68gbOG6oWkgdMOgaSBraG/huqNuIGPDsyBpZCBs4bubbiBuaOG6pXQgKG3hu5tpIG5o4bqldCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSBjw6FjIG5ow7NtIGR1cGxpY2F0ZQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgIFNFTEVDVCBhcHAsIHVuaXF1ZV91c2VybmFtZSwgQ09VTlQoKikgYXMgY291bnQKICAgICAgICAgICAgICAgIEZST00gYWNjb3VudHMgCiAgICAgICAgICAgICAgICBXSEVSRSB1bmlxdWVfdXNlcm5hbWUgSVMgTk9UIE5VTEwgQU5EIHVuaXF1ZV91c2VybmFtZSAhPSAnJwogICAgICAgICAgICAgICAgR1JPVVAgQlkgYXBwLCB1bmlxdWVfdXNlcm5hbWUgCiAgICAgICAgICAgICAgICBIQVZJTkcgQ09VTlQoKikgPiAxCiAgICAgICAgICAgICIiIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGR1cGxpY2F0ZXMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBpZiBub3QgZHVwbGljYXRlczoKICAgICAgICAgICAgICAgIHByaW50KCJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBuw6BvIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYiVMOsbSB0aOG6pXkge2xlbihkdXBsaWNhdGVzKX0gbmjDs20gdMOgaSBraG/huqNuIGR1cGxpY2F0ZSwgxJFhbmcgZOG7jW4gZOG6uXAuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgdG90YWxfZGVsZXRlZCA9IDAKICAgICAgICAgICAgZm9yIGFwcCwgdXNlcm5hbWUsIGNvdW50IGluIGR1cGxpY2F0ZXM6CiAgICAgICAgICAgICAgICAjIEzhuqV5IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBj4bunYSBuaMOzbSBuw6B5CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgICAgICBTRUxFQ1QgaWQgRlJPTSBhY2NvdW50cyAKICAgICAgICAgICAgICAgICAgICBXSEVSRSBhcHAgPSA/IEFORCB1bmlxdWVfdXNlcm5hbWUgPSA/IAogICAgICAgICAgICAgICAgICAgIE9SREVSIEJZIGlkIERFU0MKICAgICAgICAgICAgICAgICIiIiwgKGFwcCwgdXNlcm5hbWUpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkcyA9IFtyb3dbMF0gZm9yIHJvdyBpbiBjdXJzb3IuZmV0Y2hhbGwoKV0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG7ryBs4bqhaSB0w6BpIGtob+G6o24gxJHhuqd1IHRpw6puIChpZCBs4bubbiBuaOG6pXQpLCB4w7NhIGPDoWMgdMOgaSBraG/huqNuIGPDsm4gbOG6oWkKICAgICAgICAgICAgICAgIGlmIGxlbihhY2NvdW50X2lkcykgPiAxOgogICAgICAgICAgICAgICAgICAgIGtlZXBfaWQgPSBhY2NvdW50X2lkc1swXSAgIyBJRCBs4bubbiBuaOG6pXQgKG3hu5tpIG5o4bqldCkKICAgICAgICAgICAgICAgICAgICBkZWxldGVfaWRzID0gYWNjb3VudF9pZHNbMTpdICAjIEPDoWMgSUQgY8OybiBs4bqhaQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvciBkZWxldGVfaWQgaW4gZGVsZXRlX2lkczoKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGFjY291bnRzIFdIRVJFIGlkID0gPyIsIChkZWxldGVfaWQsKSkKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxfZGVsZXRlZCArPSAxCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiLEkMOjIHjDs2Ege2xlbihkZWxldGVfaWRzKX0gdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBjaG8ge2FwcH06e3VzZXJuYW1lfSwgZ2nhu68gbOG6oWkgSUQge2tlZXBfaWR9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYixJDDoyBob8OgbiB0aMOgbmggZOG7jW4gZOG6uXAsIHjDs2EgdOG7lW5nIGPhu5luZyB7dG90YWxfZGVsZXRlZH0gdMOgaSBraG/huqNuIGR1cGxpY2F0ZSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgZOG7jW4gZOG6uXAgZHVwbGljYXRlIGFjY291bnRzOiB7ZX0iKQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBjb25maWcucHkKICAgICAgICBzZWxmLmluaXRfZGVmYXVsdF9jb25maWcoKQogICAgICAgIAogICAgZGVmIGxvYWRfZGVmYXVsdF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIixJDhu41jIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBmaWxlIiIiCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCwgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZChmKQogICAgICAgIHJldHVybiB7fQogICAgICAgIAogICAgZGVmIGdldChzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBBbnk6CiAgICAgICAgIiIiTOG6pXkgZ2nDoSB0cuG7iyBj4bqldSBow6xuaCB04burIERCLCBu4bq/dSBraMO0bmcgY8OzIHRow6wgbOG6pXkgdOG7qyBkZWZhdWx0IGNvbmZpZyIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgdmFsdWUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIHJlc3VsdDoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgduG7gSBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgICAgICB2YWx1ZSA9IHJlc3VsdFswXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBM4bqleSB04burIGRlZmF1bHQgY29uZmlnCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gc2VsZi5sb2FkX2RlZmF1bHRfY29uZmlnKCkKICAgICAgICAgICAgaWYga2V5IGluIGRlZmF1bHRfY29uZmlnOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRfY29uZmlnW2tleV0KICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHQKICAgIAogICAgZGVmIHNldChzZWxmLCBrZXk6IHN0ciwgdmFsdWU6IEFueSkgLT4gYm9vbDoKICAgICAgICAiIiJMxrB1IGdpw6EgdHLhu4sgY+G6pXUgaMOsbmggdsOgbyBEQiIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGThu68gbGnhu4d1IHBo4bupYyB04bqhcCB0aMOgbmggSlNPTgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChkaWN0LCBsaXN0KSk6CiAgICAgICAgICAgIHZhbHVlID0ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGNvbmZpZyAoa2V5LCB2YWx1ZSkgVkFMVUVTICg/LCA/KSIsCiAgICAgICAgICAgICAgICAoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBsxrB1IGPhuqV1IGjDrG5oOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGRlbGV0ZShzZWxmLCBrZXk6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIG3hu5l0IGPhuqV1IGjDrG5oIGto4buPaSBkYXRhYmFzZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogS2jDs2EgY+G6pXUgaMOsbmggY+G6p24geMOzYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gY29uZmlnIFdIRVJFIGtleSA9ID8iLCAoa2V5LCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgY+G6pXUgaMOsbmgge2tleX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgc2F2ZV9kZXZpY2VfaW5mbyhzZWxmLCBkZXZpY2VfaW5mbzogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KCJkZXZpY2VfaW5mbyIsIGRldmljZV9pbmZvKQogICAgCiAgICBkZWYgZ2V0X2RldmljZV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIMSRw6MgbMawdSIiIgogICAgICAgIGRldmljZV9pbmZvID0gc2VsZi5nZXQoImRldmljZV9pbmZvIiwge30pCiAgICAgICAgcmV0dXJuIGRldmljZV9pbmZvCiAgICAKICAgIGRlZiBhZGRfYWNjb3VudChzZWxmLCBhY2NvdW50X2RhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB2w6BvIGRhdGFiYXNlIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIG1vZHVsZQogICAgICAgIGltcG9ydCBjb25maWcgYXMgY29uZmlnX21vZHVsZQogICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBkZXZpY2VfaWQsIHPhu60gZOG7pW5nIGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICBkZXZpY2VfaWQgPSBhY2NvdW50X2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIAogICAgICAgICMgTOG6pXkgdXNlcl9pZCB04burIGRhdGFiYXNlIGNvbmZpZyBob+G6t2MgdOG7qyBhY2NvdW50X2RhdGEKICAgICAgICB1c2VyX2lkID0gYWNjb3VudF9kYXRhLmdldCgidXNlcl9pZCIpCiAgICAgICAgaWYgbm90IHVzZXJfaWQ6CiAgICAgICAgICAgIHVzZXJfaWQgPSBzZWxmLmdldCgidXNlcl9pZCIpICAjIEzhuqV5IHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICAgICAgCiAgICAgICAgIyBUw6FjaCBk4buvIGxp4buHdSBjaMOtbmggdsOgIGThu68gbGnhu4d1IHBo4bulCiAgICAgICAgbWFpbl9kYXRhID0gewogICAgICAgICAgICAiYXBwIjogYWNjb3VudF9kYXRhLmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICAibmlja25hbWUiOiBhY2NvdW50X2RhdGEuZ2V0KCJuaWNrbmFtZSIsICIiKSwKICAgICAgICAgICAgInVuaXF1ZV9pZCI6IGFjY291bnRfZGF0YS5nZXQoInVuaXF1ZV9pZCIsICIiKSwKICAgICAgICAgICAgInVuaXF1ZV91c2VybmFtZSI6IGFjY291bnRfZGF0YS5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKSwKICAgICAgICAgICAgInN0YXR1cyI6IGFjY291bnRfZGF0YS5nZXQoInN0YXR1cyIsICJpbmFjdGl2ZSIpLAogICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogYWNjb3VudF9kYXRhLmdldCgiaW5hY3RpdmVfcmVhc29uIiwgIiIpLAogICAgICAgICAgICAiaXNfbG9naW4iOiAxIGlmIGFjY291bnRfZGF0YS5nZXQoImlzX2xvZ2luIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgImF2YXRhcl90aHVtYiI6IGFjY291bnRfZGF0YS5nZXQoImF2YXRhcl90aHVtYiIsICIiKSwKICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBhY2NvdW50X2RhdGEuZ2V0KCJ0b3RhbF9qb2JzIiwgMCksCiAgICAgICAgICAgICJqb2JfZW5hYmxlIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JfZW5hYmxlIiwgVHJ1ZSkgZWxzZSAwLAogICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApLAogICAgICAgICAgICAiam9iX3RvZGF5IjogYWNjb3VudF9kYXRhLmdldCgiam9iX3RvZGF5IiwgMCksCiAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IGFjY291bnRfZGF0YS5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCksCiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogYWNjb3VudF9kYXRhLmdldCgibGFzdF9qb2JfdGltZSIsIDApLAogICAgICAgICAgICAibGFzdF91cGRhdGUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiY2FyZV90b2RheSI6IGFjY291bnRfZGF0YS5nZXQoImNhcmVfdG9kYXkiLCAwKSwKICAgICAgICAgICAgImlzX2dvbGlrZV9saW5rZWQiOiAxIGlmIGFjY291bnRfZGF0YS5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiZ29saWtlX2lkIjogYWNjb3VudF9kYXRhLmdldCgiZ29saWtlX2lkIiwgIiIpLAogICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAiaXNfc3luYyI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiaXNfc3luYyIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiBhY2NvdW50X2RhdGEuZ2V0KCJmb2xsb3dfZGlzYWJsZV91bnRpbCIsIDApLAogICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogYWNjb3VudF9kYXRhLmdldCgiZm9sbG93X3RvZGF5IiwgMCksCiAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGFjY291bnRfZGF0YS5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCksCiAgICAgICAgICAgICJsYXN0X2ZvbGxvd190aW1lIjogYWNjb3VudF9kYXRhLmdldCgibGFzdF9mb2xsb3dfdGltZSIsIDApLAogICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6IGFjY291bnRfZGF0YS5nZXQoImluYWN0aXZlX2ZvbGxvd19yZWFzb24iLCAiIiksCiAgICAgICAgICAgICJsYXN0X2NhcmVfdGltZSI6IGFjY291bnRfZGF0YS5nZXQoImxhc3RfY2FyZV90aW1lIiwgMCksCiAgICAgICAgICAgICJsYXN0X3ZpZXdfc3RvcmllcyI6IGFjY291bnRfZGF0YS5nZXQoImxhc3Rfdmlld19zdG9yaWVzIiwgMCksCiAgICAgICAgICAgICJ1c2VyX2lkIjogdXNlcl9pZCwgICMgVGjDqm0gdXNlcl9pZCB2w6BvIGFjY291bnQKICAgICAgICAgICAgImFjY291bnRfdXVpZCI6IGFjY291bnRfZGF0YS5nZXQoImFjY291bnRfdXVpZCIsIHN0cih1dWlkLnV1aWQ0KCkpKSwgICMgVOG6oW8gVVVJRCBu4bq/dSBjaMawYSBjw7MKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgIyBMxrB1IElEIHThu6sgZOG7ryBsaeG7h3UgxJHhuqd1IHbDoG8gbuG6v3UgY8OzCiAgICAgICAgaWYgImlkIiBpbiBhY2NvdW50X2RhdGE6CiAgICAgICAgICAgIG1haW5fZGF0YVsiaWQiXSA9IGFjY291bnRfZGF0YVsiaWQiXQogICAgICAgIAogICAgICAgICMgTMawdSBk4buvIGxp4buHdSBwaOG7pSBkxrDhu5tpIGThuqFuZyBKU09OCiAgICAgICAgZXh0cmFfZGF0YSA9IHtrOiB2IGZvciBrLCB2IGluIGFjY291bnRfZGF0YS5pdGVtcygpIGlmIGsgbm90IGluIG1haW5fZGF0YX0KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbHVtbnMgPSAiLCAiLmpvaW4obWFpbl9kYXRhLmtleXMoKSkKICAgICAgICAgICAgcGxhY2Vob2xkZXJzID0gIiwgIi5qb2luKFsiPyJdICogbGVuKG1haW5fZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICB2YWx1ZXMgPSBsaXN0KG1haW5fZGF0YS52YWx1ZXMoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdsOgbyBjdeG7kWkKICAgICAgICAgICAgY29sdW1ucyArPSAiLCBkYXRhIgogICAgICAgICAgICBwbGFjZWhvbGRlcnMgKz0gIiwgPyIKICAgICAgICAgICAgdmFsdWVzLmFwcGVuZChqc29uLmR1bXBzKGV4dHJhX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBJTlNFUlQgT1IgSUdOT1JFIMSR4buDIHRyw6FuaCBs4buXaSBkdXBsaWNhdGUsIHNhdSDEkcOzIFVQREFURSBu4bq/dSBj4bqnbgogICAgICAgICAgICBpZiAiaWQiIGluIG1haW5fZGF0YToKICAgICAgICAgICAgICAgICMgTuG6v3UgY8OzIElELCBz4butIGThu6VuZyBJTlNFUlQgT1IgUkVQTEFDRSAodXBkYXRlIGV4aXN0aW5nIHJlY29yZCkKICAgICAgICAgICAgICAgIHF1ZXJ5ID0gZiJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGFjY291bnRzICh7Y29sdW1uc30pIFZBTFVFUyAoe3BsYWNlaG9sZGVyc30pIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgY8OzIElELCBraeG7g20gdHJhIGR1cGxpY2F0ZSBi4bqxbmcgdW5pcXVlIGNvbnN0cmFpbnQKICAgICAgICAgICAgICAgIGFwcCA9IG1haW5fZGF0YS5nZXQoImFwcCIpCiAgICAgICAgICAgICAgICB1bmlxdWVfdXNlcm5hbWUgPSBtYWluX2RhdGEuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBhcHAgYW5kIHVuaXF1ZV91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIHThu5NuIHThuqFpIGNoxrBhCiAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBpZCBGUk9NIGFjY291bnRzIFdIRVJFIGFwcCA9ID8gQU5EIHVuaXF1ZV91c2VybmFtZSA9ID8iLCAoYXBwLCB1bmlxdWVfdXNlcm5hbWUpKQogICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZzoKICAgICAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSwgY+G6rXAgbmjhuq10IHRow7RuZyB0aW4KICAgICAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdfaWQgPSBleGlzdGluZ1swXQogICAgICAgICAgICAgICAgICAgICAgICAjIExv4bqhaSBi4buPIGlkIGto4buPaSBtYWluX2RhdGEgxJHhu4MgdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0ge2s6IHYgZm9yIGssIHYgaW4gbWFpbl9kYXRhLml0ZW1zKCkgaWYgayAhPSAiaWQifQogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsiZGF0YSJdID0ganNvbi5kdW1wcyhleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgc2V0X2NsYXVzZSA9ICIsICIuam9pbihbZiJ7a30gPSA/IiBmb3IgayBpbiB1cGRhdGVfZGF0YS5rZXlzKCldKQogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfcXVlcnkgPSBmIlVQREFURSBhY2NvdW50cyBTRVQge3NldF9jbGF1c2V9IFdIRVJFIGlkID0gPyIKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUodXBkYXRlX3F1ZXJ5LCBsaXN0KHVwZGF0ZV9kYXRhLnZhbHVlcygpKSArIFtleGlzdGluZ19pZF0pCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBjaMawYSB04buTbiB04bqhaSwgdGjDqm0gbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBpZCBraOG7j2kgbWFpbl9kYXRhIMSR4buDIElOU0VSVAogICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRfZGF0YSA9IHtrOiB2IGZvciBrLCB2IGluIG1haW5fZGF0YS5pdGVtcygpIGlmIGsgIT0gImlkIn0KICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0X2NvbHVtbnMgPSAiLCAiLmpvaW4oaW5zZXJ0X2RhdGEua2V5cygpKSArICIsIGRhdGEiCiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydF9wbGFjZWhvbGRlcnMgPSAiLCAiLmpvaW4oWyI/Il0gKiBsZW4oaW5zZXJ0X2RhdGEpKSArICIsID8iCiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydF92YWx1ZXMgPSBsaXN0KGluc2VydF9kYXRhLnZhbHVlcygpKSArIFtqc29uLmR1bXBzKGV4dHJhX2RhdGEpXQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgcXVlcnkgPSBmIklOU0VSVCBJTlRPIGFjY291bnRzICh7aW5zZXJ0X2NvbHVtbnN9KSBWQUxVRVMgKHtpbnNlcnRfcGxhY2Vob2xkZXJzfSkiCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCBpbnNlcnRfdmFsdWVzKQogICAgICAgICAgICAgICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgS2jDtG5nIGPDsyBhcHAgaG/hurdjIHVuaXF1ZV91c2VybmFtZSwgc+G7rSBk4bulbmcgSU5TRVJUIGLDrG5oIHRoxrDhu51uZwogICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gZiJJTlNFUlQgSU5UTyBhY2NvdW50cyAoe2NvbHVtbnN9KSBWQUxVRVMgKHtwbGFjZWhvbGRlcnN9KSIKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmICJpZCIgaW4gbWFpbl9kYXRhOgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHZhbHVlcykKICAgICAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB0aMOqbSB0w6BpIGtob+G6o246IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHVwZGF0ZV9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCwgZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBwcmludChmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gduG7m2kgSUQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZOG7ryBsaeG7h3UKICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZGF0YSkKICAgICAgICAgICAgYWNjb3VudFsibGFzdF91cGRhdGUiXSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRw6FuaCBk4bqldSBj4bqnbiBzeW5jIHRy4burIGtoaSBkYXRhIMSRw6MgY8OzIGlzX3N5bmMgxJHGsOG7o2Mgc2V0IHLDtSByw6BuZwogICAgICAgICAgICBpZiAiaXNfc3luYyIgbm90IGluIGRhdGE6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6FjaCBtYWluX2RhdGEgdsOgIGV4dHJhX2RhdGEKICAgICAgICAgICAgIyBM4bqleSB04bqldCBj4bqjIGPDoWMgY+G7mXQgY+G7p2EgYuG6o25nIGFjY291bnRzCiAgICAgICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlBSQUdNQSB0YWJsZV9pbmZvKGFjY291bnRzKSIpCiAgICAgICAgICAgIGNvbHVtbnMgPSBbcm93WzFdIGZvciByb3cgaW4gY3Vyc29yLmZldGNoYWxsKCldCiAgICAgICAgICAgIG1haW5fZGF0YSA9IHt9CiAgICAgICAgICAgIGV4dHJhX2RhdGEgPSB7fQogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBhY2NvdW50Lml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrZXkgaW4gY29sdW1uczoKICAgICAgICAgICAgICAgICAgICBtYWluX2RhdGFba2V5XSA9IHZhbHVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGFba2V5XSA9IHZhbHVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gdXBkYXRlIGNodXnDqm4gYmnhu4d0CiAgICAgICAgICAgIHJldHVybiBzZWxmLnVwZGF0ZV9hY2NvdW50X2J5X2lkKGFjY291bnRfaWQsIG1haW5fZGF0YSwgZXh0cmFfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gY+G7p2EgbeG7mXQgdMOgaSBraG/huqNuIHRoZW8gSUQiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF9pZCwpKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICBhY2NvdW50ID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgYWNjb3VudFsiaXNfbG9naW4iXSA9IGJvb2woYWNjb3VudFsiaXNfbG9naW4iXSkKICAgICAgICBhY2NvdW50WyJqb2JfZW5hYmxlIl0gPSBib29sKGFjY291bnRbImpvYl9lbmFibGUiXSkKICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBib29sKGFjY291bnRbImlzX3N5bmMiXSkKICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGZvbGxvdyB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICBpZiAiZm9sbG93X3RvZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSA9IGludChhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSkgaWYgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gZWxzZSAwCiAgICAgICAgaWYgImZvbGxvd19pbl9zZXNzaW9uIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdID0gaW50KGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0pIGlmIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gZWxzZSAwCiAgICAgICAgIyDEkMOjIGxv4bqhaSBi4buPIG1heF9mb2xsb3dfZGF5IHbDoCBtYXhfZm9sbG93X3Nlc3Npb24KICAgICAgICBpZiAibGFzdF9mb2xsb3dfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGNhcmUgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImxhc3RfY2FyZV90aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0pIGlmIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gZWxzZSAwCiAgICAgICAgaWYgImxhc3Rfdmlld19zdG9yaWVzIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdID0gaW50KGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0pIGlmIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gZWxzZSAwCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CgogICAgZGVmIHVwZGF0ZV9hY2NvdW50X2J5X2lkKHNlbGYsIGFjY291bnRfaWQsIG1haW5fZGF0YSwgZXh0cmFfZGF0YT1Ob25lKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHRoZW8gSUQiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTHXDtG4gc2V0IGlzX3N5bmMgPSBGYWxzZSBraGkgdXBkYXRlCiAgICAgICAgICAgIG1haW5fZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gY8OidSBs4buHbmggVVBEQVRFCiAgICAgICAgICAgIHVwZGF0ZV9maWVsZHMgPSBbXQogICAgICAgICAgICB2YWx1ZXMgPSBbXQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gbWFpbl9kYXRhLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrZXkgIT0gImlkIjogICMgS2jDtG5nIHVwZGF0ZSBJRAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9maWVsZHMuYXBwZW5kKGYie2tleX0gPSA/IikKICAgICAgICAgICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKHZhbHVlKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZXh0cmFfZGF0YToKICAgICAgICAgICAgICAgIHVwZGF0ZV9maWVsZHMuYXBwZW5kKCJkYXRhID0gPyIpCiAgICAgICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKGpzb24uZHVtcHMoZXh0cmFfZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKGFjY291bnRfaWQpICAjIFdIRVJFIGlkID0gPwogICAgICAgICAgICAKICAgICAgICAgICAgcXVlcnkgPSBmIlVQREFURSBhY2NvdW50cyBTRVQgeycsICcuam9pbih1cGRhdGVfZmllbGRzKX0gV0hFUkUgaWQgPSA/IgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgdmFsdWVzKQogICAgICAgICAgICAKICAgICAgICAgICAgcm93c19hZmZlY3RlZCA9IGN1cnNvci5yb3djb3VudAogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByb3dzX2FmZmVjdGVkID4gMDoKICAgICAgICAgICAgICAgIHByaW50KGYiQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiBJRCB7YWNjb3VudF9pZH0gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludChmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gduG7m2kgSUQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldF9hY2NvdW50X2J5X3VuaXF1ZV91c2VybmFtZShzZWxmLCBhcHA6IHN0ciwgdW5pcXVlX3VzZXJuYW1lOiBzdHIpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiB0aGVvIGFwcCB2w6AgdW5pcXVlX3VzZXJuYW1lCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwOiBUw6puIOG7qW5nIGThu6VuZwogICAgICAgICAgICB1bmlxdWVfdXNlcm5hbWU6IFVzZXJuYW1lIGR1eSBuaOG6pXQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgY2jhu6lhIHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhv4bq3YyBOb25lIG7hur91IGtow7RuZyB0w6xtIHRo4bqleQogICAgICAgICIiIgogICAgICAgIGlmIG5vdCB1bmlxdWVfdXNlcm5hbWU6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgKiBGUk9NIGFjY291bnRzIFdIRVJFIGFwcCA9ID8gQU5EIHVuaXF1ZV91c2VybmFtZSA9ID8iLCAoYXBwLCB1bmlxdWVfdXNlcm5hbWUpKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICBhY2NvdW50ID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgYWNjb3VudFsiaXNfbG9naW4iXSA9IGJvb2woYWNjb3VudFsiaXNfbG9naW4iXSkKICAgICAgICBhY2NvdW50WyJqb2JfZW5hYmxlIl0gPSBib29sKGFjY291bnRbImpvYl9lbmFibGUiXSkKICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBib29sKGFjY291bnRbImlzX3N5bmMiXSkKICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGZvbGxvdyB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICBpZiAiZm9sbG93X3RvZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSA9IGludChhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSkgaWYgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gZWxzZSAwCiAgICAgICAgaWYgImZvbGxvd19pbl9zZXNzaW9uIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdID0gaW50KGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0pIGlmIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gZWxzZSAwCiAgICAgICAgIyDEkMOjIGxv4bqhaSBi4buPIG1heF9mb2xsb3dfZGF5IHbDoCBtYXhfZm9sbG93X3Nlc3Npb24KICAgICAgICBpZiAibGFzdF9mb2xsb3dfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGNhcmUgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImxhc3RfY2FyZV90aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0pIGlmIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gZWxzZSAwCiAgICAgICAgaWYgImxhc3Rfdmlld19zdG9yaWVzIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdID0gaW50KGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0pIGlmIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gZWxzZSAwCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9ieV91dWlkKHNlbGYsIGFjY291bnRfdXVpZDogc3RyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgdGjDtG5nIHRpbiBj4bunYSBt4buZdCB0w6BpIGtob+G6o24gdGhlbyBVVUlEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgYWNjb3VudF91dWlkID0gPyIsIChhY2NvdW50X3V1aWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSA9IGJvb2woYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSkKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBmb2xsb3cgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImZvbGxvd190b2RheSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gPSBpbnQoYWNjb3VudFsiZm9sbG93X3RvZGF5Il0pIGlmIGFjY291bnRbImZvbGxvd190b2RheSJdIGVsc2UgMAogICAgICAgIGlmICJmb2xsb3dfaW5fc2Vzc2lvbiIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSA9IGludChhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdIGVsc2UgMAogICAgICAgICMgxJDDoyBsb+G6oWkgYuG7jyBtYXhfZm9sbG93X2RheSB2w6AgbWF4X2ZvbGxvd19zZXNzaW9uCiAgICAgICAgaWYgImxhc3RfZm9sbG93X3RpbWUiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0pIGlmIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSBlbHNlIDAKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBjYXJlIHRow6BuaCBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgIGlmICJsYXN0X2NhcmVfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdKSBpZiBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdIGVsc2UgMAogICAgICAgIGlmICJsYXN0X3ZpZXdfc3RvcmllcyIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSA9IGludChhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdKSBpZiBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbImRhdGEiXSkKICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgCiAgICBkZWYgZ2V0X2FjY291bnRzKHNlbGYsIGFwcDogc3RyID0gTm9uZSwgc3RhdHVzOiBzdHIgPSBOb25lLCBqb2JfZW5hYmxlOiBib29sID0gTm9uZSwgZGV2aWNlX2lkOiBBbnkgPSBUcnVlKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiJM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiB0aGVvIMSRaeG7gXUga2nhu4duIGzhu41jCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwOiBUw6puIOG7qW5nIGThu6VuZyDEkeG7gyBs4buNYwogICAgICAgICAgICBzdGF0dXM6IFRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIMSR4buDIGzhu41jCiAgICAgICAgICAgIGpvYl9lbmFibGU6IEzhu41jIHRoZW8gdHLhuqFuZyB0aMOhaSBi4bqtdC904bqvdCBqb2IKICAgICAgICAgICAgZGV2aWNlX2lkOiBM4buNYyB0aGVvIGRldmljZV9pZCwgY8OzIHRo4buDIGzDoDoKICAgICAgICAgICAgICAgIC0gVHJ1ZTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaSAobeG6t2MgxJHhu4tuaCkKICAgICAgICAgICAgICAgIC0gRmFsc2UvTm9uZTogS2jDtG5nIGzhu41jIHRoZW8gZGV2aWNlX2lkCiAgICAgICAgICAgICAgICAtIENodeG7l2k6IEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6UgdGjhu4MgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbwogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHF1ZXJ5ID0gIlNFTEVDVCAqIEZST00gYWNjb3VudHMiCiAgICAgICAgcGFyYW1zID0gW10KICAgICAgICAKICAgICAgICAjIFRow6ptIMSRaeG7gXUga2nhu4duIGzhu41jCiAgICAgICAgY29uZGl0aW9ucyA9IFtdCiAgICAgICAgaWYgYXBwOgogICAgICAgICAgICBjb25kaXRpb25zLmFwcGVuZCgiYXBwID0gPyIpCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoYXBwKQogICAgICAgIGlmIHN0YXR1czoKICAgICAgICAgICAgY29uZGl0aW9ucy5hcHBlbmQoInN0YXR1cyA9ID8iKQogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKHN0YXR1cykKICAgICAgICBpZiBqb2JfZW5hYmxlIGlzIG5vdCBOb25lOgogICAgICAgICAgICBjb25kaXRpb25zLmFwcGVuZCgiam9iX2VuYWJsZSA9ID8iKQogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKDEgaWYgam9iX2VuYWJsZSBlbHNlIDApCiAgICAgICAgICAgIAogICAgICAgIGlmIGNvbmRpdGlvbnM6CiAgICAgICAgICAgIHF1ZXJ5ICs9ICIgV0hFUkUgIiArICIgQU5EICIuam9pbihjb25kaXRpb25zKQogICAgICAgICAgICAKICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgcGFyYW1zKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgIGFjY291bnRzID0gW10KICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgICAgIGFjY291bnQgPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgICAgICBhY2NvdW50WyJpc19sb2dpbiJdID0gYm9vbChhY2NvdW50WyJpc19sb2dpbiJdKQogICAgICAgICAgICBhY2NvdW50WyJqb2JfZW5hYmxlIl0gPSBib29sKGFjY291bnRbImpvYl9lbmFibGUiXSkKICAgICAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgICAgIGFjY291bnRbImlzX3N5bmMiXSA9IGJvb2woYWNjb3VudFsiaXNfc3luYyJdKSAgICAgICAgICAgICMgRml4OiBQcmVzZXJ2ZSBkaXNhYmxlX2ZvbGxvdyBzdGF0dXMgZnJvbSBkYXRhYmFzZQogICAgICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgZm9sbG93IHRow6BuaCBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgICAgICBpZiAiZm9sbG93X3RvZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gPSBpbnQoYWNjb3VudFsiZm9sbG93X3RvZGF5Il0pIGlmIGFjY291bnRbImZvbGxvd190b2RheSJdIGVsc2UgMAogICAgICAgICAgICBpZiAiZm9sbG93X2luX3Nlc3Npb24iIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdID0gaW50KGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0pIGlmIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gZWxzZSAwCiAgICAgICAgICAgICMgxJDDoyBsb+G6oWkgYuG7jyBtYXhfZm9sbG93X2RheSB2w6AgbWF4X2ZvbGxvd19zZXNzaW9uCiAgICAgICAgICAgIGlmICJsYXN0X2ZvbGxvd190aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdIGVsc2UgMAogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgY2FyZSB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICAgICAgaWYgImxhc3RfY2FyZV90aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdKSBpZiBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdIGVsc2UgMAogICAgICAgICAgICBpZiAibGFzdF92aWV3X3N0b3JpZXMiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdID0gaW50KGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0pIGlmIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gZWxzZSAwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2FkcyhhY2NvdW50WyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBM4buNYyB0aGVvIGRldmljZV9pZCBu4bq/dSBj4bqnbgogICAgICAgIGlmIGRldmljZV9pZCBpcyBUcnVlOgogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZCBj4bunYSB0aGnhur90IGLhu4sgaGnhu4duIHThuqFpCiAgICAgICAgICAgIGN1cnJlbnRfZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgY3VycmVudF9kZXZpY2VfaWQ6CiAgICAgICAgICAgICAgICAjIEzhu41jIHTDoGkga2hv4bqjbiB0aGVvIGRldmljZV9pZCBj4bunYSB0aGnhur90IGLhu4sgaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBhY2MuZ2V0KCJkZXZpY2VfaWQiKSA9PSBjdXJyZW50X2RldmljZV9pZF0KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGV2aWNlX2lkLCBzdHIpIGFuZCBkZXZpY2VfaWQ6CiAgICAgICAgICAgICMgTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7pSB0aOG7gyDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgICAgIGFjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIGFjYy5nZXQoImRldmljZV9pZCIpID09IGRldmljZV9pZF0KICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAKICAgIGRlZiBkZWxldGVfam9iX2hpc3RvcnlfYnlfYWNjb3VudChzZWxmLCBhY2NvdW50X3V1aWQ6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIHThuqV0IGPhuqMgam9iIGhpc3RvcnkgY+G7p2EgbeG7mXQgdMOgaSBraG/huqNuIHRoZW8gYWNjb3VudF91dWlkIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gam9ic19oaXN0b3J5IFdIRVJFIGFjY291bnRfdXVpZCA9ID8iLCAoYWNjb3VudF91dWlkLCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgZGVsZXRlZF9jb3VudCA9IGN1cnNvci5yb3djb3VudAogICAgICAgICAgICBwcmludChmIsSQw6MgeMOzYSB7ZGVsZXRlZF9jb3VudH0gam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuIFVVSUQ6IHthY2NvdW50X3V1aWR9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2Egam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZGVsZXRlX2FjY291bnQoc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBib29sOgogICAgICAgICIiIljDs2EgdMOgaSBraG/huqNuIGto4buPaSBkYXRhYmFzZSIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGFjY291bnRzIFdIRVJFIGlkID0gPyIsIChhY2NvdW50X2lkLCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5yb3djb3VudCA+IDAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGNsb3NlKHNlbGYpOgogICAgICAgICIiIsSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSBj4bunYSB0aHJlYWQgaGnhu4duIHThuqFpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYubG9jYWwsICdjb25uJykgYW5kIHNlbGYubG9jYWwuY29ubjoKICAgICAgICAgICAgICAgIHNlbGYubG9jYWwuY29ubi5jbG9zZSgpCiAgICAgICAgICAgICAgICBzZWxmLmxvY2FsLmNvbm4gPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIGPDoWMgdGhhbSBjaGnhur91IHRocmVhZCDEkeG7gyB0csOhbmggbOG7l2kKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnbG9jYWwnKToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5sb2NhbCwgJ19sb2NhbF9faW1wbCcpOgogICAgICAgICAgICAgICAgICAgICMgWMOzYSB0aGFtIGNoaeG6v3UgdHJvbmcgVGhyZWFkTG9jYWwKICAgICAgICAgICAgICAgICAgICBkZWxhdHRyKHNlbGYubG9jYWwsICdfbG9jYWxfX2ltcGwnKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgxJHDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlOiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfX2RlbF9fKHNlbGYpOgogICAgICAgICIiIkjhu6d5IMSR4buRaSB0xrDhu6NuZyIiIgogICAgICAgIHNlbGYuY2xvc2UoKQogICAgCiAgICBkZWYgdXBkYXRlX29yX2luc2VydF9hY2NvdW50KHNlbGYsIGFwcF9uYW1lOiBzdHIsIHVuaXF1ZV9pZDogc3RyLCBkYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgaG/hurdjIHRow6ptIG3hu5tpIG3hu5l0IHTDoGkga2hv4bqjbiB2w6BvIGRhdGFiYXNlCiAgICAgICAgIiIiCiAgICAgICAgIyDEkOG6o20gYuG6o28gY29ubmVjdGlvbiBsw6AgY+G7p2EgdGhyZWFkIGhp4buHbiB04bqhaQogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIHThu5NuIHThuqFpIGNoxrBhCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgIiIiU0VMRUNUIGlkIEZST00gYWNjb3VudHMgV0hFUkUgYXBwX25hbWUgPSA/IEFORCB1bmlxdWVfaWQgPSA/IiIiLCAKICAgICAgICAgICAgICAgIChhcHBfbmFtZSwgdW5pcXVlX2lkKQogICAgICAgICAgICApCiAgICAgICAgICAgIGFjY291bnQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYWNjb3VudDoKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiBoaeG7h24gY8OzCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudFswXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IGThu68gbGnhu4d1IGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiU0VMRUNUIGRhdGEgRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iIiIsCiAgICAgICAgICAgICAgICAgICAgKGFjY291bnRfaWQsKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgY3VycmVudF9kYXRhX3JvdyA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgICAgICAgICBjdXJyZW50X2RhdGEgPSBqc29uLmxvYWRzKGN1cnJlbnRfZGF0YV9yb3dbMF0pIGlmIGN1cnJlbnRfZGF0YV9yb3cgZWxzZSB7fQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEjhu6NwIG5o4bqldCBk4buvIGxp4buHdSBjxakgdsOgIG3hu5tpCiAgICAgICAgICAgICAgICBtZXJnZWRfZGF0YSA9IHsqKmN1cnJlbnRfZGF0YSwgKipkYXRhfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdAogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiVVBEQVRFIGFjY291bnRzIFNFVCAKICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gPywKICAgICAgICAgICAgICAgICAgICAgICBuaWNrbmFtZSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgc3RhdHVzID0gPywKICAgICAgICAgICAgICAgICAgICAgICBpc19sb2dpbiA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgam9iX2VuYWJsZSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgbGFzdF91cGRhdGUgPSA/CiAgICAgICAgICAgICAgICAgICAgICAgV0hFUkUgaWQgPSA/IiIiLAogICAgICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICAgICAganNvbi5kdW1wcyhtZXJnZWRfZGF0YSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJuaWNrbmFtZSIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoInN0YXR1cyIsICJhY3RpdmUiKSwKICAgICAgICAgICAgICAgICAgICAgICAgMSBpZiBkYXRhLmdldCgiaXNfbG9naW4iLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJqb2JfZW5hYmxlIiwgVHJ1ZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUaMOqbSB0w6BpIGtob+G6o24gbeG7m2kKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIklOU0VSVCBJTlRPIGFjY291bnRzICgKICAgICAgICAgICAgICAgICAgICAgICBhcHBfbmFtZSwgdW5pcXVlX2lkLCBuaWNrbmFtZSwgZGF0YSwgc3RhdHVzLCBpc19sb2dpbiwgam9iX2VuYWJsZSwgaXNfZ29saWtlX2xpbmtlZCwgZ29saWtlX2lkLCBsYXN0X3VwZGF0ZQogICAgICAgICAgICAgICAgICAgICkgVkFMVUVTICg/LCA/LCA/LCA/LCA/LCA/LCA/LCA/LCA/LCA/KSIiIiwKICAgICAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcF9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWVfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJuaWNrbmFtZSIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAganNvbi5kdW1wcyhkYXRhKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoInN0YXR1cyIsICJhY3RpdmUiKSwKICAgICAgICAgICAgICAgICAgICAgICAgMSBpZiBkYXRhLmdldCgiaXNfbG9naW4iLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJqb2JfZW5hYmxlIiwgVHJ1ZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICAwLCAgIyBpc19nb2xpa2VfbGlua2VkCiAgICAgICAgICAgICAgICAgICAgICAgICIiLCAjIGdvbGlrZV9pZAogICAgICAgICAgICAgICAgICAgICAgICBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGPhuq1wIG5o4bqtdC90aMOqbSB0w6BpIGtob+G6o246IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJlc2V0X2xvZ2luX3N0YXR1c19ieV9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgbeG7mXQg4bupbmcgZOG7pW5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIChhcHAsIGtow7RuZyBwaOG6o2kgYXBwX25hbWUpCiAgICAgICAgIiIiCiAgICAgICAgIyDEkOG6o20gYuG6o28gY29ubmVjdGlvbiBsw6AgY+G7p2EgdGhyZWFkIGhp4buHbiB04bqhaQogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6AgxJHDoW5oIGThuqV1IGPhuqduIMSR4buTbmcgYuG7mQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICIiIlVQREFURSBhY2NvdW50cyBTRVQgaXNfbG9naW4gPSAwLCBpc19zeW5jID0gMCBXSEVSRSBhcHAgPSA/IiIiLAogICAgICAgICAgICAgICAgKGFwcF9uYW1lLCkKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDxaluZyBj4bqtcCBuaOG6rXQgdHLGsOG7nW5nIGlzX2xvZ2luIHRyb25nIGRhdGEgSlNPTgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICIiIlNFTEVDVCBpZCwgZGF0YSBGUk9NIGFjY291bnRzIFdIRVJFIGFwcCA9ID8iIiIsCiAgICAgICAgICAgICAgICAoYXBwX25hbWUsKQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbMV0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gdHJvbmcgZGF0YQogICAgICAgICAgICAgICAgZGF0YVsiaXNfbG9naW4iXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgICAgIGRhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSBs4bqhaSBkYXRhCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiIiJVUERBVEUgYWNjb3VudHMgU0VUIGRhdGEgPSA/IFdIRVJFIGlkID0gPyIiIiwKICAgICAgICAgICAgICAgICAgICAoanNvbi5kdW1wcyhkYXRhKSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbjoge2V9IikKICAgICAgICAgICAgY29ubi5yb2xsYmFjaygpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKCiAgICBkZWYgYWRkX2pvYl9oaXN0b3J5KHNlbGYsIGpvYl9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIFRow6ptIG3hu5l0IGLhuqNuIGdoaSBs4buLY2ggc+G7rSBqb2IgbeG7m2kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfZGF0YTogROG7ryBsaeG7h3Ugam9iIGPhuqduIGzGsHUKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVVUlEIGPhu6dhIGpvYiDEkcOjIHRow6ptCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIGpvYl91dWlkID0gam9iX2RhdGEuZ2V0KCJqb2JfdXVpZCIsIHN0cih1dWlkLnV1aWQ0KCkpKQogICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBkZXZpY2VfaWQsIHPhu60gZOG7pW5nIGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICBkZXZpY2VfaWQgPSBqb2JfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgCiAgICAgICAgIyBUw6FjaCBk4buvIGxp4buHdSBjaMOtbmggdsOgIGThu68gbGnhu4d1IHBo4bulCiAgICAgICAgbWFpbl9kYXRhID0gewogICAgICAgICAgICAiam9iX3V1aWQiOiBqb2JfdXVpZCwKICAgICAgICAgICAgImFjY291bnRfdXVpZCI6IGpvYl9kYXRhLmdldCgiYWNjb3VudF91dWlkIiwgIiIpLAogICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAiYXBwIjogam9iX2RhdGEuZ2V0KCJhcHAiLCAiIiksCiAgICAgICAgICAgICJqb2JfaWQiOiBqb2JfZGF0YS5nZXQoImpvYl9pZCIsICIiKSwKICAgICAgICAgICAgImpvYl90eXBlIjogam9iX2RhdGEuZ2V0KCJqb2JfdHlwZSIsICIiKSwKICAgICAgICAgICAgIm9iamVjdF9pZCI6IGpvYl9kYXRhLmdldCgib2JqZWN0X2lkIiwgIiIpLAogICAgICAgICAgICAibGluayI6IGpvYl9kYXRhLmdldCgibGluayIsICIiKSwKICAgICAgICAgICAgInN0YXR1cyI6IGpvYl9kYXRhLmdldCgic3RhdHVzIiwgMCksCiAgICAgICAgICAgICJzdWNjZXNzIjogMSBpZiBqb2JfZGF0YS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAicHJpY2UiOiBqb2JfZGF0YS5nZXQoInByaWNlIiwgMC4wKSwKICAgICAgICAgICAgImVycm9yX21lc3NhZ2UiOiBqb2JfZGF0YS5nZXQoImVycm9yX21lc3NhZ2UiLCAiIiksCiAgICAgICAgICAgICJjcmVhdGVkX2F0Ijogam9iX2RhdGEuZ2V0KCJjcmVhdGVkX2F0IiwgY3VycmVudF90aW1lKSwKICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogY3VycmVudF90aW1lLAogICAgICAgICAgICAiaXNfc3luYyI6IDAgICMgTeG6t2MgxJHhu4tuaCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgIyBMxrB1IElEIHThu6sgZOG7ryBsaeG7h3UgxJHhuqd1IHbDoG8gbuG6v3UgY8OzCiAgICAgICAgaWYgImlkIiBpbiBqb2JfZGF0YToKICAgICAgICAgICAgbWFpbl9kYXRhWyJpZCJdID0gam9iX2RhdGFbImlkIl0KICAgICAgICAKICAgICAgICAjIEzGsHUgZOG7ryBsaeG7h3UgcGjhu6UgZMaw4bubaSBk4bqhbmcgSlNPTgogICAgICAgIGV4dHJhX2RhdGEgPSB7azogdiBmb3IgaywgdiBpbiBqb2JfZGF0YS5pdGVtcygpIGlmIGsgbm90IGluIG1haW5fZGF0YSBhbmQgayAhPSAiZGF0YSJ9CiAgICAgICAgaWYgImRhdGEiIGluIGpvYl9kYXRhIGFuZCBpc2luc3RhbmNlKGpvYl9kYXRhWyJkYXRhIl0sIGRpY3QpOgogICAgICAgICAgICBleHRyYV9kYXRhLnVwZGF0ZShqb2JfZGF0YVsiZGF0YSJdKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY29sdW1ucyA9ICIsICIuam9pbihtYWluX2RhdGEua2V5cygpKQogICAgICAgICAgICBwbGFjZWhvbGRlcnMgPSAiLCAiLmpvaW4oWyI/Il0gKiBsZW4obWFpbl9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhbHVlcyA9IGxpc3QobWFpbl9kYXRhLnZhbHVlcygpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB2w6BvIGN14buRaQogICAgICAgICAgICBjb2x1bW5zICs9ICIsIGRhdGEiCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyArPSAiLCA/IgogICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKGpzb24uZHVtcHMoZXh0cmFfZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBxdWVyeSA9IGYiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBqb2JzX2hpc3RvcnkgKHtjb2x1bW5zfSkgVkFMVUVTICh7cGxhY2Vob2xkZXJzfSkiCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCB2YWx1ZXMpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIGpvYl91dWlkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB0aMOqbSBs4buLY2ggc+G7rSBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiIgogICAgCiAgICBkZWYgdXBkYXRlX2pvYl9oaXN0b3J5KHNlbGYsIGpvYl91dWlkOiBzdHIsIGRhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIGzhu4tjaCBz4butIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl91dWlkOiBVVUlEIGPhu6dhIGpvYiBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgZGF0YTogROG7ryBsaeG7h3UgY+G6rXAgbmjhuq10CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgam9iID0gc2VsZi5nZXRfam9iX2hpc3Rvcnkoam9iX3V1aWQpCiAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgZOG7ryBsaeG7h3UKICAgICAgICBqb2IudXBkYXRlKGRhdGEpCiAgICAgICAgam9iWyJsYXN0X3VwZGF0ZSJdID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgTMawdSBs4bqhaQogICAgICAgIHJldHVybiBib29sKHNlbGYuYWRkX2pvYl9oaXN0b3J5KGpvYikpCiAgICAKICAgIGRlZiBnZXRfam9iX2hpc3Rvcnkoc2VsZiwgam9iX3V1aWQ6IHN0cikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gbOG7i2NoIHPhu60gam9iIHRoZW8gVVVJRAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl91dWlkOiBVVUlEIGPhu6dhIGpvYiBj4bqnbiBs4bqleQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0IGhv4bq3YyBOb25lOiBUaMO0bmcgdGluIGpvYiBu4bq/dSB0w6xtIHRo4bqleSwgTm9uZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogRlJPTSBqb2JzX2hpc3RvcnkgV0hFUkUgam9iX3V1aWQgPSA/IiwgKGpvYl91dWlkLCkpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAKICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgIGpvYiA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGpvYlsic3VjY2VzcyJdID0gYm9vbChqb2JbInN1Y2Nlc3MiXSkKICAgICAgICBqb2JbImlzX3N5bmMiXSA9IGJvb2woam9iWyJpc19zeW5jIl0pCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGpvYiBhbmQgam9iWyJkYXRhIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGpvYlsiZGF0YSJdKQogICAgICAgICAgICAgICAgam9iLnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgaWYgImRhdGEiIGluIGpvYjoKICAgICAgICAgICAgZGVsIGpvYlsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBqb2IKICAgIAogICAgZGVmIGdldF9qb2JfaGlzdG9yeV9ieV9hY2NvdW50KHNlbGYsIGFjY291bnRfdXVpZDogc3RyLCBsaW1pdDogaW50ID0gNTApIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGzhu4tjaCBz4butIGpvYiBj4bunYSBt4buZdCB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X3V1aWQ6IFVVSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGxpbWl0OiBT4buRIGzGsOG7o25nIGLhuqNuIGdoaSB04buRaSDEkWEgdHLhuqMgduG7gQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCBs4buLY2ggc+G7rSBqb2IKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgIlNFTEVDVCAqIEZST00gam9ic19oaXN0b3J5IFdIRVJFIGFjY291bnRfdXVpZCA9ID8gT1JERVIgQlkgY3JlYXRlZF9hdCBERVNDIExJTUlUID8iLCAKICAgICAgICAgICAgKGFjY291bnRfdXVpZCwgbGltaXQpCiAgICAgICAgKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgIGpvYnMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgam9iID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICAgICAgam9iWyJzdWNjZXNzIl0gPSBib29sKGpvYlsic3VjY2VzcyJdKQogICAgICAgICAgICBqb2JbImlzX3N5bmMiXSA9IGJvb2woam9iWyJpc19zeW5jIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGpvYiBhbmQgam9iWyJkYXRhIl06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoam9iWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgam9iLnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgICAgICBpZiAiZGF0YSIgaW4gam9iOgogICAgICAgICAgICAgICAgZGVsIGpvYlsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgam9icy5hcHBlbmQoam9iKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gam9icwogICAgCiAgICBkZWYgZ2V0X3BlbmRpbmdfc3luY19pdGVtcyhzZWxmLCB0YWJsZTogc3RyLCBsaW1pdDogaW50ID0gMTAwLCBkZXZpY2VfaWQ6IEFueSA9IFRydWUpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRhbmggc8OhY2ggY8OhYyBi4bqjbiBnaGkgY2jGsGEgxJHGsOG7o2MgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFibGU6IFTDqm4gYuG6o25nICgnYWNjb3VudHMnIGhv4bq3YyAnam9ic19oaXN0b3J5JykKICAgICAgICAgICAgbGltaXQ6IFPhu5EgbMaw4bujbmcgYuG6o24gZ2hpIHThu5FpIMSRYSB0cuG6oyB24buBCiAgICAgICAgICAgIGRldmljZV9pZDogVGhp4bq/dCBi4buLIElEIMSR4buDIGzhu41jOgogICAgICAgICAgICAgICAgLSBUcnVlOiBM4buNYyB0aGVvIGRldmljZV9pZCBoaeG7h24gdOG6oWkgKG3hurdjIMSR4buLbmgpCiAgICAgICAgICAgICAgICAtIEZhbHNlL05vbmU6IEtow7RuZyBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgICAgICAgICAgLSBDaHXhu5dpOiBM4buNYyB0aGVvIGRldmljZV9pZCBj4bulIHRo4buDIMSRxrDhu6NjIHRydXnhu4FuIHbDoG8KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggYuG6o24gZ2hpIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICIiIgogICAgICAgIGlmIHRhYmxlIG5vdCBpbiBbJ2FjY291bnRzJywgJ2pvYnNfaGlzdG9yeSddOgogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdXVpZF9maWVsZCA9ICJhY2NvdW50X3V1aWQiIGlmIHRhYmxlID09ICJhY2NvdW50cyIgZWxzZSAiam9iX3V1aWQiCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSDEkWnhu4F1IGtp4buHbiBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgIGlmIGRldmljZV9pZCBpcyBUcnVlOgogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY3VycmVudF9kZXZpY2VfaWQgPSBzZWxmLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgcXVlcnkgPSBmIlNFTEVDVCAqIEZST00ge3RhYmxlfSBXSEVSRSBpc19zeW5jID0gMCBBTkQgZGV2aWNlX2lkID0gPyBMSU1JVCA/IgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgKGN1cnJlbnRfZGV2aWNlX2lkLCBsaW1pdCkpCiAgICAgICAgZWxpZiBkZXZpY2VfaWQ6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgZGV2aWNlX2lkIMSRxrDhu6NjIHRydXnhu4FuIHbDoG8KICAgICAgICAgICAgcXVlcnkgPSBmIlNFTEVDVCAqIEZST00ge3RhYmxlfSBXSEVSRSBpc19zeW5jID0gMCBBTkQgZGV2aWNlX2lkID0gPyBMSU1JVCA/IgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgKGRldmljZV9pZCwgbGltaXQpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgS2jDtG5nIGzhu41jIHRoZW8gZGV2aWNlX2lkCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJTRUxFQ1QgKiBGUk9NIHt0YWJsZX0gV0hFUkUgaXNfc3luYyA9IDAgTElNSVQgPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIChsaW1pdCwpKQogICAgICAgICAgICAKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICBpdGVtcyA9IFtdCiAgICAgICAgZm9yIHJlc3VsdCBpbiByZXN1bHRzOgogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgICAgICBpdGVtID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgICAgICBpZiAiZGF0YSIgaW4gaXRlbSBhbmQgaXRlbVsiZGF0YSJdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGl0ZW1bImRhdGEiXSkKICAgICAgICAgICAgICAgICAgICBpdGVtLnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgICAgICBpZiAiZGF0YSIgaW4gaXRlbToKICAgICAgICAgICAgICAgIGRlbCBpdGVtWyJkYXRhIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpdGVtcy5hcHBlbmQoaXRlbSkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGl0ZW1zCiAgICAKICAgIGRlZiBtYXJrX2FzX3N5bmNlZChzZWxmLCB0YWJsZTogc3RyLCB1dWlkX3ZhbHVlOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IGLhuqNuIGdoaSDEkcOjIMSRxrDhu6NjIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhYmxlOiBUw6puIGLhuqNuZyAoJ2FjY291bnRzJyBob+G6t2MgJ2pvYnNfaGlzdG9yeScpCiAgICAgICAgICAgIHV1aWRfdmFsdWU6IEdpw6EgdHLhu4sgVVVJRCBj4bunYSBi4bqjbiBnaGkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqtcCBuaOG6rXQgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiB0YWJsZSBub3QgaW4gWydhY2NvdW50cycsICdqb2JzX2hpc3RvcnknXToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHV1aWRfZmllbGQgPSAiYWNjb3VudF91dWlkIiBpZiB0YWJsZSA9PSAiYWNjb3VudHMiIGVsc2UgImpvYl91dWlkIgogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICBmIlVQREFURSB7dGFibGV9IFNFVCBpc19zeW5jID0gMSBXSEVSRSB7dXVpZF9maWVsZH0gPSA/IiwKICAgICAgICAgICAgICAgICh1dWlkX3ZhbHVlLCkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBjdXJzb3Iucm93Y291bnQgPiAwCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgxJHDoyDEkeG7k25nIGLhu5k6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKCiAgICBkZWYgbWFya19hbGxfYWNjb3VudHNfbm90X3N5bmNlZChzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGzDoCBjaMawYSBzeW5jCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBT4buRIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdAogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlVQREFURSBhY2NvdW50cyBTRVQgaXNfc3luYyA9IDAiKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHVwZGF0ZWRfY291bnQgPSBjdXJzb3Iucm93Y291bnQKICAgICAgICAgICAgcmV0dXJuIHVwZGF0ZWRfY291bnQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjaMawYSBzeW5jOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gMAoKICAgIGRlZiBnZXRfZGV2aWNlX2NvbmZpZyhzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBBbnk6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAga2V5OiBLaMOzYSBj4bqldSBow6xuaAogICAgICAgICAgICBkZWZhdWx0OiBHacOhIHRy4buLIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIEFueTogR2nDoSB0cuG7iyBj4bqldSBow6xuaCBob+G6t2MgZ2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSBj4bqldSBow6xuaCB04burIGRhdGFiYXNlCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0KGtleSwgZGVmYXVsdCkKCiAgICBkZWYgc2V0X2RldmljZV9jb25maWcoc2VsZiwga2V5OiBzdHIsIHZhbHVlOiBBbnkpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgU2V0IGEgZGV2aWNlIGNvbmZpZ3VyYXRpb24gdmFsdWUgaW4gdGhlIGNvbmZpZyB0YWJsZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogVGhlIGNvbmZpZ3VyYXRpb24ga2V5CiAgICAgICAgICAgIHZhbHVlOiBUaGUgdmFsdWUgdG8gc2V0CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgaWYgc3VjY2Vzc2Z1bCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KGtleSwgdmFsdWUpCgogICAgZGVmIGdldF9nbG9iYWxfY29uZmlnKHNlbGYsIGRlZmF1bHQ9Tm9uZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZ2xvYmFsIGNvbmZpZyBjaHVuZyBjaG8gdOG6pXQgY+G6oyBhcHBzCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGVmYXVsdDogQ29uZmlnIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIGPDsyB0cm9uZyBEQgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogR2xvYmFsIGNvbmZpZyBjaHVuZwogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmdldCgiZ2xvYmFsX2NvbmZpZyIsIGRlZmF1bHQgb3Ige30pCiAgICAKICAgIGRlZiBzZXRfZ2xvYmFsX2NvbmZpZyhzZWxmLCBjb25maWc6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzGsHUgZ2xvYmFsIGNvbmZpZyBjaHVuZyBjaG8gdOG6pXQgY+G6oyBhcHBzCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnOiBHbG9iYWwgY29uZmlnIGNodW5nCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KCJnbG9iYWxfY29uZmlnIiwgY29uZmlnKQogICAgCiAgICBkZWYgZ2V0X2FwcF9jb25maWcoc2VsZiwgYXBwX25hbWU6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBjb25maWcgY2hvIG3hu5l0IGFwcCBj4bulIHRo4buDCiAgICAgICAgUHJpb3JpdHk6IGFwcF9jb25maWcg4oaSIGdsb2JhbF9jb25maWcg4oaSIGRlZmF1bHQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAgKHRpa3RvaywgdGlrdG9rMiwgaW5zdGFncmFtLCBldGMuKQogICAgICAgICAgICBkZWZhdWx0OiBDb25maWcgbeG6t2MgxJHhu4tuaCBjaG8gYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBDb25maWcgY+G7p2EgYXBwIMSRw6MgbWVyZ2UgdGhlbyBwcmlvcml0eQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBjb25maWcgcmnDqm5nIGPhu6dhIGFwcAogICAgICAgICAgICBhcHBfY29uZmlnX2tleSA9IGYie2FwcF9uYW1lfV9jb25maWciCiAgICAgICAgICAgIGFwcF9jb25maWcgPSBzZWxmLmdldChhcHBfY29uZmlnX2tleSwge30pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGdsb2JhbCBjb25maWcKICAgICAgICAgICAgZ2xvYmFsX2NvbmZpZyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoe30pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE1lcmdlIHRoZW8gcHJpb3JpdHk6IGRlZmF1bHQg4oaSIGdsb2JhbCDihpIgYXBwCiAgICAgICAgICAgIG1lcmdlZF9jb25maWcgPSAoZGVmYXVsdCBvciB7fSkuY29weSgpCiAgICAgICAgICAgIG1lcmdlZF9jb25maWcudXBkYXRlKGdsb2JhbF9jb25maWcpCiAgICAgICAgICAgIG1lcmdlZF9jb25maWcudXBkYXRlKGFwcF9jb25maWcpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gbWVyZ2VkX2NvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBnZXQgYXBwIGNvbmZpZyBjaG8ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHQgb3Ige30KICAgIAogICAgZGVmIHNldF9hcHBfY29uZmlnKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGFwcF9jb25maWc6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzGsHUgY29uZmlnIGNobyBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBhcHBfY29uZmlnOiBDb25maWcgY+G7p2EgYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgYXBwX2NvbmZpZ19rZXkgPSBmInthcHBfbmFtZX1fY29uZmlnIgogICAgICAgIHJldHVybiBzZWxmLnNldChhcHBfY29uZmlnX2tleSwgYXBwX2NvbmZpZykKICAgIAogICAgZGVmIHVwZGF0ZV9hcHBfY29uZmlnKHNlbGYsIGFwcF9uYW1lOiBzdHIsIHVwZGF0ZXM6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBt4buZdCBz4buRIGNvbmZpZyBjaG8gYXBwIChtZXJnZSB24bubaSBjb25maWcgaGnhu4duIHThuqFpKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICB1cGRhdGVzOiBEaWN0IGPDoWMgY29uZmlnIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIGFwcF9jb25maWdfa2V5ID0gZiJ7YXBwX25hbWV9X2NvbmZpZyIKICAgICAgICBjdXJyZW50X2NvbmZpZyA9IHNlbGYuZ2V0KGFwcF9jb25maWdfa2V5LCB7fSkKICAgICAgICBjdXJyZW50X2NvbmZpZy51cGRhdGUodXBkYXRlcykKICAgICAgICByZXR1cm4gc2VsZi5zZXQoYXBwX2NvbmZpZ19rZXksIGN1cnJlbnRfY29uZmlnKQogICAgCiAgICBkZWYgdXBkYXRlX2dsb2JhbF9jb25maWcoc2VsZiwgdXBkYXRlczogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGdsb2JhbCBjb25maWcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB1cGRhdGVzOiBEaWN0IGPDoWMgY29uZmlnIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIGN1cnJlbnRfY29uZmlnID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZyh7fSkKICAgICAgICBjdXJyZW50X2NvbmZpZy51cGRhdGUodXBkYXRlcykKICAgICAgICByZXR1cm4gc2VsZi5zZXRfZ2xvYmFsX2NvbmZpZyhjdXJyZW50X2NvbmZpZykKCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAjIEdPTElLRSBDT05GSUcgTUVUSE9EUwogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBkZWYgZ2V0X2dvbGlrZV9jb25maWcoc2VsZiwgZGVmYXVsdD1Ob25lKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBHb0xpa2UgY29uZmlnCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGVmYXVsdDogQ29uZmlnIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIGPDsyB0cm9uZyBEQgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogR29MaWtlIGNvbmZpZwogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmdldCgiZ29saWtlX2NvbmZpZyIsIGRlZmF1bHQgb3Ige30pCiAgICAKICAgIGRlZiBzZXRfZ29saWtlX2NvbmZpZyhzZWxmLCBjb25maWc6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzGsHUgR29MaWtlIGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZzogR29MaWtlIGNvbmZpZwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnNldCgiZ29saWtlX2NvbmZpZyIsIGNvbmZpZykKICAgIAogICAgZGVmIHVwZGF0ZV9nb2xpa2VfY29uZmlnKHNlbGYsIHVwZGF0ZXM6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBHb0xpa2UgY29uZmlnCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdXBkYXRlczogRGljdCBjw6FjIGNvbmZpZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBjdXJyZW50X2NvbmZpZyA9IHNlbGYuZ2V0X2dvbGlrZV9jb25maWcoe30pCiAgICAgICAgY3VycmVudF9jb25maWcudXBkYXRlKHVwZGF0ZXMpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2dvbGlrZV9jb25maWcoY3VycmVudF9jb25maWcpCgogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBQUk9YWSBDT05GSUcgTUVUSE9EUyAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAKICAgIGRlZiBnZXRfcHJveHlfY29uZmlnKHNlbGYsIGRlZmF1bHQ9Tm9uZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgUHJveHkgY29uZmlnCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGVmYXVsdDogQ29uZmlnIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIGPDsyB0cm9uZyBEQgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogUHJveHkgY29uZmlnCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0KCJwcm94eV9jb25maWciLCBkZWZhdWx0IG9yIHt9KQogICAgCiAgICBkZWYgc2V0X3Byb3h5X2NvbmZpZyhzZWxmLCBjb25maWc6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzGsHUgUHJveHkgY29uZmlnCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnOiBQcm94eSBjb25maWcKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5zZXQoInByb3h5X2NvbmZpZyIsIGNvbmZpZykKICAgIAogICAgZGVmIHVwZGF0ZV9wcm94eV9jb25maWcoc2VsZiwgdXBkYXRlczogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IFByb3h5IGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVwZGF0ZXM6IERpY3QgY8OhYyBjb25maWcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgY3VycmVudF9jb25maWcgPSBzZWxmLmdldF9wcm94eV9jb25maWcoe30pCiAgICAgICAgY3VycmVudF9jb25maWcudXBkYXRlKHVwZGF0ZXMpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X3Byb3h5X2NvbmZpZyhjdXJyZW50X2NvbmZpZykKCiAgICBkZWYgZ2V0X2FsbF9kZXZpY2VfY29uZmlnKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEdldCBhbGwgZGV2aWNlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogRGljdGlvbmFyeSBvZiBhbGwgZGV2aWNlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICAjIEdldCBhbGwga2V5cyBzdGFydGluZyB3aXRoICJkZXZpY2VfIiBidXQgZXhjbHVkZSBkZXZpY2VfaW5mbwogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1Qga2V5LCB2YWx1ZSBGUk9NIGNvbmZpZyBXSEVSRSBrZXkgIT0gJ2RldmljZV9pbmZvJyBBTkQga2V5ICE9ICdkZXZpY2VfaWQnIikKICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICAjIEJ1aWxkIGNvbmZpZyBkaWN0aW9uYXJ5LCByZW1vdmluZyAiZGV2aWNlXyIgcHJlZml4IGZyb20ga2V5cwogICAgICAgIGRldmljZV9jb25maWcgPSB7fQogICAgICAgIGZvciBrZXksIHZhbHVlIGluIHJlc3VsdHM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWdba2V5XSA9IGpzb24ubG9hZHModmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWdba2V5XSA9IHZhbHVlCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIG1vZHVsZQogICAgICAgIGltcG9ydCBjb25maWcgYXMgY29uZmlnX21vZHVsZQogICAgICAgIAogICAgICAgICMgQWRkIGRlZmF1bHQgdmFsdWVzIGZvciBtaXNzaW5nIGNvbmZpZyBpdGVtcwogICAgICAgIGRlZmF1bHRfY29uZmlncyA9IHsKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9kYXkiOiBjb25maWdfbW9kdWxlLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgICJqb2JfaW50ZXJ2YWxfc2Vjb25kcyI6IGNvbmZpZ19tb2R1bGUuSk9CX0NIRUNLX0lOVEVSVkFMLAogICAgICAgICAgICAicmVwb3J0X2ludGVydmFsIjogY29uZmlnX21vZHVsZS5NUVRUX1JFUE9SVF9JTlRFUlZBTCwKICAgICAgICAgICAgIyAiZW5hYmxlX2NhcmUiOiBjb25maWdfbW9kdWxlLlNNQVJUX0NBUkVfRU5BQkxFRCwgICMgUkVNT1ZFRDoga2jDtG5nIHPhu60gZOG7pW5nIG7hu69hCiAgICAgICAgICAgICMgImNhcmVfaW50ZXJ2YWxfaG91cnMiOiBjb25maWdfbW9kdWxlLlNNQVJUX0NBUkVfSU5URVJWQUxfSE9VUlMsICAjIFJFTU9WRUQ6IGtow7RuZyBz4butIGThu6VuZyBu4buvYQogICAgICAgICAgICAjICJjYXJlX2NoYW5jZV9wZXJjZW50IjogY29uZmlnX21vZHVsZS5TTUFSVF9DQVJFX0NIQU5DRV9QRVJDRU5UICAjIFJFTU9WRUQ6IGtow7RuZyBz4butIGThu6VuZyBu4buvYQogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3Iga2V5LCBkZWZhdWx0X3ZhbHVlIGluIGRlZmF1bHRfY29uZmlncy5pdGVtcygpOgogICAgICAgICAgICBpZiBrZXkgbm90IGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBkZXZpY2VfY29uZmlnW2tleV0gPSBkZWZhdWx0X3ZhbHVlCiAgICAgICAgCiAgICAgICAgIyBMb+G6oWkgYuG7jyBjw6FjIHRyxrDhu51uZyBraMO0bmcgY+G6p24gdGhp4bq/dAogICAgICAgIGtleXNfdG9fcmVtb3ZlID0gWyJpZCIsICJnb2xpa2VfYXBpX2Jhc2UiXQogICAgICAgIGZvciBrZXkgaW4ga2V5c190b19yZW1vdmU6CiAgICAgICAgICAgIGlmIGtleSBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgZGVsIGRldmljZV9jb25maWdba2V5XQogICAgICAgIAogICAgICAgIHJldHVybiBkZXZpY2VfY29uZmlnCgogICAgZGVmIHNhdmVfZGV2aWNlX2NvbmZpZyhzZWxmLCBjb25maWdfZGljdDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMawdSBuaGnhu4F1IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyBjw7luZyBsw7pjCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnX2RpY3Q6IERpY3Rpb25hcnkgY2jhu6lhIGPDoWMgY+G6t3Aga2V5LXZhbHVlIGPhuqV1IGjDrG5oCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGNvbmZpZ19kaWN0Lml0ZW1zKCk6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKGtleSwgdmFsdWUpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBsxrB1IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBpbml0X2RlZmF1bHRfY29uZmlnKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIGNobyB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogQ+G6pXUgaMOsbmggxJHDoyBraOG7n2kgdOG6oW8KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgREVGQVVMVF9HTE9CQUxfQ09ORklHIHThu6sgY29uZmlnLnB5IHRoYXkgdsOsIGhhcmRjb2RlCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gY29uZmlnLkRFRkFVTFRfR0xPQkFMX0NPTkZJRy5jb3B5KCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gc3luY19pbnRlcnZhbCB2w6BvIGdsb2JhbCBjb25maWcKICAgICAgICAgICAgZGVmYXVsdF9jb25maWdbInN5bmNfaW50ZXJ2YWwiXSA9IGNvbmZpZy5TWU5DX0lOVEVSVkFMCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRlZmF1bHRfY29uZmlnLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAjIENo4buJIGzGsHUgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgICAgICBpZiBzZWxmLmdldF9kZXZpY2VfY29uZmlnKGtleSkgaXMgTm9uZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKGtleSwgdmFsdWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBwcmludCgixJDDoyBraOG7n2kgdOG6oW8gY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCBjaG8gdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRfY29uZmlnCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBraOG7n2kgdOG6oW8gY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgZGVmIGdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBob+G6t2MgdOG6oW8gZGV2aWNlX2lkCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBkZXZpY2VfaWQKICAgICAgICAiIiIKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBkZXZpY2VfaWQgdHJvbmcgZGF0YWJhc2Uga2jDtG5nCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5nZXRfZGV2aWNlX2NvbmZpZygiZGV2aWNlX2lkIiwgIiIpCiAgICAgICAgaWYgZGV2aWNlX2lkOgogICAgICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgICAgIAogICAgICAgICMgVGjhu60gbOG6pXkgZGV2aWNlX2lkIHThu6sgaOG7hyB0aOG7kW5nCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5fZ2V0X2RldmljZV9pZF9mcm9tX3N5c3RlbSgpCiAgICAgICAgaWYgZGV2aWNlX2lkOgogICAgICAgICAgICAjIEzGsHUgdsOgbyBj4bqldSBow6xuaCB2w6AgdHLhuqMgduG7gQogICAgICAgICAgICBwcmludChmIsSQw6MgbOG6pXkgxJHGsOG7o2MgZGV2aWNlX2lkIHThu6sgaOG7hyB0aOG7kW5nOiB7ZGV2aWNlX2lkfSIpCiAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIFRo4butIGzhuqV5IGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5fZ2V0X2RldmljZV9pZF9mcm9tX2hlbHBlcigpCiAgICAgICAgaWYgZGV2aWNlX2lkOgogICAgICAgICAgICAjIEzGsHUgdsOgbyBj4bqldSBow6xuaCB2w6AgdHLhuqMgduG7gQogICAgICAgICAgICBwcmludChmIsSQw6MgbOG6pXkgxJHGsOG7o2MgZGV2aWNlX2lkIHThu6sgaGVscGVyIHNlcnZpY2U6IHtkZXZpY2VfaWR9IikKICAgICAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZygiZGV2aWNlX2lkIiwgZGV2aWNlX2lkKQogICAgICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGzhuqV5IMSRxrDhu6NjLCB04bqhbyBt4bubaQogICAgICAgIGltcG9ydCByYW5kb20KICAgICAgICBpbXBvcnQgc3RyaW5nCiAgICAgICAgcmFuZG9tX2lkID0gJycuam9pbihyYW5kb20uY2hvaWNlcyhzdHJpbmcuYXNjaWlfbG93ZXJjYXNlICsgc3RyaW5nLmRpZ2l0cywgaz0xMCkpCiAgICAgICAgZGV2aWNlX2lkID0gZiJyYW5kb21fe3JhbmRvbV9pZH0iCiAgICAgICAgcHJpbnQoZiJLaMO0bmcgbOG6pXkgxJHGsOG7o2MgZGV2aWNlX2lkIGLhurFuZyBjw6FjIGPDoWNoIHRyw6puLCB04bqhbyBt4bubaToge2RldmljZV9pZH0iKQogICAgICAgIAogICAgICAgICMgTMawdSB2w6BvIGPhuqV1IGjDrG5oCiAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZygiZGV2aWNlX2lkIiwgZGV2aWNlX2lkKQogICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAKICAgIGRlZiBfZ2V0X2RldmljZV9pZF9mcm9tX3N5c3RlbShzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGV2aWNlX2lkIHThu6sgaOG7hyB0aOG7kW5nIChz4butIGThu6VuZyBs4buHbmggZ2V0cHJvcCkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IGRldmljZV9pZCBob+G6t2MgY2h14buXaSBy4buXbmcgbuG6v3Uga2jDtG5nIGzhuqV5IMSRxrDhu6NjCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgc3VicHJvY2VzcwogICAgICAgICAgICByZXN1bHQgPSBzdWJwcm9jZXNzLnJ1bihbImdldHByb3AiLCAicm8uc2VyaWFsbm8iXSwgY2FwdHVyZV9vdXRwdXQ9VHJ1ZSwgdGV4dD1UcnVlKQogICAgICAgICAgICBkZXZpY2VfaWQgPSByZXN1bHQuc3Rkb3V0LnN0cmlwKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRldmljZV9pZCBhbmQgZGV2aWNlX2lkICE9ICJ1bmtub3duIjoKICAgICAgICAgICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBs4bqleSBkZXZpY2VfaWQgdOG7qyBo4buHIHRo4buRbmc6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICAKICAgIGRlZiBfZ2V0X2RldmljZV9pZF9mcm9tX2hlbHBlcihzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGV2aWNlX2lkIHThu6sgaGVscGVyIHNlcnZpY2UgKGFuZHJvaWRfaWQpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBkZXZpY2VfaWQgaG/hurdjIGNodeG7l2kgcuG7l25nIG7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBD4bqnbiBpbXBvcnQgSGVscGVyU2VydmljZSB04bqhaSDEkcOieSDEkeG7gyB0csOhbmggaW1wb3J0IHbDsm5nCiAgICAgICAgICAgIGZyb20gc2VydmljZXMuaGVscGVyX3NlcnZpY2UgaW1wb3J0IEhlbHBlclNlcnZpY2UKICAgICAgICAgICAgaW1wb3J0IGNvbmZpZwogICAgICAgICAgICAKICAgICAgICAgICAgaGVscGVyID0gSGVscGVyU2VydmljZShiYXNlX3VybD1jb25maWcuSEVMUEVSX1NFUlZJQ0VfVVJMKQogICAgICAgICAgICBkZXZpY2VfaW5mbyA9IGhlbHBlci5nZXRfZGV2aWNlX2luZm8oKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGV2aWNlX2luZm8gYW5kICJzdGF0dXMiIGluIGRldmljZV9pbmZvIGFuZCBkZXZpY2VfaW5mb1sic3RhdHVzIl0gPT0gInN1Y2Nlc3MiOgogICAgICAgICAgICAgICAgZGF0YSA9IGRldmljZV9pbmZvLmdldCgiZGF0YSIsIHt9KQogICAgICAgICAgICAgICAgYW5kcm9pZF9pZCA9IGRhdGEuZ2V0KCJhbmRyb2lkX2lkIiwgIiIpCiAgICAgICAgICAgICAgICBpZiBhbmRyb2lkX2lkOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBhbmRyb2lkX2lkCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbOG6pXkgZGV2aWNlX2lkIHThu6sgaGVscGVyOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgCiAgICBkZWYgbWlncmF0ZV9nb2xpa2VfY29uZmlnKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgWMOzYSBjw6FjIGPhuqV1IGjDrG5oIEdvTGlrZSB0csO5bmcgbOG6t3Aga2jDtG5nIGPDsm4gY+G6p24gdGhp4bq/dAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHByaW50KCLEkGFuZyB4w7NhIGPhuqV1IGjDrG5oIEdvTGlrZSB0csO5bmcgbOG6t3AuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIGvhur90IG7hu5FpIERCCiAgICAgICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRGFuaCBzw6FjaCBjw6FjIGtleSBj4bqnbiB4w7NhCiAgICAgICAgICAgIGtleXNfdG9fZGVsZXRlID0gWwogICAgICAgICAgICAgICAgImdvbGlrZV9oZWFkZXJzIiwgCiAgICAgICAgICAgICAgICAiZ29saWtlX2hlYWRlcnNfdXBkYXRlZCIsCiAgICAgICAgICAgICAgICAiZ29saWtlX2FwaV9iYXNlIgogICAgICAgICAgICBdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgY8OhYyBrZXkgdHLDuW5nIGzhurdwIGPFqQogICAgICAgICAgICBkZWxldGVkX2NvdW50ID0gMAogICAgICAgICAgICBmb3Iga2V5IGluIGtleXNfdG9fZGVsZXRlOgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGNvbmZpZyBXSEVSRSBrZXkgPSA/IiwgKGtleSwpKQogICAgICAgICAgICAgICAgZGVsZXRlZF9jb3VudCArPSBjdXJzb3Iucm93Y291bnQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ29tbWl0IHRoYXkgxJHhu5VpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYixJDDoyB4w7NhIHtkZWxldGVkX2NvdW50fSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB4w7NhIGPhuqV1IGjDrG5oIEdvTGlrZSB0csO5bmcgbOG6t3A6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKCiAgICBkZWYgc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGluYWN0aXZlX3JlYXNvbjogc3RyID0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiKSAtPiBib29sOgogICAgICAgICIiIsSQ4bq3dCB0w6BpIGtob+G6o24gdsOgbyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIMSR4bq/biBnaeG7nSByZXNldCB0aeG6v3AgdGhlbyBob+G6t2Mgc2Vzc2lvbl9jb29sZG93bl9taW51dGVzIChjaOG7jW4gbmfhuq9uIGjGoW4pIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUsIGNvbmZpZywgdGltZQogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEdp4budIHJlc2V0IHbDoCBzZXNzaW9uIGNvb2xkb3duIC0gc+G7rSBk4bulbmcgZGFpbHlfcmVzZXRfaG91ciB0aGF5IHbDrCBqb2JfaG91cgogICAgICAgICAgICBkYWlseV9yZXNldF9ob3VyID0gc2VsZi5nZXQoImRhaWx5X3Jlc2V0X2hvdXIiLCA3KSAgIyBN4bq3YyDEkeG7i25oIDdoIHPDoW5nCiAgICAgICAgICAgIHNlc3Npb25fY29vbGRvd25fbWludXRlcyA9IHNlbGYuZ2V0KCJzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0aOG7nWkgZ2lhbiDEkeG6v24gbMO6YyByZXNldCB0aeG6v3AgdGhlbwogICAgICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbm93LnJlcGxhY2UoaG91cj1kYWlseV9yZXNldF9ob3VyLCBtaW51dGU9MCwgc2Vjb25kPTAsIG1pY3Jvc2Vjb25kPTApCiAgICAgICAgICAgIGlmIG5vdyA+PSBuZXh0X3Jlc2V0OgogICAgICAgICAgICAgICAgbmV4dF9yZXNldCA9IG5leHRfcmVzZXQgKyBkYXRldGltZS50aW1lZGVsdGEoZGF5cz0xKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBz4buRIHBow7p0IHThu6sgYsOieSBnaeG7nSDEkeG6v24gbMO6YyByZXNldAogICAgICAgICAgICB0aW1lX3RvX3Jlc2V0X21pbnV0ZXMgPSBpbnQoKG5leHRfcmVzZXQgLSBub3cpLnRvdGFsX3NlY29uZHMoKSAvIDYwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7jW4gdGjhu51pIGdpYW4gbmfhuq9uIGjGoW4gZ2nhu69hIHRpbWVfdG9fcmVzZXQgdsOgIHNlc3Npb25fY29vbGRvd25fbWludXRlcwogICAgICAgICAgICBkaXNhYmxlX21pbnV0ZXMgPSBtaW4odGltZV90b19yZXNldF9taW51dGVzLCBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMpCiAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gaW50KHRpbWUudGltZSgpICsgZGlzYWJsZV9taW51dGVzICogNjApCiAgICAgICAgICAgIAogICAgICAgICAgICBwcmludChmIltEQl0gVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgYWNjb3VudF9pZCl9OiB0aOG7nWkgZ2lhbiDEkeG6v24gcmVzZXQgPSB7dGltZV90b19yZXNldF9taW51dGVzfSBwaMO6dCwgY29vbGRvd24gPSB7c2Vzc2lvbl9jb29sZG93bl9taW51dGVzfSBwaMO6dCwgY2jhu41uID0ge2Rpc2FibGVfbWludXRlc30gcGjDunQiKQogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGpvYl9kaXNhYmxlX3VudGlsLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogaW5hY3RpdmVfcmVhc29uLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltEQl0gTOG7l2kgc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlKHNlbGYsIGFjY291bnRfaWQ6IGludCwgY29vbGRvd25fbWludXRlczogaW50ID0gTm9uZSwgaW5hY3RpdmVfcmVhc29uOiBzdHIgPSAixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdHJvbmcgcGhpw6puIikgLT4gYm9vbDoKICAgICAgICAiIiLEkOG6t3QgdMOgaSBraG/huqNuIHbDoG8gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB0cm9uZyBraG/huqNuZyB0aOG7nWkgZ2lhbiAocGjDunQpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgdGltZSwgY29uZmlnCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgaWYgY29vbGRvd25fbWludXRlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZ2V0KCJzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIFPhu60gZOG7pW5nIGNvb2xkb3duX21pbnV0ZXMgbeG6t2MgxJHhu4tuaDoge2Nvb2xkb3duX21pbnV0ZXN9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBT4butIGThu6VuZyBjb29sZG93bl9taW51dGVzIMSRxrDhu6NjIHRydXnhu4FuIHbDoG86IHtjb29sZG93bl9taW51dGVzfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGludCh0aW1lLnRpbWUoKSArIGNvb2xkb3duX21pbnV0ZXMgKiA2MCkKICAgICAgICAgICAgcHJpbnQoZiJbREJdIFNldCBhY2NvdW50IGluYWN0aXZlOiBjb29sZG93bl9taW51dGVzPXtjb29sZG93bl9taW51dGVzfSwgam9iX2Rpc2FibGVfdW50aWw9e2pvYl9kaXNhYmxlX3VudGlsfSwgY3VycmVudF90aW1lPXtpbnQodGltZS50aW1lKCkpfSIpCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJpbmFjdGl2ZSIsCiAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBqb2JfZGlzYWJsZV91bnRpbCwKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGluYWN0aXZlX3JlYXNvbiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIGRpc2FibGVfYWNjb3VudF9mb2xsb3coc2VsZiwgYWNjb3VudF9pZDogaW50LCBwZW5hbHR5X2hvdXJzOiBpbnQgPSBOb25lLCBwZW5hbHR5X21pbnV0ZXM6IGludCA9IE5vbmUsIHJlYXNvbjogc3RyID0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3ciKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIERpc2FibGUgZm9sbG93IGNobyB0w6BpIGtob+G6o24gdHJvbmcgbeG7mXQga2hv4bqjbmcgdGjhu51pIGdpYW4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcGVuYWx0eV9ob3VyczogU+G7kSBnaeG7nSBkaXNhYmxlIGZvbGxvdyAoxrB1IHRpw6puIHRo4bqlcCBoxqFuIHBlbmFsdHlfbWludXRlcykKICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzOiBT4buRIHBow7p0IGRpc2FibGUgZm9sbG93ICjGsHUgdGnDqm4gY2FvIGjGoW4gcGVuYWx0eV9ob3VycykKICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gZGlzYWJsZSBmb2xsb3cKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHRpbWUKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgSUQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyDGr3UgdGnDqm4gcGVuYWx0eV9taW51dGVzLCBu4bq/dSBraMO0bmcgY8OzIHRow6wgZMO5bmcgcGVuYWx0eV9ob3VycwogICAgICAgICAgICBpZiBwZW5hbHR5X21pbnV0ZXMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0b3RhbF9taW51dGVzID0gcGVuYWx0eV9taW51dGVzCiAgICAgICAgICAgICAgICBkaXNwbGF5X3VuaXQgPSBmIntwZW5hbHR5X21pbnV0ZXN9IHBow7p0IgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIFPhu60gZOG7pW5nIHBlbmFsdHlfbWludXRlczoge3BlbmFsdHlfbWludXRlc30iKQogICAgICAgICAgICBlbGlmIHBlbmFsdHlfaG91cnMgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0b3RhbF9taW51dGVzID0gcGVuYWx0eV9ob3VycyAqIDYwCiAgICAgICAgICAgICAgICBkaXNwbGF5X3VuaXQgPSBmIntwZW5hbHR5X2hvdXJzfSBnaeG7nSIKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBT4butIGThu6VuZyBwZW5hbHR5X2hvdXJzOiB7cGVuYWx0eV9ob3Vyc30gLT4ge3RvdGFsX21pbnV0ZXN9IHBow7p0IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTeG6t2MgxJHhu4tuaCAxMiBnaeG7nSA9IDcyMCBwaMO6dAogICAgICAgICAgICAgICAgdG90YWxfbWludXRlcyA9IDcyMAogICAgICAgICAgICAgICAgZGlzcGxheV91bml0ID0gIjcyMCBwaMO6dCAobeG6t2MgxJHhu4tuaCkiCiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gU+G7rSBk4bulbmcgbeG6t2MgxJHhu4tuaDoge3RvdGFsX21pbnV0ZXN9IHBow7p0IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvbGxvd19kaXNhYmxlX3VudGlsID0gaW50KHRpbWUudGltZSgpKSArIHRvdGFsX21pbnV0ZXMgKiA2MAogICAgICAgICAgICBwcmludChmIltEQl0gRGlzYWJsZSBmb2xsb3c6IHRvdGFsX21pbnV0ZXM9e3RvdGFsX21pbnV0ZXN9LCBmb2xsb3dfZGlzYWJsZV91bnRpbD17Zm9sbG93X2Rpc2FibGVfdW50aWx9LCBjdXJyZW50X3RpbWU9e2ludCh0aW1lLnRpbWUoKSl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogVHJ1ZSwKICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IGZvbGxvd19kaXNhYmxlX3VudGlsLAogICAgICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiByZWFzb24sCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIHByaW50KGYiW0RCXSDEkMOjIGRpc2FibGUgZm9sbG93IGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCBhY2NvdW50X2lkKX0gdHJvbmcge2Rpc3BsYXlfdW5pdH0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RCXSBM4buXaSBkaXNhYmxlX2FjY291bnRfZm9sbG93OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZW5hYmxlX2FjY291bnRfZm9sbG93KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBFbmFibGUgbOG6oWkgZm9sbG93IGNobyB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgSUQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBGYWxzZSwKICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBwcmludChmIltEQl0gxJDDoyBlbmFibGUgZm9sbG93IGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCBhY2NvdW50X2lkKX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RCXSBM4buXaSBlbmFibGVfYWNjb3VudF9mb2xsb3c6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZSAKCiAgICBkZWYgZ2V0X2FjY291bnRzX2J5X2FwcF9hbmRfZ29saWtlX3N0YXR1cyhzZWxmLCBhcHA6IHN0ciwgaXNfbGlua2VkOiBib29sID0gRmFsc2UpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIHRoZW8gYXBwIHbDoCB0cuG6oW5nIHRow6FpIGdvbGlrZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcDogVMOqbiDhu6luZyBk4bulbmcgKGluc3RhZ3JhbSwgdGlrdG9rLCAuLi4pCiAgICAgICAgICAgIGlzX2xpbmtlZDogVHJ1ZSBu4bq/dSBs4bqleSB0w6BpIGtob+G6o24gxJHDoyBsacOqbiBr4bq/dCwgRmFsc2UgbuG6v3UgbOG6pXkgdMOgaSBraG/huqNuIGNoxrBhIGxpw6puIGvhur90CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHF1ZXJ5ID0gIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgYXBwID0gPyBBTkQgaXNfZ29saWtlX2xpbmtlZCA9ID8iCiAgICAgICAgcGFyYW1zID0gW2FwcCwgMSBpZiBpc19saW5rZWQgZWxzZSAwXQogICAgICAgIAogICAgICAgICMgTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaQogICAgICAgIGN1cnJlbnRfZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgaWYgY3VycmVudF9kZXZpY2VfaWQ6CiAgICAgICAgICAgIHF1ZXJ5ICs9ICIgQU5EIGRldmljZV9pZCA9ID8iCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoY3VycmVudF9kZXZpY2VfaWQpCiAgICAgICAgCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHBhcmFtcykKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICBhY2NvdW50cyA9IFtdCiAgICAgICAgZm9yIHJlc3VsdCBpbiByZXN1bHRzOgogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgICAgICBhY2NvdW50ID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICAgICAgYWNjb3VudFsiaXNfbG9naW4iXSA9IGJvb2woYWNjb3VudFsiaXNfbG9naW4iXSkKICAgICAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgICAgIGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSA9IGJvb2woYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdKQogICAgICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBib29sKGFjY291bnRbImlzX3N5bmMiXSkKICAgICAgICAgICAgIyBMdcO0biBsdcO0biDEkeG7gyBkaXNhYmxlX2ZvbGxvdyA9IEZhbHNlIHbDrCDEkcOjIGLhu48gZ2nhu5tpIGjhuqFuIGZvbGxvdwogICAgICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50cwogICAgCiAgICBkZWYgZ2V0X2FjY291bnRfY2FyZV9kYXRhKHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gZGljdDoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBjYXJlIGRhdGEgY+G7p2EgdMOgaSBraG/huqNuIGTGsOG7m2kgZOG6oW5nIGRpY3QKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgZGljdDogQ2FyZSBkYXRhIGhv4bq3YyBkaWN0IHLhu5duZyBu4bq/dSBjaMawYSBjw7MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qoc2VsZi5kYl9wYXRoKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGNhcmVfZGF0YSBGUk9NIGFjY291bnRzIFdIRVJFIGlkID0gPyIsIChhY2NvdW50X2lkLCkpCiAgICAgICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0IGFuZCByZXN1bHRbMF06CiAgICAgICAgICAgICAgICBpbXBvcnQganNvbgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZHMocmVzdWx0WzBdKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBs4bqleSBjYXJlIGRhdGEgY2hvIGFjY291bnQge2FjY291bnRfaWR9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4ge30KICAgIAogICAgZGVmIHVwZGF0ZV9hY2NvdW50X2NhcmVfZGF0YShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGNhcmVfZGF0YTogZGljdCk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGNhcmUgZGF0YSBjaG8gdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGNhcmVfZGF0YTogRGljdGlvbmFyeSBjaOG7qWEgdGjDtG5nIHRpbiBjYXJlCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQganNvbgogICAgICAgICAgICBjYXJlX2pzb24gPSBqc29uLmR1bXBzKGNhcmVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qoc2VsZi5kYl9wYXRoKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJVUERBVEUgYWNjb3VudHMgU0VUIGNhcmVfZGF0YSA9ID8sIGlzX3N5bmMgPSAwIFdIRVJFIGlkID0gPyIsIAogICAgICAgICAgICAgICAgKGNhcmVfanNvbiwgYWNjb3VudF9pZCkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGPhuq1wIG5o4bqtdCBjYXJlIGRhdGEgY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGPhuq1wIG5o4bqtdCBjYXJlIGRhdGEgY2hvIGFjY291bnQge2FjY291bnRfaWR9OiB7ZX0iKQogICAgCiAgICBkZWYgbWVyZ2VfYWNjb3VudF9jYXJlX2RhdGEoc2VsZiwgYWNjb3VudF9pZDogaW50LCBuZXdfZGF0YTogZGljdCk6CiAgICAgICAgIiIiCiAgICAgICAgTWVyZ2UgZOG7ryBsaeG7h3UgbeG7m2kgdsOgbyBjYXJlIGRhdGEgaGnhu4duIGPDswogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBuZXdfZGF0YTogRGljdGlvbmFyeSBjaOG7qWEgZOG7ryBsaeG7h3UgbeG7m2kgY+G6p24gbWVyZ2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgY2FyZSBkYXRhIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X2RhdGEgPSBzZWxmLmdldF9hY2NvdW50X2NhcmVfZGF0YShhY2NvdW50X2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBNZXJnZSBk4buvIGxp4buHdSBt4bubaQogICAgICAgICAgICBjdXJyZW50X2RhdGEudXBkYXRlKG5ld19kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbOG6oWkKICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudF9jYXJlX2RhdGEoYWNjb3VudF9pZCwgY3VycmVudF9kYXRhKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbWVyZ2UgY2FyZSBkYXRhIGNobyBhY2NvdW50IHthY2NvdW50X2lkfToge2V9IikKICAgIAogICAgZGVmIGdldF9hY2NvdW50X2xhc3RfcG9zdF90aW1lKHNlbGYsIGFjY291bnRfaWQ6IGludCwgYXBwOiBzdHIpIC0+IE9wdGlvbmFsW2ludF06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gxJHEg25nIGLDoGkgZ+G6p24gbmjhuqV0IGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhcHA6IFTDqm4gYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIE9wdGlvbmFsW2ludF06IFRpbWVzdGFtcCBj4bunYSBs4bqnbiDEkcSDbmcgYsOgaSBn4bqnbiBuaOG6pXQsIE5vbmUgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJTRUxFQ1QgbGFzdF9wb3N0X3RpbWUgRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8gQU5EIGFwcCA9ID8iLAogICAgICAgICAgICAgICAgKGFjY291bnRfaWQsIGFwcCkKICAgICAgICAgICAgKQogICAgICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdFswXSBpZiByZXN1bHQgYW5kIHJlc3VsdFswXSBlbHNlIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBs4bqleSBsYXN0X3Bvc3RfdGltZSBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBzZXRfYWNjb3VudF9sYXN0X3Bvc3RfdGltZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGFwcDogc3RyLCBwb3N0X3RpbWU6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjhu51pIGdpYW4gxJHEg25nIGLDoGkgZ+G6p24gbmjhuqV0IGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhcHA6IFTDqm4gYXBwCiAgICAgICAgICAgIHBvc3RfdGltZTogVGltZXN0YW1wIGPhu6dhIGzhuqduIMSRxINuZyBiw6BpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiVVBEQVRFIGFjY291bnRzIFNFVCBsYXN0X3Bvc3RfdGltZSA9ID8gV0hFUkUgaWQgPSA/IEFORCBhcHAgPSA/IiwKICAgICAgICAgICAgICAgIChwb3N0X3RpbWUsIGFjY291bnRfaWQsIGFwcCkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gY3Vyc29yLnJvd2NvdW50ID4gMAogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGPhuq1wIG5o4bqtdCBsYXN0X3Bvc3RfdGltZSBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiB1cGRhdGVfYWxsX2FjY291bnRzX3VzZXJfaWQoc2VsZiwgdXNlcl9pZDogc3RyKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHVzZXJfaWQgY2hvIHThuqV0IGPhuqMgYWNjb3VudHMgaGnhu4duIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVzZXJfaWQ6IFVzZXIgSUQgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogU+G7kSBsxrDhu6NuZyBhY2NvdW50cyDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdAogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdXNlcl9pZCBjaG8gdOG6pXQgY+G6oyBhY2NvdW50cwogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgIFVQREFURSBhY2NvdW50cyAKICAgICAgICAgICAgICAgIFNFVCB1c2VyX2lkID0gPywgCiAgICAgICAgICAgICAgICAgICAgbGFzdF91cGRhdGUgPSA/LAogICAgICAgICAgICAgICAgICAgIGlzX3N5bmMgPSAwCiAgICAgICAgICAgICAgICBXSEVSRSB1c2VyX2lkIElTIE5VTEwgT1IgdXNlcl9pZCAhPSA/CiAgICAgICAgICAgICIiIiwgKHVzZXJfaWQsIGludCh0aW1lLnRpbWUoKSksIHVzZXJfaWQpKQogICAgICAgICAgICAKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICB1cGRhdGVkX2NvdW50ID0gY3Vyc29yLnJvd2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICBwcmludChmIsSQw6MgY+G6rXAgbmjhuq10IHVzZXJfaWQgY2hvIHt1cGRhdGVkX2NvdW50fSBhY2NvdW50cyIpCiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkX2NvdW50CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10IHVzZXJfaWQgY2hvIHThuqV0IGPhuqMgYWNjb3VudHM6IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gMAo=').decode('utf-8'))
