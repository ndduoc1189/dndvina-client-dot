import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgZGF0ZQppbXBvcnQgcmFuZG9tCmltcG9ydCBqc29uCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsCmltcG9ydCBjb25maWcKaW1wb3J0IHV0aWxzCmZyb20gdXRpbHMgaW1wb3J0IExvZ0xldmVsLCBMb2dnZXIKZnJvbSBqb2JzIGltcG9ydCBUaWt0b2tKb2IsIFRpa3RvazJKb2IsIEluc3RhZ3JhbUpvYiwgWW91dHViZUpvYgpmcm9tIHNlcnZpY2VzLnByb3h5X3NlcnZpY2UgaW1wb3J0IFByb3h5U2VydmljZQoKIyBU4bqhbyBsb2dnZXIgY2hvIE1haW5TZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIk1haW5TZXJ2aWNlIikKCiMgQ29uc3RhbnRzIGNobyBNYWluU2VydmljZQpjbGFzcyBNYWluU2VydmljZUNvbnN0YW50czoKICAgICIiIkNvbnN0YW50cyBkw7luZyB0cm9uZyBNYWluU2VydmljZSIiIgogICAgREVGQVVMVF9DSEVDS19JTlRFUlZBTCA9IDAuNSAgIyBTbGVlcCBjaGVjayBpbnRlcnZhbCB0w61uaCBi4bqxbmcgZ2nDonkKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIEPDoWMgbG/huqFpIGjDoG5oIMSR4buZbmcKICAgIEFDVElPTl9ORVdTRkVFRCA9ICJuZXdzZmVlZCIgICAgICAgICAgICMgVnXhu5F0IGLhuqNuZyB0aW4KICAgIEFDVElPTl9SRUVMUyA9ICJyZWVscyIgICAgICAgICAgICAgICAgICMgWGVtIHJlZWxzL3ZpZGVvCiAgICBBQ1RJT05fTk9USUZJQ0FUSU9OID0gIm5vdGlmaWNhdGlvbiIgICAgIyBYZW0gdGjDtG5nIGLDoW8KICAgIEFDVElPTl9QUk9GSUxFID0gInByb2ZpbGUiICAgICAgICAgICAgICMgWGVtIHByb2ZpbGUKICAgIEFDVElPTl9KT0IgPSAiam9iIiAgICAgICAgICAgICAgICAgICAgICMgTMOgbSBqb2IKICAgIEFDVElPTl9FWFBMT1JFID0gImV4cGxvcmUiICAgICAgICAgICAgICMgS2jDoW0gcGjDoQogICAgQUNUSU9OX1NFQVJDSCA9ICJzZWFyY2giICAgICAgICAgICAgICAgIyBUw6xtIGtp4bq/bQogICAgCiAgICAjIFThu4kgbOG7hyBow6BuaCDEkeG7mW5nIG3hurdjIMSR4buLbmggKCUpIC0gREVQUkVDQVRFRDogQWN0aW9uIHByb2Nlc3NpbmcgbW92ZWQgdG8gSm9iQmFzZSBoYW5kbGVycwogICAgIyBFYWNoIGFwcCBub3cgZGVmaW5lcyBpdHMgb3duIGFjdGlvbiB3ZWlnaHRzIHZpYSBnZXRfYWN0aW9uX3dlaWdodHMoKSBtZXRob2QKICAgIERFRkFVTFRfQUNUSU9OX1dFSUdIVFMgPSB7CiAgICAgICAgQUNUSU9OX05FV1NGRUVEOiAxNSwgICAgICAjIDE1JSB2deG7kXQgbmV3c2ZlZWQKICAgICAgICBBQ1RJT05fUkVFTFM6IDIwLCAgICAgICAgICMgMjAlIHhlbSByZWVscwogICAgICAgIEFDVElPTl9OT1RJRklDQVRJT046IDEwLCAgICMgMTAlIHhlbSBub3RpZmljYXRpb24KICAgICAgICBBQ1RJT05fUFJPRklMRTogMTUsICAgICAgICMgMTUlIHhlbSBwcm9maWxlCiAgICAgICAgQUNUSU9OX0pPQjogMjAsICAgICAgICAgICAjIDIwJSBsw6BtIGpvYgogICAgICAgIEFDVElPTl9FWFBMT1JFOiA1LCAgICAgICAgIyA1JSBraMOhbSBwaMOhCiAgICAgICAgQUNUSU9OX1NFQVJDSDogMTUgICAgICAgICAjIDE1JSB0w6xtIGtp4bq/bQogICAgICAgICMgTm90ZTogQXBwcyBtYXkgZGVmaW5lIGFkZGl0aW9uYWwgYWN0aW9ucyAoZS5nLiwgVGlrVG9rICJsaXZlIiwgSW5zdGFncmFtICJzdG9yeSIpCiAgICB9CiAgICAKICAgICMgU3RhdHVzIG1lc3NhZ2VzCiAgICBNU0dfREVWSUNFX1BBVVNFRF9TRVJWRVIgPSAiVOG6oW0gZOG7q25nIChTZXZlciB5w6p1IGPhuqd1KSIKICAgIE1TR19ERVZJQ0VfTk9fQUNDT1VOVFMgPSAiVOG6oW0gbmdo4buJIChLaMO0bmcgY8OzIHTDoGkga2hv4bqjbikiCiAgICBNU0dfV0FJVElOR19QUk9YWSA9ICLEkGFuZyBjaOG7nSBwcm94eSIKICAgIE1TR19XT1JLSU5HX0hBUk1PTklPVVMgPSAixJBhbmcgbMOgbSB2aeG7h2MgaMOgaSBow7JhIgogICAgTVNHX0NBUklOR19BQ0NPVU5UID0gIsSQYW5nIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIgogICAgTVNHX0RPSU5HX0pPQiA9ICLEkGFuZyBsw6BtIGpvYiIKICAgIAogICAgIyBDYXJlIGFjdGlvbiBsaW1pdHMgcGVyIHNlc3Npb24KICAgIE1BWF9DQVJFX0FDVElPTlNfUEVSX1NFU1NJT04gPSA1ICAgICMgVOG7kWkgxJFhIDUgaMOgbmggxJHhu5luZyBjYXJlIHRyxrDhu5tjIGtoaSBsw6BtIGpvYgogICAgCiAgICAjIFNlc3Npb24gbGltaXRzIGFuZCByZXN0IHBlcmlvZHMgLSBz4bq9IGzhuqV5IHThu6sgZGF0YWJhc2UvYWNjb3VudCBjb25maWcKICAgICMgTUFYX0FDVElPTlNfUEVSX1NFU1NJT04gc+G6vSDEkcaw4bujYyB0w61uaCDEkeG7mW5nIGThu7FhIHRyw6puIG1heF9qb2JzX3Blcl9zZXNzaW9uIAogICAgIyBNQVhfSk9CU19QRVJfU0VTU0lPTiBz4bq9IMSRxrDhu6NjIGzhuqV5IHThu6sgYWNjb3VudC5tYXhfam9ic19wZXJfc2Vzc2lvbgogICAgIyBNQVhfU0VTU0lPTl9EVVJBVElPTiBz4bq9IMSRxrDhu6NjIGzhuqV5IHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICBERUZBVUxUX01BWF9BQ1RJT05TX1BFUl9TRVNTSU9OID0gMzAgICAjIE3hurdjIMSR4buLbmggMzAgYWN0aW9ucyB04buRaSDEkWEKICAgIERFRkFVTFRfTUFYX1NFU1NJT05fRFVSQVRJT04gPSAxODAwICAgICMgTeG6t2MgxJHhu4tuaCAzMCBwaMO6dCBu4bq/dSBraMO0bmcgY8OzIGNvbmZpZwogICAgTUlOX1JFU1RfQkVUV0VFTl9BQ0NPVU5UUyA9IDYwICAgICAgICAgIyBOZ2jhu4kgdOG7kWkgdGhp4buDdSAxIHBow7p0IGdp4buvYSBjw6FjIGFjY291bnQKICAgIE1BWF9SRVNUX0JFVFdFRU5fQUNDT1VOVFMgPSAzMDAgICAgICAgICMgTmdo4buJIHThu5FpIMSRYSA1IHBow7p0IGdp4buvYSBjw6FjIGFjY291bnQKICAgIAogICAgIyBHaeG7m2kgaOG6oW4gYWN0aW9ucyBjaG8gZHluYW1pYyBjYWxjdWxhdGlvbgogICAgTUlOX0FDVElPTlNfUEVSX1NFU1NJT04gPSA4ICAgICAgICAgICAgIyBU4buRaSB0aGnhu4N1IDggYWN0aW9ucyBkw7kgYWNjb3VudHMgw610CiAgICBNQVhfQUNUSU9OU19QRVJfU0VTU0lPTiA9IDMwICAgICAgICAgICAjIEdp4bubaSBo4bqhbiB04buRaSDEkWEgMzAgYWN0aW9ucyBjaG8gbeG7l2kgc2Vzc2lvbiAoa2jDtG5nIHTDrW5oIHThu6sgam9iKQogICAgCiAgICAjIFRocmVzaG9sZHMgxJHhu4MgcXV54bq/dCDEkeG7i25oIGNodXnhu4NuIGFjY291bnQKICAgIFNXSVRDSF9BQ0NPVU5UX0FGVEVSX0NPTlNFQ1VUSVZFX0ZBSUxTID0gMyAgIyBDaHV54buDbiBhY2NvdW50IHNhdSAzIGzhuqduIHRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AKICAgIFNXSVRDSF9BQ0NPVU5UX0FGVEVSX05PX0pPQlMgPSA1ICAgICAgICAgICAgIyBDaHV54buDbiBhY2NvdW50IHNhdSA1IGzhuqduIGtow7RuZyBjw7Mgam9iIGxpw6puIHRp4bq/cAoKY2xhc3MgTWFpblNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfc2VydmljZSwgaGVscGVyX3NlcnZpY2UsIGdvbGlrZV9zZXJ2aWNlLCBtcXR0X3NlcnZpY2U9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIE1haW5TZXJ2aWNlIC0gU2VydmljZSB0w61jaCBo4bujcCBjaMSDbSBzw7NjIHbDoCBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgKGNvbmZpZyDEkeG7mWMgbOG6rXApCiAgICAgICAgc2VsZi5lbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICAjIExvY2sgxJHhu4MgxJHhu5NuZyBi4buZIHRy4bqhbmcgdGjDoWkKICAgICAgICBzZWxmLl9sb2NrID0gdGhyZWFkaW5nLkxvY2soKQogICAgICAgIAogICAgICAgICMgRGljdGlvbmFyeSDEkeG7gyDEkeG6v20gc+G7kSBow6BuaCDEkeG7mW5nIGNhcmUgdHJvbmcgc2Vzc2lvbgogICAgICAgIHNlbGYuY2FyZV9hY3Rpb25fY291bnRzID0ge30gICMge2FjY291bnRfaWQ6IGNvdW50fQogICAgICAgIAogICAgICAgICMgRGljdGlvbmFyeSDEkeG7gyBsxrB1IGzhu4tjaCBz4butIGjDoG5oIMSR4buZbmcgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5ID0ge30gICMge2FjY291bnRfaWQ6IFthY3Rpb25zXX0KICAgICAgICAKICAgICAgICAjIFNlc3Npb24gbWFuYWdlbWVudCBwZXIgYWNjb3VudAogICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9ucyA9IHt9ICAjIHthY2NvdW50X2lkOiBzZXNzaW9uX2RhdGF9CiAgICAgICAgCiAgICAgICAgIyBUcmFjayBjb25zZWN1dGl2ZSBmYWlsdXJlcyBwZXIgYWNjb3VudAogICAgICAgIHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlcyA9IHt9ICAjIHthY2NvdW50X2lkOiBjb3VudH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIGNvbnNlY3V0aXZlIG5vLWpvYiBhdHRlbXB0cyBwZXIgYWNjb3VudAogICAgICAgIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMgPSB7fSAgIyB7YWNjb3VudF9pZDogY291bnR9CiAgICAgICAgCiAgICAgICAgIyBBY2NvdW50IHJlc3QgcGVyaW9kcyAtIERFUFJFQ0FURUQ6IG5vdyB1c2luZyBEQiBzdGF0dXMgPSBpbmFjdGl2ZSArIGpvYl9kaXNhYmxlX3VudGlsCiAgICAgICAgIyBzZWxmLmFjY291bnRfbGFzdF93b3JrX3RpbWUgPSB7fSAgIyB7YWNjb3VudF9pZDogdGltZXN0YW1wfQogICAgICAgICMgc2VsZi5hY2NvdW50X3Jlc3RfdW50aWwgPSB7fSAgIyB7YWNjb3VudF9pZDogdGltZXN0YW1wfQogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gbGnDqm4gdGnhur9wIGtow7RuZyB0w6xtIHRo4bqleSBqb2IKICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJHhu4MgdHLDoW5oIHJlc2V0IElQIHByb3h5IGxpw6puIHThu6VjCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBUcmFjayB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIMSRYW5nIMSRxINuZyBuaOG6rXAgdGhlbyBhcHAKICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzID0ge30gICMge2FwcF9uYW1lOiBhY2NvdW50X2lkfQogICAgICAgIAogICAgICAgICMgRmxhZyDEkeG7gyB0cmFjayB4ZW0gxJHDoyB2ZXJpZnkgY3VycmVudCBhY2NvdW50IGNoxrBhIGtoaSBraOG7n2kgxJHhu5luZyAoZ2nhu5FuZyBKb2JTZXJ2aWNlKQogICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkID0ge30gICMge2FwcF9uYW1lOiBib29sfQogICAgICAgIAogICAgICAgICMgVHJhY2sgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBUcmFjayBjb25zZWN1dGl2ZSBuby1qb2IgYXR0ZW1wdHMgcGVyIGFjY291bnQgKHThu6sgSm9iU2VydmljZSkKICAgICAgICBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzID0ge30gICMge2FjY291bnRfaWQ6IGNvdW50fQogICAgICAgIAogICAgZGVmIF9nZXRfYWNjb3VudF9zZXNzaW9uX2xpbWl0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIGludF06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZ2nhu5tpIGjhuqFuIHNlc3Npb24gY2hvIGFjY291bnQgdOG7qyBkYXRhYmFzZSBjb25maWcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBTZXNzaW9uIGxpbWl0cyBjaG8gYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBtYXhfam9ic19wZXJfc2Vzc2lvbiB04burIGFjY291bnQgY29uZmlnIGhv4bq3YyBjb25maWcucHkKICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOtbmggbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gxJHhu5luZyBk4buxYSB0csOqbiBtYXhfam9ic19wZXJfc2Vzc2lvbiB2w6AgYXBwIGNvbmZpZwogICAgICAgICAgICBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiA9IHNlbGYuX2NhbGN1bGF0ZV9keW5hbWljX2FjdGlvbnNfbGltaXQobWF4X2pvYnNfcGVyX3Nlc3Npb24sIGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IG1heF9zZXNzaW9uX2R1cmF0aW9uIHThu6sgZGF0YWJhc2UgY29uZmlnICh0w61uaCBi4bqxbmcgcGjDunQsIGNodXnhu4NuIHRow6BuaCBnacOieSkKICAgICAgICAgICAgbWF4X3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoIm1heF9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMiLCBNYWluU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX01BWF9TRVNTSU9OX0RVUkFUSU9OIC8vIDYwKQogICAgICAgICAgICBtYXhfc2Vzc2lvbl9kdXJhdGlvbiA9IG1heF9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMgKiA2MAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ2lkJyl9OiBtYXhfam9icz17bWF4X2pvYnNfcGVyX3Nlc3Npb259LCBjYWxjdWxhdGVkX21heF9hY3Rpb25zPXttYXhfYWN0aW9uc19wZXJfc2Vzc2lvbn0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IG1heF9qb2JzX3Blcl9zZXNzaW9uLAogICAgICAgICAgICAgICAgIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIjogbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24sCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb24iOiBtYXhfc2Vzc2lvbl9kdXJhdGlvbgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHNlc3Npb24gbGltaXRzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAgICAgIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIjogTWFpblNlcnZpY2VDb25zdGFudHMuTUFYX0FDVElPTlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb24iOiBNYWluU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX01BWF9TRVNTSU9OX0RVUkFUSU9OCiAgICAgICAgICAgIH0KICAgIAogICAgZGVmIF9jYWxjdWxhdGVfZHluYW1pY19hY3Rpb25zX2xpbWl0KHNlbGYsIG1heF9qb2JzX3Blcl9zZXNzaW9uOiBpbnQsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldID0gTm9uZSkgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIFTDrW5oIHRvw6FuIGR5bmFtaWMgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gZOG7sWEgdHLDqm4gYXBwIGNvbmZpZyBob+G6t2MgbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICAKICAgICAgICBMb2dpYzoKICAgICAgICAtIMavdSB0acOqbiBs4bqleSBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiB04burIGFwcCBjb25maWcKICAgICAgICAtIE7hur91IGtow7RuZyBjw7MgdGjDrCB0w61uaCB0b8OhbiBk4buxYSB0csOqbiBtYXhfam9ic19wZXJfc2Vzc2lvbiB24bubaSByYXRpbwogICAgICAgIC0gw4FwIGThu6VuZyBnaeG7m2kgaOG6oW4gdOG7kWkgdGhp4buDdQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uOiBT4buRIGpvYnMgdOG7kWkgxJFhIHRyb25nIHNlc3Npb24KICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHhu4MgbOG6pXkgY29uZmlnIGFwcCBj4bulIHRo4buDIChvcHRpb25hbCkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBT4buRIGFjdGlvbnMgdOG7kWkgxJFhIHTDrW5oIHRvw6FuIMSRxrDhu6NjCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGdp4bubaSBo4bqhbiB04burIGFwcCBjb25maWcgbuG6v3UgY8OzIGFjY291bnQKICAgICAgICAgICAgaWYgYWNjb3VudDoKICAgICAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGFwcF9jb25maWcgPSBoYW5kbGVyLmdldF9hcHBfY29uZmlnKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IG1pbl9hY3Rpb25zIHThu6sgYXBwIGNvbmZpZwogICAgICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gYXBwX2NvbmZpZy5nZXQoIm1pbl9hY3Rpb25zX3Blcl9zZXNzaW9uIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTUlOX0FDVElPTlNfUEVSX1NFU1NJT04pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyDGr1UgVEnDik46IEzhuqV5IG1heF9hY3Rpb25zIHRy4buxYyB0aeG6v3AgdOG7qyBhcHAgY29uZmlnCiAgICAgICAgICAgICAgICAgICAgYXBwX21heF9hY3Rpb25zID0gYXBwX2NvbmZpZy5nZXQoIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIikKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbWF4X2FjdGlvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpbmFsX2FjdGlvbnMgPSBtYXgobWluX2FjdGlvbnMsIGFwcF9tYXhfYWN0aW9ucykKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU+G7rSBk4bulbmcgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gdOG7qyB7YXBwX25hbWV9IGNvbmZpZzoge2ZpbmFsX2FjdGlvbnN9IikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZpbmFsX2FjdGlvbnMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBcHAge2FwcF9uYW1lfSBraMO0bmcgY8OzIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uLCB0w61uaCB0b8OhbiDEkeG7mW5nIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBGYWxsYmFjayB24buBIGNvbnN0YW50cwogICAgICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gTWFpblNlcnZpY2VDb25zdGFudHMuTUlOX0FDVElPTlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJGYWxsYmFjayB24buBIGNvbnN0YW50czogbWluPXttaW5fYWN0aW9uc30iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIGFjY291bnQsIGTDuW5nIGNvbnN0YW50cwogICAgICAgICAgICAgICAgbWluX2FjdGlvbnMgPSBNYWluU2VydmljZUNvbnN0YW50cy5NSU5fQUNUSU9OU19QRVJfU0VTU0lPTgogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0b8OhbiBhY3Rpb25zIGPhuqduIHRoaeG6v3QgZOG7sWEgdHLDqm4gc+G7kSBqb2JzIChmYWxsYmFjaykKICAgICAgICAgICAgZGVmYXVsdF9yYXRpbyA9IDIuNQogICAgICAgICAgICBjYWxjdWxhdGVkX2FjdGlvbnMgPSBpbnQobWF4X2pvYnNfcGVyX3Nlc3Npb24gKiBkZWZhdWx0X3JhdGlvKQogICAgICAgICAgICBtYXhfYWN0aW9ucyA9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1BWF9BQ1RJT05TX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMOBcCBk4bulbmcgZ2nhu5tpIGjhuqFuIHThu5FpIHRoaeG7g3UgdsOgIHThu5FpIMSRYQogICAgICAgICAgICBmaW5hbF9hY3Rpb25zID0gbWF4KG1pbl9hY3Rpb25zLCBtaW4oY2FsY3VsYXRlZF9hY3Rpb25zLCBtYXhfYWN0aW9ucykpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJEeW5hbWljIGFjdGlvbnMgY2FsY3VsYXRpb246IHttYXhfam9ic19wZXJfc2Vzc2lvbn0gam9icyAqIHtkZWZhdWx0X3JhdGlvfSByYXRpbyA9IHtjYWxjdWxhdGVkX2FjdGlvbnN9IOKGkiBmaW5hbDoge2ZpbmFsX2FjdGlvbnN9IChtaW46IHttaW5fYWN0aW9uc30sIG1heDoge21heF9hY3Rpb25zfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGZpbmFsX2FjdGlvbnMKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjYWxjdWxhdGUgZHluYW1pYyBhY3Rpb25zIGxpbWl0OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTWFpblNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9NQVhfQUNUSU9OU19QRVJfU0VTU0lPTgogICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Jlc3RfZHVyYXRpb24oc2VsZikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSB04burIGNvbmZpZyBkYXRhYmFzZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogVGjhu51pIGdpYW4gbmdo4buJIG5nxqFpIChnacOieSkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgam9iX2Nvb2xkb3duX21pbnV0ZXMgdOG7qyBkYXRhYmFzZSBjb25maWcKICAgICAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImpvYl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ29udmVydCBwaMO6dCB0aMOgbmggZ2nDonkKICAgICAgICAgICAgYmFzZV9kdXJhdGlvbiA9IGNvb2xkb3duX21pbnV0ZXMgKiA2MAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSByYW5kb20gdHJvbmcga2hv4bqjbmcgwrEyMCUgbmjGsG5nIGdp4bubaSBo4bqhbiBo4bujcCBsw70KICAgICAgICAgICAgdmFyaWF0aW9uID0gaW50KGJhc2VfZHVyYXRpb24gKiAwLjIpCiAgICAgICAgICAgIG1pbl9kdXJhdGlvbiA9IG1heChNYWluU2VydmljZUNvbnN0YW50cy5NSU5fUkVTVF9CRVRXRUVOX0FDQ09VTlRTLCBiYXNlX2R1cmF0aW9uIC0gdmFyaWF0aW9uKQogICAgICAgICAgICBtYXhfZHVyYXRpb24gPSBtaW4oTWFpblNlcnZpY2VDb25zdGFudHMuTUFYX1JFU1RfQkVUV0VFTl9BQ0NPVU5UUyAqIDYsIGJhc2VfZHVyYXRpb24gKyB2YXJpYXRpb24pICAjIENobyBwaMOpcCB04buRaSDEkWEgMzAgcGjDunQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIG1pbiA8PSBtYXgKICAgICAgICAgICAgaWYgbWluX2R1cmF0aW9uID49IG1heF9kdXJhdGlvbjoKICAgICAgICAgICAgICAgIG1pbl9kdXJhdGlvbiA9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1JTl9SRVNUX0JFVFdFRU5fQUNDT1VOVFMKICAgICAgICAgICAgICAgIG1heF9kdXJhdGlvbiA9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1BWF9SRVNUX0JFVFdFRU5fQUNDT1VOVFMKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3RfZHVyYXRpb24gPSByYW5kb20ucmFuZGludChtaW5fZHVyYXRpb24sIG1heF9kdXJhdGlvbikKICAgICAgICAgICAgcmV0dXJuIHJlc3RfZHVyYXRpb24KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBnZXQgcmVzdCBkdXJhdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHJhbmRvbS5yYW5kaW50KAogICAgICAgICAgICAgICAgTWFpblNlcnZpY2VDb25zdGFudHMuTUlOX1JFU1RfQkVUV0VFTl9BQ0NPVU5UUywKICAgICAgICAgICAgICAgIE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1BWF9SRVNUX0JFVFdFRU5fQUNDT1VOVFMKICAgICAgICAgICAgKQogICAgCiAgICBkZWYgX2dldF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBz4buRIGzGsOG7o25nIGjDoG5oIMSR4buZbmcgY2FyZSDEkcOjIHRo4buxYyBoaeG7h24gdHJvbmcgc2Vzc2lvbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFPhu5EgaMOgbmggxJHhu5luZyBjYXJlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLmdldChhY2NvdW50X2lkLCAwKQogICAgCiAgICBkZWYgX2luY3JlbWVudF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIFTEg25nIHPhu5EgbMaw4bujbmcgaMOgbmggxJHhu5luZyBjYXJlIGNobyB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBzZWxmLmNhcmVfYWN0aW9uX2NvdW50c1thY2NvdW50X2lkXSA9IHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICBsb2dnZXIuZGVidWcoZiJDYXJlIGFjdGlvbiBjb3VudCBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH06IHtzZWxmLmNhcmVfYWN0aW9uX2NvdW50c1thY2NvdW50X2lkXX0iKQogICAgCiAgICBkZWYgX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCk6CiAgICAgICAgIiIiCiAgICAgICAgUmVzZXQgc+G7kSBsxrDhu6NuZyBow6BuaCDEkeG7mW5nIGNhcmUgduG7gSAwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5jYXJlX2FjdGlvbl9jb3VudHNbYWNjb3VudF9pZF0gPSAwCiAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgY2FyZSBhY3Rpb24gY291bnQgY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgIAogICAgZGVmIF9jaG9vc2VfcmFuZG9tX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIENo4buNbiBow6BuaCDEkeG7mW5nIHRow7RuZyBxdWEgSm9iQmFzZSBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBMb+G6oWkgaMOgbmggxJHhu5luZyDEkcaw4bujYyBjaOG7jW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSwgZMO5bmcgZGVmYXVsdCBhY3Rpb24iKQogICAgICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9ORVdTRkVFRAogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBKb2JCYXNlIMSR4buDIGNo4buNbiBhY3Rpb24gdGhlbyBjb25maWcKICAgICAgICAgICAgY2hvc2VuX2FjdGlvbiA9IGhhbmRsZXIuY2hvb3NlX3dlaWdodGVkX2FjdGlvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJKb2JCYXNlIGNo4buNbiBhY3Rpb24gJ3tjaG9zZW5fYWN0aW9ufScgY2hvIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgIHJldHVybiBjaG9zZW5fYWN0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2jhu41uIGFjdGlvbiBxdWEgSm9iQmFzZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9ORVdTRkVFRCAgIyBGYWxsYmFjawogICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIHNlc3Npb24gY+G7p2EgYWNjb3VudCB04burIERCIChwZXJzaXN0ZW50IHNlc3Npb24pCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Q6IFNlc3Npb24gZGF0YSB04burIERCCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGFjY291bnQgZGF0YSBt4bubaSBuaOG6pXQgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2FjY291bnRfaWR9IHRyb25nIERCIikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXJ0X3RpbWUnOiB0aW1lLnRpbWUoKSwKICAgICAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnam9iX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnY2FyZV9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2xhc3RfYWN0aW9uX3RpbWUnOiB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBhY3Rpb25fY291bnQgdsOgIGNhcmVfY291bnQgdOG7qyBjw6FjIGZpZWxkIERCIGhp4buHbiBjw7MKICAgICAgICAgICAgam9iX2NvdW50ID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgY2FyZV9jb3VudCA9IGFjY291bnQuZ2V0KCJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiIsIDApICAjIFPhur0gdGjDqm0gZmllbGQgbsOgeQogICAgICAgICAgICBhY3Rpb25fY291bnQgPSBqb2JfY291bnQgKyBjYXJlX2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrW5oIHN0YXJ0X3RpbWU6IE7hur91IHNlc3Npb24gY2jGsGEgY8OzIHN0YXJ0X3RpbWUgdHJvbmcgbWVtb3J5IHRow6wgdOG6oW8gbeG7m2kKICAgICAgICAgICAgIyBLSMOUTkcgZMO5bmcgbGFzdF9qb2JfdGltZSB2w6wgxJHDsyBsw6AgdGjhu51pIMSRaeG7g20gam9iIGN14buRaSAoY8OzIHRo4buDIGPFqSkKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnMgYW5kICdzdGFydF90aW1lJyBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF06CiAgICAgICAgICAgICAgICAjIETDuW5nIHN0YXJ0X3RpbWUgdOG7qyBtZW1vcnkgc2Vzc2lvbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF1bJ3N0YXJ0X3RpbWUnXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBU4bqhbyBzdGFydF90aW1lIG3hu5tpIGNobyBzZXNzaW9uIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAnc3RhcnRfdGltZSc6IHN0YXJ0X3RpbWUsCiAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogYWN0aW9uX2NvdW50LAogICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IGpvYl9jb3VudCwKICAgICAgICAgICAgICAgICdjYXJlX2NvdW50JzogY2FyZV9jb3VudCwKICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDYWNoZSB2w6BvIG1lbW9yeSDEkeG7gyB0csOhbmggcXVlcnkgbGnDqm4gdOG7pWMKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gc2Vzc2lvbl9kYXRhCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gc2Vzc2lvbl9kYXRhCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IGFjY291bnQgc2Vzc2lvbiB04burIERCOiB7ZX0iKQogICAgICAgICAgICAjIEZhbGxiYWNrIHbhu4EgbWVtb3J5IHNlc3Npb24KICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBub3QgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50LCBhY3Rpb25fdHlwZTogc3RyLCBzdWNjZXNzOiBib29sKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgc2Vzc2lvbiBkYXRhIGPhu6dhIGFjY291bnQgdsOgbyBEQiAocGVyc2lzdGVudCBzZXNzaW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY3Rpb25fdHlwZTogTG/huqFpIGjDoG5oIMSR4buZbmcKICAgICAgICAgICAgc3VjY2VzczogVGjDoG5oIGPDtG5nIGhheSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGF0YSBoaeG7h24gdOG6oWkgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2FjY291bnRfaWR9IMSR4buDIHVwZGF0ZSBzZXNzaW9uIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0b8OhbiBjw6FjIGNvdW50ZXJzIG3hu5tpCiAgICAgICAgICAgIGN1cnJlbnRfam9iX2NvdW50ID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgY3VycmVudF9jYXJlX2NvdW50ID0gYWNjb3VudC5nZXQoImNhcmVfYWN0aW9uc19pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgImxhc3RfYWN0aW9uX3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJqb2JzX2RvbmVfaW5fc2Vzc2lvbiJdID0gY3VycmVudF9qb2JfY291bnQgKyAxCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgQ2FyZSBhY3Rpb24KICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsiY2FyZV9hY3Rpb25zX2luX3Nlc3Npb24iXSA9IGN1cnJlbnRfY2FyZV9jb3VudCArIDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gREIKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG1lbW9yeSBjYWNoZQogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9mcm9tX21lbW9yeShhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9CIGFuZCBzdWNjZXNzOgogICAgICAgICAgICAgICAgc2Vzc2lvblsnam9iX2NvdW50J10gKz0gMQogICAgICAgICAgICBlbGlmIGFjdGlvbl90eXBlICE9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICBzZXNzaW9uWydjYXJlX2NvdW50J10gKz0gMQogICAgICAgICAgICAKICAgICAgICAgICAgc2Vzc2lvblsnYWN0aW9uX2NvdW50J10gPSBzZXNzaW9uWydqb2JfY291bnQnXSArIHNlc3Npb25bJ2NhcmVfY291bnQnXQogICAgICAgICAgICBzZXNzaW9uWydsYXN0X2FjdGlvbl90aW1lJ10gPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgY29uc2VjdXRpdmUgZmFpbHVyZXMgKHbhuqtuIGTDuW5nIG1lbW9yeSB2w6wga2jDtG5nIGPhuqduIHBlcnNpc3QpCiAgICAgICAgICAgIGlmIG5vdCBzdWNjZXNzOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgIGlmIGFjdGlvbl90eXBlID09IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMuZ2V0KGFjY291bnRfaWQsIDApICsgMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgaWYgYWN0aW9uX3R5cGUgPT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdXBkYXRlIGFjY291bnQgc2Vzc2lvbjoge2V9IikKICAgIAogICAgZGVmIF9nZXRfYWNjb3VudF9zZXNzaW9uX2Zyb21fbWVtb3J5KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgc2Vzc2lvbiB04burIG1lbW9yeSBjYWNoZSAoaGVscGVyIGZ1bmN0aW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBTZXNzaW9uIGRhdGEgdOG7qyBtZW1vcnkKICAgICAgICAiIiIKICAgICAgICBpZiBhY2NvdW50X2lkIG5vdCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXSA9IHsKICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICdqb2JfY291bnQnOiAwLAogICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgJ2xhc3RfYWN0aW9uX3RpbWUnOiB0aW1lLnRpbWUoKQogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgCiAgICBkZWYgX3Jlc2V0X2FjY291bnRfc2Vzc2lvbihzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IHNlc3Npb24gZGF0YSBj4bunYSBhY2NvdW50IHRyb25nIERCCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIHJlc2V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gZGF0YSB0cm9uZyBEQgogICAgICAgICAgICByZXNldF9kYXRhID0gewogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAibGFzdF9hY3Rpb25fdGltZSI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCByZXNldF9kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBtZW1vcnkgY2FjaGUKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHNlc3Npb24gY2hvIGFjY291bnQge2FjY291bnRfaWR9LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBhY2NvdW50IHNlc3Npb246IHtlfSIpCgogICAgZGVmIF9yZXNldF9hY2NvdW50X3Nlc3Npb25fc3RhcnRfdGltZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IGNo4buJIHNlc3Npb24gc3RhcnRfdGltZSDEkeG7gyBi4bqvdCDEkeG6p3Ugc2Vzc2lvbiBt4bubaSBtw6Aga2jDtG5nIG3huqV0IHByb2dyZXNzCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIHJlc2V0IHN0YXJ0X3RpbWUKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVzZXQgbWVtb3J5IGNhY2hlIHNlc3Npb24gc3RhcnRfdGltZQogICAgICAgICAgICBpZiBhY2NvdW50X2lkIGluIHNlbGYuYWNjb3VudF9zZXNzaW9uczoKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXVsnc3RhcnRfdGltZSddID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+UhCBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQge2FjY291bnRfaWR9LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVOG6oW8gbeG7m2kgc2Vzc2lvbiB24bubaSBzdGFydF90aW1lIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+GlSBU4bqhbyBt4bubaSBzZXNzaW9uIGNobyBhY2NvdW50IHthY2NvdW50X2lkfS4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IGFjY291bnQgc2Vzc2lvbiBzdGFydF90aW1lOiB7ZX0iKQoKICAgIGRlZiBfc2V0X2FjY291bnRfcmVzdChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBuZ2jhu4kgbmfGoWkgc+G7rSBk4bulbmcgc3RhdHVzID0gaW5hY3RpdmUgdsOgIGpvYl9kaXNhYmxlX3VudGlsCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIG5naOG7iSBuZ8ahaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0aOG7nWkgZ2lhbiBuZ2jhu4kgdOG7qyBjb25maWcKICAgICAgICAgICAgcmVzdF9taW51dGVzID0gc2VsZi5fZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbigpIC8vIDYwICAjIENvbnZlcnQgc2Vjb25kcyB0byBtaW51dGVzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBjaHXhuqluIGPhu6dhIERhdGFiYXNlU2VydmljZQogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9cmVzdF9taW51dGVzLAogICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiQWNjb3VudCByZXN0OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBkYXRhIHRyb25nIERCCiAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgZiJBY2NvdW50IHJlc3Q6IHtyZWFzb259IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBjb25zZWN1dGl2ZSBjb3VudGVycyAobWVtb3J5KQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSDEkcaw4bujYyDEkeG6t3Qgbmdo4buJIG5nxqFpIHtyZXN0X21pbnV0ZXN9IHBow7p0LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyDEkeG6t3QgYWNjb3VudCB7YWNjb3VudF9pZH0gbmdo4buJIG5nxqFpIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzZXQgYWNjb3VudCByZXN0OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9mb2xsb3dfcGVuYWx0eShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBuZ+G7q25nIGZvbGxvdyB2w6wgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gbmfhu6tuZyBmb2xsb3cKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjhu51pIGdpYW4gcGVuYWx0eSB04burIGNvbmZpZyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50KICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGNodeG6qW4gY+G7p2EgRGF0YWJhc2VTZXJ2aWNlCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLmRpc2FibGVfYWNjb3VudF9mb2xsb3coCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRfaWQsCiAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9cGVuYWx0eV9taW51dGVzLAogICAgICAgICAgICAgICAgcmVhc29uPWYiRm9sbG93IHBlbmFsdHk6IHtyZWFzb259IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSBi4buLIG5n4burbmcgZm9sbG93IHtwZW5hbHR5X21pbnV0ZXN9IHBow7p0LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBuZ+G7q25nIGZvbGxvdyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc2V0IGZvbGxvdyBwZW5hbHR5OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9kYWlseV9saW1pdF9yZWFjaGVkKHNlbGYsIGFjY291bnRfaWQ6IGludCwgcmVhc29uOiBzdHIgPSAiIik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhurd0IGFjY291bnQgdsOgbyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHVudGlsIG5leHQgcmVzZXQga2hpIMSR4bqhdCBnaeG7m2kgaOG6oW4gZGFpbHkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY2h14bqpbiBj4bunYSBEYXRhYmFzZVNlcnZpY2UKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldCgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkRhaWx5IGxpbWl0OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gxJHhuqF0IGdp4bubaSBo4bqhbiBkYWlseSwgbmdo4buJIMSR4bq/biBuZ8OgeSBtYWkuIEzDvSBkbzoge3JlYXNvbn0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIHNldCBkYWlseSBsaW1pdCBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHNldCBkYWlseSBsaW1pdDoge2V9IikKICAgICAgICAKICAgIGRlZiBfYXBwbHlfYXBwcm9wcmlhdGVfcmVzdF90eXBlKHNlbGYsIGFjY291bnRfaWQ6IGludCwgc3dpdGNoX3JlYXNvbjogc3RyLCBzZXNzaW9uOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgw4FwIGThu6VuZyBsb+G6oWkgbmdo4buJIG5nxqFpIHBow7kgaOG7o3AgZOG7sWEgdHLDqm4gbMO9IGRvIHN3aXRjaCBhY2NvdW50CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgYWNjb3VudAogICAgICAgICAgICBzd2l0Y2hfcmVhc29uOiBMw70gZG8gc3dpdGNoCiAgICAgICAgICAgIHNlc3Npb246IFNlc3Npb24gZGF0YQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFBow6JuIGxv4bqhaSBsw70gZG8gdsOgIMOhcCBk4bulbmcgcmVzdCB0eXBlIHBow7kgaOG7o3AKICAgICAgICAgICAgaWYgImRhaWx5IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCkgb3IgIm5nw6B5IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAjIERhaWx5IGxpbWl0IHJlYWNoZWQgLSBpbmFjdGl2ZSB1bnRpbCBuZXh0IHJlc2V0CiAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9kYWlseV9saW1pdF9yZWFjaGVkKGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiAidGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cCIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJjb25zZWN1dGl2ZSIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpOgogICAgICAgICAgICAgICAgIyBDb25zZWN1dGl2ZSBmYWlsdXJlcyAtIGPDsyB0aOG7gyBsw6AgZm9sbG93IHBlbmFsdHkKICAgICAgICAgICAgICAgIGlmICJmb2xsb3ciIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKSBvciAidW5mb2xsb3ciIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9mb2xsb3dfcGVuYWx0eShhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEdlbmVyaWMgc2Vzc2lvbiByZXN0CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbGlmICJraMO0bmcgY8OzIGpvYiIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJubyBqb2IiIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICMgTm8gam9icyBhdmFpbGFibGUgLSBzaG9ydGVyIHJlc3QKICAgICAgICAgICAgICAgIGNvb2xkb3duX25vX2pvYiA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImNvb2xkb3duX2dldF9qb2JfZ29saWtlIiwgMzApICAjIDMwIHBow7p0IG3hurdjIMSR4buLbmgKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPWNvb2xkb3duX25vX2pvYiwKICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJObyBqb2IgY29vbGRvd246IHtzd2l0Y2hfcmVhc29ufSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSBuZ2jhu4kge2Nvb2xkb3duX25vX2pvYn0gcGjDunQgKGtow7RuZyBjw7Mgam9iKSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFNlc3Npb24gY29tcGxldGVkIG5vcm1hbGx5IC0gc3RhbmRhcmQgc2Vzc2lvbiBjb29sZG93bgogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBhcHBseSBhcHByb3ByaWF0ZSByZXN0IHR5cGU6IHtlfSIpCiAgICAgICAgICAgICMgRmFsbGJhY2sgdG8gc3RhbmRhcmQgcmVzdAogICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24pCiAgICAgICAgICAgIAogICAgZGVmIF9lbnN1cmVfYWNjb3VudF9zd2l0Y2hlZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gYWNjb3VudCDEkcaw4bujYyBzd2l0Y2ggdGjhu7FjIHThur8gdHLDqm4gbcOheSAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IEFjY291bnQgY+G6p24gc3dpdGNoCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyBzd2l0Y2ggdGjDoG5oIGPDtG5nIGhv4bq3YyDEkcOjIMSRw7puZyBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBzd2l0Y2gga2jDtG5nIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGN1cnJlbnRfbG9nZ2VkX2luX2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIG5lZWRzX2FjY291bnRfc3dpdGNoID0gY3VycmVudF9sb2dnZWRfaW5faWQgIT0gYWNjb3VudF9pZAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbmVlZHNfYWNjb3VudF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkPhuqduIGNodXnhu4NuIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiBoaeG7h24gdOG6oWkgSUQ9e2N1cnJlbnRfbG9nZ2VkX2luX2lkfSwgY+G6p24gY2h1eeG7g24gc2FuZyBJRD17YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRow7RuZyBiw6FvIGNobyB1c2VyCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGNodXnhu4NuIGFjY291bnQ6IHt1c2VybmFtZX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50CiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc3dpdGNoX3Jlc3VsdCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCdzdWNjZXNzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICByZWFzb24gPSBzd2l0Y2hfcmVzdWx0LmdldCgncmVhc29uJywgJ3Vua25vd24nKQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gc3dpdGNoX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnTOG7l2kga2jDtG5nIHjDoWMgxJHhu4tuaCcpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiByZWFzb24gPT0gJ2FjY291bnRfbm90X2ZvdW5kJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoLCDEkcOhbmggZOG6pXUgbG9nb3V0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGxvZ291dCB2w6Agc3luYyBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fbWFya19hY2NvdW50X2xvZ291dChhY2NvdW50LCAiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nIHNhdSBraGkgc3dpdGNoIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoYWNjb3VudF9pZCwgIkFjY291bnQgc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBD4bqtcCBuaOG6rXQgaXNfbG9naW4gc3RhdHVzIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGluZyBhY2NvdW50IGRhdGEgc2F1IGtoaSBzd2l0Y2ggY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGzDoG0gdmnhu4djOiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVMawxqFuZyB0aMOtY2ggduG7m2kgaW1wbGVtZW50YXRpb24gY8WpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoYWNjb3VudF9pZCwgIkFjY291bnQgc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBD4bqtcCBuaOG6rXQgaXNfbG9naW4gc3RhdHVzIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGluZyBhY2NvdW50IGRhdGEgc2F1IGtoaSBzd2l0Y2ggY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGzDoG0gdmnhu4djOiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSRxINuZyBuaOG6rXAsIGLhu48gcXVhIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBlbnN1cmUgYWNjb3VudCBzd2l0Y2hlZDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfbG9naW5fc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGxvZ2dlZF9pbl9hY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBsb2dpbiBzdGF0dXMgdHJvbmcgREIgc2F1IGtoaSBzd2l0Y2ggYWNjb3VudCB0aMOgbmggY8O0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQ6IElEIGPhu6dhIGFjY291bnQgxJHDoyBsb2dpbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCB04bqldCBj4bqjIGFjY291bnRzIGPhu6dhIGFwcCB24buBIGlzX2xvZ2luID0gRmFsc2UKICAgICAgICAgICAgYXBwX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhcHBfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkgYW5kIGFjY291bnRbImlkIl0gIT0gbG9nZ2VkX2luX2FjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBpc19sb2dpbj1GYWxzZSBjaG8gYWNjb3VudCBJRCB7YWNjb3VudFsnaWQnXX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgYWNjb3VudCBoaeG7h24gdOG6oWkgduG7gSBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU2V0IGlzX2xvZ2luPVRydWUgY2hvIGFjY291bnQgSUQge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdXBkYXRlIGFjY291bnQgbG9naW4gc3RhdHVzOiB7ZX0iKQoKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSBhY2NvdW50IGxvZ291dCB2w6Agc3luYyBs4bqhaSB0cuG6oW5nIHRow6FpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogQWNjb3VudCBi4buLIGxvZ291dAogICAgICAgICAgICByZWFzb246IEzDvSBkbyBsb2dvdXQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgREIKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdmVyaWZpZWQgc3RhdGUKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3ZlcmlmaWVkX3N0YXRlc1thY2NvdW50X2lkXSA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFudXAgc2Vzc2lvbgogICAgICAgICAgICBzZWxmLl9jbGVhbnVwX2FjY291bnRfc2Vzc2lvbl9vbl9sb2dvdXQoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkcOhbmggZOG6pXUgbG9nb3V0IGNobyBhY2NvdW50IHt1c2VybmFtZX06IHtyZWFzb259IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBtYXJrIGFjY291bnQgbG9nb3V0OiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbihzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gbmdo4buJIG5nxqFpIGPhu6dhIGFjY291bnQgdOG7qyBjb25maWcgZGF0YWJhc2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSB0w61uaCBi4bqxbmcgZ2nDonkgKG3hurdjIMSR4buLbmggdOG7qyBqb2JfY29vbGRvd25fbWludXRlcykKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgam9iX2Nvb2xkb3duX21pbnV0ZXMgbmjGsCBKb2JTZXJ2aWNlCiAgICAgICAgICAgIHJlc3RfbWludXRlcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImpvYl9jb29sZG93bl9taW51dGVzIiwgMzApCiAgICAgICAgICAgIHJldHVybiBpbnQocmVzdF9taW51dGVzKSAqIDYwICAjIENvbnZlcnQgbWludXRlcyB0byBzZWNvbmRzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBs4bqleSBhY2NvdW50IHJlc3QgZHVyYXRpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAzMCAqIDYwICAjIERlZmF1bHQgMzAgbWludXRlcwoKICAgIGRlZiBfY2xlYW51cF9hY2NvdW50X3Nlc3Npb25fb25fbG9nb3V0KHNlbGYsIGFjY291bnRfaWQ6IGludCk6CiAgICAgICAgIiIiCiAgICAgICAgQ2xlYW51cCBzZXNzaW9uIGRhdGEga2hpIGxvZ291dCBhY2NvdW50CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gdHJvbmcgREIKICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQsICJBY2NvdW50IGxvZ291dCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHdvcmtpbmcgc3RhdHVzCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgYW5kIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJpZCIpID09IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhciB0cmFja2luZwogICAgICAgICAgICBhcHBfbmFtZSA9IE5vbmUKICAgICAgICAgICAgZm9yIGFwcCwgYWNjX2lkIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGFjY19pZCA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGFwcF9uYW1lID0gYXBwCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFwcF9uYW1lOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHZlcmlmaWVkIHN0YXRlCiAgICAgICAgICAgIHNlbGYuYWNjb3VudF92ZXJpZmllZF9zdGF0ZXNbYWNjb3VudF9pZF0gPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDbGVhbmVkIHVwIHNlc3Npb24gZGF0YSBmb3IgbG9nb3V0IGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjbGVhbnVwIGFjY291bnQgc2Vzc2lvbjoge2V9IikKCiAgICBkZWYgX3Nob3VsZF9yZXNldF9zZXNzaW9uX29uX25ld19kYXkoc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgY8OzIG7Dqm4gcmVzZXQgc2Vzc2lvbiBraGkgcXVhIG5nw6B5IG3hu5tpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6p24gcmVzZXQgc2Vzc2lvbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IHNlc3Npb246CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBsYXN0X2FjdGlvbl90aW1lID0gc2Vzc2lvbi5nZXQoImxhc3RfYWN0aW9uX3RpbWUiLCAwKQogICAgICAgICAgICBpZiBsYXN0X2FjdGlvbl90aW1lID09IDA6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgcXVhIG5nw6B5IG3hu5tpCiAgICAgICAgICAgIGxhc3RfZGF0ZSA9IGRhdGV0aW1lLmZyb210aW1lc3RhbXAobGFzdF9hY3Rpb25fdGltZSkuZGF0ZSgpCiAgICAgICAgICAgIGN1cnJlbnRfZGF0ZSA9IGRhdGV0aW1lLm5vdygpLmRhdGUoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGN1cnJlbnRfZGF0ZSA+IGxhc3RfZGF0ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgcmVzZXQgc2Vzc2lvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9zaG91bGRfc3dpdGNoX2FjY291bnQoc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyBuw6puIGNodXnhu4NuIGFjY291bnQga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG7Dqm4gY2h1eeG7g24gYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIGFjY291bnQKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBzZXNzaW9uIGxpbWl0cyB04burIGNvbmZpZyBkYXRhYmFzZQogICAgICAgICAgICBzZXNzaW9uX2xpbWl0cyA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb25fbGltaXRzKGFjY291bnQpCiAgICAgICAgICAgIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIl0KICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X2pvYnNfcGVyX3Nlc3Npb24iXSAKICAgICAgICAgICAgbWF4X3Nlc3Npb25fZHVyYXRpb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X3Nlc3Npb25fZHVyYXRpb24iXQogICAgICAgICAgICAKICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCkKICAgICAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMS4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gdGjhu51pIGdpYW4gc2Vzc2lvbgogICAgICAgICAgICBzZXNzaW9uX2R1cmF0aW9uID0gY3VycmVudF90aW1lIC0gc2Vzc2lvblsnc3RhcnRfdGltZSddCiAgICAgICAgICAgIGlmIHNlc3Npb25fZHVyYXRpb24gPj0gbWF4X3Nlc3Npb25fZHVyYXRpb246CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9OiDEkMOjIGzDoG0gdmnhu4djIHtzZXNzaW9uX2R1cmF0aW9uLzYwOi4xZn0gcGjDunQsIGPhuqduIG5naOG7iSAobGltaXQ6IHttYXhfc2Vzc2lvbl9kdXJhdGlvbi82MDouMWZ9IHBow7p0KSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBLaeG7g20gdHJhIHPhu5EgbMaw4bujbmcgaMOgbmggxJHhu5luZwogICAgICAgICAgICBpZiBzZXNzaW9uWydhY3Rpb25fY291bnQnXSA+PSBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IMSQw6MgdGjhu7FjIGhp4buHbiB7c2Vzc2lvblsnYWN0aW9uX2NvdW50J119IGjDoG5oIMSR4buZbmcsIGPhuqduIG5naOG7iSAobGltaXQ6IHttYXhfYWN0aW9uc19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDMuIEtp4buDbSB0cmEgc+G7kSBsxrDhu6NuZyBqb2IKICAgICAgICAgICAgaWYgc2Vzc2lvblsnam9iX2NvdW50J10gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9OiDEkMOjIGzDoG0ge3Nlc3Npb25bJ2pvYl9jb3VudCddfSBqb2JzLCBj4bqnbiBuZ2jhu4kgKGxpbWl0OiB7bWF4X2pvYnNfcGVyX3Nlc3Npb259KSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA0LiBLaeG7g20gdHJhIHRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AKICAgICAgICAgICAgY29uc2VjdXRpdmVfZmFpbHVyZXMgPSBzZWxmLmFjY291bnRfY29uc2VjdXRpdmVfZmFpbHVyZXMuZ2V0KGFjY291bnRfaWQsIDApCiAgICAgICAgICAgIGlmIGNvbnNlY3V0aXZlX2ZhaWx1cmVzID49IE1haW5TZXJ2aWNlQ29uc3RhbnRzLlNXSVRDSF9BQ0NPVU5UX0FGVEVSX0NPTlNFQ1VUSVZFX0ZBSUxTOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfToge2NvbnNlY3V0aXZlX2ZhaWx1cmVzfSBs4bqnbiB0aOG6pXQgYuG6oWkgbGnDqm4gdGnhur9wLCBjaHV54buDbiBhY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDUuIEtp4buDbSB0cmEga2jDtG5nIGPDsyBqb2IgbGnDqm4gdGnhur9wCiAgICAgICAgICAgIG5vX2pvYl9hdHRlbXB0cyA9IHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMuZ2V0KGFjY291bnRfaWQsIDApCiAgICAgICAgICAgIGlmIG5vX2pvYl9hdHRlbXB0cyA+PSBNYWluU2VydmljZUNvbnN0YW50cy5TV0lUQ0hfQUNDT1VOVF9BRlRFUl9OT19KT0JTOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfToge25vX2pvYl9hdHRlbXB0c30gbOG6p24ga2jDtG5nIGPDsyBqb2IsIGNodXnhu4NuIGFjY291bnQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNi4gS2nhu4NtIHRyYSBkYWlseSBsaW1pdAogICAgICAgICAgICBkYWlseV9saW1pdCA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDEwMCkgICMgU+G7rSBk4bulbmcgam9iX21heF9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2xpbWl0CiAgICAgICAgICAgIGRhaWx5X2NvdW50ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApICAjIFPhu60gZOG7pW5nIGpvYl90b2RheSB0aGF5IHbDrCBkYWlseV9qb2JfY291bnQKICAgICAgICAgICAgaWYgZGFpbHlfY291bnQgPj0gZGFpbHlfbGltaXQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9OiDEkMOjIMSR4bqhdCBkYWlseSBsaW1pdCAoe2RhaWx5X2NvdW50fS97ZGFpbHlfbGltaXR9KSwgY2h1eeG7g24gYWNjb3VudCIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2hlY2sgc2hvdWxkIHN3aXRjaCBhY2NvdW50OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9pc19hY2NvdW50X3Jlc3Rpbmcoc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGFjY291bnQgY8OzIMSRYW5nIG5naOG7iSBuZ8ahaSBraMO0bmcgKHPhu60gZOG7pW5nIERCIHN0YXR1cykKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkWFuZyBuZ2jhu4kgbmfGoWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHN0YXR1cyA9IGluYWN0aXZlIHbDoCBqb2JfZGlzYWJsZV91bnRpbAogICAgICAgICAgICBpZiBhY2NvdW50LmdldCgic3RhdHVzIikgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsID4gY3VycmVudF90aW1lOgogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gKGpvYl9kaXNhYmxlX3VudGlsIC0gY3VycmVudF90aW1lKSAvIDYwCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gY8OybiBuZ2jhu4kge3JlbWFpbmluZ19taW51dGVzOi4xZn0gcGjDunQiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgSOG6v3QgdGjhu51pIGdpYW4gbmdo4buJLCB04buxIMSR4buZbmcgY2h1eeG7g24gduG7gSBhY3RpdmUgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gbmdo4buJLCBjaHV54buDbiB24buBIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl9kaXNhYmxlX3VudGlsIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgYWNjb3VudCByZXN0OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9nZXRfbmV4dF9hdmFpbGFibGVfYWNjb3VudChzZWxmKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgYWNjb3VudCB0aeG6v3AgdGhlbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgKGtow7RuZyBuZ2jhu4kgbmfGoWkpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgT3B0aW9uYWxbRGljdF06IEFjY291bnQgY8OzIHRo4buDIGzDoG0gdmnhu4djIGhv4bq3YyBOb25lCiAgICAgICAgIiIiCiAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBzZWxmLl9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICAgICAKICAgICAgICAjIEzhu41jIGLhu48gY8OhYyBhY2NvdW50IMSRYW5nIG5naOG7iSBuZ8ahaQogICAgICAgIGF2YWlsYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgZm9yIGFjY291bnQgaW4gd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5faXNfYWNjb3VudF9yZXN0aW5nKGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgYXZhaWxhYmxlX2FjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgIAogICAgICAgIGlmIG5vdCBhdmFpbGFibGVfYWNjb3VudHM6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICAgICAgIyDGr3UgdGnDqm4gYWNjb3VudCBjaMawYSBsw6BtIHZp4buHYyBn4bqnbiDEkcOieQogICAgICAgIGRlZiBzb3J0X2tleShhY2MpOgogICAgICAgICAgICBhY2NfaWQgPSBhY2MuZ2V0KCJpZCIpCiAgICAgICAgICAgIGxhc3Rfd29ya190aW1lID0gc2VsZi5hY2NvdW50X2xhc3Rfd29ya190aW1lLmdldChhY2NfaWQsIDApCiAgICAgICAgICAgIHJldHVybiAoCiAgICAgICAgICAgICAgICBhY2MuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSwgICMgxq91IHRpw6puIMSRw6MgbG9naW4KICAgICAgICAgICAgICAgIC1sYXN0X3dvcmtfdGltZSwgICMgxq91IHRpw6puIGzDonUga2jDtG5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICAtYWNjLmdldCgiam9iX3RvZGF5IiwgMCkgICMgxq91IHRpw6puIMOtdCBqb2IgaMahbiAoZMO5bmcgam9iX3RvZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9jb3VudCkKICAgICAgICAgICAgKQogICAgICAgIAogICAgICAgIGF2YWlsYWJsZV9hY2NvdW50cy5zb3J0KGtleT1zb3J0X2tleSwgcmV2ZXJzZT1UcnVlKQogICAgICAgIHJldHVybiBhdmFpbGFibGVfYWNjb3VudHNbMF0KICAgIAogICAgZGVmIF9yZWNvcmRfYWN0aW9uX2hpc3Rvcnkoc2VsZiwgYWNjb3VudF9pZDogaW50LCBhY3Rpb246IHN0ciwgc3VjY2VzczogYm9vbCk6CiAgICAgICAgIiIiCiAgICAgICAgR2hpIGzhuqFpIGzhu4tjaCBz4butIGjDoG5oIMSR4buZbmcgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGFjdGlvbjogTG/huqFpIGjDoG5oIMSR4buZbmcKICAgICAgICAgICAgc3VjY2VzczogQ8OzIHRow6BuaCBjw7RuZyBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBpZiBhY2NvdW50X2lkIG5vdCBpbiBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3Rvcnk6CiAgICAgICAgICAgIHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXSA9IFtdCiAgICAgICAgCiAgICAgICAgaGlzdG9yeV9lbnRyeSA9IHsKICAgICAgICAgICAgJ2FjdGlvbic6IGFjdGlvbiwKICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBzdWNjZXNzLAogICAgICAgICAgICAndGltZXN0YW1wJzogZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KCkKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdLmFwcGVuZChoaXN0b3J5X2VudHJ5KQogICAgICAgIAogICAgICAgICMgR2nhu68gdOG7kWkgxJFhIDUwIGVudHJpZXMgY2hvIG3hu5dpIGFjY291bnQKICAgICAgICBpZiBsZW4oc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdKSA+IDUwOgogICAgICAgICAgICBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnlbYWNjb3VudF9pZF0gPSBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnlbYWNjb3VudF9pZF1bLTUwOl0KICAgIAogICAgZGVmIHNhZmVfc2xlZXAoc2VsZiwgc2Vjb25kczogZmxvYXQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgU2xlZXAgYW4gdG/DoG4gduG7m2kga2jhuqMgbsSDbmcgYuG7iyBnacOhbiDEkW/huqFuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBzbGVlcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHNsZWVwIGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBmb3JjZSBzdG9wCiAgICAgICAgIiIiCiAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgaWYgbm90IHNlbGYucnVubmluZyBvciBzZWxmLmZvcmNlX3N0b3A6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgdGltZS5zbGVlcChNYWluU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMKQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAKICAgIGRlZiBfdmFsaWRhdGVfYW5kX3VwZGF0ZV9lbmFibGVkX2FwcHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgY+G6rXAgbmjhuq10IGRhbmggc8OhY2ggZW5hYmxlZF9hcHBzIGLhurFuZyBjw6FjaCBsb+G6oWkgYuG7jyBjw6FjIGFwcCBjaMawYSBjw6BpIMSR4bq3dAogICAgICAgIFPhu60gZOG7pW5nIG1hcHBpbmcgdMSpbmggdGhheSB2w6wgdOG6oW8gam9iIGhhbmRsZXJzIHThuqFtIHRo4budaSDEkeG7gyB0csOhbmggY29uZmxpY3QKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaeG7g20gdHJhIHbDoCBj4bqtcCBuaOG6rXQgZGFuaCBzw6FjaCBlbmFibGVkX2FwcHMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBNYXBwaW5nIHTEqW5oIGFwcF9uYW1lIC0+IGFwcF9wYWNrYWdlIChs4bqleSB04burIGPDoWMgam9iIGhhbmRsZXJzKQogICAgICAgICAgICBhcHBfcGFja2FnZXMgPSB7CiAgICAgICAgICAgICAgICAidGlrdG9rIjogImNvbS5zcy5hbmRyb2lkLnVnYy50cmlsbCIsCiAgICAgICAgICAgICAgICAidGlrdG9rMiI6ICJjb20uemhpbGlhb2FwcC5tdXNpY2FsbHkiLCAKICAgICAgICAgICAgICAgICJpbnN0YWdyYW0iOiAiY29tLmluc3RhZ3JhbS5hbmRyb2lkIiwKICAgICAgICAgICAgICAgICJ5b3V0dWJlIjogImNvbS5nb29nbGUuYW5kcm9pZC55b3V0dWJlIgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJyZW50X2VuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICB2YWxpZGF0ZWRfYXBwcyA9IFtdCiAgICAgICAgICAgIHJlbW92ZWRfYXBwcyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gY3VycmVudF9lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYXBwX3BhY2thZ2UgPSBhcHBfcGFja2FnZXMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgYXBwIGPDsyDEkcaw4bujYyBjw6BpIMSR4bq3dCBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuaXNfYXBwX2luc3RhbGxlZChhcHBfcGFja2FnZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZWRfYXBwcy5hcHBlbmQoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLinJMge2FwcF9uYW1lfSAoe2FwcF9wYWNrYWdlfSkgxJHDoyBjw6BpIMSR4bq3dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinJcge2FwcF9uYW1lfSAoe2FwcF9wYWNrYWdlfSkgY2jGsGEgY8OgaSDEkeG6t3QsIHPhur0gYuG7iyBsb+G6oWkgYuG7jyIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgcGFja2FnZSBtYXBwaW5nIGNobyBhcHA6IHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGFwcCB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIHJlbW92ZWRfYXBwcy5hcHBlbmQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgbuG6v3UgY8OzIHRoYXkgxJHhu5VpCiAgICAgICAgICAgIGlmIHJlbW92ZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTG/huqFpIGLhu48ge2xlbihyZW1vdmVkX2FwcHMpfSBhcHAgY2jGsGEgY8OgaSDEkeG6t3Q6IHsnLCAnLmpvaW4ocmVtb3ZlZF9hcHBzKX0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJHaeG7ryBs4bqhaSB7bGVuKHZhbGlkYXRlZF9hcHBzKX0gYXBwIMSRw6MgY8OgaSDEkeG6t3Q6IHsnLCAnLmpvaW4odmFsaWRhdGVkX2FwcHMpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gZGF0YWJhc2UgKGNvbmZpZyDEkeG7mWMgbOG6rXApCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZW5hYmxlZF9hcHBzIiwgdmFsaWRhdGVkX2FwcHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGxvY2FsIGNhY2hlCiAgICAgICAgICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHZhbGlkYXRlZF9hcHBzCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlThuqV0IGPhuqMge2xlbih2YWxpZGF0ZWRfYXBwcyl9IGFwcCB0cm9uZyBlbmFibGVkX2FwcHMgxJHhu4F1IMSRw6MgxJHGsOG7o2MgY8OgaSDEkeG6t3QiKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB2YWxpZGF0ZSBlbmFibGVkX2FwcHM6IHtlfSIpCgogICAgZGVmIGluaXRpYWxpemUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gTWFpblNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSB04bqhbyB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgdOG6oW8gTWFpblNlcnZpY2UuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCBj4bqtcCBuaOG6rXQgZW5hYmxlZF9hcHBzIFRSxq/hu5pDIGtoaSBraOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzCiAgICAgICAgICAgIHNlbGYuX3ZhbGlkYXRlX2FuZF91cGRhdGVfZW5hYmxlZF9hcHBzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jhu59pIHThuqFvIGpvYiBoYW5kbGVycwogICAgICAgICAgICBzZWxmLl9pbml0X2pvYl9oYW5kbGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEto4bufaSB04bqhbyBjb25maWcgbeG6t2MgxJHhu4tuaCBjaG8gY8OhYyBhcHAKICAgICAgICAgICAgc2VsZi5faW5pdF9hcHBfY29uZmlncygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgY8OhYyBjb25maWcgbeG6t2MgxJHhu4tuaAogICAgICAgICAgICBzZWxmLl9zYXZlX2RlZmF1bHRfY29uZmlncygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGRhaWx5IGNvdW50ZXJzIG7hur91IGPhuqduCiAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRmV0Y2ggR29MaWtlIGhlYWRlcnMgdHLGsOG7m2Mga2hpIHN5bmMgYWNjb3VudHMgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Vuc3VyZV9nb2xpa2VfaGVhZGVycygpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyBs4bqleSBHb0xpa2UgaGVhZGVycywgc3luYyBhY2NvdW50cyBz4bq9IGLhu4sgZ2nhu5tpIGjhuqFuIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhu5NuZyBi4buZIGFjY291bnRzIHThu6sgdGhp4bq/dCBi4buLIHbDoCBtYXBwaW5nIEdvTGlrZSAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBzZWxmLl9zeW5jX2FsbF9hY2NvdW50c19hbmRfbWFwcGluZygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtow7RuZyBzeW5jIHRy4bqhbmcgdGjDoWkgbG9naW4gbmdheSBs4bqtcCB04bupYyBuaMawIEpvYlNlcnZpY2UKICAgICAgICAgICAgIyBT4bq9IGxhenkgc3luYyBraGkgY+G6p24gdGhp4bq/dCB0cm9uZyBfZ2V0X25leHRfd29ya2FibGVfYWNjb3VudCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gVHJ1ZQogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2Uga2jhu59pIHThuqFvIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2jhu59pIHThuqFvIE1haW5TZXJ2aWNlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9lbnN1cmVfZ29saWtlX2hlYWRlcnMoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIGPDsyBHb0xpa2UgaGVhZGVycyBoaeG7h24gY8OzIGhheSBraMO0bmcgKGtow7RuZyBmZXRjaCBt4bubaSDEkeG7gyB0csOhbmggYmxvY2tpbmcpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgaGVhZGVycyBo4bujcCBs4buHCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIENo4buJIGtp4buDbSB0cmEgaGVhZGVycyBoaeG7h24gY8OzLCBraMO0bmcgZmV0Y2ggbeG7m2kgxJHhu4MgdHLDoW5oIGJsb2NraW5nIE1haW5TZXJ2aWNlCiAgICAgICAgICAgIHJldHVybiBzZWxmLmdvbGlrZV9zZXJ2aWNlLmlzX2dvbGlrZV9hdXRoZW50aWNhdGVkKCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIEdvTGlrZSBoZWFkZXJzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9zeW5jX2FsbF9hY2NvdW50c19hbmRfbWFwcGluZyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4sgdsOgIG1hcHBpbmcgR29MaWtlIGNobyB04bqldCBj4bqjIGFwcHMgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgxJHhu5NuZyBi4buZIGFjY291bnRzIHbDoCBtYXBwaW5nIEdvTGlrZS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyAxLiDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhu5NuZyBi4buZIHtsZW4oYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIHRow6wgYuG7jyBxdWEgbWFwcGluZwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIMSRxrDhu6NjIMSR4buTbmcgYuG7mSBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgbWFwcGluZyBHb0xpa2UiKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgMi4gTWFwIHTDoGkga2hv4bqjbiBHb0xpa2UgKGNo4buJIGtoaSBjw7MgR29MaWtlIGhlYWRlcnMpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuZ29saWtlX3NlcnZpY2UubmVlZHNfaGVhZGVyc19yZWZyZXNoKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgZ29saWtlX2FjY291bnRzID0gaGFuZGxlci5nZXRfZ29saWtlX2FjY291bnRzKCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGdvbGlrZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSB7bGVuKGdvbGlrZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IHTDoGkga2hv4bqjbiB04burIERCCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgw4FuaCB44bqhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwcGVkX2FjY291bnRzID0gaGFuZGxlci5tYXBfZ29saWtlX2FjY291bnRzKGdvbGlrZV9hY2NvdW50cywgZGV2aWNlX2FjY291bnRzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mgw6FuaCB44bqhIHtsZW4obWFwcGVkX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0gduG7m2kgR29MaWtlIikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBHb0xpa2UgaGVhZGVycyBo4bujcCBs4buHLCBi4buPIHF1YSBtYXBwaW5nIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgxJHhu5NuZyBi4buZIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJIb8OgbiB0aMOgbmggxJHhu5NuZyBi4buZIGFjY291bnRzIHbDoCBtYXBwaW5nIEdvTGlrZSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgxJHhu5NuZyBi4buZIGFjY291bnRzIHbDoCBtYXBwaW5nOiB7ZX0iKQoKICAgIGRlZiBfaW5pdF9qb2JfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIgY2hvIHThu6tuZyBhcHAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgc2VsZi5lbmFibGVkX2FwcHMgxJHDoyDEkcaw4bujYyB2YWxpZGF0ZSB0aGF5IHbDrCBs4bqleSB04burIGRhdGFiYXNlCiAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZW5hYmxlZF9hcHBzCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jhu59pIHThuqFvIGpvYiBoYW5kbGVycyBjaG8gY8OhYyBhcHBzIMSRw6MgdmFsaWRhdGU6IHsnLCAnLmpvaW4oZW5hYmxlZF9hcHBzKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lID09ICJ0aWt0b2siOgogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFRpa3Rva0pvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAidGlrdG9rMiI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rMkpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAiaW5zdGFncmFtIjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBJbnN0YWdyYW1Kb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gInlvdXR1YmUiOgogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFlvdXR1YmVKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJBcHAge2FwcF9uYW1lfSBjaMawYSDEkcaw4bujYyBo4buXIHRy4bujIikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzOiB7ZX0iKQogICAgCiAgICBkZWYgX2luaXRfYXBwX2NvbmZpZ3Moc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gY29uZmlnIG3hurdjIMSR4buLbmggY2hvIHThuqV0IGPhuqMgYXBwcwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyBhcHBzLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jhu59pIHThuqFvIGNvbmZpZyBjaG8gdOG7q25nIGpvYiBoYW5kbGVyCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSwgaGFuZGxlciBpbiBzZWxmLmpvYl9oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBoYW5kbGVyLmluaXRfZGVmYXVsdF9hcHBfY29uZmlnKCkKICAgICAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mga2jhu59pIHThuqFvIGNvbmZpZyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIGNvbmZpZyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2jhu59pIHThuqFvIGNvbmZpZyBjaG8ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gYXBwIGNvbmZpZ3M6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3NhdmVfZGVmYXVsdF9jb25maWdzKHNlbGYpOgogICAgICAgICIiIkzGsHUgY8OhYyBjb25maWcgbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFThuqFvIGdsb2JhbCBjb25maWcgdMawxqFuZyB04buxIEpvYlNlcnZpY2UKICAgICAgICAgICAgZGVmYXVsdF9jb25maWdzID0gewogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBhY3Rpb24gd2VpZ2h0cyBt4bq3YyDEkeG7i25oCiAgICAgICAgICAgICAgICAibWFpbl9zZXJ2aWNlX2FjdGlvbl93ZWlnaHRzIjogTWFpblNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9BQ1RJT05fV0VJR0hUUywKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBkeW5hbWljIGFjdGlvbnMgY2FsY3VsYXRpb24KICAgICAgICAgICAgICAgICJtaW5fYWN0aW9uc19wZXJfc2Vzc2lvbiI6IE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1JTl9BQ1RJT05TX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAgICAgIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIjogTWFpblNlcnZpY2VDb25zdGFudHMuTUFYX0FDVElPTlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggc2Vzc2lvbiBkdXJhdGlvbgogICAgICAgICAgICAgICAgIm1heF9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMiOiBNYWluU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX01BWF9TRVNTSU9OX0RVUkFUSU9OIC8vIDYwLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGNvb2xkb3duIHbDoCByZXN0CiAgICAgICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAgICAgInVuZm9sbG93X3BlbmFsdHlfbWludXRlcyI6IDcyMCwgICMgTeG6t2MgxJHhu4tuaCAxMiBnaeG7nQogICAgICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIDMwIHBow7p0IG3hurdjIMSR4buLbmgga2hpIGtow7RuZyBjw7Mgam9iCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggYXBwcyDEkcaw4bujYyBrw61jaCBob+G6oXQKICAgICAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuqV1IGjDrG5oIHJlc2V0IGRhaWx5CiAgICAgICAgICAgICAgICAibGFzdF9kYWlseV9yZXNldF9kYXRlIjogIiIsCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSB04burbmcgY29uZmlnIG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZ3MuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoa2V5KSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoyBsxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggTWFpblNlcnZpY2U6IHtrZXl9PXt2YWx1ZX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJD4bqldSBow6xuaCBNYWluU2VydmljZSB7a2V5fSDEkcOjIHThu5NuIHThuqFpOiB7c2VsZi5nZXRfZ2xvYmFsX2NvbmZpZyhrZXkpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQw6MgbMawdSBkZWZhdWx0IGNvbmZpZ3MgY2hvIE1haW5TZXJ2aWNlIGR5bmFtaWMgc2Vzc2lvbiBtYW5hZ2VtZW50IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBsxrB1IGRlZmF1bHQgY29uZmlnczoge2V9IikKICAgIAogICAgZGVmIGdldF9nbG9iYWxfY29uZmlnKHNlbGYsIGtleTogc3RyLCBkZWZhdWx0X3ZhbHVlPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGNvbmZpZyB04burIGRhdGFiYXNlIHbhu5tpIGZhbGxiYWNrIHbhu4EgZGVmYXVsdCB2YWx1ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogVMOqbiBjb25maWcgY+G6p24gbOG6pXkKICAgICAgICAgICAgZGVmYXVsdF92YWx1ZTogR2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyB0w6xtIHRo4bqleQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBHacOhIHRy4buLIGNvbmZpZyBob+G6t2MgZGVmYXVsdF92YWx1ZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmRiLmdldChrZXksIGRlZmF1bHRfdmFsdWUpCiAgICAKICAgIGRlZiBfcmVzZXRfZGFpbHlfY291bnRlcnMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgY8OhYyBjb3VudGVyIGjDoG5nIG5nw6B5IG7hur91IGPhuqduIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJyZW50X2RhdGUgPSBkYXRldGltZS5ub3coKS5zdHJmdGltZSgiJVktJW0tJWQiKQogICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJsYXN0X2RhaWx5X3Jlc2V0X2RhdGUiLCAiIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGN1cnJlbnRfZGF0ZSAhPSBsYXN0X3Jlc2V0X2RhdGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IGRhaWx5IGNvdW50ZXJzIGNobyBuZ8OgeSB7Y3VycmVudF9kYXRlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgam9iIGNvdW50ZXJzIC0gbOG6pXkgdOG6pXQgY+G6oyBhY2NvdW50cyAoa2jDtG5nIGZpbHRlcikKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoZGV2aWNlX2lkPUZhbHNlKSAgIyBkZXZpY2VfaWQ9RmFsc2UgxJHhu4Mga2jDtG5nIGZpbHRlciB0aGVvIGRldmljZQogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlkIik6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDAsICAjIFPhu60gZOG7pW5nIGpvYl90b2RheSB0aGF5IHbDrCBkYWlseV9qb2JfY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiAwICAjIFPhu60gZOG7pW5nIGZvbGxvd190b2RheSB0aGF5IHbDrCBkYWlseV9mb2xsb3dfY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IG5nw6B5IHJlc2V0CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9kYWlseV9yZXNldF9kYXRlIiwgY3VycmVudF9kYXRlKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgcmVzZXQgdOG6pXQgY+G6oyBkYWlseSBjb3VudGVycyIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IGRhaWx5IGNvdW50ZXJzOiB7ZX0iKQogICAgCiAgICBkZWYgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGhv4bq3YyBjaMSDbSBzw7NjCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0XTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGFwcF93b3JrYWJsZV9jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIGFwcF93b3JrYWJsZV9jb3VudCArPSAxCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIMSRxrDhu6NjIHtsZW4od29ya2FibGVfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHThu6sge2xlbihlbmFibGVkX2FwcHMpfSBhcHBzIikKICAgICAgICAKICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm4gc+G7rSBk4bulbmcgxJHDum5nIHTDqm4gdHLGsOG7nW5nIGRhdGFiYXNlCiAgICAgICAgd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLCAgIyDGr3UgdGnDqm4gYWNjb3VudCDEkcOjIGxvZ2luCiAgICAgICAgICAgIC14LmdldCgiam9iX3RvZGF5IiwgMCksICAjIMavdSB0acOqbiBhY2NvdW50IMOtdCBqb2IgaMahbiAoZMO5bmcgam9iX3RvZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9jb3VudCkKICAgICAgICAgICAgLXguZ2V0KCJsYXN0X2pvYl90aW1lIiwgMCkgICMgxq91IHRpw6puIGFjY291bnQgbMOidSBraMO0bmcgbMOgbSBqb2IgKHRpbWVzdGFtcCBuZ8aw4bujYykKICAgICAgICApLCByZXZlcnNlPVRydWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHdvcmthYmxlX2FjY291bnRzCiAgICAKICAgIGRlZiBfY2FuX3dvcmtfd2l0aF9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBob+G6t2MgY2jEg20gc8OzYyB24bubaSB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgKMOBcCBk4bulbmcgY2hvIGPhuqMgSk9CIHbDoCBDQVJFKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24KICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCByZXNldCBzZXNzaW9uIG7hur91IHF1YSBuZ8OgeSBt4bubaQogICAgICAgICAgICBpZiBzZWxmLl9zaG91bGRfcmVzZXRfc2Vzc2lvbl9vbl9uZXdfZGF5KGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQsICJOZ8OgeSBt4bubaSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgc3RhdHVzIChz4butIGThu6VuZyBsb2dpYyBuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyBpbiBbImRpc2FibGVkIiwgImxvZ291dCJdOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGluYWN0aXZlLCBraeG7g20gdHJhIGpvYl9kaXNhYmxlX3VudGlsIChnaeG7kW5nIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA+IHRpbWUudGltZSgpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBW4bqrbiDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYl9lbmFibGUgPSAxIChib29sZWFuIGNoZWNrKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBhcHAgY8OzIMSRxrDhu6NjIGVuYWJsZSBraMO0bmcKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDsyBqb2IgaGFuZGxlciBraMO0bmcKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgYWNjb3VudCBjw7MgxJFhbmcgbmdo4buJIG5nxqFpIGtow7RuZwogICAgICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X3Jlc3RpbmcoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtIw5RORyBraeG7g20gdHJhIGlzX2dvbGlrZV9saW5rZWQg4bufIMSRw6J5IC0gxJHhu4MgY2hvIF9jYW5fcnVuX2pvYigpIGNoZWNrCiAgICAgICAgICAgICMgQWNjb3VudCBjw7MgdGjhu4MgxJHGsOG7o2MgY2jEg20gc8OzYyBtw6Aga2jDtG5nIGPhuqduIGxpbmsgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgYWNjb3VudCB3b3JrYWJsZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9jYW5fZG9fam9iX3dpdGhfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdGjhu4MgbMOgbSBKT0IgduG7m2kgdMOgaSBraG/huqNuIGtow7RuZyAocmnDqm5nIGJp4buHdCB24bubaSBjYXJlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgY8ahIGLhuqNuIHRyxrDhu5tjCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGRhaWx5IGpvYiBsaW1pdCAtIHPhu60gZOG7pW5nIGZpZWxkIG5hbWVzIMSRw7puZyBuaMawIERCIHNjaGVtYQogICAgICAgICAgICBkYWlseV9qb2JfY291bnQgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkgICMgRmllbGQgdGjhuq10IHRyb25nIERCCiAgICAgICAgICAgIGRhaWx5X2pvYl9saW1pdCA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApICAjIEZpZWxkIHRo4bqtdCB0cm9uZyBEQgogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IGpvYiBsaW1pdCBjaGVjazogam9iX3RvZGF5PXtkYWlseV9qb2JfY291bnR9LCBqb2JfbWF4X2RheT17ZGFpbHlfam9iX2xpbWl0fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkYWlseV9qb2JfbGltaXQgPiAwIGFuZCBkYWlseV9qb2JfY291bnQgPj0gZGFpbHlfam9iX2xpbWl0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGRhaWx5IGpvYiBsaW1pdCAoe2RhaWx5X2pvYl9jb3VudH0ve2RhaWx5X2pvYl9saW1pdH0pIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFjY291bnQgY8OzIMSRYW5nIHJlc3Rpbmcga2jDtG5nCiAgICAgICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhhY2NvdW50X2lkKToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge3VzZXJuYW1lfSDEkWFuZyByZXN0aW5nIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBHb0xpa2UgbGluayAoY+G6p24gY2hvIGpvYikKICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IGNoxrBhIGxpbmsgR29MaWtlIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IGPDsyB0aOG7gyBsw6BtIGpvYjogam9icz17ZGFpbHlfam9iX2NvdW50fS97ZGFpbHlfam9iX2xpbWl0fSwgZ29saWtlPXthY2NvdW50LmdldCgnaXNfZ29saWtlX2xpbmtlZCcsIEZhbHNlKX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgY2FuIGRvIGpvYjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50KHNlbGYpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0w6BpIGtob+G6o24gdGnhur9wIHRoZW8gY8OzIHRo4buDIGzDoG0gdmnhu4djIHRoZW8gbG9naWMgdOG7kWkgxrB1IHThu6sgSm9iU2VydmljZToKICAgICAgICAxLiBUw6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCAodOG7qyB0cmFja2luZykKICAgICAgICAyLiBUw6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHRoZW8gdGjhu6kgdOG7sSBhcHAsIG5nw6B5IHThuqFvCiAgICAgICAgCiAgICAgICAgQ2jhu4kgdmVyaWZ5IGxvZ2luIHRo4buxYyB04bq/IGtoaSBs4bqnbiDEkeG6p3UgaG/hurdjIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgT3B0aW9uYWxbRGljdF06IFTDoGkga2hv4bqjbiDEkcaw4bujYyBjaOG7jW4gaG/hurdjIE5vbmUKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQsaw4bubYyAxOiBLaeG7g20gdHJhIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IHRyxrDhu5tjCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQ6CiAgICAgICAgICAgICAgICBjdXJyZW50X2lkID0gc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiS2nhu4NtIHRyYSBjdXJyZW50IGFjY291bnQ6IHtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgZGF0YSBt4bubaSBuaOG6pXQgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICAgICAgdXBkYXRlZF9jdXJyZW50X2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGN1cnJlbnRfaWQpCiAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX2N1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGN1cnJlbnQgYWNjb3VudCBjw7MgY8OybiDEkeG7pyDEkWnhu4F1IGtp4buHbiBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgICAgICAgICBjYW5fY29udGludWUgPSAoCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudCh1cGRhdGVkX2N1cnJlbnRfYWNjb3VudCkgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIG5vdCBzZWxmLl9pc19hY2NvdW50X3Jlc3RpbmcoY3VycmVudF9pZCkgYW5kCiAgICAgICAgICAgICAgICAgICAgICAgIG5vdCBzZWxmLl9zaG91bGRfc3dpdGNoX2FjY291bnQoY3VycmVudF9pZCkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgY2FuX2NvbnRpbnVlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUaeG6v3AgdOG7pWMgduG7m2kgY3VycmVudCBhY2NvdW50OiB7Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAjIFVwZGF0ZSB3b3JraW5nIGFjY291bnQgduG7m2kgZGF0YSBt4bubaSBuaOG6pXQKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IHVwZGF0ZWRfY3VycmVudF9hY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1cGRhdGVkX2N1cnJlbnRfYWNjb3VudAogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ3VycmVudCBhY2NvdW50IHtjdXJyZW50X3VzZXJuYW1lfSBraMO0bmcgY8OybiBsw6BtIHZp4buHYyDEkcaw4bujYywgdMOsbSBhY2NvdW50IG3hu5tpIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgxJDhurd0IGFjY291bnQgaGnhu4duIHThuqFpIG5naOG7iSBuZ8ahaSBu4bq/dSBj4bqnbgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9zaG91bGRfc3dpdGNoX2FjY291bnQoY3VycmVudF9pZCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihjdXJyZW50X2lkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uID0gZiJTZXNzaW9uIGxpbWl0OiB7c2Vzc2lvblsnYWN0aW9uX2NvdW50J119IGFjdGlvbnMsIHtzZXNzaW9uWydqb2JfY291bnQnXX0gam9icyIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3NldF9hY2NvdW50X3Jlc3QoY3VycmVudF9pZCwgcmVhc29uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG6t3QgYWNjb3VudCB7Y3VycmVudF91c2VybmFtZX0gbmdo4buJIG5nxqFpIC0ge3JlYXNvbn0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkN1cnJlbnQgYWNjb3VudCB7Y3VycmVudF9pZH0ga2jDtG5nIHThu5NuIHThuqFpIHRyb25nIERCIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDI6IFTDrG0gYWNjb3VudCDEkWFuZyDEkcSDbmcgbmjhuq1wIHThu6sgdHJhY2tpbmcgKG5oxrAgSm9iU2VydmljZSkKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgIyBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IGtoaSBs4bqnbiDEkeG6p3UgbMOgbSB2aeG7h2MgduG7m2kgYXBwIG7DoHkgKGNo4buJIGtoaSBj4bqnbikKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgIyBDaOG7iSB2ZXJpZnkga2hpIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gdHJvbmcgdHJhY2tpbmcgaG/hurdjIGtoaSB0cmFja2luZyBraMO0bmcgaOG7o3AgbOG7hwogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBs4bqnbiDEkeG6p3UuLi4iKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShhcHBfbmFtZSwgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJHDoyB0aOG7rSB2ZXJpZnkgxJHhu4Mga2jDtG5nIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBDw7MgdHJhY2tpbmcgcuG7k2ksIGtow7RuZyBj4bqnbiB2ZXJpZnkgbmdheQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB04burIHRyYWNraW5nCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlZF9pbl9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50IGFuZCBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVmVyaWZ5IGFjY291bnQgdGjhu7FjIHThur8gdHLDqm4gYXBwIChxdWFuIHRy4buNbmcgc2F1IGtoaSByZXN0YXJ0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl92ZXJpZnlfYWNjb3VudF9pbl9hcHAoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHbDoCB2ZXJpZmllZCB0w6BpIGtob+G6o24gdOG7qyB0cmFja2luZzoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQgdHJhY2tpbmcge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0ga2jDtG5nIHZlcmlmeSDEkcaw4bujYywgeMOzYSB0cmFja2luZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFZlcmlmeSBmdW5jdGlvbiDEkcOjIHThu7EgxJHhu5luZyB4w7NhIHRyYWNraW5nIHbDoCBzeW5jLCB0aeG6v3AgdOG7pWMgdMOsbSBhY2NvdW50IGtow6FjCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24ga2jDtG5nIGPDsm4gaOG7o3AgbOG7hywgeMOzYSBraOG7j2kgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGxvZ2dlZF9pbl9hY2NvdW50X2lkLCB7ImlzX2xvZ2luIjogRmFsc2UsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7bG9nZ2VkX2luX2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraOG7j2kgdHJhY2tpbmcgZG8ga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDM6IFTDrG0gdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXAgdOG7qyBkYXRhYmFzZSB24bubaSB2ZXJpZmljYXRpb24gdGjhu7FjIHThur8KICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAjIMavdSB0acOqbiB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB04burIERCIC0gc+G7rSBk4bulbmcgZmllbGQgImlzX2xvZ2luIiBuaMawIEpvYlNlcnZpY2UKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkgYW5kIHNlbGYuX2Nhbl93b3JrX3dpdGhfYWNjb3VudChhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgIyBRVUFOIFRS4buMTkc6IFZlcmlmeSB0aOG7sWMgdOG6vyB0csOqbiBhcHAgdHLGsOG7m2Mga2hpIHRpbiB0xrDhu59uZyBEQgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl92ZXJpZnlfYWNjb3VudF9pbl9hcHAoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHbDoCB2ZXJpZmllZCB0w6BpIGtob+G6o24gxJHEg25nIG5o4bqtcDoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0ga2jDtG5nIHZlcmlmeSDEkcaw4bujYywgdGnhur9wIHThu6VjIHTDrG0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBWZXJpZnkgc+G6vSB04buxIMSR4buZbmcgc3luYyB2w6AgY+G6rXAgbmjhuq10IHRyYWNraW5nLCB0aeG6v3AgdOG7pWMgduG7m2kgYWNjb3VudCBraMOhYwogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IE7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAsIGzhuqV5IHTDoGkga2hv4bqjbiB0aGVvIHRo4bupIHThu7EKICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gW10KICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjKV0KICAgICAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5leHRlbmQod29ya2FibGVfYWNjb3VudHMpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJLaMO0bmcgY8OzIGFjY291bnQgbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm46IGFwcCBuYW1lLCBjcmVhdGVkX2RhdGUKICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLnNvcnQoCiAgICAgICAgICAgICAgICBrZXk9bGFtYmRhIHg6ICh4LmdldCgiYXBwIiwgIiIpLCB4LmdldCgiY3JlYXRlZF9kYXRlIiwgIiIpKQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqjIHbhu4EgYWNjb3VudCDEkeG6p3UgdGnDqm4KICAgICAgICAgICAgc2VsZWN0ZWRfYWNjb3VudCA9IGFsbF93b3JrYWJsZV9hY2NvdW50c1swXQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNo4buNbiBhY2NvdW50IHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm46IHtzZWxlY3RlZF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7c2VsZWN0ZWRfYWNjb3VudC5nZXQoJ2FwcCcpfSkiKQogICAgICAgICAgICByZXR1cm4gc2VsZWN0ZWRfYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHRyb25nIF9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgIGRlZiBfdmVyaWZ5X2FjY291bnRfaW5fYXBwKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSBhY2NvdW50IHRo4buxYyB04bq/IHRyw6puIGFwcCBjw7MgxJHDum5nIGFjY291bnQgxJFhbmcgbG9naW4gdHJvbmcgREIga2jDtG5nCiAgICAgICAgTuG6v3Uga2jDtG5nIMSRw7puZyB0aMOsIHN5bmMgbOG6oWkgYWNjb3VudCB04burIGFwcCB24buBIERCCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogQWNjb3VudCB04burIERCIGPDsyBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBhY2NvdW50IMSRw7puZyBob+G6t2Mgc3luYyB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGPDsyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgZXhwZWN0ZWRfdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZ5IGFjY291bnQge2V4cGVjdGVkX3VzZXJuYW1lfSB0csOqbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBN4bufIGFwcCB2w6Aga2nhu4NtIHRyYSBhY2NvdW50IGhp4buHbiB04bqhaQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBhcHAgxJHGsOG7o2MgbeG7nwogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnZW5zdXJlX2FwcF9vcGVuJyk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5lbnN1cmVfYXBwX29wZW4oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHVzZXJuYW1lIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIGFwcAogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgbOG6pXkgxJHGsOG7o2MgdXNlcm5hbWUgaGnhu4duIHThuqFpIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgU2V0IGFjY291bnQgduG7gSBpc19sb2dpbiA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7ImlzX2xvZ2luIjogRmFsc2UsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgICMgWMOzYSBraOG7j2kgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBTbyBzw6FuaCB24bubaSBhY2NvdW50IHRyb25nIERCCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lLmxvd2VyKCkgPT0gZXhwZWN0ZWRfdXNlcm5hbWUubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBWZXJpZmllZDogQWNjb3VudCB7ZXhwZWN0ZWRfdXNlcm5hbWV9IMSRw7puZyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4p2MIEFjY291bnQgbWlzbWF0Y2g6IERCPXtleHBlY3RlZF91c2VybmFtZX0sIEFwcD17Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgQ+G6p24gc3luYyBs4bqhaSB04burIGFwcCB24buBIERCCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3N5bmNfYWNjb3VudF9mcm9tX2FwcF90b19kYihhcHBfbmFtZSwgY3VycmVudF91c2VybmFtZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX3ZlcmlmeV9hY2NvdW50X2luX2FwcDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9zeW5jX2FjY291bnRfZnJvbV9hcHBfdG9fZGIoc2VsZiwgYXBwX25hbWU6IHN0ciwgY3VycmVudF91c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFN5bmMgYWNjb3VudCB04burIGFwcCB24buBIERCIGtoaSBwaMOhdCBoaeG7h24gbWlzbWF0Y2gKICAgICAgICBT4butIGThu6VuZyBsb2dpYyB04burIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgY3VycmVudF91c2VybmFtZTogVXNlcm5hbWUgxJFhbmcgbG9naW4gdGjhu7FjIHThur8gdHLDqm4gYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugc3luYyB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgYWNjb3VudCB04burIHthcHBfbmFtZX0gduG7gSBEQi4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMTogU3luYyB04bqldCBj4bqjIGFjY291bnRzIHThu6sgYXBwIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBzeW5jIHtsZW4oYWNjb3VudHMpfSBhY2NvdW50cyB04burIHthcHBfbmFtZX0iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzeW5jIGFjY291bnRzIHThu6sge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDI6IFJlc2V0IHThuqV0IGPhuqMgYWNjb3VudHMgY+G7p2EgYXBwIHbhu4EgaXNfbG9naW4gPSBGYWxzZQogICAgICAgICAgICBhcHBfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFwcF9hY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDM6IFTDrG0gdsOgIGPhuq1wIG5o4bqtdCBhY2NvdW50IMSRYW5nIGxvZ2luIHRo4buxYyB04bq/CiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYXBwX2FjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKS5sb3dlcigpID09IGN1cnJlbnRfdXNlcm5hbWUubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGFjY291bnQgaGnhu4duIHThuqFpIHbhu4EgaXNfbG9naW4gPSBUcnVlCiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGN1cnJlbnRfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gY3VycmVudF9hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIFN5bmMgdGjDoG5oIGPDtG5nOiBBY2NvdW50IHtjdXJyZW50X3VzZXJuYW1lfSDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdCBsb2dpbiBzdGF0dXMiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4p2MIEtow7RuZyB0w6xtIHRo4bqleSBhY2NvdW50IHtjdXJyZW50X3VzZXJuYW1lfSB0cm9uZyBEQiBzYXUgc3luYyIpCiAgICAgICAgICAgICAgICAjIFjDs2EgdHJhY2tpbmcKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc3luYyBhY2NvdW50IHThu6sgYXBwIHbhu4EgREI6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIHRy4bqhbmcgdGjDoWkgbG9naW4gdGjhu7FjIHThur8gdHLDqm4gxJFp4buHbiB0aG/huqFpIHPhu60gZOG7pW5nIGjDoG0gY8OzIHPhurVuIGPhu6dhIGhhbmRsZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgbG9naW4gdGjhu7FjIHThur8gdHLDqm4gxJFp4buHbiB0aG/huqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIGPDsyBz4bq1biDEkeG7gyBjaGVjayBsb2dpbiBzdGF0dXMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQXBwIHthcHBfbmFtZX0gxJHDoyBsb2dpbiB24bubaSB1c2VybmFtZToge2N1cnJlbnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBcHAge2FwcF9uYW1lfSBjaMawYSBsb2dpbiBob+G6t2Mga2jDtG5nIGzhuqV5IMSRxrDhu6NjIHVzZXJuYW1lIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkga2nhu4NtIHRyYSBsb2dpbiBzdGF0dXMgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiBz4butIGThu6VuZyB0cuG6oW5nIHRow6FpIHThu6sgREIKICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdmFsaWRhdGUgYWN0dWFsIGxvZ2luIHN0YXR1czoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfaXNfY29ycmVjdF9hY2NvdW50X2xvZ2dlZF9pbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSDEkcO6bmcgYWNjb3VudCBuw6B5IMSRYW5nIMSRxINuZyBuaOG6rXAgdHLDqm4gxJFp4buHbiB0aG/huqFpIGtow7RuZwogICAgICAgIFPhu60gZOG7pW5nIGjDoG0gZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIGPDsyBz4bq1biBj4bunYSBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcO6bmcgYWNjb3VudCBuw6B5IMSRYW5nIMSRxINuZyBuaOG6rXAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIHRhcmdldF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIGPDsyBz4bq1bgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgaWYgY3VycmVudF91c2VybmFtZSBhbmQgdGFyZ2V0X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGlzX2NvcnJlY3QgPSBjdXJyZW50X3VzZXJuYW1lLmxvd2VyKCkgPT0gdGFyZ2V0X3VzZXJuYW1lLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJDdXJyZW50IGxvZ2dlZDoge2N1cnJlbnRfdXNlcm5hbWV9LCBUYXJnZXQ6IHt0YXJnZXRfdXNlcm5hbWV9LCBNYXRjaDoge2lzX2NvcnJlY3R9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNfY29ycmVjdAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJLaMO0bmcgbOG6pXkgxJHGsOG7o2MgY3VycmVudCB1c2VybmFtZSBob+G6t2MgdGFyZ2V0IHVzZXJuYW1lIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbOG6pXkgY3VycmVudCB1c2VybmFtZSBjaG8ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICMgRmFsbGJhY2s6IGFzc3VtZSBjb3JyZWN0IG7hur91IGtow7RuZyBjaGVjayDEkcaw4bujYwogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2hlY2sgY29ycmVjdCBhY2NvdW50IGxvZ2dlZCBpbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfcGVyZm9ybV9hY2NvdW50X3N3aXRjaChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGNodXnhu4NuIMSR4buVaSB0w6BpIGtob+G6o24gc+G7rSBk4bulbmcgbG9naWMgY8OzIHPhurVuIHRyb25nIGhhbmRsZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbiB04bubaQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGNodXnhu4NuIMSR4buVaSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gc3dpdGNoIHNhbmcgYWNjb3VudCB7dXNlcm5hbWV9IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBjYXJlIGFjdGlvbiBjb3VudGVyIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfY2FyZV9hY3Rpb25fY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGN1cnJlbnQgbG9nZ2VkIGFjY291bnQgdHLGsOG7m2Mga2hpIHN3aXRjaAogICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBzd2l0Y2ggYWNjb3VudCBi4bqxbmcgaGFuZGxlciAtIHPhu60gZOG7pW5nIGjDoG0gY8OzIHPhurVuCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSBzd2l0Y2hfdG9fYWNjb3VudCBjw7Mgc+G6tW4gdHJvbmcgaGFuZGxlcgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnc3dpdGNoX3RvX2FjY291bnQnKToKICAgICAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgWOG7rSBsw70ga+G6v3QgcXXhuqMgc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzd2l0Y2hfcmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgIyBIYW5kbGVyIHRy4bqjIHbhu4EgcmVzdWx0IGRpY3QKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzcyA9IHN3aXRjaF9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBzd2l0Y2hfcmVzdWx0LmdldCgibWVzc2FnZSIsICIiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3dpdGNoIGFjY291bnQgdGjDoG5oIGPDtG5nOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gdHJvbmcgREIgdsOgIHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCwgVHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlN3aXRjaCBhY2NvdW50IHRo4bqldCBi4bqhaToge3VzZXJuYW1lfSAtIHttZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEhhbmRsZXIgdHLhuqMgduG7gSBib29sZWFuIChsZWdhY3kpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN3aXRjaCBhY2NvdW50IHRow6BuaCBjw7RuZzoge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2luIHRyb25nIERCIHbDoCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoYXBwX25hbWUsIGFjY291bnRfaWQsIFRydWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTd2l0Y2ggYWNjb3VudCB0aOG6pXQgYuG6oWk6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgRmFsbGJhY2s6IHPhu60gZOG7pW5nIGVuc3VyZV9hY2NvdW50X2xvZ2dlZF9pbgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkhhbmRsZXIge2FwcF9uYW1lfSBraMO0bmcgY8OzIHN3aXRjaF90b19hY2NvdW50LCBkw7luZyBlbnN1cmVfYWNjb3VudF9sb2dnZWRfaW4iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbnN1cmVfYWNjb3VudF9sb2dnZWRfaW4oYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHN3aXRjaCBhY2NvdW50IHt1c2VybmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcGVyZm9ybSBhY2NvdW50IHN3aXRjaDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9lbnN1cmVfYWNjb3VudF9sb2dnZWRfaW4oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIHTDoGkga2hv4bqjbiDEkcOjIMSRxINuZyBuaOG6rXAgdHLDqm4gYXBwIHbhu5tpIGxvZ2ljIHThu5FpIMawdQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkcSDbmcgbmjhuq1wCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgdGFyZ2V0X3VzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gc3dpdGNoIGFjY291bnQga2jDtG5nCiAgICAgICAgICAgIGN1cnJlbnRfbG9nZ2VkX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgbmVlZHNfYWNjb3VudF9zd2l0Y2ggPSAoY3VycmVudF9sb2dnZWRfYWNjb3VudF9pZCAhPSBhY2NvdW50X2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbmVlZHNfYWNjb3VudF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkPhuqduIGNodXnhu4NuIGFjY291bnQ6IGN1cnJlbnQ9e2N1cnJlbnRfbG9nZ2VkX2FjY291bnRfaWR9IC0+IHRhcmdldD17YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELGsOG7m2MgMjogVmFsaWRhdGUgbOG6oWkgduG7m2kgYXBwIHRo4buxYyB04bq/IHRyxrDhu5tjIGtoaSBzd2l0Y2gKICAgICAgICAgICAgICAgIHNob3VsZF9zd2l0Y2ggPSBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIFThu5BJIMavVTogQ2jhu4kgdmVyaWZ5IGtoaSB0aOG7sWMgc+G7sSBuZ2hpIG5n4budIGPhuqduIHN3aXRjaAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgbWVtb3J5IHRyYWNraW5nIGNobyBiaeG6v3QgxJHDoyDEkcO6bmcgYWNjb3VudCwgc2tpcCB2ZXJpZmljYXRpb24KICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzIGFuZCBcCiAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiTWVtb3J5IHRyYWNraW5nIGNobyBiaeG6v3QgxJHDoyDEkcO6bmcgYWNjb3VudCB7dGFyZ2V0X3VzZXJuYW1lfSwgc2tpcCB2ZXJpZmljYXRpb24iKQogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRfc3dpdGNoID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY3VycmVudCB1c2VybmFtZSB0csOqbiBhcHAgdGjhu7FjIHThur8gc+G7rSBk4bulbmcgaMOgbSBjw7Mgc+G6tW4KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVmVyaWZ5IGN1cnJlbnQgdXNlcm5hbWUgdHLDqm4ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYXBwX3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBjdXJyZW50X2FwcF91c2VybmFtZSBhbmQgY3VycmVudF9hcHBfdXNlcm5hbWUubG93ZXIoKSA9PSB0YXJnZXRfdXNlcm5hbWUubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQXBwIMSRw6MgxJHDum5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSwga2jDtG5nIGPhuqduIHN3aXRjaCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRfc3dpdGNoID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG1lbW9yeSB0cmFja2luZyBjaG8gxJHDum5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQXBwIGhp4buHbiB04bqhaTogJ3tjdXJyZW50X2FwcF91c2VybmFtZX0nLCBj4bqnbiBjaHV54buDbiBzYW5nOiAne3RhcmdldF91c2VybmFtZX0nIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGNoZWNrIGN1cnJlbnQgdXNlcm5hbWU6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgIyBW4bqrbiB0aeG6v3AgdOG7pWMgc3dpdGNoIG7hur91IGtow7RuZyBjaGVjayDEkcaw4bujYwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELGsOG7m2MgMzogVGjhu7FjIGhp4buHbiBzd2l0Y2ggYWNjb3VudCBjaOG7iSBraGkgY+G6p24gdGhp4bq/dAogICAgICAgICAgICAgICAgaWYgc2hvdWxkX3N3aXRjaDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgY2FyZSBhY3Rpb24gY291bnRlciBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfY2FyZV9hY3Rpb25fY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjdXJyZW50IGxvZ2dlZCBhY2NvdW50IHRyxrDhu5tjIGtoaSBzd2l0Y2gKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gc3dpdGNoIGFjY291bnQgLSBoYW5kbGVyIHPhur0gdOG7sSDEkeG6o20gYuG6o28gYXBwIG3hu58KICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSBzd2l0Y2hfdG9fYWNjb3VudCBjw7Mgc+G6tW4gdHJvbmcgaGFuZGxlcgogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBY4butIGzDvSBr4bq/dCBxdeG6oyBzd2l0Y2gKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzd2l0Y2hfcmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0LmdldCgic3VjY2VzcyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlN3aXRjaCBhY2NvdW50IHRo4bqldCBi4bqhaToge3N3aXRjaF9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTd2l0Y2ggYWNjb3VudCB0aOG6pXQgYuG6oWkgY2hvIHt0YXJnZXRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBzd2l0Y2ggYWNjb3VudDoge2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIktow7RuZyBj4bqnbiBzd2l0Y2ggYWNjb3VudCBjaG8ge3RhcmdldF91c2VybmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dGFyZ2V0X3VzZXJuYW1lfSDEkcOjIGzDoCBjdXJyZW50IGxvZ2dlZCBhY2NvdW50IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyA0OiDEkOG6o20gYuG6o28g4bufIGhvbWUgc2NyZWVuIChoYW5kbGVyIHPhur0gdOG7sSBt4bufIGFwcCBu4bq/dSBj4bqnbikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBhYnN0cmFjdCBtZXRob2QgZW5zdXJlX2hvbWVfc2NyZWVuIC0gbsOzIHPhur0gdOG7sSBjaGVjayB2w6AgbeG7nyBhcHAKICAgICAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBob21lIHNjcmVlbiBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJldHVybiB0cuG6oW5nIHRow6FpIGxvZ2luCiAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJIYW5kbGVyIHthcHBfbmFtZX0gY2jGsGEgaW1wbGVtZW50IGFwcCBtYW5hZ2VtZW50IG1ldGhvZHM6IHtlfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgZXhjZXB0IE5vdEltcGxlbWVudGVkRXJyb3IgYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkhhbmRsZXIge2FwcF9uYW1lfSBjaMawYSBpbXBsZW1lbnQgYXBwIG1hbmFnZW1lbnQgbWV0aG9kczoge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGVuc3VyZSBhY2NvdW50IGxvZ2dlZCBpbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfY2FuX3J1bl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIGpvYiBraMO0bmcgKHPhu60gZOG7pW5nIGxvZ2ljIG5oxrAgSm9iU2VydmljZSkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0aOG7gyBsw6BtIGpvYgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyAxLiBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuIChnaeG7kW5nIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyBpbiBbImRpc2FibGVkIiwgImxvZ291dCJdOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGluYWN0aXZlLCBraeG7g20gdHJhIGpvYl9kaXNhYmxlX3VudGlsCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA+IHRpbWUudGltZSgpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBLaeG7g20gdHJhIGpvYl9lbmFibGUKICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJqb2JfZW5hYmxlIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDMuIEtp4buDbSB0cmEgxJHDoyBsacOqbiBr4bq/dCBHb0xpa2UgKGPhuqduIGNobyBqb2JzKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNC4gS2nhu4NtIHRyYSDEkcOjIGxvZ2luCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNS4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gZGFpbHkKICAgICAgICAgICAgZGFpbHlfbGltaXQgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAxMDApICAjIFPhu60gZOG7pW5nIGpvYl9tYXhfZGF5IG5oxrAgSm9iU2VydmljZQogICAgICAgICAgICBkYWlseV9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKSAgIyBT4butIGThu6VuZyBqb2JfdG9kYXkgbmjGsCBKb2JTZXJ2aWNlCiAgICAgICAgICAgIGlmIGRhaWx5X2NvdW50ID49IGRhaWx5X2xpbWl0OgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDYuIEtp4buDbSB0cmEgYXBwIGPDsyDEkcaw4bujYyBlbmFibGUga2jDtG5nCiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBjYW4gcnVuIGpvYjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfd29ya193aXRoX3NpbmdsZV9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzDoG0gdmnhu4djIHbhu5tpIG3hu5l0IHTDoGkga2hv4bqjbiAtIHRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyDEkcaw4bujYyBjaOG7jW4gduG7m2kgbG9naWMgdOG7kWkgxrB1CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraMO0bmcgY8OzIGzhu5dpIG5naGnDqm0gdHLhu41uZyAoYWN0aW9uIGPDsyB0aOG7gyB0aOG6pXQgYuG6oWkgbmjGsG5nIGFjY291bnQgduG6q24g4buVbikKICAgICAgICAgICAgICAgICAgRmFsc2UgY2jhu4kga2hpIGPDsyBs4buXaSBuZ2hpw6ptIHRy4buNbmcgY+G6p24gY2xlYXIgY3VycmVudCBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0IChzYXUgc3dpdGNoKQogICAgICAgICAgICBmcmVzaF9hY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBmcmVzaF9hY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudCA9IGZyZXNoX2FjY291bnQKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGVkIGZyZXNoIGFjY291bnQgZGF0YSBmb3Ige3VzZXJuYW1lfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyByZWxvYWQgYWNjb3VudCBkYXRhIGNobyB7dXNlcm5hbWV9LCBz4butIGThu6VuZyBkYXRhIGPFqSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkcaw4bujYyBzZXQgxJHDum5nCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50IG9yIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJpZCIpICE9IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gYWNjb3VudAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ+G6rXAgbmjhuq10IGN1cnJlbnQgd29ya2luZyBhY2NvdW50OiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiDEkOG6o20gYuG6o28gYWNjb3VudCDEkcaw4bujYyBzd2l0Y2ggdGjhu7FjIHThur8gdHLDqm4gbcOheQogICAgICAgICAgICBpZiBub3Qgc2VsZi5fZW5zdXJlX2FjY291bnRfc3dpdGNoZWQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBzd2l0Y2ggc2FuZyBhY2NvdW50IHt1c2VybmFtZX0sIMSRw6FuaCBk4bqldSBwcm9ibGVtYXRpYyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGFjY291bnQgY8OzIHbhuqVuIMSR4buBIHbDoCBzZXQgbmdo4buJIG5nxqFpCiAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGFjY291bnRfaWQsIGYiU3dpdGNoIGZhaWxlZDogS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgYWNjb3VudCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBM4buXaSBuZ2hpw6ptIHRy4buNbmcsIGNsZWFyIGN1cnJlbnQgYWNjb3VudAogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBhY2NvdW50IGPDsyDEkWFuZyBuZ2jhu4kgbmfGoWkga2jDtG5nCiAgICAgICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfcmVzdGluZyhhY2NvdW50X2lkKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7dXNlcm5hbWV9IMSRYW5nIG5naOG7iSBuZ8ahaSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgS2jDtG5nIHBo4bqjaSBs4buXaSBuZ2hpw6ptIHRy4buNbmcKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu41uIGjDoG5oIMSR4buZbmcgbmfhuqt1IG5oacOqbiB0aMO0bmcgcXVhIEpvYkJhc2UKICAgICAgICAgICAgY2hvc2VuX2FjdGlvbiA9IHNlbGYuX2Nob29zZV9yYW5kb21fYWN0aW9uKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHNlc3Npb24gaW5mbyB2w6AgbGltaXRzIMSR4buDIGhp4buDbiB0aOG7iwogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkKQogICAgICAgICAgICBzZXNzaW9uX2xpbWl0cyA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb25fbGltaXRzKGFjY291bnQpCiAgICAgICAgICAgIHNlc3Npb25faW5mbyA9IGYiKHtzZXNzaW9uWydhY3Rpb25fY291bnQnXX0ve3Nlc3Npb25fbGltaXRzWydtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiddfSBhY3Rpb25zLCAiIFwKICAgICAgICAgICAgICAgICAgICAgICAgICBmIntzZXNzaW9uWydqb2JfY291bnQnXX0ve3Nlc3Npb25fbGltaXRzWydtYXhfam9ic19wZXJfc2Vzc2lvbiddfSBqb2JzKSIKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nICd7Y2hvc2VuX2FjdGlvbn0nIGNobyB7dXNlcm5hbWV9IHtzZXNzaW9uX2luZm99IikKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJ7Y2hvc2VuX2FjdGlvbn06IHt1c2VybmFtZX0ge3Nlc3Npb25faW5mb30iKQogICAgICAgICAgICAKICAgICAgICAgICAgYWN0aW9uX3N1Y2Nlc3MgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgxJHGsOG7o2MgY2jhu41uIHRow7RuZyBxdWEgSm9iQmFzZQogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgaGFuZGxlcjoKICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIHBlcmZvcm1fYWN0aW9uIHThu5VuZyBxdcOhdCB04burIEpvYkJhc2UKICAgICAgICAgICAgICAgIGFjdGlvbl9zdWNjZXNzID0gaGFuZGxlci5wZXJmb3JtX2FjdGlvbihjaG9zZW5fYWN0aW9uLCBhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjYXJlIGFjdGlvbiBjb3VudCB2w6Agam9iIHJhdGlvIGNobyBjw6FjIGFjdGlvbiBjYXJlCiAgICAgICAgICAgICAgICAjIENo4buJIMSR4bq/bSBjYXJlIGFjdGlvbnMsIGtow7RuZyDEkWnhu4F1IGNo4buJbmggam9iIHJhdGlvIG7hu69hCiAgICAgICAgICAgICAgICBpZiBhY3Rpb25fc3VjY2VzcyBhbmQgY2hvc2VuX2FjdGlvbiAhPSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2luY3JlbWVudF9jYXJlX2FjdGlvbl9jb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZWxpZiBhY3Rpb25fc3VjY2VzcyBhbmQgY2hvc2VuX2FjdGlvbiA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgY2FyZSBhY3Rpb24gY291bnQgc2F1IGtoaSBsw6BtIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9jYXJlX2FjdGlvbl9jb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGFjdGlvbl9zdWNjZXNzID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHNlc3Npb24gZGF0YQogICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQsIGNob3Nlbl9hY3Rpb24sIGFjdGlvbl9zdWNjZXNzKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHaGkgbOG6oWkgbOG7i2NoIHPhu60gaMOgbmggxJHhu5luZwogICAgICAgICAgICBzZWxmLl9yZWNvcmRfYWN0aW9uX2hpc3RvcnkoYWNjb3VudF9pZCwgY2hvc2VuX2FjdGlvbiwgYWN0aW9uX3N1Y2Nlc3MpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBuw6puIGNodXnhu4NuIGFjY291bnQga2jDtG5nIHNhdSBhY3Rpb24gbsOgeQogICAgICAgICAgICBzaG91bGRfc3dpdGNoID0gc2VsZi5fc2hvdWxkX3N3aXRjaF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIHNob3VsZF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkKQogICAgICAgICAgICAgICAgc3dpdGNoX3JlYXNvbiA9IHNlbGYuX2dldF9zd2l0Y2hfcmVhc29uKGFjY291bnRfaWQsIHNlc3Npb24pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU+G6vSBjaHV54buDbiBhY2NvdW50IHNhdSBhY3Rpb24gbsOgeS4gTMO9IGRvOiB7c3dpdGNoX3JlYXNvbn0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogU+G7rSBk4bulbmcgxJHDum5nIGxv4bqhaSByZXN0IGThu7FhIHRyw6puIGzDvSBkbwogICAgICAgICAgICAgICAgc2VsZi5fYXBwbHlfYXBwcm9wcmlhdGVfcmVzdF90eXBlKGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24sIHNlc3Npb24pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU2V0IG1lc3NhZ2UgY2hvIGRldmljZQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJOZ2jhu4kgbmfGoWk6IHt1c2VybmFtZX0gKHtzd2l0Y2hfcmVhc29ufSkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSR4buDIGZvcmNlIHTDrG0gYWNjb3VudCBt4bubaSBs4bqnbiBzYXUKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmV0dXJuIEZhbHNlIMSR4buDIGLDoW8gaGnhu4d1IGPhuqduIHTDrG0gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJldHVybiBUcnVlIHbDrCBraMO0bmcgY8OzIGzhu5dpIG5naGnDqm0gdHLhu41uZwogICAgICAgICAgICAjIChhY3Rpb24gY8OzIHRo4buDIHRo4bqldCBi4bqhaSBuaMawbmcgYWNjb3VudCB24bqrbiDhu5VuKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHdvcmsgd2l0aCBzaW5nbGUgYWNjb3VudDoge2V9IikKICAgICAgICAgICAgIyBDaOG7iSByZXR1cm4gRmFsc2Uga2hpIGPDsyBleGNlcHRpb24gbmdoacOqbSB0cuG7jW5nCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2dldF9zd2l0Y2hfcmVhc29uKHNlbGYsIGFjY291bnRfaWQ6IGludCwgc2Vzc2lvbjogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBsw70gZG8gY2h1eeG7g24gYWNjb3VudAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGFjY291bnQKICAgICAgICAgICAgc2Vzc2lvbjogU2Vzc2lvbiBkYXRhCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogTMO9IGRvIGNodXnhu4NuIGFjY291bnQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiBhY2NvdW50IHbDoCBzZXNzaW9uIGxpbWl0cwogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiAiQWNjb3VudCBraMO0bmcgdOG7k24gdOG6oWkiCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uX2xpbWl0cyA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb25fbGltaXRzKGFjY291bnQpCiAgICAgICAgICAgIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIl0KICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X2pvYnNfcGVyX3Nlc3Npb24iXQogICAgICAgICAgICBtYXhfc2Vzc2lvbl9kdXJhdGlvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfc2Vzc2lvbl9kdXJhdGlvbiJdCiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICBzZXNzaW9uX2R1cmF0aW9uID0gY3VycmVudF90aW1lIC0gc2Vzc2lvblsnc3RhcnRfdGltZSddCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzZXNzaW9uX2R1cmF0aW9uID49IG1heF9zZXNzaW9uX2R1cmF0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIGYiSOG6v3QgdGjhu51pIGdpYW4gc2Vzc2lvbiAoe3Nlc3Npb25fZHVyYXRpb24vNjA6LjFmfS97bWF4X3Nlc3Npb25fZHVyYXRpb24vNjA6LjFmfSBwaMO6dCkiCiAgICAgICAgICAgIGVsaWYgc2Vzc2lvblsnYWN0aW9uX2NvdW50J10gPj0gbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgICAgICByZXR1cm4gZiLEkOG6oXQgZ2nhu5tpIGjhuqFuIGFjdGlvbnMgKHtzZXNzaW9uWydhY3Rpb25fY291bnQnXX0ve21heF9hY3Rpb25zX3Blcl9zZXNzaW9ufSkiCiAgICAgICAgICAgIGVsaWYgc2Vzc2lvblsnam9iX2NvdW50J10gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgICAgICByZXR1cm4gZiLEkOG6oXQgZ2nhu5tpIGjhuqFuIGpvYnMgKHtzZXNzaW9uWydqb2JfY291bnQnXX0ve21heF9qb2JzX3Blcl9zZXNzaW9ufSkiCiAgICAgICAgICAgIGVsaWYgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzLmdldChhY2NvdW50X2lkLCAwKSA+PSBNYWluU2VydmljZUNvbnN0YW50cy5TV0lUQ0hfQUNDT1VOVF9BRlRFUl9DT05TRUNVVElWRV9GQUlMUzoKICAgICAgICAgICAgICAgIHJldHVybiBmIlRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AgKHtzZWxmLmFjY291bnRfY29uc2VjdXRpdmVfZmFpbHVyZXNbYWNjb3VudF9pZF19KSIKICAgICAgICAgICAgZWxpZiBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzLmdldChhY2NvdW50X2lkLCAwKSA+PSBNYWluU2VydmljZUNvbnN0YW50cy5TV0lUQ0hfQUNDT1VOVF9BRlRFUl9OT19KT0JTOgogICAgICAgICAgICAgICAgcmV0dXJuIGYiS2jDtG5nIGPDsyBqb2IgbGnDqm4gdGnhur9wICh7c2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXX0pIgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuICJLaMOhYyIKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHN3aXRjaCByZWFzb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiTOG7l2kgeMOhYyDEkeG7i25oIGzDvSBkbyIKICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIkto4bufaSDEkeG7mW5nIE1haW5TZXJ2aWNlIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSDEkeG7mW5nIE1haW5TZXJ2aWNlLi4uIikKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgCiAgICAgICAgIyBLaOG7n2kgdOG6oW8gbuG6v3UgY2jGsGEgxJHGsOG7o2Mga2jhu59pIHThuqFvCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBNYWluU2VydmljZSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICAjIENo4bqheSBtYWluIGxvb3AgdHJvbmcgdGhyZWFkCiAgICAgICAgc2VsZi5ydW4oKQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENo4bqheSBNYWluU2VydmljZSAtIGxvb3AgY2jDrW5oIGvhur90IGjhu6NwIGNoxINtIHPDs2MgdsOgIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBNYWluU2VydmljZS4gS2jDtG5nIHRo4buDIGNo4bqheS4iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBjaOG6oXkgTWFpblNlcnZpY2UgduG7m2kgbG9naWMgaMOgaSBow7JhIGNoxINtIHPDs2MgdsOgIGzDoG0gdmnhu4djLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyB4w6FjIMSR4buLbmggZGV2aWNlX2lkIGhp4buHbiB04bqhaSwgTWFpblNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIHdoaWxlIHNlbGYucnVubmluZzoKICAgICAgICAgICAgIyBSZXNldCBiaeG6v24gZm9yY2Vfc3RvcCBu4bq/dSBjw7MKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICBpZiBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyLCB04bqhbSBk4burbmcgeOG7rSBsw70iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG5nYXkga2hpIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIE1haW5TZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGludGVybmV0CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuY2hlY2tfaW50ZXJuZXQoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIGPDsyBr4bq/dCBu4buRaSBpbnRlcm5ldCwgbmdo4buJIDIwcyB2w6AgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMjApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2hvbWUoKQogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MgKGzhuqduIHtzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudH0pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9OT19BQ0NPVU5UUykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSB0csaw4bubYyBraGkga2nhu4NtIHRyYSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBraGkgY8OzIHTDoGkga2hv4bqjbiDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHdvcmtpbmcgYWNjb3VudAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIkzDoG0gdmnhu4djIGjDoGkgaMOyYSIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIFRydWUpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBNYWluU2VydmljZUNvbnN0YW50cy5NU0dfV09SS0lOR19IQVJNT05JT1VTKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgd29ya19yZXN1bHQgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoYWNjb3VudF90b193b3JrKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IHdvcmtfcmVzdWx0ID0gRmFsc2UsIG5naMSpYSBsw6AgYWNjb3VudCBj4bqnbiBuZ2jhu4kgbmfGoWkKICAgICAgICAgICAgICAgICMgVGnhur9wIHThu6VjIHTDrG0gYWNjb3VudCBraMOhYyBuZ2F5IGzhuq1wIHThu6ljCiAgICAgICAgICAgICAgICBpZiBub3Qgd29ya19yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFjY291bnQgxJHDoyDEkcaw4bujYyDEkeG6t3Qgbmdo4buJIG5nxqFpLCB0w6xtIGFjY291bnQga2jDoWMuLi4iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyBs4bqnbiBsw6BtIHZp4buHYyB24bubaSBjw7luZyBhY2NvdW50CiAgICAgICAgICAgICAgICBhY3Rpb25fZGVsYXlfbWluID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiYWN0aW9uX2RlbGF5X21pbiIsIDMpCiAgICAgICAgICAgICAgICBhY3Rpb25fZGVsYXlfbWF4ID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiYWN0aW9uX2RlbGF5X21heCIsIDgpCiAgICAgICAgICAgICAgICBkZWxheV90aW1lID0gcmFuZG9tLnJhbmRpbnQoYWN0aW9uX2RlbGF5X21pbiwgYWN0aW9uX2RlbGF5X21heCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtkZWxheV90aW1lfXMgdHLGsOG7m2Mga2hpIGzDoG0gdmnhu4djIHRp4bq/cCB0aGVvIikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoZGVsYXlfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmggTWFpblNlcnZpY2UiKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgICMgQ2xlYW51cCBraGkgdGhvw6F0CiAgICAgICAgc2VsZi5fY2xlYW51cF9vbl9leGl0KCkKICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2UgxJHDoyBk4burbmciKQogICAgCiAgICBkZWYgX2NsZWFudXBfb25fZXhpdChzZWxmKToKICAgICAgICAiIiJDbGVhbnVwIGtoaSBNYWluU2VydmljZSBk4burbmciIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTmjhuqMgcHJveHkKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGtoaSBNYWluU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcAogICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IGtoaSBNYWluU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnY2xvc2VfYXBwJyk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBjbGVhbnVwOiB7ZX0iKQogICAgCiAgICBkZWYgX3ZlcmlmeV9jdXJyZW50X2FjY291bnRfb25fYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlciBj4bunYSBhcHAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIGFwcCwgTm9uZSBu4bq/dSBraMO0bmcgY8OzIGhv4bq3YyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoaGFuZGxlciwgJ2dldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZScpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJIYW5kbGVyIHthcHBfbmFtZX0ga2jDtG5nIGjhu5cgdHLhu6MgZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgdOG7qyBVSQogICAgICAgICAgICBjdXJyZW50X2FjY291bnRfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gdHJvbmcgREIKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpID09IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlZlcmlmaWVkOiBUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnRfdXNlcm5hbWV9IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbmjGsG5nIGtow7RuZyBjw7MgdHJvbmcgREIiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2ZXJpZnkgY3VycmVudCBhY2NvdW50IHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShzZWxmLCBhcHBfbmFtZTogc3RyLCBoYW5kbGVyKToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaSBpc19sb2dpbiB0cm9uZyBEQiB24bubaSB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIgY+G7p2EgYXBwCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIHZlcmlmeSBhY2NvdW50IChu4bq/dSBj4bqnbikKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKGYiVmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX0sIGLhu48gcXVhIHZlcmlmeSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLl92ZXJpZnlfY3VycmVudF9hY2NvdW50X29uX2FwcChhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgYXBwIG7DoHkgduG7gSBpc19sb2dpbiA9IEZhbHNlIHRyb25nIERCCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICByZXNldF9jb3VudCA9IDAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICByZXNldF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgaXNfbG9naW4gPSBGYWxzZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc2V0X2NvdW50ID4gMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQge3Jlc2V0X2NvdW50fSB0w6BpIGtob+G6o24gduG7gSBpc19sb2dpbiA9IEZhbHNlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBpZiBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGN1cnJlbnRfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gY3VycmVudF9hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgdHLhuqFuZyB0aMOhaTogVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGxvZ2luCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IEtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBzeW5jIGxvZ2luIHN0YXR1cyBjaG8ge2FwcF9uYW1lfToge2V9IikKCiAgICBkZWYgX2luaXRpYWxfc3luY19hbGxfYWNjb3VudHNfbG9naW5fc3RhdHVzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBiYW4gxJHhuqd1OiDEkeG7jWMgdOG6pXQgY+G6oyBhcHBzIHbDoCBzeW5jIHRy4bqhbmcgdGjDoWkgaXNfbG9naW4gY2hvIGNodeG6qW4geMOhYwogICAgICAgIENo4buJIGfhu41pIG3hu5l0IGzhuqduIGtoaSBraOG7n2kgxJHhu5luZyBNYWluU2VydmljZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflI0gQuG6r3QgxJHhuqd1IGto4bufaSB04bqhbzogU3luYyB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB04bqldCBj4bqjIGFwcHMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhciB0cmFja2luZyDEkeG7gyBi4bqvdCDEkeG6p3UgZnJlc2gKICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkLmNsZWFyKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3luYyB04burbmcgYXBwCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TsSBTeW5jIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBIb8OgbiB0aMOgbmggc3luYyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBM4buXaSBzeW5jIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4pqg77iPIEtow7RuZyBjw7MgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgc3luYyIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+OryBIb8OgbiB0aMOgbmgga2jhu59pIHThuqFvIHN5bmMgbG9naW4gc3RhdHVzLiBUcmFja2luZzoge3NlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLinYwgTOG7l2kgdHJvbmcgaW5pdGlhbCBzeW5jIGFjY291bnRzOiB7ZX0iKQoKICAgIGRlZiBfdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgYWNjb3VudF9pZDogaW50LCBpc19sb2dpbjogYm9vbCk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBj4bunYSB0w6BpIGtob+G6o24gKHTGsMahbmcgdOG7sSBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCB0w6BpIGtob+G6o24gCiAgICAgICAgICAgIGlzX2xvZ2luOiBUcnVlIG7hur91IMSRw6MgxJHEg25nIG5o4bqtcCwgRmFsc2UgbuG6v3UgbG9nb3V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGlzX2xvZ2luLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcgdHJvbmcgbWVtb3J5CiAgICAgICAgICAgIGlmIGlzX2xvZ2luOgogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGtow6FjIGPhu6dhIGPDuW5nIGFwcCBsw6AgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIG9sZF9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBpZiBvbGRfYWNjb3VudF9pZCAhPSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KG9sZF9hY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBjxakge29sZF9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkgbG9nb3V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IHTDoGkga2hv4bqjbiBt4bubaQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgWMOzYSBraOG7j2kgdHJhY2tpbmcgbuG6v3UgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzIGFuZCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wOiB7ZX0iKQoKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBNYWluU2VydmljZSIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgTWFpblNlcnZpY2UuLi4iKQogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBmb3JjZV9zdG9wX2FsbChzZWxmKToKICAgICAgICAiIiJGb3JjZSBzdG9wIHThuqV0IGPhuqMiIiIKICAgICAgICBsb2dnZXIuaW5mbygiRm9yY2Ugc3RvcCBNYWluU2VydmljZS4uLiIpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IFRydWUKICAgIAogICAgZGVmIGdldF9zZXJ2aWNlX3N0YXRzKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4buRbmcga8OqIGPhu6dhIE1haW5TZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogVGjhu5FuZyBrw6ogc2VydmljZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBzZWxmLl9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHN0YXRzID0gewogICAgICAgICAgICAgICAgInNlcnZpY2VfdHlwZSI6ICJNYWluU2VydmljZSIsCiAgICAgICAgICAgICAgICAiaXNfcnVubmluZyI6IHNlbGYucnVubmluZywKICAgICAgICAgICAgICAgICJpc19pbml0aWFsaXplZCI6IHNlbGYuaXNfaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgICAgICAidG90YWxfd29ya2FibGVfYWNjb3VudHMiOiBsZW4od29ya2FibGVfYWNjb3VudHMpLAogICAgICAgICAgICAgICAgImN1cnJlbnRfd29ya2luZ19hY2NvdW50Ijogc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgZWxzZSBOb25lLAogICAgICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IHNlbGYuZW5hYmxlZF9hcHBzLAogICAgICAgICAgICAgICAgImNhcmVfYWN0aW9uX2NvdW50cyI6IHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLAogICAgICAgICAgICAgICAgIm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCI6IHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50LAogICAgICAgICAgICAgICAgInByb3h5X2FjdGl2ZSI6IHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKSBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ2lzX3Byb3h5X2FjdGl2ZScpIGVsc2UgRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHN0YXRzCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHNlcnZpY2Ugc3RhdHM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgCiAgICAjIE1ldGhvZHMgxJHhu4MgdMawxqFuZyB0aMOtY2ggduG7m2kgSm9iU2VydmljZSBpbnRlcmZhY2UgY2hvIE1RVFQgc2VydmljZQogICAgZGVmIGhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoc2VsZiwgY29uZmlnX2NoYW5nZXM6IERpY3Rbc3RyLCBBbnldID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIE1RVFQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfY2hhbmdlczogQ8OhYyB0aGF5IMSR4buVaSBjb25maWcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBuaOG6rW4gY29uZmlnIHVwZGF0ZSB04burIE1RVFQiKQogICAgICAgICAgICBpZiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ29uZmlnIGNoYW5nZXM6IHtjb25maWdfY2hhbmdlc30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgbuG6v3UgY8OzCiAgICAgICAgICAgICAgICBpZiAiZW5hYmxlZF9hcHBzIiBpbiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IGNvbmZpZ19jaGFuZ2VzWyJlbmFibGVkX2FwcHMiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6rXAgbmjhuq10IGVuYWJsZWRfYXBwczoge3NlbGYuZW5hYmxlZF9hcHBzfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGFjdGlvbiB3ZWlnaHRzIG7hur91IGPDswogICAgICAgICAgICAgICAgaWYgIm1haW5fc2VydmljZV9hY3Rpb25fd2VpZ2h0cyIgaW4gY29uZmlnX2NoYW5nZXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hY3Rpb25fd2VpZ2h0cyA9IGNvbmZpZ19jaGFuZ2VzWyJtYWluX3NlcnZpY2VfYWN0aW9uX3dlaWdodHMiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6rXAgbmjhuq10IGFjdGlvbiB3ZWlnaHRzOiB7c2VsZi5hY3Rpb25fd2VpZ2h0c30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgc3luY19zdGF0dXMgY2hhbmdlcyB2w6AgcmVsb2FkIGFjY291bnRzIG7hur91IGPhuqduCiAgICAgICAgICAgICAgICBzeW5jX3N0YXR1c19jaGFuZ2VkID0gRmFsc2UKICAgICAgICAgICAgICAgIGZvciBrZXkgaW4gY29uZmlnX2NoYW5nZXM6CiAgICAgICAgICAgICAgICAgICAgaWYga2V5LmVuZHN3aXRoKCdfc3luY19zdGF0dXMnKToKICAgICAgICAgICAgICAgICAgICAgICAgc3luY19zdGF0dXNfY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQaMOhdCBoaeG7h24gdGhheSDEkeG7lWkgc3luYyBzdGF0dXM6IHtrZXl9ID0ge2NvbmZpZ19jaGFuZ2VzW2tleV19IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgc3luY19zdGF0dXNfY2hhbmdlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi8J+UhCBTeW5jIHN0YXR1cyDEkcOjIHRoYXkgxJHhu5VpLCByZWxvYWQgYWNjb3VudHMgdsOgIHJlLXNjYW4gdOG7qyB0aGnhur90IGLhu4suLi4iKQogICAgICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgZm9yY2UgcmVmcmVzaAogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBsb2dpbiB0cmFja2luZyDEkeG7gyBmb3JjZSByZS12ZXJpZmljYXRpb24KICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZC5jbGVhcigpCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjw6FjIGNvdW50ZXIgxJHhu4MgYuG6r3QgxJHhuqd1IGN5Y2xlIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19hY2NvdW50X2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVHJpZ2dlciByZS1zY2FuIGFjY291bnRzIHThu6sgdGhp4bq/dCBi4buLIGNobyBjw6FjIGFwcCDEkcaw4bujYyBlbmFibGUKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZXNjYW5fZGV2aWNlX2FjY291bnRzX2FzeW5jKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi4pyFIMSQw6MgcmVzZXQgd29ya2luZyBhY2NvdW50LCBsb2dpbiB0cmFja2luZyB2w6AgdHJpZ2dlciByZS1zY2FuIHNhdSBzeW5jIHN0YXR1cyBjaGFuZ2UiKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBoYW5kbGUgbXF0dCBjb25maWcgdXBkYXRlOiB7ZX0iKQogICAgCiAgICBkZWYgaGFuZGxlX21xdHRfYWNjb3VudF91cGRhdGUoc2VsZik6CiAgICAgICAgIiIiWOG7rSBsw70gY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB04burIE1RVFQiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBuaOG6rW4gYWNjb3VudCB1cGRhdGUgdOG7qyBNUVRUIikKICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBmb3JjZSByZWZyZXNoCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgaGFuZGxlIG1xdHQgYWNjb3VudCB1cGRhdGU6IHtlfSIpCiAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9mb3JjZV9zdGFydF9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIljhu60gbMO9IHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IHNlc3Npb24gdOG7qyBNUVRUIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2Ugbmjhuq1uIGZvcmNlIHN0YXJ0IHNlc3Npb24gdOG7qyBNUVRUIikKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGNvdW50ZXIKICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgaGFuZGxlIG1xdHQgZm9yY2Ugc3RhcnQgc2Vzc2lvbjoge2V9IikKICAgIAogICAgZGVmIHNodXRkb3duKHNlbGYpOgogICAgICAgICIiIlNodXRkb3duIE1haW5TZXJ2aWNlIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiU2h1dGRvd24gTWFpblNlcnZpY2UuLi4iKQogICAgICAgICAgICBzZWxmLnN0b3AoKQogICAgICAgICAgICBzZWxmLl9jbGVhbnVwX29uX2V4aXQoKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHNodXRkb3duIE1haW5TZXJ2aWNlOiB7ZX0iKQogICAgCiAgICAjIFRow6ptIGPDoWMgbWV0aG9kIGtow6FjIMSR4buDIHTGsMahbmcgdGjDrWNoIHbhu5tpIEpvYlNlcnZpY2UKICAgIGRlZiByZXNldF9jdXJyZW50X3Byb3h5X2lwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiUmVzZXQgSVAgcHJveHkgaGnhu4duIHThuqFpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ3Jlc2V0X2N1cnJlbnRfcHJveHlfaXAnKToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UucmVzZXRfY3VycmVudF9wcm94eV9pcCgpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IHByb3h5IElQOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9wcm94eV9zdGF0dXMoc2VsZikgLT4gc3RyOgogICAgICAgICIiIkzhuqV5IHRy4bqhbmcgdGjDoWkgcHJveHkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5wcm94eV9zZXJ2aWNlLCAnZ2V0X3Byb3h5X3N0YXR1cycpOgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5nZXRfcHJveHlfc3RhdHVzKCkKICAgICAgICAgICAgcmV0dXJuICJVbmtub3duIgogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGdldCBwcm94eSBzdGF0dXM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiRXJyb3IiCiAgICAKICAgIGRlZiBnZXRfcHJveHlfaW5mbyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiJM4bqleSB0aMO0bmcgdGluIHByb3h5IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ2dldF9wcm94eV9pbmZvJyk6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9pbmZvKCkKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHByb3h5IGluZm86IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgCiAgICBkZWYgX3Jlc2Nhbl9kZXZpY2VfYWNjb3VudHNfYXN5bmMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyBt4buZdCBjw6FjaCBhc3luYyDEkeG7gyBraMO0bmcgYmxvY2sgbWFpbiB0aHJlYWQKICAgICAgICAiIiIKICAgICAgICBkZWYgX3Jlc2Nhbl93b3JrZXIoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflI0gQuG6r3QgxJHhuqd1IHJlLXNjYW4gYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4suLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlLXNjYW4gY2hvIHThu6tuZyBhcHAgxJHGsOG7o2MgZW5hYmxlCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TsSBSZS1zY2FuIGFjY291bnRzIHThu6sge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIHN5bmNfYWNjb3VudHNfdG9fZGIgdOG7qyBCYXNlSm9iIHRoYXkgdsOsIHThu7EgaW1wbGVtZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUge2FwcF9uYW1lfTogxJDDoyBzeW5jIHtsZW4oZGV2aWNlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5OxIHthcHBfbmFtZX06IEtow7RuZyB0w6xtIHRo4bqleSBhY2NvdW50IG7DoG8gdOG7qyB0aGnhur90IGLhu4sgaG/hurdjIGzhu5dpIHN5bmMiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZS1zY2FuIGFjY291bnRzIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygi8J+OryBIb8OgbiB0aMOgbmggcmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX3Jlc2Nhbl93b3JrZXI6IHtlfSIpCiAgICAgICAgCiAgICAgICAgIyBDaOG6oXkgdHJvbmcgdGhyZWFkIHJpw6puZyDEkeG7gyBraMO0bmcgYmxvY2sgbWFpbiBsb29wCiAgICAgICAgcmVzY2FuX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PV9yZXNjYW5fd29ya2VyLCBkYWVtb249VHJ1ZSkKICAgICAgICByZXNjYW5fdGhyZWFkLnN0YXJ0KCkKICAgICAgICBsb2dnZXIuaW5mbygi8J+agCDEkMOjIGto4bufaSDEkeG7mW5nIHJlLXNjYW4gdGhyZWFkIikKICAgIAogICAgZGVmIHJlc2V0X2V4cGlyZWRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgY8OhYyB0w6BpIGtob+G6o24gZXhwaXJlZCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIGFjY291bnRzIGV4cGlyZWQgdsOgIHJlc2V0IG7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hbGxfYWNjb3VudHMoKQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfZXhwaXJlZCIpOgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budIGNoxrBhICh2w60gZOG7pSAxIGdp4budKQogICAgICAgICAgICAgICAgICAgIGV4cGlyZWRfdGltZSA9IGFjY291bnQuZ2V0KCJleHBpcmVkX3RpbWUiLCAwKQogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdGltZSAtIGV4cGlyZWRfdGltZSA+IDM2MDA6ICAjIDEgZ2nhu50KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBleHBpcmVkIGFjY291bnQ6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfZXhwaXJlZCI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImV4cGlyZWRfdGltZSI6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaGFzX2Vycm9yIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBleHBpcmVkIGFjY291bnRzOiB7ZX0iKQogICAgCiAgICBkZWYgcmVzZXRfbG9nb3V0X2FjY291bnRzKHNlbGYpOgogICAgICAgICIiIlJlc2V0IGPDoWMgdMOgaSBraG/huqNuIGxvZ291dCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2luIGPhu6dhIGPDoWMgYWNjb3VudCBu4bq/dSBj4bqnbgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FsbF9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfbG9naW4iKSBhbmQgYWNjb3VudC5nZXQoImlzX2FjdGl2ZSIpOgogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRo4buDIHRow6ptIGxvZ2ljIMSR4buDIHRo4butIGxvZ2luIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgbG9nb3V0IGFjY291bnRzOiB7ZX0iKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIGpvYiBjaG8gYXBwIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjaGVjayBhY2NvdW50IGNhbiBydW4gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHdvcmsoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgTWFpbiB3b3JrIGxvb3AgduG7m2kgbG9naWMgY2h1eeG7g24gYWNjb3VudCB0aMO0bmcgbWluaAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBi4bqvdCDEkeG6p3UgaG/huqF0IMSR4buZbmcgduG7m2kgbG9naWMgc2Vzc2lvbiBtYW5hZ2VtZW50IikKICAgICAgICAKICAgICAgICBjdXJyZW50X2FjY291bnQgPSBOb25lCiAgICAgICAgd29ya19zdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGFjY291bnQgxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnQgb3Igc2VsZi5fc2hvdWxkX3N3aXRjaF9hY2NvdW50KGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikpOgogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAgICAgIyBTZXQgbmdo4buJIG5nxqFpIGNobyBhY2NvdW50IGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIExvZyBsw70gZG8gY2h1eeG7g24KICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oY3VycmVudF9hY2NvdW50LmdldCgiaWQiKSkKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoX3JlYXNvbiA9IHNlbGYuX2dldF9zd2l0Y2hfcmVhc29uKGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIiksIHNlc3Npb24pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gdOG7qyBhY2NvdW50IHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0uIEzDvSBkbzoge3N3aXRjaF9yZWFzb259IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuX2dldF9uZXh0X2F2YWlsYWJsZV9hY2NvdW50KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBub3QgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyBhY2NvdW50IGto4bqjIGThu6VuZywgY2jhu50gNjBzLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgIkNo4budIGFjY291bnQga2jhuqMgZOG7pW5nLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDYwKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBjaG8gYWNjb3VudCBt4bubaQogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBjdXJyZW50X2FjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBzZXNzaW9uIG3hu5tpIHbhu5tpIGFjY291bnQge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgYWNjb3VudCBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoY3VycmVudF9hY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gZOG7q25nIChu4bq/dSBj4bqnbikKICAgICAgICAgICAgICAgIHdvcmtfZHVyYXRpb24gPSB0aW1lLnRpbWUoKSAtIHdvcmtfc3RhcnRfdGltZQogICAgICAgICAgICAgICAgaWYgd29ya19kdXJhdGlvbiA+IDg2NDAwOiAgIyAyNCBnaeG7nQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGzDoG0gdmnhu4djIDI0IGdp4budLCBuZ2jhu4kgbmfGoWkuLi4iKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEtleWJvYXJkSW50ZXJydXB0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiB0w61uIGhp4buHdSBk4burbmcgdOG7qyBuZ8aw4budaSBkw7luZyIpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyB3b3JrIGxvb3A6IHtlfSIpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMzApICAjIE5naOG7iSAzMHMga2hpIGPDsyBs4buXaQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBr4bq/dCB0aMO6YyBob+G6oXQgxJHhu5luZyIpCg==').decode('utf-8'))
