import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwpmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSwgZGF0ZSwgdGltZWRlbHRhCmltcG9ydCByYW5kb20KaW1wb3J0IGpzb24KZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwKaW1wb3J0IGNvbmZpZwppbXBvcnQgdXRpbHMKZnJvbSB1dGlscyBpbXBvcnQgTG9nTGV2ZWwsIExvZ2dlcgpmcm9tIGpvYnMgaW1wb3J0IFRpa3Rva0pvYiwgVGlrdG9rMkpvYiwgSW5zdGFncmFtSm9iLCBZb3V0dWJlSm9iCmZyb20gc2VydmljZXMucHJveHlfc2VydmljZSBpbXBvcnQgUHJveHlTZXJ2aWNlCgojIFThuqFvIGxvZ2dlciBjaG8gTWFpblNlcnZpY2UKbG9nZ2VyID0gdXRpbHMuZ2V0X2xvZ2dlcigiTWFpblNlcnZpY2UiKQoKIyBDb25zdGFudHMgY2hvIE1haW5TZXJ2aWNlCmNsYXNzIE1haW5TZXJ2aWNlQ29uc3RhbnRzOgogICAgIiIiQ29uc3RhbnRzIGNobyBNYWluU2VydmljZSAtIGNo4buJIGNo4bupYSBzdHJpbmcvZW51bSBjb25zdGFudHMsIHPhu5EgbGnhu4d1IGzhuqV5IHThu6sgY29uZmlnIiIiCiAgICAKICAgICMgQ8OhYyBsb+G6oWkgaMOgbmggxJHhu5luZyAoZW51bSkKICAgIEFDVElPTl9ORVdTRkVFRCA9ICJuZXdzZmVlZCIgICAgICAgICAgIAogICAgQUNUSU9OX1JFRUxTID0gInJlZWxzIiAgICAgICAgICAgICAgICAgCiAgICBBQ1RJT05fTk9USUZJQ0FUSU9OID0gIm5vdGlmaWNhdGlvbiIgICAgCiAgICBBQ1RJT05fUFJPRklMRSA9ICJwcm9maWxlIiAgICAgICAgICAgICAKICAgIEFDVElPTl9KT0IgPSAiam9iIiAgICAgICAgICAgICAgICAgICAgIAogICAgQUNUSU9OX0VYUExPUkUgPSAiZXhwbG9yZSIgICAgICAgICAgICAgCiAgICBBQ1RJT05fU0VBUkNIID0gInNlYXJjaCIgICAgICAgICAgICAgICAKICAgIAogICAgIyBTdGF0dXMgbWVzc2FnZXMKICAgIE1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUiA9ICJU4bqhbSBk4burbmcgKFNldmVyIHnDqnUgY+G6p3UpIgogICAgTVNHX0RFVklDRV9OT19BQ0NPVU5UUyA9ICJU4bqhbSBuZ2jhu4kgKEtow7RuZyBjw7MgdMOgaSBraG/huqNuKSIKICAgIE1TR19XQUlUSU5HX1BST1hZID0gIsSQYW5nIGNo4budIHByb3h5IgogICAgTVNHX1dPUktJTkdfSEFSTU9OSU9VUyA9ICLEkGFuZyBsw6BtIHZp4buHYyBow6BpIGjDsmEiCiAgICBNU0dfQ0FSSU5HX0FDQ09VTlQgPSAixJBhbmcgY2jEg20gc8OzYyB0w6BpIGtob+G6o24iCiAgICBNU0dfRE9JTkdfSk9CID0gIsSQYW5nIGzDoG0gam9iIgoKY2xhc3MgTWFpblNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfc2VydmljZSwgaGVscGVyX3NlcnZpY2UsIGdvbGlrZV9zZXJ2aWNlLCBtcXR0X3NlcnZpY2U9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIE1haW5TZXJ2aWNlIC0gU2VydmljZSB0w61jaCBo4bujcCBjaMSDbSBzw7NjIHbDoCBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgKHThu6sgZ2xvYmFsIGNvbmZpZykKICAgICAgICBnbG9iYWxfY29uZmlnID0gc2VsZi5kYi5nZXRfZ2xvYmFsX2NvbmZpZyh7fSkKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IGdsb2JhbF9jb25maWcuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIMSR4bq/bSBz4buRIGjDoG5oIMSR4buZbmcgY2FyZSB0cm9uZyBzZXNzaW9uCiAgICAgICAgc2VsZi5jYXJlX2FjdGlvbl9jb3VudHMgPSB7fSAgIyB7YWNjb3VudF9pZDogY291bnR9CiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgbOG7i2NoIHPhu60gaMOgbmggxJHhu5luZyBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnkgPSB7fSAgIyB7YWNjb3VudF9pZDogW2FjdGlvbnNdfQogICAgICAgIAogICAgICAgICMgU2Vzc2lvbiBtYW5hZ2VtZW50IHBlciBhY2NvdW50CiAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zID0ge30gICMge2FjY291bnRfaWQ6IHNlc3Npb25fZGF0YX0KICAgICAgICAKICAgICAgICAjIFRyYWNrIGNvbnNlY3V0aXZlIGZhaWx1cmVzIHBlciBhY2NvdW50CiAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzID0ge30gICMge2FjY291bnRfaWQ6IGNvdW50fQogICAgICAgIAogICAgICAgICMgVHJhY2sgY29uc2VjdXRpdmUgbm8tam9iIGF0dGVtcHRzIHBlciBhY2NvdW50CiAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0cyA9IHt9ICAjIHthY2NvdW50X2lkOiBjb3VudH0KICAgICAgICAKICAgICAgICAjIEFjY291bnQgcmVzdCBwZXJpb2RzIC0gREVQUkVDQVRFRDogbm93IHVzaW5nIERCIHN0YXR1cyA9IGluYWN0aXZlICsgam9iX2Rpc2FibGVfdW50aWwKICAgICAgICAjIHNlbGYuYWNjb3VudF9sYXN0X3dvcmtfdGltZSA9IHt9ICAjIHthY2NvdW50X2lkOiB0aW1lc3RhbXB9CiAgICAgICAgIyBzZWxmLmFjY291bnRfcmVzdF91bnRpbCA9IHt9ICAjIHthY2NvdW50X2lkOiB0aW1lc3RhbXB9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Aga2jDtG5nIHTDrG0gdGjhuqV5IGpvYgogICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgIAogICAgICAgICMgVHJhY2sgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSDEkeG7gyB0csOhbmggcmVzZXQgSVAgcHJveHkgbGnDqm4gdOG7pWMKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcAogICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMgPSB7fSAgIyB7YXBwX25hbWU6IGFjY291bnRfaWR9CiAgICAgICAgCiAgICAgICAgIyBGbGFnIMSR4buDIHRyYWNrIHhlbSDEkcOjIHZlcmlmeSBjdXJyZW50IGFjY291bnQgY2jGsGEga2hpIGto4bufaSDEkeG7mW5nIChnaeG7kW5nIEpvYlNlcnZpY2UpCiAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQgPSB7fSAgIyB7YXBwX25hbWU6IGJvb2x9CiAgICAgICAgCiAgICAgICAgIyBUcmFjayB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIGNvbnNlY3V0aXZlIG5vLWpvYiBhdHRlbXB0cyBwZXIgYWNjb3VudCAodOG7qyBKb2JTZXJ2aWNlKQogICAgICAgIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMgPSB7fSAgIyB7YWNjb3VudF9pZDogY291bnR9CiAgICAgICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Nlc3Npb25fbGltaXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgaW50XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBnaeG7m2kgaOG6oW4gc2Vzc2lvbiBjaG8gYWNjb3VudCB04burIGFwcC1zcGVjaWZpYyBjb25maWcgdGhheSB2w6wgYWNjb3VudCByZWNvcmQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiAocGjhuqNpIGPDsyAnYXBwJyBmaWVsZCkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogU2Vzc2lvbiBsaW1pdHMgY2hvIGFjY291bnQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgYXBwIG5hbWUgxJHhu4MgdMOsbSBqb2IgaGFuZGxlciB0xrDGoW5nIOG7qW5nCiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IG1heF9qb2JzX3Blcl9zZXNzaW9uIHThu6sgYXBwIGNvbmZpZyB0aGF5IHbDrCBhY2NvdW50IHJlY29yZAogICAgICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBqb2JfaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBqb2JfaGFuZGxlci5nZXRfY29uZmlnKCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDEwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ2lkJyl9ICh7YXBwX25hbWV9KTogVXNpbmcgYXBwLWJhc2VkIG1heF9qb2JzX3Blcl9zZXNzaW9uID0ge21heF9qb2JzX3Blcl9zZXNzaW9ufSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIG7hur91IGtow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSAxMCAgIyBEZWZhdWx0IGhhcmRjb2RlCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkFjY291bnQge2FjY291bnQuZ2V0KCdpZCcpfTogTm8gam9iIGhhbmRsZXIgZm91bmQgZm9yIGFwcCB7YXBwX25hbWV9LCB1c2luZyBkZWZhdWx0IG1heF9qb2JzX3Blcl9zZXNzaW9uID0ge21heF9qb2JzX3Blcl9zZXNzaW9ufSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrW5oIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIMSR4buZbmcgZOG7sWEgdHLDqm4gbWF4X2pvYnNfcGVyX3Nlc3Npb24gdsOgIGFwcCBjb25maWcKICAgICAgICAgICAgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gPSBzZWxmLl9jYWxjdWxhdGVfZHluYW1pY19hY3Rpb25zX2xpbWl0KG1heF9qb2JzX3Blcl9zZXNzaW9uLCBhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBzZXNzaW9uIGR1cmF0aW9uIHThu6sgam9iLXNwZWNpZmljIGNvbmZpZwogICAgICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBqb2JfaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyByYW5kb20gc2Vzc2lvbiBkdXJhdGlvbiB04burIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICByYW5kb21fc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzID0gam9iX2hhbmRsZXIuZ2V0X3JhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMoKQogICAgICAgICAgICAgICAgbWF4X3Nlc3Npb25fZHVyYXRpb24gPSByYW5kb21fc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzICogNjAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ2lkJyl9ICh7YXBwX25hbWV9KTogUmFuZG9tIHNlc3Npb24gZHVyYXRpb246IHtyYW5kb21fc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiBz4butIGThu6VuZyBnacOhIHRy4buLIG3hurdjIMSR4buLbmggdOG7qyBKb2JCYXNlCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0sIHPhu60gZOG7pW5nIGRlZmF1bHQgSm9iQmFzZSBjb25maWciKQogICAgICAgICAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBkZWZhdWx0IHThu6sgSm9iQmFzZTogMzAtNjAgcGjDunQKICAgICAgICAgICAgICAgIHJhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMgPSByYW5kb20ucmFuZGludCgzMCwgNjApCiAgICAgICAgICAgICAgICBtYXhfc2Vzc2lvbl9kdXJhdGlvbiA9IHJhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMgKiA2MAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7YWNjb3VudC5nZXQoJ2lkJyl9OiBtYXhfam9icz17bWF4X2pvYnNfcGVyX3Nlc3Npb259LCBjYWxjdWxhdGVkX21heF9hY3Rpb25zPXttYXhfYWN0aW9uc19wZXJfc2Vzc2lvbn0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IG1heF9qb2JzX3Blcl9zZXNzaW9uLAogICAgICAgICAgICAgICAgIm1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIjogbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24sCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb24iOiBtYXhfc2Vzc2lvbl9kdXJhdGlvbgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHNlc3Npb24gbGltaXRzOiB7ZX0iKQogICAgICAgICAgICAjIEZhbGxiYWNrIHPhu60gZOG7pW5nIGhhcmRjb2RlIHZhbHVlcyB0aGF5IHbDrCBnbG9iYWwgY29uZmlnCiAgICAgICAgICAgIGltcG9ydCByYW5kb20KICAgICAgICAgICAgZmFsbGJhY2tfZHVyYXRpb24gPSByYW5kb20ucmFuZGludCgzMCwgNjApICogNjAgICMgSm9iQmFzZSBkZWZhdWx0OiAzMC02MCBwaMO6dAogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IDEwLCAgIyBIYXJkY29kZSBkZWZhdWx0CiAgICAgICAgICAgICAgICAibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iOiAzMCwgICMgSGFyZGNvZGUgZGVmYXVsdCAgCiAgICAgICAgICAgICAgICAibWF4X3Nlc3Npb25fZHVyYXRpb24iOiBmYWxsYmFja19kdXJhdGlvbgogICAgICAgICAgICB9CiAgICAKICAgIGRlZiBfY2FsY3VsYXRlX2R5bmFtaWNfYWN0aW9uc19saW1pdChzZWxmLCBtYXhfam9ic19wZXJfc2Vzc2lvbjogaW50LCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUw61uaCB0b8OhbiBkeW5hbWljIG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uIGThu7FhIHRyw6puIGFwcCBjb25maWcgaG/hurdjIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgCiAgICAgICAgTG9naWM6CiAgICAgICAgLSDGr3UgdGnDqm4gbOG6pXkgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gdOG7qyBhcHAgY29uZmlnCiAgICAgICAgLSBO4bq/dSBraMO0bmcgY8OzIHRow6wgdMOtbmggdG/DoW4gZOG7sWEgdHLDqm4gbWF4X2pvYnNfcGVyX3Nlc3Npb24gduG7m2kgcmF0aW8KICAgICAgICAtIMOBcCBk4bulbmcgZ2nhu5tpIGjhuqFuIHThu5FpIHRoaeG7g3UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbjogU+G7kSBqb2JzIHThu5FpIMSRYSB0cm9uZyBzZXNzaW9uCiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIMSR4buDIGzhuqV5IGNvbmZpZyBhcHAgY+G7pSB0aOG7gyAob3B0aW9uYWwpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogU+G7kSBhY3Rpb25zIHThu5FpIMSRYSB0w61uaCB0b8OhbiDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBnaeG7m2kgaOG6oW4gdOG7qyBhcHAgY29uZmlnIG7hur91IGPDsyBhY2NvdW50CiAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBhcHBfY29uZmlnID0gaGFuZGxlci5nZXRfYXBwX2NvbmZpZygpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBtaW5fYWN0aW9ucyB04burIGFwcCBjb25maWcgaG/hurdjIGhhcmRjb2RlIGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICBtaW5fYWN0aW9ucyA9IGFwcF9jb25maWcuZ2V0KCJtaW5fYWN0aW9uc19wZXJfc2Vzc2lvbiIsIDgpICAjIERlZmF1bHQ6IDgKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIMavVSBUScOKTjogTOG6pXkgbWF4X2FjdGlvbnMgdHLhu7FjIHRp4bq/cCB04burIGFwcCBjb25maWcKICAgICAgICAgICAgICAgICAgICBhcHBfbWF4X2FjdGlvbnMgPSBhcHBfY29uZmlnLmdldCgibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iKQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9tYXhfYWN0aW9uczoKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxfYWN0aW9ucyA9IG1heChtaW5fYWN0aW9ucywgYXBwX21heF9hY3Rpb25zKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJT4butIGThu6VuZyBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiB04burIHthcHBfbmFtZX0gY29uZmlnOiB7ZmluYWxfYWN0aW9uc30iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmluYWxfYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFwcCB7YXBwX25hbWV9IGtow7RuZyBjw7MgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24sIHTDrW5oIHRvw6FuIMSR4buZbmciKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIHbhu4EgaGFyZGNvZGUgZGVmYXVsdAogICAgICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gOCAgIyBEZWZhdWx0OiB04buRaSB0aGnhu4N1IDggYWN0aW9ucwogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkZhbGxiYWNrIHbhu4EgaGFyZGNvZGUgZGVmYXVsdDogbWluPXttaW5fYWN0aW9uc30iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIGFjY291bnQsIGTDuW5nIGhhcmRjb2RlIGRlZmF1bHQKICAgICAgICAgICAgICAgIG1pbl9hY3Rpb25zID0gOCAgIyBEZWZhdWx0OiB04buRaSB0aGnhu4N1IDggYWN0aW9ucwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0b8OhbiBhY3Rpb25zIGPhuqduIHRoaeG6v3QgZOG7sWEgdHLDqm4gc+G7kSBqb2JzIChmYWxsYmFjaykKICAgICAgICAgICAgZGVmYXVsdF9yYXRpbyA9IDIuNQogICAgICAgICAgICBjYWxjdWxhdGVkX2FjdGlvbnMgPSBpbnQobWF4X2pvYnNfcGVyX3Nlc3Npb24gKiBkZWZhdWx0X3JhdGlvKQogICAgICAgICAgICBtYXhfYWN0aW9ucyA9IDMwICAjIEhhcmRjb2RlIGRlZmF1bHQgbWF4IGFjdGlvbnMKICAgICAgICAgICAgCiAgICAgICAgICAgICMgw4FwIGThu6VuZyBnaeG7m2kgaOG6oW4gdOG7kWkgdGhp4buDdSB2w6AgdOG7kWkgxJFhCiAgICAgICAgICAgIGZpbmFsX2FjdGlvbnMgPSBtYXgobWluX2FjdGlvbnMsIG1pbihjYWxjdWxhdGVkX2FjdGlvbnMsIG1heF9hY3Rpb25zKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkR5bmFtaWMgYWN0aW9ucyBjYWxjdWxhdGlvbjoge21heF9qb2JzX3Blcl9zZXNzaW9ufSBqb2JzICoge2RlZmF1bHRfcmF0aW99IHJhdGlvID0ge2NhbGN1bGF0ZWRfYWN0aW9uc30g4oaSIGZpbmFsOiB7ZmluYWxfYWN0aW9uc30gKG1pbjoge21pbl9hY3Rpb25zfSwgbWF4OiB7bWF4X2FjdGlvbnN9KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZmluYWxfYWN0aW9ucwogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNhbGN1bGF0ZSBkeW5hbWljIGFjdGlvbnMgbGltaXQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAzMCAgIyBIYXJkY29kZSBkZWZhdWx0IGZhbGxiYWNrCiAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbihzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gbmdo4buJIG5nxqFpIHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUaOG7nWkgZ2lhbiBuZ2jhu4kgbmfGoWkgKGdpw6J5KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMgdOG7qyBkYXRhYmFzZSBjb25maWcgdsOgIGNvbnZlcnQgc2FuZyBnacOieQogICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygic2Vzc2lvbl9jb29sZG93bl9taW51dGVzIiwgMzApICAjIE3hurdjIMSR4buLbmggMzAgcGjDunQKICAgICAgICAgICAgYmFzZV9kdXJhdGlvbiA9IGNvb2xkb3duX21pbnV0ZXMgKiA2MAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSByYW5kb20gbmjhu48gwrExMCUgxJHhu4MgdHLDoW5oIGPDoWMgYWNjb3VudCBuZ2jhu4kgY8O5bmcgbMO6YwogICAgICAgICAgICB2YXJpYXRpb24gPSBpbnQoYmFzZV9kdXJhdGlvbiAqIDAuMSkgIAogICAgICAgICAgICByZXN0X2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQoYmFzZV9kdXJhdGlvbiAtIHZhcmlhdGlvbiwgYmFzZV9kdXJhdGlvbiArIHZhcmlhdGlvbikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN0X2R1cmF0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHJlc3QgZHVyYXRpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAzMCAqIDYwICAjIEZhbGxiYWNrOiAzMCBwaMO6dAogICAgCiAgICBkZWYgX2dldF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBz4buRIGzGsOG7o25nIGjDoG5oIMSR4buZbmcgY2FyZSDEkcOjIHRo4buxYyBoaeG7h24gdHJvbmcgc2Vzc2lvbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFPhu5EgaMOgbmggxJHhu5luZyBjYXJlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLmdldChhY2NvdW50X2lkLCAwKQogICAgCiAgICBkZWYgX2luY3JlbWVudF9jYXJlX2FjdGlvbl9jb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIFTEg25nIHPhu5EgbMaw4bujbmcgaMOgbmggxJHhu5luZyBjYXJlIGNobyB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBzZWxmLmNhcmVfYWN0aW9uX2NvdW50c1thY2NvdW50X2lkXSA9IHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICBsb2dnZXIuZGVidWcoZiJDYXJlIGFjdGlvbiBjb3VudCBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH06IHtzZWxmLmNhcmVfYWN0aW9uX2NvdW50c1thY2NvdW50X2lkXX0iKQogICAgCiAgICBkZWYgX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCk6CiAgICAgICAgIiIiCiAgICAgICAgUmVzZXQgc+G7kSBsxrDhu6NuZyBow6BuaCDEkeG7mW5nIGNhcmUgduG7gSAwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5jYXJlX2FjdGlvbl9jb3VudHNbYWNjb3VudF9pZF0gPSAwCiAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgY2FyZSBhY3Rpb24gY291bnQgY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgIAogICAgZGVmIF9jaG9vc2VfcmFuZG9tX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIENo4buNbiBow6BuaCDEkeG7mW5nIHRow7RuZyBxdWEgSm9iQmFzZSBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBMb+G6oWkgaMOgbmggxJHhu5luZyDEkcaw4bujYyBjaOG7jW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVycy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFuZGxlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSwgZMO5bmcgZGVmYXVsdCBhY3Rpb24iKQogICAgICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9ORVdTRkVFRAogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBKb2JCYXNlIMSR4buDIGNo4buNbiBhY3Rpb24gdGhlbyBjb25maWcKICAgICAgICAgICAgY2hvc2VuX2FjdGlvbiA9IGhhbmRsZXIuY2hvb3NlX3dlaWdodGVkX2FjdGlvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJKb2JCYXNlIGNo4buNbiBhY3Rpb24gJ3tjaG9zZW5fYWN0aW9ufScgY2hvIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgIHJldHVybiBjaG9zZW5fYWN0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgY2jhu41uIGFjdGlvbiBxdWEgSm9iQmFzZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9ORVdTRkVFRCAgIyBGYWxsYmFjawogICAgCiAgICBkZWYgX2dldF9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50KSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIHNlc3Npb24gY+G7p2EgYWNjb3VudCB04burIERCIChwZXJzaXN0ZW50IHNlc3Npb24pCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Q6IFNlc3Npb24gZGF0YSB04burIERCCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGFjY291bnQgZGF0YSBt4bubaSBuaOG6pXQgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2FjY291bnRfaWR9IHRyb25nIERCIikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N0YXJ0X3RpbWUnOiB0aW1lLnRpbWUoKSwKICAgICAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnam9iX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICAgICAnY2FyZV9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2xhc3RfYWN0aW9uX3RpbWUnOiB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBhY3Rpb25fY291bnQgdsOgIGNhcmVfY291bnQgdOG7qyBjw6FjIGZpZWxkIERCIGhp4buHbiBjw7MKICAgICAgICAgICAgam9iX2NvdW50ID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgY2FyZV9jb3VudCA9IGFjY291bnQuZ2V0KCJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiIsIDApICAjIFPhur0gdGjDqm0gZmllbGQgbsOgeQogICAgICAgICAgICBhY3Rpb25fY291bnQgPSBqb2JfY291bnQgKyBjYXJlX2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrW5oIHN0YXJ0X3RpbWU6IE7hur91IHNlc3Npb24gY2jGsGEgY8OzIHN0YXJ0X3RpbWUgdHJvbmcgbWVtb3J5IHRow6wgdOG6oW8gbeG7m2kKICAgICAgICAgICAgIyBLSMOUTkcgZMO5bmcgbGFzdF9qb2JfdGltZSB2w6wgxJHDsyBsw6AgdGjhu51pIMSRaeG7g20gam9iIGN14buRaSAoY8OzIHRo4buDIGPFqSkKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnMgYW5kICdzdGFydF90aW1lJyBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF06CiAgICAgICAgICAgICAgICAjIETDuW5nIHN0YXJ0X3RpbWUgdOG7qyBtZW1vcnkgc2Vzc2lvbiBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSBzZWxmLmFjY291bnRfc2Vzc2lvbnNbYWNjb3VudF9pZF1bJ3N0YXJ0X3RpbWUnXQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBU4bqhbyBzdGFydF90aW1lIG3hu5tpIGNobyBzZXNzaW9uIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAnc3RhcnRfdGltZSc6IHN0YXJ0X3RpbWUsCiAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogYWN0aW9uX2NvdW50LAogICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IGpvYl9jb3VudCwKICAgICAgICAgICAgICAgICdjYXJlX2NvdW50JzogY2FyZV9jb3VudCwKICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDYWNoZSB2w6BvIG1lbW9yeSDEkeG7gyB0csOhbmggcXVlcnkgbGnDqm4gdOG7pWMKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gc2Vzc2lvbl9kYXRhCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gc2Vzc2lvbl9kYXRhCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IGFjY291bnQgc2Vzc2lvbiB04burIERCOiB7ZX0iKQogICAgICAgICAgICAjIEZhbGxiYWNrIHbhu4EgbWVtb3J5IHNlc3Npb24KICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBub3QgaW4gc2VsZi5hY2NvdW50X3Nlc3Npb25zOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3Nlc3Npb24oc2VsZiwgYWNjb3VudF9pZDogaW50LCBhY3Rpb25fdHlwZTogc3RyLCBzdWNjZXNzOiBib29sKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgc2Vzc2lvbiBkYXRhIGPhu6dhIGFjY291bnQgdsOgbyBEQiAocGVyc2lzdGVudCBzZXNzaW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY3Rpb25fdHlwZTogTG/huqFpIGjDoG5oIMSR4buZbmcKICAgICAgICAgICAgc3VjY2VzczogVGjDoG5oIGPDtG5nIGhheSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGF0YSBoaeG7h24gdOG6oWkgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQge2FjY291bnRfaWR9IMSR4buDIHVwZGF0ZSBzZXNzaW9uIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCB0b8OhbiBjw6FjIGNvdW50ZXJzIG3hu5tpCiAgICAgICAgICAgIGN1cnJlbnRfam9iX2NvdW50ID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgY3VycmVudF9jYXJlX2NvdW50ID0gYWNjb3VudC5nZXQoImNhcmVfYWN0aW9uc19pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgImxhc3RfYWN0aW9uX3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9COgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJqb2JzX2RvbmVfaW5fc2Vzc2lvbiJdID0gY3VycmVudF9qb2JfY291bnQgKyAxCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgQ2FyZSBhY3Rpb24KICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsiY2FyZV9hY3Rpb25zX2luX3Nlc3Npb24iXSA9IGN1cnJlbnRfY2FyZV9jb3VudCArIDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gREIKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG1lbW9yeSBjYWNoZQogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9mcm9tX21lbW9yeShhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBhY3Rpb25fdHlwZSA9PSBNYWluU2VydmljZUNvbnN0YW50cy5BQ1RJT05fSk9CIGFuZCBzdWNjZXNzOgogICAgICAgICAgICAgICAgc2Vzc2lvblsnam9iX2NvdW50J10gKz0gMQogICAgICAgICAgICBlbGlmIGFjdGlvbl90eXBlICE9IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICBzZXNzaW9uWydjYXJlX2NvdW50J10gKz0gMQogICAgICAgICAgICAKICAgICAgICAgICAgc2Vzc2lvblsnYWN0aW9uX2NvdW50J10gPSBzZXNzaW9uWydqb2JfY291bnQnXSArIHNlc3Npb25bJ2NhcmVfY291bnQnXQogICAgICAgICAgICBzZXNzaW9uWydsYXN0X2FjdGlvbl90aW1lJ10gPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgY29uc2VjdXRpdmUgZmFpbHVyZXMgKHbhuqtuIGTDuW5nIG1lbW9yeSB2w6wga2jDtG5nIGPhuqduIHBlcnNpc3QpCiAgICAgICAgICAgIGlmIG5vdCBzdWNjZXNzOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzLmdldChhY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgIGlmIGFjdGlvbl90eXBlID09IE1haW5TZXJ2aWNlQ29uc3RhbnRzLkFDVElPTl9KT0I6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMuZ2V0KGFjY291bnRfaWQsIDApICsgMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgaWYgYWN0aW9uX3R5cGUgPT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdXBkYXRlIGFjY291bnQgc2Vzc2lvbjoge2V9IikKICAgIAogICAgZGVmIF9nZXRfYWNjb3VudF9zZXNzaW9uX2Zyb21fbWVtb3J5KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgc2Vzc2lvbiB04burIG1lbW9yeSBjYWNoZSAoaGVscGVyIGZ1bmN0aW9uKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBTZXNzaW9uIGRhdGEgdOG7qyBtZW1vcnkKICAgICAgICAiIiIKICAgICAgICBpZiBhY2NvdW50X2lkIG5vdCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXSA9IHsKICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAnYWN0aW9uX2NvdW50JzogMCwKICAgICAgICAgICAgICAgICdqb2JfY291bnQnOiAwLAogICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgJ2xhc3RfYWN0aW9uX3RpbWUnOiB0aW1lLnRpbWUoKQogICAgICAgICAgICB9CiAgICAgICAgcmV0dXJuIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgCiAgICBkZWYgX3Jlc2V0X2FjY291bnRfc2Vzc2lvbihzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IHNlc3Npb24gZGF0YSBj4bunYSBhY2NvdW50IHRyb25nIERCCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIHJlc2V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gZGF0YSB0cm9uZyBEQgogICAgICAgICAgICByZXNldF9kYXRhID0gewogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJjYXJlX2FjdGlvbnNfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAibGFzdF9hY3Rpb25fdGltZSI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCByZXNldF9kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBtZW1vcnkgY2FjaGUKICAgICAgICAgICAgaWYgYWNjb3VudF9pZCBpbiBzZWxmLmFjY291bnRfc2Vzc2lvbnM6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHNlc3Npb24gY2hvIGFjY291bnQge2FjY291bnRfaWR9LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBhY2NvdW50IHNlc3Npb246IHtlfSIpCgogICAgZGVmIF9yZXNldF9hY2NvdW50X3Nlc3Npb25fc3RhcnRfdGltZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IGNo4buJIHNlc3Npb24gc3RhcnRfdGltZSDEkeG7gyBi4bqvdCDEkeG6p3Ugc2Vzc2lvbiBt4bubaSBtw6Aga2jDtG5nIG3huqV0IHByb2dyZXNzCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIHJlc2V0IHN0YXJ0X3RpbWUKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVzZXQgbWVtb3J5IGNhY2hlIHNlc3Npb24gc3RhcnRfdGltZQogICAgICAgICAgICBpZiBhY2NvdW50X2lkIGluIHNlbGYuYWNjb3VudF9zZXNzaW9uczoKICAgICAgICAgICAgICAgIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXVsnc3RhcnRfdGltZSddID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+UhCBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQge2FjY291bnRfaWR9LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVOG6oW8gbeG7m2kgc2Vzc2lvbiB24bubaSBzdGFydF90aW1lIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X3Nlc3Npb25zW2FjY291bnRfaWRdID0gewogICAgICAgICAgICAgICAgICAgICdzdGFydF90aW1lJzogdGltZS50aW1lKCksCiAgICAgICAgICAgICAgICAgICAgJ2FjdGlvbl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2pvYl9jb3VudCc6IDAsCiAgICAgICAgICAgICAgICAgICAgJ2NhcmVfY291bnQnOiAwLAogICAgICAgICAgICAgICAgICAgICdsYXN0X2FjdGlvbl90aW1lJzogdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+GlSBU4bqhbyBt4bubaSBzZXNzaW9uIGNobyBhY2NvdW50IHthY2NvdW50X2lkfS4gTMO9IGRvOiB7cmVhc29ufSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IGFjY291bnQgc2Vzc2lvbiBzdGFydF90aW1lOiB7ZX0iKQoKICAgIGRlZiBfc2V0X2FjY291bnRfcmVzdChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBuZ2jhu4kgbmfGoWkgc+G7rSBk4bulbmcgc3RhdHVzID0gaW5hY3RpdmUgdsOgIGpvYl9kaXNhYmxlX3VudGlsCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIG5naOG7iSBuZ8ahaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0aOG7nWkgZ2lhbiBuZ2jhu4kgdOG7qyBjb25maWcKICAgICAgICAgICAgcmVzdF9taW51dGVzID0gc2VsZi5fZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbigpIC8vIDYwICAjIENvbnZlcnQgc2Vjb25kcyB0byBtaW51dGVzCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBjaHXhuqluIGPhu6dhIERhdGFiYXNlU2VydmljZQogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9cmVzdF9taW51dGVzLAogICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiQWNjb3VudCByZXN0OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBkYXRhIHRyb25nIERCCiAgICAgICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgZiJBY2NvdW50IHJlc3Q6IHtyZWFzb259IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBjb25zZWN1dGl2ZSBjb3VudGVycyAobWVtb3J5KQogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X2NvbnNlY3V0aXZlX2ZhaWx1cmVzW2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0c1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSDEkcaw4bujYyDEkeG6t3Qgbmdo4buJIG5nxqFpIHtyZXN0X21pbnV0ZXN9IHBow7p0LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyDEkeG6t3QgYWNjb3VudCB7YWNjb3VudF9pZH0gbmdo4buJIG5nxqFpIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzZXQgYWNjb3VudCByZXN0OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9mb2xsb3dfcGVuYWx0eShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHJlYXNvbjogc3RyID0gIiIpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBhY2NvdW50IHbDoG8gdHLhuqFuZyB0aMOhaSBuZ+G7q25nIGZvbGxvdyB2w6wgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gbmfhu6tuZyBmb2xsb3cKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjhu51pIGdpYW4gcGVuYWx0eSB04burIGNvbmZpZyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50KICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGNodeG6qW4gY+G7p2EgRGF0YWJhc2VTZXJ2aWNlCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLmRpc2FibGVfYWNjb3VudF9mb2xsb3coCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRfaWQsCiAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9cGVuYWx0eV9taW51dGVzLAogICAgICAgICAgICAgICAgcmVhc29uPWYiRm9sbG93IHBlbmFsdHk6IHtyZWFzb259IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSBi4buLIG5n4burbmcgZm9sbG93IHtwZW5hbHR5X21pbnV0ZXN9IHBow7p0LiBMw70gZG86IHtyZWFzb259IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBuZ+G7q25nIGZvbGxvdyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc2V0IGZvbGxvdyBwZW5hbHR5OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9kYWlseV9saW1pdF9yZWFjaGVkKHNlbGYsIGFjY291bnRfaWQ6IGludCwgcmVhc29uOiBzdHIgPSAiIik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhurd0IGFjY291bnQgdsOgbyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHVudGlsIG5leHQgcmVzZXQga2hpIMSR4bqhdCBnaeG7m2kgaOG6oW4gZGFpbHkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY2h14bqpbiBj4bunYSBEYXRhYmFzZVNlcnZpY2UKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldCgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkRhaWx5IGxpbWl0OiB7cmVhc29ufSIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gxJHhuqF0IGdp4bubaSBo4bqhbiBkYWlseSwgbmdo4buJIMSR4bq/biBuZ8OgeSBtYWkuIEzDvSBkbzoge3JlYXNvbn0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIHNldCBkYWlseSBsaW1pdCBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHNldCBkYWlseSBsaW1pdDoge2V9IikKICAgICAgICAKICAgIGRlZiBfYXBwbHlfYXBwcm9wcmlhdGVfcmVzdF90eXBlKHNlbGYsIGFjY291bnRfaWQ6IGludCwgc3dpdGNoX3JlYXNvbjogc3RyLCBzZXNzaW9uOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgw4FwIGThu6VuZyBsb+G6oWkgbmdo4buJIG5nxqFpIHBow7kgaOG7o3AgZOG7sWEgdHLDqm4gbMO9IGRvIHN3aXRjaCBhY2NvdW50CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgYWNjb3VudAogICAgICAgICAgICBzd2l0Y2hfcmVhc29uOiBMw70gZG8gc3dpdGNoCiAgICAgICAgICAgIHNlc3Npb246IFNlc3Npb24gZGF0YQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFBow6JuIGxv4bqhaSBsw70gZG8gdsOgIMOhcCBk4bulbmcgcmVzdCB0eXBlIHBow7kgaOG7o3AKICAgICAgICAgICAgaWYgImRhaWx5IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCkgb3IgIm5nw6B5IiBpbiBzd2l0Y2hfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAjIERhaWx5IGxpbWl0IHJlYWNoZWQgLSBpbmFjdGl2ZSB1bnRpbCBuZXh0IHJlc2V0CiAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9kYWlseV9saW1pdF9yZWFjaGVkKGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiAidGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cCIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJjb25zZWN1dGl2ZSIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpOgogICAgICAgICAgICAgICAgIyBDb25zZWN1dGl2ZSBmYWlsdXJlcyAtIGPDsyB0aOG7gyBsw6AgZm9sbG93IHBlbmFsdHkKICAgICAgICAgICAgICAgIGlmICJmb2xsb3ciIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKSBvciAidW5mb2xsb3ciIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9mb2xsb3dfcGVuYWx0eShhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEdlbmVyaWMgc2Vzc2lvbiByZXN0CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbGlmICJraMO0bmcgY8OzIGpvYiIgaW4gc3dpdGNoX3JlYXNvbi5sb3dlcigpIG9yICJubyBqb2IiIGluIHN3aXRjaF9yZWFzb24ubG93ZXIoKToKICAgICAgICAgICAgICAgICMgTm8gam9icyBhdmFpbGFibGUgLSBzaG9ydGVyIHJlc3QKICAgICAgICAgICAgICAgIGNvb2xkb3duX25vX2pvYiA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImNvb2xkb3duX2dldF9qb2JfZ29saWtlIiwgMzApICAjIDMwIHBow7p0IG3hurdjIMSR4buLbmgKICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudF9pZCwKICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPWNvb2xkb3duX25vX2pvYiwKICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJObyBqb2IgY29vbGRvd246IHtzd2l0Y2hfcmVhc29ufSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfSBuZ2jhu4kge2Nvb2xkb3duX25vX2pvYn0gcGjDunQgKGtow7RuZyBjw7Mgam9iKSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFNlc3Npb24gY29tcGxldGVkIG5vcm1hbGx5IC0gc3RhbmRhcmQgc2Vzc2lvbiBjb29sZG93bgogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBhcHBseSBhcHByb3ByaWF0ZSByZXN0IHR5cGU6IHtlfSIpCiAgICAgICAgICAgICMgRmFsbGJhY2sgdG8gc3RhbmRhcmQgcmVzdAogICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGFjY291bnRfaWQsIHN3aXRjaF9yZWFzb24pCiAgICAgICAgICAgIAogICAgZGVmIF9lbnN1cmVfYWNjb3VudF9zd2l0Y2hlZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gYWNjb3VudCDEkcaw4bujYyBzd2l0Y2ggdGjhu7FjIHThur8gdHLDqm4gbcOheSAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IEFjY291bnQgY+G6p24gc3dpdGNoCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyBzd2l0Y2ggdGjDoG5oIGPDtG5nIGhv4bq3YyDEkcOjIMSRw7puZyBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBzd2l0Y2gga2jDtG5nIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGN1cnJlbnRfbG9nZ2VkX2luX2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIG5lZWRzX2FjY291bnRfc3dpdGNoID0gY3VycmVudF9sb2dnZWRfaW5faWQgIT0gYWNjb3VudF9pZAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbmVlZHNfYWNjb3VudF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkPhuqduIGNodXnhu4NuIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiBoaeG7h24gdOG6oWkgSUQ9e2N1cnJlbnRfbG9nZ2VkX2luX2lkfSwgY+G6p24gY2h1eeG7g24gc2FuZyBJRD17YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRow7RuZyBiw6FvIGNobyB1c2VyCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGNodXnhu4NuIGFjY291bnQ6IHt1c2VybmFtZX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50CiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc3dpdGNoX3Jlc3VsdCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCdzdWNjZXNzJywgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICByZWFzb24gPSBzd2l0Y2hfcmVzdWx0LmdldCgncmVhc29uJywgJ3Vua25vd24nKQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gc3dpdGNoX3Jlc3VsdC5nZXQoJ21lc3NhZ2UnLCAnTOG7l2kga2jDtG5nIHjDoWMgxJHhu4tuaCcpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiByZWFzb24gPT0gJ2FjY291bnRfbm90X2ZvdW5kJzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoLCDEkcOhbmggZOG6pXUgbG9nb3V0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGxvZ291dCB2w6Agc3luYyBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fbWFya19hY2NvdW50X2xvZ291dChhY2NvdW50LCAiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nIHNhdSBraGkgc3dpdGNoIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoYWNjb3VudF9pZCwgIkFjY291bnQgc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBD4bqtcCBuaOG6rXQgaXNfbG9naW4gc3RhdHVzIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGluZyBhY2NvdW50IGRhdGEgc2F1IGtoaSBzd2l0Y2ggY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGzDoG0gdmnhu4djOiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVMawxqFuZyB0aMOtY2ggduG7m2kgaW1wbGVtZW50YXRpb24gY8WpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZXNldCBzZXNzaW9uIHN0YXJ0X3RpbWUgY2hvIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uX3N0YXJ0X3RpbWUoYWNjb3VudF9pZCwgIkFjY291bnQgc3dpdGNoIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBD4bqtcCBuaOG6rXQgaXNfbG9naW4gc3RhdHVzIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X2xvZ2luX3N0YXR1cyhhcHBfbmFtZSwgYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBSZWxvYWQgYWNjb3VudCBkYXRhIHThu6sgREIgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZGluZyBhY2NvdW50IGRhdGEgc2F1IGtoaSBzd2l0Y2ggY2hvIGFjY291bnQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIMSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIsSQYW5nIGzDoG0gdmnhu4djOiB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSRxINuZyBuaOG6rXAsIGLhu48gcXVhIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBlbnN1cmUgYWNjb3VudCBzd2l0Y2hlZDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfbG9naW5fc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGxvZ2dlZF9pbl9hY2NvdW50X2lkOiBpbnQpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBsb2dpbiBzdGF0dXMgdHJvbmcgREIgc2F1IGtoaSBzd2l0Y2ggYWNjb3VudCB0aMOgbmggY8O0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQ6IElEIGPhu6dhIGFjY291bnQgxJHDoyBsb2dpbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSZXNldCB04bqldCBj4bqjIGFjY291bnRzIGPhu6dhIGFwcCB24buBIGlzX2xvZ2luID0gRmFsc2UKICAgICAgICAgICAgYXBwX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhcHBfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSkgYW5kIGFjY291bnRbImlkIl0gIT0gbG9nZ2VkX2luX2FjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBpc19sb2dpbj1GYWxzZSBjaG8gYWNjb3VudCBJRCB7YWNjb3VudFsnaWQnXX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgYWNjb3VudCBoaeG7h24gdOG6oWkgduG7gSBpc19sb2dpbiA9IFRydWUKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU2V0IGlzX2xvZ2luPVRydWUgY2hvIGFjY291bnQgSUQge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdXBkYXRlIGFjY291bnQgbG9naW4gc3RhdHVzOiB7ZX0iKQoKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSBhY2NvdW50IGxvZ291dCB2w6Agc3luYyBs4bqhaSB0cuG6oW5nIHRow6FpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogQWNjb3VudCBi4buLIGxvZ291dAogICAgICAgICAgICByZWFzb246IEzDvSBkbyBsb2dvdXQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgREIKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdmVyaWZpZWQgc3RhdGUKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3ZlcmlmaWVkX3N0YXRlc1thY2NvdW50X2lkXSA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFudXAgc2Vzc2lvbgogICAgICAgICAgICBzZWxmLl9jbGVhbnVwX2FjY291bnRfc2Vzc2lvbl9vbl9sb2dvdXQoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkcOhbmggZOG6pXUgbG9nb3V0IGNobyBhY2NvdW50IHt1c2VybmFtZX06IHtyZWFzb259IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBtYXJrIGFjY291bnQgbG9nb3V0OiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfZ2V0X2FjY291bnRfcmVzdF9kdXJhdGlvbihzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjhu51pIGdpYW4gbmdo4buJIG5nxqFpIGPhu6dhIGFjY291bnQgdOG7qyBjb25maWcgZGF0YWJhc2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSB0w61uaCBi4bqxbmcgZ2nDonkgKG3hurdjIMSR4buLbmggdOG7qyBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIHNlc3Npb25fY29vbGRvd25fbWludXRlcyB0aGF5IHbDrCBqb2JfY29vbGRvd25fbWludXRlcwogICAgICAgICAgICByZXN0X21pbnV0ZXMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMiLCAzMCkKICAgICAgICAgICAgcmV0dXJuIGludChyZXN0X21pbnV0ZXMpICogNjAgICMgQ29udmVydCBtaW51dGVzIHRvIHNlY29uZHMKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGzhuqV5IGFjY291bnQgcmVzdCBkdXJhdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIDMwICogNjAgICMgRGVmYXVsdCAzMCBtaW51dGVzCgogICAgZGVmIF9jbGVhbnVwX2FjY291bnRfc2Vzc2lvbl9vbl9sb2dvdXQoc2VsZiwgYWNjb3VudF9pZDogaW50KToKICAgICAgICAiIiIKICAgICAgICBDbGVhbnVwIHNlc3Npb24gZGF0YSBraGkgbG9nb3V0IGFjY291bnQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiB0cm9uZyBEQgogICAgICAgICAgICBzZWxmLl9yZXNldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCwgIkFjY291bnQgbG9nb3V0IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgd29ya2luZyBzdGF0dXMKICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCBhbmQgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImlkIikgPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHRyYWNraW5nCiAgICAgICAgICAgIGFwcF9uYW1lID0gTm9uZQogICAgICAgICAgICBmb3IgYXBwLCBhY2NfaWQgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYgYWNjX2lkID09IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUgPSBhcHAKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYXBwX25hbWU6CiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdmVyaWZpZWQgc3RhdGUKICAgICAgICAgICAgc2VsZi5hY2NvdW50X3ZlcmlmaWVkX3N0YXRlc1thY2NvdW50X2lkXSA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNsZWFuZWQgdXAgc2Vzc2lvbiBkYXRhIGZvciBsb2dvdXQgYWNjb3VudCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNsZWFudXAgYWNjb3VudCBzZXNzaW9uOiB7ZX0iKQoKICAgIGRlZiBfc2hvdWxkX3Jlc2V0X3Nlc3Npb25fb25fbmV3X2RheShzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSBjw7MgbsOqbiByZXNldCBzZXNzaW9uIGtoaSBxdWEgbmfDoHkgbeG7m2kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqnbiByZXNldCBzZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3Qgc2Vzc2lvbjoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxhc3RfYWN0aW9uX3RpbWUgPSBzZXNzaW9uLmdldCgibGFzdF9hY3Rpb25fdGltZSIsIDApCiAgICAgICAgICAgIGlmIGxhc3RfYWN0aW9uX3RpbWUgPT0gMDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBxdWEgbmfDoHkgbeG7m2kKICAgICAgICAgICAgbGFzdF9kYXRlID0gZGF0ZXRpbWUuZnJvbXRpbWVzdGFtcChsYXN0X2FjdGlvbl90aW1lKS5kYXRlKCkKICAgICAgICAgICAgY3VycmVudF9kYXRlID0gZGF0ZXRpbWUubm93KCkuZGF0ZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gY3VycmVudF9kYXRlID4gbGFzdF9kYXRlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSByZXNldCBzZXNzaW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIG7Dqm4gY2h1eeG7g24gYWNjb3VudCBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgbsOqbiBjaHV54buDbiBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gYWNjb3VudAogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHNlc3Npb24gbGltaXRzIHThu6sgY29uZmlnIGRhdGFiYXNlCiAgICAgICAgICAgIHNlc3Npb25fbGltaXRzID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbl9saW1pdHMoYWNjb3VudCkKICAgICAgICAgICAgbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24iXQogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdIAogICAgICAgICAgICBtYXhfc2Vzc2lvbl9kdXJhdGlvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfc2Vzc2lvbl9kdXJhdGlvbiJdCiAgICAgICAgICAgIAogICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkKQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAxLiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiB0aOG7nWkgZ2lhbiBzZXNzaW9uCiAgICAgICAgICAgIHNlc3Npb25fZHVyYXRpb24gPSBjdXJyZW50X3RpbWUgLSBzZXNzaW9uWydzdGFydF90aW1lJ10KICAgICAgICAgICAgaWYgc2Vzc2lvbl9kdXJhdGlvbiA+PSBtYXhfc2Vzc2lvbl9kdXJhdGlvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IMSQw6MgbMOgbSB2aeG7h2Mge3Nlc3Npb25fZHVyYXRpb24vNjA6LjFmfSBwaMO6dCwgY+G6p24gbmdo4buJIChsaW1pdDoge21heF9zZXNzaW9uX2R1cmF0aW9uLzYwOi4xZn0gcGjDunQpIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDIuIEtp4buDbSB0cmEgc+G7kSBsxrDhu6NuZyBow6BuaCDEkeG7mW5nCiAgICAgICAgICAgIGlmIHNlc3Npb25bJ2FjdGlvbl9jb3VudCddID49IG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyB0aOG7sWMgaGnhu4duIHtzZXNzaW9uWydhY3Rpb25fY291bnQnXX0gaMOgbmggxJHhu5luZywgY+G6p24gbmdo4buJIChsaW1pdDoge21heF9hY3Rpb25zX3Blcl9zZXNzaW9ufSkiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gS2nhu4NtIHRyYSBz4buRIGzGsOG7o25nIGpvYgogICAgICAgICAgICBpZiBzZXNzaW9uWydqb2JfY291bnQnXSA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IMSQw6MgbMOgbSB7c2Vzc2lvblsnam9iX2NvdW50J119IGpvYnMsIGPhuqduIG5naOG7iSAobGltaXQ6IHttYXhfam9ic19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDQuIEtp4buDbSB0cmEgdGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cAogICAgICAgICAgICBjb25zZWN1dGl2ZV9mYWlsdXJlcyA9IHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlcy5nZXQoYWNjb3VudF9pZCwgMCkKICAgICAgICAgICAgbWF4X2NvbnNlY3V0aXZlX2ZhaWxzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygic3dpdGNoX2FjY291bnRfYWZ0ZXJfY29uc2VjdXRpdmVfZmFpbHMiLCAzKQogICAgICAgICAgICBpZiBjb25zZWN1dGl2ZV9mYWlsdXJlcyA+PSBtYXhfY29uc2VjdXRpdmVfZmFpbHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge2FjY291bnRfaWR9OiB7Y29uc2VjdXRpdmVfZmFpbHVyZXN9IGzhuqduIHRo4bqldCBi4bqhaSBsacOqbiB0aeG6v3AsIGNodXnhu4NuIGFjY291bnQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgNS4gS2nhu4NtIHRyYSBraMO0bmcgY8OzIGpvYiBsacOqbiB0aeG6v3AKICAgICAgICAgICAgbm9fam9iX2F0dGVtcHRzID0gc2VsZi5hY2NvdW50X25vX2pvYl9hdHRlbXB0cy5nZXQoYWNjb3VudF9pZCwgMCkKICAgICAgICAgICAgbWF4X25vX2pvYl9hdHRlbXB0cyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoInN3aXRjaF9hY2NvdW50X2FmdGVyX25vX2pvYnMiLCA1KQogICAgICAgICAgICBpZiBub19qb2JfYXR0ZW1wdHMgPj0gbWF4X25vX2pvYl9hdHRlbXB0czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH06IHtub19qb2JfYXR0ZW1wdHN9IGzhuqduIGtow7RuZyBjw7Mgam9iLCBjaHV54buDbiBhY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDYuIEtp4buDbSB0cmEgZGFpbHkgbGltaXQgLSBs4bqleSB04burIGFwcCBjb25maWcgdGhheSB2w6wgYWNjb3VudCByZWNvcmQKICAgICAgICAgICAgZGFpbHlfY291bnQgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkgICMgU+G7rSBk4bulbmcgam9iX3RvZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9jb3VudAogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYWlseSBqb2IgbGltaXQgdOG7qyBhcHAgY29uZmlnCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgIGpvYl9oYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBkYWlseV9saW1pdCA9IGpvYl9oYW5kbGVyLmdldF9jb25maWcoIm1heF9qb2JzX3Blcl9kYXkiLCAzMCkgICMgRGVmYXVsdCAzMCBu4bq/dSBraMO0bmcgY8OzIGNvbmZpZwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjayBu4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIGRhaWx5X2xpbWl0ID0gMzAgICMgRGVmYXVsdCBoYXJkY29kZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRhaWx5X2NvdW50ID49IGRhaWx5X2xpbWl0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50X2lkfTogxJDDoyDEkeG6oXQgYXBwIGRhaWx5IGxpbWl0ICh7ZGFpbHlfY291bnR9L3tkYWlseV9saW1pdH0pLCBjaHV54buDbiBhY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBjaGVjayBzaG91bGQgc3dpdGNoIGFjY291bnQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2lzX2FjY291bnRfcmVzdGluZyhzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gYWNjb3VudCBjw7MgxJFhbmcgbmdo4buJIG5nxqFpIGtow7RuZyAoc+G7rSBk4bulbmcgREIgc3RhdHVzKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRYW5nIG5naOG7iSBuZ8ahaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgc3RhdHVzID0gaW5hY3RpdmUgdsOgIGpvYl9kaXNhYmxlX3VudGlsCiAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPiBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nX21pbnV0ZXMgPSAoam9iX2Rpc2FibGVfdW50aWwgLSBjdXJyZW50X3RpbWUpIC8gNjAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHthY2NvdW50X2lkfSBjw7JuIG5naOG7iSB7cmVtYWluaW5nX21pbnV0ZXM6LjFmfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBI4bq/dCB0aOG7nWkgZ2lhbiBuZ2jhu4ksIHThu7EgxJHhu5luZyBjaHV54buDbiB24buBIGFjdGl2ZSAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQWNjb3VudCB7YWNjb3VudF9pZH0gxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBuZ2jhu4ksIGNodXnhu4NuIHbhu4EgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBhY2NvdW50IHJlc3Q6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2dldF9uZXh0X2F2YWlsYWJsZV9hY2NvdW50KHNlbGYpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBhY2NvdW50IHRp4bq/cCB0aGVvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyAoa2jDtG5nIG5naOG7iSBuZ8ahaSkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBPcHRpb25hbFtEaWN0XTogQWNjb3VudCBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgaG/hurdjIE5vbmUKICAgICAgICAiIiIKICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IHNlbGYuX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoKQogICAgICAgIAogICAgICAgICMgTOG7jWMgYuG7jyBjw6FjIGFjY291bnQgxJFhbmcgbmdo4buJIG5nxqFpCiAgICAgICAgYXZhaWxhYmxlX2FjY291bnRzID0gW10KICAgICAgICBmb3IgYWNjb3VudCBpbiB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9pc19hY2NvdW50X3Jlc3RpbmcoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICBhdmFpbGFibGVfYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGF2YWlsYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAKICAgICAgICAjIMavdSB0acOqbiBhY2NvdW50IGNoxrBhIGzDoG0gdmnhu4djIGfhuqduIMSRw6J5CiAgICAgICAgZGVmIHNvcnRfa2V5KGFjYyk6CiAgICAgICAgICAgIGFjY19pZCA9IGFjYy5nZXQoImlkIikKICAgICAgICAgICAgbGFzdF93b3JrX3RpbWUgPSBzZWxmLmFjY291bnRfbGFzdF93b3JrX3RpbWUuZ2V0KGFjY19pZCwgMCkKICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIGFjYy5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLCAgIyDGr3UgdGnDqm4gxJHDoyBsb2dpbgogICAgICAgICAgICAgICAgLWxhc3Rfd29ya190aW1lLCAgIyDGr3UgdGnDqm4gbMOidSBraMO0bmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIC1hY2MuZ2V0KCJqb2JfdG9kYXkiLCAwKSAgIyDGr3UgdGnDqm4gw610IGpvYiBoxqFuIChkw7luZyBqb2JfdG9kYXkgdGhheSB2w6wgZGFpbHlfam9iX2NvdW50KQogICAgICAgICAgICApCiAgICAgICAgCiAgICAgICAgYXZhaWxhYmxlX2FjY291bnRzLnNvcnQoa2V5PXNvcnRfa2V5LCByZXZlcnNlPVRydWUpCiAgICAgICAgcmV0dXJuIGF2YWlsYWJsZV9hY2NvdW50c1swXQogICAgCiAgICBkZWYgX3JlY29yZF9hY3Rpb25faGlzdG9yeShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGFjdGlvbjogc3RyLCBzdWNjZXNzOiBib29sKToKICAgICAgICAiIiIKICAgICAgICBHaGkgbOG6oWkgbOG7i2NoIHPhu60gaMOgbmggxJHhu5luZyBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgYWN0aW9uOiBMb+G6oWkgaMOgbmggxJHhu5luZwogICAgICAgICAgICBzdWNjZXNzOiBDw7MgdGjDoG5oIGPDtG5nIGtow7RuZwogICAgICAgICIiIgogICAgICAgIGlmIGFjY291bnRfaWQgbm90IGluIHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeToKICAgICAgICAgICAgc2VsZi5hY2NvdW50X2FjdGlvbl9oaXN0b3J5W2FjY291bnRfaWRdID0gW10KICAgICAgICAKICAgICAgICBoaXN0b3J5X2VudHJ5ID0gewogICAgICAgICAgICAnYWN0aW9uJzogYWN0aW9uLAogICAgICAgICAgICAnc3VjY2Vzcyc6IHN1Y2Nlc3MsCiAgICAgICAgICAgICd0aW1lc3RhbXAnOiBkYXRldGltZS5ub3coKS5pc29mb3JtYXQoKQogICAgICAgIH0KICAgICAgICAKICAgICAgICBzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnlbYWNjb3VudF9pZF0uYXBwZW5kKGhpc3RvcnlfZW50cnkpCiAgICAgICAgCiAgICAgICAgIyBHaeG7ryB04buRaSDEkWEgNTAgZW50cmllcyBjaG8gbeG7l2kgYWNjb3VudAogICAgICAgIGlmIGxlbihzZWxmLmFjY291bnRfYWN0aW9uX2hpc3RvcnlbYWNjb3VudF9pZF0pID4gNTA6CiAgICAgICAgICAgIHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXSA9IHNlbGYuYWNjb3VudF9hY3Rpb25faGlzdG9yeVthY2NvdW50X2lkXVstNTA6XQogICAgCiAgICBkZWYgc2FmZV9zbGVlcChzZWxmLCBzZWNvbmRzOiBmbG9hdCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBTbGVlcCBhbiB0b8OgbiB24bubaSBraOG6oyBuxINuZyBi4buLIGdpw6FuIMSRb+G6oW4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBzZWNvbmRzOiBT4buRIGdpw6J5IGPhuqduIHNsZWVwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugc2xlZXAgaG/DoG4gdGjDoG5oLCBGYWxzZSBu4bq/dSBi4buLIGZvcmNlIHN0b3AKICAgICAgICAiIiIKICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUgPCBzZWNvbmRzOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5ydW5uaW5nIG9yIHNlbGYuZm9yY2Vfc3RvcDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBjaGVja19pbnRlcnZhbCA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImNoZWNrX2ludGVydmFsIiwgMC41KQogICAgICAgICAgICB0aW1lLnNsZWVwKGNoZWNrX2ludGVydmFsKQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAKICAgIGRlZiBfdmFsaWRhdGVfYW5kX3VwZGF0ZV9lbmFibGVkX2FwcHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgY+G6rXAgbmjhuq10IGRhbmggc8OhY2ggZW5hYmxlZF9hcHBzIGLhurFuZyBjw6FjaCBsb+G6oWkgYuG7jyBjw6FjIGFwcCBjaMawYSBjw6BpIMSR4bq3dAogICAgICAgIFPhu60gZOG7pW5nIG1hcHBpbmcgdMSpbmggdGhheSB2w6wgdOG6oW8gam9iIGhhbmRsZXJzIHThuqFtIHRo4budaSDEkeG7gyB0csOhbmggY29uZmxpY3QKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaeG7g20gdHJhIHbDoCBj4bqtcCBuaOG6rXQgZGFuaCBzw6FjaCBlbmFibGVkX2FwcHMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBNYXBwaW5nIHTEqW5oIGFwcF9uYW1lIC0+IGFwcF9wYWNrYWdlIChs4bqleSB04burIGPDoWMgam9iIGhhbmRsZXJzKQogICAgICAgICAgICBhcHBfcGFja2FnZXMgPSB7CiAgICAgICAgICAgICAgICAidGlrdG9rIjogImNvbS5zcy5hbmRyb2lkLnVnYy50cmlsbCIsCiAgICAgICAgICAgICAgICAidGlrdG9rMiI6ICJjb20uemhpbGlhb2FwcC5tdXNpY2FsbHkiLCAKICAgICAgICAgICAgICAgICJpbnN0YWdyYW0iOiAiY29tLmluc3RhZ3JhbS5hbmRyb2lkIiwKICAgICAgICAgICAgICAgICJ5b3V0dWJlIjogImNvbS5nb29nbGUuYW5kcm9pZC55b3V0dWJlIgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBjdXJyZW50X2VuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0X2dsb2JhbF9jb25maWcoe30pLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgdmFsaWRhdGVkX2FwcHMgPSBbXQogICAgICAgICAgICByZW1vdmVkX2FwcHMgPSBbXQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGN1cnJlbnRfZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGFwcF9wYWNrYWdlID0gYXBwX3BhY2thZ2VzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfcGFja2FnZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFwcCBjw7MgxJHGsOG7o2MgY8OgaSDEkeG6t3Qga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuaGVscGVyLmlzX2FwcF9pbnN0YWxsZWQoYXBwX3BhY2thZ2UpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYi4pyTIHthcHBfbmFtZX0gKHthcHBfcGFja2FnZX0pIMSRw6MgY8OgaSDEkeG6t3QiKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZF9hcHBzLmFwcGVuZChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4pyXIHthcHBfbmFtZX0gKHthcHBfcGFja2FnZX0pIGNoxrBhIGPDoGkgxJHhurd0LCBz4bq9IGLhu4sgbG/huqFpIGLhu48iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHBhY2thZ2UgbWFwcGluZyBjaG8gYXBwOiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3ZlZF9hcHBzLmFwcGVuZChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBhcHAge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICAgICByZW1vdmVkX2FwcHMuYXBwZW5kKGFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZW5hYmxlZF9hcHBzIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgICAgICBpZiByZW1vdmVkX2FwcHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkxv4bqhaSBi4buPIHtsZW4ocmVtb3ZlZF9hcHBzKX0gYXBwIGNoxrBhIGPDoGkgxJHhurd0OiB7JywgJy5qb2luKHJlbW92ZWRfYXBwcyl9IikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiR2nhu68gbOG6oWkge2xlbih2YWxpZGF0ZWRfYXBwcyl9IGFwcCDEkcOjIGPDoGkgxJHhurd0OiB7JywgJy5qb2luKHZhbGlkYXRlZF9hcHBzKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIChnbG9iYWwgY29uZmlnKQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfZ2xvYmFsX2NvbmZpZyh7ImVuYWJsZWRfYXBwcyI6IHZhbGlkYXRlZF9hcHBzfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgY2FjaGUKICAgICAgICAgICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gdmFsaWRhdGVkX2FwcHMKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVOG6pXQgY+G6oyB7bGVuKHZhbGlkYXRlZF9hcHBzKX0gYXBwIHRyb25nIGVuYWJsZWRfYXBwcyDEkeG7gXUgxJHDoyDEkcaw4bujYyBjw6BpIMSR4bq3dCIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHZhbGlkYXRlIGVuYWJsZWRfYXBwczoge2V9IikKCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBNYWluU2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIHThuqFvIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBNYWluU2VydmljZS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgVFLGr+G7mkMga2hpIGto4bufaSB04bqhbyBqb2IgaGFuZGxlcnMKICAgICAgICAgICAgc2VsZi5fdmFsaWRhdGVfYW5kX3VwZGF0ZV9lbmFibGVkX2FwcHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzCiAgICAgICAgICAgIHNlbGYuX2luaXRfam9iX2hhbmRsZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyBjw6FjIGFwcAogICAgICAgICAgICBzZWxmLl9pbml0X2FwcF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSBjw6FjIGNvbmZpZyBt4bq3YyDEkeG7i25oCiAgICAgICAgICAgIHNlbGYuX3NhdmVfZGVmYXVsdF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgZGFpbHkgY291bnRlcnMgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBGZXRjaCBHb0xpa2UgaGVhZGVycyB0csaw4bubYyBraGkgc3luYyBhY2NvdW50cyAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5fZW5zdXJlX2dvbGlrZV9oZWFkZXJzKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzLCBzeW5jIGFjY291bnRzIHPhur0gYuG7iyBnaeG7m2kgaOG6oW4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG7k25nIGLhu5kgYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4sgdsOgIG1hcHBpbmcgR29MaWtlIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIHNlbGYuX3N5bmNfYWxsX2FjY291bnRzX2FuZF9tYXBwaW5nKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jDtG5nIHN5bmMgdHLhuqFuZyB0aMOhaSBsb2dpbiBuZ2F5IGzhuq1wIHThu6ljIG5oxrAgSm9iU2VydmljZQogICAgICAgICAgICAjIFPhur0gbGF6eSBzeW5jIGtoaSBj4bqnbiB0aGnhur90IHRyb25nIF9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gTWFpblNlcnZpY2U6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2Vuc3VyZV9nb2xpa2VfaGVhZGVycyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IEdvTGlrZSBoZWFkZXJzIGtoaSBraOG7n2kgxJHhu5luZyB0b29sIChmZXRjaCB24bubaSByZXRyeSkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyBoZWFkZXJzIGjhu6NwIGzhu4cgaG/hurdjIGzhuqV5IMSRxrDhu6NjIGhlYWRlcnMgbeG7m2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBraeG7g20gdHJhIHbDoCBs4bqleSBHb0xpa2UgaGVhZGVycy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgaGVhZGVycyBoaeG7h24gY8OzIHRyxrDhu5tjCiAgICAgICAgICAgIGlmIHNlbGYuZ29saWtlX3NlcnZpY2UuaXNfZ29saWtlX2F1dGhlbnRpY2F0ZWQoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJHb0xpa2UgaGVhZGVycyDEkcOjIGPDsyBz4bq1biB2w6AgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkNoxrBhIGPDsyBHb0xpa2UgaGVhZGVycywgxJFhbmcgY+G7kSBn4bqvbmcgbOG6pXkgbeG7m2kuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkcSDbmcga8O9IHByb3h5IG7hur91IGPhuqduIHRyxrDhu5tjIGtoaSBmZXRjaCBHb0xpa2UgaGVhZGVycwogICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmNoZWNrX3Byb3h5X3JlcXVpcmVtZW50KCk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGzhuqV5IHByb3h5IGNobyB2aeG7h2MgZmV0Y2ggR29MaWtlIGhlYWRlcnMiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyBz4buxIGZldGNoIGhlYWRlcnMgduG7m2kgcmV0cnkKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZ29saWtlX3NlcnZpY2UuZmV0Y2hfZ29saWtlX2hlYWRlcnNfd2l0aF9yZXRyeShmb3JjZV9yZWZyZXNoPUZhbHNlKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLinIUgxJDDoyBs4bqleSBHb0xpa2UgaGVhZGVycyB0aMOgbmggY8O0bmcga2hpIGto4bufaSDEkeG7mW5nIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygi4pqg77iPIEtow7RuZyB0aOG7gyBs4bqleSBHb0xpa2UgaGVhZGVycyBraGkga2jhu59pIMSR4buZbmciKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgbOG6pXkgR29MaWtlIGhlYWRlcnMga2hpIGto4bufaSDEkeG7mW5nOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jaGVja19nb2xpa2VfaGVhZGVycyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIENo4buJIGtp4buDbSB0cmEgR29MaWtlIGhlYWRlcnMgaGnhu4duIGPDsyAoa2jDtG5nIGZldGNoIG3hu5tpKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIGhlYWRlcnMgaOG7o3AgbOG7hwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZ29saWtlX3NlcnZpY2UuaXNfZ29saWtlX2F1dGhlbnRpY2F0ZWQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2nhu4NtIHRyYSBHb0xpa2UgaGVhZGVyczoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfc3luY19hbGxfYWNjb3VudHNfYW5kX21hcHBpbmcoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhu5NuZyBi4buZIGFjY291bnRzIHThu6sgdGhp4bq/dCBi4buLIHbDoCBtYXBwaW5nIEdvTGlrZSBjaG8gdOG6pXQgY+G6oyBhcHBzIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IMSR4buTbmcgYuG7mSBhY2NvdW50cyB2w6AgbWFwcGluZyBHb0xpa2UuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHEg25nIGvDvSBwcm94eSBu4bq/dSBj4bqnbiB0csaw4bubYyBraGkgc3luYyBhY2NvdW50cwogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgbOG6pXkgcHJveHkgY2hvIHZp4buHYyDEkeG7k25nIGLhu5kge2FwcF9uYW1lfSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgMS4gxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4buTbmcgYuG7mSB7bGVuKGFjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiB0aMOsIGLhu48gcXVhIG1hcHBpbmcKICAgICAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkcaw4bujYyDEkeG7k25nIGLhu5kgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIG1hcHBpbmcgR29MaWtlIikKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIDIuIE1hcCB0w6BpIGtob+G6o24gR29MaWtlIChjaOG7iSBraGkgY8OzIEdvTGlrZSBoZWFkZXJzIGjhu6NwIGzhu4cpCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfZ29saWtlX2hlYWRlcnMoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBnb2xpa2VfYWNjb3VudHMgPSBoYW5kbGVyLmdldF9nb2xpa2VfYWNjb3VudHMoKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IHtsZW4oZ29saWtlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgREIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIEdvTGlrZSBoZWFkZXJzIGjhu6NwIGzhu4csIGLhu48gcXVhIG1hcHBpbmcgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSDEkeG7k25nIGLhu5kge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkhvw6BuIHRow6BuaCDEkeG7k25nIGLhu5kgYWNjb3VudHMgdsOgIG1hcHBpbmcgR29MaWtlIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSDEkeG7k25nIGLhu5kgYWNjb3VudHMgdsOgIG1hcHBpbmc6IHtlfSIpCgogICAgZGVmIF9pbml0X2pvYl9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlciBjaG8gdOG7q25nIGFwcCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBzZWxmLmVuYWJsZWRfYXBwcyDEkcOjIMSRxrDhu6NjIHZhbGlkYXRlIHRoYXkgdsOsIGzhuqV5IHThu6sgZGF0YWJhc2UKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5lbmFibGVkX2FwcHMKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gam9iIGhhbmRsZXJzIGNobyBjw6FjIGFwcHMgxJHDoyB2YWxpZGF0ZTogeycsICcuam9pbihlbmFibGVkX2FwcHMpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJ0aWt0b2syIjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2sySm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IEluc3RhZ3JhbUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAieW91dHViZSI6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gWW91dHViZUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkFwcCB7YXBwX25hbWV9IGNoxrBhIMSRxrDhu6NjIGjhu5cgdHLhu6MiKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2jhu59pIHThuqFvIGpvYiBoYW5kbGVyczoge2V9IikKICAgIAogICAgZGVmIF9pbml0X2FwcF9jb25maWdzKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIGNvbmZpZyBt4bq3YyDEkeG7i25oIGNobyB04bqldCBj4bqjIGFwcHMKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBjb25maWcgbeG6t2MgxJHhu4tuaCBjaG8gYXBwcy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEto4bufaSB04bqhbyBjb25maWcgY2hvIHThu6tuZyBqb2IgaGFuZGxlcgogICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gaGFuZGxlci5pbml0X2RlZmF1bHRfYXBwX2NvbmZpZygpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgICMgbG9nZ2VyLmluZm8oZiLEkMOjIGto4bufaSB04bqhbyBjb25maWcgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBraOG7n2kgdOG6oW8gY29uZmlnIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gY29uZmlnIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGto4bufaSB04bqhbyBhcHAgY29uZmlnczoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGNvbmZpZyBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgdGhlbyBzdHJ1Y3R1cmUgbeG7m2kiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgSW1wb3J0IGNvbmZpZyDEkeG7gyBs4bqleSBkZWZhdWx0IHZhbHVlcwogICAgICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgZGVmYXVsdCBnbG9iYWwgY29uZmlnIG7hur91IGNoxrBhIGPDswogICAgICAgICAgICBjdXJyZW50X2dsb2JhbF9jb25maWcgPSBzZWxmLmRiLmdldF9nbG9iYWxfY29uZmlnKHt9KQogICAgICAgICAgICBpZiBub3QgY3VycmVudF9nbG9iYWxfY29uZmlnOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBnbG9iYWwgY29uZmlnIG3hurdjIMSR4buLbmguLi4iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfZ2xvYmFsX2NvbmZpZyhjb25maWcuREVGQVVMVF9HTE9CQUxfQ09ORklHKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgbMawdSBnbG9iYWwgY29uZmlnIG3hurdjIMSR4buLbmgiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGRlZmF1bHQgZ29saWtlIGNvbmZpZyBu4bq/dSBjaMawYSBjw7MKICAgICAgICAgICAgY3VycmVudF9nb2xpa2VfY29uZmlnID0gc2VsZi5kYi5nZXRfZ29saWtlX2NvbmZpZyh7fSkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfZ29saWtlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgdOG6oW8gZ29saWtlIGNvbmZpZyBt4bq3YyDEkeG7i25oLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2dvbGlrZV9jb25maWcoY29uZmlnLkRFRkFVTFRfR09MSUtFX0NPTkZJRykKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGzGsHUgZ29saWtlIGNvbmZpZyBt4bq3YyDEkeG7i25oIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSBkZWZhdWx0IHByb3h5IGNvbmZpZyBu4bq/dSBjaMawYSBjw7MKICAgICAgICAgICAgY3VycmVudF9wcm94eV9jb25maWcgPSBzZWxmLmRiLmdldF9wcm94eV9jb25maWcoe30pCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X3Byb3h5X2NvbmZpZzoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgdOG6oW8gcHJveHkgY29uZmlnIG3hurdjIMSR4buLbmguLi4iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfcHJveHlfY29uZmlnKGNvbmZpZy5ERUZBVUxUX1BST1hZX0NPTkZJRykKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGzGsHUgcHJveHkgY29uZmlnIG3hurdjIMSR4buLbmgiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCLEkMOjIGtp4buDbSB0cmEgdsOgIGzGsHUgY8OhYyBkZWZhdWx0IGNvbmZpZ3MiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGzGsHUgZGVmYXVsdCBjb25maWdzOiB7ZX0iKQogICAgCiAgICBkZWYgZ2V0X2dsb2JhbF9jb25maWcoc2VsZiwga2V5OiBzdHIsIGRlZmF1bHRfdmFsdWU9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY29uZmlnIHThu6sgZ2xvYmFsX2NvbmZpZyB24bubaSBmYWxsYmFjayB24buBIGRlZmF1bHQgdmFsdWUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBrZXk6IFTDqm4gY29uZmlnIGPhuqduIGzhuqV5ICAKICAgICAgICAgICAgZGVmYXVsdF92YWx1ZTogR2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyB0w6xtIHRo4bqleQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBHacOhIHRy4buLIGNvbmZpZyBob+G6t2MgZGVmYXVsdF92YWx1ZQogICAgICAgICIiIgogICAgICAgIGdsb2JhbF9jb25maWcgPSBzZWxmLmRiLmdldF9nbG9iYWxfY29uZmlnKHt9KQogICAgICAgIHJldHVybiBnbG9iYWxfY29uZmlnLmdldChrZXksIGRlZmF1bHRfdmFsdWUpCiAgICAKICAgIGRlZiBfcmVzZXRfZGFpbHlfY291bnRlcnMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgY8OhYyBjb3VudGVyIGjDoG5nIG5nw6B5IHRoZW8gZ2nhu50gxJHGsOG7o2MgY+G6pXUgaMOsbmggKG3hurdjIMSR4buLbmggN2ggc8OhbmcpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3cgPSBkYXRldGltZS5ub3coKQogICAgICAgICAgICByZXNldF9ob3VyID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZGFpbHlfcmVzZXRfaG91ciIsIDcpICAjIE3hurdjIMSR4buLbmggN2ggc8OhbmcKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gdGltZXN0YW1wIGNobyBnaeG7nSByZXNldCBow7RtIG5heQogICAgICAgICAgICB0b2RheV9yZXNldF90aW1lID0gbm93LnJlcGxhY2UoaG91cj1yZXNldF9ob3VyLCBtaW51dGU9MCwgc2Vjb25kPTAsIG1pY3Jvc2Vjb25kPTApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGdp4budIGhp4buHbiB04bqhaSBjaMawYSDEkeG6v24gZ2nhu50gcmVzZXQgaMO0bSBuYXksIHRow6wgZ2nhu50gcmVzZXQgY3Xhu5FpIGPDuW5nIGzDoCBow7RtIHF1YQogICAgICAgICAgICBpZiBub3cgPCB0b2RheV9yZXNldF90aW1lOgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF90aW1lID0gdG9kYXlfcmVzZXRfdGltZSAtIHRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X3RpbWUgPSB0b2RheV9yZXNldF90aW1lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRo4budaSBnaWFuIHJlc2V0IGN14buRaSBjw7luZyB04burIERCCiAgICAgICAgICAgIGxhc3RfcmVzZXRfdGltZXN0YW1wID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygibGFzdF9kYWlseV9yZXNldF90aW1lc3RhbXAiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTbyBzw6FuaCB0aW1lc3RhbXAgxJHhu4MgcXV54bq/dCDEkeG7i25oIGPDsyBj4bqnbiByZXNldCBraMO0bmcKICAgICAgICAgICAgaWYgbGFzdF9yZXNldF90aW1lc3RhbXAgPCBsYXN0X3Jlc2V0X3RpbWUudGltZXN0YW1wKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IGRhaWx5IGNvdW50ZXJzIGzDumMge25vdy5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0gKGdp4budIHJlc2V0OiB7cmVzZXRfaG91cn1oKSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgam9iIGNvdW50ZXJzIC0gbOG6pXkgdOG6pXQgY+G6oyBhY2NvdW50cyAoa2jDtG5nIGZpbHRlcikKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoZGV2aWNlX2lkPUZhbHNlKSAgIyBkZXZpY2VfaWQ9RmFsc2UgxJHhu4Mga2jDtG5nIGZpbHRlciB0aGVvIGRldmljZQogICAgICAgICAgICAgICAgcmVzZXRfY291bnQgPSAwCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaWQiKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX3RvZGF5IjogMCwgICMgU+G7rSBk4bulbmcgam9iX3RvZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9jb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd190b2RheSI6IDAgICMgU+G7rSBk4bulbmcgZm9sbG93X3RvZGF5IHRoYXkgdsOsIGRhaWx5X2ZvbGxvd19jb3VudAogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICByZXNldF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSB0aW1lc3RhbXAgcmVzZXQgbeG7m2kKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2dsb2JhbF9jb25maWcoewogICAgICAgICAgICAgICAgICAgICJsYXN0X2RhaWx5X3Jlc2V0X2RhdGUiOiBub3cuc3RyZnRpbWUoIiVZLSVtLSVkIiksICAjIEdp4buvIMSR4buDIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkKICAgICAgICAgICAgICAgICAgICAibGFzdF9kYWlseV9yZXNldF90aW1lc3RhbXAiOiBpbnQobGFzdF9yZXNldF90aW1lLnRpbWVzdGFtcCgpKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGRhaWx5IGNvdW50ZXJzIGNobyB7cmVzZXRfY291bnR9IHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJEYWlseSBjb3VudGVycyDEkcOjIMSRxrDhu6NjIHJlc2V0IHLhu5NpIChs4bqnbiBjdeG7kWk6IHtkYXRldGltZS5mcm9tdGltZXN0YW1wKGxhc3RfcmVzZXRfdGltZXN0YW1wKS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0pIikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgcmVzZXQgZGFpbHkgY291bnRlcnM6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IGRhaWx5IGNvdW50ZXJzOiB7ZX0iKQogICAgCiAgICBkZWYgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGhv4bq3YyBjaMSDbSBzw7NjCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0XTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGFwcF93b3JrYWJsZV9jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIGFwcF93b3JrYWJsZV9jb3VudCArPSAxCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIMSRxrDhu6NjIHtsZW4od29ya2FibGVfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHThu6sge2xlbihlbmFibGVkX2FwcHMpfSBhcHBzIikKICAgICAgICAKICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm4gc+G7rSBk4bulbmcgxJHDum5nIHTDqm4gdHLGsOG7nW5nIGRhdGFiYXNlCiAgICAgICAgd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLCAgIyDGr3UgdGnDqm4gYWNjb3VudCDEkcOjIGxvZ2luCiAgICAgICAgICAgIC14LmdldCgiam9iX3RvZGF5IiwgMCksICAjIMavdSB0acOqbiBhY2NvdW50IMOtdCBqb2IgaMahbiAoZMO5bmcgam9iX3RvZGF5IHRoYXkgdsOsIGRhaWx5X2pvYl9jb3VudCkKICAgICAgICAgICAgLXguZ2V0KCJsYXN0X2pvYl90aW1lIiwgMCkgICMgxq91IHRpw6puIGFjY291bnQgbMOidSBraMO0bmcgbMOgbSBqb2IgKHRpbWVzdGFtcCBuZ8aw4bujYykKICAgICAgICApLCByZXZlcnNlPVRydWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHdvcmthYmxlX2FjY291bnRzCiAgICAKICAgIGRlZiBfY2FuX3dvcmtfd2l0aF9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBob+G6t2MgY2jEg20gc8OzYyB24bubaSB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgKMOBcCBk4bulbmcgY2hvIGPhuqMgSk9CIHbDoCBDQVJFKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24KICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCByZXNldCBzZXNzaW9uIG7hur91IHF1YSBuZ8OgeSBt4bubaQogICAgICAgICAgICBpZiBzZWxmLl9zaG91bGRfcmVzZXRfc2Vzc2lvbl9vbl9uZXdfZGF5KGFjY291bnRfaWQpOgogICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfYWNjb3VudF9zZXNzaW9uKGFjY291bnRfaWQsICJOZ8OgeSBt4bubaSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgc3RhdHVzIChz4butIGThu6VuZyBsb2dpYyBuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyBpbiBbImRpc2FibGVkIiwgImxvZ291dCJdOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGluYWN0aXZlLCBraeG7g20gdHJhIGpvYl9kaXNhYmxlX3VudGlsIChnaeG7kW5nIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA+IHRpbWUudGltZSgpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBW4bqrbiDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYl9lbmFibGUgPSAxIChib29sZWFuIGNoZWNrKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBhcHAgY8OzIMSRxrDhu6NjIGVuYWJsZSBraMO0bmcKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDsyBqb2IgaGFuZGxlciBraMO0bmcKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgYWNjb3VudCBjw7MgxJFhbmcgbmdo4buJIG5nxqFpIGtow7RuZwogICAgICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X3Jlc3RpbmcoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtIw5RORyBraeG7g20gdHJhIGlzX2dvbGlrZV9saW5rZWQg4bufIMSRw6J5IC0gxJHhu4MgY2hvIF9jYW5fcnVuX2pvYigpIGNoZWNrCiAgICAgICAgICAgICMgQWNjb3VudCBjw7MgdGjhu4MgxJHGsOG7o2MgY2jEg20gc8OzYyBtw6Aga2jDtG5nIGPhuqduIGxpbmsgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgYWNjb3VudCB3b3JrYWJsZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9jYW5fZG9fam9iX3dpdGhfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdGjhu4MgbMOgbSBKT0IgduG7m2kgdMOgaSBraG/huqNuIGtow7RuZyAocmnDqm5nIGJp4buHdCB24bubaSBjYXJlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgY8ahIGLhuqNuIHRyxrDhu5tjCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGRhaWx5IGpvYiBsaW1pdCAtIGzhuqV5IHThu6sgYXBwIGNvbmZpZyB0aGF5IHbDrCBhY2NvdW50IHJlY29yZAogICAgICAgICAgICBkYWlseV9qb2JfY291bnQgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkgICMgRmllbGQgdGjhuq10IHRyb25nIERCCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhaWx5IGpvYiBsaW1pdCB04burIGFwcCBjb25maWcgdGhheSB2w6wgYWNjb3VudCByZWNvcmQKICAgICAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgam9iX2hhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGRhaWx5X2pvYl9saW1pdCA9IGpvYl9oYW5kbGVyLmdldF9jb25maWcoIm1heF9qb2JzX3Blcl9kYXkiLCAzMCkgICMgRGVmYXVsdCAzMCBu4bq/dSBraMO0bmcgY8OzIGNvbmZpZwogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9ICh7YXBwX25hbWV9KTogVXNpbmcgYXBwLWJhc2VkIGRhaWx5IGxpbWl0OiB7ZGFpbHlfam9iX2xpbWl0fSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIG7hur91IGtow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgZGFpbHlfam9iX2xpbWl0ID0gMzAgICMgRGVmYXVsdCBoYXJkY29kZQogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJBY2NvdW50IHt1c2VybmFtZX06IE5vIGpvYiBoYW5kbGVyIGZvciBhcHAge2FwcF9uYW1lfSwgdXNpbmcgZGVmYXVsdCBkYWlseSBsaW1pdDoge2RhaWx5X2pvYl9saW1pdH0iKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQWNjb3VudCB7dXNlcm5hbWV9IGpvYiBsaW1pdCBjaGVjazogam9iX3RvZGF5PXtkYWlseV9qb2JfY291bnR9LCBhcHBfZGFpbHlfbGltaXQ9e2RhaWx5X2pvYl9saW1pdH0iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGFpbHlfam9iX2xpbWl0ID4gMCBhbmQgZGFpbHlfam9iX2NvdW50ID49IGRhaWx5X2pvYl9saW1pdDoKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBkYWlseSBqb2IgbGltaXQgKHtkYWlseV9qb2JfY291bnR9L3tkYWlseV9qb2JfbGltaXR9KSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBhY2NvdW50IGPDsyDEkWFuZyByZXN0aW5nIGtow7RuZwogICAgICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X3Jlc3RpbmcoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJBY2NvdW50IHt1c2VybmFtZX0gxJFhbmcgcmVzdGluZyIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgR29MaWtlIGxpbmsgKGPhuqduIGNobyBqb2IpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge3VzZXJuYW1lfSBjaMawYSBsaW5rIEdvTGlrZSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge3VzZXJuYW1lfSBjw7MgdGjhu4MgbMOgbSBqb2I6IGpvYnM9e2RhaWx5X2pvYl9jb3VudH0ve2RhaWx5X2pvYl9saW1pdH0sIGdvbGlrZT17YWNjb3VudC5nZXQoJ2lzX2dvbGlrZV9saW5rZWQnLCBGYWxzZSl9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraeG7g20gdHJhIGNhbiBkbyBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfZ2V0X25leHRfd29ya2FibGVfYWNjb3VudChzZWxmKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdMOgaSBraG/huqNuIHRp4bq/cCB0aGVvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIGxvZ2ljIHThu5FpIMawdSB04burIEpvYlNlcnZpY2U6CiAgICAgICAgMS4gVMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgKHThu6sgdHJhY2tpbmcpCiAgICAgICAgMi4gVMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIENo4buJIHZlcmlmeSBsb2dpbiB0aOG7sWMgdOG6vyBraGkgbOG6p24gxJHhuqd1IGhv4bq3YyBraGkgY+G6p24gdGhp4bq/dAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIE9wdGlvbmFsW0RpY3RdOiBUw6BpIGtob+G6o24gxJHGsOG7o2MgY2jhu41uIGhv4bq3YyBOb25lCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIELGsOG7m2MgMTogS2nhu4NtIHRyYSBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCB0csaw4bubYwogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50OgogICAgICAgICAgICAgICAgY3VycmVudF9pZCA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIktp4buDbSB0cmEgY3VycmVudCBhY2NvdW50OiB7Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IGRhdGEgbeG7m2kgbmjhuqV0IHThu6sgZGF0YWJhc2UKICAgICAgICAgICAgICAgIHVwZGF0ZWRfY3VycmVudF9hY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChjdXJyZW50X2lkKQogICAgICAgICAgICAgICAgaWYgdXBkYXRlZF9jdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjdXJyZW50IGFjY291bnQgY8OzIGPDsm4gxJHhu6cgxJFp4buBdSBraeG7h24gbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgY2FuX2NvbnRpbnVlID0gKAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQodXBkYXRlZF9jdXJyZW50X2FjY291bnQpIGFuZAogICAgICAgICAgICAgICAgICAgICAgICBub3Qgc2VsZi5faXNfYWNjb3VudF9yZXN0aW5nKGN1cnJlbnRfaWQpIGFuZAogICAgICAgICAgICAgICAgICAgICAgICBub3Qgc2VsZi5fc2hvdWxkX3N3aXRjaF9hY2NvdW50KGN1cnJlbnRfaWQpCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGNhbl9jb250aW51ZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVGnhur9wIHThu6VjIHbhu5tpIGN1cnJlbnQgYWNjb3VudDoge2N1cnJlbnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgIyBVcGRhdGUgd29ya2luZyBhY2NvdW50IHbhu5tpIGRhdGEgbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSB1cGRhdGVkX2N1cnJlbnRfYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdXBkYXRlZF9jdXJyZW50X2FjY291bnQKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkN1cnJlbnQgYWNjb3VudCB7Y3VycmVudF91c2VybmFtZX0ga2jDtG5nIGPDsm4gbMOgbSB2aeG7h2MgxJHGsOG7o2MsIHTDrG0gYWNjb3VudCBt4bubaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIMSQ4bq3dCBhY2NvdW50IGhp4buHbiB04bqhaSBuZ2jhu4kgbmfGoWkgbuG6v3UgY+G6p24KICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fc2hvdWxkX3N3aXRjaF9hY2NvdW50KGN1cnJlbnRfaWQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oY3VycmVudF9pZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbiA9IGYiU2Vzc2lvbiBsaW1pdDoge3Nlc3Npb25bJ2FjdGlvbl9jb3VudCddfSBhY3Rpb25zLCB7c2Vzc2lvblsnam9iX2NvdW50J119IGpvYnMiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXRfYWNjb3VudF9yZXN0KGN1cnJlbnRfaWQsIHJlYXNvbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDhurd0IGFjY291bnQge2N1cnJlbnRfdXNlcm5hbWV9IG5naOG7iSBuZ8ahaSAtIHtyZWFzb259IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJDdXJyZW50IGFjY291bnQge2N1cnJlbnRfaWR9IGtow7RuZyB04buTbiB04bqhaSB0cm9uZyBEQiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAyOiBUw6xtIGFjY291bnQgxJFhbmcgxJHEg25nIG5o4bqtcCB04burIHRyYWNraW5nIChuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyBraGkgbOG6p24gxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIGFwcCBuw6B5IChjaOG7iSBraGkgY+G6p24pCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgICMgQ2jhu4kgdmVyaWZ5IGtoaSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIHRyb25nIHRyYWNraW5nIGhv4bq3YyBraGkgdHJhY2tpbmcga2jDtG5nIGjhu6NwIGzhu4cKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbOG6p24gxJHhuqd1Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50X2xvZ2luX3N0YXR1c193aXRoX3JlYWxpdHkoYXBwX25hbWUsIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSB0w6BpIGtob+G6o24gdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRw6MgdGjhu60gdmVyaWZ5IMSR4buDIGtow7RuZyB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ8OzIHRyYWNraW5nIHLhu5NpLCBraMO0bmcgY+G6p24gdmVyaWZ5IG5nYXkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyB0cmFja2luZwogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBsb2dnZWRfaW5fYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudCBhbmQgc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgICAgICAjIFZlcmlmeSBhY2NvdW50IHRo4buxYyB04bq/IHRyw6puIGFwcCAocXVhbiB0cuG7jW5nIHNhdSBraGkgcmVzdGFydCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fdmVyaWZ5X2FjY291bnRfaW5fYXBwKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB2w6AgdmVyaWZpZWQgdMOgaSBraG/huqNuIHThu6sgdHJhY2tpbmc6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHRyYWNraW5nIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGtow7RuZyB2ZXJpZnkgxJHGsOG7o2MsIHjDs2EgdHJhY2tpbmciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBWZXJpZnkgZnVuY3Rpb24gxJHDoyB04buxIMSR4buZbmcgeMOzYSB0cmFja2luZyB2w6Agc3luYywgdGnhur9wIHThu6VjIHTDrG0gYWNjb3VudCBraMOhYwogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIGjhu6NwIGzhu4csIHjDs2Ega2jhu49pIHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChsb2dnZWRfaW5fYWNjb3VudF9pZCwgeyJpc19sb2dpbiI6IEZhbHNlLCAiaXNfc3luYyI6IEZhbHNlfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIGRvIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAzOiBUw6xtIHTDoGkga2hv4bqjbiDEkcSDbmcgbmjhuq1wIHThu6sgZGF0YWJhc2UgduG7m2kgdmVyaWZpY2F0aW9uIHRo4buxYyB04bq/CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgIyDGr3UgdGnDqm4gdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyBEQiAtIHPhu60gZOG7pW5nIGZpZWxkICJpc19sb2dpbiIgbmjGsCBKb2JTZXJ2aWNlCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpIGFuZCBzZWxmLl9jYW5fd29ya193aXRoX2FjY291bnQoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgUVVBTiBUUuG7jE5HOiBWZXJpZnkgdGjhu7FjIHThur8gdHLDqm4gYXBwIHRyxrDhu5tjIGtoaSB0aW4gdMaw4bufbmcgREIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fdmVyaWZ5X2FjY291bnRfaW5fYXBwKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB2w6AgdmVyaWZpZWQgdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXA6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJBY2NvdW50IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGtow7RuZyB2ZXJpZnkgxJHGsOG7o2MsIHRp4bq/cCB04bulYyB0w6xtLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVmVyaWZ5IHPhur0gdOG7sSDEkeG7mW5nIHN5bmMgdsOgIGPhuq1wIG5o4bqtdCB0cmFja2luZywgdGnhur9wIHThu6VjIHbhu5tpIGFjY291bnQga2jDoWMKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyA0OiBO4bq/dSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wLCBs4bqleSB0w6BpIGtob+G6o24gdGhlbyB0aOG7qSB04buxCiAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERlYnVnOiBUaOG7kW5nIGvDqiBjaGkgdGnhur90IGFjY291bnRzIHRoZW8gYXBwCiAgICAgICAgICAgIHRvdGFsX2FjY291bnRzID0gMAogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIHRvdGFsX2FjY291bnRzICs9IGxlbihhY2NvdW50cykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYi8J+TsSBBcHAge2FwcF9uYW1lfToge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUGjDom4gdMOtY2ggdOG7q25nIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgd29ya2FibGVfY291bnQgPSAwCiAgICAgICAgICAgICAgICBmb3IgYWNjIGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjLmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ3Vua25vd24nKQogICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9IGFjYy5nZXQoJ3N0YXR1cycsICd1bmtub3duJykKICAgICAgICAgICAgICAgICAgICBqb2JfZW5hYmxlID0gYWNjLmdldCgnam9iX2VuYWJsZScsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIGlzX2xvZ2luID0gYWNjLmdldCgnaXNfbG9naW4nLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpc19nb2xpa2VfbGlua2VkID0gYWNjLmdldCgnaXNfZ29saWtlX2xpbmtlZCcsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIGpvYl90b2RheSA9IGFjYy5nZXQoJ2pvYl90b2RheScsIDApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBkYWlseSBqb2IgbGltaXQgdOG7qyBhcHAgY29uZmlnIHRoYXkgdsOsIGFjY291bnQgcmVjb3JkCiAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUgPSBhY2MuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICAgICAgam9iX2hhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgZGFpbHlfam9iX2xpbWl0ID0gam9iX2hhbmRsZXIuZ2V0X2NvbmZpZygibWF4X2pvYnNfcGVyX2RheSIsIDMwKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhaWx5X2pvYl9saW1pdCA9IDMwICAjIERlZmF1bHQgZmFsbGJhY2sKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY8OzIHdvcmthYmxlIGtow7RuZwogICAgICAgICAgICAgICAgICAgIGNhbl93b3JrID0gc2VsZi5fY2FuX3dvcmtfd2l0aF9hY2NvdW50KGFjYykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiIgICB7dXNlcm5hbWV9OiBzdGF0dXM9e3N0YXR1c30sIGpvYl9lbmFibGU9e2pvYl9lbmFibGV9LCAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmImlzX2xvZ2luPXtpc19sb2dpbn0sIGdvbGlrZT17aXNfZ29saWtlX2xpbmtlZH0sICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiam9icz17am9iX3RvZGF5fS97ZGFpbHlfam9iX2xpbWl0fSwgY2FuX3dvcms9e2Nhbl93b3JrfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgY2FuX3dvcms6CiAgICAgICAgICAgICAgICAgICAgICAgIHdvcmthYmxlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLmFwcGVuZChhY2MpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIiAgIOKGkiB7d29ya2FibGVfY291bnR9L3tsZW4oYWNjb3VudHMpfSBjw7MgdGjhu4MgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn5SNIFThu5VuZyBr4bq/dDoge2xlbihhbGxfd29ya2FibGVfYWNjb3VudHMpfS97dG90YWxfYWNjb3VudHN9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdOG7qyB7bGVuKHNlbGYuZW5hYmxlZF9hcHBzKX0gYXBwcyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIuKdjCBLaMO0bmcgY8OzIGFjY291bnQgbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgLSBraeG7g20gdHJhIGxvZyBjaGkgdGnhur90IOG7nyB0csOqbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjogYXBwIG5hbWUsIGNyZWF0ZWRfZGF0ZQogICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydCgKICAgICAgICAgICAgICAgIGtleT1sYW1iZGEgeDogKHguZ2V0KCJhcHAiLCAiIiksIHguZ2V0KCJjcmVhdGVkX2RhdGUiLCAiIikpCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLhuqMgduG7gSBhY2NvdW50IMSR4bqndSB0acOqbgogICAgICAgICAgICBzZWxlY3RlZF9hY2NvdW50ID0gYWxsX3dvcmthYmxlX2FjY291bnRzWzBdCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2jhu41uIGFjY291bnQgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjoge3NlbGVjdGVkX2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHtzZWxlY3RlZF9hY2NvdW50LmdldCgnYXBwJyl9KSIpCiAgICAgICAgICAgIHJldHVybiBzZWxlY3RlZF9hY2NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF92ZXJpZnlfYWNjb3VudF9pbl9hcHAoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmVyaWZ5IGFjY291bnQgdGjhu7FjIHThur8gdHLDqm4gYXBwIGPDsyDEkcO6bmcgYWNjb3VudCDEkWFuZyBsb2dpbiB0cm9uZyBEQiBraMO0bmcKICAgICAgICBO4bq/dSBraMO0bmcgxJHDum5nIHRow6wgc3luYyBs4bqhaSBhY2NvdW50IHThu6sgYXBwIHbhu4EgREIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBBY2NvdW50IHThu6sgREIgY8OzIGlzX2xvZ2luID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGFjY291bnQgxJHDum5nIGhv4bq3YyBzeW5jIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBleHBlY3RlZF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgYWNjb3VudCB7ZXhwZWN0ZWRfdXNlcm5hbWV9IHRyw6puIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IE3hu58gYXBwIHbDoCBraeG7g20gdHJhIGFjY291bnQgaGnhu4duIHThuqFpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGFwcCDEkcaw4bujYyBt4bufCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICdlbnN1cmVfYXBwX29wZW4nKToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLmVuc3VyZV9hcHBfb3BlbigpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdXNlcm5hbWUgdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gaGFuZGxlci5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgY3VycmVudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBs4bqleSDEkcaw4bujYyB1c2VybmFtZSBoaeG7h24gdOG6oWkgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgIyBTZXQgYWNjb3VudCB24buBIGlzX2xvZ2luID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsiaXNfbG9naW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgIyBYw7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNvIHPDoW5oIHbhu5tpIGFjY291bnQgdHJvbmcgREIKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdXNlcm5hbWUubG93ZXIoKSA9PSBleHBlY3RlZF91c2VybmFtZS5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi4pyFIFZlcmlmaWVkOiBBY2NvdW50IHtleHBlY3RlZF91c2VybmFtZX0gxJHDum5nIMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiLinYwgQWNjb3VudCBtaXNtYXRjaDogREI9e2V4cGVjdGVkX3VzZXJuYW1lfSwgQXBwPXtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgIyBD4bqnbiBzeW5jIGzhuqFpIHThu6sgYXBwIHbhu4EgREIKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fc3luY19hY2NvdW50X2Zyb21fYXBwX3RvX2RiKGFwcF9uYW1lLCBjdXJyZW50X3VzZXJuYW1lKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBfdmVyaWZ5X2FjY291bnRfaW5fYXBwOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3N5bmNfYWNjb3VudF9mcm9tX2FwcF90b19kYihzZWxmLCBhcHBfbmFtZTogc3RyLCBjdXJyZW50X3VzZXJuYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgU3luYyBhY2NvdW50IHThu6sgYXBwIHbhu4EgREIga2hpIHBow6F0IGhp4buHbiBtaXNtYXRjaAogICAgICAgIFPhu60gZOG7pW5nIGxvZ2ljIHThu6sgSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lOiBVc2VybmFtZSDEkWFuZyBsb2dpbiB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBzeW5jIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyBhY2NvdW50IHThu6sge2FwcF9uYW1lfSB24buBIERCLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHEg25nIGvDvSBwcm94eSBu4bq/dSBj4bqnbiB0csaw4bubYyBraGkgc3luYyBhY2NvdW50cwogICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmNoZWNrX3Byb3h5X3JlcXVpcmVtZW50KCk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBs4bqleSBwcm94eSBjaG8gdmnhu4djIMSR4buTbmcgYuG7mSB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IFN5bmMgdOG6pXQgY+G6oyBhY2NvdW50cyB04burIGFwcCAobmjGsCBKb2JTZXJ2aWNlKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mgc3luYyB7bGVuKGFjY291bnRzKX0gYWNjb3VudHMgdOG7qyB7YXBwX25hbWV9IikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc3luYyBhY2NvdW50cyB04burIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAyOiBSZXNldCB04bqldCBj4bqjIGFjY291bnRzIGPhu6dhIGFwcCB24buBIGlzX2xvZ2luID0gRmFsc2UKICAgICAgICAgICAgYXBwX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhcHBfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAzOiBUw6xtIHbDoCBj4bqtcCBuaOG6rXQgYWNjb3VudCDEkWFuZyBsb2dpbiB0aOG7sWMgdOG6vwogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFwcF9hY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIikubG93ZXIoKSA9PSBjdXJyZW50X3VzZXJuYW1lLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9hY2NvdW50ID0gYWNjb3VudAogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBhY2NvdW50IGhp4buHbiB04bqhaSB24buBIGlzX2xvZ2luID0gVHJ1ZQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChjdXJyZW50X2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGN1cnJlbnRfYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBTeW5jIHRow6BuaCBjw7RuZzogQWNjb3VudCB7Y3VycmVudF91c2VybmFtZX0gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQgbG9naW4gc3RhdHVzIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIuKdjCBLaMO0bmcgdMOsbSB0aOG6pXkgYWNjb3VudCB7Y3VycmVudF91c2VybmFtZX0gdHJvbmcgREIgc2F1IHN5bmMiKQogICAgICAgICAgICAgICAgIyBYw7NhIHRyYWNraW5nCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHN5bmMgYWNjb3VudCB04burIGFwcCB24buBIERCOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAiIiIKICAgICAgICBWYWxpZGF0ZSB0cuG6oW5nIHRow6FpIGxvZ2luIHRo4buxYyB04bq/IHRyw6puIMSRaeG7h24gdGhv4bqhaSBz4butIGThu6VuZyBow6BtIGPDsyBz4bq1biBj4bunYSBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIGxvZ2luIHRo4buxYyB04bq/IHRyw6puIMSRaeG7h24gdGhv4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSBjw7Mgc+G6tW4gxJHhu4MgY2hlY2sgbG9naW4gc3RhdHVzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFwcCB7YXBwX25hbWV9IMSRw6MgbG9naW4gduG7m2kgdXNlcm5hbWU6IHtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQXBwIHthcHBfbmFtZX0gY2jGsGEgbG9naW4gaG/hurdjIGtow7RuZyBs4bqleSDEkcaw4bujYyB1c2VybmFtZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgbG9naW4gc3RhdHVzIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogc+G7rSBk4bulbmcgdHLhuqFuZyB0aMOhaSB04burIERCCiAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHZhbGlkYXRlIGFjdHVhbCBsb2dpbiBzdGF0dXM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2lzX2NvcnJlY3RfYWNjb3VudF9sb2dnZWRfaW4oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gxJHDum5nIGFjY291bnQgbsOgeSDEkWFuZyDEkcSDbmcgbmjhuq1wIHRyw6puIMSRaeG7h24gdGhv4bqhaSBraMO0bmcKICAgICAgICBT4butIGThu6VuZyBow6BtIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSBjw7Mgc+G6tW4gY+G7p2EgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDum5nIGFjY291bnQgbsOgeSDEkWFuZyDEkcSDbmcgbmjhuq1wCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICB0YXJnZXRfdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSBjw7Mgc+G6tW4KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdXNlcm5hbWUgYW5kIHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBpc19jb3JyZWN0ID0gY3VycmVudF91c2VybmFtZS5sb3dlcigpID09IHRhcmdldF91c2VybmFtZS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ3VycmVudCBsb2dnZWQ6IHtjdXJyZW50X3VzZXJuYW1lfSwgVGFyZ2V0OiB7dGFyZ2V0X3VzZXJuYW1lfSwgTWF0Y2g6IHtpc19jb3JyZWN0fSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzX2NvcnJlY3QKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiS2jDtG5nIGzhuqV5IMSRxrDhu6NjIGN1cnJlbnQgdXNlcm5hbWUgaG/hurdjIHRhcmdldCB1c2VybmFtZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGzhuqV5IGN1cnJlbnQgdXNlcm5hbWUgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiBhc3N1bWUgY29ycmVjdCBu4bq/dSBraMO0bmcgY2hlY2sgxJHGsOG7o2MKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNoZWNrIGNvcnJlY3QgYWNjb3VudCBsb2dnZWQgaW46IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2goc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBjaHV54buDbiDEkeG7lWkgdMOgaSBraG/huqNuIHPhu60gZOG7pW5nIGxvZ2ljIGPDsyBz4bq1biB0cm9uZyBoYW5kbGVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gY+G6p24gY2h1eeG7g24gdOG7m2kKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjaHV54buDbiDEkeG7lWkgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnMuZ2V0KGFwcF9uYW1lKQogICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgY8OzIGhhbmRsZXIgY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIHN3aXRjaCBzYW5nIGFjY291bnQge3VzZXJuYW1lfSB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgY2FyZSBhY3Rpb24gY291bnRlciBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuCiAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjdXJyZW50IGxvZ2dlZCBhY2NvdW50IHRyxrDhu5tjIGtoaSBzd2l0Y2gKICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gc3dpdGNoIGFjY291bnQgYuG6sW5nIGhhbmRsZXIgLSBz4butIGThu6VuZyBow6BtIGPDsyBz4bq1bgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gc3dpdGNoX3RvX2FjY291bnQgY8OzIHPhurVuIHRyb25nIGhhbmRsZXIKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoaGFuZGxlciwgJ3N3aXRjaF90b19hY2NvdW50Jyk6CiAgICAgICAgICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjIHN3aXRjaAogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc3dpdGNoX3Jlc3VsdCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgSGFuZGxlciB0cuG6oyB24buBIHJlc3VsdCBkaWN0CiAgICAgICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzd2l0Y2hfcmVzdWx0LmdldCgic3VjY2VzcyIsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gc3dpdGNoX3Jlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN3aXRjaCBhY2NvdW50IHRow6BuaCBjw7RuZzoge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2luIHRyb25nIERCIHbDoCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoYXBwX25hbWUsIGFjY291bnRfaWQsIFRydWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTd2l0Y2ggYWNjb3VudCB0aOG6pXQgYuG6oWk6IHt1c2VybmFtZX0gLSB7bWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBIYW5kbGVyIHRy4bqjIHbhu4EgYm9vbGVhbiAobGVnYWN5KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTd2l0Y2ggYWNjb3VudCB0aMOgbmggY8O0bmc6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBsb2dpbiB0cm9uZyBEQiB2w6AgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKGFwcF9uYW1lLCBhY2NvdW50X2lkLCBUcnVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU3dpdGNoIGFjY291bnQgdGjhuqV0IGLhuqFpOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiBz4butIGThu6VuZyBlbnN1cmVfYWNjb3VudF9sb2dnZWRfaW4KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJIYW5kbGVyIHthcHBfbmFtZX0ga2jDtG5nIGPDsyBzd2l0Y2hfdG9fYWNjb3VudCwgZMO5bmcgZW5zdXJlX2FjY291bnRfbG9nZ2VkX2luIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5zdXJlX2FjY291bnRfbG9nZ2VkX2luKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBzd2l0Y2ggYWNjb3VudCB7dXNlcm5hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHBlcmZvcm0gYWNjb3VudCBzd2l0Y2g6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfZW5zdXJlX2FjY291bnRfbG9nZ2VkX2luKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyB0w6BpIGtob+G6o24gxJHDoyDEkcSDbmcgbmjhuq1wIHRyw6puIGFwcCB24bubaSBsb2dpYyB04buRaSDGsHUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgxJHEg25nIG5o4bqtcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHRhcmdldF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGhhbmRsZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyBjw7MgaGFuZGxlciBjaG8gYXBwIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMTogS2nhu4NtIHRyYSB4ZW0gY8OzIGPhuqduIHN3aXRjaCBhY2NvdW50IGtow7RuZwogICAgICAgICAgICBjdXJyZW50X2xvZ2dlZF9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIG5lZWRzX2FjY291bnRfc3dpdGNoID0gKGN1cnJlbnRfbG9nZ2VkX2FjY291bnRfaWQgIT0gYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5lZWRzX2FjY291bnRfc3dpdGNoOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJD4bqnbiBjaHV54buDbiBhY2NvdW50OiBjdXJyZW50PXtjdXJyZW50X2xvZ2dlZF9hY2NvdW50X2lkfSAtPiB0YXJnZXQ9e2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDI6IFZhbGlkYXRlIGzhuqFpIHbhu5tpIGFwcCB0aOG7sWMgdOG6vyB0csaw4bubYyBraGkgc3dpdGNoCiAgICAgICAgICAgICAgICBzaG91bGRfc3dpdGNoID0gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBU4buQSSDGr1U6IENo4buJIHZlcmlmeSBraGkgdGjhu7FjIHPhu7EgbmdoaSBuZ+G7nSBj4bqnbiBzd2l0Y2gKICAgICAgICAgICAgICAgICAgICAjIE7hur91IG1lbW9yeSB0cmFja2luZyBjaG8gYmnhur90IMSRw6MgxJHDum5nIGFjY291bnQsIHNraXAgdmVyaWZpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyBhbmQgXAogICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID09IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIk1lbW9yeSB0cmFja2luZyBjaG8gYmnhur90IMSRw6MgxJHDum5nIGFjY291bnQge3RhcmdldF91c2VybmFtZX0sIHNraXAgdmVyaWZpY2F0aW9uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkX3N3aXRjaCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGN1cnJlbnQgdXNlcm5hbWUgdHLDqm4gYXBwIHRo4buxYyB04bq/IHPhu60gZOG7pW5nIGjDoG0gY8OzIHPhurVuCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlZlcmlmeSBjdXJyZW50IHVzZXJuYW1lIHRyw6puIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2FwcF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgY3VycmVudF9hcHBfdXNlcm5hbWUgYW5kIGN1cnJlbnRfYXBwX3VzZXJuYW1lLmxvd2VyKCkgPT0gdGFyZ2V0X3VzZXJuYW1lLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFwcCDEkcOjIMSRw7puZyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0sIGtow7RuZyBj4bqnbiBzd2l0Y2giKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkX3N3aXRjaCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBtZW1vcnkgdHJhY2tpbmcgY2hvIMSRw7puZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFwcCBoaeG7h24gdOG6oWk6ICd7Y3VycmVudF9hcHBfdXNlcm5hbWV9JywgY+G6p24gY2h1eeG7g24gc2FuZzogJ3t0YXJnZXRfdXNlcm5hbWV9JyIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBjaGVjayBjdXJyZW50IHVzZXJuYW1lOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICMgVuG6q24gdGnhur9wIHThu6VjIHN3aXRjaCBu4bq/dSBraMO0bmcgY2hlY2sgxJHGsOG7o2MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDM6IFRo4buxYyBoaeG7h24gc3dpdGNoIGFjY291bnQgY2jhu4kga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgICAgIGlmIHNob3VsZF9zd2l0Y2g6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGNhcmUgYWN0aW9uIGNvdW50ZXIga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2NhcmVfYWN0aW9uX2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgY3VycmVudCBsb2dnZWQgYWNjb3VudCB0csaw4bubYyBraGkgc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN3aXRjaCBhY2NvdW50IC0gaGFuZGxlciBz4bq9IHThu7EgxJHhuqNtIGLhuqNvIGFwcCBt4bufCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gc3dpdGNoX3RvX2FjY291bnQgY8OzIHPhurVuIHRyb25nIGhhbmRsZXIKICAgICAgICAgICAgICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgWOG7rSBsw70ga+G6v3QgcXXhuqMgc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc3dpdGNoX3Jlc3VsdCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc3dpdGNoX3Jlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTd2l0Y2ggYWNjb3VudCB0aOG6pXQgYuG6oWk6IHtzd2l0Y2hfcmVzdWx0LmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiBub3Qgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU3dpdGNoIGFjY291bnQgdGjhuqV0IGLhuqFpIGNobyB7dGFyZ2V0X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgc3dpdGNoIGFjY291bnQ6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJLaMO0bmcgY+G6p24gc3dpdGNoIGFjY291bnQgY2hvIHt0YXJnZXRfdXNlcm5hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkFjY291bnQge3RhcmdldF91c2VybmFtZX0gxJHDoyBsw6AgY3VycmVudCBsb2dnZWQgYWNjb3VudCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgNDogxJDhuqNtIGLhuqNvIOG7nyBob21lIHNjcmVlbiAoaGFuZGxlciBz4bq9IHThu7EgbeG7nyBhcHAgbuG6v3UgY+G6p24pCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgYWJzdHJhY3QgbWV0aG9kIGVuc3VyZV9ob21lX3NjcmVlbiAtIG7DsyBz4bq9IHThu7EgY2hlY2sgdsOgIG3hu58gYXBwCiAgICAgICAgICAgICAgICBpZiBub3QgaGFuZGxlci5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gaG9tZSBzY3JlZW4gY2hvIGFwcCB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXR1cm4gdHLhuqFuZyB0aMOhaSBsb2dpbgogICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvciBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiSGFuZGxlciB7YXBwX25hbWV9IGNoxrBhIGltcGxlbWVudCBhcHAgbWFuYWdlbWVudCBtZXRob2RzOiB7ZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGV4Y2VwdCBOb3RJbXBsZW1lbnRlZEVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJIYW5kbGVyIHthcHBfbmFtZX0gY2jGsGEgaW1wbGVtZW50IGFwcCBtYW5hZ2VtZW50IG1ldGhvZHM6IHtlfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBlbnN1cmUgYWNjb3VudCBsb2dnZWQgaW46IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSBqb2Iga2jDtG5nIChz4butIGThu6VuZyBsb2dpYyBuaMawIEpvYlNlcnZpY2UpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbiAoZ2nhu5FuZyBKb2JTZXJ2aWNlKQogICAgICAgICAgICBhY2NvdW50X3N0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgaW4gWyJkaXNhYmxlZCIsICJsb2dvdXQiXToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBpbmFjdGl2ZSwga2nhu4NtIHRyYSBqb2JfZGlzYWJsZV91bnRpbAogICAgICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPiB0aW1lLnRpbWUoKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gS2nhu4NtIHRyYSBqb2JfZW5hYmxlCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBLaeG7g20gdHJhIMSRw6MgbGnDqm4ga+G6v3QgR29MaWtlIChj4bqnbiBjaG8gam9icykKICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDQuIEtp4buDbSB0cmEgxJHDoyBsb2dpbgogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGRhaWx5IC0gbOG6pXkgdOG7qyBhcHAgY29uZmlnIHRoYXkgdsOsIGFjY291bnQgcmVjb3JkCiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgIGRhaWx5X2NvdW50ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBqb2JfaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgZGFpbHlfbGltaXQgPSBqb2JfaGFuZGxlci5nZXRfY29uZmlnKCJtYXhfam9ic19wZXJfZGF5IiwgMzApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBkYWlseV9saW1pdCA9IDMwICAjIERlZmF1bHQgZmFsbGJhY2sKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkYWlseV9jb3VudCA+PSBkYWlseV9saW1pdDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyA2LiBLaeG7g20gdHJhIGFwcCBjw7MgxJHGsOG7o2MgZW5hYmxlIGtow7RuZwogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgY2FuIHJ1biBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3dvcmtfd2l0aF9zaW5nbGVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCB0w6BpIGtob+G6o24gLSB0aOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgxJHGsOG7o2MgY2jhu41uIHbhu5tpIGxvZ2ljIHThu5FpIMawdQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jDtG5nIGPDsyBs4buXaSBuZ2hpw6ptIHRy4buNbmcgKGFjdGlvbiBjw7MgdGjhu4MgdGjhuqV0IGLhuqFpIG5oxrBuZyBhY2NvdW50IHbhuqtuIOG7lW4pCiAgICAgICAgICAgICAgICAgIEZhbHNlIGNo4buJIGtoaSBjw7MgbOG7l2kgbmdoacOqbSB0cuG7jW5nIGPhuqduIGNsZWFyIGN1cnJlbnQgYWNjb3VudAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogUmVsb2FkIGFjY291bnQgZGF0YSB04burIERCIMSR4buDIMSR4bqjbSBi4bqjbyB0aMO0bmcgdGluIG3hu5tpIG5o4bqldCAoc2F1IHN3aXRjaCkKICAgICAgICAgICAgZnJlc2hfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgZnJlc2hfYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnQgPSBmcmVzaF9hY2NvdW50CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZWxvYWRlZCBmcmVzaCBhY2NvdW50IGRhdGEgZm9yIHt1c2VybmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgcmVsb2FkIGFjY291bnQgZGF0YSBjaG8ge3VzZXJuYW1lfSwgc+G7rSBk4bulbmcgZGF0YSBjxakiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHGsOG7o2Mgc2V0IMSRw7puZwogICAgICAgICAgICBpZiBub3Qgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCBvciBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiaWQiKSAhPSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnQKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPhuq1wIG5o4bqtdCBjdXJyZW50IHdvcmtpbmcgYWNjb3VudDoge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFFVQU4gVFLhu4xORzogxJDhuqNtIGLhuqNvIGFjY291bnQgxJHGsOG7o2Mgc3dpdGNoIHRo4buxYyB04bq/IHRyw6puIG3DoXkKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Vuc3VyZV9hY2NvdW50X3N3aXRjaGVkKGFjY291bnQpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4Mgc3dpdGNoIHNhbmcgYWNjb3VudCB7dXNlcm5hbWV9LCDEkcOhbmggZOG6pXUgcHJvYmxlbWF0aWMiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBhY2NvdW50IGPDsyB24bqlbiDEkeG7gSB2w6Agc2V0IG5naOG7iSBuZ8ahaQogICAgICAgICAgICAgICAgc2VsZi5fc2V0X2FjY291bnRfcmVzdChhY2NvdW50X2lkLCBmIlN3aXRjaCBmYWlsZWQ6IEtow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIGFjY291bnQiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgTOG7l2kgbmdoacOqbSB0cuG7jW5nLCBjbGVhciBjdXJyZW50IGFjY291bnQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gYWNjb3VudCBjw7MgxJFhbmcgbmdo4buJIG5nxqFpIGtow7RuZwogICAgICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X3Jlc3RpbmcoYWNjb3VudF9pZCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkFjY291bnQge3VzZXJuYW1lfSDEkWFuZyBuZ2jhu4kgbmfGoWksIGLhu48gcXVhIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBwaOG6o2kgbOG7l2kgbmdoacOqbSB0cuG7jW5nCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4buNbiBow6BuaCDEkeG7mW5nIG5n4bqrdSBuaGnDqm4gdGjDtG5nIHF1YSBKb2JCYXNlCiAgICAgICAgICAgIGNob3Nlbl9hY3Rpb24gPSBzZWxmLl9jaG9vc2VfcmFuZG9tX2FjdGlvbihhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBzZXNzaW9uIGluZm8gdsOgIGxpbWl0cyDEkeG7gyBoaeG7g24gdGjhu4sKICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCkKICAgICAgICAgICAgc2Vzc2lvbl9saW1pdHMgPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uX2xpbWl0cyhhY2NvdW50KQogICAgICAgICAgICBzZXNzaW9uX2luZm8gPSBmIih7c2Vzc2lvblsnYWN0aW9uX2NvdW50J119L3tzZXNzaW9uX2xpbWl0c1snbWF4X2FjdGlvbnNfcGVyX3Nlc3Npb24nXX0gYWN0aW9ucywgIiBcCiAgICAgICAgICAgICAgICAgICAgICAgICAgZiJ7c2Vzc2lvblsnam9iX2NvdW50J119L3tzZXNzaW9uX2xpbWl0c1snbWF4X2pvYnNfcGVyX3Nlc3Npb24nXX0gam9icykiCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyAne2Nob3Nlbl9hY3Rpb259JyBjaG8ge3VzZXJuYW1lfSB7c2Vzc2lvbl9pbmZvfSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYie2Nob3Nlbl9hY3Rpb259OiB7dXNlcm5hbWV9IHtzZXNzaW9uX2luZm99IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjdGlvbl9zdWNjZXNzID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIMSRxrDhu6NjIGNo4buNbiB0aMO0bmcgcXVhIEpvYkJhc2UKICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGhhbmRsZXI6CiAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBwZXJmb3JtX2FjdGlvbiB04buVbmcgcXXDoXQgdOG7qyBKb2JCYXNlCiAgICAgICAgICAgICAgICBhY3Rpb25fc3VjY2VzcyA9IGhhbmRsZXIucGVyZm9ybV9hY3Rpb24oY2hvc2VuX2FjdGlvbiwgYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgY2FyZSBhY3Rpb24gY291bnQgdsOgIGpvYiByYXRpbyBjaG8gY8OhYyBhY3Rpb24gY2FyZQogICAgICAgICAgICAgICAgIyBDaOG7iSDEkeG6v20gY2FyZSBhY3Rpb25zLCBraMO0bmcgxJFp4buBdSBjaOG7iW5oIGpvYiByYXRpbyBu4buvYQogICAgICAgICAgICAgICAgaWYgYWN0aW9uX3N1Y2Nlc3MgYW5kIGNob3Nlbl9hY3Rpb24gIT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQjoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9pbmNyZW1lbnRfY2FyZV9hY3Rpb25fY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsaWYgYWN0aW9uX3N1Y2Nlc3MgYW5kIGNob3Nlbl9hY3Rpb24gPT0gTWFpblNlcnZpY2VDb25zdGFudHMuQUNUSU9OX0pPQjoKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGNhcmUgYWN0aW9uIGNvdW50IHNhdSBraGkgbMOgbSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzZXRfY2FyZV9hY3Rpb25fY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIGPDsyBoYW5kbGVyIGNobyBhcHAge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBhY3Rpb25fc3VjY2VzcyA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBzZXNzaW9uIGRhdGEKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc2Vzc2lvbihhY2NvdW50X2lkLCBjaG9zZW5fYWN0aW9uLCBhY3Rpb25fc3VjY2VzcykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2hpIGzhuqFpIGzhu4tjaCBz4butIGjDoG5oIMSR4buZbmcKICAgICAgICAgICAgc2VsZi5fcmVjb3JkX2FjdGlvbl9oaXN0b3J5KGFjY291bnRfaWQsIGNob3Nlbl9hY3Rpb24sIGFjdGlvbl9zdWNjZXNzKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgbsOqbiBjaHV54buDbiBhY2NvdW50IGtow7RuZyBzYXUgYWN0aW9uIG7DoHkKICAgICAgICAgICAgc2hvdWxkX3N3aXRjaCA9IHNlbGYuX3Nob3VsZF9zd2l0Y2hfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBzaG91bGRfc3dpdGNoOgogICAgICAgICAgICAgICAgc2Vzc2lvbiA9IHNlbGYuX2dldF9hY2NvdW50X3Nlc3Npb24oYWNjb3VudF9pZCkKICAgICAgICAgICAgICAgIHN3aXRjaF9yZWFzb24gPSBzZWxmLl9nZXRfc3dpdGNoX3JlYXNvbihhY2NvdW50X2lkLCBzZXNzaW9uKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlPhur0gY2h1eeG7g24gYWNjb3VudCBzYXUgYWN0aW9uIG7DoHkuIEzDvSBkbzoge3N3aXRjaF9yZWFzb259IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBRVUFOIFRS4buMTkc6IFPhu60gZOG7pW5nIMSRw7puZyBsb+G6oWkgcmVzdCBk4buxYSB0csOqbiBsw70gZG8KICAgICAgICAgICAgICAgIHNlbGYuX2FwcGx5X2FwcHJvcHJpYXRlX3Jlc3RfdHlwZShhY2NvdW50X2lkLCBzd2l0Y2hfcmVhc29uLCBzZXNzaW9uKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNldCBtZXNzYWdlIGNobyBkZXZpY2UKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYiTmdo4buJIG5nxqFpOiB7dXNlcm5hbWV9ICh7c3dpdGNoX3JlYXNvbn0pIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBmb3JjZSB0w6xtIGFjY291bnQgbeG7m2kgbOG6p24gc2F1CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJldHVybiBGYWxzZSDEkeG7gyBiw6FvIGhp4buHdSBj4bqnbiB0w6xtIGFjY291bnQgbeG7m2kKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXR1cm4gVHJ1ZSB2w6wga2jDtG5nIGPDsyBs4buXaSBuZ2hpw6ptIHRy4buNbmcKICAgICAgICAgICAgIyAoYWN0aW9uIGPDsyB0aOG7gyB0aOG6pXQgYuG6oWkgbmjGsG5nIGFjY291bnQgduG6q24g4buVbikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB3b3JrIHdpdGggc2luZ2xlIGFjY291bnQ6IHtlfSIpCiAgICAgICAgICAgICMgQ2jhu4kgcmV0dXJuIEZhbHNlIGtoaSBjw7MgZXhjZXB0aW9uIG5naGnDqm0gdHLhu41uZwogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9nZXRfc3dpdGNoX3JlYXNvbihzZWxmLCBhY2NvdW50X2lkOiBpbnQsIHNlc3Npb246IERpY3Rbc3RyLCBBbnldKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgbMO9IGRvIGNodXnhu4NuIGFjY291bnQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBhY2NvdW50CiAgICAgICAgICAgIHNlc3Npb246IFNlc3Npb24gZGF0YQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IEzDvSBkbyBjaHV54buDbiBhY2NvdW50CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGNvbmZpZyBsaW1pdHMKICAgICAgICAgICAgbWF4X2NvbnNlY3V0aXZlX2ZhaWxzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygic3dpdGNoX2FjY291bnRfYWZ0ZXJfY29uc2VjdXRpdmVfZmFpbHMiLCAzKQogICAgICAgICAgICBtYXhfbm9fam9iX2F0dGVtcHRzID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygic3dpdGNoX2FjY291bnRfYWZ0ZXJfbm9fam9icyIsIDUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gYWNjb3VudCB2w6Agc2Vzc2lvbiBsaW1pdHMKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICByZXR1cm4gIkFjY291bnQga2jDtG5nIHThu5NuIHThuqFpIgogICAgICAgICAgICAKICAgICAgICAgICAgc2Vzc2lvbl9saW1pdHMgPSBzZWxmLl9nZXRfYWNjb3VudF9zZXNzaW9uX2xpbWl0cyhhY2NvdW50KQogICAgICAgICAgICBtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiA9IHNlc3Npb25fbGltaXRzWyJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiJdCiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gc2Vzc2lvbl9saW1pdHNbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0KICAgICAgICAgICAgbWF4X3Nlc3Npb25fZHVyYXRpb24gPSBzZXNzaW9uX2xpbWl0c1sibWF4X3Nlc3Npb25fZHVyYXRpb24iXQogICAgICAgICAgICAKICAgICAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgc2Vzc2lvbl9kdXJhdGlvbiA9IGN1cnJlbnRfdGltZSAtIHNlc3Npb25bJ3N0YXJ0X3RpbWUnXQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2Vzc2lvbl9kdXJhdGlvbiA+PSBtYXhfc2Vzc2lvbl9kdXJhdGlvbjoKICAgICAgICAgICAgICAgIHJldHVybiBmIkjhur90IHRo4budaSBnaWFuIHNlc3Npb24gKHtzZXNzaW9uX2R1cmF0aW9uLzYwOi4xZn0ve21heF9zZXNzaW9uX2R1cmF0aW9uLzYwOi4xZn0gcGjDunQpIgogICAgICAgICAgICBlbGlmIHNlc3Npb25bJ2FjdGlvbl9jb3VudCddID49IG1heF9hY3Rpb25zX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIGYixJDhuqF0IGdp4bubaSBo4bqhbiBhY3Rpb25zICh7c2Vzc2lvblsnYWN0aW9uX2NvdW50J119L3ttYXhfYWN0aW9uc19wZXJfc2Vzc2lvbn0pIgogICAgICAgICAgICBlbGlmIHNlc3Npb25bJ2pvYl9jb3VudCddID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIGYixJDhuqF0IGdp4bubaSBo4bqhbiBqb2JzICh7c2Vzc2lvblsnam9iX2NvdW50J119L3ttYXhfam9ic19wZXJfc2Vzc2lvbn0pIgogICAgICAgICAgICBlbGlmIHNlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlcy5nZXQoYWNjb3VudF9pZCwgMCkgPj0gbWF4X2NvbnNlY3V0aXZlX2ZhaWxzOgogICAgICAgICAgICAgICAgcmV0dXJuIGYiVGjhuqV0IGLhuqFpIGxpw6puIHRp4bq/cCAoe3NlbGYuYWNjb3VudF9jb25zZWN1dGl2ZV9mYWlsdXJlc1thY2NvdW50X2lkXX0pIgogICAgICAgICAgICBlbGlmIHNlbGYuYWNjb3VudF9ub19qb2JfYXR0ZW1wdHMuZ2V0KGFjY291bnRfaWQsIDApID49IG1heF9ub19qb2JfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICByZXR1cm4gZiJLaMO0bmcgY8OzIGpvYiBsacOqbiB0aeG6v3AgKHtzZWxmLmFjY291bnRfbm9fam9iX2F0dGVtcHRzW2FjY291bnRfaWRdfSkiCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gIktow6FjIgogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBnZXQgc3dpdGNoIHJlYXNvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICJM4buXaSB4w6FjIMSR4buLbmggbMO9IGRvIgogICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIMSR4buZbmcgTWFpblNlcnZpY2UiIiIKICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIMSR4buZbmcgTWFpblNlcnZpY2UuLi4iKQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBu4bq/dSBjaMawYSDEkcaw4bujYyBraOG7n2kgdOG6oW8KICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIE1haW5TZXJ2aWNlIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgICMgQ2jhuqF5IG1haW4gbG9vcCB0cm9uZyB0aHJlYWQKICAgICAgICBzZWxmLnJ1bigpCiAgICAKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhuqF5IE1haW5TZXJ2aWNlIC0gbG9vcCBjaMOtbmgga+G6v3QgaOG7o3AgY2jEg20gc8OzYyB2w6AgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIE1haW5TZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBNYWluU2VydmljZSB24bubaSBsb2dpYyBow6BpIGjDsmEgY2jEg20gc8OzYyB2w6AgbMOgbSB2aeG7h2MuLi4iKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBkZXZpY2VfaWQKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQgaGnhu4duIHThuqFpLCBNYWluU2VydmljZSBraMO0bmcgdGjhu4MgY2jhuqF5IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgd2hpbGUgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAjIFJlc2V0IGJp4bq/biBmb3JjZV9zdG9wIG7hur91IGPDswogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIChjb25maWcgxJHhu5ljIGzhuq1wLCBraMO0bmcgbuG6sW0gdHJvbmcgZ2xvYmFsX2NvbmZpZykKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIsIHThuqFtIGThu6tuZyB44butIGzDvSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBraGkgYuG7iyB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIHByb3h5X2NvbmZpZyA9IHNlbGYuZGIuZ2V0X3Byb3h5X2NvbmZpZyh7fSkKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHByb3h5X2NvbmZpZy5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGRvIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgaW50ZXJuZXQKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmhlbHBlci5jaGVja19pbnRlcm5ldCgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIGvhur90IG7hu5FpIGludGVybmV0LCBuZ2jhu4kgMjBzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgyMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgYWNjb3VudF90b193b3JrID0gc2VsZi5fZ2V0X25leHRfd29ya2FibGVfYWNjb3VudCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3RvX3dvcms6CiAgICAgICAgICAgICAgICAgICAgIyBUxINuZyBjb3VudGVyIGtow7RuZyBjw7MgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfaG9tZSgpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyAobOG6p24ge3NlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50fSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgICAgICBwcm94eV9jb25maWcgPSBzZWxmLmRiLmdldF9wcm94eV9jb25maWcoe30pCiAgICAgICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gcHJveHlfY29uZmlnLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgTWFpblNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9OT19BQ0NPVU5UUykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSB0csaw4bubYyBraGkga2nhu4NtIHRyYSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBraGkgY8OzIHTDoGkga2hv4bqjbiDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHdvcmtpbmcgYWNjb3VudAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIkzDoG0gdmnhu4djIGjDoGkgaMOyYSIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIFRydWUpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBNYWluU2VydmljZUNvbnN0YW50cy5NU0dfV09SS0lOR19IQVJNT05JT1VTKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgd29ya19yZXN1bHQgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoYWNjb3VudF90b193b3JrKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IHdvcmtfcmVzdWx0ID0gRmFsc2UsIG5naMSpYSBsw6AgYWNjb3VudCBj4bqnbiBuZ2jhu4kgbmfGoWkKICAgICAgICAgICAgICAgICMgVGnhur9wIHThu6VjIHTDrG0gYWNjb3VudCBraMOhYyBuZ2F5IGzhuq1wIHThu6ljCiAgICAgICAgICAgICAgICBpZiBub3Qgd29ya19yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkFjY291bnQgxJHDoyDEkcaw4bujYyDEkeG6t3Qgbmdo4buJIG5nxqFpLCB0w6xtIGFjY291bnQga2jDoWMuLi4iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyBs4bqnbiBsw6BtIHZp4buHYyB24bubaSBjw7luZyBhY2NvdW50CiAgICAgICAgICAgICAgICBhY3Rpb25fZGVsYXlfbWluID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiYWN0aW9uX2RlbGF5X21pbiIsIDMpCiAgICAgICAgICAgICAgICBhY3Rpb25fZGVsYXlfbWF4ID0gc2VsZi5nZXRfZ2xvYmFsX2NvbmZpZygiYWN0aW9uX2RlbGF5X21heCIsIDgpCiAgICAgICAgICAgICAgICBkZWxheV90aW1lID0gcmFuZG9tLnJhbmRpbnQoYWN0aW9uX2RlbGF5X21pbiwgYWN0aW9uX2RlbGF5X21heCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtkZWxheV90aW1lfXMgdHLGsOG7m2Mga2hpIGzDoG0gdmnhu4djIHRp4bq/cCB0aGVvIikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoZGVsYXlfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmggTWFpblNlcnZpY2UiKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIAogICAgICAgICMgQ2xlYW51cCBraGkgdGhvw6F0CiAgICAgICAgc2VsZi5fY2xlYW51cF9vbl9leGl0KCkKICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2UgxJHDoyBk4burbmciKQogICAgCiAgICBkZWYgX2NsZWFudXBfb25fZXhpdChzZWxmKToKICAgICAgICAiIiJDbGVhbnVwIGtoaSBNYWluU2VydmljZSBk4burbmciIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTmjhuqMgcHJveHkKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGtoaSBNYWluU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcAogICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IGtoaSBNYWluU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnY2xvc2VfYXBwJyk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBjbGVhbnVwOiB7ZX0iKQogICAgCiAgICBkZWYgX3ZlcmlmeV9jdXJyZW50X2FjY291bnRfb25fYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlciBj4bunYSBhcHAKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIGFwcCwgTm9uZSBu4bq/dSBraMO0bmcgY8OzIGhv4bq3YyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoaGFuZGxlciwgJ2dldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZScpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJIYW5kbGVyIHthcHBfbmFtZX0ga2jDtG5nIGjhu5cgdHLhu6MgZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgdOG7qyBVSQogICAgICAgICAgICBjdXJyZW50X2FjY291bnRfdXNlcm5hbWUgPSBoYW5kbGVyLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gdHJvbmcgREIKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpID09IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlZlcmlmaWVkOiBUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnRfdXNlcm5hbWV9IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbmjGsG5nIGtow7RuZyBjw7MgdHJvbmcgREIiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2ZXJpZnkgY3VycmVudCBhY2NvdW50IHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShzZWxmLCBhcHBfbmFtZTogc3RyLCBoYW5kbGVyKToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaSBpc19sb2dpbiB0cm9uZyBEQiB24bubaSB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIgY+G7p2EgYXBwCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIHZlcmlmeSBhY2NvdW50IChu4bq/dSBj4bqnbikKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKGYiVmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX0sIGLhu48gcXVhIHZlcmlmeSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLl92ZXJpZnlfY3VycmVudF9hY2NvdW50X29uX2FwcChhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgYXBwIG7DoHkgduG7gSBpc19sb2dpbiA9IEZhbHNlIHRyb25nIERCCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICByZXNldF9jb3VudCA9IDAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICByZXNldF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVzZXQgaXNfbG9naW4gPSBGYWxzZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc2V0X2NvdW50ID4gMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQge3Jlc2V0X2NvdW50fSB0w6BpIGtob+G6o24gduG7gSBpc19sb2dpbiA9IEZhbHNlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBpZiBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGN1cnJlbnRfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gY3VycmVudF9hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgdHLhuqFuZyB0aMOhaTogVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGxvZ2luCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IEtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBzeW5jIGxvZ2luIHN0YXR1cyBjaG8ge2FwcF9uYW1lfToge2V9IikKCiAgICBkZWYgX2luaXRpYWxfc3luY19hbGxfYWNjb3VudHNfbG9naW5fc3RhdHVzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBiYW4gxJHhuqd1OiDEkeG7jWMgdOG6pXQgY+G6oyBhcHBzIHbDoCBzeW5jIHRy4bqhbmcgdGjDoWkgaXNfbG9naW4gY2hvIGNodeG6qW4geMOhYwogICAgICAgIENo4buJIGfhu41pIG3hu5l0IGzhuqduIGtoaSBraOG7n2kgxJHhu5luZyBNYWluU2VydmljZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflI0gQuG6r3QgxJHhuqd1IGto4bufaSB04bqhbzogU3luYyB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB04bqldCBj4bqjIGFwcHMuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGVhciB0cmFja2luZyDEkeG7gyBi4bqvdCDEkeG6p3UgZnJlc2gKICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkLmNsZWFyKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU3luYyB04burbmcgYXBwCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TsSBTeW5jIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBIb8OgbiB0aMOgbmggc3luYyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIuKdjCBM4buXaSBzeW5jIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IEZhbHNlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYi4pqg77iPIEtow7RuZyBjw7MgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgc3luYyIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+OryBIb8OgbiB0aMOgbmgga2jhu59pIHThuqFvIHN5bmMgbG9naW4gc3RhdHVzLiBUcmFja2luZzoge3NlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLinYwgTOG7l2kgdHJvbmcgaW5pdGlhbCBzeW5jIGFjY291bnRzOiB7ZX0iKQoKICAgIGRlZiBfdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgYWNjb3VudF9pZDogaW50LCBpc19sb2dpbjogYm9vbCk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBj4bunYSB0w6BpIGtob+G6o24gKHTGsMahbmcgdOG7sSBKb2JTZXJ2aWNlKQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCB0w6BpIGtob+G6o24gCiAgICAgICAgICAgIGlzX2xvZ2luOiBUcnVlIG7hur91IMSRw6MgxJHEg25nIG5o4bqtcCwgRmFsc2UgbuG6v3UgbG9nb3V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGlzX2xvZ2luLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcgdHJvbmcgbWVtb3J5CiAgICAgICAgICAgIGlmIGlzX2xvZ2luOgogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGtow6FjIGPhu6dhIGPDuW5nIGFwcCBsw6AgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIG9sZF9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBpZiBvbGRfYWNjb3VudF9pZCAhPSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KG9sZF9hY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBjxakge29sZF9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkgbG9nb3V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IHTDoGkga2hv4bqjbiBt4bubaQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgWMOzYSBraOG7j2kgdHJhY2tpbmcgbuG6v3UgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzIGFuZCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wOiB7ZX0iKQoKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBNYWluU2VydmljZSIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgTWFpblNlcnZpY2UuLi4iKQogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBmb3JjZV9zdG9wX2FsbChzZWxmKToKICAgICAgICAiIiJGb3JjZSBzdG9wIHThuqV0IGPhuqMiIiIKICAgICAgICBsb2dnZXIuaW5mbygiRm9yY2Ugc3RvcCBNYWluU2VydmljZS4uLiIpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IFRydWUKICAgIAogICAgZGVmIGdldF9zZXJ2aWNlX3N0YXRzKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4buRbmcga8OqIGPhu6dhIE1haW5TZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdDogVGjhu5FuZyBrw6ogc2VydmljZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBzZWxmLl9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHN0YXRzID0gewogICAgICAgICAgICAgICAgInNlcnZpY2VfdHlwZSI6ICJNYWluU2VydmljZSIsCiAgICAgICAgICAgICAgICAiaXNfcnVubmluZyI6IHNlbGYucnVubmluZywKICAgICAgICAgICAgICAgICJpc19pbml0aWFsaXplZCI6IHNlbGYuaXNfaW5pdGlhbGl6ZWQsCiAgICAgICAgICAgICAgICAidG90YWxfd29ya2FibGVfYWNjb3VudHMiOiBsZW4od29ya2FibGVfYWNjb3VudHMpLAogICAgICAgICAgICAgICAgImN1cnJlbnRfd29ya2luZ19hY2NvdW50Ijogc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgZWxzZSBOb25lLAogICAgICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IHNlbGYuZ2V0X2VuYWJsZWRfYXBwcygpLAogICAgICAgICAgICAgICAgImNhcmVfYWN0aW9uX2NvdW50cyI6IHNlbGYuY2FyZV9hY3Rpb25fY291bnRzLAogICAgICAgICAgICAgICAgIm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCI6IHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50LAogICAgICAgICAgICAgICAgInByb3h5X2FjdGl2ZSI6IHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKSBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ2lzX3Byb3h5X2FjdGl2ZScpIGVsc2UgRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHN0YXRzCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgZ2V0IHNlcnZpY2Ugc3RhdHM6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgCiAgICAjIE1ldGhvZHMgxJHhu4MgdMawxqFuZyB0aMOtY2ggduG7m2kgSm9iU2VydmljZSBpbnRlcmZhY2UgY2hvIE1RVFQgc2VydmljZQogICAgZGVmIGhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoc2VsZiwgY29uZmlnX2NoYW5nZXM6IERpY3Rbc3RyLCBBbnldID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIE1RVFQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfY2hhbmdlczogQ8OhYyB0aGF5IMSR4buVaSBjb25maWcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJNYWluU2VydmljZSBuaOG6rW4gY29uZmlnIHVwZGF0ZSB04burIE1RVFQiKQogICAgICAgICAgICBpZiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ29uZmlnIGNoYW5nZXM6IHtjb25maWdfY2hhbmdlc30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBlbmFibGVkX2FwcHMgbuG6v3UgY8OzIHRoYXkgxJHhu5VpIHRyb25nIGdsb2JhbF9jb25maWcKICAgICAgICAgICAgICAgIGlmICJnbG9iYWxfY29uZmlnIiBpbiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgICAgICAgICBvbGRfZW5hYmxlZF9hcHBzID0gc2VsZi5lbmFibGVkX2FwcHMuY29weSgpICAjIENhY2hlIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgZ2xvYmFsX2NvbmZpZyBt4bubaSB04burIGRhdGFiYXNlIHNhdSBraGkgxJHDoyBsxrB1CiAgICAgICAgICAgICAgICAgICAgbmV3X2dsb2JhbF9jb25maWcgPSBzZWxmLmRiLmdldF9nbG9iYWxfY29uZmlnKHt9KQogICAgICAgICAgICAgICAgICAgIG5ld19lbmFibGVkX2FwcHMgPSBuZXdfZ2xvYmFsX2NvbmZpZy5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBlbmFibGVkX2FwcHMgY8OzIHRoYXkgxJHhu5VpIGtow7RuZwogICAgICAgICAgICAgICAgICAgIGlmIHNldChvbGRfZW5hYmxlZF9hcHBzKSAhPSBzZXQobmV3X2VuYWJsZWRfYXBwcyk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUGjDoXQgaGnhu4duIHRoYXkgxJHhu5VpIGVuYWJsZWRfYXBwczoge29sZF9lbmFibGVkX2FwcHN9IC0+IHtuZXdfZW5hYmxlZF9hcHBzfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFjhu60gbMO9IHRoYXkgxJHhu5VpIGVuYWJsZWRfYXBwcwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9oYW5kbGVfZW5hYmxlZF9hcHBzX2NoYW5nZShvbGRfZW5hYmxlZF9hcHBzLCBuZXdfZW5hYmxlZF9hcHBzKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBTeW5jIGNhY2hlIHbhu5tpIGdsb2JhbF9jb25maWcgbeG7m2kKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5lbmFibGVkX2FwcHMgPSBuZXdfZW5hYmxlZF9hcHBzCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBzeW5jIGVuYWJsZWRfYXBwcyBjYWNoZToge3NlbGYuZW5hYmxlZF9hcHBzfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJlbmFibGVkX2FwcHMga2jDtG5nIHRoYXkgxJHhu5VpIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHN5bmNfc3RhdHVzIGNoYW5nZXMgdsOgIHJlbG9hZCBhY2NvdW50cyBu4bq/dSBj4bqnbgogICAgICAgICAgICAgICAgc3luY19zdGF0dXNfY2hhbmdlZCA9IEZhbHNlCiAgICAgICAgICAgICAgICBmb3Iga2V5IGluIGNvbmZpZ19jaGFuZ2VzOgogICAgICAgICAgICAgICAgICAgIGlmIGtleS5lbmRzd2l0aCgnX3N5bmNfc3RhdHVzJyk6CiAgICAgICAgICAgICAgICAgICAgICAgIHN5bmNfc3RhdHVzX2NoYW5nZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUGjDoXQgaGnhu4duIHRoYXkgxJHhu5VpIHN5bmMgc3RhdHVzOiB7a2V5fSA9IHtjb25maWdfY2hhbmdlc1trZXldfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHN5bmNfc3RhdHVzX2NoYW5nZWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflIQgU3luYyBzdGF0dXMgxJHDoyB0aGF5IMSR4buVaSwgcmVsb2FkIGFjY291bnRzIHbDoCByZS1zY2FuIHThu6sgdGhp4bq/dCBi4buLLi4uIikKICAgICAgICAgICAgICAgICAgICAjIENsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSR4buDIGZvcmNlIHJlZnJlc2gKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgICAgICMgQ2xlYXIgbG9naW4gdHJhY2tpbmcgxJHhu4MgZm9yY2UgcmUtdmVyaWZpY2F0aW9uCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5jbGVhcigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQuY2xlYXIoKQogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgY8OhYyBjb3VudGVyIMSR4buDIGLhuq90IMSR4bqndSBjeWNsZSBt4bubaQogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fYWNjb3VudF9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRyaWdnZXIgcmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyBjaG8gY8OhYyBhcHAgxJHGsOG7o2MgZW5hYmxlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVzY2FuX2RldmljZV9hY2NvdW50c19hc3luYygpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIuKchSDEkMOjIHJlc2V0IHdvcmtpbmcgYWNjb3VudCwgbG9naW4gdHJhY2tpbmcgdsOgIHRyaWdnZXIgcmUtc2NhbiBzYXUgc3luYyBzdGF0dXMgY2hhbmdlIikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgaGFuZGxlIG1xdHQgY29uZmlnIHVwZGF0ZToge2V9IikKICAgIAogICAgZGVmIGhhbmRsZV9tcXR0X2FjY291bnRfdXBkYXRlKHNlbGYpOgogICAgICAgICIiIljhu60gbMO9IGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdOG7qyBNUVRUIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiTWFpblNlcnZpY2Ugbmjhuq1uIGFjY291bnQgdXBkYXRlIHThu6sgTVFUVCIpCiAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgZm9yY2UgcmVmcmVzaAogICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGhhbmRsZSBtcXR0IGFjY291bnQgdXBkYXRlOiB7ZX0iKQogICAgCiAgICBkZWYgaGFuZGxlX21xdHRfZm9yY2Vfc3RhcnRfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiJY4butIGzDvSB5w6p1IGPhuqd1IGLhuq90IMSR4bqndSBzZXNzaW9uIHThu6sgTVFUVCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk1haW5TZXJ2aWNlIG5o4bqtbiBmb3JjZSBzdGFydCBzZXNzaW9uIHThu6sgTVFUVCIpCiAgICAgICAgICAgICMgUmVzZXQgY8OhYyBjb3VudGVyCiAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGhhbmRsZSBtcXR0IGZvcmNlIHN0YXJ0IHNlc3Npb246IHtlfSIpCiAgICAKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiJTaHV0ZG93biBNYWluU2VydmljZSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlNodXRkb3duIE1haW5TZXJ2aWNlLi4uIikKICAgICAgICAgICAgc2VsZi5zdG9wKCkKICAgICAgICAgICAgc2VsZi5fY2xlYW51cF9vbl9leGl0KCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzaHV0ZG93biBNYWluU2VydmljZToge2V9IikKICAgIAogICAgIyBUaMOqbSBjw6FjIG1ldGhvZCBraMOhYyDEkeG7gyB0xrDGoW5nIHRow61jaCB24bubaSBKb2JTZXJ2aWNlCiAgICBkZWYgcmVzZXRfY3VycmVudF9wcm94eV9pcChzZWxmKSAtPiBib29sOgogICAgICAgICIiIlJlc2V0IElQIHByb3h5IGhp4buHbiB04bqhaSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLnByb3h5X3NlcnZpY2UsICdyZXNldF9jdXJyZW50X3Byb3h5X2lwJyk6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLnJlc2V0X2N1cnJlbnRfcHJveHlfaXAoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBwcm94eSBJUDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBnZXRfcHJveHlfc3RhdHVzKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiJM4bqleSB0cuG6oW5nIHRow6FpIHByb3h5IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYucHJveHlfc2VydmljZSwgJ2dldF9wcm94eV9zdGF0dXMnKToKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZ2V0X3Byb3h5X3N0YXR1cygpCiAgICAgICAgICAgIHJldHVybiAiVW5rbm93biIKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBnZXQgcHJveHkgc3RhdHVzOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIkVycm9yIgogICAgCiAgICBkZWYgZ2V0X3Byb3h5X2luZm8oc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiTOG6pXkgdGjDtG5nIHRpbiBwcm94eSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLnByb3h5X3NlcnZpY2UsICdnZXRfcHJveHlfaW5mbycpOgogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5nZXRfcHJveHlfaW5mbygpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGdldCBwcm94eSBpbmZvOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4ge30KICAgIAogICAgZGVmIF9oYW5kbGVfZW5hYmxlZF9hcHBzX2NoYW5nZShzZWxmLCBvbGRfZW5hYmxlZF9hcHBzOiBMaXN0W3N0cl0sIG5ld19lbmFibGVkX2FwcHM6IExpc3Rbc3RyXSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBraGkgY8OzIHRoYXkgxJHhu5VpIGVuYWJsZWRfYXBwcyB04burIE1RVFQgY29uZmlnIHVwZGF0ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG9sZF9lbmFibGVkX2FwcHM6IERhbmggc8OhY2ggYXBwIMSRxrDhu6NjIGVuYWJsZSB0csaw4bubYyDEkcOzCiAgICAgICAgICAgIG5ld19lbmFibGVkX2FwcHM6IERhbmggc8OhY2ggYXBwIMSRxrDhu6NjIGVuYWJsZSBt4bubaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBYw6FjIMSR4buLbmggYXBwcyBi4buLIGRpc2FibGUKICAgICAgICAgICAgZGlzYWJsZWRfYXBwcyA9IHNldChvbGRfZW5hYmxlZF9hcHBzKSAtIHNldChuZXdfZW5hYmxlZF9hcHBzKQogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZXQobmV3X2VuYWJsZWRfYXBwcykgLSBzZXQob2xkX2VuYWJsZWRfYXBwcykKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRpc2FibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfmqsgQXBwcyBi4buLIGRpc2FibGU6IHtsaXN0KGRpc2FibGVkX2FwcHMpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgMS4gUmVzZXQgY3VycmVudF93b3JraW5nX2FjY291bnQgbuG6v3UgdGh14buZYyBhcHAgYuG7iyBkaXNhYmxlCiAgICAgICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50OgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYXBwID0gc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgICAgICAgICAgICAgaWYgY3VycmVudF9hcHAgaW4gZGlzYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAidW5rbm93biIpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+UhCBSZXNldCBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCB7Y3VycmVudF91c2VybmFtZX0gKHtjdXJyZW50X2FwcH0pIGRvIGFwcCBi4buLIGRpc2FibGUiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIDIuIENsZWFyIGxvZ2luIHRyYWNraW5nIGPhu6dhIGFwcCBi4buLIGRpc2FibGUKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBkaXNhYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLwn6e5IENsZWFyIGxvZ2luIHRyYWNraW5nIGNobyB7YXBwX25hbWV9IChhY2NvdW50X2lkOiB7YWNjb3VudF9pZH0pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIENsZWFyIGluaXRpYWxfYWNjb3VudF92ZXJpZmllZCDEkeG7gyBmb3JjZSByZS12ZXJpZnkgbuG6v3UgYXBwIMSRxrDhu6NjIGVuYWJsZSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkOgogICAgICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+nuSBDbGVhciB2ZXJpZmllZCBzdGF0dXMgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIDMuIFNldCB04bqldCBj4bqjIGFjY291bnRzIGPhu6dhIGFwcCBi4buLIGRpc2FibGUgduG7gSBpc19sb2dpbj1GYWxzZQogICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGRpc2FibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCflIQgU2V0IGlzX2xvZ2luPUZhbHNlIGNobyBhY2NvdW50IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgcmVzZXQgYWNjb3VudHMgY+G7p2Ege2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLinIUgxJDDoyByZXNldCB0cuG6oW5nIHRow6FpIGNobyB7bGVuKGRpc2FibGVkX2FwcHMpfSBhcHBzIGLhu4sgZGlzYWJsZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSBBcHBzIMSRxrDhu6NjIGVuYWJsZToge2xpc3QoZW5hYmxlZF9hcHBzKX0iKQogICAgICAgICAgICAgICAgIyBBcHBzIG3hu5tpIMSRxrDhu6NjIGVuYWJsZSBz4bq9IHThu7EgxJHhu5luZyDEkcaw4bujYyB44butIGzDvSB0cm9uZyBfcmVzY2FuX2RldmljZV9hY2NvdW50c19hc3luYwogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHRyb25nIF9oYW5kbGVfZW5hYmxlZF9hcHBzX2NoYW5nZToge2V9IikKCiAgICBkZWYgX3Jlc2Nhbl9kZXZpY2VfYWNjb3VudHNfYXN5bmMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgUmUtc2NhbiBhY2NvdW50cyB04burIHRoaeG6v3QgYuG7iyBt4buZdCBjw6FjaCBhc3luYyDEkeG7gyBraMO0bmcgYmxvY2sgbWFpbiB0aHJlYWQKICAgICAgICAiIiIKICAgICAgICBkZWYgX3Jlc2Nhbl93b3JrZXIoKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIvCflI0gQuG6r3QgxJHhuqd1IHJlLXNjYW4gYWNjb3VudHMgdOG7qyB0aGnhur90IGLhu4suLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlLXNjYW4gY2hvIHThu6tuZyBhcHAgxJHGsOG7o2MgZW5hYmxlCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYi8J+TsSBSZS1zY2FuIGFjY291bnRzIHThu6sge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHEg25nIGvDvSBwcm94eSBu4bq/dSBj4bqnbiB0csaw4bubYyBraGkgc3luYyBhY2NvdW50cwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5jaGVja19wcm94eV9yZXF1aXJlbWVudCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGzhuqV5IHByb3h5IGNobyB2aeG7h2MgcmUtc2NhbiB7YXBwX25hbWV9LCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2Qgc3luY19hY2NvdW50c190b19kYiB04burIEJhc2VKb2IgdGhheSB2w6wgdOG7sSBpbXBsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRldmljZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIuKchSB7YXBwX25hbWV9OiDEkMOjIHN5bmMge2xlbihkZXZpY2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4siKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIvCfk7Ege2FwcF9uYW1lfTogS2jDtG5nIHTDrG0gdGjhuqV5IGFjY291bnQgbsOgbyB04burIHRoaeG6v3QgYuG7iyBob+G6t2MgbOG7l2kgc3luYyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlLXNjYW4gYWNjb3VudHMgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLwn46vIEhvw6BuIHRow6BuaCByZS1zY2FuIGFjY291bnRzIHThu6sgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBfcmVzY2FuX3dvcmtlcjoge2V9IikKICAgICAgICAKICAgICAgICAjIENo4bqheSB0cm9uZyB0aHJlYWQgcmnDqm5nIMSR4buDIGtow7RuZyBibG9jayBtYWluIGxvb3AKICAgICAgICByZXNjYW5fdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9X3Jlc2Nhbl93b3JrZXIsIGRhZW1vbj1UcnVlKQogICAgICAgIHJlc2Nhbl90aHJlYWQuc3RhcnQoKQogICAgICAgIGxvZ2dlci5pbmZvKCLwn5qAIMSQw6Mga2jhu59pIMSR4buZbmcgcmUtc2NhbiB0aHJlYWQiKQogICAgCiAgICBkZWYgcmVzZXRfZXhwaXJlZF9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiJSZXNldCBjw6FjIHTDoGkga2hv4bqjbiBleHBpcmVkIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggYWNjb3VudHMgZXhwaXJlZCB2w6AgcmVzZXQgbuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FsbF9hY2NvdW50cygpCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19leHBpcmVkIik6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50gY2jGsGEgKHbDrSBk4bulIDEgZ2nhu50pCiAgICAgICAgICAgICAgICAgICAgZXhwaXJlZF90aW1lID0gYWNjb3VudC5nZXQoImV4cGlyZWRfdGltZSIsIDApCiAgICAgICAgICAgICAgICAgICAgaWYgY3VycmVudF90aW1lIC0gZXhwaXJlZF90aW1lID4gMzYwMDogICMgMSBnaeG7nQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IGV4cGlyZWQgYWNjb3VudDoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19leHBpcmVkIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZXhwaXJlZF90aW1lIjogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJoYXNfZXJyb3IiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHJlc2V0IGV4cGlyZWQgYWNjb3VudHM6IHtlfSIpCiAgICAKICAgIGRlZiByZXNldF9sb2dvdXRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgY8OhYyB0w6BpIGtob+G6o24gbG9nb3V0IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJlc2V0IHRy4bqhbmcgdGjDoWkgbG9naW4gY+G7p2EgY8OhYyBhY2NvdW50IG7hur91IGPhuqduCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWxsX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19sb2dpbiIpIGFuZCBhY2NvdW50LmdldCgiaXNfYWN0aXZlIik6CiAgICAgICAgICAgICAgICAgICAgIyBDw7MgdGjhu4MgdGjDqm0gbG9naWMgxJHhu4MgdGjhu60gbG9naW4gbOG6oWkKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSByZXNldCBsb2dvdXQgYWNjb3VudHM6IHtlfSIpCiAgICAKICAgIGRlZiBpc19hY2NvdW50X2Nhbl9ydW5fam9iKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSBjw7MgdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gam9iIGNobyBhcHAga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGNoZWNrIGFjY291bnQgY2FuIHJ1biBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgd29yayhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBNYWluIHdvcmsgbG9vcCB24bubaSBsb2dpYyBjaHV54buDbiBhY2NvdW50IHRow7RuZyBtaW5oCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk1haW5TZXJ2aWNlIGLhuq90IMSR4bqndSBob+G6oXQgxJHhu5luZyB24bubaSBsb2dpYyBzZXNzaW9uIG1hbmFnZW1lbnQiKQogICAgICAgIAogICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IE5vbmUKICAgICAgICB3b3JrX3N0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIAogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgTOG6pXkgYWNjb3VudCDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudCBvciBzZWxmLl9zaG91bGRfc3dpdGNoX2FjY291bnQoY3VycmVudF9hY2NvdW50LmdldCgiaWQiKSk6CiAgICAgICAgICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICAjIFNldCBuZ2jhu4kgbmfGoWkgY2hvIGFjY291bnQgaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3NldF9hY2NvdW50X3Jlc3QoY3VycmVudF9hY2NvdW50LmdldCgiaWQiKSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgTG9nIGzDvSBkbyBjaHV54buDbgogICAgICAgICAgICAgICAgICAgICAgICBzZXNzaW9uID0gc2VsZi5fZ2V0X2FjY291bnRfc2Vzc2lvbihjdXJyZW50X2FjY291bnQuZ2V0KCJpZCIpKQogICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hfcmVhc29uID0gc2VsZi5fZ2V0X3N3aXRjaF9yZWFzb24oY3VycmVudF9hY2NvdW50LmdldCgiaWQiKSwgc2Vzc2lvbikKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDaHV54buDbiB04burIGFjY291bnQge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfS4gTMO9IGRvOiB7c3dpdGNoX3JlYXNvbn0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVMOsbSBhY2NvdW50IG3hu5tpCiAgICAgICAgICAgICAgICAgICAgY3VycmVudF9hY2NvdW50ID0gc2VsZi5fZ2V0X25leHRfYXZhaWxhYmxlX2FjY291bnQoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaMO0bmcgY8OzIGFjY291bnQga2jhuqMgZOG7pW5nLCBjaOG7nSA2MHMuLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCAiQ2jhu50gYWNjb3VudCBraOG6oyBk4bulbmcuLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBzZXNzaW9uIGNobyBhY2NvdW50IG3hu5tpCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGN1cnJlbnRfYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50X2lkIGluIHNlbGYuYWNjb3VudF9zZXNzaW9uczoKICAgICAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuYWNjb3VudF9zZXNzaW9uc1thY2NvdW50X2lkXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IHNlc3Npb24gbeG7m2kgduG7m2kgYWNjb3VudCB7Y3VycmVudF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMw6BtIHZp4buHYyB24bubaSBhY2NvdW50IGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuX3dvcmtfd2l0aF9zaW5nbGVfYWNjb3VudChjdXJyZW50X2FjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBk4burbmcgKG7hur91IGPhuqduKQogICAgICAgICAgICAgICAgd29ya19kdXJhdGlvbiA9IHRpbWUudGltZSgpIC0gd29ya19zdGFydF90aW1lCiAgICAgICAgICAgICAgICBpZiB3b3JrX2R1cmF0aW9uID4gODY0MDA6ICAjIDI0IGdp4budCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgbMOgbSB2aeG7h2MgMjQgZ2nhu50sIG5naOG7iSBuZ8ahaS4uLiIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgS2V5Ym9hcmRJbnRlcnJ1cHQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIHTDrW4gaGnhu4d1IGThu6tuZyB04burIG5nxrDhu51pIGTDuW5nIikKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHRyb25nIHdvcmsgbG9vcDoge2V9IikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzMCkgICMgTmdo4buJIDMwcyBraGkgY8OzIGzhu5dpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIk1haW5TZXJ2aWNlIGvhur90IHRow7pjIGhv4bqhdCDEkeG7mW5nIikK').decode('utf-8'))
