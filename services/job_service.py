import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKZnJvbSBzZXJ2aWNlcy5wcm94eV9zZXJ2aWNlIGltcG9ydCBQcm94eVNlcnZpY2UKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19DT05USU5VT1VTID0gIsSQYW5nIGzDoG0gdmnhu4djIGxpw6puIHThu6VjIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIG5nw6B5IgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgLSBs4bqleSB04burIGRhdGFiYXNlIGhv4bq3YyBjb25maWcKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIHRoZW8gYWNjb3VudF9pZAogICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Agam9iIGZvbGxvdyB0cuG6oyB24buBIHN0YXR1cyA0IChwZW5kaW5nKQogICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBi4buLIHVuZm9sbG93L3VubGlrZSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBs4buXaSBmZXRjaCBqb2IgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyBxdXnhur90IMSR4buLbmggbmjhuqMgcHJveHkKICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJHDoyByZXNldCBJUCBwcm94eSDEkeG7gyB0csOhbmggcmVzZXQgbOG6t3AgbOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcCDEkeG7gyB0csOhbmggc3dpdGNoIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyA9IHt9ICAjIHthcHBfbmFtZTogYWNjb3VudF9pZH0KICAgICAgICAKICAgICAgICAjIEZsYWcgxJHhu4MgdHJhY2sgeGVtIMSRw6MgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCBjaMawYSBraGkga2jhu59pIMSR4buZbmcKICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCA9IHt9ICAjIHthcHBfbmFtZTogYm9vbH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgbMOgbSB2aeG7h2MgxJHhu4MgdHLDoW5oIHF1w6l0IGzhuqFpIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgIGRlZiBfdmVyaWZ5X2N1cnJlbnRfYWNjb3VudF9vbl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0ciwgaGFuZGxlcikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyIGPhu6dhIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4gYXBwLCBOb25lIG7hur91IGtow7RuZyBjw7MgaG/hurdjIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihoYW5kbGVyLCAnZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lJyk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkhhbmRsZXIge2FwcF9uYW1lfSBraMO0bmcgaOG7lyB0cuG7oyBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB04burIFVJCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJykgPT0gY3VycmVudF9hY2NvdW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZpZWQ6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50X3VzZXJuYW1lfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBuaMawbmcga2jDtG5nIGPDsyB0cm9uZyBEQiIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBjdXJyZW50IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGlzX2xvZ2luIHRyb25nIERCIHbhu5tpIHRo4buxYyB04bq/IHRyw6puIGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlciBj4bunYSBhcHAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSB0csaw4bubYyBraGkgdmVyaWZ5IGFjY291bnQgKG7hur91IGPhuqduKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoZiJWZXJpZnkgYWNjb3VudCB0csOqbiB7YXBwX25hbWV9Iik6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgdmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSwgYuG7jyBxdWEgdmVyaWZ5IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuX3ZlcmlmeV9jdXJyZW50X2FjY291bnRfb25fYXBwKGFwcF9uYW1lLCBoYW5kbGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBj4bunYSBhcHAgbsOgeSB24buBIGlzX2xvZ2luID0gRmFsc2UgdHJvbmcgREIKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHJlc2V0X2NvdW50ID0gMAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsiaXNfbG9naW4iOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgcmVzZXRfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IGlzX2xvZ2luID0gRmFsc2UgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNldF9jb3VudCA+IDA6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHtyZXNldF9jb3VudH0gdMOgaSBraG/huqNuIHbhu4EgaXNfbG9naW4gPSBGYWxzZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4KICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChjdXJyZW50X2FjY291bnRbImlkIl0sIHsiaXNfbG9naW4iOiBUcnVlfSkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gY3VycmVudF9hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgdHLhuqFuZyB0aMOhaTogVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJFhbmcgbG9naW4gdGjhuq10IHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGxvZ2luCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IEtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBzeW5jIGxvZ2luIHN0YXR1cyBjaG8ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX2ZvcmNlX3ZlcmlmeV9hY2NvdW50c193aXRoX3Byb3h5KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEZvcmNlIHZlcmlmeSB04bqldCBj4bqjIGFjY291bnQga2hpIMSRw6MgY8OzIHByb3h5IChn4buNaSBraGkgdGjhu7FjIHPhu7EgY+G6p24gdGhp4bq/dCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnMgYW5kIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkZvcmNlIHZlcmlmeSB0w6BpIGtob+G6o24gdHLDqm4ge2FwcF9uYW1lfSB24bubaSBwcm94eS4uLiIpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShhcHBfbmFtZSwgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGZvcmNlIHZlcmlmeSB0w6BpIGtob+G6o24gdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZm9yY2UgdmVyaWZ5IGFjY291bnRzOiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfaXNfY3VycmVudF9hY2NvdW50X3N0aWxsX3dvcmthYmxlKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSBjw7MgY8OybiBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHbhuqtuIGPDsyB0aOG7gyBsw6BtIHZp4buHYywgRmFsc2UgbuG6v3UgY+G6p24gdMOsbSB0w6BpIGtob+G6o24ga2jDoWMKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBt4bubaSBuaOG6pXQgdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgY3VycmVudF9hY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiBJRCB7YWNjb3VudF9pZH0ga2jDtG5nIGPDsm4gdOG7k24gdOG6oWkgdHJvbmcgREIiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIGPDsm4gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgICAgICBjYW5fd29yayA9IHNlbGYuX2Nhbl9ydW5fam9iKGN1cnJlbnRfYWNjb3VudCkKICAgICAgICAgICAgaWYgY2FuX3dvcms6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgduG7m2kgZGF0YSBt4bubaSBuaOG6pXQKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBjdXJyZW50X2FjY291bnQKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGtow7RuZyB0aOG7gyBsw6BtIHZp4buHYyBu4buvYSwgY+G6p24gdMOsbSB0w6BpIGtob+G6o24ga2jDoWMiKQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkga2nhu4NtIHRyYSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpOiB7ZX0iKQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMga2hpIGZvcmNlX3N0b3AgxJHGsOG7o2MgxJHhurd0IHRow6BuaCBUcnVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGNoZWNrX2ludGVydmFsID0gSm9iU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMICAjIEtp4buDbSB0cmEgbeG7l2kgMC41IGdpw6J5CiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyB5w6p1IGPhuqd1IGThu6tuZwogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmfhu6cgbeG7mXQga2hv4bqjbmcgbmfhuq9uCiAgICAgICAgICAgIHNsZWVwX3RpbWUgPSBtaW4oY2hlY2tfaW50ZXJ2YWwsIHNlY29uZHMgLSAodGltZS50aW1lKCkgLSBzdGFydF90aW1lKSkKICAgICAgICAgICAgaWYgc2xlZXBfdGltZSA+IDA6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHNsZWVwX3RpbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBpbml0aWFsaXplKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSB04bqhbyB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICAgICAgIyAxLiBLaeG7g20gdHJhIEhlbHBlclNlcnZpY2UKICAgICAgICBoZWxwZXJfc3VjY2VzcywgaGVscGVyX2RhdGEgPSB1dGlscy5jaGVja19oZWxwZXJfc2VydmljZShzZWxmLmhlbHBlcikKICAgICAgICBpZiBub3QgaGVscGVyX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGvhur90IG7hu5FpIMSR4bq/biBIZWxwZXJTZXJ2aWNlLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBMxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIG7hur91IGPDswogICAgICAgIGlmIGhlbHBlcl9kYXRhIGFuZCAiZGF0YSIgaW4gaGVscGVyX2RhdGE6CiAgICAgICAgICAgIHNlbGYuZGIuc2F2ZV9kZXZpY2VfaW5mbyhoZWxwZXJfZGF0YSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4s6IHtoZWxwZXJfZGF0YVsnZGF0YSddLmdldCgnZGV2aWNlX21vZGVsJywgJ1Vua25vd24nKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgIyAzLiBMxrB1IGPDoWMgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIG7hur91IGNoxrBhIGPDswogICAgICAgIHNlbGYuX3NhdmVfZGVmYXVsdF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyA1LiBLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlcgogICAgICAgIHNlbGYuX2luaXRfam9iX2hhbmRsZXJzKCkKICAgICAgICAKICAgICAgICAjIDYuIEto4bufaSB04bqhbyBuZ8OgeSBjdeG7kWkgY8O5bmcgxJHDoyByZXNldCBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIHRvZGF5ID0gbm93LmRhdGUoKQogICAgICAgIGpvYl9ob3VyID0gc2VsZi5kYi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgIHJlc2V0X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5jb21iaW5lKHRvZGF5LCBkYXRldGltZS50aW1lKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wKSkKICAgICAgICAKICAgICAgICAjIEzhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZyB04burIGRhdGFiYXNlCiAgICAgICAgbGFzdF9yZXNldF9kYXRlX3N0ciA9IHNlbGYuZGIuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKQogICAgICAgIAogICAgICAgIGlmIG5vdCBsYXN0X3Jlc2V0X2RhdGVfc3RyOgogICAgICAgICAgICAjIE7hur91IGhp4buHbiB04bqhaSDEkcOjIHF1YSBnaeG7nSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heSwgxJHDoW5oIGThuqV1IMSRw6MgcmVzZXQKICAgICAgICAgICAgaWYgbm93ID49IHJlc2V0X3RpbWU6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG6v24gZ2nhu50gcmVzZXQsIMSRw6FuaCBk4bqldSBsw6AgxJHDoyByZXNldCBuZ8OgeSBow7RtIHF1YQogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gdG9kYXkgLSBkYXRldGltZS50aW1lZGVsdGEoZGF5cz0xKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsYXN0X3Jlc2V0X2RhdGUiLCBsYXN0X3Jlc2V0X2RhdGUuaXNvZm9ybWF0KCkpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jhu59pIHThuqFvIG5nw6B5IHJlc2V0OiB7bGFzdF9yZXNldF9kYXRlfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZzoge2xhc3RfcmVzZXRfZGF0ZV9zdHJ9IikKICAgICAgICAKICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gVHJ1ZQogICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgdOG6oW8gSm9iU2VydmljZSB0aMOgbmggY8O0bmcuIikKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY+G7p2EgbeG7mXQgYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIGPhuqduIGtp4buDbSB0cmEKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWksIEZhbHNlIG7hur91IGtow7RuZyBj4bqnbgogICAgICAgICIiIgogICAgICAgICMgTOG6pXkgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdOG7qyBkYXRhYmFzZQogICAgICAgIHN5bmNfc3RhdHVzX2tleSA9IGYie2FwcF9uYW1lfV9zeW5jX3N0YXR1cyIKICAgICAgICBzeW5jX3N0YXR1cyA9IHNlbGYuZGIuZ2V0KHN5bmNfc3RhdHVzX2tleSwgRmFsc2UpICAjIE3hurdjIMSR4buLbmggbMOgIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgICMgTuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZIHRow6wgY+G6p24gxJHhu5NuZyBi4buZIGzhuqFpCiAgICAgICAgcmV0dXJuIG5vdCBzeW5jX3N0YXR1cwogICAgICAgIAogICAgZGVmIF91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyLCBzdGF0dXM6IGJvb2wgPSBUcnVlKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY+G7p2EgbeG7mXQgYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICBzdGF0dXM6IFRydWUgbuG6v3UgxJHDoyDEkeG7k25nIGLhu5ksIEZhbHNlIG7hur91IGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICIiIgogICAgICAgIHN5bmNfc3RhdHVzX2tleSA9IGYie2FwcF9uYW1lfV9zeW5jX3N0YXR1cyIKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgIHNlbGYuZGIuc2V0KHN5bmNfc3RhdHVzX2tleSwgc3RhdHVzKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX06IHtzdGF0dXN9IikKICAgICAgICAKICAgIGRlZiBfc3luY19hY2NvdW50c19mb3JfYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIG3hu5l0IGFwcCBj4bulIHRo4buDCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIGPhuqduIMSR4buTbmcgYuG7mQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSR4buTbmcgYuG7mSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgCiAgICAgICAgdHJ5OgoKICAgICAgICAgICAgIyAxLiDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhu5NuZyBi4buZIHtsZW4oYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDIuIE1hcCB0w6BpIGtob+G6o24gR29MaWtlCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgZ29saWtlX2FjY291bnRzID0gaGFuZGxlci5nZXRfZ29saWtlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGdvbGlrZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSB7bGVuKGdvbGlrZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMOBbmggeOG6oSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIG1hcHBlZF9hY2NvdW50cyA9IGhhbmRsZXIubWFwX2dvbGlrZV9hY2NvdW50cyhnb2xpa2VfYWNjb3VudHMsIGRldmljZV9hY2NvdW50cykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMOhbmggeOG6oSB7bGVuKG1hcHBlZF9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IHbhu5tpIEdvTGlrZSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gR29MaWtlIG7DoG8gY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIFRydWUpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgbMOgIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSwgRmFsc2UpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIF9zYXZlX2RlZmF1bHRfY29uZmlncyhzZWxmKToKICAgICAgICAiIiJMxrB1IGPDoWMgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIG7hur91IGNoxrBhIGPDsyIiIgogICAgICAgIGRlZmF1bHRfY29uZmlncyA9IHsKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBsacOqbiBxdWFuIMSR4bq/biB0aOG7nWkgZ2lhbiBsw6BtIGpvYgogICAgICAgICAgICAiam9iX2hvdXIiOiBjb25maWcuSk9CX0hPVVIsCiAgICAgICAgICAgICJqb2JfY29vbGRvd25fbWludXRlcyI6IGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMsCiAgICAgICAgICAgICJqb2JfY2hlY2tfaW50ZXJ2YWwiOiBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMLAogICAgICAgICAgICAiY29vbGRvd25fZ2V0X2pvYl9nb2xpa2UiOiAzMCwgICMgVGjhu51pIGdpYW4gY2jhu50gKHBow7p0KSBraGkga2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBHb0xpa2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gc+G7kSBsxrDhu6NuZyBqb2IKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9kYXkiOiBjb25maWcuTUFYX0pPQlNfUEVSX0RBWSwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLhuqFuZyB0aMOhaSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgInBhdXNlX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdGhp4bq/dCBi4buLIMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICJkZXZpY2VfaXNfd29ya2luZyI6IEZhbHNlLAogICAgICAgICAgICAiZGV2aWNlX21lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRGFuaCBzw6FjaCBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQKICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IGNvbmZpZy5FTkFCTEVEX0FQUFMsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRoaeG6v3QgbOG6rXAgY2hvIHBow6lwIGNoxINtIHPDs2Mga2hpIGzDoG0gam9iCiAgICAgICAgICAgICJjYXJlX2luX3dvcmtpbmdfam9iIjogRmFsc2UsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGdpw6EgdOG7kWkgdGhp4buDdSBjaG8gam9iIGZvbGxvdwogICAgICAgICAgICAibWluX2ZvbGxvd19wcmljZSI6IDIwLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCB44butIGzDvSB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgIm1heF91bmZvbGxvd19hdHRlbXB0cyI6IGNvbmZpZy5NQVhfVU5GT0xMT1dfQVRURU1QVFMsCiAgICAgICAgICAgICJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiOiA3MjAsICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50sIGPDsyB0aOG7gyDEkWnhu4F1IGNo4buJbmggdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggcHJveHkKICAgICAgICAgICAgInVzZV9wcm94eSI6IEZhbHNlLCAgIyBDw7Mgc+G7rSBk4bulbmcgcHJveHkga2jDtG5nCiAgICAgICAgICAgICJwcm94eV9zZXJ2ZXIiOiAiaHR0cDovLzEwLjAuMC41OjkwMzIiLCAgIyBTZXJ2ZXIgcHJveHkgbeG6t2MgxJHhu4tuaAogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZ3MuaXRlbXMoKToKICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBpZiBzZWxmLmRiLmdldChrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldChrZXksIHZhbHVlKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoyBsxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtrZXl9PXt2YWx1ZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ+G6pXUgaMOsbmgge2tleX0gxJHDoyB04buTbiB04bqhaToge3NlbGYuZGIuZ2V0KGtleSl9IikKICAgICAgICAKICAgIGRlZiBfaW5pdF9qb2JfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIiIiIKICAgICAgICAjIGluaXQgdGjDrCBz4bq9IGluaXQgaGFuZGxlcnMgY2hvIHThuqV0IGPhuqMgY8OhYyBhcHAsIGzDoG0gYXBwIG7DoG8gdGjDrCBz4bq9IHRoZW8gY+G6pXUgaMOsbmggbOG6pXkgdOG7qyBkYXRhYmFzZQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBjb25maWcuRU5BQkxFRF9BUFBTOgogICAgICAgICAgICBpZiBhcHBfbmFtZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFRpa3Rva0pvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgIHByb3h5X3NlcnZpY2UgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gSW5zdGFncmFtSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6AgcHJveHlfc2VydmljZSB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mga2jhu59pIHThuqFvIHtsZW4oc2VsZi5qb2JfaGFuZGxlcnMpfSBqb2IgaGFuZGxlcjogeycsICcuam9pbihzZWxmLmpvYl9oYW5kbGVycy5rZXlzKCkpfSIpCiAgICAgICAgCiAgICBkZWYgX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKHNlbGYpOgogICAgICAgICIiIlJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IHbDoG8gZ2nhu50gxJHGsOG7o2MgY+G6pXUgaMOsbmgiIiIKICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIHRvZGF5ID0gbm93LmRhdGUoKQogICAgICAgIAogICAgICAgICMgTOG6pXkgZ2nhu50gcmVzZXQgdOG7qyBj4bqldSBow6xuaCBob+G6t2MgdOG7qyBkYXRhYmFzZSBu4bq/dSBjw7MKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICAKICAgICAgICAjIFTDrW5oIHRo4budaSDEkWnhu4NtIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5CiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gTm9uZQogICAgICAgIAogICAgICAgIGlmIGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IGRhdGV0aW1lLmRhdGUuZnJvbWlzb2Zvcm1hdChsYXN0X3Jlc2V0X2RhdGVfc3RyKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIsSQ4buLbmggZOG6oW5nIG5nw6B5IHJlc2V0IGtow7RuZyBo4bujcCBs4buHOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gTm9uZQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkgY2jGsGEgdsOgIGNoxrBhIHJlc2V0IHRyb25nIG5nw6B5IGjDtG0gbmF5CiAgICAgICAgaWYgbm93ID49IHJlc2V0X3RpbWUgYW5kIChsYXN0X3Jlc2V0X2RhdGUgaXMgTm9uZSBvciBsYXN0X3Jlc2V0X2RhdGUgPCB0b2RheSk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiByZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSAoZ2nhu50gcmVzZXQ6IHtqb2JfaG91cn06MDApIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgY8OhYyBi4buZIMSR4bq/bSBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24KICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgc+G7kSBqb2IgaMO0bSBuYXkgdsOgIHNlc3Npb24gY291bnRlcnMKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF92aWV3X3N0b3JpZXMiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHRy4bqhbmcgdGjDoWkgZm9sbG93IGtoaSBjaHV54buDbiBuZ8OgeSBt4bubaQogICAgICAgICAgICAgICAgICAgICMgQ2jhu4kgZW5hYmxlIGzhuqFpIGZvbGxvdyBu4bq/dSBi4buLIGRpc2FibGUgdsOsIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IChraMO0bmcgcGjDom4gYmnhu4d0IG5nw6B5IGhheSBzZXNzaW9uKQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uID0gYWNjb3VudC5nZXQoImluYWN0aXZlX2ZvbGxvd19yZWFzb24iLCAiIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVhc29uIGluIFsixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyIsICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHNlc3Npb24iXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5hYmxlX2FjY291bnRfZm9sbG93KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgZW5hYmxlIGzhuqFpIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHNhdSBraGkgcmVzZXQgbmfDoHkgKGzDvSBkbyBjxak6IHtyZWFzb259KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSB24bqrbiBkaXNhYmxlIGZvbGxvdyAobMO9IGRvOiB7cmVhc29ufSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHbDrCDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5LAogICAgICAgICAgICAgICAgICAgICMgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgdGjDoG5oIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAiaW5hY3RpdmUiIGFuZCBhY2NvdW50LmdldCgiaW5hY3RpdmVfcmVhc29uIikgPT0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBhY3RpdmUgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBzYXUga2hpIHJlc2V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6BvIHtub3cuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG5nw6B5IMSRw6MgcmVzZXQgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkuaXNvZm9ybWF0KCkpCiAgICAgICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBjaOG6oXkgam9iIGNobyB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgY2jhuqF5IGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMi4gS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBj4bqnbiB0aGnhur90CiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMy4gxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5CiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBzZXNzaW9uCiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9zZXNzaW9uX2xpbWl0KGFjY291bnQpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgIyAuLi5LSMOUTkcga2nhu4NtIHRyYSBmb2xsb3cg4bufIMSRw6J5LCBjaOG7iSBraeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIGNodW5nLi4uCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYmFzaWNfYWNjb3VudF9zdGF0dXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbiBj4bunYSB0w6BpIGtob+G6o24iIiIKICAgICAgICBhY2NvdW50X3N0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiBi4buLIGRpc2FibGVkLCBraMO0bmcgY2hvIGNo4bqheSBqb2IKICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiZGlzYWJsZWQiOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJHDoyBsb2dvdXQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJsb2dvdXQiOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJFhbmcgaW5hY3RpdmUsIGtp4buDbSB0cmEgdGjhu51pIGdpYW4gY29vbGRvd24KICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICByZXR1cm4gc2VsZi5faGFuZGxlX2luYWN0aXZlX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2luYWN0aXZlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiWOG7rSBsw70gdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIiIiCiAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY29vbGRvd24sIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHbhu4EgYWN0aXZlCiAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPD0gdGltZS50aW1lKCk6CiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiAwCiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLnVuZm9sbG93X2F0dGVtcHRzOgogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgZmV0Y2ggam9iIGVycm9yIGNvdW50cyBraGkgdMOgaSBraG/huqNuIGFjdGl2ZSBs4bqhaQogICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50czoKICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgZmV0Y2ggam9iIGVycm9yIGNvdW50cyBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaMO0bmcgdOG7sSDEkeG7mW5nIGVuYWJsZSBmb2xsb3cgLSBjaOG7iSBlbmFibGUga2hpIGjhur90IHRo4budaSBnaWFuIGRpc2FibGVfZm9sbG93CiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBDaMawYSBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBjb29sZG93bl9yZW1haW4gPSBpbnQoKGpvYl9kaXNhYmxlX3VudGlsIC0gdGltZS50aW1lKCkpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50gKGPDsm4ge2Nvb2xkb3duX3JlbWFpbn0gcGjDunQpIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyLCBhY2NvdW50X2lkOiBpbnQsIGlzX2xvZ2luOiBib29sKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCB0w6BpIGtob+G6o24gCiAgICAgICAgICAgIGlzX2xvZ2luOiBUcnVlIG7hur91IMSRw6MgxJHEg25nIG5o4bqtcCwgRmFsc2UgbuG6v3UgbG9nb3V0CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkYXRhYmFzZSAtIHPhu60gZOG7pW5nIGZpZWxkIGlzX2xvZ2luIMSR4buDIG5o4bqldCBxdcOhbiB24bubaSBEQiBzY2hlbWEKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBpc19sb2dpbiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRyYWNraW5nIHRyb25nIG1lbW9yeQogICAgICAgICAgICBpZiBpc19sb2dpbjoKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBraMOhYyBj4bunYSBjw7luZyBhcHAgbMOgIGxvZ291dAogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBvbGRfYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgaWYgb2xkX2FjY291bnRfaWQgIT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChvbGRfYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gY8WpIHtvbGRfYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGxvZ291dCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSB0w6BpIGtob+G6o24gbeG7m2kKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudF9pZAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFjDs2Ega2jhu49pIHRyYWNraW5nIG7hur91IGxvZ291dAogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyBhbmQgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcDoge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIGPDoWMgxJFp4buBdSBraeG7h24gdGnDqm4gcXV54bq/dCBj4bunYSB0w6BpIGtob+G6o24iIiIKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHGsOG7o2MgYuG6rXQgam9iIGtow7RuZwogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2MgbGnDqm4ga+G6v3QgduG7m2kgR29MaWtlIGNoxrBhCiAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIGPhu6dhIHTDoGkga2hv4bqjbiDEkcaw4bujYyB0aGnhur90IGzhuq1wIHbhu5tpIGdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdAogICAgICAgICIiIgogICAgICAgIHVwZGF0ZV9kYXRhID0ge30KICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRoaeG6v3QgbOG6rXAgam9iX21heF9kYXkKICAgICAgICBpZiBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSA8PSAwOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiam9iX21heF9kYXkiXSA9IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgdGhp4bq/dCBs4bqtcCBtYXhfam9ic19wZXJfc2Vzc2lvbgogICAgICAgIGlmIGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIDw9IDA6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJtYXhfam9ic19wZXJfc2Vzc2lvbiJdID0gY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gZGF0YWJhc2UgbuG6v3UgY8OzIHRoYXkgxJHhu5VpCiAgICAgICAgaWYgdXBkYXRlX2RhdGE6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBhY2NvdW50LnVwZGF0ZSh1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAKICAgIGRlZiBfY2xvc2VfYXBwX2Zvcl9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIMSQw7NuZyBhcHAgdMawxqFuZyDhu6luZyB24bubaSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIpCiAgICAgICAgaWYgYXBwX25hbWUgYW5kIGFwcF9uYW1lIGluIGNvbmZpZy5BUFBfUEFDS0FHRVM6CiAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChjb25maWcuQVBQX1BBQ0tBR0VTW2FwcF9uYW1lXSkKICAgICAgICAgICAgCiAgICBkZWYgX2lzX2FjY291bnRfYXRfZGFpbHlfbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgICIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICByZXR1cm4gam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5CiAgICAgICAgCiAgICBkZWYgX2lzX2FjY291bnRfYXRfc2Vzc2lvbl9saW1pdChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHNlc3Npb24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gc2Vzc2lvbgogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAKICAgICAgICBpZiBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHNlc3Npb24gKHtqb2JzX2RvbmVfaW5fc2Vzc2lvbn0ve21heF9qb2JzX3Blcl9zZXNzaW9ufSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaG8gdMOgaSBraG/huqNuIG5naOG7iSB0aGVvIHRo4budaSBnaWFuIGpvYl9jb29sZG93bl9taW51dGVzCiAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmRiLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSBuZ2jhu4kge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IHNhdSBraGkgaG/DoG4gdGjDoG5oIHNlc3Npb24iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY8OzIHPhurVuIHRyb25nIGRiX3NlcnZpY2UgxJHhu4MgxJHhurd0IHTDoGkga2hv4bqjbiBpbmFjdGl2ZQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz1jb29sZG93bl9taW51dGVzLAogICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiSG/DoG4gdGjDoG5oIHNlc3Npb24gKHtqb2JzX2RvbmVfaW5fc2Vzc2lvbn0gam9icyksIG5naOG7iSB7Y29vbGRvd25fbWludXRlc30gcGjDunQiCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgc2Vzc2lvbiBjb3VudGVyIHNhdSBraGkgxJHhurd0IGluYWN0aXZlCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2pvYl9zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgc3VjY2VzczogYm9vbCA9IFRydWUsIGpvYl90eXBlOiBzdHIgPSBOb25lLCBqb2JfcmVzdWx0OiBkaWN0ID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIHN1Y2Nlc3M6IFRydWUgbuG6v3Ugam9iIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iIChmb2xsb3csIGxpa2UsIGV0Yy4pCiAgICAgICAgICAgIGpvYl9yZXN1bHQ6IEvhur90IHF14bqjIGpvYiAoZMO5bmcgxJHhu4MgeOG7rSBsw70gdW5mb2xsb3cpCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gam9iIGPGoSBi4bqjbiAoYmFvIGfhu5NtIGPhuqMgZm9sbG93IHN0YXRzIG7hur91IGzDoCBmb2xsb3cgam9iKQogICAgICAgIHNlbGYuX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoYWNjb3VudCwgc3VjY2Vzcywgam9iX3R5cGUpCiAgICAgICAgCiAgICAgICAgIyBSZXNldCBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgbuG6v3Ugam9iIHRow6BuaCBjw7RuZwogICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgIyBSZXNldCB1bmZvbGxvdyBhdHRlbXB0cyBraGkgam9iIHRow6BuaCBjw7RuZyAoa2jDtG5nIHBo4bqjaSBi4buLIHVuZm9sbG93KQogICAgICAgICAgICBpZiBub3QgKGpvYl9yZXN1bHQgYW5kIGpvYl9yZXN1bHQuZ2V0KCJ1bmZvbGxvdyIsIEZhbHNlKSk6CiAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgQuG7jyBxdWEga2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gc2Vzc2lvbiB2w6wgxJHDoyBjaHV54buDbiBzYW5nIGNvbnRpbnVvdXMgcHJvY2Vzc2luZwogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5CiAgICAgICAgc2VsZi5fY2hlY2tfZGFpbHlfbGltaXRfYWZ0ZXJfam9iKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSB1bmZvbGxvdyBjaG8gam9iIGZvbGxvdwogICAgICAgIGlmIGpvYl90eXBlIGFuZCBqb2JfdHlwZS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICAjIE7hur91IGLhu4sgdW5mb2xsb3cgKGpvYl9yZXN1bHQgY8OzIGtleSAndW5mb2xsb3cnIGhv4bq3YyBzdGF0dXMgxJHhurdjIGJp4buHdCkKICAgICAgICAgICAgaWYgam9iX3Jlc3VsdCBhbmQgam9iX3Jlc3VsdC5nZXQoInVuZm9sbG93IiwgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBUxINuZyBz4buRIGzhuqduIGLhu4sgdW5mb2xsb3cgY2hvIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgICAgICB1bmZvbGxvd19jb3VudCA9IHNlbGYudW5mb2xsb3dfYXR0ZW1wdHMuZ2V0KGFjY291bnRbImlkIl0sIDApICsgMQogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IHVuZm9sbG93X2NvdW50CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIG1heF91bmZvbGxvd19hdHRlbXB0cyA9IHNlbGYuZGIuZ2V0KCJtYXhfdW5mb2xsb3dfYXR0ZW1wdHMiLCBjb25maWcuTUFYX1VORk9MTE9XX0FUVEVNUFRTKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBi4buLIHVuZm9sbG93IGzhuqduIHt1bmZvbGxvd19jb3VudH0ve21heF91bmZvbGxvd19hdHRlbXB0c30iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buJIGtow7NhIHTDoGkga2hv4bqjbiBraGkgxJHhuqF0IGdp4bubaSBo4bqhbiBz4buRIGzhuqduIHVuZm9sbG93CiAgICAgICAgICAgICAgICBpZiB1bmZvbGxvd19jb3VudCA+PSBtYXhfdW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzID0gc2VsZi5kYi5nZXQoInVuZm9sbG93X3BlbmFsdHlfbWludXRlcyIsIDcyMCkgICMgTeG6t2MgxJHhu4tuaCAxMiBnaeG7nSA9IDcyMCBwaMO6dAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBi4buLIHVuZm9sbG93IHt1bmZvbGxvd19jb3VudH0gbOG6p24sIGtow7NhIGZvbGxvdyB7cGVuYWx0eV9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRbImlkIl0sCiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbj1mIkLhu4sgdW5mb2xsb3cge3VuZm9sbG93X2NvdW50fSBs4bqnbiIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBjb3VudGVyIHNhdSBraGkga2jDs2EKICAgICAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgbMOgIHRpa3RvayB0aMOsIGThu6tuZyB0w6BpIGtob+G6o24gbHXDtG4gduG7m2kgdGjhu51pIGdpYW4gcGVuYWx0eSB0xrDGoW5nIOG7qW5nCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImFwcCIpID09ICJ0aWt0b2siOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudFsiaWQiXSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkLhu4sgdW5mb2xsb3cge3VuZm9sbG93X2NvdW50fSBs4bqnbiAoVGlrVG9rKSIKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBi4buLIHVuZm9sbG93IG5oxrBuZyBjaMawYSDEkeG6oXQgZ2nhu5tpIGjhuqFuICh7dW5mb2xsb3dfY291bnR9L3ttYXhfdW5mb2xsb3dfYXR0ZW1wdHN9KSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEpvYiB0aMOgbmggY8O0bmcgdsOgIGtow7RuZyBi4buLIHVuZm9sbG93LCByZXNldCBjb3VudGVyCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzIGFuZCBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wsIGpvYl90eXBlOiBzdHIgPSBOb25lKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iIGPGoSBi4bqjbiAtIGfhu5lwIGPhuqMgZm9sbG93IHN0YXRzIMSR4buDIHRyw6FuaCBj4bqtcCBuaOG6rXQgdHLDuW5nIGzhurdwIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgImxhc3Rfam9iX3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgQ2jhu4kgdMSDbmcgY291bnRlcnMga2hpIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgImpvYl90b2RheSI6IGpvYl90b2RheSArIDEsCiAgICAgICAgICAgICAgICAidG90YWxfam9icyI6IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkgKyAxLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogam9ic19kb25lX2luX3Nlc3Npb24gKyAxCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGzDoCBmb2xsb3cgam9iLCBj4bqtcCBuaOG6rXQgbHXDtG4gZm9sbG93IHN0YXRzIMSR4buDIHRyw6FuaCAyIGzhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICBpZiBqb2JfdHlwZSBhbmQgam9iX3R5cGUubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKSArIDEKICAgICAgICAgICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkgKyAxCiAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiBmb2xsb3dfdG9kYXksCiAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogZm9sbG93X2luX3Nlc3Npb24sCiAgICAgICAgICAgICAgICAgICAgImxhc3RfZm9sbG93X3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIHRo4buxYyBoaeG7h24gZm9sbG93IHRow6BuaCBjw7RuZyAtIFNlc3Npb246IHtmb2xsb3dfaW5fc2Vzc2lvbn0sIEjDtG0gbmF5OiB7Zm9sbG93X3RvZGF5fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZyB0aMO0bmcgdGluIHThu5VuZyBxdWFuIHbhu4Egam9icwogICAgICAgICAgICBqb2JzX2RvbmVfc2Vzc2lvbiA9IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMQogICAgICAgICAgICBqb2JzX3RvZGF5ID0gam9iX3RvZGF5ICsgMQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGhvw6BuIHRow6BuaCBqb2IgLSBTZXNzaW9uOiB7am9ic19kb25lX3Nlc3Npb259L3thY2NvdW50LmdldCgnbWF4X2pvYnNfcGVyX3Nlc3Npb24nLCBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04pfSwgSMO0bSBuYXk6IHtqb2JzX3RvZGF5fS97YWNjb3VudC5nZXQoJ2pvYl9tYXhfZGF5JywgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkpfSIpCiAgICAgICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpICAjIEPhuq1wIG5o4bqtdCBsb2NhbCBkYXRhCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkgc2F1IGtoaSBsw6BtIGpvYiIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5OgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgbmfDoHkgKHtqb2JfdG9kYXl9L3tqb2JfbWF4X2RheX0pIikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9sb2dvdXQoc2VsZiwgYWNjb3VudF9pZDogaW50LCB1c2VybmFtZTogc3RyID0gTm9uZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIMSRw6MgbG9nb3V0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVzZXJuYW1lOiBVc2VybmFtZSDEkeG7gyBsb2cgKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBU4bqhbyBtZXNzYWdlIHbhu5tpIG5nw6B5IGdp4budIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKQogICAgICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYiUGjDoXQgaGnhu4duIGxvZ291dDoge2N1cnJlbnRfdGltZX0iCiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IHTDoGkga2hv4bqjbiB7dXNlcm5hbWUgb3IgYWNjb3VudF9pZH0gbMOgIGxvZ291dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nb3V0IGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lIG9yIGFjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAKICAgIGRlZiByZXNldF9pbmFjdGl2ZV9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGluYWN0aXZlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImluYWN0aXZlIikgb3IgW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gaW5hY3RpdmVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgduG6q24gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyB0w6BpIGtob+G6o24gaW5hY3RpdmUiKQogICAgICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UgdHJvbmcgdGhyZWFkIHJpw6puZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQ6IFRocmVhZCDEkWFuZyBjaOG6oXkgSm9iU2VydmljZSBob+G6t2MgTm9uZSBu4bq/dSBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6t3QgdHLhuqFuZyB0aMOhaSBydW5uaW5nCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcgxJHhu4MgdmVyaWZ5IGzhuqFpIHThu6sgxJHhuqd1CiAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZC5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgY291bnRlcnMga2hpIGLhuq90IMSR4bqndSBwaGnDqm4gbeG7m2kKICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDbGVhciBhY2NvdW50IHRyYWNraW5nIHbDoCByZXNldCBlcnJvciBjb3VudGVycyDEkeG7gyB2ZXJpZnkgbOG6oWkgdOG7qyDEkeG6p3Uga2hpIGto4bufaSDEkeG7mW5nIikKICAgICAgICAgICAgCgogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aHJlYWQKICAgICAgICAgICAgdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5ydW4pCiAgICAgICAgICAgIHRocmVhZC5kYWVtb24gPSBUcnVlCiAgICAgICAgICAgIHRocmVhZC5zdGFydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdGhyZWFkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgSm9iU2VydmljZSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgZGVmIHJlc2V0X2xvZ291dF9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCByZXNldCBjw6FjIHTDoGkga2hv4bqjbiBsb2dvdXQgduG7gSBhY3RpdmUga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICBDaOG7iSBuw6puIGfhu41pIG1ldGhvZCBuw6B5IGtoaSBjw7MgecOqdSBj4bqndSDEkeG6t2MgYmnhu4d0IHThu6sgYWRtaW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBsb2dvdXQKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgbG9nb3V0X2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImxvZ291dCIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGxvZ291dF9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB1bmZvbGxvdyBhdHRlbXB0cyBraGkgcmVzZXQgdMOgaSBraG/huqNuIGxvZ291dAogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQiKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTpzdHIgKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgY2jhuqF5IGpvYiBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgaWYoc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBDaOG6oXkgSm9iU2VydmljZSB0cm9uZyB2w7JuZyBs4bq3cCDEkcahbiBnaeG6o24gLSBs4bqleSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm4KICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuIEtow7RuZyB0aOG7gyBjaOG6oXkuIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgY2jhuqF5IEpvYlNlcnZpY2UgduG7m2kgbG9naWMgbMOgbSB2aeG7h2MgdOG7sSDEkeG7mW5nLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgeMOhYyDEkeG7i25oIGRldmljZV9pZCBoaeG7h24gdOG6oWksIEpvYlNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogCiAgICAgICAgd2hpbGUgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAjIFJlc2V0IGJp4bq/biBmb3JjZV9zdG9wIG7hur91IGPDswogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyLCB04bqhbSBk4burbmcgeOG7rSBsw70gam9iIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOaOG6oyBwcm94eSBuZ2F5IGtoaSBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGRvIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB0cmFja2luZyB2YXJpYWJsZSBraGkgdW5yZWdpc3RlciBwcm94eQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSKQogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKGpvYl9jaGVja19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIHNlbGYucmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIGPhuqduIMSRxINuZyBrw70gcHJveHkga2jDtG5nCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHRyxrDhu5tjLCBjaOG7iSBxdcOpdCBs4bqhaSBraGkgY+G6p24gdGhp4bq/dAogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2lzX2N1cnJlbnRfYWNjb3VudF9zdGlsbF93b3JrYWJsZSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiQ+G6p24gdMOsbSB0w6BpIGtob+G6o24gbeG7m2kgxJHhu4MgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoKQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRfdG9fd29yazoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIG3hu5tpOiB7YWNjb3VudF90b193b3JrLmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF90b193b3JrID0gc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlRp4bq/cCB04bulYyB24bubaSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpOiB7YWNjb3VudF90b193b3JrLmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnRfdG9fd29yazoKICAgICAgICAgICAgICAgICAgICAjIFTEg25nIGNvdW50ZXIga2jDtG5nIGPDsyBqb2IKICAgICAgICAgICAgICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIChs4bqnbiB7c2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnR9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBVbnJlZ2lzdGVyIHByb3h5IG5nYXkga2hpIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djIMSR4buDIHRp4bq/dCBraeG7h20KICAgICAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlVucmVnaXN0ZXIgcHJveHkgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdHJhY2tpbmcgdmFyaWFibGUga2hpIHVucmVnaXN0ZXIgcHJveHkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyDEkMOzbmcgdOG6pXQgY+G6oyBhcHAgc2F1IDMgbOG6p24gbGnDqm4gdGnhur9wIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPj0gMzoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw7NuZyB04bqldCBj4bqjIGFwcCBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyB0cm9uZyB0aOG7nWkgZ2lhbiBkw6BpIikKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lLCBoYW5kbGVyIGluIHNlbGYuam9iX2hhbmRsZXJzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOzbmcgYXBwIHthcHBfbmFtZX0gZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9hbmRfdXBkYXRlX3N0YXR1cyhoYW5kbGVyLCBhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDs25nIGFwcDoge2V9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQga2hv4bqjbmcgbmfhuq9uIHRyxrDhu5tjIGtoaSBraeG7g20gdHJhIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgzMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBjb3VudGVyIGtoaSBjw7MgdMOgaSBraG/huqNuIMSR4buDIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBGZXRjaCBHb0xpa2UgaGVhZGVycyAtIMSR4bqjbSBi4bqjbyBjw7MgcHJveHkgbuG6v3UgY+G6p24gZmV0Y2ggaGVhZGVycyBt4bubaQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIGPhuqduIGzDoG0gbeG7m2kgR29MaWtlIGhlYWRlcnMga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgbmVlZHNfaGVhZGVyc19yZWZyZXNoID0gc2VsZi5nb2xpa2Vfc2VydmljZS5uZWVkc19oZWFkZXJzX3JlZnJlc2goKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSBu4bq/dSBj4bqnbiBmZXRjaCBoZWFkZXJzIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgaWYgbmVlZHNfaGVhZGVyc19yZWZyZXNoOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIkZldGNoIEdvTGlrZSBoZWFkZXJzIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgZmV0Y2ggR29MaWtlIGhlYWRlcnMsIG5naOG7iSAxMHMgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IG5lZWRzX2hlYWRlcnNfcmVmcmVzaDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJHb0xpa2UgaGVhZGVycyBjw7JuIGjhu6NwIGzhu4csIGtow7RuZyBj4bqnbiDEkcSDbmcga8O9IHByb3h5IMSR4buDIGZldGNoIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgaW50ZXJuZXQgc2F1IGtoaSB44butIGzDvSBwcm94eSAodsOsIHByb3h5IGPDsyB0aOG7gyDhuqNuaCBoxrDhu59uZyDEkeG6v24ga+G6v3QgbuG7kWkpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuaGVscGVyLmNoZWNrX2ludGVybmV0KCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIGvhur90IG7hu5FpIGludGVybmV0LCBuZ2jhu4kgMjBzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMjApOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBnb2xpa2VfaGVhZGVycyA9IHNlbGYuZ29saWtlX3NlcnZpY2UuZmV0Y2hfZ29saWtlX2hlYWRlcnNfd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGdvbGlrZV9oZWFkZXJzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiR29MaWtlIGhlYWRlcnMga2jDtG5nIGjhu6NwIGzhu4csIG5naOG7iSA1cyB2w6AgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZmV0Y2ggR29MaWtlIGhlYWRlcnM6IHtlfSwgbmdo4buJIDVzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg1KToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEZvcmNlIHZlcmlmeSBhY2NvdW50IG7hur91IGNoxrBhIMSRxrDhu6NjIHZlcmlmeSB2w6AgY8OzIHByb3h5IG7hur91IGPhuqduCiAgICAgICAgICAgICAgICBzZWxmLl9mb3JjZV92ZXJpZnlfYWNjb3VudHNfd2l0aF9wcm94eSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBu4bq/dSBj4bqnbiB0csaw4bubYyBraGkgbMOgbSBqb2IKICAgICAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVycyBhbmQgc2VsZi5fY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudHNfZm9yX2FwcChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgIyBTYXUga2hpIMSR4buTbmcgYuG7mSwgY2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgcXXDqXQgbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCBhbmQgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImFwcCIpID09IGFwcF9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDbGVhciB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHNhdSBraGkgxJHhu5NuZyBi4buZIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIFRydWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZyB0csaw4bubYyBraGkgbMOgbSBqb2IKICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF90b193b3JrWyJpZCJdKQogICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnRfdG9fd29yayBvciBub3Qgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudF90b193b3JrKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiBraMO0bmcgdGjhu4MgbMOgbSB2aeG7h2MgbuG7r2EsIGLhu48gcXVhIikKICAgICAgICAgICAgICAgICAgICAjIENsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IHbDrCBraMO0bmcgdGjhu4MgbMOgbSB2aeG7h2MgbuG7r2EKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIG7Dqm4gxJHDs25nIGFwcCBraMO0bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChhY2NvdW50X3RvX3dvcmsuZ2V0KCJhcHAiKSBpZiBhY2NvdW50X3RvX3dvcmsgZWxzZSBOb25lKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGN1cnJlbnQgd29ya2luZyBhY2NvdW50IHbhu5tpIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gYWNjb3VudF90b193b3JrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSB0csaw4bubYyBraGkgbMOgbSBqb2IgKG7hur91IGPhuqduKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKCJMw6BtIGpvYiIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBsw6BtIGpvYiwgbmdo4buJIDEwcyB0csaw4bubYyBraGkgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoYWNjb3VudF90b193b3JrKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBuw6puIMSRw7NuZyBhcHAgc2F1IGtoaSBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIG5vdCBqb2JfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgY8OzIGzhu5dpLCBjbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBxdcOpdCBs4bqhaQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgIyBDw7MgdGjhu4MgY+G6p24gxJHDs25nIGFwcAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FuZF9jbG9zZV9hcHBfaWZfbmVlZGVkKGFjY291bnRfdG9fd29yay5nZXQoImFwcCIpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgbOG6p24gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGpvYl9jaGVja19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kgdHJvbmcgdsOybmcgbOG6t3AgY2jDrW5oIikKICAgICAgICAgICAgICAgICMgTmdo4buJIG3hu5l0IGNow7p0IHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgzMCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgIyBOaOG6oyBwcm94eSBraGkgdGhvw6F0CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkga2hpIEpvYlNlcnZpY2UgZOG7q25nIikKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICMgUmVzZXQgdHJhY2tpbmcgdmFyaWFibGUga2hpIHVucmVnaXN0ZXIgcHJveHkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbmjhuqMgcHJveHk6IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICMgxJDDs25nIHThuqV0IGPhuqMgYXBwIGtoaSB0aG/DoXQgSm9iU2VydmljZQogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGFwcF9uYW1lLCBoYW5kbGVyIGluIHNlbGYuam9iX2hhbmRsZXJzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAge2FwcF9uYW1lfSBraGkgSm9iU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDs25nIGFwcDoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkpvYlNlcnZpY2UgxJHDoyBk4burbmciKQogICAgICAgICAgICAKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBKb2JTZXJ2aWNlIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBk4burbmcgSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICBkZWYgZm9yY2Vfc3RvcF9hbGwoc2VsZik6CiAgICAgICAgIiIiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCgogICAgZGVmIGhhbmRsZV9tcXR0X2FjY291bnRfdXBkYXRlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPhuq1wIG5o4bqtdCBhY2NvdW50IHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBBY2NvdW50IHPhur0gxJHGsOG7o2MgcmVsb2FkIHNhdSBt4buXaSBqb2IgdHJvbmcgY29udGludW91cyBwcm9jZXNzaW5nCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB0aMO0bmcgYsOhbyBj4bqtcCBuaOG6rXQgYWNjb3VudCB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9mb3JjZV9zdGFydF9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIG5nYXkgbOG6rXAgdOG7qWMgdOG7qyBNUVRUIHNlcnZlcgogICAgICAgIExvZ2ljIG3hu5tpIGtow7RuZyBjw7Mgc2Vzc2lvbiBjb29sZG93biBuw6puIGtow7RuZyBj4bqnbiB44butIGzDvSBnw6wgxJHhurdjIGJp4buHdAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBi4bqvdCDEkeG6p3UgbMOgbSB2aeG7h2MgbmdheSBs4bqtcCB04bupYyB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAgICAgIyBUcm9uZyBsb2dpYyBt4bubaSwgSm9iU2VydmljZSBz4bq9IHThu7EgxJHhu5luZyBs4bqleSBqb2IgbGnDqm4gdOG7pWMgbsOqbiBraMO0bmcgY+G6p24geOG7rSBsw70gZ8OsIHRow6ptCiAgICAgICAgICAgIAogICAgZGVmIGhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoc2VsZiwgY29uZmlnX2NoYW5nZXM6IERpY3Rbc3RyLCBBbnldID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIE1RVFQgc2VydmVyCiAgICAgICAgTG9naWMgbeG7m2kga2jDtG5nIGPhuqduIHJlc3RhcnQgc2Vzc2lvbiwgY29uZmlnIHPhur0gxJHGsOG7o2Mgw6FwIGThu6VuZyBuZ2F5IGzhuq1wIHThu6ljCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnX2NoYW5nZXM6IERpY3Rpb25hcnkgY2jhu6lhIGPDoWMgdGhheSDEkeG7lWkgY29uZmlnCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB0aMO0bmcgYsOhbyBj4bqtcCBuaOG6rXQgY29uZmlnIHThu6sgc2VydmVyIHF1YSBNUVRUIikKICAgICAgICAjIExvZ2ljIG3hu5tpIGtow7RuZyBj4bqnbiB44butIGzDvSDEkeG6t2MgYmnhu4d0LCBjb25maWcgc+G6vSDEkcaw4bujYyDEkeG7jWMgbOG6oWkgdOG7qyBEQiBt4buXaSBs4bqnbiBs4bq3cAoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiLEkMOzbmcgZOG7i2NoIHbhu6UsIGThu6tuZyB04bqldCBj4bqjIHdvcmtlciB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGThu6tuZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNodXRkb3duIFByb3h5U2VydmljZSAoc+G6vSB04buxIMSR4buZbmcgdW5yZWdpc3RlciBwcm94eSB2w6AgZOG7q25nIHVwZGF0ZSB0aHJlYWQpCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3NlcnZpY2UnKSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlOgogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnNodXRkb3duKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlIMSR4buDIHRyw6FuaCBs4buXaSB0aHJlYWQKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmNsb3NlKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHNodXRkb3duIEpvYlNlcnZpY2UiKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09IFBST1hZIENPTlZFTklFTkNFIE1FVEhPRFMgPT09PT09PT09PT09PT09PT09PT0KICAgIGRlZiByZXNldF9jdXJyZW50X3Byb3h5X2lwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgUmVzZXQgSVAgY2hvIHByb3h5IGhp4buHbiB04bqhaSAoY8OzIHRo4buDIGfhu41pIHRyb25nIHF1w6EgdHLDrG5oIGzDoG0gdmnhu4djKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgcmVzZXQgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X3N0YXR1cyhzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdHLhuqFuZyB0aMOhaSBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9zdGF0dXMoKQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X2luZm8oc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjDtG5nIHRpbiBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiBwcm94eQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZ2V0X3Byb3h5X2luZm8oKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09IEVORCBQUk9YWSBDT05WRU5JRU5DRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09CiAgICAgICAgICAgIAogICAgIyBERVBSRUNBVEVEOiBLaMO0bmcgZMO5bmcgbuG7r2EsIHRoYXkgYuG6sW5nIF9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICMgZGVmIF9oYXNfYWNjb3VudHNfcmVhZHlfZm9yX3dvcmsoc2VsZikgLT4gYm9vbDoKICAgICMgICAgICIiIgogICAgIyAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIGtow7RuZwogICAgIyAgICAgCiAgICAjICAgICBSZXR1cm5zOgogICAgIyAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICMgICAgICIiIgogICAgIyAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAjICAgICAKICAgICMgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAjICAgICAgICAgaWYgc2VsZi5pc19hY2NvdW50X2Nhbl9ydW5fam9iKGFwcF9uYW1lKToKICAgICMgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICMgICAgICAgICAgICAgCiAgICAjICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdOG7qyB04bqldCBj4bqjIGFwcCB2w6Agc+G6r3AgeOG6v3AgdGhlbyBhcHAsIG5nw6B5IHThuqFvCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2Mgc+G6r3AgeOG6v3AKICAgICAgICAiIiIKICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6v20gc+G7kSBsxrDhu6NuZyB0w6BpIGtob+G6o24gdGhlbyB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgIHN0YXR1c19jb3VudHMgPSB7fQogICAgICAgICAgICBmb3IgYWNjIGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgc3RhdHVzID0gYWNjLmdldCgnc3RhdHVzJywgJ2FjdGl2ZScpCiAgICAgICAgICAgICAgICBzdGF0dXNfY291bnRzW3N0YXR1c10gPSBzdGF0dXNfY291bnRzLmdldChzdGF0dXMsIDApICsgMQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2cgdGjhu5FuZyBrw6ogdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzdGF0dXNfaW5mbyA9ICIsICIuam9pbihbZiJ7c3RhdHVzfToge2NvdW50fSIgZm9yIHN0YXR1cywgY291bnQgaW4gc3RhdHVzX2NvdW50cy5pdGVtcygpXSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FwcF9uYW1lfSAtIHtzdGF0dXNfaW5mb30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4buNYyBjw6FjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHdvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuZXh0ZW5kKHdvcmthYmxlX2FjY291bnRzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgCiAgICAgICAgIyBT4bqvcCB44bq/cCB0aGVvOgogICAgICAgICMgMS4gQXBwIG5hbWUgKMSR4buDIG5ow7NtIGPDuW5nIGFwcCBs4bqhaSB24bubaSBuaGF1KQogICAgICAgICMgMi4gTmfDoHkgdOG6oW8gdMOgaSBraG/huqNuIChjcmVhdGVkX2F0KSAtIGPFqSBuaOG6pXQgdHLGsOG7m2MKICAgICAgICAjIDMuIFPhu5Egam9iIMSRw6MgbMOgbSBow7RtIG5heSAow610IG5o4bqldCB0csaw4bubYykgLSB0aGF5IGNobyBqb2JzX2RvbmVfaW5fc2Vzc2lvbgogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICB4LmdldCgiY3JlYXRlZF9hdCIsIDApLAogICAgICAgICAgICB4LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIHJldHVybiBhbGxfd29ya2FibGVfYWNjb3VudHMKICAgICAgICAKICAgIGRlZiBfZ2V0X25leHRfd29ya2FibGVfYWNjb3VudChzZWxmKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdMOgaSBraG/huqNuIHRp4bq/cCB0aGVvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puOgogICAgICAgIDEuIFTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIChpc19sb2dpbiA9IFRydWUpCiAgICAgICAgMi4gVMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgaG/hurdjIE5vbmU6IEFjY291bnQgZGF0YSBu4bq/dSB0w6xtIHRo4bqleSwgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDE6IFTDrG0gdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdHLGsOG7m2MgKGTDuW5nIHRyYWNraW5nIGhp4buHbiB04bqhaSkKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAjIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBsw6BtIHZp4buHYyB24bubaSBhcHAgbsOgeSAoY2jhu4kga2hpIGPhuqduKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgIyBDaOG7iSB2ZXJpZnkga2hpIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gdHJvbmcgdHJhY2tpbmcgaG/hurdjIGtoaSB0cmFja2luZyBraMO0bmcgaOG7o3AgbOG7hwogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbOG6p24gxJHhuqd1Li4uIikKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRw6MgdGjhu60gdmVyaWZ5IMSR4buDIGtow7RuZyB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRyYWNraW5nIHLhu5NpLCBraMO0bmcgY+G6p24gdmVyaWZ5IG5nYXkKICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyB0cmFja2luZwogICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQpCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50IGFuZCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIGPDsyB0aOG7gyBsw6BtIHZp4buHYzoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBraMO0bmcgY8OybiBo4bujcCBs4buHLCB4w7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQsIHsiaXNfbG9naW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIGRvIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMjogVMOsbSB0w6BpIGtob+G6o24gxJHEg25nIG5o4bqtcCB04burIGRhdGFiYXNlIChmYWxsYmFjaykKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAjIMavdSB0acOqbiB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB04burIERCCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgibG9nZ2VkX2luIiwgRmFsc2UpIGFuZCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXAgdHJvbmcgREI6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMzogTuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgbOG6pXkgdMOgaSBraG/huqNuIHRoZW8gdGjhu6kgdOG7sQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5leHRlbmQod29ya2FibGVfYWNjb3VudHMpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGFsbF93b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBT4bqvcCB44bq/cCB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puOiBhcHAsIG5nw6B5IHThuqFvLCBz4buRIGpvYiBow7RtIG5heQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICB4LmdldCgiY3JlYXRlZF9hdCIsIDApLAogICAgICAgICAgICB4LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIGFjY291bnQgPSBhbGxfd29ya2FibGVfYWNjb3VudHNbMF0KICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2M6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YWNjb3VudC5nZXQoJ2FwcCcpfSkiKQogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX3dvcmtfd2l0aF9zaW5nbGVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCB0w6BpIGtob+G6o24gLSB0aOG7sWMgaGnhu4duIG3hu5l0IGpvYiBkdXkgbmjhuqV0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIAogICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBQcm94eSDEkcOjIMSRxrDhu6NjIHjhu60gbMO9IOG7nyBuZ2/DoGksIGtow7RuZyBj4bqnbiBraeG7g20gdHJhIGzhuqFpIOG7nyDEkcOieQogICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBjaHV54buDbiB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgdHJhY2tpbmcgaW4tbWVtb3J5IHRoYXkgdsOsIGZpZWxkIGlzX2xvZ2luIMSR4buDIGNow61uaCB4w6FjIGjGoW4KICAgICAgICAgICAgY3VycmVudF9sb2dnZWRfaW5faWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgbmVlZHNfYWNjb3VudF9zd2l0Y2ggPSBjdXJyZW50X2xvZ2dlZF9pbl9pZCAhPSBjdXJyZW50X2FjY291bnRfaWQKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5lZWRzX2FjY291bnRfc3dpdGNoOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJD4bqnbiBjaHV54buDbiB0w6BpIGtob+G6o246IGhp4buHbiB04bqhaSBJRD17Y3VycmVudF9sb2dnZWRfaW5faWR9LCBj4bqnbiBjaHV54buDbiBzYW5nIElEPXtjdXJyZW50X2FjY291bnRfaWR9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChJRDoge2N1cnJlbnRfYWNjb3VudF9pZH0pIMSRw6MgxJHEg25nIG5o4bqtcCwga2jDtG5nIGPhuqduIGNodXnhu4NuIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgSVAgcHJveHkgY2jhu4kga2hpIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgIyBDaOG7iSByZXNldCBJUCBraGkgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ga2jDoWMgaG/hurdjIGzhuqduIMSR4bqndSB0acOqbgogICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgIT0gY3VycmVudF9hY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgSVAgcHJveHkgY2hvIHTDoGkga2hv4bqjbiBt4bubaToge3VzZXJuYW1lfSAoSUQ6IHtjdXJyZW50X2FjY291bnRfaWR9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBJUCDEkeG7gyBjw7MgSVAgbeG7m2kgY2hvIHTDoGkga2hv4bqjbiBt4bubaSAgCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBJUCB0aMOgbmggY8O0bmcgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAgICAgICAgICMgTMawdSBs4bqhaSBhY2NvdW50X2lkIMSRw6MgcmVzZXQgxJHhu4MgdHLDoW5oIHJlc2V0IGzhurdwIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gY3VycmVudF9hY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJSZXNldCBJUCB0aOG6pXQgYuG6oWkgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCB0aeG6v3AgdOG7pWMgduG7m2kgSVAgaGnhu4duIHThuqFpIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkcaw4bujYyByZXNldCBJUCB0csaw4bubYyDEkcOzLCBi4buPIHF1YSByZXNldCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4buJIGNodXnhu4NuIHTDoGkga2hv4bqjbiBraGkgY+G6p24gdGhp4bq/dAogICAgICAgICAgICBpZiBuZWVkc19hY2NvdW50X3N3aXRjaDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX21hcmtfYWNjb3VudF9sb2dvdXQoYWNjb3VudCwgIktow7RuZyB0aOG7gyBjaHV54buDbiB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBUcuG6oyB24buBIEZhbHNlIMSR4buDIGLDoW8gaGnhu4d1IGzhu5dpIGNodXnhu4NuIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgc2F1IGtoaSBjaHV54buDbiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhhcHBfbmFtZSwgY3VycmVudF9hY2NvdW50X2lkLCBUcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSRxINuZyBuaOG6rXAsIGLhu48gcXVhIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGpvYiB24bubaSBlcnJvciBoYW5kbGluZwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkzhuqV5IGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBqb2IgPSBoYW5kbGVyLmZldGNoX2pvYihhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3Qgam9iOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIGpvYgogICAgICAgICAgICAgICAgICAgIG5vX2pvYl9jb3VudCA9IHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50cy5nZXQoY3VycmVudF9hY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbY3VycmVudF9hY2NvdW50X2lkXSA9IG5vX2pvYl9jb3VudAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChs4bqnbiB7bm9fam9iX2NvdW50fS81KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgY8OzIGpvYiA1IGzhuqduIGxpw6puIHRp4bq/cCwgY2hvIHTDoGkga2hv4bqjbiBuZ2jhu4kgMzAgcGjDunQKICAgICAgICAgICAgICAgICAgICBpZiBub19qb2JfY291bnQgPj0gNToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBraMO0bmcgY8OzIGpvYiB7bm9fam9iX2NvdW50fSBs4bqnbiBsacOqbiB0aeG6v3AsIGNobyBuZ2jhu4kgMzAgcGjDunQiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9Y3VycmVudF9hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz0zMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIktow7RuZyBjw7Mgam9iIHtub19qb2JfY291bnR9IGzhuqduIGxpw6puIHRp4bq/cCIKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBlcnJvciBjb3VudCBzYXUga2hpIMSR4bq3dCBpbmFjdGl2ZQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbY3VycmVudF9hY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBUcuG6oyB24buBIEZhbHNlIMSR4buDIGLDoW8gaGnhu4d1IGPhuqduIHTDrG0gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgS2jDtG5nIGPDsyBqb2IgbmjGsG5nIGNoxrBhIMSR4bq/biBnaeG7m2kgaOG6oW4sIHRo4butIGzhuqFpIHNhdQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGVycm9yIGNvdW50IGtoaSBjw7Mgam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudF9pZCBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAjIFTEg25nIGVycm9yIGNvdW50IGtoaSBmZXRjaCBqb2IgbOG7l2kKICAgICAgICAgICAgICAgIGVycm9yX2NvdW50ID0gc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzLmdldChjdXJyZW50X2FjY291bnRfaWQsIDApICsgMQogICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2N1cnJlbnRfYWNjb3VudF9pZF0gPSBlcnJvcl9jb3VudAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgbOG6pXkgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAobOG6p24ge2Vycm9yX2NvdW50fS81KToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBs4buXaSA1IGzhuqduIGxpw6puIHRp4bq/cCwgY2hvIHTDoGkga2hv4bqjbiBuZ2jhu4kgMzAgcGjDunQKICAgICAgICAgICAgICAgIGlmIGVycm9yX2NvdW50ID49IDU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBs4buXaSBmZXRjaCBqb2Ige2Vycm9yX2NvdW50fSBs4bqnbiBsacOqbiB0aeG6v3AsIGNobyBuZ2jhu4kgMzAgcGjDunQiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9Y3VycmVudF9hY2NvdW50X2lkLAogICAgICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPTMwLAogICAgICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJM4buXaSBmZXRjaCBqb2Ige2Vycm9yX2NvdW50fSBs4bqnbiBsacOqbiB0aeG6v3AiCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgZXJyb3IgY291bnQgc2F1IGtoaSDEkeG6t3QgaW5hY3RpdmUKICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbY3VycmVudF9hY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgVHLhuqMgduG7gSBGYWxzZSDEkeG7gyBiw6FvIGhp4buHdSBj4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBM4buXaSBuaMawbmcgY2jGsGEgxJHhur9uIGdp4bubaSBo4bqhbiwgdGjhu60gbOG6oWkgc2F1CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZQogICAgICAgICAgICBzZWxmLl91cGRhdGVfZGV2aWNlX21lc3NhZ2VfZm9yX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgam9iIGZvbGxvdyB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fdmFsaWRhdGVfZm9sbG93X2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYiwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaSwga2jDtG5nIMSRw7NuZyBhcHAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgam9iIGLhurFuZyBoYW5kbGVyCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl92YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKGFjY291bnQsIGpvYiwgaGFuZGxlcik6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBTa2lwIGpvYiBraMO0bmcgcGjhuqNpIGzhu5dpLCBraMO0bmcgxJHDs25nIGFwcAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGpvYgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge2pvYi5nZXQoJ3R5cGUnLCAndW5rbm93bicpfSIpCiAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGVfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70ga+G6v3QgcXXhuqMgam9iIChiYW8gZ+G7k20gYsOhbyBjw6FvIHbDoCBj4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6opCiAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gY2jEg20gc8OzYyBzYXUga2hpIGjhur90IGpvYiAobuG6v3UgxJHGsOG7o2MgYuG6rXQgdsOgIGNoxrBhIGzDoG0gdHJvbmcgcGhpw6puIG7DoHkpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGNhcmVfaW5fd29ya2luZ19qb2IgPSBzZWxmLmRiLmdldCgiY2FyZV9pbl93b3JraW5nX2pvYiIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgY2FyZV9pbl93b3JraW5nX2pvYiBhbmQgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgbMOgbSBjaMSDbSBzw7NjIHRyb25nIHBoacOqbiBuw6B5IGNoxrBhCiAgICAgICAgICAgICAgICAgICAgbGFzdF9jYXJlX3RpbWUgPSBhY2NvdW50LmdldCgibGFzdF9jYXJlX3RpbWUiLCAwKQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBjaMawYSBsw6BtIGNoxINtIHPDs2MgdHJvbmcgcGhpw6puIG7DoHkgKGxhc3RfY2FyZV90aW1lID0gMCBob+G6t2Mga2jDoWMgc2Vzc2lvbiBoaeG7h24gdOG6oWkpCiAgICAgICAgICAgICAgICAgICAgaWYgbGFzdF9jYXJlX3RpbWUgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChs4bqnbiDEkeG6p3UgdHJvbmcgcGhpw6puKSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7nWkgZ2lhbiBsw6BtIGNoxINtIHPDs2MKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiBpbnQoY3VycmVudF90aW1lKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgbMOgbSBjaMSDbSBzw7NjIHRyb25nIHBoacOqbiBuw6B5LCBi4buPIHF1YSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtIw5RORyDEkcOzbmcgYXBwIHNhdSBt4buXaSBqb2IgLSBjaOG7iSDEkcOzbmcga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggam9iIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY8OzIGzhu5dpCiAgICAgICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoc2VsZiwgaGFuZGxlciwgYXBwX25hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyCiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiBj4bunYSB0w6BpIGtob+G6o24gdHJvbmcgYXBwIG7DoHkKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGNobyB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraGkgxJHDs25nIGFwcCIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWk6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChzZWxmLCBhcHBfbmFtZTogc3RyKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCDEkcOzbmcgYXBwIG7hur91IGtow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IGFwcF9uYW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyBhcHAgbsOgeSBraMO0bmcKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgxJHDs25nIGFwcCIpCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgZ2nhu68gYXBwIG3hu58iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIMSRw7NuZyBhcHAge2FwcF9uYW1lfToge2V9IikKICAgICAgICAKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIgPSAiUGjDoXQgaGnhu4duIGxvZ291dCIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0IHbDoCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYie3JlYXNvbn06IHtjdXJyZW50X3RpbWV9IgogICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyB0cm9uZyBtZW1vcnkKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50WyJpZCJdOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudFsnaWQnXX0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBsb2dvdXQiKQogICAgICAgIAogICAgZGVmIF91cGRhdGVfZGV2aWNlX21lc3NhZ2VfZm9yX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlIGNobyBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgIiIiCiAgICAgICAgbGluayA9IGpvYi5nZXQoJ2xpbmsnLCAnJykKICAgICAgICBpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJywgJycpCiAgICAgICAgCiAgICAgICAgbWVzc2FnZSA9IGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgbWVzc2FnZSkKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIGPhu6dhIGpvYiBzYXUga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgam9iX3N1Y2Nlc3MgPSBqb2JfcmVzdWx0WyJzdWNjZXNzIl0KICAgICAgICBqb2JfbWVzc2FnZSA9IGpvYl9yZXN1bHRbIm1lc3NhZ2UiXQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gZm9sbG93IGpvYiDEkeG6t2MgYmnhu4d0CiAgICAgICAgaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5faGFuZGxlX2ZvbGxvd19qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgROG7q25nIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5IG5oxrBuZyB0aeG6v3AgdOG7pWMgbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICAjIELDoW8gY8OhbyBr4bq/dCBxdeG6owogICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6oKICAgICAgICBzZWxmLl91cGRhdGVfam9iX3N0YXRzKGFjY291bnQsIGpvYl9zdWNjZXNzLCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLCBqb2JfcmVzdWx0KQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIFRow6BuaCBjw7RuZwogICAgICAgIAogICAgZGVmIF9oYW5kbGVfZm9sbG93X2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIMSR4bq3YyBiaeG7h3QgY2hvIGZvbGxvdyBqb2IKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRp4bq/cCB04bulYyB24bubaSB0w6BpIGtob+G6o24gbsOgeSwgRmFsc2UgbuG6v3UgY+G6p24gZOG7q25nCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZyAoc3RhdHVzIDQpIHbDoCBn4butaSB5w6p1IGPhuqd1IGNo4budIGR1eeG7h3QgKHN0YXR1cyA1KQogICAgICAgIGlmIGpvYl9zdGF0dXMgaW4gWzQsIDVdOgogICAgICAgICAgICBjbnQgPSBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgIGlmIGNudCA+PSA1OgogICAgICAgICAgICAgICAgc3RhdHVzX21zZyA9ICJmb2xsb3cgcGVuZGluZyIgaWYgam9iX3N0YXR1cyA9PSA0IGVsc2UgImfhu61pIHnDqnUgY+G6p3UgY2jhu50gZHV54buHdCIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCB7c3RhdHVzX21zZ30sIHThuqFtIGThu6tuZyB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249ZiJMacOqbiB0aeG6v3AgbOG7l2kge3N0YXR1c19tc2d9IikKICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEThu6tuZyB24bubaSB0w6BpIGtob+G6o24gbsOgeQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgIHNlbGYuX2NoZWNrX2FuZF9kaXNhYmxlX2ZvbGxvd19hZnRlcl9qb2IoYWNjb3VudCwgdXNlcm5hbWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYW5kX2Rpc2FibGVfZm9sbG93X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgdXNlcm5hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbiBzYXUga2hpIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKQogICAgICAgIG1heF9mb2xsb3dfZGF5ID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfZGF5IiwgMjApCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIMSR4bqhdCBnaeG7m2kgaOG6oW4gbmfDoHkgdHLGsOG7m2MKICAgICAgICBpZiBmb2xsb3dfdG9kYXkgPj0gbWF4X2ZvbGxvd19kYXk6CiAgICAgICAgICAgICMgVMOtbmggdGjhu51pIGdpYW4gxJHhur9uIHJlc2V0IG5nw6B5IHRp4bq/cCB0aGVvICh0w61uaCB0aGVvIHBow7p0KQogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUKICAgICAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgICAgIHRvbW9ycm93ID0gbm93LmRhdGUoKSArIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgIG5leHRfcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9tb3Jyb3csIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBz4buRIHBow7p0IHThu6sgYsOieSBnaeG7nSDEkeG6v24gdGjhu51pIMSRaeG7g20gcmVzZXQKICAgICAgICAgICAgdGltZV9kaWZmID0gbmV4dF9yZXNldF90aW1lIC0gbm93CiAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IGludCh0aW1lX2RpZmYudG90YWxfc2Vjb25kcygpIC8gNjApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gY8OzIHPhurVuIHRyb25nIGRiX3NlcnZpY2UKICAgICAgICAgICAgc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyIKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IG5nw6B5ICh7Zm9sbG93X3RvZGF5fS97bWF4X2ZvbGxvd19kYXl9KSwgZGlzYWJsZSDEkeG6v24ge25leHRfcmVzZXRfdGltZS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0iKQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgxJHhuqF0IGdp4bubaSBo4bqhbiBzZXNzaW9uCiAgICAgICAgZWxpZiBmb2xsb3dfaW5fc2Vzc2lvbiA+PSBtYXhfZm9sbG93X3Nlc3Npb246CiAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50gPSA3MjAgcGjDunQKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBzZXNzaW9uIC0gcGVuYWx0eV9taW51dGVzIHThu6sgREI6IHtwZW5hbHR5X21pbnV0ZXN9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgaMOgbSB04burIGRiX3NlcnZpY2UgduG7m2kgcGVuYWx0eSB0aW1lCiAgICAgICAgICAgIHNlbGYuZGIuZGlzYWJsZV9hY2NvdW50X2ZvbGxvdygKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudFsiaWQiXSwKICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICByZWFzb249IsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgc2Vzc2lvbiIKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHNlc3Npb24gKHtmb2xsb3dfaW5fc2Vzc2lvbn0ve21heF9mb2xsb3dfc2Vzc2lvbn0pLCBraMOzYSBmb2xsb3cge3BlbmFsdHlfbWludXRlc30gcGjDunQiKQogICAgICAgICAgICAKICAgIGRlZiBfdmFsaWRhdGVfam9iX3dpdGhfaGFuZGxlcihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlcikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBWYWxpZGF0ZSBqb2IgYuG6sW5nIGhhbmRsZXIKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGpvYiBo4bujcCBs4buHLCBGYWxzZSBu4bq/dSBj4bqnbiBza2lwIGhv4bq3YyBjb250aW51ZQogICAgICAgICIiIgogICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gaGFuZGxlci52YWxpZGF0ZV9qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IpCiAgICAgICAgaWYgbm90IHZhbGlkYXRpb25fcmVzdWx0LmdldCgidmFsaWQiLCBUcnVlKToKICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgU2tpcCBqb2IKICAgICAgICAgICAgICAgIHNraXBfbWVzc2FnZSA9IHZhbGlkYXRpb25fcmVzdWx0LmdldCgibWVzc2FnZSIsICJKb2Iga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTa2lwIGpvYjoge3NraXBfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwgCiAgICAgICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHNraXBfbWVzc2FnZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTa2lwIGpvYiBs4buXaToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBza2lwIGpvYiDEkeG7gyB0csOhbmggc3BhbSIpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hzoge3ZhbGlkYXRpb25fcmVzdWx0LmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfdmFsaWRhdGVfZm9sbG93X2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIGZvbGxvdyBqb2IgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0aOG7gyB0aOG7sWMgaGnhu4duLCBGYWxzZSBu4bq/dSBj4bqnbiBza2lwCiAgICAgICAgIiIiCiAgICAgICAgIyBDaOG7iSB2YWxpZGF0ZSBjaG8gam9iIGZvbGxvdwogICAgICAgIGlmIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSAhPSAiZm9sbG93IjoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIGRpc2FibGVfZm9sbG93ID0gYWNjb3VudC5nZXQoImRpc2FibGVfZm9sbG93IiwgRmFsc2UpCiAgICAgICAgZm9sbG93X2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiZm9sbG93X2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgIG5vdyA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyBi4buLIGtow7NhIGZvbGxvdyBraMO0bmcKICAgICAgICBpZiBkaXNhYmxlX2ZvbGxvdzoKICAgICAgICAgICAgaWYgZm9sbG93X2Rpc2FibGVfdW50aWwgPiAwIGFuZCBmb2xsb3dfZGlzYWJsZV91bnRpbCA8PSBub3c6CiAgICAgICAgICAgICAgICAjIEjhur90IHRo4budaSBnaWFuIGtow7NhLCBlbmFibGUgbOG6oWkgZm9sbG93CiAgICAgICAgICAgICAgICBzZWxmLmRiLmVuYWJsZV9hY2NvdW50X2ZvbGxvdyhhY2NvdW50WyJpZCJdKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBW4bqrbiDEkWFuZyBi4buLIGtow7NhIGZvbGxvdwogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyBi4buLIGtow7NhIGZvbGxvdywgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHJlc3VsdF9za2lwID0gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiVMOgaSBraG/huqNuIMSRYW5nIGLhu4sga2jDs2EgZm9sbG93IgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIyByZXBvcnRfam9iIHPhur0gdOG7sSDEkeG7mW5nIHNraXAgam9iIGtoaSBzdGF0dXMgPSAyCiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCByZXN1bHRfc2tpcCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCg1LCAyNSkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puCiAgICAgICAgaWYgZm9sbG93X2luX3Nlc3Npb24gPj0gbWF4X2ZvbGxvd19zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puICh7Zm9sbG93X2luX3Nlc3Npb259L3ttYXhfZm9sbG93X3Nlc3Npb259KSwgaOG7p3kgam9iIikKICAgICAgICAgICAgcmVzdWx0X3NraXAgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwKICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbiIKICAgICAgICAgICAgfQogICAgICAgICAgICAjIHJlcG9ydF9qb2Igc+G6vSB04buxIMSR4buZbmcgc2tpcCBqb2Iga2hpIHN0YXR1cyA9IDIKICAgICAgICAgICAgaGFuZGxlci5yZXBvcnRfam9iKGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVl').decode('utf-8'))
