import base64
exec(base64.b64decode('aW1wb3J0IHNxbGl0ZTMKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHV1aWQKaW1wb3J0IHV0aWxzCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsLCBVbmlvbgppbXBvcnQgY29uZmlnCgojIFThuqFvIGxvZ2dlciBjaG8gRGF0YWJhc2VTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkRhdGFiYXNlU2VydmljZSIpCgpjbGFzcyBEYXRhYmFzZVNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfcGF0aDogc3RyID0gImRhdGEuZGIiLCBkZWZhdWx0X2NvbmZpZ19wYXRoOiBzdHIgPSAiZGVmYXVsdENvbmZpZy5qc29uIik6CiAgICAgICAgc2VsZi5kYl9wYXRoID0gZGJfcGF0aAogICAgICAgIHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCA9IGRlZmF1bHRfY29uZmlnX3BhdGgKICAgICAgICBzZWxmLmxvY2FsID0gdGhyZWFkaW5nLmxvY2FsKCkgICMgTMawdSB0cuG7ryByacOqbmcgY2hvIG3hu5dpIHRocmVhZAogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIG7hur91IGNoxrBhIHThu5NuIHThuqFpCiAgICAgICAgc2VsZi5faW5pdF9kYigpCiAgICAgICAgCiAgICBkZWYgX2dldF9jb25uZWN0aW9uKHNlbGYpOgogICAgICAgICIiIkzhuqV5IGvhur90IG7hu5FpIFNRTGl0ZSBjaG8gdGhyZWFkIGhp4buHbiB04bqhaSIiIgogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYubG9jYWwsICdjb25uJykgb3Igc2VsZi5sb2NhbC5jb25uIGlzIE5vbmU6CiAgICAgICAgICAgIHNlbGYubG9jYWwuY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLmRiX3BhdGgpCiAgICAgICAgcmV0dXJuIHNlbGYubG9jYWwuY29ubgogICAgICAgIAogICAgZGVmIF9pbml0X2RiKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBj4bqldSB0csO6YyBkYXRhYmFzZSBu4bq/dSBjaMawYSB04buTbiB04bqhaSIiIgogICAgICAgIGNvbm4gPSBzcWxpdGUzLmNvbm5lY3Qoc2VsZi5kYl9wYXRoKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICAjIFThuqFvIGLhuqNuZyBjb25maWcKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnJycKICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBjb25maWcgKAogICAgICAgICAgICBrZXkgVEVYVCBQUklNQVJZIEtFWSwKICAgICAgICAgICAgdmFsdWUgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgYWNjb3VudCB24bubaSB1dWlkCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJycnCiAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgYWNjb3VudHMgKAogICAgICAgICAgICBpZCBJTlRFR0VSIFBSSU1BUlkgS0VZLAogICAgICAgICAgICBhY2NvdW50X3V1aWQgVEVYVCBVTklRVUUsCiAgICAgICAgICAgIGFwcCBURVhULAogICAgICAgICAgICBuaWNrbmFtZSBURVhULAogICAgICAgICAgICB1bmlxdWVfaWQgVEVYVCwKICAgICAgICAgICAgdW5pcXVlX3VzZXJuYW1lIFRFWFQsCiAgICAgICAgICAgIHN0YXR1cyBURVhULAogICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb24gVEVYVCwKICAgICAgICAgICAgaXNfbG9naW4gSU5URUdFUiwKICAgICAgICAgICAgYXZhdGFyX3RodW1iIFRFWFQsCiAgICAgICAgICAgIHRvdGFsX2pvYnMgSU5URUdFUiwKICAgICAgICAgICAgam9iX2VuYWJsZSBJTlRFR0VSLAogICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCBJTlRFR0VSLAogICAgICAgICAgICBqb2JfdG9kYXkgSU5URUdFUiwKICAgICAgICAgICAgam9iX21heF9kYXkgSU5URUdFUiwKICAgICAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gSU5URUdFUiwKICAgICAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gSU5URUdFUiwKICAgICAgICAgICAgbGFzdF9qb2JfdGltZSBJTlRFR0VSLAogICAgICAgICAgICBsYXN0X3VwZGF0ZSBJTlRFR0VSLAogICAgICAgICAgICBjYXJlX3RvZGF5IElOVEVHRVIsCiAgICAgICAgICAgIGlzX2dvbGlrZV9saW5rZWQgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGdvbGlrZV9pZCBURVhULAogICAgICAgICAgICBkZXZpY2VfaWQgVEVYVCwKICAgICAgICAgICAgaXNfc3luYyBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZGlzYWJsZV9mb2xsb3cgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGZvbGxvd19kaXNhYmxlX3VudGlsIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBmb2xsb3dfdG9kYXkgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGZvbGxvd19pbl9zZXNzaW9uIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBtYXhfZm9sbG93X2RheSBJTlRFR0VSIERFRkFVTFQgMjAsCiAgICAgICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiBJTlRFR0VSIERFRkFVTFQgNSwKICAgICAgICAgICAgbGFzdF9mb2xsb3dfdGltZSBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgaW5hY3RpdmVfZm9sbG93X3JlYXNvbiBURVhULAogICAgICAgICAgICBkYXRhIFRFWFQKICAgICAgICApCiAgICAgICAgJycnKQogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIGpvYnNfaGlzdG9yeSDEkeG7gyBsxrB1IGzhu4tjaCBz4butIGpvYgogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGpvYnNfaGlzdG9yeSAoCiAgICAgICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVksCiAgICAgICAgICAgIGpvYl91dWlkIFRFWFQgVU5JUVVFLAogICAgICAgICAgICBhY2NvdW50X3V1aWQgVEVYVCwKICAgICAgICAgICAgZGV2aWNlX2lkIFRFWFQsCiAgICAgICAgICAgIGFwcCBURVhULAogICAgICAgICAgICBqb2JfaWQgVEVYVCwKICAgICAgICAgICAgam9iX3R5cGUgVEVYVCwKICAgICAgICAgICAgb2JqZWN0X2lkIFRFWFQsCiAgICAgICAgICAgIGxpbmsgVEVYVCwKICAgICAgICAgICAgc3RhdHVzIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBzdWNjZXNzIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBwcmljZSBSRUFMIERFRkFVTFQgMCwKICAgICAgICAgICAgZXJyb3JfbWVzc2FnZSBURVhULAogICAgICAgICAgICBjcmVhdGVkX2F0IElOVEVHRVIsCiAgICAgICAgICAgIGxhc3RfdXBkYXRlIElOVEVHRVIsCiAgICAgICAgICAgIGlzX3N5bmMgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGRhdGEgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBhY2NvdW50X3V1aWQgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiUFJBR01BIHRhYmxlX2luZm8oYWNjb3VudHMpIikKICAgICAgICBjb2x1bW5zID0gW3Jvd1sxXSBmb3Igcm93IGluIGN1cnNvci5mZXRjaGFsbCgpXQogICAgICAgIGlmICJhY2NvdW50X3V1aWQiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBhY2NvdW50X3V1aWQgVEVYVCBVTklRVUUiKQogICAgICAgICAgICAjIFThuqFvIFVVSUQgY2hvIGPDoWMgdMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWkKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBpZCBGUk9NIGFjY291bnRzIikKICAgICAgICAgICAgYWNjb3VudHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WzBdCiAgICAgICAgICAgICAgICBhY2NvdW50X3V1aWQgPSBzdHIodXVpZC51dWlkNCgpKQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlVQREFURSBhY2NvdW50cyBTRVQgYWNjb3VudF91dWlkID0gPyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF91dWlkLCBhY2NvdW50X2lkKSkKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgYWNjb3VudF91dWlkIHbDoG8gYuG6o25nIGFjY291bnRzIHbDoCB04bqhbyBVVUlEIGNobyBjw6FjIHTDoGkga2hv4bqjbiBoaeG7h24gY8OzIikKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBpc19zeW5jIG7hur91IGNoxrBhIHThu5NuIHThuqFpCiAgICAgICAgaWYgImlzX3N5bmMiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgdGjDqm0gY+G7mXQgaXNfc3luYyB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyB1bmlxdWUgaW5kZXggY2hvIChhcHAsIHVuaXF1ZV91c2VybmFtZSkgxJHhu4MgdHLDoW5oIGR1cGxpY2F0ZSBhY2NvdW50cwogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkNSRUFURSBVTklRVUUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfYWNjb3VudHNfYXBwX3VzZXJuYW1lIE9OIGFjY291bnRzKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIHThuqFvIHVuaXF1ZSBpbmRleCBjaG8gKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAjIE7hur91IGPDsyBkdXBsaWNhdGUgZGF0YSwgY+G6p24gY2xlYW51cCB0csaw4bubYwogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkPhuqNuaCBiw6FvIGtoaSB04bqhbyB1bmlxdWUgaW5kZXg6IHtlfSIpCiAgICAgICAgICAgIHNlbGYuX2NsZWFudXBfZHVwbGljYXRlX2FjY291bnRzKGN1cnNvcikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkNSRUFURSBVTklRVUUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfYWNjb3VudHNfYXBwX3VzZXJuYW1lIE9OIGFjY291bnRzKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSIpCiAgICAgICAgICAgICAgICBwcmludCgixJDDoyB04bqhbyB1bmlxdWUgaW5kZXggY2hvIChhcHAsIHVuaXF1ZV91c2VybmFtZSkgc2F1IGtoaSBjbGVhbnVwIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlMjoKICAgICAgICAgICAgICAgIHByaW50KGYiS2jDtG5nIHRo4buDIHThuqFvIHVuaXF1ZSBpbmRleDoge2UyfSIpCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBj4buZdCBkaXNhYmxlX2ZvbGxvdyBu4bq/dSBjaMawYSBjw7MKICAgICAgICBpZiAiZGlzYWJsZV9mb2xsb3ciIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBkaXNhYmxlX2ZvbGxvdyBJTlRFR0VSIERFRkFVTFQgMCIpCiAgICAgICAgICAgIHByaW50KCLEkMOjIHRow6ptIGPhu5l0IGRpc2FibGVfZm9sbG93IHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAKICAgICAgICAjIFRow6ptIGPhu5l0IGZvbGxvd19kaXNhYmxlX3VudGlsIG7hur91IGNoxrBhIGPDswogICAgICAgIGlmICJmb2xsb3dfZGlzYWJsZV91bnRpbCIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGZvbGxvd19kaXNhYmxlX3VudGlsIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgZm9sbG93X2Rpc2FibGVfdW50aWwgdsOgbyBi4bqjbmcgYWNjb3VudHMiKQogICAgICAgIAogICAgICAgICMgVGjDqm0gY8OhYyBj4buZdCBmb2xsb3cgdHJhY2tpbmcgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgZm9sbG93X2NvbHVtbnMgPSBbCiAgICAgICAgICAgICgiZm9sbG93X3RvZGF5IiwgIklOVEVHRVIgREVGQVVMVCAwIiksCiAgICAgICAgICAgICgiZm9sbG93X2luX3Nlc3Npb24iLCAiSU5URUdFUiBERUZBVUxUIDAiKSwKICAgICAgICAgICAgKCJtYXhfZm9sbG93X2RheSIsICJJTlRFR0VSIERFRkFVTFQgMjAiKSwKICAgICAgICAgICAgKCJtYXhfZm9sbG93X3Nlc3Npb24iLCAiSU5URUdFUiBERUZBVUxUIDUiKSwKICAgICAgICAgICAgKCJsYXN0X2ZvbGxvd190aW1lIiwgIklOVEVHRVIgREVGQVVMVCAwIiksCiAgICAgICAgICAgICgiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiIsICJURVhUIikKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgZm9yIGNvbF9uYW1lLCBjb2xfdHlwZSBpbiBmb2xsb3dfY29sdW1uczoKICAgICAgICAgICAgaWYgY29sX25hbWUgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShmIkFMVEVSIFRBQkxFIGFjY291bnRzIEFERCBDT0xVTU4ge2NvbF9uYW1lfSB7Y29sX3R5cGV9IikKICAgICAgICAgICAgICAgIHByaW50KGYixJDDoyB0aMOqbSBj4buZdCB7Y29sX25hbWV9IHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAKICAgICAgICAjIFRow6ptIGPDoWMgY+G7mXQgY2FyZSB0cmFja2luZyBu4bq/dSBjaMawYSBjw7MKICAgICAgICBjYXJlX2NvbHVtbnMgPSBbCiAgICAgICAgICAgICgibGFzdF9jYXJlX3RpbWUiLCAiSU5URUdFUiBERUZBVUxUIDAiKSwKICAgICAgICAgICAgKCJsYXN0X3ZpZXdfc3RvcmllcyIsICJJTlRFR0VSIERFRkFVTFQgMCIpLAogICAgICAgICAgICAoImNhcmVfZGF0YSIsICJURVhUIiksICAjIEzGsHUgSlNPTiBTbWFydCBDYXJlIGNobyB04burbmcgdMOgaSBraG/huqNuCiAgICAgICAgICAgICgibGFzdF9wb3N0X3RpbWUiLCAiSU5URUdFUiBERUZBVUxUIDAiKSAgIyBUaOG7nWkgZ2lhbiDEkcSDbmcgYsOgaSBn4bqnbiBuaOG6pXQKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgZm9yIGNvbF9uYW1lLCBjb2xfdHlwZSBpbiBjYXJlX2NvbHVtbnM6CiAgICAgICAgICAgIGlmIGNvbF9uYW1lIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoZiJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIHtjb2xfbmFtZX0ge2NvbF90eXBlfSIpCiAgICAgICAgICAgICAgICBwcmludChmIsSQw6MgdGjDqm0gY+G7mXQge2NvbF9uYW1lfSB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIAogICAgZGVmIF9jbGVhbnVwX2R1cGxpY2F0ZV9hY2NvdW50cyhzZWxmLCBjdXJzb3IpOgogICAgICAgICIiIgogICAgICAgIEThu41uIGThurlwIGPDoWMgdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBk4buxYSB0csOqbiAoYXBwLCB1bmlxdWVfdXNlcm5hbWUpCiAgICAgICAgR2nhu68gbOG6oWkgdMOgaSBraG/huqNuIGPDsyBpZCBs4bubbiBuaOG6pXQgKG3hu5tpIG5o4bqldCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSBjw6FjIG5ow7NtIGR1cGxpY2F0ZQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgIFNFTEVDVCBhcHAsIHVuaXF1ZV91c2VybmFtZSwgQ09VTlQoKikgYXMgY291bnQKICAgICAgICAgICAgICAgIEZST00gYWNjb3VudHMgCiAgICAgICAgICAgICAgICBXSEVSRSB1bmlxdWVfdXNlcm5hbWUgSVMgTk9UIE5VTEwgQU5EIHVuaXF1ZV91c2VybmFtZSAhPSAnJwogICAgICAgICAgICAgICAgR1JPVVAgQlkgYXBwLCB1bmlxdWVfdXNlcm5hbWUgCiAgICAgICAgICAgICAgICBIQVZJTkcgQ09VTlQoKikgPiAxCiAgICAgICAgICAgICIiIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGR1cGxpY2F0ZXMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBpZiBub3QgZHVwbGljYXRlczoKICAgICAgICAgICAgICAgIHByaW50KCJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBuw6BvIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYiVMOsbSB0aOG6pXkge2xlbihkdXBsaWNhdGVzKX0gbmjDs20gdMOgaSBraG/huqNuIGR1cGxpY2F0ZSwgxJFhbmcgZOG7jW4gZOG6uXAuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgdG90YWxfZGVsZXRlZCA9IDAKICAgICAgICAgICAgZm9yIGFwcCwgdXNlcm5hbWUsIGNvdW50IGluIGR1cGxpY2F0ZXM6CiAgICAgICAgICAgICAgICAjIEzhuqV5IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBj4bunYSBuaMOzbSBuw6B5CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiIiIKICAgICAgICAgICAgICAgICAgICBTRUxFQ1QgaWQgRlJPTSBhY2NvdW50cyAKICAgICAgICAgICAgICAgICAgICBXSEVSRSBhcHAgPSA/IEFORCB1bmlxdWVfdXNlcm5hbWUgPSA/IAogICAgICAgICAgICAgICAgICAgIE9SREVSIEJZIGlkIERFU0MKICAgICAgICAgICAgICAgICIiIiwgKGFwcCwgdXNlcm5hbWUpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkcyA9IFtyb3dbMF0gZm9yIHJvdyBpbiBjdXJzb3IuZmV0Y2hhbGwoKV0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG7ryBs4bqhaSB0w6BpIGtob+G6o24gxJHhuqd1IHRpw6puIChpZCBs4bubbiBuaOG6pXQpLCB4w7NhIGPDoWMgdMOgaSBraG/huqNuIGPDsm4gbOG6oWkKICAgICAgICAgICAgICAgIGlmIGxlbihhY2NvdW50X2lkcykgPiAxOgogICAgICAgICAgICAgICAgICAgIGtlZXBfaWQgPSBhY2NvdW50X2lkc1swXSAgIyBJRCBs4bubbiBuaOG6pXQgKG3hu5tpIG5o4bqldCkKICAgICAgICAgICAgICAgICAgICBkZWxldGVfaWRzID0gYWNjb3VudF9pZHNbMTpdICAjIEPDoWMgSUQgY8OybiBs4bqhaQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvciBkZWxldGVfaWQgaW4gZGVsZXRlX2lkczoKICAgICAgICAgICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGFjY291bnRzIFdIRVJFIGlkID0gPyIsIChkZWxldGVfaWQsKSkKICAgICAgICAgICAgICAgICAgICAgICAgdG90YWxfZGVsZXRlZCArPSAxCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcHJpbnQoZiLEkMOjIHjDs2Ege2xlbihkZWxldGVfaWRzKX0gdMOgaSBraG/huqNuIGR1cGxpY2F0ZSBjaG8ge2FwcH06e3VzZXJuYW1lfSwgZ2nhu68gbOG6oWkgSUQge2tlZXBfaWR9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYixJDDoyBob8OgbiB0aMOgbmggZOG7jW4gZOG6uXAsIHjDs2EgdOG7lW5nIGPhu5luZyB7dG90YWxfZGVsZXRlZH0gdMOgaSBraG/huqNuIGR1cGxpY2F0ZSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgZOG7jW4gZOG6uXAgZHVwbGljYXRlIGFjY291bnRzOiB7ZX0iKQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBjb25maWcucHkKICAgICAgICBzZWxmLmluaXRfZGVmYXVsdF9jb25maWcoKQogICAgICAgIAogICAgZGVmIGxvYWRfZGVmYXVsdF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIixJDhu41jIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBmaWxlIiIiCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCwgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZChmKQogICAgICAgIHJldHVybiB7fQogICAgICAgIAogICAgZGVmIGdldChzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBBbnk6CiAgICAgICAgIiIiTOG6pXkgZ2nDoSB0cuG7iyBj4bqldSBow6xuaCB04burIERCLCBu4bq/dSBraMO0bmcgY8OzIHRow6wgbOG6pXkgdOG7qyBkZWZhdWx0IGNvbmZpZyIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgdmFsdWUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIHJlc3VsdDoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgduG7gSBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgICAgICB2YWx1ZSA9IHJlc3VsdFswXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBM4bqleSB04burIGRlZmF1bHQgY29uZmlnCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gc2VsZi5sb2FkX2RlZmF1bHRfY29uZmlnKCkKICAgICAgICAgICAgaWYga2V5IGluIGRlZmF1bHRfY29uZmlnOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRfY29uZmlnW2tleV0KICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHQKICAgIAogICAgZGVmIHNldChzZWxmLCBrZXk6IHN0ciwgdmFsdWU6IEFueSkgLT4gYm9vbDoKICAgICAgICAiIiJMxrB1IGdpw6EgdHLhu4sgY+G6pXUgaMOsbmggdsOgbyBEQiIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGThu68gbGnhu4d1IHBo4bupYyB04bqhcCB0aMOgbmggSlNPTgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChkaWN0LCBsaXN0KSk6CiAgICAgICAgICAgIHZhbHVlID0ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGNvbmZpZyAoa2V5LCB2YWx1ZSkgVkFMVUVTICg/LCA/KSIsCiAgICAgICAgICAgICAgICAoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBsxrB1IGPhuqV1IGjDrG5oOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGRlbGV0ZShzZWxmLCBrZXk6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIG3hu5l0IGPhuqV1IGjDrG5oIGto4buPaSBkYXRhYmFzZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogS2jDs2EgY+G6pXUgaMOsbmggY+G6p24geMOzYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gY29uZmlnIFdIRVJFIGtleSA9ID8iLCAoa2V5LCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgY+G6pXUgaMOsbmgge2tleX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgc2F2ZV9kZXZpY2VfaW5mbyhzZWxmLCBkZXZpY2VfaW5mbzogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KCJkZXZpY2VfaW5mbyIsIGRldmljZV9pbmZvKQogICAgCiAgICBkZWYgZ2V0X2RldmljZV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIMSRw6MgbMawdSIiIgogICAgICAgIGRldmljZV9pbmZvID0gc2VsZi5nZXQoImRldmljZV9pbmZvIiwge30pCiAgICAgICAgcmV0dXJuIGRldmljZV9pbmZvCiAgICAKICAgIGRlZiBhZGRfYWNjb3VudChzZWxmLCBhY2NvdW50X2RhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB2w6BvIGRhdGFiYXNlIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIG1vZHVsZQogICAgICAgIGltcG9ydCBjb25maWcgYXMgY29uZmlnX21vZHVsZQogICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBkZXZpY2VfaWQsIHPhu60gZOG7pW5nIGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICBkZXZpY2VfaWQgPSBhY2NvdW50X2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIAogICAgICAgICMgVMOhY2ggZOG7ryBsaeG7h3UgY2jDrW5oIHbDoCBk4buvIGxp4buHdSBwaOG7pQogICAgICAgIG1haW5fZGF0YSA9IHsKICAgICAgICAgICAgImFwcCI6IGFjY291bnRfZGF0YS5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgIm5pY2tuYW1lIjogYWNjb3VudF9kYXRhLmdldCgibmlja25hbWUiLCAiIiksCiAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBhY2NvdW50X2RhdGEuZ2V0KCJ1bmlxdWVfaWQiLCAiIiksCiAgICAgICAgICAgICJ1bmlxdWVfdXNlcm5hbWUiOiBhY2NvdW50X2RhdGEuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIiksCiAgICAgICAgICAgICJzdGF0dXMiOiBhY2NvdW50X2RhdGEuZ2V0KCJzdGF0dXMiLCAiaW5hY3RpdmUiKSwKICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGFjY291bnRfZGF0YS5nZXQoImluYWN0aXZlX3JlYXNvbiIsICIiKSwKICAgICAgICAgICAgImlzX2xvZ2luIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBhY2NvdW50X2RhdGEuZ2V0KCJhdmF0YXJfdGh1bWIiLCAiIiksCiAgICAgICAgICAgICJ0b3RhbF9qb2JzIjogYWNjb3VudF9kYXRhLmdldCgidG90YWxfam9icyIsIDApLAogICAgICAgICAgICAiam9iX2VuYWJsZSI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiam9iX2VuYWJsZSIsIFRydWUpIGVsc2UgMCwKICAgICAgICAgICAgImpvYl9kaXNhYmxlX3VudGlsIjogYWNjb3VudF9kYXRhLmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKSwKICAgICAgICAgICAgImpvYl90b2RheSI6IGFjY291bnRfZGF0YS5nZXQoImpvYl90b2RheSIsIDApLAogICAgICAgICAgICAiam9iX21heF9kYXkiOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JfbWF4X2RheSIsIGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX0RBWSksCiAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IGFjY291bnRfZGF0YS5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCksCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGFjY291bnRfZGF0YS5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgY29uZmlnX21vZHVsZS5NQVhfSk9CU19QRVJfU0VTU0lPTiksCiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogYWNjb3VudF9kYXRhLmdldCgibGFzdF9qb2JfdGltZSIsIDApLAogICAgICAgICAgICAibGFzdF91cGRhdGUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiY2FyZV90b2RheSI6IGFjY291bnRfZGF0YS5nZXQoImNhcmVfdG9kYXkiLCAwKSwKICAgICAgICAgICAgImlzX2dvbGlrZV9saW5rZWQiOiAxIGlmIGFjY291bnRfZGF0YS5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiZ29saWtlX2lkIjogYWNjb3VudF9kYXRhLmdldCgiZ29saWtlX2lkIiwgIiIpLAogICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAiaXNfc3luYyI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiaXNfc3luYyIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiBhY2NvdW50X2RhdGEuZ2V0KCJmb2xsb3dfZGlzYWJsZV91bnRpbCIsIDApLAogICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogYWNjb3VudF9kYXRhLmdldCgiZm9sbG93X3RvZGF5IiwgMCksCiAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGFjY291bnRfZGF0YS5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCksCiAgICAgICAgICAgICJsYXN0X2ZvbGxvd190aW1lIjogYWNjb3VudF9kYXRhLmdldCgibGFzdF9mb2xsb3dfdGltZSIsIDApLAogICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6IGFjY291bnRfZGF0YS5nZXQoImluYWN0aXZlX2ZvbGxvd19yZWFzb24iLCAiIiksCiAgICAgICAgICAgICJsYXN0X2NhcmVfdGltZSI6IGFjY291bnRfZGF0YS5nZXQoImxhc3RfY2FyZV90aW1lIiwgMCksCiAgICAgICAgICAgICJsYXN0X3ZpZXdfc3RvcmllcyI6IGFjY291bnRfZGF0YS5nZXQoImxhc3Rfdmlld19zdG9yaWVzIiwgMCksCiAgICAgICAgICAgICJhY2NvdW50X3V1aWQiOiBhY2NvdW50X2RhdGEuZ2V0KCJhY2NvdW50X3V1aWQiLCBzdHIodXVpZC51dWlkNCgpKSksICAjIFThuqFvIFVVSUQgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgTMawdSBJRCB04burIGThu68gbGnhu4d1IMSR4bqndSB2w6BvIG7hur91IGPDswogICAgICAgIGlmICJpZCIgaW4gYWNjb3VudF9kYXRhOgogICAgICAgICAgICBtYWluX2RhdGFbImlkIl0gPSBhY2NvdW50X2RhdGFbImlkIl0KICAgICAgICAKICAgICAgICAjIEzGsHUgZOG7ryBsaeG7h3UgcGjhu6UgZMaw4bubaSBk4bqhbmcgSlNPTgogICAgICAgIGV4dHJhX2RhdGEgPSB7azogdiBmb3IgaywgdiBpbiBhY2NvdW50X2RhdGEuaXRlbXMoKSBpZiBrIG5vdCBpbiBtYWluX2RhdGF9CiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb2x1bW5zID0gIiwgIi5qb2luKG1haW5fZGF0YS5rZXlzKCkpCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyA9ICIsICIuam9pbihbIj8iXSAqIGxlbihtYWluX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgdmFsdWVzID0gbGlzdChtYWluX2RhdGEudmFsdWVzKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHbDoG8gY3Xhu5FpCiAgICAgICAgICAgIGNvbHVtbnMgKz0gIiwgZGF0YSIKICAgICAgICAgICAgcGxhY2Vob2xkZXJzICs9ICIsID8iCiAgICAgICAgICAgIHZhbHVlcy5hcHBlbmQoanNvbi5kdW1wcyhleHRyYV9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgSU5TRVJUIE9SIElHTk9SRSDEkeG7gyB0csOhbmggbOG7l2kgZHVwbGljYXRlLCBzYXUgxJHDsyBVUERBVEUgbuG6v3UgY+G6p24KICAgICAgICAgICAgaWYgImlkIiBpbiBtYWluX2RhdGE6CiAgICAgICAgICAgICAgICAjIE7hur91IGPDsyBJRCwgc+G7rSBk4bulbmcgSU5TRVJUIE9SIFJFUExBQ0UgKHVwZGF0ZSBleGlzdGluZyByZWNvcmQpCiAgICAgICAgICAgICAgICBxdWVyeSA9IGYiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBhY2NvdW50cyAoe2NvbHVtbnN9KSBWQUxVRVMgKHtwbGFjZWhvbGRlcnN9KSIKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBJRCwga2nhu4NtIHRyYSBkdXBsaWNhdGUgYuG6sW5nIHVuaXF1ZSBjb25zdHJhaW50CiAgICAgICAgICAgICAgICBhcHAgPSBtYWluX2RhdGEuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgdW5pcXVlX3VzZXJuYW1lID0gbWFpbl9kYXRhLmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgYXBwIGFuZCB1bmlxdWVfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSBjaMawYQogICAgICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgaWQgRlJPTSBhY2NvdW50cyBXSEVSRSBhcHAgPSA/IEFORCB1bmlxdWVfdXNlcm5hbWUgPSA/IiwgKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSkKICAgICAgICAgICAgICAgICAgICBleGlzdGluZyA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgZXhpc3Rpbmc6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWksIGPhuq1wIG5o4bqtdCB0aMO0bmcgdGluCiAgICAgICAgICAgICAgICAgICAgICAgIGV4aXN0aW5nX2lkID0gZXhpc3RpbmdbMF0KICAgICAgICAgICAgICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBpZCBraOG7j2kgbWFpbl9kYXRhIMSR4buDIHVwZGF0ZQogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHtrOiB2IGZvciBrLCB2IGluIG1haW5fZGF0YS5pdGVtcygpIGlmIGsgIT0gImlkIn0KICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFbImRhdGEiXSA9IGpzb24uZHVtcHMoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHNldF9jbGF1c2UgPSAiLCAiLmpvaW4oW2Yie2t9ID0gPyIgZm9yIGsgaW4gdXBkYXRlX2RhdGEua2V5cygpXSkKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX3F1ZXJ5ID0gZiJVUERBVEUgYWNjb3VudHMgU0VUIHtzZXRfY2xhdXNlfSBXSEVSRSBpZCA9ID8iCiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHVwZGF0ZV9xdWVyeSwgbGlzdCh1cGRhdGVfZGF0YS52YWx1ZXMoKSkgKyBbZXhpc3RpbmdfaWRdKQogICAgICAgICAgICAgICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24gY2jGsGEgdOG7k24gdOG6oWksIHRow6ptIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgICMgTG/huqFpIGLhu48gaWQga2jhu49pIG1haW5fZGF0YSDEkeG7gyBJTlNFUlQKICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0X2RhdGEgPSB7azogdiBmb3IgaywgdiBpbiBtYWluX2RhdGEuaXRlbXMoKSBpZiBrICE9ICJpZCJ9CiAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydF9jb2x1bW5zID0gIiwgIi5qb2luKGluc2VydF9kYXRhLmtleXMoKSkgKyAiLCBkYXRhIgogICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRfcGxhY2Vob2xkZXJzID0gIiwgIi5qb2luKFsiPyJdICogbGVuKGluc2VydF9kYXRhKSkgKyAiLCA/IgogICAgICAgICAgICAgICAgICAgICAgICBpbnNlcnRfdmFsdWVzID0gbGlzdChpbnNlcnRfZGF0YS52YWx1ZXMoKSkgKyBbanNvbi5kdW1wcyhleHRyYV9kYXRhKV0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHF1ZXJ5ID0gZiJJTlNFUlQgSU5UTyBhY2NvdW50cyAoe2luc2VydF9jb2x1bW5zfSkgVkFMVUVTICh7aW5zZXJ0X3BsYWNlaG9sZGVyc30pIgogICAgICAgICAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgaW5zZXJ0X3ZhbHVlcykKICAgICAgICAgICAgICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEtow7RuZyBjw7MgYXBwIGhv4bq3YyB1bmlxdWVfdXNlcm5hbWUsIHPhu60gZOG7pW5nIElOU0VSVCBiw6xuaCB0aMaw4budbmcKICAgICAgICAgICAgICAgICAgICBxdWVyeSA9IGYiSU5TRVJUIElOVE8gYWNjb3VudHMgKHtjb2x1bW5zfSkgVkFMVUVTICh7cGxhY2Vob2xkZXJzfSkiCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAiaWQiIGluIG1haW5fZGF0YToKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCB2YWx1ZXMpCiAgICAgICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgdGjDqm0gdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiB1cGRhdGVfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGRhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHbhu5tpIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGThu68gbGnhu4d1CiAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGRhdGEpCiAgICAgICAgICAgIGFjY291bnRbImxhc3RfdXBkYXRlIl0gPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkcOhbmggZOG6pXUgY+G6p24gc3luYyB0cuG7qyBraGkgZGF0YSDEkcOjIGPDsyBpc19zeW5jIMSRxrDhu6NjIHNldCByw7UgcsOgbmcKICAgICAgICAgICAgaWYgImlzX3N5bmMiIG5vdCBpbiBkYXRhOgogICAgICAgICAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOhY2ggbWFpbl9kYXRhIHbDoCBleHRyYV9kYXRhCiAgICAgICAgICAgICMgTOG6pXkgdOG6pXQgY+G6oyBjw6FjIGPhu5l0IGPhu6dhIGLhuqNuZyBhY2NvdW50cwogICAgICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJQUkFHTUEgdGFibGVfaW5mbyhhY2NvdW50cykiKQogICAgICAgICAgICBjb2x1bW5zID0gW3Jvd1sxXSBmb3Igcm93IGluIGN1cnNvci5mZXRjaGFsbCgpXQogICAgICAgICAgICBtYWluX2RhdGEgPSB7fQogICAgICAgICAgICBleHRyYV9kYXRhID0ge30KICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gYWNjb3VudC5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYga2V5IGluIGNvbHVtbnM6CiAgICAgICAgICAgICAgICAgICAgbWFpbl9kYXRhW2tleV0gPSB2YWx1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhW2tleV0gPSB2YWx1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHVwZGF0ZSBjaHV5w6puIGJp4buHdAogICAgICAgICAgICByZXR1cm4gc2VsZi51cGRhdGVfYWNjb3VudF9ieV9pZChhY2NvdW50X2lkLCBtYWluX2RhdGEsIGV4dHJhX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBnZXRfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiJM4bqleSB0aMO0bmcgdGluIGPhu6dhIG3hu5l0IHTDoGkga2hv4bqjbiB0aGVvIElEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IiwgKGFjY291bnRfaWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSA9IGJvb2woYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSkKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBmb2xsb3cgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImZvbGxvd190b2RheSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gPSBpbnQoYWNjb3VudFsiZm9sbG93X3RvZGF5Il0pIGlmIGFjY291bnRbImZvbGxvd190b2RheSJdIGVsc2UgMAogICAgICAgIGlmICJmb2xsb3dfaW5fc2Vzc2lvbiIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSA9IGludChhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdIGVsc2UgMAogICAgICAgICMgxJDDoyBsb+G6oWkgYuG7jyBtYXhfZm9sbG93X2RheSB2w6AgbWF4X2ZvbGxvd19zZXNzaW9uCiAgICAgICAgaWYgImxhc3RfZm9sbG93X3RpbWUiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0pIGlmIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSBlbHNlIDAKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBjYXJlIHRow6BuaCBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgIGlmICJsYXN0X2NhcmVfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdKSBpZiBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdIGVsc2UgMAogICAgICAgIGlmICJsYXN0X3ZpZXdfc3RvcmllcyIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSA9IGludChhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdKSBpZiBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbImRhdGEiXSkKICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAoKICAgIGRlZiB1cGRhdGVfYWNjb3VudF9ieV9pZChzZWxmLCBhY2NvdW50X2lkLCBtYWluX2RhdGEsIGV4dHJhX2RhdGE9Tm9uZSk6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB0aGVvIElEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEx1w7RuIHNldCBpc19zeW5jID0gRmFsc2Uga2hpIHVwZGF0ZQogICAgICAgICAgICBtYWluX2RhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIGPDonUgbOG7h25oIFVQREFURQogICAgICAgICAgICB1cGRhdGVfZmllbGRzID0gW10KICAgICAgICAgICAgdmFsdWVzID0gW10KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIG1haW5fZGF0YS5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYga2V5ICE9ICJpZCI6ICAjIEtow7RuZyB1cGRhdGUgSUQKICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZmllbGRzLmFwcGVuZChmIntrZXl9ID0gPyIpCiAgICAgICAgICAgICAgICAgICAgdmFsdWVzLmFwcGVuZCh2YWx1ZSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGV4dHJhX2RhdGE6CiAgICAgICAgICAgICAgICB1cGRhdGVfZmllbGRzLmFwcGVuZCgiZGF0YSA9ID8iKQogICAgICAgICAgICAgICAgdmFsdWVzLmFwcGVuZChqc29uLmR1bXBzKGV4dHJhX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgdmFsdWVzLmFwcGVuZChhY2NvdW50X2lkKSAgIyBXSEVSRSBpZCA9ID8KICAgICAgICAgICAgCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJVUERBVEUgYWNjb3VudHMgU0VUIHsnLCAnLmpvaW4odXBkYXRlX2ZpZWxkcyl9IFdIRVJFIGlkID0gPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHZhbHVlcykKICAgICAgICAgICAgCiAgICAgICAgICAgIHJvd3NfYWZmZWN0ZWQgPSBjdXJzb3Iucm93Y291bnQKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcm93c19hZmZlY3RlZCA+IDA6CiAgICAgICAgICAgICAgICBwcmludChmIkPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gSUQge2FjY291bnRfaWR9IHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHbhu5tpIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbjoge2V9IikKICAgICAgICAgICAgY29ubi5yb2xsYmFjaygpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBnZXRfYWNjb3VudF9ieV91bmlxdWVfdXNlcm5hbWUoc2VsZiwgYXBwOiBzdHIsIHVuaXF1ZV91c2VybmFtZTogc3RyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gdGhlbyBhcHAgdsOgIHVuaXF1ZV91c2VybmFtZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcDogVMOqbiDhu6luZyBk4bulbmcKICAgICAgICAgICAgdW5pcXVlX3VzZXJuYW1lOiBVc2VybmFtZSBkdXkgbmjhuqV0IGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0IGNo4bupYSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBob+G6t2MgTm9uZSBu4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkKICAgICAgICAiIiIKICAgICAgICBpZiBub3QgdW5pcXVlX3VzZXJuYW1lOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUICogRlJPTSBhY2NvdW50cyBXSEVSRSBhcHAgPSA/IEFORCB1bmlxdWVfdXNlcm5hbWUgPSA/IiwgKGFwcCwgdW5pcXVlX3VzZXJuYW1lKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSA9IGJvb2woYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSkKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBmb2xsb3cgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImZvbGxvd190b2RheSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gPSBpbnQoYWNjb3VudFsiZm9sbG93X3RvZGF5Il0pIGlmIGFjY291bnRbImZvbGxvd190b2RheSJdIGVsc2UgMAogICAgICAgIGlmICJmb2xsb3dfaW5fc2Vzc2lvbiIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSA9IGludChhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdIGVsc2UgMAogICAgICAgICMgxJDDoyBsb+G6oWkgYuG7jyBtYXhfZm9sbG93X2RheSB2w6AgbWF4X2ZvbGxvd19zZXNzaW9uCiAgICAgICAgaWYgImxhc3RfZm9sbG93X3RpbWUiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0pIGlmIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSBlbHNlIDAKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBjYXJlIHRow6BuaCBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgIGlmICJsYXN0X2NhcmVfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdKSBpZiBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdIGVsc2UgMAogICAgICAgIGlmICJsYXN0X3ZpZXdfc3RvcmllcyIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSA9IGludChhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdKSBpZiBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbImRhdGEiXSkKICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgCiAgICBkZWYgZ2V0X2FjY291bnRfYnlfdXVpZChzZWxmLCBhY2NvdW50X3V1aWQ6IHN0cikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gY+G7p2EgbeG7mXQgdMOgaSBraG/huqNuIHRoZW8gVVVJRCIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgKiBGUk9NIGFjY291bnRzIFdIRVJFIGFjY291bnRfdXVpZCA9ID8iLCAoYWNjb3VudF91dWlkLCkpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAKICAgICAgICBpZiBub3QgcmVzdWx0OgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgIGFjY291bnQgPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICBhY2NvdW50WyJpc19sb2dpbiJdID0gYm9vbChhY2NvdW50WyJpc19sb2dpbiJdKQogICAgICAgIGFjY291bnRbImpvYl9lbmFibGUiXSA9IGJvb2woYWNjb3VudFsiam9iX2VuYWJsZSJdKQogICAgICAgIGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSA9IGJvb2woYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdKQogICAgICAgIGFjY291bnRbImlzX3N5bmMiXSA9IGJvb2woYWNjb3VudFsiaXNfc3luYyJdKQogICAgICAgIGFjY291bnRbImRpc2FibGVfZm9sbG93Il0gPSBib29sKGFjY291bnRbImRpc2FibGVfZm9sbG93Il0pCiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgZm9sbG93IHRow6BuaCBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgIGlmICJmb2xsb3dfdG9kYXkiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImZvbGxvd190b2RheSJdID0gaW50KGFjY291bnRbImZvbGxvd190b2RheSJdKSBpZiBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSBlbHNlIDAKICAgICAgICBpZiAiZm9sbG93X2luX3Nlc3Npb24iIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gPSBpbnQoYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSkgaWYgYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSBlbHNlIDAKICAgICAgICAjIMSQw6MgbG/huqFpIGLhu48gbWF4X2ZvbGxvd19kYXkgdsOgIG1heF9mb2xsb3dfc2Vzc2lvbgogICAgICAgIGlmICJsYXN0X2ZvbGxvd190aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0gPSBpbnQoYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdKSBpZiBhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0gZWxzZSAwCiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgY2FyZSB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICBpZiAibGFzdF9jYXJlX3RpbWUiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gPSBpbnQoYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSBlbHNlIDAKICAgICAgICBpZiAibGFzdF92aWV3X3N0b3JpZXMiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gPSBpbnQoYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSkgaWYgYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSBlbHNlIDAKICAgICAgICAKICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudCBhbmQgYWNjb3VudFsiZGF0YSJdOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2FkcyhhY2NvdW50WyJkYXRhIl0pCiAgICAgICAgICAgICAgICBhY2NvdW50LnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIAogICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQ6CiAgICAgICAgICAgIGRlbCBhY2NvdW50WyJkYXRhIl0KICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnQKICAgIAogICAgZGVmIGdldF9hY2NvdW50cyhzZWxmLCBhcHA6IHN0ciA9IE5vbmUsIHN0YXR1czogc3RyID0gTm9uZSwgam9iX2VuYWJsZTogYm9vbCA9IE5vbmUsIGRldmljZV9pZDogQW55ID0gVHJ1ZSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdGhlbyDEkWnhu4F1IGtp4buHbiBs4buNYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcDogVMOqbiDhu6luZyBk4bulbmcgxJHhu4MgbOG7jWMKICAgICAgICAgICAgc3RhdHVzOiBUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiDEkeG7gyBs4buNYwogICAgICAgICAgICBqb2JfZW5hYmxlOiBM4buNYyB0aGVvIHRy4bqhbmcgdGjDoWkgYuG6rXQvdOG6r3Qgam9iCiAgICAgICAgICAgIGRldmljZV9pZDogTOG7jWMgdGhlbyBkZXZpY2VfaWQsIGPDsyB0aOG7gyBsw6A6CiAgICAgICAgICAgICAgICAtIFRydWU6IEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6dhIHRoaeG6v3QgYuG7iyBoaeG7h24gdOG6oWkgKG3hurdjIMSR4buLbmgpCiAgICAgICAgICAgICAgICAtIEZhbHNlL05vbmU6IEtow7RuZyBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgICAgICAgICAgLSBDaHXhu5dpOiBM4buNYyB0aGVvIGRldmljZV9pZCBj4bulIHRo4buDIMSRxrDhu6NjIHRydXnhu4FuIHbDoG8KICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBxdWVyeSA9ICJTRUxFQ1QgKiBGUk9NIGFjY291bnRzIgogICAgICAgIHBhcmFtcyA9IFtdCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSDEkWnhu4F1IGtp4buHbiBs4buNYwogICAgICAgIGNvbmRpdGlvbnMgPSBbXQogICAgICAgIGlmIGFwcDoKICAgICAgICAgICAgY29uZGl0aW9ucy5hcHBlbmQoImFwcCA9ID8iKQogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKGFwcCkKICAgICAgICBpZiBzdGF0dXM6CiAgICAgICAgICAgIGNvbmRpdGlvbnMuYXBwZW5kKCJzdGF0dXMgPSA/IikKICAgICAgICAgICAgcGFyYW1zLmFwcGVuZChzdGF0dXMpCiAgICAgICAgaWYgam9iX2VuYWJsZSBpcyBub3QgTm9uZToKICAgICAgICAgICAgY29uZGl0aW9ucy5hcHBlbmQoImpvYl9lbmFibGUgPSA/IikKICAgICAgICAgICAgcGFyYW1zLmFwcGVuZCgxIGlmIGpvYl9lbmFibGUgZWxzZSAwKQogICAgICAgICAgICAKICAgICAgICBpZiBjb25kaXRpb25zOgogICAgICAgICAgICBxdWVyeSArPSAiIFdIRVJFICIgKyAiIEFORCAiLmpvaW4oY29uZGl0aW9ucykKICAgICAgICAgICAgCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHBhcmFtcykKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICBhY2NvdW50cyA9IFtdCiAgICAgICAgZm9yIHJlc3VsdCBpbiByZXN1bHRzOgogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgICAgICBhY2NvdW50ID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICAgICAgYWNjb3VudFsiaXNfbG9naW4iXSA9IGJvb2woYWNjb3VudFsiaXNfbG9naW4iXSkKICAgICAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgICAgIGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSA9IGJvb2woYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdKQogICAgICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBib29sKGFjY291bnRbImlzX3N5bmMiXSkgICAgICAgICAgICAjIEZpeDogUHJlc2VydmUgZGlzYWJsZV9mb2xsb3cgc3RhdHVzIGZyb20gZGF0YWJhc2UKICAgICAgICAgICAgYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSA9IGJvb2woYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGZvbGxvdyB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICAgICAgaWYgImZvbGxvd190b2RheSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImZvbGxvd190b2RheSJdID0gaW50KGFjY291bnRbImZvbGxvd190b2RheSJdKSBpZiBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSBlbHNlIDAKICAgICAgICAgICAgaWYgImZvbGxvd19pbl9zZXNzaW9uIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSA9IGludChhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdIGVsc2UgMAogICAgICAgICAgICAjIMSQw6MgbG/huqFpIGLhu48gbWF4X2ZvbGxvd19kYXkgdsOgIG1heF9mb2xsb3dfc2Vzc2lvbgogICAgICAgICAgICBpZiAibGFzdF9mb2xsb3dfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSA9IGludChhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0pIGlmIGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSBlbHNlIDAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGNhcmUgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgICAgIGlmICJsYXN0X2NhcmVfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gPSBpbnQoYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9jYXJlX3RpbWUiXSBlbHNlIDAKICAgICAgICAgICAgaWYgImxhc3Rfdmlld19zdG9yaWVzIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSA9IGludChhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdKSBpZiBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdIGVsc2UgMAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50IGFuZCBhY2NvdW50WyJkYXRhIl06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGFjY291bnQudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgZGVsIGFjY291bnRbImRhdGEiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgTOG7jWMgdGhlbyBkZXZpY2VfaWQgbuG6v3UgY+G6p24KICAgICAgICBpZiBkZXZpY2VfaWQgaXMgVHJ1ZToKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X2RldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGN1cnJlbnRfZGV2aWNlX2lkOgogICAgICAgICAgICAgICAgIyBM4buNYyB0w6BpIGtob+G6o24gdGhlbyBkZXZpY2VfaWQgY+G7p2EgdGhp4bq/dCBi4buLIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgYWNjLmdldCgiZGV2aWNlX2lkIikgPT0gY3VycmVudF9kZXZpY2VfaWRdCiAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRldmljZV9pZCwgc3RyKSBhbmQgZGV2aWNlX2lkOgogICAgICAgICAgICAjIEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6UgdGjhu4MgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbwogICAgICAgICAgICBhY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBhY2MuZ2V0KCJkZXZpY2VfaWQiKSA9PSBkZXZpY2VfaWRdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50cwogICAgCiAgICBkZWYgZGVsZXRlX2pvYl9oaXN0b3J5X2J5X2FjY291bnQoc2VsZiwgYWNjb3VudF91dWlkOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiWMOzYSB04bqldCBj4bqjIGpvYiBoaXN0b3J5IGPhu6dhIG3hu5l0IHTDoGkga2hv4bqjbiB0aGVvIGFjY291bnRfdXVpZCIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkRFTEVURSBGUk9NIGpvYnNfaGlzdG9yeSBXSEVSRSBhY2NvdW50X3V1aWQgPSA/IiwgKGFjY291bnRfdXVpZCwpKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIGRlbGV0ZWRfY291bnQgPSBjdXJzb3Iucm93Y291bnQKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIHjDs2Ege2RlbGV0ZWRfY291bnR9IGpvYiBoaXN0b3J5IGPhu6dhIHTDoGkga2hv4bqjbiBVVUlEOiB7YWNjb3VudF91dWlkfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB4w7NhIGpvYiBoaXN0b3J5IGPhu6dhIHTDoGkga2hv4bqjbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGRlbGV0ZV9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIHTDoGkga2hv4bqjbiBraOG7j2kgZGF0YWJhc2UiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJERUxFVEUgRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF9pZCwpKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBjdXJzb3Iucm93Y291bnQgPiAwCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB4w7NhIHTDoGkga2hv4bqjbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICAiIiLEkMOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2UgY+G7p2EgdGhyZWFkIGhp4buHbiB04bqhaSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLmxvY2FsLCAnY29ubicpIGFuZCBzZWxmLmxvY2FsLmNvbm46CiAgICAgICAgICAgICAgICBzZWxmLmxvY2FsLmNvbm4uY2xvc2UoKQogICAgICAgICAgICAgICAgc2VsZi5sb2NhbC5jb25uID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSBjw6FjIHRoYW0gY2hp4bq/dSB0aHJlYWQgxJHhu4MgdHLDoW5oIGzhu5dpCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2xvY2FsJyk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYubG9jYWwsICdfbG9jYWxfX2ltcGwnKToKICAgICAgICAgICAgICAgICAgICAjIFjDs2EgdGhhbSBjaGnhur91IHRyb25nIFRocmVhZExvY2FsCiAgICAgICAgICAgICAgICAgICAgZGVsYXR0cihzZWxmLmxvY2FsLCAnX2xvY2FsX19pbXBsJykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX19kZWxfXyhzZWxmKToKICAgICAgICAiIiJI4buneSDEkeG7kWkgdMaw4bujbmciIiIKICAgICAgICBzZWxmLmNsb3NlKCkKICAgIAogICAgZGVmIHVwZGF0ZV9vcl9pbnNlcnRfYWNjb3VudChzZWxmLCBhcHBfbmFtZTogc3RyLCB1bmlxdWVfaWQ6IHN0ciwgZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGhv4bq3YyB0aMOqbSBt4bubaSBt4buZdCB0w6BpIGtob+G6o24gdsOgbyBkYXRhYmFzZQogICAgICAgICIiIgogICAgICAgICMgxJDhuqNtIGLhuqNvIGNvbm5lY3Rpb24gbMOgIGPhu6dhIHRocmVhZCBoaeG7h24gdOG6oWkKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSBjaMawYQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICIiIlNFTEVDVCBpZCBGUk9NIGFjY291bnRzIFdIRVJFIGFwcF9uYW1lID0gPyBBTkQgdW5pcXVlX2lkID0gPyIiIiwgCiAgICAgICAgICAgICAgICAoYXBwX25hbWUsIHVuaXF1ZV9pZCkKICAgICAgICAgICAgKQogICAgICAgICAgICBhY2NvdW50ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gaGnhu4duIGPDswogICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSBk4buvIGxp4buHdSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIlNFTEVDVCBkYXRhIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IiIiLAogICAgICAgICAgICAgICAgICAgIChhY2NvdW50X2lkLCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGN1cnJlbnRfZGF0YV9yb3cgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgICAgICAgICAgY3VycmVudF9kYXRhID0ganNvbi5sb2FkcyhjdXJyZW50X2RhdGFfcm93WzBdKSBpZiBjdXJyZW50X2RhdGFfcm93IGVsc2Uge30KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBI4bujcCBuaOG6pXQgZOG7ryBsaeG7h3UgY8WpIHbDoCBt4bubaQogICAgICAgICAgICAgICAgbWVyZ2VkX2RhdGEgPSB7KipjdXJyZW50X2RhdGEsICoqZGF0YX0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIlVQREFURSBhY2NvdW50cyBTRVQgCiAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgbmlja25hbWUgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgaXNfbG9naW4gPSA/LAogICAgICAgICAgICAgICAgICAgICAgIGpvYl9lbmFibGUgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIGpvYl9tYXhfZGF5ID0gPywKICAgICAgICAgICAgICAgICAgICAgICBsYXN0X3VwZGF0ZSA9ID8KICAgICAgICAgICAgICAgICAgICAgICBXSEVSRSBpZCA9ID8iIiIsCiAgICAgICAgICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXBzKG1lcmdlZF9kYXRhKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoIm5pY2tuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgic3RhdHVzIiwgImFjdGl2ZSIpLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIDEgaWYgZGF0YS5nZXQoImpvYl9lbmFibGUiLCBUcnVlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJqb2JfbWF4X2RheSIsIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZKSwKICAgICAgICAgICAgICAgICAgICAgICAgaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGjDqm0gdMOgaSBraG/huqNuIG3hu5tpCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiIiJJTlNFUlQgSU5UTyBhY2NvdW50cyAoCiAgICAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUsIHVuaXF1ZV9pZCwgbmlja25hbWUsIGRhdGEsIHN0YXR1cywgaXNfbG9naW4sIGpvYl9lbmFibGUsIGpvYl9tYXhfZGF5LCBpc19nb2xpa2VfbGlua2VkLCBnb2xpa2VfaWQsIGxhc3RfdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgKSBWQUxVRVMgKD8sID8sID8sID8sID8sID8sID8sID8sID8sID8sID8pIiIiLAogICAgICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoIm5pY2tuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXBzKGRhdGEpLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgic3RhdHVzIiwgImFjdGl2ZSIpLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIDEgaWYgZGF0YS5nZXQoImpvYl9lbmFibGUiLCBUcnVlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJqb2JfbWF4X2RheSIsIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZKSwKICAgICAgICAgICAgICAgICAgICAgICAgMCwgICMgaXNfZ29saWtlX2xpbmtlZAogICAgICAgICAgICAgICAgICAgICAgICAiIiwgIyBnb2xpa2VfaWQKICAgICAgICAgICAgICAgICAgICAgICAgaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQvdGjDqm0gdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiByZXNldF9sb2dpbl9zdGF0dXNfYnlfYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IOG7qW5nIGThu6VuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyAoYXBwLCBraMO0bmcgcGjhuqNpIGFwcF9uYW1lKQogICAgICAgICIiIgogICAgICAgICMgxJDhuqNtIGLhuqNvIGNvbm5lY3Rpb24gbMOgIGPhu6dhIHRocmVhZCBoaeG7h24gdOG6oWkKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gdsOgIMSRw6FuaCBk4bqldSBj4bqnbiDEkeG7k25nIGLhu5kKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiIiJVUERBVEUgYWNjb3VudHMgU0VUIGlzX2xvZ2luID0gMCwgaXNfc3luYyA9IDAgV0hFUkUgYXBwID0gPyIiIiwKICAgICAgICAgICAgICAgIChhcHBfbmFtZSwpCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ8WpbmcgY+G6rXAgbmjhuq10IHRyxrDhu51uZyBpc19sb2dpbiB0cm9uZyBkYXRhIEpTT04KICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiIiJTRUxFQ1QgaWQsIGRhdGEgRlJPTSBhY2NvdW50cyBXSEVSRSBhcHAgPSA/IiIiLAogICAgICAgICAgICAgICAgKGFwcF9uYW1lLCkKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WzBdCiAgICAgICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkcyhhY2NvdW50WzFdKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2luIHRyb25nIGRhdGEKICAgICAgICAgICAgICAgIGRhdGFbImlzX2xvZ2luIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgICAgICBkYXRhWyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgZGF0YQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiVVBEQVRFIGFjY291bnRzIFNFVCBkYXRhID0gPyBXSEVSRSBpZCA9ID8iIiIsCiAgICAgICAgICAgICAgICAgICAgKGpzb24uZHVtcHMoZGF0YSksIGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW46IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIGFkZF9qb2JfaGlzdG9yeShzZWxmLCBqb2JfZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBUaMOqbSBt4buZdCBi4bqjbiBnaGkgbOG7i2NoIHPhu60gam9iIG3hu5tpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgam9iX2RhdGE6IEThu68gbGnhu4d1IGpvYiBj4bqnbiBsxrB1CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVVJRCBj4bunYSBqb2IgxJHDoyB0aMOqbQogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICBqb2JfdXVpZCA9IGpvYl9kYXRhLmdldCgiam9iX3V1aWQiLCBzdHIodXVpZC51dWlkNCgpKSkKICAgICAgICAKICAgICAgICAjIE7hur91IGtow7RuZyBjw7MgZGV2aWNlX2lkLCBz4butIGThu6VuZyBkZXZpY2VfaWQgaGnhu4duIHThuqFpCiAgICAgICAgZGV2aWNlX2lkID0gam9iX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIAogICAgICAgICMgVMOhY2ggZOG7ryBsaeG7h3UgY2jDrW5oIHbDoCBk4buvIGxp4buHdSBwaOG7pQogICAgICAgIG1haW5fZGF0YSA9IHsKICAgICAgICAgICAgImpvYl91dWlkIjogam9iX3V1aWQsCiAgICAgICAgICAgICJhY2NvdW50X3V1aWQiOiBqb2JfZGF0YS5nZXQoImFjY291bnRfdXVpZCIsICIiKSwKICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgImFwcCI6IGpvYl9kYXRhLmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICAiam9iX2lkIjogam9iX2RhdGEuZ2V0KCJqb2JfaWQiLCAiIiksCiAgICAgICAgICAgICJqb2JfdHlwZSI6IGpvYl9kYXRhLmdldCgiam9iX3R5cGUiLCAiIiksCiAgICAgICAgICAgICJvYmplY3RfaWQiOiBqb2JfZGF0YS5nZXQoIm9iamVjdF9pZCIsICIiKSwKICAgICAgICAgICAgImxpbmsiOiBqb2JfZGF0YS5nZXQoImxpbmsiLCAiIiksCiAgICAgICAgICAgICJzdGF0dXMiOiBqb2JfZGF0YS5nZXQoInN0YXR1cyIsIDApLAogICAgICAgICAgICAic3VjY2VzcyI6IDEgaWYgam9iX2RhdGEuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgInByaWNlIjogam9iX2RhdGEuZ2V0KCJwcmljZSIsIDAuMCksCiAgICAgICAgICAgICJlcnJvcl9tZXNzYWdlIjogam9iX2RhdGEuZ2V0KCJlcnJvcl9tZXNzYWdlIiwgIiIpLAogICAgICAgICAgICAiY3JlYXRlZF9hdCI6IGpvYl9kYXRhLmdldCgiY3JlYXRlZF9hdCIsIGN1cnJlbnRfdGltZSksCiAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGN1cnJlbnRfdGltZSwKICAgICAgICAgICAgImlzX3N5bmMiOiAwICAjIE3hurdjIMSR4buLbmggY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgTMawdSBJRCB04burIGThu68gbGnhu4d1IMSR4bqndSB2w6BvIG7hur91IGPDswogICAgICAgIGlmICJpZCIgaW4gam9iX2RhdGE6CiAgICAgICAgICAgIG1haW5fZGF0YVsiaWQiXSA9IGpvYl9kYXRhWyJpZCJdCiAgICAgICAgCiAgICAgICAgIyBMxrB1IGThu68gbGnhu4d1IHBo4bulIGTGsOG7m2kgZOG6oW5nIEpTT04KICAgICAgICBleHRyYV9kYXRhID0ge2s6IHYgZm9yIGssIHYgaW4gam9iX2RhdGEuaXRlbXMoKSBpZiBrIG5vdCBpbiBtYWluX2RhdGEgYW5kIGsgIT0gImRhdGEifQogICAgICAgIGlmICJkYXRhIiBpbiBqb2JfZGF0YSBhbmQgaXNpbnN0YW5jZShqb2JfZGF0YVsiZGF0YSJdLCBkaWN0KToKICAgICAgICAgICAgZXh0cmFfZGF0YS51cGRhdGUoam9iX2RhdGFbImRhdGEiXSkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbHVtbnMgPSAiLCAiLmpvaW4obWFpbl9kYXRhLmtleXMoKSkKICAgICAgICAgICAgcGxhY2Vob2xkZXJzID0gIiwgIi5qb2luKFsiPyJdICogbGVuKG1haW5fZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICB2YWx1ZXMgPSBsaXN0KG1haW5fZGF0YS52YWx1ZXMoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdsOgbyBjdeG7kWkKICAgICAgICAgICAgY29sdW1ucyArPSAiLCBkYXRhIgogICAgICAgICAgICBwbGFjZWhvbGRlcnMgKz0gIiwgPyIKICAgICAgICAgICAgdmFsdWVzLmFwcGVuZChqc29uLmR1bXBzKGV4dHJhX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgcXVlcnkgPSBmIklOU0VSVCBPUiBSRVBMQUNFIElOVE8gam9ic19oaXN0b3J5ICh7Y29sdW1uc30pIFZBTFVFUyAoe3BsYWNlaG9sZGVyc30pIgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgdmFsdWVzKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBqb2JfdXVpZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgdGjDqm0gbOG7i2NoIHPhu60gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIiIKICAgIAogICAgZGVmIHVwZGF0ZV9qb2JfaGlzdG9yeShzZWxmLCBqb2JfdXVpZDogc3RyLCBkYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBs4buLY2ggc+G7rSBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfdXVpZDogVVVJRCBj4bunYSBqb2IgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIGRhdGE6IEThu68gbGnhu4d1IGPhuq1wIG5o4bqtdAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuq1wIG5o4bqtdCB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgICMgTOG6pXkgam9iIGhp4buHbiB04bqhaQogICAgICAgIGpvYiA9IHNlbGYuZ2V0X2pvYl9oaXN0b3J5KGpvYl91dWlkKQogICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IGThu68gbGnhu4d1CiAgICAgICAgam9iLnVwZGF0ZShkYXRhKQogICAgICAgIGpvYlsibGFzdF91cGRhdGUiXSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAKICAgICAgICAjIEzGsHUgbOG6oWkKICAgICAgICByZXR1cm4gYm9vbChzZWxmLmFkZF9qb2JfaGlzdG9yeShqb2IpKQogICAgCiAgICBkZWYgZ2V0X2pvYl9oaXN0b3J5KHNlbGYsIGpvYl91dWlkOiBzdHIpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIGzhu4tjaCBz4butIGpvYiB0aGVvIFVVSUQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfdXVpZDogVVVJRCBj4bunYSBqb2IgY+G6p24gbOG6pXkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogVGjDtG5nIHRpbiBqb2IgbuG6v3UgdMOsbSB0aOG6pXksIE5vbmUgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gam9ic19oaXN0b3J5IFdIRVJFIGpvYl91dWlkID0gPyIsIChqb2JfdXVpZCwpKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICBqb2IgPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICBqb2JbInN1Y2Nlc3MiXSA9IGJvb2woam9iWyJzdWNjZXNzIl0pCiAgICAgICAgam9iWyJpc19zeW5jIl0gPSBib29sKGpvYlsiaXNfc3luYyJdKQogICAgICAgIAogICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgIGlmICJkYXRhIiBpbiBqb2IgYW5kIGpvYlsiZGF0YSJdOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2Fkcyhqb2JbImRhdGEiXSkKICAgICAgICAgICAgICAgIGpvYi51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBqb2I6CiAgICAgICAgICAgIGRlbCBqb2JbImRhdGEiXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gam9iCiAgICAKICAgIGRlZiBnZXRfam9iX2hpc3RvcnlfYnlfYWNjb3VudChzZWxmLCBhY2NvdW50X3V1aWQ6IHN0ciwgbGltaXQ6IGludCA9IDUwKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBs4buLY2ggc+G7rSBqb2IgY+G7p2EgbeG7mXQgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF91dWlkOiBVVUlEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBsaW1pdDogU+G7kSBsxrDhu6NuZyBi4bqjbiBnaGkgdOG7kWkgxJFhIHRy4bqjIHbhu4EKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggbOG7i2NoIHPhu60gam9iCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICJTRUxFQ1QgKiBGUk9NIGpvYnNfaGlzdG9yeSBXSEVSRSBhY2NvdW50X3V1aWQgPSA/IE9SREVSIEJZIGNyZWF0ZWRfYXQgREVTQyBMSU1JVCA/IiwgCiAgICAgICAgICAgIChhY2NvdW50X3V1aWQsIGxpbWl0KQogICAgICAgICkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICBqb2JzID0gW10KICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgICAgIGpvYiA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgICAgIGpvYlsic3VjY2VzcyJdID0gYm9vbChqb2JbInN1Y2Nlc3MiXSkKICAgICAgICAgICAgam9iWyJpc19zeW5jIl0gPSBib29sKGpvYlsiaXNfc3luYyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBqb2IgYW5kIGpvYlsiZGF0YSJdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGpvYlsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGpvYi51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGpvYjoKICAgICAgICAgICAgICAgIGRlbCBqb2JbImRhdGEiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGpvYnMuYXBwZW5kKGpvYikKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGpvYnMKICAgIAogICAgZGVmIGdldF9wZW5kaW5nX3N5bmNfaXRlbXMoc2VsZiwgdGFibGU6IHN0ciwgbGltaXQ6IGludCA9IDEwMCwgZGV2aWNlX2lkOiBBbnkgPSBUcnVlKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIGPDoWMgYuG6o24gZ2hpIGNoxrBhIMSRxrDhu6NjIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhYmxlOiBUw6puIGLhuqNuZyAoJ2FjY291bnRzJyBob+G6t2MgJ2pvYnNfaGlzdG9yeScpCiAgICAgICAgICAgIGxpbWl0OiBT4buRIGzGsOG7o25nIGLhuqNuIGdoaSB04buRaSDEkWEgdHLhuqMgduG7gQogICAgICAgICAgICBkZXZpY2VfaWQ6IFRoaeG6v3QgYuG7iyBJRCDEkeG7gyBs4buNYzoKICAgICAgICAgICAgICAgIC0gVHJ1ZTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgaGnhu4duIHThuqFpICht4bq3YyDEkeG7i25oKQogICAgICAgICAgICAgICAgLSBGYWxzZS9Ob25lOiBLaMO0bmcgbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIC0gQ2h14buXaTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7pSB0aOG7gyDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIGLhuqNuIGdoaSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAiIiIKICAgICAgICBpZiB0YWJsZSBub3QgaW4gWydhY2NvdW50cycsICdqb2JzX2hpc3RvcnknXToKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgICAgIAogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHV1aWRfZmllbGQgPSAiYWNjb3VudF91dWlkIiBpZiB0YWJsZSA9PSAiYWNjb3VudHMiIGVsc2UgImpvYl91dWlkIgogICAgICAgIAogICAgICAgICMgVGjDqm0gxJFp4buBdSBraeG7h24gbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICBpZiBkZXZpY2VfaWQgaXMgVHJ1ZToKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgaGnhu4duIHThuqFpCiAgICAgICAgICAgIGN1cnJlbnRfZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJTRUxFQ1QgKiBGUk9NIHt0YWJsZX0gV0hFUkUgaXNfc3luYyA9IDAgQU5EIGRldmljZV9pZCA9ID8gTElNSVQgPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIChjdXJyZW50X2RldmljZV9pZCwgbGltaXQpKQogICAgICAgIGVsaWYgZGV2aWNlX2lkOgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGRldmljZV9pZCDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJTRUxFQ1QgKiBGUk9NIHt0YWJsZX0gV0hFUkUgaXNfc3luYyA9IDAgQU5EIGRldmljZV9pZCA9ID8gTElNSVQgPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIChkZXZpY2VfaWQsIGxpbWl0KSkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEtow7RuZyBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgICAgICBxdWVyeSA9IGYiU0VMRUNUICogRlJPTSB7dGFibGV9IFdIRVJFIGlzX3N5bmMgPSAwIExJTUlUID8iCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCAobGltaXQsKSkKICAgICAgICAgICAgCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgaXRlbXMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgaXRlbSA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGl0ZW0gYW5kIGl0ZW1bImRhdGEiXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2FkcyhpdGVtWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgaXRlbS51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGl0ZW06CiAgICAgICAgICAgICAgICBkZWwgaXRlbVsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaXRlbXMuYXBwZW5kKGl0ZW0pCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBpdGVtcwogICAgCiAgICBkZWYgbWFya19hc19zeW5jZWQoc2VsZiwgdGFibGU6IHN0ciwgdXVpZF92YWx1ZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSBi4bqjbiBnaGkgxJHDoyDEkcaw4bujYyDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YWJsZTogVMOqbiBi4bqjbmcgKCdhY2NvdW50cycgaG/hurdjICdqb2JzX2hpc3RvcnknKQogICAgICAgICAgICB1dWlkX3ZhbHVlOiBHacOhIHRy4buLIFVVSUQgY+G7p2EgYuG6o24gZ2hpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgdGFibGUgbm90IGluIFsnYWNjb3VudHMnLCAnam9ic19oaXN0b3J5J106CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICB1dWlkX2ZpZWxkID0gImFjY291bnRfdXVpZCIgaWYgdGFibGUgPT0gImFjY291bnRzIiBlbHNlICJqb2JfdXVpZCIKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgZiJVUERBVEUge3RhYmxlfSBTRVQgaXNfc3luYyA9IDEgV0hFUkUge3V1aWRfZmllbGR9ID0gPyIsCiAgICAgICAgICAgICAgICAodXVpZF92YWx1ZSwpCiAgICAgICAgICAgICkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gY3Vyc29yLnJvd2NvdW50ID4gMAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgxJHDoW5oIGThuqV1IMSRw6MgxJHhu5NuZyBi4buZOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIG1hcmtfYWxsX2FjY291bnRzX25vdF9zeW5jZWQoc2VsZikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBsw6AgY2jGsGEgc3luYwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogU+G7kSB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJVUERBVEUgYWNjb3VudHMgU0VUIGlzX3N5bmMgPSAwIikKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICB1cGRhdGVkX2NvdW50ID0gY3Vyc29yLnJvd2NvdW50CiAgICAgICAgICAgIHJldHVybiB1cGRhdGVkX2NvdW50CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY2jGsGEgc3luYzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIDAKCiAgICBkZWYgZ2V0X2RldmljZV9jb25maWcoc2VsZiwga2V5OiBzdHIsIGRlZmF1bHQ9Tm9uZSkgLT4gQW55OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogS2jDs2EgY+G6pXUgaMOsbmgKICAgICAgICAgICAgZGVmYXVsdDogR2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyB0w6xtIHRo4bqleQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBBbnk6IEdpw6EgdHLhu4sgY+G6pXUgaMOsbmggaG/hurdjIGdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaAogICAgICAgICIiIgogICAgICAgICMgTOG6pXkgY+G6pXUgaMOsbmggdOG7qyBkYXRhYmFzZQogICAgICAgIHJldHVybiBzZWxmLmdldChrZXksIGRlZmF1bHQpCgogICAgZGVmIHNldF9kZXZpY2VfY29uZmlnKHNlbGYsIGtleTogc3RyLCB2YWx1ZTogQW55KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFNldCBhIGRldmljZSBjb25maWd1cmF0aW9uIHZhbHVlIGluIHRoZSBjb25maWcgdGFibGUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBrZXk6IFRoZSBjb25maWd1cmF0aW9uIGtleQogICAgICAgICAgICB2YWx1ZTogVGhlIHZhbHVlIHRvIHNldAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIGlmIHN1Y2Nlc3NmdWwsIEZhbHNlIG90aGVyd2lzZQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnNldChrZXksIHZhbHVlKQoKICAgIGRlZiBnZXRfZ2xvYmFsX2NvbmZpZyhzZWxmLCBkZWZhdWx0PU5vbmUpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGdsb2JhbCBjb25maWcgY2h1bmcgY2hvIHThuqV0IGPhuqMgYXBwcwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRlZmF1bHQ6IENvbmZpZyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyBjw7MgdHJvbmcgREIKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEdsb2JhbCBjb25maWcgY2h1bmcKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5nZXQoImdsb2JhbF9jb25maWciLCBkZWZhdWx0IG9yIHt9KQogICAgCiAgICBkZWYgc2V0X2dsb2JhbF9jb25maWcoc2VsZiwgY29uZmlnOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IGdsb2JhbCBjb25maWcgY2h1bmcgY2hvIHThuqV0IGPhuqMgYXBwcwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZzogR2xvYmFsIGNvbmZpZyBjaHVuZwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnNldCgiZ2xvYmFsX2NvbmZpZyIsIGNvbmZpZykKICAgIAogICAgZGVmIGdldF9hcHBfY29uZmlnKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGRlZmF1bHQ9Tm9uZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY29uZmlnIGNobyBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIFByaW9yaXR5OiBhcHBfY29uZmlnIOKGkiBnbG9iYWxfY29uZmlnIOKGkiBkZWZhdWx0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwICh0aWt0b2ssIHRpa3RvazIsIGluc3RhZ3JhbSwgZXRjLikKICAgICAgICAgICAgZGVmYXVsdDogQ29uZmlnIG3hurdjIMSR4buLbmggY2hvIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogQ29uZmlnIGPhu6dhIGFwcCDEkcOjIG1lcmdlIHRoZW8gcHJpb3JpdHkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgY29uZmlnIHJpw6puZyBj4bunYSBhcHAKICAgICAgICAgICAgYXBwX2NvbmZpZ19rZXkgPSBmInthcHBfbmFtZX1fY29uZmlnIgogICAgICAgICAgICBhcHBfY29uZmlnID0gc2VsZi5nZXQoYXBwX2NvbmZpZ19rZXksIHt9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBnbG9iYWwgY29uZmlnCiAgICAgICAgICAgIGdsb2JhbF9jb25maWcgPSBzZWxmLmdldF9nbG9iYWxfY29uZmlnKHt9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBNZXJnZSB0aGVvIHByaW9yaXR5OiBkZWZhdWx0IOKGkiBnbG9iYWwg4oaSIGFwcAogICAgICAgICAgICBtZXJnZWRfY29uZmlnID0gKGRlZmF1bHQgb3Ige30pLmNvcHkoKQogICAgICAgICAgICBtZXJnZWRfY29uZmlnLnVwZGF0ZShnbG9iYWxfY29uZmlnKQogICAgICAgICAgICBtZXJnZWRfY29uZmlnLnVwZGF0ZShhcHBfY29uZmlnKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIG1lcmdlZF9jb25maWcKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kgZ2V0IGFwcCBjb25maWcgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0IG9yIHt9CiAgICAKICAgIGRlZiBzZXRfYXBwX2NvbmZpZyhzZWxmLCBhcHBfbmFtZTogc3RyLCBhcHBfY29uZmlnOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IGNvbmZpZyBjaG8gbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgYXBwX2NvbmZpZzogQ29uZmlnIGPhu6dhIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIGFwcF9jb25maWdfa2V5ID0gZiJ7YXBwX25hbWV9X2NvbmZpZyIKICAgICAgICByZXR1cm4gc2VsZi5zZXQoYXBwX2NvbmZpZ19rZXksIGFwcF9jb25maWcpCiAgICAKICAgIGRlZiB1cGRhdGVfYXBwX2NvbmZpZyhzZWxmLCBhcHBfbmFtZTogc3RyLCB1cGRhdGVzOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgbeG7mXQgc+G7kSBjb25maWcgY2hvIGFwcCAobWVyZ2UgduG7m2kgY29uZmlnIGhp4buHbiB04bqhaSkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgdXBkYXRlczogRGljdCBjw6FjIGNvbmZpZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBhcHBfY29uZmlnX2tleSA9IGYie2FwcF9uYW1lfV9jb25maWciCiAgICAgICAgY3VycmVudF9jb25maWcgPSBzZWxmLmdldChhcHBfY29uZmlnX2tleSwge30pCiAgICAgICAgY3VycmVudF9jb25maWcudXBkYXRlKHVwZGF0ZXMpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KGFwcF9jb25maWdfa2V5LCBjdXJyZW50X2NvbmZpZykKICAgIAogICAgZGVmIHVwZGF0ZV9nbG9iYWxfY29uZmlnKHNlbGYsIHVwZGF0ZXM6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBnbG9iYWwgY29uZmlnCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdXBkYXRlczogRGljdCBjw6FjIGNvbmZpZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBjdXJyZW50X2NvbmZpZyA9IHNlbGYuZ2V0X2dsb2JhbF9jb25maWcoe30pCiAgICAgICAgY3VycmVudF9jb25maWcudXBkYXRlKHVwZGF0ZXMpCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0X2dsb2JhbF9jb25maWcoY3VycmVudF9jb25maWcpCgogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBHT0xJS0UgQ09ORklHIE1FVEhPRFMKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIGdldF9nb2xpa2VfY29uZmlnKHNlbGYsIGRlZmF1bHQ9Tm9uZSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgR29MaWtlIGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRlZmF1bHQ6IENvbmZpZyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyBjw7MgdHJvbmcgREIKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEdvTGlrZSBjb25maWcKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5nZXQoImdvbGlrZV9jb25maWciLCBkZWZhdWx0IG9yIHt9KQogICAgCiAgICBkZWYgc2V0X2dvbGlrZV9jb25maWcoc2VsZiwgY29uZmlnOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IEdvTGlrZSBjb25maWcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWc6IEdvTGlrZSBjb25maWcKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5zZXQoImdvbGlrZV9jb25maWciLCBjb25maWcpCiAgICAKICAgIGRlZiB1cGRhdGVfZ29saWtlX2NvbmZpZyhzZWxmLCB1cGRhdGVzOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgR29MaWtlIGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVwZGF0ZXM6IERpY3QgY8OhYyBjb25maWcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgY3VycmVudF9jb25maWcgPSBzZWxmLmdldF9nb2xpa2VfY29uZmlnKHt9KQogICAgICAgIGN1cnJlbnRfY29uZmlnLnVwZGF0ZSh1cGRhdGVzKQogICAgICAgIHJldHVybiBzZWxmLnNldF9nb2xpa2VfY29uZmlnKGN1cnJlbnRfY29uZmlnKQoKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgUFJPWFkgQ09ORklHIE1FVEhPRFMgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X2NvbmZpZyhzZWxmLCBkZWZhdWx0PU5vbmUpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFByb3h5IGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRlZmF1bHQ6IENvbmZpZyBt4bq3YyDEkeG7i25oIG7hur91IGtow7RuZyBjw7MgdHJvbmcgREIKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFByb3h5IGNvbmZpZwogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmdldCgicHJveHlfY29uZmlnIiwgZGVmYXVsdCBvciB7fSkKICAgIAogICAgZGVmIHNldF9wcm94eV9jb25maWcoc2VsZiwgY29uZmlnOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IFByb3h5IGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZzogUHJveHkgY29uZmlnCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KCJwcm94eV9jb25maWciLCBjb25maWcpCiAgICAKICAgIGRlZiB1cGRhdGVfcHJveHlfY29uZmlnKHNlbGYsIHVwZGF0ZXM6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBQcm94eSBjb25maWcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB1cGRhdGVzOiBEaWN0IGPDoWMgY29uZmlnIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIGN1cnJlbnRfY29uZmlnID0gc2VsZi5nZXRfcHJveHlfY29uZmlnKHt9KQogICAgICAgIGN1cnJlbnRfY29uZmlnLnVwZGF0ZSh1cGRhdGVzKQogICAgICAgIHJldHVybiBzZWxmLnNldF9wcm94eV9jb25maWcoY3VycmVudF9jb25maWcpCgogICAgZGVmIGdldF9hbGxfZGV2aWNlX2NvbmZpZyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBHZXQgYWxsIGRldmljZSBjb25maWd1cmF0aW9uIHNldHRpbmdzCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IERpY3Rpb25hcnkgb2YgYWxsIGRldmljZSBjb25maWd1cmF0aW9uIHNldHRpbmdzCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgIyBHZXQgYWxsIGtleXMgc3RhcnRpbmcgd2l0aCAiZGV2aWNlXyIgYnV0IGV4Y2x1ZGUgZGV2aWNlX2luZm8KICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGtleSwgdmFsdWUgRlJPTSBjb25maWcgV0hFUkUga2V5ICE9ICdkZXZpY2VfaW5mbycgQU5EIGtleSAhPSAnZGV2aWNlX2lkJyIpCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgIyBCdWlsZCBjb25maWcgZGljdGlvbmFyeSwgcmVtb3ZpbmcgImRldmljZV8iIHByZWZpeCBmcm9tIGtleXMKICAgICAgICBkZXZpY2VfY29uZmlnID0ge30KICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiByZXN1bHRzOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2VfY29uZmlnW2tleV0gPSBqc29uLmxvYWRzKHZhbHVlKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBkZXZpY2VfY29uZmlnW2tleV0gPSB2YWx1ZQogICAgICAgIAogICAgICAgICMgSW1wb3J0IGNvbmZpZyBtb2R1bGUKICAgICAgICBpbXBvcnQgY29uZmlnIGFzIGNvbmZpZ19tb2R1bGUKICAgICAgICAKICAgICAgICAjIEFkZCBkZWZhdWx0IHZhbHVlcyBmb3IgbWlzc2luZyBjb25maWcgaXRlbXMKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnX21vZHVsZS5NQVhfSk9CU19QRVJfREFZLAogICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBjb25maWdfbW9kdWxlLk1BWF9KT0JTX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAiam9iX2ludGVydmFsX3NlY29uZHMiOiBjb25maWdfbW9kdWxlLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgInJlcG9ydF9pbnRlcnZhbCI6IGNvbmZpZ19tb2R1bGUuTVFUVF9SRVBPUlRfSU5URVJWQUwsCiAgICAgICAgICAgICMgImVuYWJsZV9jYXJlIjogY29uZmlnX21vZHVsZS5TTUFSVF9DQVJFX0VOQUJMRUQsICAjIFJFTU9WRUQ6IGtow7RuZyBz4butIGThu6VuZyBu4buvYQogICAgICAgICAgICAjICJjYXJlX2ludGVydmFsX2hvdXJzIjogY29uZmlnX21vZHVsZS5TTUFSVF9DQVJFX0lOVEVSVkFMX0hPVVJTLCAgIyBSRU1PVkVEOiBraMO0bmcgc+G7rSBk4bulbmcgbuG7r2EKICAgICAgICAgICAgIyAiY2FyZV9jaGFuY2VfcGVyY2VudCI6IGNvbmZpZ19tb2R1bGUuU01BUlRfQ0FSRV9DSEFOQ0VfUEVSQ0VOVCAgIyBSRU1PVkVEOiBraMO0bmcgc+G7rSBk4bulbmcgbuG7r2EKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZm9yIGtleSwgZGVmYXVsdF92YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZ3MuaXRlbXMoKToKICAgICAgICAgICAgaWYga2V5IG5vdCBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZ1trZXldID0gZGVmYXVsdF92YWx1ZQogICAgICAgIAogICAgICAgICMgTG/huqFpIGLhu48gY8OhYyB0csaw4budbmcga2jDtG5nIGPhuqduIHRoaeG6v3QKICAgICAgICBrZXlzX3RvX3JlbW92ZSA9IFsiaWQiLCAiZ29saWtlX2FwaV9iYXNlIl0KICAgICAgICBmb3Iga2V5IGluIGtleXNfdG9fcmVtb3ZlOgogICAgICAgICAgICBpZiBrZXkgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGRlbCBkZXZpY2VfY29uZmlnW2tleV0KICAgICAgICAKICAgICAgICByZXR1cm4gZGV2aWNlX2NvbmZpZwoKICAgIGRlZiBzYXZlX2RldmljZV9jb25maWcoc2VsZiwgY29uZmlnX2RpY3Q6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzGsHUgbmhp4buBdSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgY8O5bmcgbMO6YwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZ19kaWN0OiBEaWN0aW9uYXJ5IGNo4bupYSBjw6FjIGPhurdwIGtleS12YWx1ZSBj4bqldSBow6xuaAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBjb25maWdfZGljdC5pdGVtcygpOgogICAgICAgICAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZyhrZXksIHZhbHVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbMawdSBj4bqldSBow6xuaCB0aGnhur90IGLhu4s6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgaW5pdF9kZWZhdWx0X2NvbmZpZyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCBjaG8gdGhp4bq/dCBi4buLCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEPhuqV1IGjDrG5oIMSRw6Mga2jhu59pIHThuqFvCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIERFRkFVTFRfR0xPQkFMX0NPTkZJRyB04burIGNvbmZpZy5weSB0aGF5IHbDrCBoYXJkY29kZQogICAgICAgICAgICBkZWZhdWx0X2NvbmZpZyA9IGNvbmZpZy5ERUZBVUxUX0dMT0JBTF9DT05GSUcuY29weSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIHN5bmNfaW50ZXJ2YWwgdsOgbyBnbG9iYWwgY29uZmlnCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnWyJzeW5jX2ludGVydmFsIl0gPSBjb25maWcuU1lOQ19JTlRFUlZBTAogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZy5pdGVtcygpOgogICAgICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgc2VsZi5nZXRfZGV2aWNlX2NvbmZpZyhrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZyhrZXksIHZhbHVlKQogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoIsSQw6Mga2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggY2hvIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0X2NvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkga2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgIGRlZiBnZXRfb3JfY3JlYXRlX2RldmljZV9pZChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgaG/hurdjIHThuqFvIGRldmljZV9pZAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkCiAgICAgICAgIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgZGV2aWNlX2lkIHRyb25nIGRhdGFiYXNlIGtow7RuZwogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsICIiKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIFRo4butIGzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZwogICAgICAgIGRldmljZV9pZCA9IHNlbGYuX2dldF9kZXZpY2VfaWRfZnJvbV9zeXN0ZW0oKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmggdsOgIHRy4bqjIHbhu4EKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZzoge2RldmljZV9pZH0iKQogICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKCJkZXZpY2VfaWQiLCBkZXZpY2VfaWQpCiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAgICAgCiAgICAgICAgIyBUaOG7rSBs4bqleSBkZXZpY2VfaWQgdOG7qyBoZWxwZXIgc2VydmljZQogICAgICAgIGRldmljZV9pZCA9IHNlbGYuX2dldF9kZXZpY2VfaWRfZnJvbV9oZWxwZXIoKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmggdsOgIHRy4bqjIHbhu4EKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlOiB7ZGV2aWNlX2lkfSIpCiAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIE7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYywgdOG6oW8gbeG7m2kKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgaW1wb3J0IHN0cmluZwogICAgICAgIHJhbmRvbV9pZCA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX2xvd2VyY2FzZSArIHN0cmluZy5kaWdpdHMsIGs9MTApKQogICAgICAgIGRldmljZV9pZCA9IGYicmFuZG9tX3tyYW5kb21faWR9IgogICAgICAgIHByaW50KGYiS2jDtG5nIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCBi4bqxbmcgY8OhYyBjw6FjaCB0csOqbiwgdOG6oW8gbeG7m2k6IHtkZXZpY2VfaWR9IikKICAgICAgICAKICAgICAgICAjIEzGsHUgdsOgbyBj4bqldSBow6xuaAogICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgCiAgICBkZWYgX2dldF9kZXZpY2VfaWRfZnJvbV9zeXN0ZW0oc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZyAoc+G7rSBk4bulbmcgbOG7h25oIGdldHByb3ApCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBkZXZpY2VfaWQgaG/hurdjIGNodeG7l2kgcuG7l25nIG7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHN1YnByb2Nlc3MKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWyJnZXRwcm9wIiwgInJvLnNlcmlhbG5vIl0sIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSkKICAgICAgICAgICAgZGV2aWNlX2lkID0gcmVzdWx0LnN0ZG91dC5zdHJpcCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkZXZpY2VfaWQgYW5kIGRldmljZV9pZCAhPSAidW5rbm93biI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbOG6pXkgZGV2aWNlX2lkIHThu6sgaOG7hyB0aOG7kW5nOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgCiAgICBkZWYgX2dldF9kZXZpY2VfaWRfZnJvbV9oZWxwZXIoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlIChhbmRyb2lkX2lkKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkIGhv4bq3YyBjaHXhu5dpIHLhu5duZyBu4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ+G6p24gaW1wb3J0IEhlbHBlclNlcnZpY2UgdOG6oWkgxJHDonkgxJHhu4MgdHLDoW5oIGltcG9ydCB2w7JuZwogICAgICAgICAgICBmcm9tIHNlcnZpY2VzLmhlbHBlcl9zZXJ2aWNlIGltcG9ydCBIZWxwZXJTZXJ2aWNlCiAgICAgICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGhlbHBlciA9IEhlbHBlclNlcnZpY2UoYmFzZV91cmw9Y29uZmlnLkhFTFBFUl9TRVJWSUNFX1VSTCkKICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBoZWxwZXIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRldmljZV9pbmZvIGFuZCAic3RhdHVzIiBpbiBkZXZpY2VfaW5mbyBhbmQgZGV2aWNlX2luZm9bInN0YXR1cyJdID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgIGRhdGEgPSBkZXZpY2VfaW5mby5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgICAgIGFuZHJvaWRfaWQgPSBkYXRhLmdldCgiYW5kcm9pZF9pZCIsICIiKQogICAgICAgICAgICAgICAgaWYgYW5kcm9pZF9pZDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5kcm9pZF9pZAogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGzhuqV5IGRldmljZV9pZCB04burIGhlbHBlcjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgIAogICAgZGVmIG1pZ3JhdGVfZ29saWtlX2NvbmZpZyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjDs2EgY8OhYyBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwIGtow7RuZyBjw7JuIGPhuqduIHRoaeG6v3QKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmludCgixJBhbmcgeMOzYSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyBr4bq/dCBu4buRaSBEQgogICAgICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBrZXkgY+G6p24geMOzYQogICAgICAgICAgICBrZXlzX3RvX2RlbGV0ZSA9IFsKICAgICAgICAgICAgICAgICJnb2xpa2VfaGVhZGVycyIsIAogICAgICAgICAgICAgICAgImdvbGlrZV9oZWFkZXJzX3VwZGF0ZWQiLAogICAgICAgICAgICAgICAgImdvbGlrZV9hcGlfYmFzZSIKICAgICAgICAgICAgXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIGPDoWMga2V5IHRyw7luZyBs4bq3cCBjxakKICAgICAgICAgICAgZGVsZXRlZF9jb3VudCA9IDAKICAgICAgICAgICAgZm9yIGtleSBpbiBrZXlzX3RvX2RlbGV0ZToKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJERUxFVEUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICAgICAgICAgIGRlbGV0ZWRfY291bnQgKz0gY3Vyc29yLnJvd2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENvbW1pdCB0aGF5IMSR4buVaQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBwcmludChmIsSQw6MgeMOzYSB7ZGVsZXRlZF9jb3VudH0gY+G6pXUgaMOsbmggR29MaWtlIHRyw7luZyBs4bq3cCIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgeMOzYSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoc2VsZiwgYWNjb3VudF9pZDogaW50LCBpbmFjdGl2ZV9yZWFzb246IHN0ciA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikgLT4gYm9vbDoKICAgICAgICAiIiLEkOG6t3QgdMOgaSBraG/huqNuIHbDoG8gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSDEkeG6v24gZ2nhu50gcmVzZXQgdGnhur9wIHRoZW8gaG/hurdjIHNlc3Npb25fY29vbGRvd25fbWludXRlcyAoY2jhu41uIG5n4bqvbiBoxqFuKSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGRhdGV0aW1lLCBjb25maWcsIHRpbWUKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIGPDsyBJRCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBHaeG7nSByZXNldCB2w6Agc2Vzc2lvbiBjb29sZG93biAtIHPhu60gZOG7pW5nIGRhaWx5X3Jlc2V0X2hvdXIgdGhheSB2w6wgam9iX2hvdXIKICAgICAgICAgICAgZGFpbHlfcmVzZXRfaG91ciA9IHNlbGYuZ2V0KCJkYWlseV9yZXNldF9ob3VyIiwgNykgICMgTeG6t2MgxJHhu4tuaCA3aCBzw6FuZwogICAgICAgICAgICBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmdldCgic2Vzc2lvbl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOtbmggdGjhu51pIGdpYW4gxJHhur9uIGzDumMgcmVzZXQgdGnhur9wIHRoZW8KICAgICAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICAgICAgbmV4dF9yZXNldCA9IG5vdy5yZXBsYWNlKGhvdXI9ZGFpbHlfcmVzZXRfaG91ciwgbWludXRlPTAsIHNlY29uZD0wLCBtaWNyb3NlY29uZD0wKQogICAgICAgICAgICBpZiBub3cgPj0gbmV4dF9yZXNldDoKICAgICAgICAgICAgICAgIG5leHRfcmVzZXQgPSBuZXh0X3Jlc2V0ICsgZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOtbmggc+G7kSBwaMO6dCB04burIGLDonkgZ2nhu50gxJHhur9uIGzDumMgcmVzZXQKICAgICAgICAgICAgdGltZV90b19yZXNldF9taW51dGVzID0gaW50KChuZXh0X3Jlc2V0IC0gbm93KS50b3RhbF9zZWNvbmRzKCkgLyA2MCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu41uIHRo4budaSBnaWFuIG5n4bqvbiBoxqFuIGdp4buvYSB0aW1lX3RvX3Jlc2V0IHbDoCBzZXNzaW9uX2Nvb2xkb3duX21pbnV0ZXMKICAgICAgICAgICAgZGlzYWJsZV9taW51dGVzID0gbWluKHRpbWVfdG9fcmVzZXRfbWludXRlcywgc2Vzc2lvbl9jb29sZG93bl9taW51dGVzKQogICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGludCh0aW1lLnRpbWUoKSArIGRpc2FibGVfbWludXRlcyAqIDYwKQogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoZiJbREJdIFTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsIGFjY291bnRfaWQpfTogdGjhu51pIGdpYW4gxJHhur9uIHJlc2V0ID0ge3RpbWVfdG9fcmVzZXRfbWludXRlc30gcGjDunQsIGNvb2xkb3duID0ge3Nlc3Npb25fY29vbGRvd25fbWludXRlc30gcGjDunQsIGNo4buNbiA9IHtkaXNhYmxlX21pbnV0ZXN9IHBow7p0IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJpbmFjdGl2ZSIsCiAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBqb2JfZGlzYWJsZV91bnRpbCwKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGluYWN0aXZlX3JlYXNvbiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZXRfYWNjb3VudF9pbmFjdGl2ZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGNvb2xkb3duX21pbnV0ZXM6IGludCA9IE5vbmUsIGluYWN0aXZlX3JlYXNvbjogc3RyID0gIsSQw6MgaG/DoG4gdGjDoG5oIHPhu5Egam9iIHRyb25nIHBoacOqbiIpIC0+IGJvb2w6CiAgICAgICAgIiIixJDhurd0IHTDoGkga2hv4bqjbiB2w6BvIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUgdHJvbmcga2hv4bqjbmcgdGjhu51pIGdpYW4gKHBow7p0KSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHRpbWUsIGNvbmZpZwogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIGPDsyBJRCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGlmIGNvb2xkb3duX21pbnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmdldCgic2Vzc2lvbl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBT4butIGThu6VuZyBjb29sZG93bl9taW51dGVzIG3hurdjIMSR4buLbmg6IHtjb29sZG93bl9taW51dGVzfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gU+G7rSBk4bulbmcgY29vbGRvd25fbWludXRlcyDEkcaw4bujYyB0cnV54buBbiB2w6BvOiB7Y29vbGRvd25fbWludXRlc30iKQogICAgICAgICAgICAKICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBpbnQodGltZS50aW1lKCkgKyBjb29sZG93bl9taW51dGVzICogNjApCiAgICAgICAgICAgIHByaW50KGYiW0RCXSBTZXQgYWNjb3VudCBpbmFjdGl2ZTogY29vbGRvd25fbWludXRlcz17Y29vbGRvd25fbWludXRlc30sIGpvYl9kaXNhYmxlX3VudGlsPXtqb2JfZGlzYWJsZV91bnRpbH0sIGN1cnJlbnRfdGltZT17aW50KHRpbWUudGltZSgpKX0iKQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiaW5hY3RpdmUiLAogICAgICAgICAgICAgICAgImpvYl9kaXNhYmxlX3VudGlsIjogam9iX2Rpc2FibGVfdW50aWwsCiAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBpbmFjdGl2ZV9yZWFzb24sCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiW0RCXSBM4buXaSBzZXRfYWNjb3VudF9pbmFjdGl2ZToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlIAoKICAgIGRlZiBkaXNhYmxlX2FjY291bnRfZm9sbG93KHNlbGYsIGFjY291bnRfaWQ6IGludCwgcGVuYWx0eV9ob3VyczogaW50ID0gTm9uZSwgcGVuYWx0eV9taW51dGVzOiBpbnQgPSBOb25lLCByZWFzb246IHN0ciA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBEaXNhYmxlIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHRyb25nIG3hu5l0IGtob+G6o25nIHRo4budaSBnaWFuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHBlbmFsdHlfaG91cnM6IFPhu5EgZ2nhu50gZGlzYWJsZSBmb2xsb3cgKMawdSB0acOqbiB0aOG6pXAgaMahbiBwZW5hbHR5X21pbnV0ZXMpCiAgICAgICAgICAgIHBlbmFsdHlfbWludXRlczogU+G7kSBwaMO6dCBkaXNhYmxlIGZvbGxvdyAoxrB1IHRpw6puIGNhbyBoxqFuIHBlbmFsdHlfaG91cnMpCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIGRpc2FibGUgZm9sbG93CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCB0aW1lCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxq91IHRpw6puIHBlbmFsdHlfbWludXRlcywgbuG6v3Uga2jDtG5nIGPDsyB0aMOsIGTDuW5nIHBlbmFsdHlfaG91cnMKICAgICAgICAgICAgaWYgcGVuYWx0eV9taW51dGVzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdG90YWxfbWludXRlcyA9IHBlbmFsdHlfbWludXRlcwogICAgICAgICAgICAgICAgZGlzcGxheV91bml0ID0gZiJ7cGVuYWx0eV9taW51dGVzfSBwaMO6dCIKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBT4butIGThu6VuZyBwZW5hbHR5X21pbnV0ZXM6IHtwZW5hbHR5X21pbnV0ZXN9IikKICAgICAgICAgICAgZWxpZiBwZW5hbHR5X2hvdXJzIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdG90YWxfbWludXRlcyA9IHBlbmFsdHlfaG91cnMgKiA2MAogICAgICAgICAgICAgICAgZGlzcGxheV91bml0ID0gZiJ7cGVuYWx0eV9ob3Vyc30gZ2nhu50iCiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gU+G7rSBk4bulbmcgcGVuYWx0eV9ob3Vyczoge3BlbmFsdHlfaG91cnN9IC0+IHt0b3RhbF9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50gPSA3MjAgcGjDunQKICAgICAgICAgICAgICAgIHRvdGFsX21pbnV0ZXMgPSA3MjAKICAgICAgICAgICAgICAgIGRpc3BsYXlfdW5pdCA9ICI3MjAgcGjDunQgKG3hurdjIMSR4buLbmgpIgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIFPhu60gZOG7pW5nIG3hurdjIMSR4buLbmg6IHt0b3RhbF9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb2xsb3dfZGlzYWJsZV91bnRpbCA9IGludCh0aW1lLnRpbWUoKSkgKyB0b3RhbF9taW51dGVzICogNjAKICAgICAgICAgICAgcHJpbnQoZiJbREJdIERpc2FibGUgZm9sbG93OiB0b3RhbF9taW51dGVzPXt0b3RhbF9taW51dGVzfSwgZm9sbG93X2Rpc2FibGVfdW50aWw9e2ZvbGxvd19kaXNhYmxlX3VudGlsfSwgY3VycmVudF90aW1lPXtpbnQodGltZS50aW1lKCkpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IFRydWUsCiAgICAgICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiBmb2xsb3dfZGlzYWJsZV91bnRpbCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIjogcmVhc29uLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBwcmludChmIltEQl0gxJDDoyBkaXNhYmxlIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgYWNjb3VudF9pZCl9IHRyb25nIHtkaXNwbGF5X3VuaXR9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltEQl0gTOG7l2kgZGlzYWJsZV9hY2NvdW50X2ZvbGxvdzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGVuYWJsZV9hY2NvdW50X2ZvbGxvdyhzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgRW5hYmxlIGzhuqFpIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogRmFsc2UsCiAgICAgICAgICAgICAgICAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiAiIiwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgcHJpbnQoZiJbREJdIMSQw6MgZW5hYmxlIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgYWNjb3VudF9pZCl9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltEQl0gTOG7l2kgZW5hYmxlX2FjY291bnRfZm9sbG93OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIGdldF9hY2NvdW50c19ieV9hcHBfYW5kX2dvbGlrZV9zdGF0dXMoc2VsZiwgYXBwOiBzdHIsIGlzX2xpbmtlZDogYm9vbCA9IEZhbHNlKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiB0aGVvIGFwcCB2w6AgdHLhuqFuZyB0aMOhaSBnb2xpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHA6IFTDqm4g4bupbmcgZOG7pW5nIChpbnN0YWdyYW0sIHRpa3RvaywgLi4uKQogICAgICAgICAgICBpc19saW5rZWQ6IFRydWUgbuG6v3UgbOG6pXkgdMOgaSBraG/huqNuIMSRw6MgbGnDqm4ga+G6v3QsIEZhbHNlIG7hur91IGzhuqV5IHTDoGkga2hv4bqjbiBjaMawYSBsacOqbiBr4bq/dAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBxdWVyeSA9ICJTRUxFQ1QgKiBGUk9NIGFjY291bnRzIFdIRVJFIGFwcCA9ID8gQU5EIGlzX2dvbGlrZV9saW5rZWQgPSA/IgogICAgICAgIHBhcmFtcyA9IFthcHAsIDEgaWYgaXNfbGlua2VkIGVsc2UgMF0KICAgICAgICAKICAgICAgICAjIEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6dhIHRoaeG6v3QgYuG7iyBoaeG7h24gdOG6oWkKICAgICAgICBjdXJyZW50X2RldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIGlmIGN1cnJlbnRfZGV2aWNlX2lkOgogICAgICAgICAgICBxdWVyeSArPSAiIEFORCBkZXZpY2VfaWQgPSA/IgogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKGN1cnJlbnRfZGV2aWNlX2lkKQogICAgICAgIAogICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCBwYXJhbXMpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgICAgIGFjY291bnRbImpvYl9lbmFibGUiXSA9IGJvb2woYWNjb3VudFsiam9iX2VuYWJsZSJdKQogICAgICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgICAgICMgTHXDtG4gbHXDtG4gxJHhu4MgZGlzYWJsZV9mb2xsb3cgPSBGYWxzZSB2w6wgxJHDoyBi4buPIGdp4bubaSBo4bqhbiBmb2xsb3cKICAgICAgICAgICAgYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSA9IGJvb2woYWNjb3VudFsiZGlzYWJsZV9mb2xsb3ciXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudCBhbmQgYWNjb3VudFsiZGF0YSJdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbImRhdGEiXSkKICAgICAgICAgICAgICAgICAgICBhY2NvdW50LnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGRlbCBhY2NvdW50WyJkYXRhIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50cy5hcHBlbmQoYWNjb3VudCkKICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudHMKICAgIAogICAgZGVmIGdldF9hY2NvdW50X2NhcmVfZGF0YShzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGRpY3Q6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY2FyZSBkYXRhIGPhu6dhIHTDoGkga2hv4bqjbiBkxrDhu5tpIGThuqFuZyBkaWN0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGRpY3Q6IENhcmUgZGF0YSBob+G6t2MgZGljdCBy4buXbmcgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KHNlbGYuZGJfcGF0aCkKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBjYXJlX2RhdGEgRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF9pZCwpKQogICAgICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3VsdCBhbmQgcmVzdWx0WzBdOgogICAgICAgICAgICAgICAgaW1wb3J0IGpzb24KICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWRzKHJlc3VsdFswXSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbOG6pXkgY2FyZSBkYXRhIGNobyBhY2NvdW50IHthY2NvdW50X2lkfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAKICAgIGRlZiB1cGRhdGVfYWNjb3VudF9jYXJlX2RhdGEoc2VsZiwgYWNjb3VudF9pZDogaW50LCBjYXJlX2RhdGE6IGRpY3QpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBjYXJlIGRhdGEgY2hvIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBjYXJlX2RhdGE6IERpY3Rpb25hcnkgY2jhu6lhIHRow7RuZyB0aW4gY2FyZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGpzb24KICAgICAgICAgICAgY2FyZV9qc29uID0ganNvbi5kdW1wcyhjYXJlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25uID0gc3FsaXRlMy5jb25uZWN0KHNlbGYuZGJfcGF0aCkKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiVVBEQVRFIGFjY291bnRzIFNFVCBjYXJlX2RhdGEgPSA/LCBpc19zeW5jID0gMCBXSEVSRSBpZCA9ID8iLCAKICAgICAgICAgICAgICAgIChjYXJlX2pzb24sIGFjY291bnRfaWQpCiAgICAgICAgICAgICkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICBjb25uLmNsb3NlKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KGYixJDDoyBj4bqtcCBuaOG6rXQgY2FyZSBkYXRhIGNobyBhY2NvdW50IHthY2NvdW50X2lkfSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgY2FyZSBkYXRhIGNobyBhY2NvdW50IHthY2NvdW50X2lkfToge2V9IikKICAgIAogICAgZGVmIG1lcmdlX2FjY291bnRfY2FyZV9kYXRhKHNlbGYsIGFjY291bnRfaWQ6IGludCwgbmV3X2RhdGE6IGRpY3QpOgogICAgICAgICIiIgogICAgICAgIE1lcmdlIGThu68gbGnhu4d1IG3hu5tpIHbDoG8gY2FyZSBkYXRhIGhp4buHbiBjw7MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgbmV3X2RhdGE6IERpY3Rpb25hcnkgY2jhu6lhIGThu68gbGnhu4d1IG3hu5tpIGPhuqduIG1lcmdlCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGNhcmUgZGF0YSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY3VycmVudF9kYXRhID0gc2VsZi5nZXRfYWNjb3VudF9jYXJlX2RhdGEoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTWVyZ2UgZOG7ryBsaeG7h3UgbeG7m2kKICAgICAgICAgICAgY3VycmVudF9kYXRhLnVwZGF0ZShuZXdfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGzhuqFpCiAgICAgICAgICAgIHNlbGYudXBkYXRlX2FjY291bnRfY2FyZV9kYXRhKGFjY291bnRfaWQsIGN1cnJlbnRfZGF0YSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIG1lcmdlIGNhcmUgZGF0YSBjaG8gYWNjb3VudCB7YWNjb3VudF9pZH06IHtlfSIpCiAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9sYXN0X3Bvc3RfdGltZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGFwcDogc3RyKSAtPiBPcHRpb25hbFtpbnRdOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4budaSBnaWFuIMSRxINuZyBiw6BpIGfhuqduIG5o4bqldCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgYXBwOiBUw6puIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBPcHRpb25hbFtpbnRdOiBUaW1lc3RhbXAgY+G7p2EgbOG6p24gxJHEg25nIGLDoGkgZ+G6p24gbmjhuqV0LCBOb25lIG7hur91IGNoxrBhIGPDswogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiU0VMRUNUIGxhc3RfcG9zdF90aW1lIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IEFORCBhcHAgPSA/IiwKICAgICAgICAgICAgICAgIChhY2NvdW50X2lkLCBhcHApCiAgICAgICAgICAgICkKICAgICAgICAgICAgcmVzdWx0ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHRbMF0gaWYgcmVzdWx0IGFuZCByZXN1bHRbMF0gZWxzZSBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbOG6pXkgbGFzdF9wb3N0X3RpbWUgY2hvIGFjY291bnQge2FjY291bnRfaWR9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgc2V0X2FjY291bnRfbGFzdF9wb3N0X3RpbWUoc2VsZiwgYWNjb3VudF9pZDogaW50LCBhcHA6IHN0ciwgcG9zdF90aW1lOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4budaSBnaWFuIMSRxINuZyBiw6BpIGfhuqduIG5o4bqldCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgYXBwOiBUw6puIGFwcAogICAgICAgICAgICBwb3N0X3RpbWU6IFRpbWVzdGFtcCBj4bunYSBs4bqnbiDEkcSDbmcgYsOgaQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuq1wIG5o4bqtdCB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgIlVQREFURSBhY2NvdW50cyBTRVQgbGFzdF9wb3N0X3RpbWUgPSA/IFdIRVJFIGlkID0gPyBBTkQgYXBwID0gPyIsCiAgICAgICAgICAgICAgICAocG9zdF90aW1lLCBhY2NvdW50X2lkLCBhcHApCiAgICAgICAgICAgICkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5yb3djb3VudCA+IDAKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgbGFzdF9wb3N0X3RpbWUgY2hvIGFjY291bnQge2FjY291bnRfaWR9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UK').decode('utf-8'))
