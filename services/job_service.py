import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIERFRkFVTFRfTUFYX0ZPTExPV19EQVkgPSAyMAogICAgREVGQVVMVF9NQVhfRk9MTE9XX1NFU1NJT04gPSA1CiAgICBNQVhfV0FSTklOR19MT0dTID0gMjAKICAgIAogICAgIyBTdGF0dXMgbWVzc2FnZXMKICAgIE1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUiA9ICJU4bqhbSBk4burbmcgKFNldmVyIHnDqnUgY+G6p3UpIgogICAgTVNHX0RFVklDRV9OT19BQ0NPVU5UUyA9ICJU4bqhbSBuZ2jhu4kgKEtow7RuZyBjw7MgdMOgaSBraG/huqNuKSIKICAgIE1TR19XQUlUSU5HX1BST1hZID0gIsSQYW5nIGNo4budIHByb3h5IgogICAgTVNHX1dPUktJTkdfU0VTU0lPTiA9ICLEkGFuZyB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiCiAgICBNU0dfU0VTU0lPTl9DT09MRE9XTiA9ICJOZ2jhu4kgbmfGoWkgZ2nhu69hIGPDoWMgcGhpw6puIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX1NFU1NJT05fTElNSVQgPSAixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIKICAgIFJFQVNPTl9GT0xMT1dfREFJTFlfTElNSVQgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xvdyB0cm9uZyBwaGnDqm4iCiAgICBSRUFTT05fRk9MTE9XX1NFU1NJT05fTElNSVQgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xsb3cgdHJvbmcgcGhpw6puIgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLmpvYl9oYW5kbGVycyA9IHt9CiAgICAgICAgCiAgICAgICAgIyBGbGFnIMSRaeG7gXUga2hp4buDbgogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgVGjDtG5nIHRpbiB24buBIGPDoWMgYXBwIMSRxrDhu6NjIGvDrWNoIGhv4bqhdCAtIGzhuqV5IHThu6sgZGF0YWJhc2UgaG/hurdjIGNvbmZpZwogICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBMb2NrIMSR4buDIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpCiAgICAgICAgc2VsZi5fbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICAKICAgICAgICAjIERpY3Rpb25hcnkgxJHhu4MgbMawdSBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBqb2IgZm9sbG93IHRy4bqjIHbhu4Egc3RhdHVzIDQgKHBlbmRpbmcpCiAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMgPSB7fQogICAgICAgIAogICAgICAgICMgVHLhuqFuZyB0aMOhaSBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfaWQgPSBOb25lCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBOb25lCiAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgIHNlbGYuY3VycmVudF9wcm94eV90YWJsZSA9IE5vbmUgICMgVGFibGUgbmFtZSDEkcaw4bujYyBj4bqlcCB04burIHByb3h5IHNlcnZlcgogICAgICAgIHNlbGYucHJveHlfbGFzdF91cGRhdGUgPSAwICAjIFRo4budaSBnaWFuIHVwZGF0ZSBjdeG7kWkgY8O5bmcKICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIHRo4bqldCBi4bqhaSBraGkgc2V0dXAgcHJveHkKICAgICAgICBzZWxmLnByb3h5X3NldHVwX2ZhaWxfY291bnQgPSAwCiAgICAgICAgCiAgICAgICAgIyBYw7NhIHByb3h5IHRhYmxlIG5hbWUgY8WpIGto4buPaSBkZXZpY2UgY29uZmlnIGtoaSBraOG7n2kgdOG6oW8KICAgICAgICBzZWxmLmRiLnNldF9kZXZpY2VfY29uZmlnKCJwcm94eV90YWJsZV9uYW1lIiwgTm9uZSkKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMga2hpIGZvcmNlX3N0b3AgxJHGsOG7o2MgxJHhurd0IHRow6BuaCBUcnVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGNoZWNrX2ludGVydmFsID0gSm9iU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMICAjIEtp4buDbSB0cmEgbeG7l2kgMC41IGdpw6J5CiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyB5w6p1IGPhuqd1IGThu6tuZwogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmfhu6cgbeG7mXQga2hv4bqjbmcgbmfhuq9uCiAgICAgICAgICAgIHNsZWVwX3RpbWUgPSBtaW4oY2hlY2tfaW50ZXJ2YWwsIHNlY29uZHMgLSAodGltZS50aW1lKCkgLSBzdGFydF90aW1lKSkKICAgICAgICAgICAgaWYgc2xlZXBfdGltZSA+IDA6CiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKHNsZWVwX3RpbWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBpbml0aWFsaXplKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSB04bqhbyB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICAgICAgIyAxLiBLaeG7g20gdHJhIEhlbHBlclNlcnZpY2UKICAgICAgICBoZWxwZXJfc3VjY2VzcywgaGVscGVyX2RhdGEgPSB1dGlscy5jaGVja19oZWxwZXJfc2VydmljZShzZWxmLmhlbHBlcikKICAgICAgICBpZiBub3QgaGVscGVyX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGvhur90IG7hu5FpIMSR4bq/biBIZWxwZXJTZXJ2aWNlLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBMxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIG7hur91IGPDswogICAgICAgIGlmIGhlbHBlcl9kYXRhIGFuZCAiZGF0YSIgaW4gaGVscGVyX2RhdGE6CiAgICAgICAgICAgIHNlbGYuZGIuc2F2ZV9kZXZpY2VfaW5mbyhoZWxwZXJfZGF0YSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4s6IHtoZWxwZXJfZGF0YVsnZGF0YSddLmdldCgnZGV2aWNlX21vZGVsJywgJ1Vua25vd24nKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgIyAzLiBMxrB1IGPDoWMgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIG7hur91IGNoxrBhIGPDswogICAgICAgIHNlbGYuX3NhdmVfZGVmYXVsdF9jb25maWdzKCkKICAgICAgICAgICAgCiAgICAgICAgIyA0LiBLaeG7g20gdHJhIHbDoCBs4bqleSBHb0xpa2UgaGVhZGVycyBu4bq/dSBj4bqnbgogICAgICAgIGdvbGlrZV9zdWNjZXNzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KCkKICAgICAgICBpZiBub3QgZ29saWtlX3N1Y2Nlc3M6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGzhuqV5IEdvTGlrZSBoZWFkZXJzLiBWdWkgbMOybmcga2nhu4NtIHRyYSBs4bqhaS4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIDUuIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5faW5pdF9qb2JfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgNi4gS2jhu59pIHThuqFvIG5nw6B5IGN14buRaSBjw7luZyDEkcOjIHJlc2V0IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgICMgTuG6v3UgaGnhu4duIHThuqFpIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5LCDEkcOhbmggZOG6pXUgxJHDoyByZXNldAogICAgICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE7hur91IGNoxrBhIMSR4bq/biBnaeG7nSByZXNldCwgxJHDoW5oIGThuqV1IGzDoCDEkcOjIHJlc2V0IG5nw6B5IGjDtG0gcXVhCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheSAtIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIGxhc3RfcmVzZXRfZGF0ZS5pc29mb3JtYXQoKSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gbmfDoHkgcmVzZXQ6IHtsYXN0X3Jlc2V0X2RhdGV9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgIAogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBKb2JTZXJ2aWNlIHRow6BuaCBjw7RuZy4iKQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24ga2nhu4NtIHRyYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaSwgRmFsc2UgbuG6v3Uga2jDtG5nIGPhuqduCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB04burIGRhdGFiYXNlCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIHN5bmNfc3RhdHVzID0gc2VsZi5kYi5nZXQoc3luY19zdGF0dXNfa2V5LCBGYWxzZSkgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG7k25nIGLhu5kgdGjDrCBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWkKICAgICAgICByZXR1cm4gbm90IHN5bmNfc3RhdHVzCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIHN0YXR1czogYm9vbCA9IFRydWUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIHN0YXR1czogVHJ1ZSBu4bq/dSDEkcOjIMSR4buTbmcgYuG7mSwgRmFsc2UgbuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgIiIiCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgc2VsZi5kYi5zZXQoc3luY19zdGF0dXNfa2V5LCBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfToge3N0YXR1c30iKQogICAgICAgIAogICAgZGVmIF9zeW5jX2FjY291bnRzX2Zvcl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8gbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gxJHhu5NuZyBi4buZCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CgogICAgICAgICAgICAjIDEuIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gTWFwIHTDoGkga2hv4bqjbiBHb0xpa2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBnb2xpa2VfYWNjb3VudHMgPSBoYW5kbGVyLmdldF9nb2xpa2VfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IHtsZW4oZ29saWtlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgw4FuaCB44bqhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgbWFwcGVkX2FjY291bnRzID0gaGFuZGxlci5tYXBfZ29saWtlX2FjY291bnRzKGdvbGlrZV9hY2NvdW50cywgZGV2aWNlX2FjY291bnRzKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mgw6FuaCB44bqhIHtsZW4obWFwcGVkX2FjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0gduG7m2kgR29MaWtlIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBHb0xpa2UgbsOgbyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSwgVHJ1ZSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBGYWxzZSkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3NhdmVfZGVmYXVsdF9jb25maWdzKHNlbGYpOgogICAgICAgICIiIkzGsHUgY8OhYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgbuG6v3UgY2jGsGEgY8OzIiIiCiAgICAgICAgZGVmYXVsdF9jb25maWdzID0gewogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHRo4budaSBnaWFuIGzDoG0gam9iCiAgICAgICAgICAgICJqb2JfaG91ciI6IGNvbmZpZy5KT0JfSE9VUiwKICAgICAgICAgICAgImpvYl9jb29sZG93bl9taW51dGVzIjogY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUywKICAgICAgICAgICAgImpvYl9jaGVja19pbnRlcnZhbCI6IGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwsCiAgICAgICAgICAgICJjb29sZG93bl9nZXRfam9iX2dvbGlrZSI6IDMwLCAgIyBUaOG7nWkgZ2lhbiBjaOG7nSAocGjDunQpIGtoaSBraMO0bmcgdMOsbSB0aOG6pXkgam9iIEdvTGlrZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBsacOqbiBxdWFuIMSR4bq/biBz4buRIGzGsOG7o25nIGpvYgogICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZLAogICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaGnhur90IGzhuq1wIGNobyBwaMOpcCBjaMSDbSBzw7NjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAiY2FyZV9pbl93b3JraW5nX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBnacOhIHThu5FpIHRoaeG7g3UgY2hvIGpvYiBmb2xsb3cKICAgICAgICAgICAgIm1pbl9mb2xsb3dfcHJpY2UiOiAyMCwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggcHJveHkKICAgICAgICAgICAgInVzZV9wcm94eSI6IEZhbHNlLCAgIyBDw7Mgc+G7rSBk4bulbmcgcHJveHkga2jDtG5nCiAgICAgICAgICAgICJwcm94eV9zZXJ2ZXIiOiAiaHR0cDovLzEwLjAuMC41OjkwMzIiLCAgIyBTZXJ2ZXIgcHJveHkgbeG6t2MgxJHhu4tuaAogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZ3MuaXRlbXMoKToKICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBpZiBzZWxmLmRiLmdldChrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldChrZXksIHZhbHVlKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoyBsxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtrZXl9PXt2YWx1ZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ+G6pXUgaMOsbmgge2tleX0gxJHDoyB04buTbiB04bqhaToge3NlbGYuZGIuZ2V0KGtleSl9IikKICAgICAgICAKICAgIGRlZiBfaW5pdF9qb2JfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIiIiIKICAgICAgICAjIGluaXQgdGjDrCBz4bq9IGluaXQgaGFuZGxlcnMgY2hvIHThuqV0IGPhuqMgY8OhYyBhcHAsIGzDoG0gYXBwIG7DoG8gdGjDrCBz4bq9IHRoZW8gY+G6pXUgaMOsbmggbOG6pXkgdOG7qyBkYXRhYmFzZQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBjb25maWcuRU5BQkxFRF9BUFBTOgogICAgICAgICAgICBpZiBhcHBfbmFtZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFRpa3Rva0pvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gImluc3RhZ3JhbSI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBJbnN0YWdyYW1Kb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGto4bufaSB04bqhbyB7bGVuKHNlbGYuam9iX2hhbmRsZXJzKX0gam9iIGhhbmRsZXI6IHsnLCAnLmpvaW4oc2VsZi5qb2JfaGFuZGxlcnMua2V5cygpKX0iKQogICAgICAgIAogICAgZGVmIF9yZXNldF9kYWlseV9jb3VudGVycyhzZWxmKToKICAgICAgICAiIiJSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSB2w6BvIGdp4budIMSRxrDhu6NjIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICAKICAgICAgICAjIEzhuqV5IGdp4budIHJlc2V0IHThu6sgY+G6pXUgaMOsbmggaG/hurdjIHThu6sgZGF0YWJhc2UgbuG6v3UgY8OzCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgCiAgICAgICAgIyBUw61uaCB0aOG7nWkgxJFp4buDbSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heQogICAgICAgIHJlc2V0X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5jb21iaW5lKHRvZGF5LCBkYXRldGltZS50aW1lKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wKSkKICAgICAgICAKICAgICAgICAjIEzhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZyB04burIGRhdGFiYXNlCiAgICAgICAgbGFzdF9yZXNldF9kYXRlX3N0ciA9IHNlbGYuZGIuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICBpZiBsYXN0X3Jlc2V0X2RhdGVfc3RyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBkYXRldGltZS5kYXRlLmZyb21pc29mb3JtYXQobGFzdF9yZXNldF9kYXRlX3N0cikKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLEkOG7i25oIGThuqFuZyBuZ8OgeSByZXNldCBraMO0bmcgaOG7o3AgbOG7hzoge2xhc3RfcmVzZXRfZGF0ZV9zdHJ9IikKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5IGNoxrBhIHbDoCBjaMawYSByZXNldCB0cm9uZyBuZ8OgeSBow7RtIG5heQogICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lIGFuZCAobGFzdF9yZXNldF9kYXRlIGlzIE5vbmUgb3IgbGFzdF9yZXNldF9kYXRlIDwgdG9kYXkpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gcmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgKGdp4budIHJlc2V0OiB7am9iX2hvdXJ9OjAwKSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgYuG7mSDEkeG6v20gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHPhu5Egam9iIGjDtG0gbmF5IHbDoCBz4buRIGpvYiB0cm9uZyBwaGnDqm4KICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF92aWV3X3N0b3JpZXMiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB2w6wgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSwKICAgICAgICAgICAgICAgICAgICAjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIHRow6BuaCBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgic3RhdHVzIikgPT0gImluYWN0aXZlIiBhbmQgYWNjb3VudC5nZXQoImluYWN0aXZlX3JlYXNvbiIpID09ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgYWN0aXZlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBN4bufIGtow7NhIGZvbGxvdyBu4bq/dSBi4buLIGtow7NhIGRvIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIG5nw6B5CiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImRpc2FibGVfZm9sbG93IiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19kaXNhYmxlX3VudGlsIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBt4bufIGtow7NhIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHNhdSBraGkgcmVzZXQiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6BvIHtub3cuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG5nw6B5IMSRw6MgcmVzZXQgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkuaXNvZm9ybWF0KCkpCiAgICAgICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBjaOG6oXkgam9iIGNobyB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgY2jhuqF5IGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMi4gS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBj4bqnbiB0aGnhur90CiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMy4gxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5CiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4KICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIGpvYiB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0ixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuIGPhu6dhIHTDoGkga2hv4bqjbiIiIgogICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIGLhu4sgZGlzYWJsZWQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJkaXNhYmxlZCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyBpbmFjdGl2ZSwga2nhu4NtIHRyYSB0aOG7nWkgZ2lhbiBjb29sZG93bgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJY4butIGzDvSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiIiIKICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjb29sZG93biwgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSB0aW1lLnRpbWUoKToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsic3RhdHVzIjogImFjdGl2ZSIsICJsYXN0X2NhcmVfdGltZSI6IDB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgaW5hY3RpdmVfZm9sbG93X3JlYXNvbiBjaOG7qWEgInVuZm9sbG93IiB0aMOsIG3hu58ga2jDs2EgZm9sbG93CiAgICAgICAgICAgIGluYWN0aXZlX2ZvbGxvd19yZWFzb24gPSBhY2NvdW50LmdldCgiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiIsICIiKQogICAgICAgICAgICBpZiAidW5mb2xsb3ciIG5vdCBpbiBpbmFjdGl2ZV9mb2xsb3dfcmVhc29uLmxvd2VyKCk6CiAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiAiIgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBDaMawYSBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBjb29sZG93bl9yZW1haW4gPSBpbnQoKGpvYl9kaXNhYmxlX3VudGlsIC0gdGltZS50aW1lKCkpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50gKGPDsm4ge2Nvb2xkb3duX3JlbWFpbn0gcGjDunQpIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYQogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiBj4bunYSB0w6BpIGtob+G6o24gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcCB24bubaSBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgaWYgYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0gPSBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIGpvYl9tYXhfZGF5CiAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImpvYl9tYXhfZGF5Il0gPSBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgIGlmIHVwZGF0ZV9kYXRhOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOzbmcgYXBwIHTGsMahbmcg4bupbmcgduG7m2kgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBjb25maWcuQVBQX1BBQ0tBR0VTOgogICAgICAgICAgICBzZWxmLmhlbHBlci5jbG9zZV9hcHAoY29uZmlnLkFQUF9QQUNLQUdFU1thcHBfbmFtZV0pCiAgICAgICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgcmV0dXJuIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheQogICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICByZXR1cm4gam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2pvYl9zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgc3VjY2VzczogYm9vbCA9IFRydWUsIGpvYl90eXBlOiBzdHIgPSBOb25lKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc3VjY2VzczogVHJ1ZSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgam9iX3R5cGU6IExv4bqhaSBqb2IgKGZvbGxvdywgbGlrZSwgZXRjLikKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBqb2IgY8ahIGLhuqNuCiAgICAgICAgc2VsZi5fdXBkYXRlX2Jhc2ljX2pvYl9zdGF0cyhhY2NvdW50LCBzdWNjZXNzKQogICAgICAgIAogICAgICAgICMgUmVzZXQgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIG7hur91IGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgCiAgICAgICAgIyDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcAogICAgICAgIGFjY291bnQgPSBzZWxmLl9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB44butIGzDvSBnaeG7m2kgaOG6oW4gcGhpw6puCiAgICAgICAgc2VsZi5fY2hlY2tfc2Vzc2lvbl9saW1pdF9hZnRlcl9qb2IoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeQogICAgICAgIHNlbGYuX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihhY2NvdW50KQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gdGjhu5FuZyBrw6ogcmnDqm5nIGNobyBqb2IgZm9sbG93CiAgICAgICAgaWYgc3VjY2VzcyBhbmQgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9mb2xsb3dfc3RhdHMoYWNjb3VudCkKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wpOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IgY8ahIGLhuqNuIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIAogICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICJqb2JfdG9kYXkiOiBqb2JfdG9kYXkgKyAxLAogICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiBqb2JzX2RvbmVfaW5fc2Vzc2lvbiArIDEsCiAgICAgICAgICAgICJ0b3RhbF9qb2JzIjogYWNjb3VudC5nZXQoInRvdGFsX2pvYnMiLCAwKSArIDEsCiAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgaWYgbm90IHN1Y2Nlc3M6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJmYWlsZWRfam9icyJdID0gYWNjb3VudC5nZXQoImZhaWxlZF9qb2JzIiwgMCkgKyAxCiAgICAgICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpICAjIEPhuq1wIG5o4bqtdCBsb2NhbCBkYXRhCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX3Nlc3Npb25fbGltaXRfYWZ0ZXJfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiJLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBwaGnDqm4gc2F1IGtoaSBsw6BtIGpvYiIiIgogICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICBpZiBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGzDoG0gxJHhu6cge21heF9qb2JzX3Blcl9zZXNzaW9ufSBqb2IgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249IsSQw6MgaG/DoG4gdGjDoG5oIHPhu5Egam9iIHThu5FpIMSRYSB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgCiAgICBkZWYgX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkgc2F1IGtoaSBsw6BtIGpvYiIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5OgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgbmfDoHkgKHtqb2JfdG9kYXl9L3tqb2JfbWF4X2RheX0pIikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfZm9sbG93X3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogcmnDqm5nIGNobyBmb2xsb3cgam9iIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKSArIDEKICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApICsgMQogICAgICAgIG1heF9mb2xsb3dfZGF5ID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfZGF5IiwgMjApCiAgICAgICAgbWF4X2ZvbGxvd19zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfc2Vzc2lvbiIsIDUpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgc+G7kSBsaeG7h3UgZm9sbG93CiAgICAgICAgdXBkYXRlX2ZvbGxvdyA9IHsKICAgICAgICAgICAgImZvbGxvd190b2RheSI6IGZvbGxvd190b2RheSwKICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogZm9sbG93X2luX3Nlc3Npb24sCiAgICAgICAgICAgICJsYXN0X2ZvbGxvd190aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0KICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9mb2xsb3cpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgbmfDoHkKICAgICAgICBpZiBmb2xsb3dfdG9kYXkgPj0gbWF4X2ZvbGxvd19kYXk6CiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfZm9sbG93X3VudGlsX25leHRfcmVzZXQoYWNjb3VudFsiaWQiXSwgIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgZm9sb3cgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIG5nw6B5ICh7Zm9sbG93X3RvZGF5fS97bWF4X2ZvbGxvd19kYXl9KSIpCiAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puCiAgICAgICAgZWxpZiBmb2xsb3dfaW5fc2Vzc2lvbiA+PSBtYXhfZm9sbG93X3Nlc3Npb246CiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfZm9sbG93KGFjY291bnRbImlkIl0sIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBmb2xsb3cgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbiAoe2ZvbGxvd19pbl9zZXNzaW9ufS97bWF4X2ZvbGxvd19zZXNzaW9ufSkiKQogICAgICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UgdHJvbmcgdGhyZWFkIHJpw6puZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQ6IFRocmVhZCDEkWFuZyBjaOG6oXkgSm9iU2VydmljZSBob+G6t2MgTm9uZSBu4bq/dSBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6t3QgdHLhuqFuZyB0aMOhaSBydW5uaW5nCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gdGhyZWFkCiAgICAgICAgICAgIHRocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYucnVuKQogICAgICAgICAgICB0aHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgICB0aHJlYWQuc3RhcnQoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHRocmVhZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgIGRlZiByZXNldF9pbmFjdGl2ZV9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGluYWN0aXZlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImluYWN0aXZlIikgb3IgW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gaW5hY3RpdmVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7InN0YXR1cyI6ICJhY3RpdmUiLCAiaXNfc3luYyI6IEZhbHNlfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nX21pbnV0ZXMgPSBpbnQoKGpvYl9kaXNhYmxlX3VudGlsIC0gY3VycmVudF90aW1lKSAvIDYwKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gY8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0IOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGtow7NhIEZPTExPVwogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkgb3IgW10KICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIpOgogICAgICAgICAgICAgICAgICAgICAgICB1bnRpbF90cyA9IGFjY291bnQuZ2V0KCJmb2xsb3dfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVudGlsX3RzIDw9IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgeyJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLCAiZm9sbG93X2Rpc2FibGVfdW50aWwiOiAwLCAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiLCAiaXNfc3luYyI6IEZhbHNlfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBt4bufIGtow7NhIEZPTExPVyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZyA9IGludCgodW50aWxfdHMgLSBjdXJyZW50X3RpbWUpIC8gNjApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gY8OybiB7cmVtYWluaW5nfSBwaMO6dCBraMOzYSBGT0xMT1ciKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyB0w6BpIGtob+G6o24gaW5hY3RpdmUiKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTpzdHIgKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgY2jhuqF5IGpvYiBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgaWYoc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBDaOG6oXkgSm9iU2VydmljZSB0cm9uZyBt4buZdCB2w7JuZyBs4bq3cCB24bubaSBsb2dpYyBsw6BtIHZp4buHYyB0aGVvIHBoacOqbgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmlzX2luaXRpYWxpemVkOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5pbml0aWFsaXplKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4gS2jDtG5nIHRo4buDIGNo4bqheS4iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBjaOG6oXkgSm9iU2VydmljZSB24bubaSBsb2dpYyBsw6BtIHZp4buHYyB0aGVvIHBoacOqbi4uLiIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGRldmljZV9pZAogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQgaGnhu4duIHThuqFpLCBKb2JTZXJ2aWNlIGtow7RuZyB0aOG7gyBjaOG6oXkiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgd2hpbGUgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAjIFJlc2V0IGJp4bq/biBmb3JjZV9zdG9wIG7hur91IGPDswogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyLCB04bqhbSBk4burbmcgeOG7rSBsw70gam9iIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOaOG6oyBwcm94eSBuZ2F5IGtoaSBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBoYXNhdHRyKHNlbGYsICdwcm94eV9yZWdpc3RlcmVkJykgYW5kIHNlbGYucHJveHlfcmVnaXN0ZXJlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkgZG8gYuG7iyB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3VucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSKQogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKGpvYl9jaGVja19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IG7hur91IGPhuqduCiAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgc2VsZi5yZXNldF9pbmFjdGl2ZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kgZ2nhu69hIGPDoWMgcGhpw6puIGtow7RuZwogICAgICAgICAgICAgICAgaWYgc2VsZi5faXNfaW5fc2Vzc2lvbl9jb29sZG93bigpOgogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBpbnQodGltZS50aW1lKCkpKSAvIDYwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYie0pvYlNlcnZpY2VDb25zdGFudHMuTVNHX1NFU1NJT05fQ09PTERPV059IChjw7JuIHtyZW1haW5pbmdfbWludXRlc30gcGjDunQpIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDYwKTogICMgS2nhu4NtIHRyYSBt4buXaSBwaMO6dAogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB0csaw4bubYyB0acOqbgogICAgICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzIGFuZCBzZWxmLl9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50c19mb3JfYXBwKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcgKHNhdSBraGkgxJHDoyDEkeG7k25nIGLhu5kpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5faGFzX2FjY291bnRzX3JlYWR5X2Zvcl93b3JrKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBu4bq/dSDEkWFuZyBz4butIGThu6VuZwogICAgICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3JlZ2lzdGVyZWQnKSBhbmQgc2VsZi5wcm94eV9yZWdpc3RlcmVkOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2jhu4kgbOG6pXkgcHJveHkga2hpIMSRw6MgY2jhuq9jIGNo4bqvbiBjw7MgdMOgaSBraG/huqNuIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoKToKICAgICAgICAgICAgICAgICAgICAjIEPhuqduIHByb3h5IG5oxrBuZyBjaMawYSBjw7MsIGNo4budIDEwIGdpw6J5IHLhu5NpIGtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19XQUlUSU5HX1BST1hZKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQuG6r3QgxJHhuqd1IHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5fd29ya19zZXNzaW9uKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IHbDoCBi4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVsZWFzZV9wcm94eV9hZnRlcl9zZXNzaW9uKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXJ0X3Nlc3Npb25fY29vbGRvd24oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCIpCiAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJKb2JTZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgICAgICAgICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgSm9iU2VydmljZSIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgZGVmIGZvcmNlX3N0b3BfYWxsKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZyIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiLEkMOzbmcgZOG7i2NoIHbhu6UsIGThu6tuZyB04bqldCBj4bqjIHdvcmtlciB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGThu6tuZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdp4bqjaSBwaMOzbmcgcHJveHkgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV90YWJsZToKICAgICAgICAgICAgICAgIHNlbGYuX3JlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSDEkeG7gyB0csOhbmggbOG7l2kgdGhyZWFkCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2RiJykgYW5kIHNlbGYuZGI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBzaHV0ZG93biBKb2JTZXJ2aWNlIikKICAgIAogICAgZGVmIF9wcm94eV9hcGlfY2FsbChzZWxmLCBlbmRwb2ludDogc3RyLCBkYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEfhu41pIEFQSSBwcm94eSBzZXJ2ZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBlbmRwb2ludDogRW5kcG9pbnQgQVBJIChyZWdpc3RlciwgdXBkYXRlLCB1bnJlZ2lzdGVyLCByZXNldC1pcCkKICAgICAgICAgICAgZGF0YTogROG7ryBsaeG7h3UgZ+G7rWkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCByZXNwb25zZSBob+G6t2MgTm9uZSBu4bq/dSBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHJlcXVlc3RzCiAgICAgICAgICAgIAogICAgICAgICAgICBwcm94eV9zZXJ2ZXIgPSBzZWxmLmRiLmdldCgicHJveHlfc2VydmVyIiwgImh0dHA6Ly8xMC4wLjAuNTo5MDMyIikKICAgICAgICAgICAgdXJsID0gZiJ7cHJveHlfc2VydmVyfS97ZW5kcG9pbnR9IgogICAgICAgICAgICAKICAgICAgICAgICAgcmVzcG9uc2UgPSByZXF1ZXN0cy5wb3N0KHVybCwganNvbj1kYXRhLCB0aW1lb3V0PTEwKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2Uuc3RhdHVzX2NvZGUgPT0gMjAwOgogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiUHJveHkgQVBJIHtlbmRwb2ludH0gZmFpbGVkIHdpdGggc3RhdHVzIHtyZXNwb25zZS5zdGF0dXNfY29kZX06IHtyZXNwb25zZS50ZXh0fSIpCiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7jWkgUHJveHkgQVBJIHtlbmRwb2ludH06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBfcmVnaXN0ZXJfcHJveHkoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkMSDbmcga8O9IHbhu5tpIHByb3h5IHNlcnZlciDEkeG7gyDEkcaw4bujYyBj4bqlcCBwaMOhdCB0YWJsZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHGsOG7o2MgY+G6pXAgdGFibGUgaG/hurdjIMSRw6MgY8OzIHRhYmxlLCBGYWxzZSBu4bq/dSB2w6BvIHF1ZXVlIGhv4bq3YyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBsb2NhbCBJUCB04burIGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGxvY2FsX2lwID0gc2VsZi5oZWxwZXIuZ2V0X2xvY2FsX2lwKCkKICAgICAgICAgICAgaWYgbm90IGxvY2FsX2lwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgbOG6pXkgbG9jYWwgSVAsIGLhu48gcXVhIMSRxINuZyBrw70gcHJveHkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBkYXRhID0geyJsb2NhbF9pcCI6IGxvY2FsX2lwfQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuX3Byb3h5X2FwaV9jYWxsKCJyZWdpc3RlciIsIGRhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgcmVzcG9uc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzdGF0dXMgPSByZXNwb25zZS5nZXQoInN0YXR1cyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdGF0dXMgPT0gInN1Y2Nlc3MiOgogICAgICAgICAgICAgICAgIyDEkMaw4bujYyBj4bqlcCB0YWJsZSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHRhYmxlX25hbWUgPSByZXNwb25zZS5nZXQoImRhdGEiLCB7fSkuZ2V0KCJ0YWJsZV9uYW1lIikKICAgICAgICAgICAgICAgIGFjdGlvbiA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIHt9KS5nZXQoImFjdGlvbiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV90YWJsZSA9IHRhYmxlX25hbWUKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9uYW1lID0gZiJ7dGFibGVfbmFtZX0iCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMawdSBwcm94eSB0YWJsZSBuYW1lIHbDoG8gZGV2aWNlIGNvbmZpZyDEkeG7gyBn4butaSBsw6puIHNlcnZlcgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfZGV2aWNlX2NvbmZpZygicHJveHlfdGFibGVfbmFtZSIsIHRhYmxlX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUHJveHkgxJHDoyDEkcaw4bujYyBj4bqlcCB0YWJsZToge3RhYmxlX25hbWV9IChhY3Rpb246IHthY3Rpb259KSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR+G7jWkgcmVzZXQtaXAgxJHhu4MgxJHhu5VpIElQIG3hu5tpCiAgICAgICAgICAgICAgICBpZiB0YWJsZV9uYW1lOgogICAgICAgICAgICAgICAgICAgIHBwb2VfbmFtZSA9IHRhYmxlX25hbWUucmVwbGFjZSgidG9fIiwgIiIpICAjIENodXnhu4NuICJ0b19wcHBvZTIiIHRow6BuaCAicHBwb2UyIgogICAgICAgICAgICAgICAgICAgIHJlc2V0X2RhdGEgPSB7InBwb2VfbmFtZSI6IGYie3Bwb2VfbmFtZX0ifSAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmVzZXRfcmVzcG9uc2UgPSBzZWxmLl9wcm94eV9hcGlfY2FsbCgicmVzZXQtaXAiLCByZXNldF9kYXRhKQogICAgICAgICAgICAgICAgICAgIGlmIHJlc2V0X3Jlc3BvbnNlIGFuZCByZXNldF9yZXNwb25zZS5nZXQoInN0YXR1cyIpID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IElQIGNobyB7cmVzZXRfZGF0YVsncHBvZV9uYW1lJ119IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyByZXNldCBJUCBjaG8ge3Jlc2V0X2RhdGFbJ3Bwb2VfbmFtZSddfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxpZiBzdGF0dXMgPT0gInF1ZXVlZCI6CiAgICAgICAgICAgICAgICAjIFbDoG8gcXVldWUgY2jhu50KICAgICAgICAgICAgICAgIHF1ZXVlX3Bvc2l0aW9uID0gcmVzcG9uc2UuZ2V0KCJkYXRhIiwge30pLmdldCgicXVldWVfcG9zaXRpb24iLCAwKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm94eSBzZXJ2ZXIgZnVsbCwgdsOgbyBow6BuZyDEkeG7o2kgduG7iyB0csOtIHtxdWV1ZV9wb3NpdGlvbn0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIlByb3h5IHJlZ2lzdGVyIHRo4bqldCBi4bqhaToge3Jlc3BvbnNlLmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgxJHEg25nIGvDvSBwcm94eSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3VwZGF0ZV9wcm94eShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aW1lc3RhbXAgc+G7rSBk4bulbmcgcHJveHkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHVwZGF0ZSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgbG9jYWwgSVAgdOG7qyBoZWxwZXIgc2VydmljZQogICAgICAgICAgICBsb2NhbF9pcCA9IHNlbGYuaGVscGVyLmdldF9sb2NhbF9pcCgpCiAgICAgICAgICAgIGlmIG5vdCBsb2NhbF9pcDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbOG6pXkgbG9jYWwgSVAsIGLhu48gcXVhIHVwZGF0ZSBwcm94eSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGRhdGEgPSB7ImxvY2FsX2lwIjogbG9jYWxfaXB9CiAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5fcHJveHlfYXBpX2NhbGwoInVwZGF0ZSIsIGRhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdGF0dXMiKSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X2xhc3RfdXBkYXRlID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgICMgTG9nIHRow7RuZyB0aW4gdOG7qyByZXNwb25zZSBu4bq/dSBjw7MKICAgICAgICAgICAgICAgIGRhdGEgPSByZXNwb25zZS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgICAgIHRhYmxlX25hbWUgPSBkYXRhLmdldCgidGFibGVfbmFtZSIsICJ1bmtub3duIikKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlByb3h5IHVwZGF0ZSB0aMOgbmggY8O0bmcgY2hvIHRhYmxlOiB7dGFibGVfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUHJveHkgdXBkYXRlIHRo4bqldCBi4bqhaToge3Jlc3BvbnNlLmdldCgnbWVzc2FnZScpIGlmIHJlc3BvbnNlIGVsc2UgJ05vIHJlc3BvbnNlJ30iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHVwZGF0ZSBwcm94eToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfdW5yZWdpc3Rlcl9wcm94eShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEjhu6d5IMSRxINuZyBrw70gdsOgIGdp4bqjaSBwaMOzbmcgdGFibGUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHVucmVnaXN0ZXIgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGxvY2FsIElQIHThu6sgaGVscGVyIHNlcnZpY2UKICAgICAgICAgICAgbG9jYWxfaXAgPSBzZWxmLmhlbHBlci5nZXRfbG9jYWxfaXAoKQogICAgICAgICAgICBpZiBub3QgbG9jYWxfaXA6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGzhuqV5IGxvY2FsIElQLCBi4buPIHF1YSB1bnJlZ2lzdGVyIHByb3h5IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgZGF0YSA9IHsibG9jYWxfaXAiOiBsb2NhbF9pcH0KICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLl9wcm94eV9hcGlfY2FsbCgidW5yZWdpc3RlciIsIGRhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdGF0dXMiKSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICByZWxlYXNlZF90YWJsZSA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIHt9KS5nZXQoInJlbGVhc2VkX3RhYmxlIikKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB1bnJlZ2lzdGVyIHByb3h5IHbDoCBnaeG6o2kgcGjDs25nIHRhYmxlOiB7cmVsZWFzZWRfdGFibGV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGUgPSBOb25lCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IE5vbmUKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfbGFzdF91cGRhdGUgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgWMOzYSBwcm94eSB0YWJsZSBuYW1lIGto4buPaSBkZXZpY2UgY29uZmlnCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9kZXZpY2VfY29uZmlnKCJwcm94eV90YWJsZV9uYW1lIiwgTm9uZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUHJveHkgdW5yZWdpc3RlciB0aOG6pXQgYuG6oWk6IHtyZXNwb25zZS5nZXQoJ21lc3NhZ2UnKSBpZiByZXNwb25zZSBlbHNlICdObyByZXNwb25zZSd9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB1bnJlZ2lzdGVyIHByb3h5OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jaGVja19wcm94eV9yZXF1aXJlbWVudChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIMSRxINuZyBrw70gcHJveHkgbuG6v3UgY+G6p24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyBwcm94eSBob+G6t2Mga2jDtG5nIGPhuqduIHByb3h5LCBGYWxzZSBu4bq/dSBj4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgxJHGsOG7o2MgY+G6pXAKICAgICAgICAiIiIKICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHVzZV9wcm94eToKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgS2jDtG5nIGPhuqduIHByb3h5CiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBjw7MgdGFibGUgdGjDrCByZXR1cm4gVHJ1ZQogICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV90YWJsZToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgIyBDaMawYSBjw7MgdGFibGUsIHRo4butIMSRxINuZyBrw70KICAgICAgICByZXR1cm4gc2VsZi5fcmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAKICAgIGRlZiBfZ2V0X3Byb3h5X2Rpc3BsYXlfbmFtZShzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdMOqbiBoaeG7g24gdGjhu4sgY2hvIHByb3h5IGhp4buHbiB04bqhaQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVMOqbiBoaeG7g24gdGjhu4sgY+G7p2EgcHJveHkKICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuY3VycmVudF9wcm94eV9uYW1lCiAgICAgICAgZWxpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgIHJldHVybiBmIntzZWxmLmN1cnJlbnRfcHJveHlfdGFibGV9IgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiAiVW5rbm93biIKICAgICAgICAgICAgCiAgICBkZWYgX3NldHVwX3Byb3h5X2Zvcl9zZXNzaW9uKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGhp4bq/dCBs4bqtcCBwcm94eSBjaG8gcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aGnhur90IGzhuq1wIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBO4bq/dSDEkcOjIGPDsyB0YWJsZSBwcm94eSB0aMOsIHNldHVwIHhvbmcgcuG7k2kKICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgIHByb3h5X25hbWUgPSBzZWxmLl9nZXRfcHJveHlfZGlzcGxheV9uYW1lKCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQcm94eSB7cHJveHlfbmFtZX0gxJHDoyBz4bq1biBzw6BuZyBjaG8gcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSBjw7MgdGjDrCDEkcSDbmcga8O9CiAgICAgICAgcmV0dXJuIHNlbGYuX3JlZ2lzdGVyX3Byb3h5KCkKICAgIGRlZiBfcmVsZWFzZV9wcm94eV9hZnRlcl9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIkdp4bqjaSBwaMOzbmcgcHJveHkgc2F1IGtoaSBr4bq/dCB0aMO6YyBwaGnDqm4gbMOgbSB2aeG7h2MiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV90YWJsZToKICAgICAgICAgICAgICAgIHByb3h5X25hbWUgPSBzZWxmLl9nZXRfcHJveHlfZGlzcGxheV9uYW1lKCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgZ2nhuqNpIHBow7NuZyBwcm94eSB7cHJveHlfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu41pIEFQSSB1bnJlZ2lzdGVyCiAgICAgICAgICAgICAgICBpZiBzZWxmLl91bnJlZ2lzdGVyX3Byb3h5KCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGdp4bqjaSBwaMOzbmcgcHJveHkge3Byb3h5X25hbWV9IHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiR2nhuqNpIHBow7NuZyBwcm94eSB7cHJveHlfbmFtZX0gdGjhuqV0IGLhuqFpIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgZ2nhuqNpIHBow7NuZyBwcm94eSIpCiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgZ2nhuqNpIHBow7NuZyBwcm94eSB7c2VsZi5jdXJyZW50X3Byb3h5X25hbWUgb3Igc2VsZi5jdXJyZW50X3Byb3h5X2lkIG9yICd1bmtub3duJ30iKQogICAgICAgICAgICAKICAgIGRlZiBfaGFzX2FjY291bnRzX3JlYWR5X2Zvcl93b3JrKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAiIiIKICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBpZiBzZWxmLmlzX2FjY291bnRfY2FuX3J1bl9qb2IoYXBwX25hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIF93b3JrX3Nlc3Npb24oc2VsZik6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiBt4buZdCBwaGnDqm4gbMOgbSB2aeG7h2MgaG/DoG4gY2jhu4luaCIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAKICAgICAgICAjIMSQw6FuaCBk4bqldSDEkWFuZyB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX1dPUktJTkdfU0VTU0lPTikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSByZWFsLXRpbWUgeGVtIGPDsyB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9zdG9wIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciB0cm9uZyByZWFsLXRpbWUKICAgICAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCBhcHAgZW5hYmxlZCBoaeG7h24gdOG6oWkgKGPDsyB0aOG7gyB0aGF5IMSR4buVaSB04burIHNlcnZlcikKICAgICAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9oYXNfYWNjb3VudHNfcmVhZHlfZm9yX3dvcmsoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MsIGvhur90IHRow7pjIHBoacOqbiIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMw6BtIHZp4buHYyB0deG6p24gdOG7sSB04burbmcgYXBwCiAgICAgICAgICAgICAgICBzZXNzaW9uX2NvbXBsZXRlZCA9IFRydWUKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25fY29tcGxldGVkID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBu4bq/dSBzZXJ2ZXIgecOqdSBj4bqndSAoY8OzIHRo4buDIGPDsyB0w6BpIGtob+G6o24gbeG7m2kgdOG7qyBHb0xpa2UpCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU2VydmVyIHnDqnUgY+G6p3UgxJHhu5NuZyBi4buZIGzhuqFpIHTDoGkga2hv4bqjbiBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudHNfZm9yX2FwcChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBMw6BtIHZp4buHYyB24bubaSBhcHAgbsOgeQogICAgICAgICAgICAgICAgICAgIGFwcF9yZXN1bHQgPSBzZWxmLl93b3JrX3dpdGhfYXBwKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgxJDDs25nIGFwcCBzYXUga2hpIGhvw6BuIHRow6BuaAogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLmNsb3NlX2FwcCgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuq9uIGdp4buvYSBjw6FjIGFwcAogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25fY29tcGxldGVkID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBob8OgbiB0aMOgbmggbeG7mXQgcm91bmQgbMOgbSB2aeG7h2MgduG7m2kgdOG6pXQgY+G6oyBhcHAsIHRob8OhdCBraOG7j2kgcGhpw6puCiAgICAgICAgICAgICAgICBpZiBzZXNzaW9uX2NvbXBsZXRlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBob8OgbiB0aMOgbmggbeG7mXQgcm91bmQgbMOgbSB2aeG7h2MgduG7m2kgdOG6pXQgY+G6oyBhcHAiKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgYuG7iyBnacOhbiDEkW/huqFuLCB0aG/DoXQga2jhu49pIHBoacOqbgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGvhur90IHRow7pjIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgCiAgICBkZWYgX3dvcmtfd2l0aF9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBsw6BtIHZp4buHYwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBnacOhbiDEkW/huqFuCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbMOgbSB2aeG7h2MgduG7m2kge2FwcF9uYW1lfSIpCiAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgICMgTMOgbSB2aeG7h2MgdHXhuqduIHThu7EgduG7m2kgdOG7q25nIHTDoGkga2hv4bqjbiAocmVhbC10aW1lIHJlbG9hZCkKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciBraGkgbMOgbSB2aeG7h2MgduG7m2kge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gbeG7m2kgbmjhuqV0IChjw7MgdGjhu4MgdGhheSDEkeG7lWkgdOG7qyBzZXJ2ZXIpCiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4buNYyBjw6FjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdMOgaSBraG/huqNuIGPDsyBqb2JzX2RvbmVfaW5fc2Vzc2lvbiB0aOG6pXAgbmjhuqV0IMSR4buDIGzDoG0gdmnhu4djCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzLnNvcnQoa2V5PWxhbWJkYSB4OiB4LmdldCgnam9ic19kb25lX2luX3Nlc3Npb24nLCAwKSkKICAgICAgICAgICAgYWNjb3VudCA9IHdvcmthYmxlX2FjY291bnRzWzBdCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBsw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgIHN3aXRjaF9yZXN1bHQgPSBoYW5kbGVyLnN3aXRjaF90b19hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBuw6B5IGPDsyB24bqlbiDEkeG7gSB2w6AgdGjhu60gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0iTOG7l2kgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMw6BtIMSR4bunIHPhu5Egam9iIHRyb25nIHBoacOqbiBjaG8gdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgYWNjb3VudF9yZXN1bHQgPSBzZWxmLl93b3JrX2FjY291bnRfc2Vzc2lvbihhY2NvdW50LCBoYW5kbGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMw6BtIGNoxINtIHPDs2Mgc2F1IGtoaSBo4bq/dCBqb2IKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gY2jEg20gc8OzYyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBjaMSDbSBzw7NjIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGLhu4sgZ2nDoW4gxJFv4bqhbiwgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3Jlc3VsdDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB4ZW0gY8OybiB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgICMgKGPDsyB0aOG7gyBjw7MgdGhheSDEkeG7lWkgdOG7qyBzZXJ2ZXIgdHJvbmcgbMO6YyBsw6BtIHZp4buHYykKICAgICAgICAgICAgdXBkYXRlZF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgcmVtYWluaW5nX3dvcmthYmxlID0gW2FjYyBmb3IgYWNjIGluIHVwZGF0ZWRfYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCByZW1haW5pbmdfd29ya2FibGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgaG/DoG4gdGjDoG5oIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICBkZWYgX3dvcmtfYWNjb3VudF9zZXNzaW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzDoG0gdmnhu4djIHbhu5tpIG3hu5l0IHTDoGkga2hv4bqjbiB0cm9uZyBwaGnDqm4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlcgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBnacOhbiDEkW/huqFuCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGpvYnNfZG9uZSA9IDAKICAgICAgICBjYXJlX2NvdW50ZXIgPSAwCiAgICAgICAgY29uZmlnX3JlbG9hZF9jb3VudGVyID0gMCAgIyDEkOG6v20gxJHhu4MgcmVsb2FkIGPhuqV1IGjDrG5oIMSR4buLbmgga+G7swogICAgICAgIG5vX2pvYl9jb3VudCA9IDAgICMgxJDhur9tIHPhu5EgbOG6p24ga2jDtG5nIGzhuqV5IMSRxrDhu6NjIGpvYiBsacOqbiB0aeG6v3AKICAgICAgICBtYXhfbm9fam9iX2F0dGVtcHRzID0gNSAgIyBT4buRIGzhuqduIHThu5FpIMSRYSB0aOG7rSBs4bqleSBqb2Iga2hpIGtow7RuZyBjw7MKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciBraGkgbMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVXBkYXRlIHByb3h5IHRpbWVzdGFtcCBt4buXaSAyMCBnacOieSBu4bq/dSDEkWFuZyBz4butIGThu6VuZyBwcm94eQogICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlOgogICAgICAgICAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfdGltZSAtIHNlbGYucHJveHlfbGFzdF91cGRhdGUgPj0gMjA6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fdXBkYXRlX3Byb3h5KCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygixJDDoyB1cGRhdGUgcHJveHkgdGltZXN0YW1wIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiVXBkYXRlIHByb3h5IHRpbWVzdGFtcCB0aOG6pXQgYuG6oWkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlbG9hZCBj4bqldSBow6xuaCB0w6BpIGtob+G6o24gdOG7qyBkYXRhYmFzZSBt4buXaSA1IGpvYiDEkeG7gyBwaOG6o24gw6FuaCB0aGF5IMSR4buVaSB04burIHNlcnZlcgogICAgICAgICAgICBjb25maWdfcmVsb2FkX2NvdW50ZXIgKz0gMQogICAgICAgICAgICBpZiBjb25maWdfcmVsb2FkX2NvdW50ZXIgPj0gNToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlbG9hZCBj4bqldSBow6xuaCB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB04burIGRhdGFiYXNlIikKICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICBjb25maWdfcmVsb2FkX2NvdW50ZXIgPSAwCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldCAoYmFvIGfhu5NtIHRo4buRbmcga8OqIGpvYikKICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgY2jhuqF5IGpvYiBraMO0bmcgKGPDsyB0aOG7gyBi4buLIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGtow7RuZyB0aOG7gyBjaOG6oXkgam9iIG7hu69hIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBwaGnDqm4gaGnhu4duIHThuqFpCiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGhvw6BuIHRow6BuaCDEkeG7pyBqb2IgdHJvbmcgcGhpw6puICh7am9ic19kb25lX2luX3Nlc3Npb259L3ttYXhfam9ic19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBM4bqleSBqb2IKICAgICAgICAgICAgICAgIGpvYiA9IGhhbmRsZXIuZmV0Y2hfam9iKGFjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgICAgICAgICAgbm9fam9iX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7Mgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAobOG6p24ge25vX2pvYl9jb3VudH0ve21heF9ub19qb2JfYXR0ZW1wdHN9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2Mgam9iIHF1w6Egbmhp4buBdSBs4bqnbiwgZOG7q25nIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgICAgIGlmIG5vX2pvYl9jb3VudCA+PSBtYXhfbm9fam9iX2F0dGVtcHRzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGtow7RuZyBs4bqleSDEkcaw4bujYyBqb2Igc2F1IHttYXhfbm9fam9iX2F0dGVtcHRzfSBs4bqnbiB0aOG7rSwgZOG7q25nIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChyYW5kb20ucmFuZGludCgxMCwgMjApKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBjb3VudGVyIGtoaSBs4bqleSDEkcaw4bujYyBqb2IKICAgICAgICAgICAgICAgIG5vX2pvYl9jb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlCiAgICAgICAgICAgICAgICBsaW5rID0gam9iLmdldCgnbGluaycsICcnKQogICAgICAgICAgICAgICAgaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycpOgogICAgICAgICAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgICAgICAgICBlbGlmIGxpbmsuc3RhcnRzd2l0aCgnaHR0cHM6Ly93d3cudGlrdG9rLmNvbS8nKToKICAgICAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy50aWt0b2suY29tLycsICcnKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJbe2FjY291bnQuZ2V0KCdhcHAnKX1dW3t1c2VybmFtZX1dW3tqb2IuZ2V0KCd0eXBlJyl9XVt7bGlua31dIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSBqb2IKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gaGFuZGxlci52YWxpZGF0ZV9qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInZhbGlkIiwgVHJ1ZSk6CiAgICAgICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgIyBTa2lwIGpvYgogICAgICAgICAgICAgICAgICAgICAgICBza2lwX21lc3NhZ2UgPSB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiSm9iIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTa2lwIGpvYjoge3NraXBfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc2tpcF9tZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU2tpcCBqb2IgbOG7l2k6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEdpw6NuIHRo4budaSBnaWFuIHNhdSBraGkgc2tpcCBqb2IgxJHhu4MgdHLDoW5oIHNwYW0gbOG6pXkvaOG7p3kgam9iIGxpw6puIHThu6VjCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBfc2xlZXBfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDEwKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBza2lwIGpvYiDEkeG7gyB0csOhbmggc3BhbSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoc2tpcF9zbGVlcF90aW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSm9iIGtow7RuZyBo4bujcCBs4buHOiB7dmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGVfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSBr4bq/dCBxdeG6owogICAgICAgICAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgICAgICAgICBqb2Jfc3VjY2VzcyA9IGpvYl9yZXN1bHRbInN1Y2Nlc3MiXQogICAgICAgICAgICAgICAgam9iX21lc3NhZ2UgPSBqb2JfcmVzdWx0WyJtZXNzYWdlIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZwogICAgICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSA0IGFuZCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAgICAgY250ID0gc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMuZ2V0KGFjY291bnRbImlkIl0sIDApICsgMQogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgICAgICAgICAgaWYgY250ID49IDU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCBmb2xsb3cgcGVuZGluZywga2jDs2EgRk9MTE9XIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3dfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAiTGnDqm4gdGnhur9wIGzhu5dpIGZvbGxvdyBwZW5kaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbGlmIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsOhbyBjw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCBqb2JfcmVzdWx0KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqgogICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2pvYl9zdGF0cyhhY2NvdW50LCBqb2Jfc3VjY2Vzcywgam9iLmdldCgidHlwZSIsICIiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZWxvYWQgYWNjb3VudCBzYXUga2hpIHVwZGF0ZSDEkeG7gyBjw7MgZOG7ryBsaeG7h3UgbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkvhur90IHF14bqjIGpvYiB7am9ic19kb25lX2luX3Nlc3Npb259L3ttYXhfam9ic19wZXJfc2Vzc2lvbn06IHtqb2JfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buJIHTEg25nIGNhcmVfY291bnRlciBraGkgam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgaWYgam9iX3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgam9ic19kb25lICs9IDEKICAgICAgICAgICAgICAgICAgICBjYXJlX2NvdW50ZXIgKz0gMQogICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIENoxINtIHPDs2Mgc2F1IG3hu5dpIDMtNSBqb2IgdGjDoG5oIGPDtG5nIChyYW5kb20pCiAgICAgICAgICAgICAgICAgICAgIyBpZiBjYXJlX2NvdW50ZXIgPj0gcmFuZG9tLnJhbmRpbnQoMywgNSk6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICJwZXJmb3JtX2NhcmUiKSBhbmQgY2FsbGFibGUoaGFuZGxlci5wZXJmb3JtX2NhcmUpOgogICAgICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgbmjhurkgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBjYXJlX2NvdW50ZXIgPSAwCiAgICAgICAgICAgICAgICAgICAgIyAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICMgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBjaMSDbSBzw7NjIG5o4bq5OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgam9iCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS5yYW5kaW50KDIsIDUpKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfc3RhcnRfc2Vzc2lvbl9jb29sZG93bihzZWxmKToKICAgICAgICAiIiJC4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiIiIgogICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmRiLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCA2MCkKICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSBpbnQodGltZS50aW1lKCkpICsgKGNvb2xkb3duX21pbnV0ZXMgKiA2MCkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IGdp4buvYSBjw6FjIHBoacOqbiIpCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJ7Sm9iU2VydmljZUNvbnN0YW50cy5NU0dfU0VTU0lPTl9DT09MRE9XTn0gKHtjb29sZG93bl9taW51dGVzfSBwaMO6dCkiKQogICAgICAgIAogICAgZGVmIF9pc19pbl9zZXNzaW9uX2Nvb2xkb3duKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIG5naOG7iSBnaeG7r2EgY8OhYyBwaGnDqm4ga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kKICAgICAgICAiIiIKICAgICAgICBpZiBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPD0gMDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICBpZiBjdXJyZW50X3RpbWUgPCBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWU6CiAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBjdXJyZW50X3RpbWUpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPDsm4ge3JlbWFpbmluZ19taW51dGVzfSBwaMO6dCBuZ2jhu4kgbmfGoWkiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IDAKICAgICAgICAgICAgcmV0dXJuIEZhbHNl').decode('utf-8'))
