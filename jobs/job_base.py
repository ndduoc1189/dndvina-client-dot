import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwsIENhbGxhYmxlCmZyb20gYWJjIGltcG9ydCBBQkMsIGFic3RyYWN0bWV0aG9kCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmltcG9ydCB1cmxsaWIucGFyc2UKaW1wb3J0IHJhbmRvbQppbXBvcnQgY29uZmlnCiMgVOG6oW8gbG9nZ2VyIGNobyBCYXNlSm9iCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkJhc2VKb2IiKQoKY2xhc3MgQmFzZUpvYihBQkMpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gIiIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gIiIKICAgICAgICAjIEjDoG0gc2xlZXAgbeG6t2MgxJHhu4tuaCBsw6AgdGltZS5zbGVlcAogICAgICAgIHNlbGYuX3NsZWVwX2Z1bmMgPSB0aW1lLnNsZWVwCiAgICAgICAgIyBU4bqhbyBsb2dnZXIgY2hvIGluc3RhbmNlIGPhu6UgdGjhu4MKICAgICAgICBzZWxmLmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoZiJKb2Iue3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgCiAgICAgICAgIyBQcm94eSBzZXJ2aWNlIHPhur0gxJHGsOG7o2Mgc2V0IHNhdSBraGkga2jhu59pIHThuqFvCiAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlID0gTm9uZQogICAgICAgIAogICAgICAgICMgQXBwLXNwZWNpZmljIGNvbmZpZ3VyYXRpb24gY2FjaGUKICAgICAgICBzZWxmLl9hcHBfY29uZmlnX2NhY2hlID0gTm9uZQogICAgICAgIHNlbGYuX2NvbmZpZ19jYWNoZV90aW1lID0gMAogICAgICAgIHNlbGYuX2NvbmZpZ19jYWNoZV90dGwgPSAzMDAgICMgQ2FjaGUgNSBwaMO6dAogICAgICAgIAogICAgICAgICMgRGVmYXVsdCBjb25maWcgY2hvIGFwcCAoY8OzIHRo4buDIG92ZXJyaWRlIHRyb25nIHN1YmNsYXNzKQogICAgICAgIHNlbGYuX2RlZmF1bHRfY29uZmlnID0gewogICAgICAgICAgICAiYWN0aW9uX3dlaWdodHMiOiB7CiAgICAgICAgICAgICAgICAibmV3c2ZlZWQiOiAxNSwgICAgICAjIDE1JSB2deG7kXQgbmV3c2ZlZWQvYuG6o25nIHRpbgogICAgICAgICAgICAgICAgInJlZWxzIjogMjAsICAgICAgICAgIyAyMCUgeGVtIHJlZWxzL3ZpZGVvCiAgICAgICAgICAgICAgICAibm90aWZpY2F0aW9uIjogMTAsICAgIyAxMCUgeGVtIHRow7RuZyBiw6FvCiAgICAgICAgICAgICAgICAicHJvZmlsZSI6IDE1LCAgICAgICAjIDE1JSB4ZW0gcHJvZmlsZQogICAgICAgICAgICAgICAgImpvYiI6IDIwLCAgICAgICAgICAgIyAyMCUgbMOgbSBqb2IKICAgICAgICAgICAgICAgICJleHBsb3JlIjogNSwgICAgICAgICMgNSUga2jDoW0gcGjDoQogICAgICAgICAgICAgICAgInNlYXJjaCI6IDE1ICAgICAgICAgIyAxNSUgdMOsbSBraeG6v20KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm1pbl9hY3Rpb25zX3Blcl9zZXNzaW9uIjogMjAsICAgICAgICAjIFThu5FpIHRoaeG7g3UgYWN0aW9ucyBt4buXaSBzZXNzaW9uCiAgICAgICAgICAgICJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiI6IDUwLCAgICAgICAgIyBU4buRaSDEkWEgYWN0aW9ucyBt4buXaSBzZXNzaW9uCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IDEwLCAgICAgICAgICAgIyBU4buRaSDEkWEgam9icyBt4buXaSBzZXNzaW9uCiAgICAgICAgICAgICJtYXhfY2FyZV9hY3Rpb25zX3Blcl9zZXNzaW9uIjogNSwgICAgIyBU4buRaSDEkWEgY2FyZSBhY3Rpb25zIHRyxrDhu5tjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAibWluX3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyI6IDMwLCAgICMgVGjhu51pIGdpYW4gdOG7kWkgdGhp4buDdSBt4buXaSBzZXNzaW9uIChwaMO6dCkKICAgICAgICAgICAgIm1heF9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMiOiA2MCwgICAjIFRo4budaSBnaWFuIHThu5FpIMSRYSBt4buXaSBzZXNzaW9uIChwaMO6dCkKICAgICAgICB9CiAgICAgICAgCiAgICBkZWYgc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZiwgcHJveHlfc2VydmljZSk6CiAgICAgICAgIiIiCiAgICAgICAgVGhp4bq/dCBs4bqtcCBwcm94eSBzZXJ2aWNlIGNobyBqb2IgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHByb3h5X3NlcnZpY2U6IFByb3h5U2VydmljZSBpbnN0YW5jZQogICAgICAgICIiIgogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IHByb3h5X3NlcnZpY2UKICAgICAgICAKICAgIGRlZiBnZXRfY29uZmlnKHNlbGYsIGtleTogc3RyLCBkZWZhdWx0PU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGPhuqV1IGjDrG5oIGNobyBqb2IgdGhlbyBwcmlvcml0eTogYXBwX2NvbmZpZyDihpIgZ2xvYmFsX2NvbmZpZyDihpIgX2RlZmF1bHRfY29uZmlnIOKGkiBkZWZhdWx0CiAgICAgICAgQ2FjaGUga+G6v3QgcXXhuqMgxJHhu4MgdOG7kWkgxrB1IHBlcmZvcm1hbmNlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAga2V5OiBLaMOzYSBj4bqldSBow6xuaCBj4bqnbiBs4bqleQogICAgICAgICAgICBkZWZhdWx0OiBHacOhIHRy4buLIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIEdpw6EgdHLhu4sgY+G6pXUgaMOsbmggaG/hurdjIGRlZmF1bHQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgY2FjaGUKICAgICAgICAgICAgaWYgKHNlbGYuX2FwcF9jb25maWdfY2FjaGUgaXMgbm90IE5vbmUgYW5kIAogICAgICAgICAgICAgICAgY3VycmVudF90aW1lIC0gc2VsZi5fY29uZmlnX2NhY2hlX3RpbWUgPCBzZWxmLl9jb25maWdfY2FjaGVfdHRsKToKICAgICAgICAgICAgICAgIGlmIGtleSBpbiBzZWxmLl9hcHBfY29uZmlnX2NhY2hlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9hcHBfY29uZmlnX2NhY2hlW2tleV0KICAgICAgICAgICAgICAgIGVsaWYga2V5IGluIHNlbGYuX2RlZmF1bHRfY29uZmlnOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZWZhdWx0X2NvbmZpZ1trZXldCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWZhdWx0CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENhY2hlIGjhur90IGjhuqFuIGhv4bq3YyBjaMawYSBjw7MsIHThuqNpIGzhuqFpIGNvbmZpZwogICAgICAgICAgICBhcHBfY29uZmlnID0gc2VsZi5kYi5nZXRfYXBwX2NvbmZpZyhzZWxmLmFwcF9uYW1lLCBzZWxmLl9kZWZhdWx0X2NvbmZpZykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGNhY2hlCiAgICAgICAgICAgIHNlbGYuX2FwcF9jb25maWdfY2FjaGUgPSBhcHBfY29uZmlnCiAgICAgICAgICAgIHNlbGYuX2NvbmZpZ19jYWNoZV90aW1lID0gY3VycmVudF90aW1lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqjIHbhu4EgZ2nDoSB0cuG7iwogICAgICAgICAgICBpZiBrZXkgaW4gYXBwX2NvbmZpZzoKICAgICAgICAgICAgICAgIHJldHVybiBhcHBfY29uZmlnW2tleV0KICAgICAgICAgICAgZWxpZiBrZXkgaW4gc2VsZi5fZGVmYXVsdF9jb25maWc6CiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fZGVmYXVsdF9jb25maWdba2V5XQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHQKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgbOG6pXkgY29uZmlnICd7a2V5fSc6IHtlfSIpCiAgICAgICAgICAgICMgRmFsbGJhY2sgdG8gX2RlZmF1bHRfY29uZmlnCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZWZhdWx0X2NvbmZpZy5nZXQoa2V5LCBkZWZhdWx0KQogICAgICAgIAogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgZ2V0X2FjY291bnRzX2Zyb21fZGV2aWNlKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIiIiCiAgICAgICAgcGFzcwoKICAgICAgICAKICAgIGRlZiBzeW5jX2FjY291bnRzX3RvX2RiKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sgdsOgbyBkYXRhYmFzZSB2w6AgbWFwIHbhu5tpIHTDoGkga2hv4bqjbiBHb0xpa2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5nZXRfYWNjb3VudHNfZnJvbV9kZXZpY2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICBhbmRyb2lkX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIGhp4buHbiBjw7MgdHJvbmcgREIgY2hvIGFwcCBuw6B5CiAgICAgICAgICAgIGV4aXN0aW5nX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPXNlbGYuYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHNldCBjw6FjIHVuaXF1ZV91c2VybmFtZSB04burIHRoaeG6v3QgYuG7iyDEkeG7gyBk4buFIHNvIHPDoW5oCiAgICAgICAgICAgIGRldmljZV91c2VybmFtZXMgPSBzZXQoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX3VzZXJuYW1lcy5hZGQodXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIHRyb25nIERCIG3DoCBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4sgLT4gxJHDoW5oIGThuqV1IGxvZ291dAogICAgICAgICAgICBmb3IgZXhpc3RpbmdfYWNjb3VudCBpbiBleGlzdGluZ19hY2NvdW50czoKICAgICAgICAgICAgICAgIGV4aXN0aW5nX3VzZXJuYW1lID0gZXhpc3RpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiBleGlzdGluZ191c2VybmFtZSBhbmQgZXhpc3RpbmdfdXNlcm5hbWUgbm90IGluIGRldmljZV91c2VybmFtZXM6CiAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24gY8OzIHRyb25nIERCIG5oxrBuZyBraMO0bmcgY8OzIHRyw6puIHRoaeG6v3QgYuG7iyAtPiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgIT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2V4aXN0aW5nX3VzZXJuYW1lfSBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4ssIMSRw6FuaCBk4bqldSBsb2dvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGV4aXN0aW5nX2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBob+G6t2MgdGjDqm0gbeG7m2kgdsOgbyBEQgogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAjIFRow6ptIHRow7RuZyB0aW4gYXBwIHbDoCBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIGFjY291bnRbImFwcCJdID0gc2VsZi5hcHBfbmFtZQogICAgICAgICAgICAgICAgYWNjb3VudFsiZGV2aWNlX2lkIl0gPSBhbmRyb2lkX2lkCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBsw6AgY2jGsGEgxJHhu5NuZyBi4buZIMSR4buDIGfhu61pIGzDqm4gc2VydmVyCiAgICAgICAgICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWkgY2jGsGEgZOG7sWEgdsOgbyB1bmlxdWVfdXNlcm5hbWUgKyBhcHAKICAgICAgICAgICAgICAgIGV4aXN0aW5nX2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50X2J5X3VuaXF1ZV91c2VybmFtZShzZWxmLmFwcF9uYW1lLCBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIGhp4buHbiBjw7MgLSBjaOG7iSDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaSBsb2dpbi9sb2dvdXQKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gZXhpc3RpbmdfYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ2h14bqpbiBi4buLIGThu68gbGnhu4d1IGPhuq1wIG5o4bqtdCB04buRaSB0aGnhu4N1CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSwKICAgICAgICAgICAgICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogYWNjb3VudC5nZXQoImxhc3RfdXBkYXRlIiwgaW50KHRpbWUudGltZSgpKSksCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IHTDoGkga2hv4bqjbiB0cm9uZyBEQiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBsb2dvdXQgbmjGsG5nIHh14bqldCBoaeG7h24gbOG6oWkgdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICAgICAgaWYgZXhpc3RpbmdfYWNjb3VudC5nZXQoInN0YXR1cyIpID09ICJsb2dvdXQiOgogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHThu6sgbG9nb3V0IHbhu4EgYWN0aXZlIHbDoCB4w7NhIGluYWN0aXZlX3JlYXNvbgogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsic3RhdHVzIl0gPSAiYWN0aXZlIgogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsiaW5hY3RpdmVfcmVhc29uIl0gPSAiIgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IMSRw6MgeHXhuqV0IGhp4buHbiBs4bqhaSB0csOqbiB0aGnhur90IGLhu4ssIHJlc2V0IHThu6sgbG9nb3V0IHbhu4EgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICAjIE7hur91IMSRw6MgYWN0aXZlIHRow6wgZ2nhu68gbmd1ecOqbiBzdGF0dXMsIGtow7RuZyB0aGF5IMSR4buVaSBnw6wga2jDoWMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSB0cm9uZyB7c2VsZi5hcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB24bubaSB0cuG6oW5nIHRow6FpIGFjdGl2ZSB2w6AgdXNlcl9pZAogICAgICAgICAgICAgICAgICAgIGFjY291bnRbInN0YXR1cyJdID0gImFjdGl2ZSIKICAgICAgICAgICAgICAgICAgICAjIFRow6ptIHVzZXJfaWQgdOG7qyBjb25maWcgKMSRw6MgxJHGsOG7o2MgxJHhu41jIGtoaSBraOG7n2kgxJHhu5luZyBhcHApCiAgICAgICAgICAgICAgICAgICAgdXNlcl9pZCA9IHNlbGYuZGIuZ2V0KCJ1c2VyX2lkIikKICAgICAgICAgICAgICAgICAgICBpZiB1c2VyX2lkOgogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50WyJ1c2VyX2lkIl0gPSB1c2VyX2lkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5hZGRfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjaG8ge3NlbGYuYXBwX25hbWV9IHbhu5tpIHVzZXJfaWQ6IHt1c2VyX2lkfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iywgdGjhu7FjIGhp4buHbiBtYXBwaW5nIHbhu5tpIEdvTGlrZQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IG1hcHBpbmcgdMOgaSBraG/huqNuIHtzZWxmLmFwcF9uYW1lfSB24bubaSBHb0xpa2UuLi4iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICAgICAgZ29saWtlX2FjY291bnRzID0gc2VsZi5nZXRfZ29saWtlX2FjY291bnRzKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKGdvbGlrZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIGPhuq1wIG5o4bqtdCB04burIERCCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9kZXZpY2VfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9c2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gbWFwcGluZwogICAgICAgICAgICAgICAgICAgIG1hcHBlZF9jb3VudCA9IHNlbGYubWFwX2dvbGlrZV9hY2NvdW50cyhnb2xpa2VfYWNjb3VudHMsIHVwZGF0ZWRfZGV2aWNlX2FjY291bnRzKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobWFwcGVkX2NvdW50LCBpbnQpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBtYXBwaW5nIHttYXBwZWRfY291bnR9IHTDoGkga2hv4bqjbiB7c2VsZi5hcHBfbmFtZX0gduG7m2kgR29MaWtlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIG1hcHBpbmcgdMOgaSBraG/huqNuIHtzZWxmLmFwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBHb0xpa2UgbsOgbyBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBtYXBwaW5nIHbhu5tpIEdvTGlrZToge2V9IikKICAgICAgICAgICAgICAgICMgS2jDtG5nIHRocm93IGV4Y2VwdGlvbiB2w6wgc3luYyB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sgxJHDoyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZGV2aWNlX2FjY291bnRzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7c2VsZi5hcHBfbmFtZX0iKQogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgCiAgICBkZWYgaXNfZ29saWtlX2F1dGhlbnRpY2F0ZWQoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSDEkcOjIGPDsyB0aMO0bmcgdGluIHjDoWMgdGjhu7FjIEdvTGlrZSBo4bujcCBs4buHIGNoxrBhCiAgICAgICAgU+G7rSBk4bulbmcgR29MaWtlU2VydmljZSDEkeG7gyB2YWxpZGF0ZSBjaOG6t3QgY2jhur0gaMahbgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyB4w6FjIHRo4buxYyDEkeG6p3kgxJHhu6csIEZhbHNlIG7hur91IHRoaeG6v3UgdGjDtG5nIHRpbgogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLmdvbGlrZV9zZXJ2aWNlLmlzX2dvbGlrZV9hdXRoZW50aWNhdGVkKCkKICAgIAogICAgZGVmIGFwaV9yZXF1ZXN0KHNlbGYsIHVybDogc3RyLCBtZXRob2Q6IHN0ciA9ICJHRVQiLCBwYXlsb2FkOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBH4buNaSBBUEkgR29MaWtlIHRow7RuZyBxdWEgR29MaWtlU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVybDogVVJMIGPhu6dhIEFQSQogICAgICAgICAgICBtZXRob2Q6IFBoxrDGoW5nIHRo4bupYyBIVFRQIChHRVQgaG/hurdjIFBPU1QpCiAgICAgICAgICAgIHBheWxvYWQ6IEThu68gbGnhu4d1IGfhu61pIMSRaSAoY2hvIFBPU1QgcmVxdWVzdCkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogS+G6v3QgcXXhuqMgQVBJIG7hur91IHRow6BuaCBjw7RuZywgTm9uZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgZ+G7jWkgQVBJOiBHb0xpa2VTZXJ2aWNlIGNoxrBhIMSRxrDhu6NjIGN1bmcgY+G6pXAgY2hvIHtzZWxmLmFwcF9uYW1lfSBqb2IiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IHBheWxvYWQgY2hvIEdFVCByZXF1ZXN0IC0gdGjDqm0gdsOgbyBVUkwKICAgICAgICBpZiBtZXRob2QudXBwZXIoKSA9PSAiR0VUIiBhbmQgcGF5bG9hZDoKICAgICAgICAgICAgIyBU4bqhbyBxdWVyeSBzdHJpbmcgdOG7qyBwYXlsb2FkCiAgICAgICAgICAgIHF1ZXJ5X3BhcmFtcyA9IFtdCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIHBheWxvYWQuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIHZhbHVlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIHF1ZXJ5X3BhcmFtcy5hcHBlbmQoZiJ7dXJsbGliLnBhcnNlLnF1b3RlKGtleSl9PXt1cmxsaWIucGFyc2UucXVvdGUoc3RyKHZhbHVlKSl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gcXVlcnkgc3RyaW5nIHbDoG8gVVJMCiAgICAgICAgICAgIGlmIHF1ZXJ5X3BhcmFtczoKICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9ICImIiBpZiAiPyIgaW4gdXJsIGVsc2UgIj8iCiAgICAgICAgICAgICAgICB1cmwgPSBmInt1cmx9e3NlcGFyYXRvcn17JyYnLmpvaW4ocXVlcnlfcGFyYW1zKX0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq3dCBwYXlsb2FkIHbhu4EgTm9uZSB2w6wgxJHDoyDEkcawYSB2w6BvIFVSTAogICAgICAgICAgICBwYXlsb2FkID0gTm9uZQogICAgICAgIAogICAgICAgIHJldHVybiBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kLCBwYXlsb2FkKQogICAgCiAgICBkZWYgZ2V0X2dvbGlrZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMSRxINuZyBrw70gduG7m2kgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkMaw4budbmcgZOG6q24gQVBJIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVybCA9IGYie3NlbGYuZ2V0X2FjY291bnRfdXJsKCl9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KHVybCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIFtdKQogICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgbWFwX2dvbGlrZV9hY2NvdW50cyhzZWxmLCBnb2xpa2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dLCBkZXZpY2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICDDgW5oIHjhuqEgdMOgaSBraG/huqNuIHThu6sgR29MaWtlIHbDoG8gdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyBHb0xpa2UgQVBJCiAgICAgICAgICAgIGRldmljZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMOhbmggeOG6oQogICAgICAgICIiIgogICAgICAgICMgUGjGsMahbmcgdGjhu6ljIG3hurdjIMSR4buLbmgsIGPhuqduIG92ZXJyaWRlIOG7nyBs4bubcCBjb24KICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGVmIGZldGNoX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gam9iIHThu6sgR29MaWtlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogVGjDtG5nIHRpbiBqb2IgbuG6v3UgY8OzLCBOb25lIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDGsOG7nW5nIGThuqtuIEFQSSBs4bqleSBqb2IKICAgICAgICAgICAgdXJsID0gZiJ7c2VsZi5nZXRfam9ic191cmwoKX0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRoYW0gc+G7kSB0w7l5IHRoZW8gbG/huqFpIGFwcAogICAgICAgICAgICBwYXJhbXMgPSBzZWxmLmdldF9qb2JfcGFyYW1zKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIEFQSQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuYXBpX3JlcXVlc3QodXJsLCAiR0VUIiwgcGFyYW1zKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3VjY2VzcyIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGpvYiA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBqb2I6CiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3Ugam9iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYubWFwX2pvYl9kYXRhKGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBs4bqleSBqb2IiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgbWFwX2pvYl9kYXRhKHNlbGYsIGpvYl9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ2h14bqpbiBow7NhIGThu68gbGnhu4d1IGpvYiB04burIEFQSQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9kYXRhOiBE4buvIGxp4buHdSBqb2IgdOG7qyBBUEkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEThu68gbGnhu4d1IGpvYiDEkcOjIGNodeG6qW4gaMOzYQogICAgICAgICIiIgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhcHAiOiBzZWxmLmFwcF9uYW1lLAogICAgICAgICAgICAiaWQiOiBqb2JfZGF0YS5nZXQoImlkIiksCiAgICAgICAgICAgICJsaW5rIjogam9iX2RhdGEuZ2V0KCJsaW5rIiksCiAgICAgICAgICAgICJ0eXBlIjogam9iX2RhdGEuZ2V0KCJ0eXBlIiksCiAgICAgICAgICAgICJvYmplY3RfaWQiOiBqb2JfZGF0YS5nZXQoIm9iamVjdF9pZCIpLAogICAgICAgICAgICAicHJpY2VfYWZ0ZXJfY29zdCI6IGpvYl9kYXRhLmdldCgicHJpY2VfYWZ0ZXJfY29zdCIpLAogICAgICAgICAgICAic3RhdHVzIjogImlkbGUiLCAgIyBTdGF0dXMgbeG6t2MgxJHhu4tuaCBsw6AgaWRsZQogICAgICAgICAgICAicmF3X2RhdGEiOiBqb2JfZGF0YSAgIyBMxrB1IGzhuqFpIGThu68gbGnhu4d1IGfhu5FjIMSR4buDIHRoYW0ga2jhuqNvIGtoaSBj4bqnbgogICAgICAgIH0KICAgIAogICAgZGVmIHZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCB2YWxpZGF0ZSBqb2IgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyB2YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgLSB2YWxpZCAoYm9vbCk6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICAgICAgICAgLSBzaG91bGRfc2tpcCAoYm9vbCk6IFRydWUgbuG6v3UgbsOqbiBza2lwIGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgICAgICAgICAtIHJlYXNvbiAoc3RyKTogTMO9IGRvIGtow7RuZyBo4bujcCBs4buHIGhv4bq3YyBza2lwCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGNoaSB0aeG6v3QKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgIGpvYl9wcmljZSA9IGpvYi5nZXQoInByaWNlX2FmdGVyX2Nvc3QiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYiBmb2xsb3cKICAgICAgICAgICAgaWYgam9iX3R5cGUgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAjIDEuIEtp4buDbSB0cmEgZ2nDoSB0aeG7gW4gY+G7p2Egam9iIGZvbGxvdwogICAgICAgICAgICAgICAgbWluX2ZvbGxvd19wcmljZSA9IHNlbGYuZ2V0X2NvbmZpZygibWluX2ZvbGxvd19wcmljZSIsIDMwKSAgIyBN4bq3YyDEkeG7i25oIDMwCiAgICAgICAgICAgICAgICBpZiBqb2JfcHJpY2UgPCBtaW5fZm9sbG93X3ByaWNlOgogICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJ2YWxpZCI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAic2hvdWxkX3NraXAiOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IGYiSm9iIGZvbGxvdyBjw7MgZ2nDoSB7am9iX3ByaWNlfSA8IHttaW5fZm9sbG93X3ByaWNlfSwgc2tpcCBqb2IuIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOjIGLhu48ga2nhu4NtIHRyYSBraMOzYSBmb2xsb3cgdsOsIGtow7RuZyBjw7JuIGdp4bubaSBo4bqhbiBmb2xsb3cKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSm9iIGjhu6NwIGzhu4cKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJ2YWxpZCI6IFRydWUsCiAgICAgICAgICAgICAgICAic2hvdWxkX3NraXAiOiBGYWxzZSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIkpvYiBo4bujcCBs4buHIgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIHZhbGlkYXRlIGpvYjoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInZhbGlkIjogRmFsc2UsCiAgICAgICAgICAgICAgICAic2hvdWxkX3NraXAiOiBGYWxzZSwKICAgICAgICAgICAgICAgICJyZWFzb24iOiAidmFsaWRhdGlvbl9lcnJvciIsCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6IGYiTOG7l2kga2hpIHZhbGlkYXRlIGpvYjoge3N0cihlKX0iCiAgICAgICAgICAgIH0KICAgIAogICAgZGVmIGV4ZWN1dGVfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEvhur90IHF14bqjIHRo4buxYyBoaeG7h24gam9iLCBiYW8gZ+G7k206CiAgICAgICAgICAgICAgICAtIHN0YXR1cyAoaW50KTogTcOjIHRy4bqhbmcgdGjDoWkgam9iCiAgICAgICAgICAgICAgICAgICAgMDogQ2jGsGEgdGjhu7FjIGhp4buHbgogICAgICAgICAgICAgICAgICAgIDE6IFRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIDI6IFRo4bqldCBi4bqhaSwga2jDtG5nIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZwogICAgICAgICAgICAgICAgICAgIDM6IFRo4bqldCBi4bqhaSwgxJHDoyBi4buLIHVuZm9sbG93L3VubGlrZQogICAgICAgICAgICAgICAgLSBtZXNzYWdlIChzdHIpOiBUaMO0bmcgYsOhbyBr4bq/dCBxdeG6owogICAgICAgICAgICAgICAgLSBzdWNjZXNzIChib29sKTogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgICMgTeG6t2MgxJHhu4tuaCBraMO0bmcgbMOgbSBnw6wsIGPhuqduIG92ZXJyaWRlIOG7nyBs4bubcCBjb24KICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBqb2IgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDAsICJDaMawYSB0aOG7sWMgaGnhu4duIGpvYiIsIEZhbHNlKQogICAgCiAgICBkZWYgX2NyZWF0ZV9qb2JfcmVzdWx0KHNlbGYsIHN0YXR1czogaW50LCBtZXNzYWdlOiBzdHIsIHN1Y2Nlc3M6IGJvb2wsICoqa3dhcmdzKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBU4bqhbyBr4bq/dCBxdeG6oyBqb2IgY2h14bqpbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHN0YXR1cyAoaW50KTogTcOjIHRy4bqhbmcgdGjDoWkgam9iCiAgICAgICAgICAgICAgICAwOiBDaMawYSB0aOG7sWMgaGnhu4duCiAgICAgICAgICAgICAgICAxOiBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIDI6IFRo4bqldCBi4bqhaSwga2jDtG5nIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZwogICAgICAgICAgICAgICAgMzogVGjhuqV0IGLhuqFpLCDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICAgICA0OiBUaOG6pXQgYuG6oWksIHnDqnUgY+G6p3UgxJFhbmcgY2jhu50KICAgICAgICAgICAgICAgIDU6IEfhu61pIHnDqnUgY+G6p3UgY2jhu50gZHV54buHdCAoSW5zdGFncmFtKQogICAgICAgICAgICBtZXNzYWdlIChzdHIpOiBUaMO0bmcgYsOhbyBr4bq/dCBxdeG6owogICAgICAgICAgICBzdWNjZXNzIChib29sKTogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICAgICAqKmt3YXJnczogQ8OhYyB0aMO0bmcgdGluIGLhu5Ugc3VuZwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgam9iIMSRw6MgY2h14bqpbiBow7NhCiAgICAgICAgIiIiCiAgICAgICAgcmVzdWx0ID0gewogICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzLAogICAgICAgICAgICAibWVzc2FnZSI6IG1lc3NhZ2UsCiAgICAgICAgICAgICJzdWNjZXNzIjogc3VjY2VzcwogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIFRow6ptIHRow7RuZyB0aW4gYuG7lSBzdW5nIG7hur91IGPDswogICAgICAgIHJlc3VsdC51cGRhdGUoa3dhcmdzKQogICAgICAgIAogICAgICAgIHJldHVybiByZXN1bHQKICAgIAogICAgZGVmIHJlcG9ydF9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIHJlc3VsdDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQsOhbyBjw6FvIGvhur90IHF14bqjIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgcmVzdWx0OiBL4bq/dCBxdeG6oyB0aOG7sWMgaGnhu4duIGpvYiBiYW8gZ+G7k206CiAgICAgICAgICAgICAgICAtIHN0YXR1cyAoaW50KTogTcOjIHRy4bqhbmcgdGjDoWkgam9iCiAgICAgICAgICAgICAgICAgICAgMTogVGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgMjogVGjhuqV0IGLhuqFpLCBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgICAgICAgICAgMzogVGjhuqV0IGLhuqFpLCDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICAtIHN1Y2Nlc3MgKGJvb2wpOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgYsOhbyBjw6FvIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKQogICAgICAgICAgICBqb2Jfc3RhdHVzID0gcmVzdWx0LmdldCgic3RhdHVzIiwgMCkKICAgICAgICAgICAgam9iX3N1Y2Nlc3MgPSByZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEdoaSBs4bqhaSBs4buLY2ggc+G7rSBqb2IKICAgICAgICAgICAgc2VsZi5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCByZXN1bHQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgam9iX2lkOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyBjw7MgSUQgam9iIMSR4buDIGLDoW8gY8OhbyIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBqb2IgdsOgIHjhu60gbMO9IHTGsMahbmcg4bupbmcKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Ugc3RhdHVzIGzDoCAyIChs4buXaSBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nKSwgaOG7p3kgam9iIHbDoCBiw6FvIGPDoW8gdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIGlmIGpvYl9zdGF0dXMgPT0gMjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2Ige2pvYl9pZH0sIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcsIGjhu6d5IGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IHN0YXR1cyBsw6AgNiAoxJHhuqF0IGdp4bubaSBo4bqhbiBob+G6t2MgYuG7iyBraMOzYSksIGjhu6d5IGpvYgogICAgICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDY6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSm9iIHtqb2JfaWR9IGLhu4sgaOG7p3kgZG8gxJHhuqF0IGdp4bubaSBo4bqhbiBob+G6t2MgdMOgaSBraG/huqNuIGLhu4sga2jDs2EiKQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBzdGF0dXMgbMOgIDMgKMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UpLCDEkcOhbmggZOG6pXUgdHJvbmcgcmVzdWx0IMSR4buDIEpvYlNlcnZpY2UgeOG7rSBsw70KICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSAzOgogICAgICAgICAgICAgICAgYWNjb3VudF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlBow6F0IGhp4buHbiBi4buLIHVuZm9sbG93L3VubGlrZSwgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgSOG7p3kgam9iIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHVuZm9sbG93IHRyb25nIHJlc3VsdCDEkeG7gyBKb2JTZXJ2aWNlIHjhu60gbMO9IHThuq1wIHRydW5nCiAgICAgICAgICAgICAgICByZXN1bHRbInVuZm9sbG93Il0gPSBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSA0OgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlnDqnUgY+G6p3UgxJFhbmcgY2jhu50gdHJvbmcgam9iIHtqb2JfdHlwZX0sIGjhu6d5IGpvYiIpCiAgICAgICAgICAgICAgICBzZWxmLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBqb2IgdGjDoG5oIGPDtG5nLCBiw6FvIGPDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgaWYgam9iX3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAjIFVSTCBBUEkgYsOhbyBjw6FvIGpvYgogICAgICAgICAgICAgICAgdXJsID0gc2VsZi5nZXRfY29tcGxldGVfam9ic191cmwoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFThuqFvIHBheWxvYWQgY2hvIGLDoW8gY8OhbyBqb2IKICAgICAgICAgICAgICAgIHBheWxvYWQgPSBzZWxmLmdldF9yZXBvcnRfcGF5bG9hZChhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICBpZiBub3QgcGF5bG9hZDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHThuqFvIHBheWxvYWQgY2hvIGLDoW8gY8OhbyBqb2IiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRo4butIGfhu41pIEFQSSB04buRaSDEkWEgMyBs4bqnbgogICAgICAgICAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMyk6CiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KHVybCwgIlBPU1QiLCBwYXlsb2FkKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGLDoW8gY8OhbyBqb2Ige2pvYl9pZH0gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICBlbGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN0YXR1cyIpID09IDQwMDoKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gcmVzcG9uc2UuZ2V0KCdtZXNzYWdlJywgJycpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiW3thdHRlbXB0ICsgMX1dIELDoW8gY8OhbyBqb2IgbOG7l2k6IHtlcnJvcl9tc2d9LCB0aOG7rSBs4bqhaSBzYXUgNXMuLi4iKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiUGjhuqNuIGjhu5NpIGtow7RuZyBtb25nIMSR4bujaSBraGkgYsOhbyBjw6FvIGpvYjoge3Jlc3BvbnNlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHRow6BuaCBjw7RuZyBzYXUgMyBs4bqnbiB0aOG7rSwgaOG7p3kgam9iCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBiw6FvIGPDoW8gam9iIHtqb2JfaWR9IHNhdSAzIGzhuqduIHRo4butIikKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgSm9iIGtow7RuZyB0aMOgbmggY8O0bmcsIGjhu6d5IGpvYgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkpvYiB7am9iX2lkfSBraMO0bmcgdGjDoG5oIGPDtG5nLCBo4buneSBqb2IiKQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBiw6FvIGPDoW8gam9iIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBnZXRfcmVwb3J0X3BheWxvYWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFThuqFvIHBheWxvYWQgY2hvIHZp4buHYyBiw6FvIGPDoW8gaG/DoG4gdGjDoG5oIGpvYgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFBheWxvYWQgY2hvIEFQSSBiw6FvIGPDoW8KICAgICAgICAiIiIKICAgICAgICBnb2xpa2VfaWQgPSBhY2NvdW50LmdldCgiZ29saWtlX2lkIikKICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGdvbGlrZV9pZCBvciBub3Qgam9iX2lkOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiVGhp4bq/dSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBob+G6t2Mgam9iIMSR4buDIHThuqFvIHBheWxvYWQgYsOhbyBjw6FvIikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhZHNfaWQiOiBqb2JfaWQsCiAgICAgICAgICAgICJhY2NvdW50X2lkIjogZ29saWtlX2lkLAogICAgICAgICAgICAiYXN5bmMiOiBUcnVlLAogICAgICAgICAgICAiZGF0YSI6IE5vbmUKICAgICAgICB9CiAgICAKICAgIGRlZiBnZXRfc2tpcF9wYXlsb2FkKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBU4bqhbyBwYXlsb2FkIGNobyB2aeG7h2MgYuG7jyBxdWEvaOG7p3kgam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogUGF5bG9hZCBjaG8gQVBJIHNraXAgam9iCiAgICAgICAgIiIiCiAgICAgICAgZ29saWtlX2lkID0gYWNjb3VudC5nZXQoImdvbGlrZV9pZCIpCiAgICAgICAgam9iX2lkID0gam9iLmdldCgiaWQiKQogICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIpCiAgICAgICAgb2JqZWN0X2lkID0gam9iLmdldCgib2JqZWN0X2lkIikKICAgICAgICAKICAgICAgICBpZiBub3QgZ29saWtlX2lkIG9yIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJUaGnhur91IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhv4bq3YyBqb2IgxJHhu4MgdOG6oW8gcGF5bG9hZCBo4buneSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAiYWRzX2lkIjogam9iX2lkLAogICAgICAgICAgICAiYWNjb3VudF9pZCI6IGdvbGlrZV9pZCwKICAgICAgICAgICAgIm9iamVjdF9pZCI6IG9iamVjdF9pZCwKICAgICAgICAgICAgInR5cGUiOiBqb2JfdHlwZQogICAgICAgIH0KICAgICAgICAKICAgIGRlZiBza2lwX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBC4buPIHF1YS9o4buneSBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGjhu6d5IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGNvbmZpZwogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBVUkwgQVBJIMSR4buDIHNraXAgam9iCiAgICAgICAgICAgIHVybCA9IHNlbGYuZ2V0X3NraXBfam9ic191cmwoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBwYXlsb2FkIGNobyB2aeG7h2Mgc2tpcCBqb2IKICAgICAgICAgICAgcGF5bG9hZCA9IHNlbGYuZ2V0X3NraXBfcGF5bG9hZChhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIGlmIG5vdCBwYXlsb2FkOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB04bqhbyBwYXlsb2FkIGNobyBza2lwIGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgQVBJCiAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5hcGlfcmVxdWVzdCh1cmwsICJQT1NUIiwgcGF5bG9hZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBo4buneSBqb2Ige2pvYi5nZXQoJ2lkJyl9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkjhu6d5IGpvYiB7am9iLmdldCgnaWQnKX0gdGjhuqV0IGLhuqFpOiB7cmVzcG9uc2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBo4buneSBqb2IiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGRlZiBjbG9zZV9hcHAoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcAogICAgICAgICIiIgogICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgZGVmIGdldF9hcGlfYmFzZV91cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBn4buRYyBj4bunYSBBUEkgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgZ+G7kWMKICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfSIKICAgIAogICAgZGVmIGdldF9hY2NvdW50X3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSB0w6BpIGtob+G6o24gY+G7p2EgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0ve3NlbGYuYXBwX25hbWV9LWFjY291bnQiCiAgICAKICAgIGRlZiBnZXRfam9ic191cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgam9icyBj4bunYSBHb0xpa2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgam9icwogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vam9icyIKICAgIAogICAgZGVmIGdldF9jb21wbGV0ZV9qb2JzX3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSBiw6FvIGPDoW8gam9iIGhvw6BuIHRow6BuaCBj4bunYSBHb0xpa2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgYsOhbyBjw6FvIGpvYiBob8OgbiB0aMOgbmgKICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L2FkdmVydGlzaW5nL3B1Ymxpc2hlcnMve3NlbGYuYXBwX25hbWV9L2NvbXBsZXRlLWpvYnMiCiAgICAKICAgIGRlZiBnZXRfc2tpcF9qb2JzX3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSBza2lwIGpvYnMgY+G7p2EgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIHNraXAgam9icwogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vc2tpcC1qb2JzIgogICAgCiAgICBkZWYgZ2V0X2pvYl9yZXBvcnRfdXJsKHNlbGYsIGpvYl9pZDogc3RyKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSBiw6FvIGPDoW8gam9iIGPhu6dhIEdvTGlrZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9pZDogSUQgY+G7p2Egam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVJMIEFQSSBiw6FvIGPDoW8gam9iCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGNvbmZpZwogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS97c2VsZi5hcHBfbmFtZX0vam9icy97am9iX2lkfS9yZXBvcnQiCiAgICAKICAgIGRlZiBnZXRfam9iX3BhcmFtcyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGhhbSBz4buRIMSR4buDIGfhu41pIEFQSSBs4bqleSBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGhhbSBz4buRCiAgICAgICAgIiIiCiAgICAgICAgIyBN4bq3YyDEkeG7i25oIGtow7RuZyBjw7MgdGhhbSBz4buRLCBj4bqnbiBvdmVycmlkZSDhu58gbOG7m3AgY29uCiAgICAgICAgcmV0dXJuIHt9CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudHNfZnJvbV9kZXZpY2Uoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiUGjGsMahbmcgdGjhu6ljIGPGoSBz4bufIMSR4buDIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuLCBj4bqnbiBvdmVycmlkZSDhu58gY2xhc3MgY29uIiIiCiAgICAgICAgcmV0dXJuIFtdCiAgICAKICAgIGRlZiBzZXRfc2xlZXBfZnVuY3Rpb24oc2VsZiwgc2xlZXBfZnVuYzogQ2FsbGFibGVbW2Zsb2F0XSwgYm9vbF0pOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBow6BtIHNsZWVwIHTDuXkgY2jhu4luaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNsZWVwX2Z1bmM6IEjDoG0gc2xlZXAgbmjhuq1uIG3hu5l0IHRoYW0gc+G7kSBsw6Agc+G7kSBnacOieSB2w6AgdHLhuqMgduG7gSBUcnVlIG7hur91IHNsZWVwIMSR4bunIHRo4budaSBnaWFuLAogICAgICAgICAgICAgICAgICAgICAgICBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHNlbGYuX3NsZWVwX2Z1bmMgPSBzbGVlcF9mdW5jCiAgICAgICAgCiAgICBkZWYgc2FmZV9zbGVlcChzZWxmLCBzZWNvbmRzOiBmbG9hdCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBOZ+G7pyBhbiB0b8OgbiwgY8OzIHRo4buDIGThu6tuZyBs4bqhaSBuZ2F5IGzhuq1wIHThu6ljCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLl9zbGVlcF9mdW5jKHNlY29uZHMpCiAgICAKICAgIGRlZiBzd2l0Y2hfdG9fYWNjb3VudChzZWxmLCB0YXJnZXRfYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIENodXnhu4NuIMSR4buVaSBzYW5nIHTDoGkga2hv4bqjbiBt4bulYyB0acOqdQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhcmdldF9hY2NvdW50OiBUw6BpIGtob+G6o24gY+G6p24gY2h1eeG7g24gxJHhur9uCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiB7CiAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IGJvb2wsCiAgICAgICAgICAgICAgICAncmVhc29uJzogc3RyIChu4bq/dSB0aOG6pXQgYuG6oWkpLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBzdHIKICAgICAgICAgICAgfQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIGNodXnhu4NuIMSR4buVaSBzYW5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAndW5rbm93bicpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq3dCB0aOG7nWkgZ2lhbiBjaOG7nSB04buRaSDEkWEgKGdpw6J5KQogICAgICAgICAgICB0aW1lb3V0ID0gNjAKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wCiAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBzZWxmLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgIHRhcmdldF91c2VybmFtZSA9IHRhcmdldF9hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgxJHDoyDEkcSDbmcgbmjhuq1wIMSRw7puZyB0w6BpIGtob+G6o24gcuG7k2ksIGtow7RuZyBj4bqnbiBjaHV54buDbiDEkeG7lWkKICAgICAgICAgICAgaWYgY3VycmVudF91c2VybmFtZSBhbmQgY3VycmVudF91c2VybmFtZSA9PSB0YXJnZXRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyDEkcSDbmcgbmjhuq1wIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSBy4buTaSIpCiAgICAgICAgICAgICAgICByZXR1cm4geydzdWNjZXNzJzogVHJ1ZSwgJ21lc3NhZ2UnOiBmJ8SQw6MgxJHEg25nIG5o4bqtcCB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0nfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBjaMawYSDEkcSDbmcgbmjhuq1wIMSRw7puZyB0w6BpIGtob+G6o24sIHRo4buxYyBoaeG7h24gY2h1eeG7g24gxJHhu5VpCiAgICAgICAgICAgIHdoaWxlIHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSA8IHRpbWVvdXQ6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBQaMawxqFuZyB0aOG7qWMgbsOgeSBz4bq9IMSRxrDhu6NjIGdoaSDEkcOoIGLhu59pIGzhu5twIGNvbiB0w7l5IHRoZW8g4bupbmcgZOG7pW5nCiAgICAgICAgICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IHNlbGYuX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2godGFyZ2V0X2FjY291bnQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGvhur90IHF14bqjIHRy4bqjIHbhu4EgdOG7qyBfcGVyZm9ybV9hY2NvdW50X3N3aXRjaAogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoc3dpdGNoX3Jlc3VsdCwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0LmdldCgnc3VjY2VzcycsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzd2l0Y2hfcmVzdWx0ICAjIFRy4bqjIHbhu4EgbmdheSBs4buXaSB04burIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3Qgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAgICAgIyBUxrDGoW5nIHRow61jaCB24bubaSBpbXBsZW1lbnRhdGlvbiBjxakgdHLhuqMgduG7gSBib29sZWFuCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAnc3dpdGNoX2ZhaWxlZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6ICdLaMO0bmcgdGjhu4MgY2h1eeG7g24gdMOgaSBraG/huqNuJwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyDEkOG7o2kgbeG7mXQgY2jDunQgxJHhu4Mg4bupbmcgZOG7pW5nIGxvYWQgeG9uZwogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB4ZW0gxJHDoyBjaHV54buDbiDEkcO6bmcgdMOgaSBraG/huqNuIGNoxrBhCiAgICAgICAgICAgICAgICAgICAgbmV3X3VzZXJuYW1lID0gc2VsZi5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIG5ld191c2VybmFtZSBhbmQgbmV3X3VzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCB0cm9uZyBEQgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnJlc2V0X2xvZ2luX3N0YXR1c19ieV9hcHAoc2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudCh0YXJnZXRfYWNjb3VudFsiaWQiXSwgeyJpc19sb2dpbiI6IFRydWUsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsnc3VjY2Vzcyc6IFRydWUsICdtZXNzYWdlJzogZidDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0aMOgbmggY8O0bmcnfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgY2jGsGEgdGjDoG5oIGPDtG5nLCDEkeG7o2kgbeG7mXQgY2jDunQgcuG7k2kgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o246IHtzdHIoZSl9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IHNhdSB7dGltZW91dH0gZ2nDonkiKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAncmVhc29uJzogJ3RpbWVvdXQnLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ0tow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSBzYXUge3RpbWVvdXR9IGdpw6J5JwogICAgICAgICAgICB9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdleGNlcHRpb24nLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ0zhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o246IHtzdHIoZSl9JwogICAgICAgICAgICB9CiAgICAKICAgIGRlZiBfcGVyZm9ybV9hY2NvdW50X3N3aXRjaChzZWxmLCB0YXJnZXRfYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gY8OhYyB0aGFvIHTDoWMgVUkgxJHhu4MgY2h1eeG7g24gdMOgaSBraG/huqNuCiAgICAgICAgUGjGsMahbmcgdGjhu6ljIG7DoHkgY+G6p24gxJHGsOG7o2MgZ2hpIMSRw6ggYuG7n2kgbOG7m3AgY29uCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFyZ2V0X2FjY291bnQ6IFTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbiDEkeG6v24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IHsKICAgICAgICAgICAgICAgICdzdWNjZXNzJzogYm9vbCwKICAgICAgICAgICAgICAgICdyZWFzb24nOiBzdHIgKG7hur91IHRo4bqldCBi4bqhaSAtICdhY2NvdW50X25vdF9mb3VuZCcsICd1aV9lcnJvcicsIGV0Yy4pLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBzdHIKICAgICAgICAgICAgfQogICAgICAgICIiIgogICAgICAgICMgUGjGsMahbmcgdGjhu6ljIGPGoSBz4bufIGNo4buJIGxvZyBj4bqjbmggYsOhbwogICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJQaMawxqFuZyB0aOG7qWMgX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2ggY2jGsGEgxJHGsOG7o2MgdHJp4buDbiBraGFpIGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgJ3JlYXNvbic6ICdub3RfaW1wbGVtZW50ZWQnLAogICAgICAgICAgICAnbWVzc2FnZSc6IGYnUGjGsMahbmcgdGjhu6ljIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoIGNoxrBhIMSRxrDhu6NjIHRyaeG7g24ga2hhaSBjaG8ge3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffScKICAgICAgICB9CiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKHNlbGYpIC0+IE9wdGlvbmFsW3N0cl06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdXNlcm5hbWUgY+G7p2EgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHIgaG/hurdjIE5vbmU6IFVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wLCBob+G6t2MgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgIyBQaMawxqFuZyB0aOG7qWMgY8ahIHPhu58gY2jhu4kgbG9nIGPhuqNuaCBiw6FvCiAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlBoxrDGoW5nIHRo4bupYyBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUgY2jGsGEgxJHGsOG7o2MgdHJp4buDbiBraGFpIGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgcmVjb3JkX2pvYl9oaXN0b3J5KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCByZXN1bHQ6IERpY3Rbc3RyLCBBbnldKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgR2hpIGzhuqFpIGzhu4tjaCBz4butIGpvYiB2w6BvIGRhdGFiYXNlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICByZXN1bHQ6IEvhur90IHF14bqjIHRo4buxYyBoaeG7h24gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVVJRCBj4bunYSBi4bqjbiBnaGkgbOG7i2NoIHPhu60gam9iIGhv4bq3YyBjaHXhu5dpIHLhu5duZyBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGV2aWNlX2lkCiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3Ugam9iIGhpc3RvcnkKICAgICAgICAgICAgam9iX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAiYWNjb3VudF91dWlkIjogYWNjb3VudC5nZXQoImFjY291bnRfdXVpZCIsICIiKSwKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAiYXBwIjogc2VsZi5hcHBfbmFtZSwKICAgICAgICAgICAgICAgICJqb2JfaWQiOiBqb2IuZ2V0KCJpZCIsICIiKSwKICAgICAgICAgICAgICAgICJqb2JfdHlwZSI6IGpvYi5nZXQoInR5cGUiLCAiIiksCiAgICAgICAgICAgICAgICAib2JqZWN0X2lkIjogam9iLmdldCgib2JqZWN0X2lkIiwgIiIpLAogICAgICAgICAgICAgICAgImxpbmsiOiBqb2IuZ2V0KCJsaW5rIiwgIiIpLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHJlc3VsdC5nZXQoInN0YXR1cyIsIDApLAogICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiByZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpLAogICAgICAgICAgICAgICAgInByaWNlIjogam9iLmdldCgicHJpY2VfYWZ0ZXJfY29zdCIsIDApLAogICAgICAgICAgICAgICAgImVycm9yX21lc3NhZ2UiOiByZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIiIpIGlmIG5vdCByZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpIGVsc2UgIiIsCiAgICAgICAgICAgICAgICAiY3JlYXRlZF9hdCI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlICAjIMSQ4bqjbSBi4bqjbyB0cuG6oW5nIHRow6FpIGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgam9iX3V1aWQgPSBzZWxmLmRiLmFkZF9qb2JfaGlzdG9yeShqb2JfZGF0YSkKICAgICAgICAgICAgaWYgam9iX3V1aWQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIsSQw6MgbMawdSBs4buLY2ggc+G7rSBqb2Ige2pvYi5nZXQoJ2lkJyl9IHbDoG8gZGF0YWJhc2UgduG7m2kgVVVJRDoge2pvYl91dWlkfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGzGsHUgbOG7i2NoIHPhu60gam9iIHtqb2IuZ2V0KCdpZCcpfSB2w6BvIGRhdGFiYXNlIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBqb2JfdXVpZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgZ2hpIGzhu4tjaCBz4butIGpvYiIpCiAgICAgICAgICAgIHJldHVybiAiIgoKICAgIGRlZiByZXBvcnRfam9iX2NvbXBsZXRlZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgcmVwb3J0X2RhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBCw6FvIGPDoW8gam9iIMSRw6MgaG/DoG4gdGjDoG5oCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICByZXBvcnRfZGF0YTogROG7ryBsaeG7h3UgYsOhbyBjw6FvCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyBiw6FvIGPDoW8gdOG7qyBBUEkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgam9iX2lkIHThu6sgam9iCiAgICAgICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAgICAgaWYgbm90IGpvYl9pZDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgam9iX2lkIHRyb25nIGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJLaMO0bmcgdMOsbSB0aOG6pXkgam9iX2lkIHRyb25nIGpvYiJ9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3UgYsOhbyBjw6FvCiAgICAgICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICAiaWQiOiBqb2JfaWQsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogVHJ1ZQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IGLDoW8gY8OhbyBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgcmVwb3J0X2RhdGE6CiAgICAgICAgICAgICAgICBwYXlsb2FkLnVwZGF0ZShyZXBvcnRfZGF0YSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIEFQSSBiw6FvIGPDoW8gam9iIMSRw6MgaG/DoG4gdGjDoG5oCiAgICAgICAgICAgIHVybCA9IHNlbGYuZ2V0X2NvbXBsZXRlX2pvYnNfdXJsKCkKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5nb2xpa2Vfc2VydmljZS5hcGlfcmVxdWVzdCh1cmwsIG1ldGhvZD0iUE9TVCIsIHBheWxvYWQ9cGF5bG9hZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmgiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiAiS2jDtG5nIHRo4buDIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmgifQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGLDoW8gY8OhbyBqb2Ige2pvYl9pZH0gaG/DoG4gdGjDoG5oIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJzdWNjZXNzIiwgIm1lc3NhZ2UiOiAixJDDoyBiw6FvIGPDoW8gam9iIGhvw6BuIHRow6BuaCB0aMOgbmggY8O0bmciLCAiZGF0YSI6IHJlc3VsdH0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBiw6FvIGPDoW8gam9iIMSRw6MgaG/DoG4gdGjDoG5oIikKICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiBmIkzhu5dpIGtoaSBiw6FvIGPDoW8gam9iIMSRw6MgaG/DoG4gdGjDoG5oOiB7c3RyKGUpfSJ9CiAgICAgICAgICAgIAogICAgZGVmIHJlcG9ydF9qb2Jfc2tpcHBlZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIgPSAiIikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWEKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIHJlYXNvbjogTMO9IGRvIGLhu48gcXVhIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgYsOhbyBjw6FvIHThu6sgQVBJCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGpvYl9pZCB04burIGpvYgogICAgICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgICAgIGlmIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYl9pZCB0cm9uZyBqb2IiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiAiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYl9pZCB0cm9uZyBqb2IifQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h14bqpbiBi4buLIGThu68gbGnhu4d1IGLDoW8gY8OhbwogICAgICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgImlkIjogam9iX2lkCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gbMO9IGRvIG7hur91IGPDswogICAgICAgICAgICBpZiByZWFzb246CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJyZWFzb24iXSA9IHJlYXNvbgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgQVBJIGLDoW8gY8OhbyBqb2IgxJHDoyBi4buLIGLhu48gcXVhCiAgICAgICAgICAgIHVybCA9IHNlbGYuZ2V0X3NraXBfam9ic191cmwoKQogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kPSJQT1NUIiwgcGF5bG9hZD1wYXlsb2FkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiAiS2jDtG5nIHRo4buDIGLDoW8gY8OhbyBqb2IgxJHDoyBi4buLIGLhu48gcXVhIn0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBiw6FvIGPDoW8gam9iIHtqb2JfaWR9IGLhu4sgYuG7jyBxdWEgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MiLCAibWVzc2FnZSI6ICLEkMOjIGLDoW8gY8OhbyBqb2IgYuG7iyBi4buPIHF1YSB0aMOgbmggY8O0bmciLCAiZGF0YSI6IHJlc3VsdH0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBiw6FvIGPDoW8gam9iIMSRw6MgYuG7iyBi4buPIHF1YSIpCiAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJlcnJvciIsICJtZXNzYWdlIjogZiJM4buXaSBraGkgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWE6IHtzdHIoZSl9In0KICAgIAogICAgZGVmIGdldF9hY2NvdW50X2xpc3RfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfSIKICAgICAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9kZXRhaWxfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGNoaSB0aeG6v3QgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIGNoaSB0aeG6v3QgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfS1hY2NvdW50IgogICAgICAgIAogICAgZGVmIGdldF9qb2JfbGlzdF91cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgZGFuaCBzw6FjaCBqb2IKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgZGFuaCBzw6FjaCBqb2IKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vam9icyIKICAgICAgICAKICAgIGRlZiBnZXRfam9iX3JlcG9ydF91cmwoc2VsZiwgam9iX2lkOiBzdHIpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGLDoW8gY8OhbyBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfaWQ6IElEIGPhu6dhIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgYsOhbyBjw6FvIGpvYgogICAgICAgICIiIgogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS97c2VsZi5hcHBfbmFtZX0vam9icy97am9iX2lkfS9yZXBvcnQiCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgQUJTVFJBQ1QgTUVUSE9EUyBDSE8gQ0FSRSBBQ1RJT05TIChLSMOUTkcgUEjhuqJJIEpPQikKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIHBlcmZvcm1fbmV3c2ZlZWRfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyB2deG7kXQgbmV3c2ZlZWQvYuG6o25nIHRpbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmInBlcmZvcm1fbmV3c2ZlZWRfYWN0aW9uIGNoxrBhIMSRxrDhu6NjIGltcGxlbWVudCBjaG8ge3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3JlZWxzX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgeGVtIHJlZWxzL3ZpZGVvCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYicGVyZm9ybV9yZWVsc19hY3Rpb24gY2jGsGEgxJHGsOG7o2MgaW1wbGVtZW50IGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fbm90aWZpY2F0aW9uX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgeGVtIHRow7RuZyBiw6FvCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYicGVyZm9ybV9ub3RpZmljYXRpb25fYWN0aW9uIGNoxrBhIMSRxrDhu6NjIGltcGxlbWVudCBjaG8ge3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3Byb2ZpbGVfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gaMOgbmggxJHhu5luZyB4ZW0gcHJvZmlsZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmInBlcmZvcm1fcHJvZmlsZV9hY3Rpb24gY2jGsGEgxJHGsOG7o2MgaW1wbGVtZW50IGNobyB7c2VsZi5fX2NsYXNzX18uX19uYW1lX199IikKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHBlcmZvcm1fZXhwbG9yZV9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIGtow6FtIHBow6EvdMOsbSBoaeG7g3UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJwZXJmb3JtX2V4cGxvcmVfYWN0aW9uIGNoxrBhIMSRxrDhu6NjIGltcGxlbWVudCBjaG8ge3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3NlYXJjaF9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIHTDrG0ga2nhur9tCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYicGVyZm9ybV9zZWFyY2hfYWN0aW9uIGNoxrBhIMSRxrDhu6NjIGltcGxlbWVudCBjaG8ge3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgTUVUSE9EUyBI4buWIFRS4buiIENITyBBUFAgTUFOQUdFTUVOVAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBvcGVuX2FwcChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE3hu58gYXBwIHTGsMahbmcg4bupbmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHBhc3MKICAgIAogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgZW5zdXJlX2hvbWVfc2NyZWVuKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyBtw6BuIGjDrG5oIGhvbWUgKGltcGxlbWVudGF0aW9uIGNodW5nKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgbWF4X3JldHJpZXMgPSAzCiAgICAgICAgCiAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UobWF4X3JldHJpZXMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIELGsOG7m2MgMTogS2nhu4NtIHRyYSBwYWNrYWdlIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3BhY2thZ2UgIT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQXBwIGNoxrBhIG3hu58gKGhp4buHbiB04bqhaToge2N1cnJlbnRfcGFja2FnZX0pLCDEkWFuZyBt4bufIGFwcC4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgICAgICAgICAjIENo4budIDEwIGdpw6J5IGNobyBhcHAga2jhu59pIMSR4buZbmcKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAyOiBLaeG7g20gdHJhIGPDsyBwaOG6o2kgdHJhbmcgY2jhu6cga2jDtG5nCiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIsSQw6Mg4bufIG3DoG4gaMOsbmggaG9tZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDM6IFZhbGlkYXRlIGFwcCBraMO0bmcgYuG7iyBiYW5uZWQKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnZhbGlkYXRlX2FwcF9ub3RfYmFubmVkKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiQXBwIGLhu4sgYmFubmVkLCDEkcOzbmcgdsOgIG3hu58gbOG6oWkuLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMik6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIFJldHJ5IHThu6sgxJHhuqd1CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyA0OiBY4butIGzDvSBjw6FjIGRpYWxvZyB2w6AgduG7gSBob21lCiAgICAgICAgICAgICAgICBzZWxmLl9oYW5kbGVfZGlhbG9nc19hbmRfbmF2aWdhdGVfaG9tZSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyA1OiBLaeG7g20gdHJhIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkF0dGVtcHQge2F0dGVtcHQgKyAxfTogVuG6q24gY2jGsGEgduG7gSDEkcaw4bujYyBob21lIHNjcmVlbiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBlbnN1cmVfaG9tZV9zY3JlZW4gYXR0ZW1wdCB7YXR0ZW1wdCArIDF9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgduG7gSBob21lIHNjcmVlbiBzYXUge21heF9yZXRyaWVzfSBs4bqnbiB0aOG7rSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgdmFsaWRhdGVfYXBwX25vdF9iYW5uZWQoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIGFwcCBjw7MgYuG7iyBiYW5uZWQga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraMO0bmcgYuG7iyBiYW5uZWQsIEZhbHNlIG7hur91IGLhu4sgYmFubmVkCiAgICAgICAgIiIiCiAgICAgICAgcGFzcwogICAgCiAgICBkZWYgX2hhbmRsZV9kaWFsb2dzX2FuZF9uYXZpZ2F0ZV9ob21lKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPDoWMgZGlhbG9nIHbDoCBuYXZpZ2F0ZSB24buBIGhvbWUgKGPDsyB0aOG7gyBvdmVycmlkZSB0cm9uZyBzdWJjbGFzcykKICAgICAgICAiIiIKICAgICAgICAjIERlZmF1bHQgaW1wbGVtZW50YXRpb24gLSBzdWJjbGFzcyBjw7MgdGjhu4Mgb3ZlcnJpZGUKICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZygixJBhbmcgeOG7rSBsw70gZGlhbG9ncyB2w6AgbmF2aWdhdGUgduG7gSBob21lLi4uIikKICAgICAgICAKICAgICAgICAjIFRo4butIG5o4bqlbiBiYWNrIG3hu5l0IHbDoGkgbOG6p24KICAgICAgICBmb3IgXyBpbiByYW5nZSgzKToKICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgICAgICMgTuG6v3UgduG6q24gY2jGsGEgduG7gSDEkcaw4bujYyBob21lLCB0aOG7rSB0w6xtIGhvbWUgYnV0dG9uCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJUcmFuZyBjaOG7pyIpCiAgICAgICAgICAgIGlmIG5vdCBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgIGhvbWVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgaWYgbm90IGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iSG9tZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoaG9tZV9idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKCiAgICBAYWJzdHJhY3RtZXRob2QKICAgIGRlZiBpc19ob21lX3NjcmVlbihzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyDhu58gbcOgbiBow6xuaCBob21lIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJFhbmcg4bufIGhvbWUgc2NyZWVuCiAgICAgICAgIiIiCiAgICAgICAgcGFzcwogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAjIE1FVEhPRFMgSOG7liBUUuG7oiBDSE8gQUNUSU9OIFdFSUdIVFMgQ09ORklHVVJBVElPTgogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBkZWYgZ2V0X2FjdGlvbl93ZWlnaHRzKHNlbGYpIC0+IERpY3Rbc3RyLCBpbnRdOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHThu4kgbOG7hyBow6BuaCDEkeG7mW5nIGNobyBhcHAgbsOgeSAtIMawdSB0acOqbiB04burIERCLCBmYWxsYmFjayB24buBIGRlZmF1bHQKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgaW50XTogVOG7iSBs4buHIGjDoG5oIMSR4buZbmcge2FjdGlvbl9uYW1lOiB3ZWlnaHRfcGVyY2VudH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9jb25maWcgPSBzZWxmLmdldF9hcHBfY29uZmlnKCkKICAgICAgICAgICAgcmV0dXJuIGFwcF9jb25maWcuZ2V0KCJhY3Rpb25fd2VpZ2h0cyIsIHNlbGYuX2RlZmF1bHRfY29uZmlnWyJhY3Rpb25fd2VpZ2h0cyJdKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGzhuqV5IGFjdGlvbiB3ZWlnaHRzLCBkw7luZyBkZWZhdWx0OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGVmYXVsdF9jb25maWdbImFjdGlvbl93ZWlnaHRzIl0KICAgIAogICAgZGVmIGdldF9hcHBfY29uZmlnKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGNvbmZpZyBjaG8gYXBwIG7DoHkgdOG7qyBEQiB24bubaSBwcmlvcml0eTogYXBwX2NvbmZpZyDihpIgZ2xvYmFsX2NvbmZpZyDihpIgZGVmYXVsdAogICAgICAgIEx1w7RuIMSR4buNYyB04burIERCLCBraMO0bmcgY2FjaGUgxJHhu4MgY8OzIHRo4buDIHVwZGF0ZSBxdWEgTVFUVAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBDb25maWcgY+G7p2EgYXBwLCBtZXJnZSB0aGVvIHByaW9yaXR5CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIERCIHNlcnZpY2UgxJHhu4MgbOG6pXkgY29uZmlnIHbhu5tpIHByaW9yaXR5IGxvZ2ljCiAgICAgICAgICAgIHJldHVybiBzZWxmLmRiLmdldF9hcHBfY29uZmlnKHNlbGYuYXBwX25hbWUsIHNlbGYuX2RlZmF1bHRfY29uZmlnKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGzhuqV5IGFwcCBjb25maWcsIGTDuW5nIGRlZmF1bHQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZWZhdWx0X2NvbmZpZy5jb3B5KCkKICAgIAogICAgZGVmIHNhdmVfYXBwX2NvbmZpZyhzZWxmLCBjb25maWdfdXBkYXRlczogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMawdSBjb25maWcgY2hvIGFwcCBuw6B5IHbDoG8gREIgKG1lcmdlIHbhu5tpIGNvbmZpZyBoaeG7h24gdOG6oWkpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnX3VwZGF0ZXM6IEPDoWMgY29uZmlnIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZGIudXBkYXRlX2FwcF9jb25maWcoc2VsZi5hcHBfbmFtZSwgY29uZmlnX3VwZGF0ZXMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGzGsHUgYXBwIGNvbmZpZzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBpbml0X2RlZmF1bHRfYXBwX2NvbmZpZyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBjb25maWcgbeG6t2MgxJHhu4tuaCBjaG8gYXBwIG7hur91IGNoxrBhIGPDsyB0cm9uZyBEQgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGNvbmZpZyBoaeG7h24gdOG6oWkgKGNo4buJIHJpw6puZyBj4bunYSBhcHAsIGtow7RuZyBtZXJnZSkKICAgICAgICAgICAgYXBwX2NvbmZpZ19rZXkgPSBmIntzZWxmLmFwcF9uYW1lfV9jb25maWciCiAgICAgICAgICAgIGN1cnJlbnRfYXBwX2NvbmZpZyA9IHNlbGYuZGIuZ2V0KGFwcF9jb25maWdfa2V5LCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FwcF9jb25maWc6CiAgICAgICAgICAgICAgICAjIENoxrBhIGPDsyBjb25maWcgcmnDqm5nIGNobyBhcHAsIGzGsHUgZGVmYXVsdAogICAgICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2V0X2FwcF9jb25maWcoc2VsZi5hcHBfbmFtZSwgc2VsZi5fZGVmYXVsdF9jb25maWcpCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGto4bufaSB04bqhbyBjb25maWcgbeG6t2MgxJHhu4tuaCBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBzdWNjZXNzCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIMSQw6MgY8OzIGNvbmZpZywga2nhu4NtIHRyYSB2w6AgYuG7lSBzdW5nIGPDoWMga2V5cyB0aGnhur91CiAgICAgICAgICAgICAgICB1cGRhdGVkID0gRmFsc2UKICAgICAgICAgICAgICAgIGZvciBrZXksIGRlZmF1bHRfdmFsdWUgaW4gc2VsZi5fZGVmYXVsdF9jb25maWcuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICBpZiBrZXkgbm90IGluIGN1cnJlbnRfYXBwX2NvbmZpZzoKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF9hcHBfY29uZmlnW2tleV0gPSBkZWZhdWx0X3ZhbHVlCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU3BlY2lhbCBjaGVjayBjaG8gYWN0aW9uX3dlaWdodHMKICAgICAgICAgICAgICAgIGlmICJhY3Rpb25fd2VpZ2h0cyIgaW4gY3VycmVudF9hcHBfY29uZmlnIGFuZCAiYWN0aW9uX3dlaWdodHMiIGluIHNlbGYuX2RlZmF1bHRfY29uZmlnOgogICAgICAgICAgICAgICAgICAgIGZvciBhY3Rpb24sIHdlaWdodCBpbiBzZWxmLl9kZWZhdWx0X2NvbmZpZ1siYWN0aW9uX3dlaWdodHMiXS5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY3Rpb24gbm90IGluIGN1cnJlbnRfYXBwX2NvbmZpZ1siYWN0aW9uX3dlaWdodHMiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfYXBwX2NvbmZpZ1siYWN0aW9uX3dlaWdodHMiXVthY3Rpb25dID0gd2VpZ2h0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkID0gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiB1cGRhdGVkOgogICAgICAgICAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNldF9hcHBfY29uZmlnKHNlbGYuYXBwX25hbWUsIGN1cnJlbnRfYXBwX2NvbmZpZykKICAgICAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgY29uZmlnIHRoaeG6v3UgY2hvIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgS2jDtG5nIGPhuqduIHVwZGF0ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraOG7n2kgdOG6oW8gZGVmYXVsdCBhcHAgY29uZmlnOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9taW5fYWN0aW9uc19wZXJfc2Vzc2lvbihzZWxmKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgc+G7kSBhY3Rpb24gdOG7kWkgdGhp4buDdSBt4buXaSBzZXNzaW9uIHThu6sgY29uZmlnCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBT4buRIGFjdGlvbiB04buRaSB0aGnhu4N1CiAgICAgICAgIiIiCiAgICAgICAgYXBwX2NvbmZpZyA9IHNlbGYuZ2V0X2FwcF9jb25maWcoKQogICAgICAgIHJldHVybiBhcHBfY29uZmlnLmdldCgibWluX2FjdGlvbnNfcGVyX3Nlc3Npb24iLCA1KQogICAgCiAgICBkZWYgZ2V0X3JhbmRvbV9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMoc2VsZikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4budaSBnaWFuIHNlc3Npb24gbmfhuqt1IG5oacOqbiB0cm9uZyBraG/huqNuZyBtaW4tbWF4IHThu6sgY29uZmlnCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUaOG7nWkgZ2lhbiBzZXNzaW9uIG5n4bqrdSBuaGnDqm4gKHBow7p0KQogICAgICAgICIiIgogICAgICAgIGFwcF9jb25maWcgPSBzZWxmLmdldF9hcHBfY29uZmlnKCkKICAgICAgICBtaW5fZHVyYXRpb24gPSBhcHBfY29uZmlnLmdldCgibWluX3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyIsIDMwKQogICAgICAgIG1heF9kdXJhdGlvbiA9IGFwcF9jb25maWcuZ2V0KCJtYXhfc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzIiwgNjApCiAgICAgICAgCiAgICAgICAgIyDEkOG6o20gYuG6o28gbWluIDw9IG1heAogICAgICAgIGlmIG1pbl9kdXJhdGlvbiA+IG1heF9kdXJhdGlvbjoKICAgICAgICAgICAgbWluX2R1cmF0aW9uLCBtYXhfZHVyYXRpb24gPSBtYXhfZHVyYXRpb24sIG1pbl9kdXJhdGlvbgogICAgICAgIAogICAgICAgIGltcG9ydCByYW5kb20KICAgICAgICByYW5kb21fZHVyYXRpb24gPSByYW5kb20ucmFuZGludChtaW5fZHVyYXRpb24sIG1heF9kdXJhdGlvbikKICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIlJhbmRvbSBzZXNzaW9uIGR1cmF0aW9uOiB7cmFuZG9tX2R1cmF0aW9ufSBwaMO6dCAocmFuZ2U6IHttaW5fZHVyYXRpb259LXttYXhfZHVyYXRpb259KSIpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJhbmRvbV9kdXJhdGlvbgogICAgCiAgICBkZWYgZ2V0X21pbl9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMoc2VsZikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4budaSBnaWFuIHThu5FpIHRoaeG7g3UgbeG7l2kgc2Vzc2lvbiB04burIGNvbmZpZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogVGjhu51pIGdpYW4gdOG7kWkgdGhp4buDdSAocGjDunQpCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X2NvbmZpZygibWluX3Nlc3Npb25fZHVyYXRpb25fbWludXRlcyIsIDMwKQogICAgCiAgICBkZWYgZ2V0X21heF9zZXNzaW9uX2R1cmF0aW9uX21pbnV0ZXMoc2VsZikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRo4budaSBnaWFuIHThu5FpIMSRYSBt4buXaSBzZXNzaW9uIHThu6sgY29uZmlnIChiYWNrd2FyZCBjb21wYXRpYmlsaXR5KQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogVGjhu51pIGdpYW4gdOG7kWkgxJFhIChwaMO6dCkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5nZXRfY29uZmlnKCJtYXhfc2Vzc2lvbl9kdXJhdGlvbl9taW51dGVzIiwgNjApCiAgICAKICAgIGRlZiBnZXRfYWN0aW9uX2RlbGF5X3JhbmdlKHNlbGYpIC0+IHR1cGxlW2ludCwgaW50XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBraG/huqNuZyBkZWxheSBnaeG7r2EgY8OhYyBhY3Rpb25zIHThu6sgY29uZmlnIChwcmlvcml0eTogYXBwIOKGkiBnbG9iYWwg4oaSIGRlZmF1bHQpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgdHVwbGVbaW50LCBpbnRdOiAobWluX2RlbGF5LCBtYXhfZGVsYXkpIHRyb25nIGdpw6J5CiAgICAgICAgIiIiCiAgICAgICAgIyBT4butIGThu6VuZyBnZXRfY29uZmlnIMSR4buDIGPDsyBwcmlvcml0eSBzeXN0ZW06IGFwcCDihpIgZ2xvYmFsIOKGkiBkZWZhdWx0CiAgICAgICAgbWluX2RlbGF5ID0gc2VsZi5nZXRfY29uZmlnKCJhY3Rpb25fZGVsYXlfbWluIiwgMikgICMgRGVmYXVsdDogMiBnacOieQogICAgICAgIG1heF9kZWxheSA9IHNlbGYuZ2V0X2NvbmZpZygiYWN0aW9uX2RlbGF5X21heCIsIDgpICAjIERlZmF1bHQ6IDggZ2nDonkKICAgICAgICByZXR1cm4gKG1pbl9kZWxheSwgbWF4X2RlbGF5KQogICAgCiAgICBkZWYgc2hvdWxkX3NraXBfam9iX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIGPDsyBuw6puIHNraXAgam9iIGFjdGlvbiBraMO0bmcgZOG7sWEgdHLDqm4gY29uZmlnIHbDoCB0cuG6oW5nIHRow6FpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuw6puIHNraXAgam9iIGFjdGlvbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFjdGlvbl93ZWlnaHRzIMSR4buDIHF1eeG6v3QgxJHhu4tuaCBjw7MgbMOgbSBqb2Iga2jDtG5nCiAgICAgICAgICAgIGFjdGlvbl93ZWlnaHRzID0gc2VsZi5nZXRfYWN0aW9uX3dlaWdodHMoKQogICAgICAgICAgICBqb2Jfd2VpZ2h0ID0gYWN0aW9uX3dlaWdodHMuZ2V0KCJqb2IiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBqb2Igd2VpZ2h0ID0gMCB0aMOsIHNraXAgam9iIGFjdGlvbgogICAgICAgICAgICBpZiBqb2Jfd2VpZ2h0ID09IDA6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDoWMgxJFp4buBdSBraeG7h24gam9iIHRoxrDhu51uZwogICAgICAgICAgICByZXR1cm4gbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtp4buDbSB0cmEgc2tpcCBqb2IgYWN0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBBbiB0b8OgbiAtIHNraXAgbuG6v3UgbOG7l2kKICAgIAogICAgZGVmIGdldF9zdXBwb3J0ZWRfYWN0aW9ucyhzZWxmKSAtPiBMaXN0W3N0cl06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGFuaCBzw6FjaCBow6BuaCDEkeG7mW5nIMSRxrDhu6NjIGjhu5cgdHLhu6MgYuG7n2kgYXBwIG7DoHkKICAgICAgICBBcHAgY8OzIHRo4buDIG92ZXJyaWRlIMSR4buDIGjhu5cgdHLhu6MgY8OhYyBow6BuaCDEkeG7mW5nIGtow6FjIG5oYXUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W3N0cl06IERhbmggc8OhY2ggYWN0aW9uIG5hbWVzIMSRxrDhu6NjIGjhu5cgdHLhu6MKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gbGlzdChzZWxmLmdldF9hY3Rpb25fd2VpZ2h0cygpLmtleXMoKSkKICAgIAogICAgZGVmIHBlcmZvcm1fYWN0aW9uKHNlbGYsIGFjdGlvbjogc3RyLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGjDoG5oIMSR4buZbmcgxJHGsOG7o2MgY2jhu4kgxJHhu4tuaCB24bubaSBjb25maWctYmFzZWQgbG9naWMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY3Rpb246IFTDqm4gaMOgbmggxJHhu5luZwogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFjdGlvbiBjw7MgxJHGsOG7o2MgaOG7lyB0cuG7oyBraMO0bmcKICAgICAgICAgICAgaWYgYWN0aW9uIG5vdCBpbiBzZWxmLmdldF9zdXBwb3J0ZWRfYWN0aW9ucygpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkFjdGlvbiAne2FjdGlvbn0nIGtow7RuZyDEkcaw4bujYyBo4buXIHRy4bujIGLhu59pIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjhu60gbMO9IMSR4bq3YyBiaeG7h3QgY2hvIGpvYiBhY3Rpb24gZOG7sWEgdHLDqm4gY29uZmlnCiAgICAgICAgICAgIGlmIGFjdGlvbiA9PSAiam9iIjoKICAgICAgICAgICAgICAgIGlmIHNlbGYuc2hvdWxkX3NraXBfam9iX2FjdGlvbihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU2tpcCBqb2IgYWN0aW9uIGNobyB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSB0aGVvIGNvbmZpZyIpCiAgICAgICAgICAgICAgICAgICAgIyBUaGF5IHRo4bq/IGLhurFuZyBhY3Rpb24ga2jDoWMgKGtow7RuZyBwaOG6o2kgam9iKQogICAgICAgICAgICAgICAgICAgIGFsdGVybmF0aXZlX2FjdGlvbiA9IHNlbGYuX2Nob29zZV9hbHRlcm5hdGl2ZV9hY3Rpb24oKQogICAgICAgICAgICAgICAgICAgIGlmIGFsdGVybmF0aXZlX2FjdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24ge2FsdGVybmF0aXZlX2FjdGlvbn0gdGhheSBjaG8gam9iIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucGVyZm9ybV9hY3Rpb24oYWx0ZXJuYXRpdmVfYWN0aW9uLCBhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIE7hur91IGtow7RuZyBjw7MgYWx0ZXJuYXRpdmUsIGNvaSBuaMawIHRow6BuaCBjw7RuZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSBn4buNaSBtZXRob2QgxJHhu5luZyBjaG8gYWN0aW9uIHTDuXkgY2jhu4luaCB0csaw4bubYwogICAgICAgICAgICBjdXN0b21fbWV0aG9kX25hbWUgPSBmInBlcmZvcm1fe2FjdGlvbn1fYWN0aW9uIgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsIGN1c3RvbV9tZXRob2RfbmFtZSk6CiAgICAgICAgICAgICAgICBjdXN0b21fbWV0aG9kID0gZ2V0YXR0cihzZWxmLCBjdXN0b21fbWV0aG9kX25hbWUpCiAgICAgICAgICAgICAgICBpZiBjYWxsYWJsZShjdXN0b21fbWV0aG9kKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU+G7rSBk4bulbmcgY3VzdG9tIG1ldGhvZCAne2N1c3RvbV9tZXRob2RfbmFtZX0nIGNobyBhY3Rpb24gJ3thY3Rpb259JyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN1c3RvbV9tZXRob2QoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTWFwcGluZyBjw6FjIGFjdGlvbnMgdOG7m2kgbWV0aG9kcyBjaHXhuqluCiAgICAgICAgICAgIHN0YW5kYXJkX2FjdGlvbl9tZXRob2RzID0gewogICAgICAgICAgICAgICAgIm5ld3NmZWVkIjogc2VsZi5wZXJmb3JtX25ld3NmZWVkX2FjdGlvbiwKICAgICAgICAgICAgICAgICJyZWVscyI6IHNlbGYucGVyZm9ybV9yZWVsc19hY3Rpb24sCiAgICAgICAgICAgICAgICAibm90aWZpY2F0aW9uIjogc2VsZi5wZXJmb3JtX25vdGlmaWNhdGlvbl9hY3Rpb24sCiAgICAgICAgICAgICAgICAicHJvZmlsZSI6IHNlbGYucGVyZm9ybV9wcm9maWxlX2FjdGlvbiwKICAgICAgICAgICAgICAgICJqb2IiOiBzZWxmLnBlcmZvcm1fam9iX2FjdGlvbiwKICAgICAgICAgICAgICAgICJleHBsb3JlIjogc2VsZi5wZXJmb3JtX2V4cGxvcmVfYWN0aW9uLAogICAgICAgICAgICAgICAgInNlYXJjaCI6IHNlbGYucGVyZm9ybV9zZWFyY2hfYWN0aW9uLAogICAgICAgICAgICAgICAgInBvc3QiOiBzZWxmLnBlcmZvcm1fcG9zdF9hY3Rpb24KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBtZXRob2QgdMawxqFuZyDhu6luZyB24bubaSBhY3Rpb24KICAgICAgICAgICAgYWN0aW9uX21ldGhvZCA9IHN0YW5kYXJkX2FjdGlvbl9tZXRob2RzLmdldChhY3Rpb24pCiAgICAgICAgICAgIGlmIG5vdCBhY3Rpb25fbWV0aG9kOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBtZXRob2QgY2hvIGFjdGlvbiAne2FjdGlvbn0nIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGFjdGlvbgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBhY3Rpb24gJ3thY3Rpb259JyBjaG8ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICByZXR1cm4gYWN0aW9uX21ldGhvZChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgdGjhu7FjIGhp4buHbiBhY3Rpb24gJ3thY3Rpb259Jzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfY2hvb3NlX2FsdGVybmF0aXZlX2FjdGlvbihzZWxmKSAtPiBPcHRpb25hbFtzdHJdOgogICAgICAgICIiIgogICAgICAgIENo4buNbiBhY3Rpb24gdGhheSB0aOG6vyBraGkga2jDtG5nIHRo4buDIGzDoG0gam9iCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBUw6puIGFjdGlvbiB0aGF5IHRo4bq/LCBob+G6t2MgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBhY3Rpb24gd2VpZ2h0cyBraMO0bmcgYmFvIGfhu5NtIGpvYgogICAgICAgICAgICBhY3Rpb25fd2VpZ2h0cyA9IHNlbGYuZ2V0X2FjdGlvbl93ZWlnaHRzKCkKICAgICAgICAgICAgYWx0ZXJuYXRpdmVfd2VpZ2h0cyA9IHtrOiB2IGZvciBrLCB2IGluIGFjdGlvbl93ZWlnaHRzLml0ZW1zKCkgaWYgayAhPSAiam9iIn0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBhbHRlcm5hdGl2ZV93ZWlnaHRzOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu41uIHJhbmRvbSB0aGVvIHdlaWdodAogICAgICAgICAgICBhY3Rpb25zID0gbGlzdChhbHRlcm5hdGl2ZV93ZWlnaHRzLmtleXMoKSkKICAgICAgICAgICAgd2VpZ2h0cyA9IGxpc3QoYWx0ZXJuYXRpdmVfd2VpZ2h0cy52YWx1ZXMoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNob3Nlbl9hY3Rpb24gPSByYW5kb20uY2hvaWNlcyhhY3Rpb25zLCB3ZWlnaHRzPXdlaWdodHMsIGs9MSlbMF0KICAgICAgICAgICAgcmV0dXJuIGNob3Nlbl9hY3Rpb24KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgY2jhu41uIGFsdGVybmF0aXZlIGFjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICJuZXdzZmVlZCIgICMgRmFsbGJhY2sgdG8gbmV3c2ZlZWQKICAgIAogICAgZGVmIGNhbGN1bGF0ZV9hY3Rpb25zX25lZWRlZF9mb3Jfc2Vzc2lvbihzZWxmLCBhY2NvdW50czogTGlzdFtEaWN0W3N0ciwgQW55XV0pIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUw61uaCB0b8OhbiBz4buRIGFjdGlvbnMgY+G6p24gdGhp4bq/dCBjaG8gc2Vzc2lvbiBk4buxYSB0csOqbiBjb25maWcgdsOgIHPhu5Egam9icyBjw7MgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBT4buRIGFjdGlvbnMgY+G6p24gdGjhu7FjIGhp4buHbiB0cm9uZyBzZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGNvbmZpZyBtaW4gYWN0aW9ucwogICAgICAgICAgICBtaW5fYWN0aW9ucyA9IHNlbGYuZ2V0X21pbl9hY3Rpb25zX3Blcl9zZXNzaW9uKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhur9tIHPhu5EgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIGpvYgogICAgICAgICAgICBqb2JfY2FwYWJsZV9hY2NvdW50cyA9IDAKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zaG91bGRfc2tpcF9qb2JfYWN0aW9uKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIGpvYl9jYXBhYmxlX2FjY291bnRzICs9IDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQmFzZSBhY3Rpb25zIGThu7FhIHRyw6puIHPhu5EgdMOgaSBraG/huqNuCiAgICAgICAgICAgICMgTeG7l2kgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIGpvYiBz4bq9IHTGsMahbmcg4bupbmcgduG7m2kgMi0zIGFjdGlvbnMKICAgICAgICAgICAgZGVmYXVsdF9hY3Rpb25zX3Blcl9hY2NvdW50ID0gMi41CiAgICAgICAgICAgIGFjdGlvbnNfZnJvbV9hY2NvdW50cyA9IGludChqb2JfY2FwYWJsZV9hY2NvdW50cyAqIGRlZmF1bHRfYWN0aW9uc19wZXJfYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgbWF4IGdp4buvYSBhY3Rpb25zIHThu6sgYWNjb3VudHMgdsOgIG1pbiBhY3Rpb25zCiAgICAgICAgICAgIHRvdGFsX2FjdGlvbnMgPSBtYXgoYWN0aW9uc19mcm9tX2FjY291bnRzLCBtaW5fYWN0aW9ucykKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw61uaCB0b8OhbiBhY3Rpb25zIGNobyBzZXNzaW9uOiB7am9iX2NhcGFibGVfYWNjb3VudHN9IGFjY291bnRzIGPDsyB0aOG7gyBsw6BtIHZp4buHYywgIgogICAgICAgICAgICAgICAgICAgICAgICAgICBmIntkZWZhdWx0X2FjdGlvbnNfcGVyX2FjY291bnR9IGFjdGlvbnMvYWNjb3VudCA9IHthY3Rpb25zX2Zyb21fYWNjb3VudHN9IGFjdGlvbnMgdOG7qyBhY2NvdW50cywgIgogICAgICAgICAgICAgICAgICAgICAgICAgICBmIm1pbiB7bWluX2FjdGlvbnN9ID0+IHRvdGFsIHt0b3RhbF9hY3Rpb25zfSBhY3Rpb25zIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0b3RhbF9hY3Rpb25zCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSB0w61uaCB0b8OhbiBhY3Rpb25zIG5lZWRlZDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIHNlbGYuZ2V0X21pbl9hY3Rpb25zX3Blcl9zZXNzaW9uKCkgICMgRmFsbGJhY2sKICAgIAogICAgZGVmIGNob29zZV93ZWlnaHRlZF9hY3Rpb24oc2VsZiwgZXhjbHVkZV9hY3Rpb25zOiBMaXN0W3N0cl0gPSBOb25lKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhu41uIGFjdGlvbiB0aGVvIHdlaWdodCB04burIGNvbmZpZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGV4Y2x1ZGVfYWN0aW9uczogRGFuaCBzw6FjaCBhY3Rpb25zIGPhuqduIGxv4bqhaSB0cuG7qwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IEFjdGlvbiDEkcaw4bujYyBjaOG7jW4KICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhY3Rpb25fd2VpZ2h0cyA9IHNlbGYuZ2V0X2FjdGlvbl93ZWlnaHRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG/huqFpIHRy4burIGFjdGlvbnMga2jDtG5nIG1vbmcgbXXhu5FuCiAgICAgICAgICAgIGlmIGV4Y2x1ZGVfYWN0aW9uczoKICAgICAgICAgICAgICAgIGFjdGlvbl93ZWlnaHRzID0ge2s6IHYgZm9yIGssIHYgaW4gYWN0aW9uX3dlaWdodHMuaXRlbXMoKSBpZiBrIG5vdCBpbiBleGNsdWRlX2FjdGlvbnN9CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWN0aW9uX3dlaWdodHM6CiAgICAgICAgICAgICAgICByZXR1cm4gIm5ld3NmZWVkIiAgIyBGYWxsYmFjawogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7jW4gcmFuZG9tIHRoZW8gd2VpZ2h0CiAgICAgICAgICAgIGFjdGlvbnMgPSBsaXN0KGFjdGlvbl93ZWlnaHRzLmtleXMoKSkKICAgICAgICAgICAgd2VpZ2h0cyA9IGxpc3QoYWN0aW9uX3dlaWdodHMudmFsdWVzKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICBjaG9zZW5fYWN0aW9uID0gcmFuZG9tLmNob2ljZXMoYWN0aW9ucywgd2VpZ2h0cz13ZWlnaHRzLCBrPTEpWzBdCiAgICAgICAgICAgIHJldHVybiBjaG9zZW5fYWN0aW9uCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGNo4buNbiB3ZWlnaHRlZCBhY3Rpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAibmV3c2ZlZWQiICAjIEZhbGxiYWNrCiAgICAKICAgIGRlZiBwZXJmb3JtX2pvYl9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBow6BuaCDEkeG7mW5nIGzDoG0gam9iIC0gQ29tcGxldGUgam9iIHByb2Nlc3NpbmcgcGlwZWxpbmUKICAgICAgICAKICAgICAgICBQaXBlbGluZToKICAgICAgICAxLiBWYWxpZGF0ZSBHb0xpa2UgaGVhZGVycwogICAgICAgIDIuIFZhbGlkYXRlIGFjY291bnQgY2FuIHJ1biBqb2IKICAgICAgICAzLiBGZXRjaCBqb2IgZnJvbSBHb0xpa2UgIAogICAgICAgIDQuIFVwZGF0ZSBkZXZpY2UgbWVzc2FnZQogICAgICAgIDUuIFZhbGlkYXRlIGpvYiBiZWZvcmUgZXhlY3V0aW9uCiAgICAgICAgNi4gRXhlY3V0ZSBqb2IKICAgICAgICA3LiBSZXBvcnQgam9iIHJlc3VsdCB0byBHb0xpa2UKICAgICAgICA4LiBVcGRhdGUgam9iIHN0YXRpc3RpY3MKICAgICAgICAKICAgICAgICBBcHAgY8OzIHRo4buDIG92ZXJyaWRlIMSR4buDIGPDsyBsb2dpYyBsw6BtIGpvYiByacOqbmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTMOgbSBqb2IgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDA6IEtp4buDbSB0cmEgeMOhYyB0aOG7sWMgR29MaWtlCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmlzX2dvbGlrZV9hdXRoZW50aWNhdGVkKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQsaw4bubYyAxOiBLaeG7g20gdHJhIGPDsyB0aOG7gyBsw6BtIGpvYiBraMO0bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkFjY291bnQge3VzZXJuYW1lfSBraMO0bmcgdGjhu4MgbMOgbSBqb2IiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogRmV0Y2ggam9iIHThu6sgR29MaWtlCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJM4bqleSBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgam9iID0gc2VsZi5mZXRjaF9qb2IoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgbOG6pXkgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDM6IEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZSBjaG8gam9iCiAgICAgICAgICAgIHNlbGYudXBkYXRlX2RldmljZV9tZXNzYWdlX2Zvcl9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IFZhbGlkYXRlIGpvYgogICAgICAgICAgICBpZiBub3Qgc2VsZi52YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKGFjY291bnQsIGpvYik6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSm9iIGtow7RuZyBo4bujcCBs4buHIGhv4bq3YyDEkcOjIHNraXAgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDU6IFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtqb2IuZ2V0KCd0eXBlJywgJ3Vua25vd24nKX0iKQogICAgICAgICAgICBqb2JfcmVzdWx0ID0gc2VsZi5leGVjdXRlX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgam9iX3Jlc3VsdDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIG5o4bqtbiDEkcaw4bujYyBr4bq/dCBxdeG6oyBqb2IgdOG7qyBoYW5kbGVyIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDY6IELDoW8gY8OhbyBr4bq/dCBxdeG6oyB24buBIEdvTGlrZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCBqb2JfcmVzdWx0KQogICAgICAgICAgICAgICAgc3VjY2VzcyA9IGpvYl9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBiw6FvIGPDoW8gam9iIGNobyB7dXNlcm5hbWV9OiBzdWNjZXNzPXtzdWNjZXNzfSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBiw6FvIGPDoW8gam9iIGNobyB7dXNlcm5hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDc6IEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IKICAgICAgICAgICAgc3VjY2VzcyA9IGpvYl9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpCiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9qb2Jfc3RhdHMoYWNjb3VudCwgc3VjY2Vzcywgam9iX3R5cGUsIGpvYl9yZXN1bHQpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gc3VjY2VzcwogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgbMOgbSBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSBqb2Iga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgbMOgbSBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgICAgICBhY2NvdW50X3N0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgaW4gWyJkaXNhYmxlZCIsICJsb2dvdXQiXToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBpbmFjdGl2ZSwga2nhu4NtIHRyYSBqb2JfZGlzYWJsZV91bnRpbAogICAgICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPiB0aW1lLnRpbWUoKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gS2nhu4NtIHRyYSBqb2JfZW5hYmxlCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAzLiBLaeG7g20gdHJhIMSRw6MgbGnDqm4ga+G6v3QgR29MaWtlIChj4bqnbiBjaG8gam9icykKICAgICAgICAgICAgaWYgbm90IGFjY291bnQuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDQuIEtp4buDbSB0cmEgxJHDoyBsb2dpbgogICAgICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGRhaWx5CiAgICAgICAgICAgIGRhaWx5X2xpbWl0ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMTAwKQogICAgICAgICAgICBkYWlseV9jb3VudCA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgICAgICBpZiBkYWlseV9jb3VudCA+PSBkYWlseV9saW1pdDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGtp4buDbSB0cmEgY2FuIHJ1biBqb2I6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3ZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIGpvYiB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbgogICAgICAgIEFwcCBjw7MgdGjhu4Mgb3ZlcnJpZGUgxJHhu4MgY8OzIGxvZ2ljIHZhbGlkYXRlIHJpw6puZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBqb2IgaOG7o3AgbOG7hwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBzZWxmLnZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYikKICAgICAgICAgICAgaWYgbm90IHZhbGlkYXRpb25fcmVzdWx0LmdldCgidmFsaWQiLCBUcnVlKToKICAgICAgICAgICAgICAgIGlmIHZhbGlkYXRpb25fcmVzdWx0LmdldCgic2hvdWxkX3NraXAiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlNraXAgam9iIHRoZW8gecOqdSBj4bqndSB2YWxpZGF0aW9uIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hyB0aGVvIHZhbGlkYXRpb24iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgdmFsaWRhdGUgam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBUaeG6v3AgdOG7pWMgbuG6v3UgdmFsaWRhdGUgbOG7l2kKICAgIAogICAgZGVmIHVwZGF0ZV9kZXZpY2VfbWVzc2FnZV9mb3Jfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgZGV2aWNlIG1lc3NhZ2UgY2hvIGpvYiBoaeG7h24gdOG6oWkKICAgICAgICBBcHAgY8OzIHRo4buDIG92ZXJyaWRlIMSR4buDIGN1c3RvbSBtZXNzYWdlIGZvcm1hdAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxpbmsgPSBqb2IuZ2V0KCdsaW5rJywgJycpCiAgICAgICAgICAgICMgQ2xlYW4gdXAgbGluayDEkeG7gyBoaeG7g24gdGjhu4sgbmfhuq9uIGfhu41uIGjGoW4KICAgICAgICAgICAgaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycpOgogICAgICAgICAgICAgICAgbGluayA9IGxpbmsucmVwbGFjZSgnaHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS8nLCAnJykKICAgICAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy50aWt0b2suY29tLycsICcnKQogICAgICAgICAgICAKICAgICAgICAgICAgbWVzc2FnZSA9IGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZSB0aMO0bmcgcXVhIGRiIHNlcnZpY2UKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIG1lc3NhZ2UpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZToge2V9IikKICAgIAogICAgZGVmIHZhbGlkYXRlX2pvYl93aXRoX2hhbmRsZXIoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgam9iIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duIC0gc+G7rSBk4bulbmcgYWJzdHJhY3QgbWV0aG9kIHZhbGlkYXRpb24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGPhuqduIHNraXAgaG/hurdjIGNvbnRpbnVlCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB2YWxpZGF0aW9uX3Jlc3VsdCA9IHNlbGYudmFsaWRhdGVfam9iX2JlZm9yZV9leGVjdXRpb24oYWNjb3VudCwgam9iKQogICAgICAgICAgICBpZiBub3QgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJ2YWxpZCIsIFRydWUpOgogICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAjIFNraXAgam9iCiAgICAgICAgICAgICAgICAgICAgc2tpcF9tZXNzYWdlID0gdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIkpvYiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlNraXAgam9iOiB7c2tpcF9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIEdoaSBs4bqhaSBoaXN0b3J5IGNobyBqb2IgYuG7iyBza2lwCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHNraXBfbWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAjIELDoW8gc2tpcCBqb2IgduG7gSBHb0xpa2UKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiU2tpcCBqb2IgbOG7l2k6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBTbGVlcCBuZ+G6r24gxJHhu4MgdHLDoW5oIHNwYW0KICAgICAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zbGVlcF9mdW5jKHNraXBfc2xlZXBfdGltZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hzoge3ZhbGlkYXRpb25fcmVzdWx0LmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIHZhbGlkYXRlIGpvYjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgVGnhur9wIHThu6VjIG7hur91IHZhbGlkYXRlIGzhu5dpCiAgICAKICAgIGRlZiB1cGRhdGVfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sLCBqb2JfdHlwZTogc3RyLCBqb2JfcmVzdWx0OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYiAtIGFwcCBjw7MgdGjhu4Mgb3ZlcnJpZGUgxJHhu4MgY3VzdG9tIGxvZ2ljCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc3VjY2VzczogSm9iIGPDsyB0aMOgbmggY8O0bmcga2jDtG5nCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iCiAgICAgICAgICAgIGpvYl9yZXN1bHQ6IEvhur90IHF14bqjIGpvYgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgIyBUxINuZyBqb2IgY291bnQgY2hvIGFjY291bnQKICAgICAgICAgICAgICAgIGN1cnJlbnRfY291bnQgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICAgICAgICAgIG5ld19jb3VudCA9IGN1cnJlbnRfY291bnQgKyAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMSDbmcgdG90YWwgam9icwogICAgICAgICAgICAgICAgY3VycmVudF90b3RhbCA9IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkKICAgICAgICAgICAgICAgIG5ld190b3RhbCA9IGN1cnJlbnRfdG90YWwgKyAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGpvYiBjb3VudCB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IG5ld19jb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBuZXdfdG90YWwsCiAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJD4bqtcCBuaOG6rXQgam9iIGNvdW50IGNobyBhY2NvdW50IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9OiB0b2RheT17bmV3X2NvdW50fSwgdG90YWw9e25ld190b3RhbH0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBj4bqtcCBuaOG6rXQgam9iIHN0YXRzOiB7ZX0iKQ==').decode('utf-8'))
