import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKZnJvbSBzZXJ2aWNlcy5wcm94eV9zZXJ2aWNlIGltcG9ydCBQcm94eVNlcnZpY2UKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19TRVNTSU9OID0gIsSQYW5nIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYyIKICAgIE1TR19TRVNTSU9OX0NPT0xET1dOID0gIk5naOG7iSBuZ8ahaSBnaeG7r2EgY8OhYyBwaGnDqm4iCiAgICAKICAgICMgQWNjb3VudCBzdGF0dXMgcmVhc29ucwogICAgUkVBU09OX0RBSUxZX0xJTUlUID0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiCiAgICBSRUFTT05fU0VTU0lPTl9MSU1JVCA9ICLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIHBoacOqbiIKICAgIFJFQVNPTl9GT0xMT1dfU0VTU0lPTl9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbGxvdyB0cm9uZyBwaGnDqm4iCgpjbGFzcyBKb2JTZXJ2aWNlOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSwgbXF0dF9zZXJ2aWNlPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGJfc2VydmljZTogRGF0YWJhc2VTZXJ2aWNlIMSR4buDIGzGsHUgdHLhu68gZOG7ryBsaeG7h3UKICAgICAgICAgICAgaGVscGVyX3NlcnZpY2U6IEhlbHBlclNlcnZpY2UgxJHhu4MgdMawxqFuZyB0w6FjIHbhu5tpIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBnb2xpa2Vfc2VydmljZTogR29MaWtlU2VydmljZSDEkeG7gyBn4buNaSBBUEkgR29MaWtlCiAgICAgICAgICAgIG1xdHRfc2VydmljZTogTVFUVFNlcnZpY2UgxJHhu4MgZ+G7rWkgdGjDtG5nIGLDoW8gKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHNlbGYuZGIgPSBkYl9zZXJ2aWNlCiAgICAgICAgc2VsZi5oZWxwZXIgPSBoZWxwZXJfc2VydmljZQogICAgICAgIHNlbGYuZ29saWtlX3NlcnZpY2UgPSBnb2xpa2Vfc2VydmljZQogICAgICAgIHNlbGYubXF0dF9zZXJ2aWNlID0gbXF0dF9zZXJ2aWNlCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaOG7n2kgdOG6oW8gUHJveHlTZXJ2aWNlCiAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlID0gUHJveHlTZXJ2aWNlKGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlKQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLmpvYl9oYW5kbGVycyA9IHt9CiAgICAgICAgCiAgICAgICAgIyBGbGFnIMSRaeG7gXUga2hp4buDbgogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgVGjDtG5nIHRpbiB24buBIGPDoWMgYXBwIMSRxrDhu6NjIGvDrWNoIGhv4bqhdCAtIGzhuqV5IHThu6sgZGF0YWJhc2UgaG/hurdjIGNvbmZpZwogICAgICAgIHNlbGYuZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBMb2NrIMSR4buDIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpCiAgICAgICAgc2VsZi5fbG9jayA9IHRocmVhZGluZy5Mb2NrKCkKICAgICAgICAKICAgICAgICAjIERpY3Rpb25hcnkgxJHhu4MgbMawdSBz4buRIGzhuqduIHRo4butIGpvYiB0aOG6pXQgYuG6oWkgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBqb2IgZm9sbG93IHRy4bqjIHbhu4Egc3RhdHVzIDQgKHBlbmRpbmcpCiAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMgPSB7fQogICAgICAgIAogICAgICAgICMgVGjhu51pIGdpYW4ga+G6v3QgdGjDumMgcGhpw6puIHByb3h5CiAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgIAogICAgICAgICMgVHLhuqFuZyB0aMOhaSBj4bqtcCBuaOG6rXQgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQKICAgICAgICBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbiA9IEZhbHNlICAjIEPhuqduIHJlc3RhcnQgc2Vzc2lvbiBkbyBjb25maWcgdGhheSDEkeG7lWkKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMga2hpIGZvcmNlX3N0b3AgxJHGsOG7o2MgxJHhurd0IHRow6BuaCBUcnVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGNoZWNrX2ludGVydmFsID0gSm9iU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMICAjIEtp4buDbSB0cmEgbeG7l2kgMC41IGdpw6J5CiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyB5w6p1IGPhuqd1IGThu6tuZyBob+G6t2MgcmVzdGFydCBzZXNzaW9uCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgIyBO4bq/dSBjw7MgecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24sIHRob8OhdCBraOG7j2kgc2xlZXAgbmdheSBs4bqtcCB04bupYwogICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE5n4bunIG3hu5l0IGtob+G6o25nIG5n4bqvbgogICAgICAgICAgICBzbGVlcF90aW1lID0gbWluKGNoZWNrX2ludGVydmFsLCBzZWNvbmRzIC0gKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkpCiAgICAgICAgICAgIGlmIHNsZWVwX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChzbGVlcF90aW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSBIZWxwZXJTZXJ2aWNlCiAgICAgICAgaGVscGVyX3N1Y2Nlc3MsIGhlbHBlcl9kYXRhID0gdXRpbHMuY2hlY2tfaGVscGVyX3NlcnZpY2Uoc2VsZi5oZWxwZXIpCiAgICAgICAgaWYgbm90IGhlbHBlcl9zdWNjZXNzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBr4bq/dCBu4buRaSDEkeG6v24gSGVscGVyU2VydmljZS4gVnVpIGzDsm5nIGtp4buDbSB0cmEgbOG6oWkuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyBu4bq/dSBjw7MKICAgICAgICBpZiBoZWxwZXJfZGF0YSBhbmQgImRhdGEiIGluIGhlbHBlcl9kYXRhOgogICAgICAgICAgICBzZWxmLmRiLnNhdmVfZGV2aWNlX2luZm8oaGVscGVyX2RhdGEpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBsxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLOiB7aGVscGVyX2RhdGFbJ2RhdGEnXS5nZXQoJ2RldmljZV9tb2RlbCcsICdVbmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICMgMy4gTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MKICAgICAgICBzZWxmLl9zYXZlX2RlZmF1bHRfY29uZmlncygpCiAgICAgICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgICMgNS4gS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLl9pbml0X2pvYl9oYW5kbGVycygpCiAgICAgICAgCiAgICAgICAgIyA2LiBLaOG7n2kgdOG6oW8gbmfDoHkgY3Xhu5FpIGPDuW5nIMSRw6MgcmVzZXQgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICAKICAgICAgICBpZiBub3QgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgIyBO4bq/dSBoaeG7h24gdOG6oWkgxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXksIMSRw6FuaCBk4bqldSDEkcOjIHJlc2V0CiAgICAgICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lOgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gdG9kYXkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTuG6v3UgY2jGsGEgxJHhur9uIGdp4budIHJlc2V0LCDEkcOhbmggZOG6pXUgbMOgIMSRw6MgcmVzZXQgbmfDoHkgaMO0bSBxdWEKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5IC0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgbGFzdF9yZXNldF9kYXRlLmlzb2Zvcm1hdCgpKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkto4bufaSB04bqhbyBuZ8OgeSByZXNldDoge2xhc3RfcmVzZXRfZGF0ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmc6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgCiAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IFRydWUKICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIEpvYlNlcnZpY2UgdGjDoG5oIGPDtG5nLiIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6p24gxJHhu5NuZyBi4buZIGzhuqFpLCBGYWxzZSBu4bq/dSBraMO0bmcgY+G6p24KICAgICAgICAiIiIKICAgICAgICAjIEzhuqV5IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgZGF0YWJhc2UKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgc3luY19zdGF0dXMgPSBzZWxmLmRiLmdldChzeW5jX3N0YXR1c19rZXksIEZhbHNlKSAgIyBN4bq3YyDEkeG7i25oIGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICAjIE7hur91IGNoxrBhIMSR4buTbmcgYuG7mSB0aMOsIGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaQogICAgICAgIHJldHVybiBub3Qgc3luY19zdGF0dXMKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgc3RhdHVzOiBib29sID0gVHJ1ZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgc3RhdHVzOiBUcnVlIG7hur91IMSRw6MgxJHhu5NuZyBi4buZLCBGYWxzZSBu4bq/dSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAiIiIKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICBzZWxmLmRiLnNldChzeW5jX3N0YXR1c19rZXksIHN0YXR1cykKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiB7c3RhdHVzfSIpCiAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudHNfZm9yX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCB0w6BpIGtob+G6o24gR29MaWtlIGNobyBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiDEkeG7k25nIGLhu5kKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkeG7k25nIGLhu5kgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKCiAgICAgICAgICAgICMgMS4gxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4buTbmcgYuG7mSB7bGVuKGFjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBUcnVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIEZhbHNlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MiIiIKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gdGjhu51pIGdpYW4gbMOgbSBqb2IKICAgICAgICAgICAgImpvYl9ob3VyIjogY29uZmlnLkpPQl9IT1VSLAogICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIFRo4budaSBnaWFuIGNo4budIChwaMO6dCkga2hpIGtow7RuZyB0w6xtIHRo4bqleSBqb2IgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLhuqFuZyB0aMOhaSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgInBhdXNlX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdGhp4bq/dCBi4buLIMSRYW5nIGzDoG0gdmnhu4djCiAgICAgICAgICAgICJkZXZpY2VfaXNfd29ya2luZyI6IEZhbHNlLAogICAgICAgICAgICAiZGV2aWNlX21lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRGFuaCBzw6FjaCBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQKICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IGNvbmZpZy5FTkFCTEVEX0FQUFMsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRoaeG6v3QgbOG6rXAgY2hvIHBow6lwIGNoxINtIHPDs2Mga2hpIGzDoG0gam9iCiAgICAgICAgICAgICJjYXJlX2luX3dvcmtpbmdfam9iIjogRmFsc2UsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGdpw6EgdOG7kWkgdGhp4buDdSBjaG8gam9iIGZvbGxvdwogICAgICAgICAgICAibWluX2ZvbGxvd19wcmljZSI6IDIwLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBwcm94eQogICAgICAgICAgICAidXNlX3Byb3h5IjogRmFsc2UsICAjIEPDsyBz4butIGThu6VuZyBwcm94eSBraMO0bmcKICAgICAgICAgICAgInByb3h5X3NlcnZlciI6ICJodHRwOi8vMTAuMC4wLjU6OTAzMiIsICAjIFNlcnZlciBwcm94eSBt4bq3YyDEkeG7i25oCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRlZmF1bHRfY29uZmlncy5pdGVtcygpOgogICAgICAgICAgICAjIENo4buJIGzGsHUgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KGtleSkgaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOjIGzGsHUgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaDoge2tleX09e3ZhbHVlfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJD4bqldSBow6xuaCB7a2V5fSDEkcOjIHThu5NuIHThuqFpOiB7c2VsZi5kYi5nZXQoa2V5KX0iKQogICAgICAgIAogICAgZGVmIF9pbml0X2pvYl9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlciIiIgogICAgICAgICMgaW5pdCB0aMOsIHPhur0gaW5pdCBoYW5kbGVycyBjaG8gdOG6pXQgY+G6oyBjw6FjIGFwcCwgbMOgbSBhcHAgbsOgbyB0aMOsIHPhur0gdGhlbyBj4bqldSBow6xuaCBs4bqleSB04burIGRhdGFiYXNlCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGNvbmZpZy5FTkFCTEVEX0FQUFM6CiAgICAgICAgICAgIGlmIGFwcF9uYW1lID09ICJ0aWt0b2siOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6AgcHJveHlfc2VydmljZSB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gImluc3RhZ3JhbSI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBJbnN0YWdyYW1Kb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoCBwcm94eV9zZXJ2aWNlIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBraOG7n2kgdOG6oW8ge2xlbihzZWxmLmpvYl9oYW5kbGVycyl9IGpvYiBoYW5kbGVyOiB7JywgJy5qb2luKHNlbGYuam9iX2hhbmRsZXJzLmtleXMoKSl9IikKICAgICAgICAKICAgIGRlZiBfcmVzZXRfZGFpbHlfY291bnRlcnMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgdsOgbyBnaeG7nSDEkcaw4bujYyBj4bqldSBow6xuaCIiIgogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBnaeG7nSByZXNldCB04burIGPhuqV1IGjDrG5oIGhv4bq3YyB04burIGRhdGFiYXNlIG7hur91IGPDswogICAgICAgIGpvYl9ob3VyID0gc2VsZi5kYi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgIAogICAgICAgICMgVMOtbmggdGjhu51pIMSRaeG7g20gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgaWYgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gZGF0ZXRpbWUuZGF0ZS5mcm9taXNvZm9ybWF0KGxhc3RfcmVzZXRfZGF0ZV9zdHIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYixJDhu4tuaCBk4bqhbmcgbmfDoHkgcmVzZXQga2jDtG5nIGjhu6NwIGzhu4c6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIHF1YSBnaeG7nSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heSBjaMawYSB2w6AgY2jGsGEgcmVzZXQgdHJvbmcgbmfDoHkgaMO0bSBuYXkKICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZSBhbmQgKGxhc3RfcmVzZXRfZGF0ZSBpcyBOb25lIG9yIGxhc3RfcmVzZXRfZGF0ZSA8IHRvZGF5KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IChnaeG7nSByZXNldDoge2pvYl9ob3VyfTowMCkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGLhu5kgxJHhur9tIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbgogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBz4buRIGpvYiBow7RtIG5heSB2w6Agc+G7kSBqb2IgdHJvbmcgcGhpw6puCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImxhc3Rfdmlld19zdG9yaWVzIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHbDrCDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5LAogICAgICAgICAgICAgICAgICAgICMgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgdGjDoG5oIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAiaW5hY3RpdmUiIGFuZCBhY2NvdW50LmdldCgiaW5hY3RpdmVfcmVhc29uIikgPT0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBhY3RpdmUgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBzYXUga2hpIHJlc2V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6BvIHtub3cuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG5nw6B5IMSRw6MgcmVzZXQgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkuaXNvZm9ybWF0KCkpCiAgICAgICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBjaOG6oXkgam9iIGNobyB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgY2jhuqF5IGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMi4gS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBj4bqnbiB0aGnhur90CiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMy4gxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5CiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4KICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIGpvYiB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0ixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuIGPhu6dhIHTDoGkga2hv4bqjbiIiIgogICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIGLhu4sgZGlzYWJsZWQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJkaXNhYmxlZCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dCwga2jDtG5nIGNobyBjaOG6oXkgam9iCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImxvZ291dCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyBpbmFjdGl2ZSwga2nhu4NtIHRyYSB0aOG7nWkgZ2lhbiBjb29sZG93bgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJY4butIGzDvSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiIiIKICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjb29sZG93biwgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSB0aW1lLnRpbWUoKToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICJsYXN0X2NhcmVfdGltZSI6IDAsCiAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBGYWxzZSwKICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBDaMawYSBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBjb29sZG93bl9yZW1haW4gPSBpbnQoKGpvYl9kaXNhYmxlX3VudGlsIC0gdGltZS50aW1lKCkpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50gKGPDsm4ge2Nvb2xkb3duX3JlbWFpbn0gcGjDunQpIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYQogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiBj4bunYSB0w6BpIGtob+G6o24gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcCB24bubaSBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgaWYgYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0gPSBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIGpvYl9tYXhfZGF5CiAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImpvYl9tYXhfZGF5Il0gPSBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgIGlmIHVwZGF0ZV9kYXRhOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOzbmcgYXBwIHTGsMahbmcg4bupbmcgduG7m2kgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBjb25maWcuQVBQX1BBQ0tBR0VTOgogICAgICAgICAgICBzZWxmLmhlbHBlci5jbG9zZV9hcHAoY29uZmlnLkFQUF9QQUNLQUdFU1thcHBfbmFtZV0pCiAgICAgICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgcmV0dXJuIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheQogICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICByZXR1cm4gam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2pvYl9zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgc3VjY2VzczogYm9vbCA9IFRydWUsIGpvYl90eXBlOiBzdHIgPSBOb25lKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc3VjY2VzczogVHJ1ZSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgam9iX3R5cGU6IExv4bqhaSBqb2IgKGZvbGxvdywgbGlrZSwgZXRjLikKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBqb2IgY8ahIGLhuqNuCiAgICAgICAgc2VsZi5fdXBkYXRlX2Jhc2ljX2pvYl9zdGF0cyhhY2NvdW50LCBzdWNjZXNzKQogICAgICAgIAogICAgICAgICMgUmVzZXQgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIG7hur91IGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgCiAgICAgICAgIyDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcAogICAgICAgIGFjY291bnQgPSBzZWxmLl9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB44butIGzDvSBnaeG7m2kgaOG6oW4gcGhpw6puCiAgICAgICAgc2VsZi5fY2hlY2tfc2Vzc2lvbl9saW1pdF9hZnRlcl9qb2IoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeQogICAgICAgIHNlbGYuX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihhY2NvdW50KQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gdGjhu5FuZyBrw6ogcmnDqm5nIGNobyBqb2IgZm9sbG93CiAgICAgICAgaWYgc3VjY2VzcyBhbmQgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9mb2xsb3dfc3RhdHMoYWNjb3VudCkKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wpOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IgY8ahIGLhuqNuIC0gY2jhu4kgxJHhur9tIGpvYiB0aMOgbmggY8O0bmciIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIENo4buJIHTEg25nIGNvdW50ZXJzIGtoaSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgdXBkYXRlX2RhdGEudXBkYXRlKHsKICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiBqb2JfdG9kYXkgKyAxLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogam9ic19kb25lX2luX3Nlc3Npb24gKyAxLAogICAgICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBhY2NvdW50LmdldCgidG90YWxfam9icyIsIDApICsgMQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKSAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgZGF0YQogICAgICAgIAogICAgZGVmIF9jaGVja19zZXNzaW9uX2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gcGhpw6puIHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIHttYXhfam9ic19wZXJfc2Vzc2lvbn0gam9iIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPSLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5IHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5ICh7am9iX3RvZGF5fS97am9iX21heF9kYXl9KSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfc2V0X2FjY291bnRfbG9nb3V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgdXNlcm5hbWU6IHN0ciA9IE5vbmUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICB1c2VybmFtZTogVXNlcm5hbWUgxJHhu4MgbG9nIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVOG6oW8gbWVzc2FnZSB24bubaSBuZ8OgeSBnaeG7nSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgICAgIGxvZ291dF9tZXNzYWdlID0gZiJQaMOhdCBoaeG7h24gbG9nb3V0OiB7Y3VycmVudF90aW1lfSIKICAgICAgICAgICAgCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGxvZ291dF9tZXNzYWdlLAogICAgICAgICAgICAgICAgImxhc3Rfam9iX3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkcOhbmggZOG6pXUgdMOgaSBraG/huqNuIHt1c2VybmFtZSBvciBhY2NvdW50X2lkfSBsw6AgbG9nb3V0IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBsb2dvdXQgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWUgb3IgYWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBsb2dvdXQ6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfZm9sbG93X3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogcmnDqm5nIGNobyBmb2xsb3cgam9iIHRow6BuaCBjw7RuZyAoxJHDoyBi4buPIGdp4bubaSBo4bqhbiBmb2xsb3cpIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKSArIDEKICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApICsgMQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHPhu5EgbGnhu4d1IGZvbGxvdyB0aMOgbmggY8O0bmcKICAgICAgICB1cGRhdGVfZm9sbG93ID0gewogICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogZm9sbG93X3RvZGF5LAogICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiBmb2xsb3dfaW5fc2Vzc2lvbiwKICAgICAgICAgICAgImxhc3RfZm9sbG93X3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBGYWxzZSwgICMgTHXDtG4gbHXDtG4gxJHhu4MgRmFsc2UgdsOsIMSRw6MgYuG7jyBnaeG7m2kgaOG6oW4KICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0KICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9mb2xsb3cpCiAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIHRo4buxYyBoaeG7h24gZm9sbG93IHRow6BuaCBjw7RuZyAoe2ZvbGxvd190b2RheX0gZm9sbG93IGjDtG0gbmF5KSIpCiAgICAgICAgCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIMSR4buZbmcgSm9iU2VydmljZSB0cm9uZyB0aHJlYWQgcmnDqm5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgdGhyZWFkaW5nLlRocmVhZDogVGhyZWFkIMSRYW5nIGNo4bqheSBKb2JTZXJ2aWNlIGhv4bq3YyBOb25lIG7hur91IGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bq3dCB0cuG6oW5nIHRow6FpIHJ1bm5pbmcKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aHJlYWQKICAgICAgICAgICAgdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5ydW4pCiAgICAgICAgICAgIHRocmVhZC5kYWVtb24gPSBUcnVlCiAgICAgICAgICAgIHRocmVhZC5zdGFydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdGhyZWFkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgSm9iU2VydmljZSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgZGVmIHJlc2V0X2luYWN0aXZlX2FjY291bnRzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24g4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgaW5hY3RpdmVfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUsIHN0YXR1cz0iaW5hY3RpdmUiKSBvciBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBpbmFjdGl2ZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPD0gY3VycmVudF90aW1lOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsic3RhdHVzIjogImFjdGl2ZSIsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoam9iX2Rpc2FibGVfdW50aWwgLSBjdXJyZW50X3RpbWUpIC8gNjApCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjw7JuIHtyZW1haW5pbmdfbWludXRlc30gcGjDunQg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyB0w6BpIGtob+G6o24gaW5hY3RpdmUiKQogICAgICAgICAgICAKICAgIGRlZiByZXNldF9sb2dvdXRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgcmVzZXQgY8OhYyB0w6BpIGtob+G6o24gbG9nb3V0IHbhu4EgYWN0aXZlIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgQ2jhu4kgbsOqbiBn4buNaSBtZXRob2QgbsOgeSBraGkgY8OzIHnDqnUgY+G6p3UgxJHhurdjIGJp4buHdCB04burIGFkbWluCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24g4bufIHRy4bqhbmcgdGjDoWkgbG9nb3V0CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ291dF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJsb2dvdXQiKSBvciBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBsb2dvdXRfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCB0w6BpIGtob+G6o24gbG9nb3V0IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQiKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTpzdHIgKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgY2jhuqF5IGpvYiBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgaWYoc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBDaOG6oXkgSm9iU2VydmljZSB0cm9uZyBt4buZdCB2w7JuZyBs4bq3cCB24bubaSBsb2dpYyBsw6BtIHZp4buHYyB0aGVvIHBoacOqbgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmlzX2luaXRpYWxpemVkOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5pbml0aWFsaXplKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4gS2jDtG5nIHRo4buDIGNo4bqheS4iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBjaOG6oXkgSm9iU2VydmljZSB24bubaSBsb2dpYyBsw6BtIHZp4buHYyB0aGVvIHBoacOqbi4uLiIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGRldmljZV9pZAogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQgaGnhu4duIHThuqFpLCBKb2JTZXJ2aWNlIGtow7RuZyB0aOG7gyBjaOG6oXkiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgd2hpbGUgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAjIFJlc2V0IGJp4bq/biBmb3JjZV9zdG9wIG7hur91IGPDswogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyLCB04bqhbSBk4burbmcgeOG7rSBsw70gam9iIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOaOG6oyBwcm94eSBuZ2F5IGtoaSBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGRvIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX1BBVVNFRF9TRVJWRVIpCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldCgiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBwaOG6o2kgZG8gZm9yY2VfcmVzdGFydF9zZXNzaW9uIGtow7RuZwogICAgICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IGzDoCByZXN0YXJ0IHNlc3Npb24sIHRp4bq/cCB04bulYyB2w7JuZyBs4bq3cCB0aGF5IHbDrCBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyBwaOG6o2kgcmVzdGFydCBzZXNzaW9uIHRow6wgbeG7m2kgYnJlYWsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgIyBSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIHNlbGYucmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPhuq1wIG5o4bqtdCB04burIHNlcnZlciBxdWEgTVFUVAogICAgICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19hbmRfaGFuZGxlX3NlcnZlcl91cGRhdGVzKCk6CiAgICAgICAgICAgICAgICAjIEPhuqduIHJlc3RhcnQgc2Vzc2lvbiBkbyBjb25maWcgdGhheSDEkeG7lWkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJSZXN0YXJ0IHNlc3Npb24gZG8gY29uZmlnIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyIikKICAgICAgICAgICAgICAgICMgUmVzZXQgdGjhu51pIGdpYW4gY29vbGRvd24gxJHhu4MgYuG6r3QgxJHhuqd1IHNlc3Npb24gbmdheSBs4bqtcCB04bupYwogICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IDAKICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbuG6v3UgxJFhbmcgc+G7rSBk4bulbmcKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyByZXN0YXJ0IHNlc3Npb24iKQogICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgIGNvbnRpbnVlICAjIELhuq90IMSR4bqndSBs4bqhaSB04burIMSR4bqndSB2w7JuZyBs4bq3cAogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiBraMO0bmcKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2lzX2luX3Nlc3Npb25fY29vbGRvd24oKToKICAgICAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lIC0gaW50KHRpbWUudGltZSgpKSkgLyA2MCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIntKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19TRVNTSU9OX0NPT0xET1dOfSAoY8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0KSIpCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIG3hu5dpIDUgZ2nDonkgxJHhu4MgY8OzIHRo4buDIHRob8OhdCBz4bubbSBraGkgY8OzIHnDqnUgY+G6p3UKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBwaOG6o2kgZG8gZm9yY2VfcmVzdGFydF9zZXNzaW9uIGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IGzDoCByZXN0YXJ0IHNlc3Npb24sIHRp4bq/cCB04bulYyB2w7JuZyBs4bq3cCB0aGF5IHbDrCBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHBo4bqjaSByZXN0YXJ0IHNlc3Npb24gdGjDrCBt4bubaSBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDEg25nIGvDvSBwcm94eSBuZ2F5IG7hur91IMSRxrDhu6NjIGLhuq10IHbDoCBjaMawYSBhY3RpdmUKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDEg25nIGvDvSBwcm94eSB0csaw4bubYyBraGkgYuG6r3QgxJHhuqd1IHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3h5X3N1Y2Nlc3MgPSBzZWxmLnByb3h5X3NlcnZpY2UucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgcHJveHlfc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSRxINuZyBrw70gcHJveHksIG5naOG7iSAxMHMgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlByb3h5IMSRw6MgxJHGsOG7o2MgxJHEg25nIGvDvSwgdGnhur9wIHThu6VjIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB0csaw4bubYyB0acOqbgogICAgICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzIGFuZCBzZWxmLl9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50c19mb3JfYXBwKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyAoc2F1IGtoaSDEkcOjIMSR4buTbmcgYuG7mSkKICAgICAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IHNlbGYuX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG5nYXkgbuG6v3UgxJFhbmcgc+G7rSBk4bulbmcKICAgICAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBC4bqvdCDEkeG6p3Ugc2Vzc2lvbiBjb29sZG93biB0aGF5IHbDrCBzbGVlcCBuZ+G6r24KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MsIGLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkgbmjGsCBzYXUgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELhuq90IMSR4bqndSBwaGnDqm4gbMOgbSB2aeG7h2MgduG7m2kgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyBz4bq1biBzw6BuZwogICAgICAgICAgICAgICAgc2VsZi5fd29ya19zZXNzaW9uKGFsbF93b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IHbDoCBi4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnJlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbigpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLl9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmgiKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBwaOG6o2kgZG8gZm9yY2VfcmVzdGFydF9zZXNzaW9uIGtow7RuZwogICAgICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IGzDoCByZXN0YXJ0IHNlc3Npb24sIHRp4bq/cCB04bulYyB2w7JuZyBs4bq3cCB0aGF5IHbDrCBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyBwaOG6o2kgcmVzdGFydCBzZXNzaW9uIHRow6wgbeG7m2kgYnJlYWsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICBsb2dnZXIuZXJyb3IoIkpvYlNlcnZpY2UgxJHDoyBk4burbmciKQogICAgICAgICAgICAKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBKb2JTZXJ2aWNlIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBk4burbmcgSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICBkZWYgZm9yY2Vfc3RvcF9hbGwoc2VsZik6CiAgICAgICAgIiIiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCgogICAgZGVmIGhhbmRsZV9tcXR0X2FjY291bnRfdXBkYXRlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPhuq1wIG5o4bqtdCBhY2NvdW50IHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBBY2NvdW50IHPhur0gxJHGsOG7o2MgcmVsb2FkIHNhdSBt4buXaSBqb2IgdHJvbmcgX3dvcmtfYWNjb3VudF9zZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB0aMO0bmcgYsOhbyBj4bqtcCBuaOG6rXQgYWNjb3VudCB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9mb3JjZV9zdGFydF9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IHNlc3Npb24gbmdheSBs4bqtcCB04bupYyB04burIE1RVFQgc2VydmVyCiAgICAgICAgQuG7jyBxdWEgdGjhu51pIGdpYW4gbmdo4buJIGhp4buHbiB04bqhaQogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBi4bqvdCDEkeG6p3Ugc2Vzc2lvbiBuZ2F5IGzhuq1wIHThu6ljIHThu6sgc2VydmVyIHF1YSBNUVRUIikKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA+IDA6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQuG7jyBxdWEgdGjhu51pIGdpYW4gbmdo4buJIHbDoCBi4bqvdCDEkeG6p3Ugc2Vzc2lvbiBuZ2F5IikKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IDAKICAgICAgICAgICAgCiAgICBkZWYgaGFuZGxlX21xdHRfY29uZmlnX3VwZGF0ZShzZWxmLCBjb25maWdfY2hhbmdlczogRGljdFtzdHIsIEFueV0gPSBOb25lKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBj4bqtcCBuaOG6rXQgY29uZmlnIHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gcmVzdGFydCBzZXNzaW9uIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZ19jaGFuZ2VzOiBEaWN0aW9uYXJ5IGNo4bupYSBjw6FjIHRoYXkgxJHhu5VpIGNvbmZpZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgdGjDtG5nIGLDoW8gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIMSR4buDIGzhuqV5IGRhbmggc8OhY2ggcmVzdGFydCByZXF1aXJlZCBjb25maWdzCiAgICAgICAgaW1wb3J0IGNvbmZpZyBhcyBhcHBfY29uZmlnCiAgICAgICAgcmVzdGFydF9yZXF1aXJlZF9jb25maWdzID0gZ2V0YXR0cihhcHBfY29uZmlnLCAnUkVTVEFSVF9SRVFVSVJFRF9DT05GSUdTJywgWwogICAgICAgICAgICAiZW5hYmxlZF9hcHBzIiwgIm1heF9qb2JzX3Blcl9kYXkiLCAibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAKICAgICAgICAgICAgImpvYl9jb29sZG93bl9taW51dGVzIiwgInVzZV9wcm94eSIsICJwcm94eV9zZXJ2ZXIiLCAiam9iX2hvdXIiCiAgICAgICAgXSkKICAgICAgICAKICAgICAgICBuZWVkX3Jlc3RhcnQgPSBGYWxzZQogICAgICAgIAogICAgICAgIGlmIGNvbmZpZ19jaGFuZ2VzOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgdOG7q25nIGNvbmZpZyBjw7MgY+G6p24gcmVzdGFydCBraMO0bmcKICAgICAgICAgICAgZm9yIGNvbmZpZ19rZXkgaW4gY29uZmlnX2NoYW5nZXMua2V5cygpOgogICAgICAgICAgICAgICAgaWYgY29uZmlnX2tleSBpbiByZXN0YXJ0X3JlcXVpcmVkX2NvbmZpZ3M6CiAgICAgICAgICAgICAgICAgICAgbmVlZF9yZXN0YXJ0ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ29uZmlnIHtjb25maWdfa2V5fSB0aGF5IMSR4buVaSwgY+G6p24gcmVzdGFydCBzZXNzaW9uIikKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyB0aMO0bmcgdGluIGNoaSB0aeG6v3QsIGNvaSBuaMawIGPhuqduIHJlc3RhcnQKICAgICAgICAgICAgbmVlZF9yZXN0YXJ0ID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBpZiBuZWVkX3Jlc3RhcnQ6CiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIHNlbGYuZm9yY2VfcmVzdGFydF9zZXNzaW9uID0gVHJ1ZQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQ4bq3dCBmbGFnIHJlc3RhcnQgc2Vzc2lvbiBkbyBjb25maWcgdGhheSDEkeG7lWkiKQogICAgICAgICAgICAgICAgCiAgICBkZWYgY2hlY2tfYW5kX2hhbmRsZV9zZXJ2ZXJfdXBkYXRlcyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCB44butIGzDvSBjw6FjIGPhuq1wIG5o4bqtdCB04burIHNlcnZlcgogICAgICAgIMSQxrDhu6NjIGfhu41pIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCB2w6AgdHJvbmcgX3dvcmtfc2Vzc2lvbgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6p24gdGnhur9wIHThu6VjLCBGYWxzZSBu4bq/dSBj4bqnbiByZXN0YXJ0IHNlc3Npb24KICAgICAgICAiIiIKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBmbGFnIHJlc3RhcnQgc2Vzc2lvbgogICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24gZG8gY29uZmlnIHRoYXkgxJHhu5VpIikKICAgICAgICAgICAgICAgIHNlbGYuZm9yY2VfcmVzdGFydF9zZXNzaW9uID0gRmFsc2UgICMgUmVzZXQgZmxhZwogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIELDoW8gaGnhu4d1IGPhuqduIHJlc3RhcnQgc2Vzc2lvbgogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUgICMgVGnhur9wIHThu6VjIGLDrG5oIHRoxrDhu51uZwoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiLEkMOzbmcgZOG7i2NoIHbhu6UsIGThu6tuZyB04bqldCBj4bqjIHdvcmtlciB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGThu6tuZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNodXRkb3duIFByb3h5U2VydmljZSAoc+G6vSB04buxIMSR4buZbmcgdW5yZWdpc3RlciBwcm94eSB2w6AgZOG7q25nIHVwZGF0ZSB0aHJlYWQpCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3NlcnZpY2UnKSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlOgogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnNodXRkb3duKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlIMSR4buDIHRyw6FuaCBs4buXaSB0aHJlYWQKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmNsb3NlKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHNodXRkb3duIEpvYlNlcnZpY2UiKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09IFBST1hZIENPTlZFTklFTkNFIE1FVEhPRFMgPT09PT09PT09PT09PT09PT09PT0KICAgIGRlZiByZXNldF9jdXJyZW50X3Byb3h5X2lwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgUmVzZXQgSVAgY2hvIHByb3h5IGhp4buHbiB04bqhaSAoY8OzIHRo4buDIGfhu41pIHRyb25nIHF1w6EgdHLDrG5oIGzDoG0gdmnhu4djKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgcmVzZXQgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X3N0YXR1cyhzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdHLhuqFuZyB0aMOhaSBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9zdGF0dXMoKQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X2luZm8oc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjDtG5nIHRpbiBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiBwcm94eQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZ2V0X3Byb3h5X2luZm8oKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09IEVORCBQUk9YWSBDT05WRU5JRU5DRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09CiAgICAgICAgICAgIAogICAgIyBERVBSRUNBVEVEOiBLaMO0bmcgZMO5bmcgbuG7r2EsIHRoYXkgYuG6sW5nIF9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICMgZGVmIF9oYXNfYWNjb3VudHNfcmVhZHlfZm9yX3dvcmsoc2VsZikgLT4gYm9vbDoKICAgICMgICAgICIiIgogICAgIyAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIGtow7RuZwogICAgIyAgICAgCiAgICAjICAgICBSZXR1cm5zOgogICAgIyAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICMgICAgICIiIgogICAgIyAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAjICAgICAKICAgICMgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAjICAgICAgICAgaWYgc2VsZi5pc19hY2NvdW50X2Nhbl9ydW5fam9iKGFwcF9uYW1lKToKICAgICMgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICMgICAgICAgICAgICAgCiAgICAjICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdOG7qyB04bqldCBj4bqjIGFwcCB2w6Agc+G6r3AgeOG6v3AgdGhlbyBhcHAsIG5nw6B5IHThuqFvCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2Mgc+G6r3AgeOG6v3AKICAgICAgICAiIiIKICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6v20gc+G7kSBsxrDhu6NuZyB0w6BpIGtob+G6o24gdGhlbyB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgIHN0YXR1c19jb3VudHMgPSB7fQogICAgICAgICAgICBmb3IgYWNjIGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgc3RhdHVzID0gYWNjLmdldCgnc3RhdHVzJywgJ2FjdGl2ZScpCiAgICAgICAgICAgICAgICBzdGF0dXNfY291bnRzW3N0YXR1c10gPSBzdGF0dXNfY291bnRzLmdldChzdGF0dXMsIDApICsgMQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2cgdGjhu5FuZyBrw6ogdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzdGF0dXNfaW5mbyA9ICIsICIuam9pbihbZiJ7c3RhdHVzfToge2NvdW50fSIgZm9yIHN0YXR1cywgY291bnQgaW4gc3RhdHVzX2NvdW50cy5pdGVtcygpXSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FwcF9uYW1lfSAtIHtzdGF0dXNfaW5mb30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4buNYyBjw6FjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHdvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuZXh0ZW5kKHdvcmthYmxlX2FjY291bnRzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgCiAgICAgICAgIyBT4bqvcCB44bq/cCB0aGVvOgogICAgICAgICMgMS4gQXBwIG5hbWUgKMSR4buDIG5ow7NtIGPDuW5nIGFwcCBs4bqhaSB24bubaSBuaGF1KQogICAgICAgICMgMi4gTmfDoHkgdOG6oW8gdMOgaSBraG/huqNuIChjcmVhdGVkX2F0KSAtIGPFqSBuaOG6pXQgdHLGsOG7m2MKICAgICAgICAjIDMuIFPhu5Egam9iIMSRw6MgbMOgbSB0cm9uZyBwaGnDqm4gKMOtdCBuaOG6pXQgdHLGsOG7m2MpCiAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLnNvcnQoa2V5PWxhbWJkYSB4OiAoCiAgICAgICAgICAgIHguZ2V0KCJhcHAiLCAiIiksCiAgICAgICAgICAgIHguZ2V0KCJjcmVhdGVkX2F0IiwgMCksCiAgICAgICAgICAgIHguZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgKSkKICAgICAgICAKICAgICAgICByZXR1cm4gYWxsX3dvcmthYmxlX2FjY291bnRzCiAgICAgICAgCiAgICBkZWYgX3dvcmtfc2Vzc2lvbihzZWxmLCBhbGxfd29ya2FibGVfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dID0gTm9uZSk6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiBt4buZdCBwaGnDqm4gbMOgbSB2aeG7h2MgaG/DoG4gY2jhu4luaCB24bubaSBjxqEgY2jhur8gbeG7m2kiIiIKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgCiAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgdHJvbmcgcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgVHJ1ZSkKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19XT1JLSU5HX1NFU1NJT04pCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE7hur91IGtow7RuZyB0cnV54buBbiBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiwgbOG6pXkgbOG6oWkgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICBpZiBhbGxfd29ya2FibGVfYWNjb3VudHMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IHNlbGYuX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGFsbF93b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbihhbGxfd29ya2FibGVfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMw6BtIHZp4buHYyB0deG6p24gdOG7sSB24bubaSB04burbmcgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFsbF93b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICBpZiBzZWxmLmRiLmdldCgicGF1c2Vfam9iIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIgdHJvbmcgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY+G6rXAgbmjhuq10IGNvbmZpZyB04burIHNlcnZlcgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfYW5kX2hhbmRsZV9zZXJ2ZXJfdXBkYXRlcygpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24gZG8gY29uZmlnIHRoYXkgxJHhu5VpIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAjIFRob8OhdCBraOG7j2kgX3dvcmtfc2Vzc2lvbiDEkeG7gyByZXN0YXJ0IHThu6sgcnVuKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBt4bubaSBuaOG6pXQgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gbuG6v3Ugc2VydmVyIHnDqnUgY+G6p3UKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU2VydmVyIHnDqnUgY+G6p3UgxJHhu5NuZyBi4buZIGzhuqFpIHTDoGkga2hv4bqjbiBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50c19mb3JfYXBwKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgbOG6oWkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gc2F1IGtoaSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50IG9yIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSBoYW5kbGVyIHRyxrDhu5tjIGtoaSBz4butIGThu6VuZwogICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSR4bqjbSBi4bqjbyBwcm94eSBob+G6oXQgxJHhu5luZyB0csaw4bubYyBraGkgbMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2nhu4NtIHRyYSBwcm94eSB0csaw4bubYyBraGkgbMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVsOybmcgbOG6t3AgY2jhu50gcHJveHkgaG/huqF0IMSR4buZbmcgKHThu5FpIMSRYSA1IGzhuqduIHRo4butKQogICAgICAgICAgICAgICAgICAgIHByb3h5X2F0dGVtcHRzID0gMAogICAgICAgICAgICAgICAgICAgIG1heF9wcm94eV9hdHRlbXB0cyA9IDUwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgd2hpbGUgcHJveHlfYXR0ZW1wdHMgPCBtYXhfcHJveHlfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUHJveHkgxJHDoyBob+G6oXQgxJHhu5luZyBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHByb3h5X2F0dGVtcHRzICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJQcm94eSBjaMawYSBob+G6oXQgxJHhu5luZyBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0sIHRo4butIMSRxINuZyBrw70gbOG6oWkgKGzhuqduIHtwcm94eV9hdHRlbXB0c30ve21heF9wcm94eV9hdHRlbXB0c30pIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgVGjhu60gxJHEg25nIGvDvSBwcm94eQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnByb3h5X3NlcnZpY2UucmVnaXN0ZXJfcHJveHkoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDEg25nIGvDvSBwcm94eSB0aMOgbmggY8O0bmcgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLEkMSDbmcga8O9IHByb3h5IHRo4bqldCBi4bqhaSBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gKGzhuqduIHtwcm94eV9hdHRlbXB0c30pIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG6v24gbOG6p24gY3Xhu5FpLCBuZ2jhu4kgMTBzIHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgcHJveHlfYXR0ZW1wdHMgPCBtYXhfcHJveHlfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOZ2jhu4kgMTBzIHRyxrDhu5tjIGtoaSB0aOG7rSDEkcSDbmcga8O9IHByb3h5IGzhuqFpIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAgIyBUaG/DoXQgbuG6v3UgYuG7iyBuZ+G6r3QKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY3Xhu5FpIGPDuW5nIHhlbSBwcm94eSBjw7MgaG/huqF0IMSR4buZbmcga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIMSRxINuZyBrw70gcHJveHkgc2F1IHttYXhfcHJveHlfYXR0ZW1wdHN9IGzhuqduIHRo4butLCBi4buPIHF1YSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSDEkcOjIGPDsyBwcm94eSBob+G6oXQgxJHhu5luZywgxJHDs25nIGFwcCB2w6AgcmVzZXQgSVAKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAgdsOgIHJlc2V0IElQIHRyxrDhu5tjIGtoaSBsw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyDEkMOzbmcgYXBwIHRyxrDhu5tjIGtoaSByZXNldCBJUAogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuY2xvc2VfYXBwKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IElQCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBJUCB0aMOgbmggY8O0bmcgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpICAjIENo4budIElQIG3hu5tpIOG7lW4gxJHhu4tuaAogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVzZXQgSVAgdGjhuqV0IGLhuqFpIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSwgdGnhur9wIHThu6VjIHbhu5tpIElQIGhp4buHbiB04bqhaSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgICAgIGFjY291bnRfcmVzdWx0ID0gc2VsZi5fd29ya19hY2NvdW50X3Nlc3Npb24oYWNjb3VudCwgaGFuZGxlcikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOzbmcgYXBwIHNhdSBraGkgbMOgbSB4b25nIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gY2jEg20gc8OzYyBzYXUga2hpIGjhur90IGpvYiAobuG6v3UgxJHGsOG7o2MgYuG6rXQpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgY2FyZV9pbl93b3JraW5nX2pvYiA9IHNlbGYuZGIuZ2V0KCJjYXJlX2luX3dvcmtpbmdfam9iIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgaWYgY2FyZV9pbl93b3JraW5nX2pvYiBhbmQgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgY2FyZV9pbl93b3JraW5nX2pvYjoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ2jEg20gc8OzYyBi4buLIHThuq90LCBi4buPIHF1YSBjaMSDbSBzw7NjIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9OiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGLhu4sgZ2nDoW4gxJFv4bqhbiwgZOG7q25nIHBoacOqbgogICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnRfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMyk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgZmluYWxseToKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUga+G6v3QgdGjDumMgcGhpw6puIGzDoG0gdmnhu4djCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAKICAgICMgREVQUkVDQVRFRDogUGjGsMahbmcgdGjhu6ljIG7DoHkga2jDtG5nIGTDuW5nIG7hu69hIGRvIGNodXnhu4NuIHNhbmcgY8ahIGNo4bq/IG3hu5tpCiAgICAjIGRlZiBfd29ya193aXRoX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgIyAgICAgIiIiCiAgICAjICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgIyAgICAgCiAgICAjICAgICBBcmdzOgogICAgIyAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBsw6BtIHZp4buHYwogICAgIyAgICAgICAgIAogICAgIyAgICAgUmV0dXJuczoKICAgICMgICAgICAgICBib29sOiBUcnVlIG7hur91IGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBnacOhbiDEkW/huqFuCiAgICAjICAgICAiIiIKICAgICMgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIHthcHBfbmFtZX0iKQogICAgIyAgICAgCiAgICAjICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAjICAgICAKICAgICMgICAgICMgTMOgbSB2aeG7h2MgdHXhuqduIHThu7EgduG7m2kgdOG7q25nIHTDoGkga2hv4bqjbiAocmVhbC10aW1lIHJlbG9hZCkKICAgICMgICAgIHdoaWxlIFRydWU6CiAgICAjICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgIyAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3N0b3Agb3Igbm90IHNlbGYucnVubmluZzoKICAgICMgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgIyAgICAgICAgICAgICAgICAgCiAgICAjICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAjICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICMgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQaMOhdCBoaeG7h24gecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIga2hpIGzDoG0gdmnhu4djIHbhu5tpIHthcHBfbmFtZX0iKQogICAgIyAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICMgICAgICAgICAKICAgICMgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldCAoY8OzIHRo4buDIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyKQogICAgIyAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgICMgTOG7jWMgY8OhYyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICMgICAgICAgICAKICAgICMgICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAjICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgIyAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgICAgICAjIFTDrG0gdMOgaSBraG/huqNuIGPDsyBqb2JzX2RvbmVfaW5fc2Vzc2lvbiB0aOG6pXAgbmjhuqV0IMSR4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAgICAgd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6IHguZ2V0KCdqb2JzX2RvbmVfaW5fc2Vzc2lvbicsIDApKQogICAgIyAgICAgICAgIGFjY291bnQgPSB3b3JrYWJsZV9hY2NvdW50c1swXQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAjICAgICAgICAgCiAgICAjICAgICAgICAgIyBDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBuw6B5CiAgICAjICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICMgICAgICAgICBpZiBub3Qgc3dpdGNoX3Jlc3VsdDoKICAgICMgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICMgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIG7DoHkgY8OzIHbhuqVuIMSR4buBIHbDoCB0aOG7rSB0w6BpIGtob+G6o24ga2jDoWMKICAgICMgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249Ikzhu5dpIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAjICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgICAgICMgTMOgbSDEkeG7pyBz4buRIGpvYiB0cm9uZyBwaGnDqm4gY2hvIHTDoGkga2hv4bqjbiBuw6B5CiAgICAjICAgICAgICAgYWNjb3VudF9yZXN1bHQgPSBzZWxmLl93b3JrX2FjY291bnRfc2Vzc2lvbihhY2NvdW50LCBoYW5kbGVyKQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgICMgTMOgbSBjaMSDbSBzw7NjIHNhdSBraGkgaOG6v3Qgam9iCiAgICAjICAgICAgICAgdHJ5OgogICAgIyAgICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICJwZXJmb3JtX2NhcmUiKSBhbmQgY2FsbGFibGUoaGFuZGxlci5wZXJmb3JtX2NhcmUpOgogICAgIyAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAjICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgIyAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICMgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgY2jEg20gc8OzYyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX06IHtlfSIpCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgICAgICMgTuG6v3UgYuG7iyBnacOhbiDEkW/huqFuLCByZXR1cm4gRmFsc2UKICAgICMgICAgICAgICBpZiBub3QgYWNjb3VudF9yZXN1bHQ6CiAgICAjICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZwogICAgIyAgICAgICAgICMgKGPDsyB0aOG7gyBjw7MgdGhheSDEkeG7lWkgdOG7qyBzZXJ2ZXIgdHJvbmcgbMO6YyBsw6BtIHZp4buHYykKICAgICMgICAgICAgICB1cGRhdGVkX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgIyAgICAgICAgIHJlbWFpbmluZ193b3JrYWJsZSA9IFthY2MgZm9yIGFjYyBpbiB1cGRhdGVkX2FjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAjICAgICAgICAgCiAgICAjICAgICAgICAgaWYgbm90IHJlbWFpbmluZ193b3JrYWJsZToKICAgICMgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGhvw6BuIHRow6BuaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgIyAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICBkZWYgX3dvcmtfYWNjb3VudF9zZXNzaW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEzDoG0gdmnhu4djIHbhu5tpIG3hu5l0IHTDoGkga2hv4bqjbiB0cm9uZyBwaGnDqm4KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlcgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGhvw6BuIHRow6BuaCwgRmFsc2UgbuG6v3UgYuG7iyBnacOhbiDEkW/huqFuCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGpvYnNfZG9uZSA9IDAKICAgICAgICBjYXJlX2NvdW50ZXIgPSAwCiAgICAgICAgY29uZmlnX3JlbG9hZF9jb3VudGVyID0gMCAgIyDEkOG6v20gxJHhu4MgcmVsb2FkIGPhuqV1IGjDrG5oIMSR4buLbmgga+G7swogICAgICAgIG5vX2pvYl9jb3VudCA9IDAgICMgxJDhur9tIHPhu5EgbOG6p24ga2jDtG5nIGzhuqV5IMSRxrDhu6NjIGpvYiBsacOqbiB0aeG6v3AKICAgICAgICBtYXhfbm9fam9iX2F0dGVtcHRzID0gMyAgIyBT4buRIGzhuqduIHThu5FpIMSRYSB0aOG7rSBs4bqleSBqb2Iga2hpIGtow7RuZyBjw7MKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAKICAgICAgICAjIENodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gxJHDoyBsb2dvdXQga2hpIGtow7RuZyB0aOG7gyBjaHV54buDbiDEkcaw4bujYwogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGtow7RuZyB0aOG7gyBjaHV54buDbiDEkcaw4bujYywgxJHDoW5oIGThuqV1IGxvZ291dCIpCiAgICAgICAgICAgICMgVOG6oW8gbWVzc2FnZSB24bubaSBuZ8OgeSBnaeG7nSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCIlZC8lbS8lWSAlSDolTTolUyIpCiAgICAgICAgICAgIGxvZ291dF9tZXNzYWdlID0gZiJQaMOhdCBoaeG7h24gbG9nb3V0OiB7Y3VycmVudF90aW1lfSIKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGxvZ291dF9tZXNzYWdlLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBSZXR1cm4gVHJ1ZSDEkeG7gyB0aeG6v3AgdOG7pWMgduG7m2kgdMOgaSBraG/huqNuIHRp4bq/cCB0aGVvCiAgICAgICAgCiAgICAgICAgd2hpbGUgVHJ1ZToKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9zdG9wIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEx1w7RuIHJlbG9hZCBhY2NvdW50IOG7nyDEkeG6p3UgdsOybmcgbOG6t3AgxJHhu4MgxJHhuqNtIGLhuqNvIGThu68gbGnhu4d1IG3hu5tpIG5o4bqldCB04burIHNlcnZlcgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IHNhdSBraGkgcmVsb2FkLCBk4burbmcgc2Vzc2lvbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGNo4bqheSBqb2Iga2jDtG5nIHNhdSBraGkgcmVsb2FkCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0ga2jDtG5nIHRo4buDIGNo4bqheSBqb2IgbuG7r2Egc2F1IGtoaSByZWxvYWQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciBraGkgbMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPhuq1wIG5o4bqtdCBjb25maWcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfYW5kX2hhbmRsZV9zZXJ2ZXJfdXBkYXRlcygpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQaMOhdCBoaeG7h24gecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24gZG8gY29uZmlnIHRoYXkgxJHhu5VpIGtoaSBsw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgVGhvw6F0IMSR4buDIHJlc3RhcnQgc2Vzc2lvbgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtow7RuZyBj4bqnbiB1cGRhdGUgcHJveHkgdGjhu6cgY8O0bmcgbuG7r2EgLSDEkcOjIGPDsyB0aHJlYWQgdOG7sSDEkeG7mW5nIHVwZGF0ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZWxvYWQgY+G6pXUgaMOsbmggdMOgaSBraG/huqNuIHThu6sgZGF0YWJhc2UgbeG7l2kgNSBqb2IgxJHhu4MgcGjhuqNuIMOhbmggdGhheSDEkeG7lWkgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgY29uZmlnX3JlbG9hZF9jb3VudGVyICs9IDEKICAgICAgICAgICAgaWYgY29uZmlnX3JlbG9hZF9jb3VudGVyID49IDU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZWxvYWQgY+G6pXUgaMOsbmggdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdOG7qyBkYXRhYmFzZSAoxJHDoyByZWxvYWQg4bufIMSR4bqndSB2w7JuZyBs4bq3cCkiKQogICAgICAgICAgICAgICAgY29uZmlnX3JlbG9hZF9jb3VudGVyID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBwaGnDqm4gaGnhu4duIHThuqFpCiAgICAgICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGhvw6BuIHRow6BuaCDEkeG7pyBqb2IgdHJvbmcgcGhpw6puICh7am9ic19kb25lX2luX3Nlc3Npb259L3ttYXhfam9ic19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBM4bqleSBqb2IKICAgICAgICAgICAgICAgIGpvYiA9IGhhbmRsZXIuZmV0Y2hfam9iKGFjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgICAgICAgICAgbm9fam9iX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7Mgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAobOG6p24ge25vX2pvYl9jb3VudH0ve21heF9ub19qb2JfYXR0ZW1wdHN9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2Mgam9iIHF1w6Egbmhp4buBdSBs4bqnbiwgZOG7q25nIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgICAgIGlmIG5vX2pvYl9jb3VudCA+PSBtYXhfbm9fam9iX2F0dGVtcHRzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGtow7RuZyBs4bqleSDEkcaw4bujYyBqb2Igc2F1IHttYXhfbm9fam9iX2F0dGVtcHRzfSBs4bqnbiB0aOG7rSwgZOG7q25nIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChyYW5kb20ucmFuZGludCgxMCwgMjApKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZXNldCBjb3VudGVyIGtoaSBs4bqleSDEkcaw4bujYyBqb2IKICAgICAgICAgICAgICAgIG5vX2pvYl9jb3VudCA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlCiAgICAgICAgICAgICAgICBsaW5rID0gam9iLmdldCgnbGluaycsICcnKQogICAgICAgICAgICAgICAgaWYgbGluay5zdGFydHN3aXRoKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycpOgogICAgICAgICAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgICAgICAgICBlbGlmIGxpbmsuc3RhcnRzd2l0aCgnaHR0cHM6Ly93d3cudGlrdG9rLmNvbS8nKToKICAgICAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy50aWt0b2suY29tLycsICcnKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJbe2FjY291bnQuZ2V0KCdhcHAnKX1dW3t1c2VybmFtZX1dW3tqb2IuZ2V0KCd0eXBlJyl9XVt7bGlua31dIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSBqb2IKICAgICAgICAgICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gaGFuZGxlci52YWxpZGF0ZV9qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInZhbGlkIiwgVHJ1ZSk6CiAgICAgICAgICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgIyBTa2lwIGpvYgogICAgICAgICAgICAgICAgICAgICAgICBza2lwX21lc3NhZ2UgPSB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiSm9iIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTa2lwIGpvYjoge3NraXBfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc2tpcF9tZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU2tpcCBqb2IgbOG7l2k6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEdpw6NuIHRo4budaSBnaWFuIHNhdSBraGkgc2tpcCBqb2IgxJHhu4MgdHLDoW5oIHNwYW0gbOG6pXkvaOG7p3kgam9iIGxpw6puIHThu6VjCiAgICAgICAgICAgICAgICAgICAgICAgIHNraXBfc2xlZXBfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDEwKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBza2lwIGpvYiDEkeG7gyB0csOhbmggc3BhbSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoc2tpcF9zbGVlcF90aW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSm9iIGtow7RuZyBo4bujcCBs4buHOiB7dmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGVfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSBr4bq/dCBxdeG6owogICAgICAgICAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgICAgICAgICBqb2Jfc3VjY2VzcyA9IGpvYl9yZXN1bHRbInN1Y2Nlc3MiXQogICAgICAgICAgICAgICAgam9iX21lc3NhZ2UgPSBqb2JfcmVzdWx0WyJtZXNzYWdlIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZwogICAgICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSA0IGFuZCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAgICAgY250ID0gc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHMuZ2V0KGFjY291bnRbImlkIl0sIDApICsgMQogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgICAgICAgICAgaWYgY250ID49IDU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCBmb2xsb3cgcGVuZGluZywgdOG6oW0gZOG7q25nIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPSJMacOqbiB0aeG6v3AgbOG7l2kgZm9sbG93IHBlbmRpbmciKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGVsaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCw6FvIGPDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqCiAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfam9iX3N0YXRzKGFjY291bnQsIGpvYl9zdWNjZXNzLCBqb2IuZ2V0KCJ0eXBlIiwgIiIpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlbG9hZCBhY2NvdW50IHNhdSBraGkgdXBkYXRlIMSR4buDIGPDsyBk4buvIGxp4buHdSBt4bubaSBuaOG6pXQKICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS+G6v3QgcXXhuqMgam9iIHtqb2JzX2RvbmVfaW5fc2Vzc2lvbn0ve21heF9qb2JzX3Blcl9zZXNzaW9ufToge2pvYl9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2jhu4kgdMSDbmcgY2FyZV9jb3VudGVyIGtoaSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICBpZiBqb2Jfc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICBqb2JzX2RvbmUgKz0gMQogICAgICAgICAgICAgICAgICAgIGNhcmVfY291bnRlciArPSAxCiAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ2jEg20gc8OzYyBzYXUgbeG7l2kgMy01IGpvYiB0aMOgbmggY8O0bmcgKHJhbmRvbSkKICAgICAgICAgICAgICAgICAgICAjIGlmIGNhcmVfY291bnRlciA+PSByYW5kb20ucmFuZGludCgzLCA1KToKICAgICAgICAgICAgICAgICAgICAjICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgICAgIGlmIGhhc2F0dHIoaGFuZGxlciwgInBlcmZvcm1fY2FyZSIpIGFuZCBjYWxsYWJsZShoYW5kbGVyLnBlcmZvcm1fY2FyZSk6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gY2jEg20gc8OzYyBuaOG6uSBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgaGFuZGxlci5wZXJmb3JtX2NhcmUoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIGNhcmVfY291bnRlciA9IDAKICAgICAgICAgICAgICAgICAgICAjICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2Mgbmjhurk6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyBqb2IKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnJhbmRpbnQoMiwgNSkpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKHNlbGYpOgogICAgICAgICIiIkLhuq90IMSR4bqndSB0aOG7nWkgZ2lhbiBuZ2jhu4kgZ2nhu69hIGPDoWMgcGhpw6puIiIiCiAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJqb2JfY29vbGRvd25fbWludXRlcyIsIDYwKQogICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkgKyAoY29vbGRvd25fbWludXRlcyAqIDYwKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IG5naOG7iSBuZ8ahaSB7Y29vbGRvd25fbWludXRlc30gcGjDunQgZ2nhu69hIGPDoWMgcGhpw6puIikKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIntKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19TRVNTSU9OX0NPT0xET1dOfSAoe2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0KSIpCiAgICAgICAgCiAgICAgICAgIyBC4bqlbSBuw7p0IEhvbWUgdsOgIG3hu58gVGVybXV4IGtoaSBi4bqvdCDEkeG6p3Ugbmdo4buJIG5nxqFpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiQuG6pW0gbsO6dCBIb21lIHbDoCBt4bufIFRlcm11eCDEkeG7gyBuZ2jhu4kgbmfGoWkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBC4bqlbSBuw7p0IEhvbWUKICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfaG9tZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4budIG3hu5l0IGNow7p0IHLhu5NpIG3hu58gVGVybXV4CiAgICAgICAgICAgIHRpbWUuc2xlZXAoMikKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoImNvbS50ZXJtdXgiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGLhuqVtIEhvbWUgdsOgIG3hu58gVGVybXV4OiB7ZX0iKQogICAgICAgIAogICAgZGVmIF9pc19pbl9zZXNzaW9uX2Nvb2xkb3duKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIG5naOG7iSBnaeG7r2EgY8OhYyBwaGnDqm4ga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kKICAgICAgICAiIiIKICAgICAgICAjIE7hur91IGPDsyB5w6p1IGPhuqd1IHJlc3RhcnQgc2Vzc2lvbiwgYuG7jyBxdWEgY291bnRkb3duCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24sIGLhu48gcXVhIHRo4budaSBnaWFuIG5naOG7iSIpCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSAwCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBpZiBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPD0gMDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHRo4budaSBnaWFuIGNvb2xkb3duIGhp4buHbiB04bqhaQogICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICBpZiBjdXJyZW50X3RpbWUgPCBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWU6CiAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBjdXJyZW50X3RpbWUpIC8gNjApCiAgICAgICAgICAgIHJlbWFpbmluZ19zZWNvbmRzID0gKHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSAtIGN1cnJlbnRfdGltZSkgJSA2MAogICAgICAgICAgICBpZiByZW1haW5pbmdfbWludXRlcyA+IDA6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJDw7JuIHtyZW1haW5pbmdfbWludXRlc30gcGjDunQge3JlbWFpbmluZ19zZWNvbmRzfSBnacOieSBuZ2jhu4kgbmfGoWkiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7cmVtYWluaW5nX3NlY29uZHN9IGdpw6J5IG5naOG7iSBuZ8ahaSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgaOG6v3QgdGjhu51pIGdpYW4gbmdo4buJIG5nxqFpLCBi4bqvdCDEkeG6p3UgcGhpw6puIGzDoG0gdmnhu4djIG3hu5tpIikKICAgICAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgICAgICByZXR1cm4gRmFsc2U=').decode('utf-8'))
