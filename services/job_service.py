import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKZnJvbSBzZXJ2aWNlcy5wcm94eV9zZXJ2aWNlIGltcG9ydCBQcm94eVNlcnZpY2UKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19DT05USU5VT1VTID0gIsSQYW5nIGzDoG0gdmnhu4djIGxpw6puIHThu6VjIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIG5nw6B5IgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgLSBs4bqleSB04burIGRhdGFiYXNlIGhv4bq3YyBjb25maWcKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIHRoZW8gYWNjb3VudF9pZAogICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Agam9iIGZvbGxvdyB0cuG6oyB24buBIHN0YXR1cyA0IChwZW5kaW5nKQogICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBi4buLIHVuZm9sbG93L3VubGlrZSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBs4buXaSBmZXRjaCBqb2IgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyBxdXnhur90IMSR4buLbmggbmjhuqMgcHJveHkKICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJHDoyByZXNldCBJUCBwcm94eSDEkeG7gyB0csOhbmggcmVzZXQgbOG6t3AgbOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcCDEkeG7gyB0csOhbmggc3dpdGNoIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyA9IHt9ICAjIHthcHBfbmFtZTogYWNjb3VudF9pZH0KICAgICAgICAKICAgICAgICAjIEZsYWcgxJHhu4MgdHJhY2sgeGVtIMSRw6MgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCBjaMawYSBraGkga2jhu59pIMSR4buZbmcKICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCA9IHt9ICAjIHthcHBfbmFtZTogYm9vbH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgbMOgbSB2aeG7h2MgxJHhu4MgdHLDoW5oIHF1w6l0IGzhuqFpIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgIGRlZiBfdmVyaWZ5X2N1cnJlbnRfYWNjb3VudF9vbl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0ciwgaGFuZGxlcikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyIGPhu6dhIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4gYXBwLCBOb25lIG7hur91IGtow7RuZyBjw7MgaG/hurdjIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihoYW5kbGVyLCAnZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lJyk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkhhbmRsZXIge2FwcF9uYW1lfSBraMO0bmcgaOG7lyB0cuG7oyBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB04burIFVJCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJykgPT0gY3VycmVudF9hY2NvdW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZpZWQ6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50X3VzZXJuYW1lfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBuaMawbmcga2jDtG5nIGPDsyB0cm9uZyBEQiIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBjdXJyZW50IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGlzX2xvZ2luIHRyb25nIERCIHbhu5tpIHRo4buxYyB04bq/IHRyw6puIGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlciBj4bunYSBhcHAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSB0csaw4bubYyBraGkgdmVyaWZ5IGFjY291bnQgKG7hur91IGPhuqduKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoZiJWZXJpZnkgYWNjb3VudCB0csOqbiB7YXBwX25hbWV9Iik6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgdmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSwgYuG7jyBxdWEgdmVyaWZ5IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuX3ZlcmlmeV9jdXJyZW50X2FjY291bnRfb25fYXBwKGFwcF9uYW1lLCBoYW5kbGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBj4bunYSBhcHAgbsOgeSB24buBIGlzX2xvZ2luID0gRmFsc2UgdHJvbmcgREIKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHJlc2V0X2NvdW50ID0gMAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIHJlc2V0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBpc19sb2dpbiA9IEZhbHNlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzZXRfY291bnQgPiAwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCB7cmVzZXRfY291bnR9IHTDoGkga2hv4bqjbiB24buBIGlzX2xvZ2luID0gRmFsc2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luCiAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoY3VycmVudF9hY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBjdXJyZW50X2FjY291bnRbImlkIl0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyB0cuG6oW5nIHRow6FpOiBUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gbG9naW4KICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgdHLhuqFuZyB0aMOhaTogS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHN5bmMgbG9naW4gc3RhdHVzIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfZm9yY2VfdmVyaWZ5X2FjY291bnRzX3dpdGhfcHJveHkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgRm9yY2UgdmVyaWZ5IHThuqV0IGPhuqMgYWNjb3VudCBraGkgxJHDoyBjw7MgcHJveHkgKGfhu41pIGtoaSB0aOG7sWMgc+G7sSBj4bqnbiB0aGnhur90KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVycyBhbmQgYXBwX25hbWUgbm90IGluIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiRm9yY2UgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9IHbhu5tpIHByb3h5Li4uIikKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZm9yY2UgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmb3JjZSB2ZXJpZnkgYWNjb3VudHM6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9pc19jdXJyZW50X2FjY291bnRfc3RpbGxfd29ya2FibGUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIGPDsyBjw7JuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgduG6q24gY8OzIHRo4buDIGzDoG0gdmnhu4djLCBGYWxzZSBu4bq/dSBj4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50OgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldCB04burIERCCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIElEIHthY2NvdW50X2lkfSBraMO0bmcgY8OybiB04buTbiB04bqhaSB0cm9uZyBEQiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgY8OybiBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgIGNhbl93b3JrID0gc2VsZi5fY2FuX3J1bl9qb2IoY3VycmVudF9hY2NvdW50KQogICAgICAgICAgICBpZiBjYW5fd29yazoKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB24bubaSBkYXRhIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGN1cnJlbnRfYWNjb3VudAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0ga2jDtG5nIHRo4buDIGzDoG0gdmnhu4djIG7hu69hLCBj4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBraMOhYyIpCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBraeG7g20gdHJhIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWk6IHtlfSIpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIHNhZmVfc2xlZXAoc2VsZiwgc2Vjb25kczogZmxvYXQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTmfhu6cgYW4gdG/DoG4sIGPDsyB0aOG7gyBk4burbmcgbOG6oWkgbmdheSBs4bqtcCB04bupYyBraGkgZm9yY2Vfc3RvcCDEkcaw4bujYyDEkeG6t3QgdGjDoG5oIFRydWUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBzZWNvbmRzOiBT4buRIGdpw6J5IGPhuqduIG5n4bunCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugbmfhu6cgxJHhu6cgdGjhu51pIGdpYW4sIEZhbHNlIG7hur91IGLhu4sgZOG7q25nIGzhuqFpCiAgICAgICAgIiIiCiAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgY2hlY2tfaW50ZXJ2YWwgPSBKb2JTZXJ2aWNlQ29uc3RhbnRzLkRFRkFVTFRfQ0hFQ0tfSU5URVJWQUwgICMgS2nhu4NtIHRyYSBt4buXaSAwLjUgZ2nDonkKICAgICAgICAKICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUgPCBzZWNvbmRzOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgY8OzIHnDqnUgY+G6p3UgZOG7q25nCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBOZ+G7pyBt4buZdCBraG/huqNuZyBuZ+G6r24KICAgICAgICAgICAgc2xlZXBfdGltZSA9IG1pbihjaGVja19pbnRlcnZhbCwgc2Vjb25kcyAtICh0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUpKQogICAgICAgICAgICBpZiBzbGVlcF90aW1lID4gMDoKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2xlZXBfdGltZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIGluaXRpYWxpemUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIHThuqFvIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLi4uIikKICAgICAgICAKICAgICAgICAjIDEuIEtp4buDbSB0cmEgSGVscGVyU2VydmljZQogICAgICAgIGhlbHBlcl9zdWNjZXNzLCBoZWxwZXJfZGF0YSA9IHV0aWxzLmNoZWNrX2hlbHBlcl9zZXJ2aWNlKHNlbGYuaGVscGVyKQogICAgICAgIGlmIG5vdCBoZWxwZXJfc3VjY2VzczoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga+G6v3QgbuG7kWkgxJHhur9uIEhlbHBlclNlcnZpY2UuIFZ1aSBsw7JuZyBraeG7g20gdHJhIGzhuqFpLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4sgbuG6v3UgY8OzCiAgICAgICAgaWYgaGVscGVyX2RhdGEgYW5kICJkYXRhIiBpbiBoZWxwZXJfZGF0YToKICAgICAgICAgICAgc2VsZi5kYi5zYXZlX2RldmljZV9pbmZvKGhlbHBlcl9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgbMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7izoge2hlbHBlcl9kYXRhWydkYXRhJ10uZ2V0KCdkZXZpY2VfbW9kZWwnLCAnVW5rbm93bicpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAjIDMuIEzGsHUgY8OhYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgc2VsZi5fc2F2ZV9kZWZhdWx0X2NvbmZpZ3MoKQogICAgICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAjIDUuIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5faW5pdF9qb2JfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgNi4gS2jhu59pIHThuqFvIG5nw6B5IGN14buRaSBjw7luZyDEkcOjIHJlc2V0IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgICMgTuG6v3UgaGnhu4duIHThuqFpIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5LCDEkcOhbmggZOG6pXUgxJHDoyByZXNldAogICAgICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE7hur91IGNoxrBhIMSR4bq/biBnaeG7nSByZXNldCwgxJHDoW5oIGThuqV1IGzDoCDEkcOjIHJlc2V0IG5nw6B5IGjDtG0gcXVhCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheSAtIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIGxhc3RfcmVzZXRfZGF0ZS5pc29mb3JtYXQoKSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gbmfDoHkgcmVzZXQ6IHtsYXN0X3Jlc2V0X2RhdGV9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgIAogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBKb2JTZXJ2aWNlIHRow6BuaCBjw7RuZy4iKQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24ga2nhu4NtIHRyYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaSwgRmFsc2UgbuG6v3Uga2jDtG5nIGPhuqduCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB04burIGRhdGFiYXNlCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIHN5bmNfc3RhdHVzID0gc2VsZi5kYi5nZXQoc3luY19zdGF0dXNfa2V5LCBGYWxzZSkgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG7k25nIGLhu5kgdGjDrCBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWkKICAgICAgICByZXR1cm4gbm90IHN5bmNfc3RhdHVzCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIHN0YXR1czogYm9vbCA9IFRydWUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIHN0YXR1czogVHJ1ZSBu4bq/dSDEkcOjIMSR4buTbmcgYuG7mSwgRmFsc2UgbuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgIiIiCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgc2VsZi5kYi5zZXQoc3luY19zdGF0dXNfa2V5LCBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfToge3N0YXR1c30iKQogICAgICAgIAogICAgZGVmIF9zeW5jX2FjY291bnRzX2Zvcl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8gbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gxJHhu5NuZyBi4buZCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CgogICAgICAgICAgICAjIDEuIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiB0aMOsIGtow7RuZyBsw6BtIGfDrAogICAgICAgICAgICBpZiBub3QgYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJHGsOG7o2MgxJHhu5NuZyBi4buZIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSBtYXBwaW5nIEdvTGlrZSIpCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIFRydWUpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBUcnVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIEZhbHNlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MiIiIKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gdGjhu51pIGdpYW4gbMOgbSBqb2IKICAgICAgICAgICAgImpvYl9ob3VyIjogY29uZmlnLkpPQl9IT1VSLAogICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIFRo4budaSBnaWFuIGNo4budIChwaMO6dCkga2hpIGtow7RuZyB0w6xtIHRo4bqleSBqb2IgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBTbWFydCBjYXJlIHN5c3RlbSAtIGNvbmZpZyB04buRaSBnaeG6o24gKHRoYXkgdGjhur8gY2FyZV9pbl93b3JraW5nX2pvYiBjxakpCiAgICAgICAgICAgICJlbmFibGVfY2FyZSI6IFRydWUsICAgICAgICAgICAgICAgICAgICAjIELhuq10L3Thuq90IHRvw6BuIGLhu5kgaOG7hyB0aOG7kW5nIGNhcmUKICAgICAgICAgICAgImNhcmVfaW50ZXJ2YWxfaG91cnMiOiA2LCAgICAgICAgICAgICAgICMgS2hv4bqjbmcgY8OhY2ggZ2nhu69hIGPDoWMgbOG6p24gY2FyZSAoNmgpCiAgICAgICAgICAgICJjYXJlX2NoYW5jZV9wZXJjZW50IjogMzAsICAgICAgICAgICAgICAjIFThu7cgbOG7hyBjYXJlIG5n4bqrdSBuaGnDqm4gKDMwJSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggZ2nDoSB04buRaSB0aGnhu4N1IGNobyBqb2IgZm9sbG93CiAgICAgICAgICAgICJtaW5fZm9sbG93X3ByaWNlIjogMjAsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIHjhu60gbMO9IHVuZm9sbG93L3VubGlrZQogICAgICAgICAgICAibWF4X3VuZm9sbG93X2F0dGVtcHRzIjogY29uZmlnLk1BWF9VTkZPTExPV19BVFRFTVBUUywKICAgICAgICAgICAgInVuZm9sbG93X3BlbmFsdHlfbWludXRlcyI6IDcyMCwgICMgTeG6t2MgxJHhu4tuaCAxMiBnaeG7nSwgY8OzIHRo4buDIMSRaeG7gXUgY2jhu4luaCB04burIHNlcnZlcgogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBwcm94eQogICAgICAgICAgICAidXNlX3Byb3h5IjogRmFsc2UsICAjIEPDsyBz4butIGThu6VuZyBwcm94eSBraMO0bmcKICAgICAgICAgICAgInByb3h5X3NlcnZlciI6ICJodHRwOi8vMTAuMC4wLjU6OTAzMiIsICAjIFNlcnZlciBwcm94eSBt4bq3YyDEkeG7i25oCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRlZmF1bHRfY29uZmlncy5pdGVtcygpOgogICAgICAgICAgICAjIENo4buJIGzGsHUgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KGtleSkgaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KGtleSwgdmFsdWUpCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOjIGzGsHUgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaDoge2tleX09e3ZhbHVlfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJD4bqldSBow6xuaCB7a2V5fSDEkcOjIHThu5NuIHThuqFpOiB7c2VsZi5kYi5nZXQoa2V5KX0iKQogICAgICAgIAogICAgZGVmIF9pbml0X2pvYl9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlciIiIgogICAgICAgICMgaW5pdCB0aMOsIHPhur0gaW5pdCBoYW5kbGVycyBjaG8gdOG6pXQgY+G6oyBjw6FjIGFwcCwgbMOgbSBhcHAgbsOgbyB0aMOsIHPhur0gdGhlbyBj4bqldSBow6xuaCBs4bqleSB04burIGRhdGFiYXNlCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGNvbmZpZy5FTkFCTEVEX0FQUFM6CiAgICAgICAgICAgIGlmIGFwcF9uYW1lID09ICJ0aWt0b2siOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6AgcHJveHlfc2VydmljZSB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgIGVsaWYgYXBwX25hbWUgPT0gImluc3RhZ3JhbSI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBJbnN0YWdyYW1Kb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoCBwcm94eV9zZXJ2aWNlIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBraOG7n2kgdOG6oW8ge2xlbihzZWxmLmpvYl9oYW5kbGVycyl9IGpvYiBoYW5kbGVyOiB7JywgJy5qb2luKHNlbGYuam9iX2hhbmRsZXJzLmtleXMoKSl9IikKICAgICAgICAKICAgIGRlZiBfcmVzZXRfZGFpbHlfY291bnRlcnMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgdsOgbyBnaeG7nSDEkcaw4bujYyBj4bqldSBow6xuaCIiIgogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBnaeG7nSByZXNldCB04burIGPhuqV1IGjDrG5oIGhv4bq3YyB04burIGRhdGFiYXNlIG7hur91IGPDswogICAgICAgIGpvYl9ob3VyID0gc2VsZi5kYi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgIAogICAgICAgICMgVMOtbmggdGjhu51pIMSRaeG7g20gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgaWYgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gZGF0ZXRpbWUuZGF0ZS5mcm9taXNvZm9ybWF0KGxhc3RfcmVzZXRfZGF0ZV9zdHIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYixJDhu4tuaCBk4bqhbmcgbmfDoHkgcmVzZXQga2jDtG5nIGjhu6NwIGzhu4c6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIHF1YSBnaeG7nSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heSBjaMawYSB2w6AgY2jGsGEgcmVzZXQgdHJvbmcgbmfDoHkgaMO0bSBuYXkKICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZSBhbmQgKGxhc3RfcmVzZXRfZGF0ZSBpcyBOb25lIG9yIGxhc3RfcmVzZXRfZGF0ZSA8IHRvZGF5KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IChnaeG7nSByZXNldDoge2pvYl9ob3VyfTowMCkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGLhu5kgxJHhur9tIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbgogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBz4buRIGpvYiBow7RtIG5heSB2w6Agc2Vzc2lvbiBjb3VudGVycwogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAiam9iX3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd190b2RheSI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3ZpZXdfc3RvcmllcyI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaSBmb2xsb3cga2hpIGNodXnhu4NuIG5nw6B5IG3hu5tpCiAgICAgICAgICAgICAgICAgICAgIyBFbmFibGUgbOG6oWkgZm9sbG93IG7hur91IGLhu4sgZGlzYWJsZSB2w6wgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgbmfDoHkgaG/hurdjIHBoacOqbgogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uID0gYWNjb3VudC5nZXQoImluYWN0aXZlX2ZvbGxvd19yZWFzb24iLCAiIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVhc29uIGluIFsixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBuZ8OgeSIsICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHBoacOqbiIsICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IiwgIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgc2Vzc2lvbiJdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5lbmFibGVfYWNjb3VudF9mb2xsb3coYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBlbmFibGUgbOG6oWkgZm9sbG93IGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCBuZ8OgeSAobMO9IGRvIGPFqToge3JlYXNvbn0pIikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHbhuqtuIGRpc2FibGUgZm9sbG93IChsw70gZG86IHtyZWFzb259KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUgdsOsIMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHksCiAgICAgICAgICAgICAgICAgICAgIyDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSB0aMOgbmggYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoInN0YXR1cyIpID09ICJpbmFjdGl2ZSIgYW5kIGFjY291bnQuZ2V0KCJpbmFjdGl2ZV9yZWFzb24iKSA9PSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvYl9kaXNhYmxlX3VudGlsIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIGFjdGl2ZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHNhdSBraGkgcmVzZXQiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgcmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIHbDoG8ge25vdy5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgbmfDoHkgxJHDoyByZXNldCB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsYXN0X3Jlc2V0X2RhdGUiLCB0b2RheS5pc29mb3JtYXQoKSkKICAgICAgICAKICAgIGRlZiBfY2FuX3J1bl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHRo4buDIGNo4bqheSBqb2IgY2hvIHTDoGkga2hv4bqjbiBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0aOG7gyBjaOG6oXkgam9iLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyAxLiBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuCiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2Jhc2ljX2FjY291bnRfc3RhdHVzKGFjY291bnQpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyAyLiBLaeG7g20gdHJhIMSRaeG7gXUga2nhu4duIGPhuqduIHRoaeG6v3QKICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfYWNjb3VudF9wcmVyZXF1aXNpdGVzKGFjY291bnQpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyAzLiDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcAogICAgICAgIGFjY291bnQgPSBzZWxmLl9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyA0LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkKICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KGFjY291bnQpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgbmfDoHkiKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoYWNjb3VudFsiaWQiXSwgIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiKQogICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfZm9yX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgNS4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIHRyb25nIHNlc3Npb24KICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAjIC4uLktIw5RORyBraeG7g20gdHJhIGZvbGxvdyDhu58gxJHDonksIGNo4buJIGtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24gY2h1bmcuLi4KICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuIGPhu6dhIHTDoGkga2hv4bqjbiIiIgogICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIGLhu4sgZGlzYWJsZWQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJkaXNhYmxlZCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dCwga2jDtG5nIGNobyBjaOG6oXkgam9iCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImxvZ291dCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyBpbmFjdGl2ZSwga2nhu4NtIHRyYSB0aOG7nWkgZ2lhbiBjb29sZG93bgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJY4butIGzDvSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiIiIKICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjb29sZG93biwgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSB0aW1lLnRpbWUoKToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICJsYXN0X2NhcmVfdGltZSI6IDAsCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLnVuZm9sbG93X2F0dGVtcHRzOgogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgZmV0Y2ggam9iIGVycm9yIGNvdW50cyBraGkgdMOgaSBraG/huqNuIGFjdGl2ZSBs4bqhaQogICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50czoKICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgZmV0Y2ggam9iIGVycm9yIGNvdW50cyBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBFbmFibGUgbOG6oWkgZm9sbG93IG7hur91IGLhu4sgZGlzYWJsZSB2w6wgZ2nhu5tpIGjhuqFuIHBoacOqbiAoa2jDtG5nIHBo4bqjaSB2w6wgZ2nhu5tpIGjhuqFuIG5nw6B5KQogICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZWFzb24gPSBhY2NvdW50LmdldCgiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiIsICIiKQogICAgICAgICAgICAgICAgZm9sbG93X3RvZGF5ID0gYWNjb3VudC5nZXQoImZvbGxvd190b2RheSIsIDApCiAgICAgICAgICAgICAgICBtYXhfZm9sbG93X2RheSA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X2RheSIsIDIwKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiByZWFzb24gPT0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgcGhpw6puIjoKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIG5nw6B5IGNoxrBhCiAgICAgICAgICAgICAgICAgICAgaWYgZm9sbG93X3RvZGF5IDwgbWF4X2ZvbGxvd19kYXk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5hYmxlX2FjY291bnRfZm9sbG93KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBlbmFibGUgbOG6oWkgZm9sbG93IGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSBraGkgYuG6r3QgxJHhuqd1IHNlc3Npb24gbeG7m2kgKGZvbGxvd190b2RheToge2ZvbGxvd190b2RheX0ve21heF9mb2xsb3dfZGF5fSkiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBuZ8OgeSAoe2ZvbGxvd190b2RheX0ve21heF9mb2xsb3dfZGF5fSksIGtow7RuZyBlbmFibGUgZm9sbG93IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSB24bqrbiBkaXNhYmxlIGZvbGxvdyAobMO9IGRvOiB7cmVhc29ufSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCDEkcOjIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgQ2jGsGEgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgY29vbGRvd25fcmVtYWluID0gaW50KChqb2JfZGlzYWJsZV91bnRpbCAtIHRpbWUudGltZSgpKSAvIDYwKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budIChjw7JuIHtjb29sZG93bl9yZW1haW59IHBow7p0KSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgYWNjb3VudF9pZDogaW50LCBpc19sb2dpbjogYm9vbCk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgdMOgaSBraG/huqNuIAogICAgICAgICAgICBpc19sb2dpbjogVHJ1ZSBu4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAsIEZhbHNlIG7hur91IGxvZ291dAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGF0YWJhc2UgLSBz4butIGThu6VuZyBmaWVsZCBpc19sb2dpbiDEkeG7gyBuaOG6pXQgcXXDoW4gduG7m2kgREIgc2NoZW1hCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgImlzX2xvZ2luIjogaXNfbG9naW4sCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyB0cm9uZyBtZW1vcnkKICAgICAgICAgICAgaWYgaXNfbG9naW46CiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24ga2jDoWMgY+G7p2EgY8O5bmcgYXBwIGzDoCBsb2dvdXQKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgb2xkX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGlmIG9sZF9hY2NvdW50X2lkICE9IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQob2xkX2FjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGPFqSB7b2xkX2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBsb2dvdXQiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzGsHUgdMOgaSBraG/huqNuIG3hu5tpCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBYw7NhIGto4buPaSB0cmFja2luZyBu4bq/dSBsb2dvdXQKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMgYW5kIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID09IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraOG7j2kgdHJhY2tpbmciKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXA6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYQogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiBj4bunYSB0w6BpIGtob+G6o24gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcCB24bubaSBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIGpvYl9tYXhfZGF5CiAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImpvYl9tYXhfZGF5Il0gPSBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRoaeG6v3QgbOG6rXAgbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICBpZiBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSA8PSAwOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsibWF4X2pvYnNfcGVyX3Nlc3Npb24iXSA9IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgIGlmIHVwZGF0ZV9kYXRhOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOzbmcgYXBwIHTGsMahbmcg4bupbmcgduG7m2kgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBjb25maWcuQVBQX1BBQ0tBR0VTOgogICAgICAgICAgICBzZWxmLmhlbHBlci5jbG9zZV9hcHAoY29uZmlnLkFQUF9QQUNLQUdFU1thcHBfbmFtZV0pCiAgICAgICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgcmV0dXJuIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheQogICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBzZXNzaW9uIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIHNlc3Npb24KICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgCiAgICAgICAgaWYgam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBzZXNzaW9uICh7am9ic19kb25lX2luX3Nlc3Npb259L3ttYXhfam9ic19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2hvIHTDoGkga2hv4bqjbiBuZ2jhu4kgdGhlbyB0aOG7nWkgZ2lhbiBqb2JfY29vbGRvd25fbWludXRlcwogICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5kYi5nZXQoImpvYl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gbmdo4buJIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCBzYXUga2hpIGhvw6BuIHRow6BuaCBzZXNzaW9uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGPDsyBz4bq1biB0cm9uZyBkYl9zZXJ2aWNlIMSR4buDIMSR4bq3dCB0w6BpIGtob+G6o24gaW5hY3RpdmUKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudFsiaWQiXSwKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9Y29vbGRvd25fbWludXRlcywKICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkhvw6BuIHRow6BuaCBzZXNzaW9uICh7am9ic19kb25lX2luX3Nlc3Npb259IGpvYnMpLCBuZ2jhu4kge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gY291bnRlciBzYXUga2hpIMSR4bq3dCBpbmFjdGl2ZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wgPSBUcnVlLCBqb2JfdHlwZTogc3RyID0gTm9uZSwgam9iX3Jlc3VsdDogZGljdCA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzdWNjZXNzOiBUcnVlIG7hur91IGpvYiB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICAgICBqb2JfdHlwZTogTG/huqFpIGpvYiAoZm9sbG93LCBsaWtlLCBldGMuKQogICAgICAgICAgICBqb2JfcmVzdWx0OiBL4bq/dCBxdeG6oyBqb2IgKGTDuW5nIMSR4buDIHjhu60gbMO9IHVuZm9sbG93KQogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIGpvYiBjxqEgYuG6o24gKGJhbyBn4buTbSBj4bqjIGZvbGxvdyBzdGF0cyBu4bq/dSBsw6AgZm9sbG93IGpvYikKICAgICAgICBzZWxmLl91cGRhdGVfYmFzaWNfam9iX3N0YXRzKGFjY291bnQsIHN1Y2Nlc3MsIGpvYl90eXBlKQogICAgICAgIAogICAgICAgICMgUmVzZXQgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIG7hur91IGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIGpvYiB0aMOgbmggY8O0bmcgKGtow7RuZyBwaOG6o2kgYuG7iyB1bmZvbGxvdykKICAgICAgICAgICAgaWYgbm90IChqb2JfcmVzdWx0IGFuZCBqb2JfcmVzdWx0LmdldCgidW5mb2xsb3ciLCBGYWxzZSkpOgogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAKICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiDEkcaw4bujYyB0aGnhur90IGzhuq1wCiAgICAgICAgYWNjb3VudCA9IHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIELhu48gcXVhIGtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIHNlc3Npb24gdsOsIMSRw6MgY2h1eeG7g24gc2FuZyBjb250aW51b3VzIHByb2Nlc3NpbmcKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeQogICAgICAgIHNlbGYuX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihhY2NvdW50KQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gdW5mb2xsb3cgY2hvIGpvYiBmb2xsb3cKICAgICAgICBpZiBqb2JfdHlwZSBhbmQgam9iX3R5cGUubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgIyBO4bq/dSBi4buLIHVuZm9sbG93IChqb2JfcmVzdWx0IGPDsyBrZXkgJ3VuZm9sbG93JyBob+G6t2Mgc3RhdHVzIMSR4bq3YyBiaeG7h3QpCiAgICAgICAgICAgIGlmIGpvYl9yZXN1bHQgYW5kIGpvYl9yZXN1bHQuZ2V0KCJ1bmZvbGxvdyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgVMSDbmcgc+G7kSBs4bqnbiBi4buLIHVuZm9sbG93IGNobyB0w6BpIGtob+G6o24gbsOgeQogICAgICAgICAgICAgICAgdW5mb2xsb3dfY291bnQgPSBzZWxmLnVuZm9sbG93X2F0dGVtcHRzLmdldChhY2NvdW50WyJpZCJdLCAwKSArIDEKICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSB1bmZvbGxvd19jb3VudAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtYXhfdW5mb2xsb3dfYXR0ZW1wdHMgPSBzZWxmLmRiLmdldCgibWF4X3VuZm9sbG93X2F0dGVtcHRzIiwgY29uZmlnLk1BWF9VTkZPTExPV19BVFRFTVBUUykKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gYuG7iyB1bmZvbGxvdyBs4bqnbiB7dW5mb2xsb3dfY291bnR9L3ttYXhfdW5mb2xsb3dfYXR0ZW1wdHN9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaOG7iSBraMOzYSB0w6BpIGtob+G6o24ga2hpIMSR4bqhdCBnaeG7m2kgaOG6oW4gc+G7kSBs4bqnbiB1bmZvbGxvdwogICAgICAgICAgICAgICAgaWYgdW5mb2xsb3dfY291bnQgPj0gbWF4X3VuZm9sbG93X2F0dGVtcHRzOgogICAgICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50gPSA3MjAgcGjDunQKICAgICAgICAgICAgICAgICAgICBhcHBfdHlwZSA9IGFjY291bnQuZ2V0KCJhcHAiLCAiIikubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBzYXUga2hpIGtow7NhCiAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBhcHBfdHlwZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBUaWtUb2s6IERpc2FibGUgdG/DoG4gYuG7mSB0w6BpIGtob+G6o24gKGtow7RuZyBjaOG7iSBmb2xsb3cpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIFRpa1RvayB7dXNlcm5hbWV9IMSRw6MgYuG7iyB1bmZvbGxvdyB7dW5mb2xsb3dfY291bnR9IGzhuqduLCBkaXNhYmxlIHRvw6BuIGLhu5kgdMOgaSBraG/huqNuIHtwZW5hbHR5X21pbnV0ZXN9IHBow7p0IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRbImlkIl0sIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJC4buLIHVuZm9sbG93IHt1bmZvbGxvd19jb3VudH0gbOG6p24gKFRpa1RvaykiCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBJbnN0YWdyYW06IENo4buJIGRpc2FibGUgZm9sbG93LCB0w6BpIGtob+G6o24gduG6q24gY8OzIHRo4buDIGzDoG0gam9iIGtow6FjCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIEluc3RhZ3JhbSB7dXNlcm5hbWV9IMSRw6MgYuG7iyB1bmZvbGxvdyB7dW5mb2xsb3dfY291bnR9IGzhuqduLCBkaXNhYmxlIGZvbGxvdyB7cGVuYWx0eV9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZGlzYWJsZV9hY2NvdW50X2ZvbGxvdygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudFsiaWQiXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFzb249ZiJC4buLIHVuZm9sbG93IHt1bmZvbGxvd19jb3VudH0gbOG6p24iCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBi4buLIHVuZm9sbG93IG5oxrBuZyBjaMawYSDEkeG6oXQgZ2nhu5tpIGjhuqFuICh7dW5mb2xsb3dfY291bnR9L3ttYXhfdW5mb2xsb3dfYXR0ZW1wdHN9KSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEpvYiB0aMOgbmggY8O0bmcgdsOgIGtow7RuZyBi4buLIHVuZm9sbG93LCByZXNldCBjb3VudGVyCiAgICAgICAgICAgICAgICBpZiBzdWNjZXNzIGFuZCBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wsIGpvYl90eXBlOiBzdHIgPSBOb25lKToKICAgICAgICAiIiJD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iIGPGoSBi4bqjbiAtIGfhu5lwIGPhuqMgZm9sbG93IHN0YXRzIMSR4buDIHRyw6FuaCBj4bqtcCBuaOG6rXQgdHLDuW5nIGzhurdwIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgImxhc3Rfam9iX3RpbWUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgQ2jhu4kgdMSDbmcgY291bnRlcnMga2hpIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgImpvYl90b2RheSI6IGpvYl90b2RheSArIDEsCiAgICAgICAgICAgICAgICAidG90YWxfam9icyI6IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkgKyAxLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogam9ic19kb25lX2luX3Nlc3Npb24gKyAxCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGzDoCBmb2xsb3cgam9iLCBj4bqtcCBuaOG6rXQgbHXDtG4gZm9sbG93IHN0YXRzIMSR4buDIHRyw6FuaCAyIGzhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICBpZiBqb2JfdHlwZSBhbmQgam9iX3R5cGUubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKSArIDEKICAgICAgICAgICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkgKyAxCiAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YS51cGRhdGUoewogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiBmb2xsb3dfdG9kYXksCiAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogZm9sbG93X2luX3Nlc3Npb24sCiAgICAgICAgICAgICAgICAgICAgImxhc3RfZm9sbG93X3RpbWUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIHRo4buxYyBoaeG7h24gZm9sbG93IHRow6BuaCBjw7RuZyAtIFNlc3Npb246IHtmb2xsb3dfaW5fc2Vzc2lvbn0sIEjDtG0gbmF5OiB7Zm9sbG93X3RvZGF5fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZyB0aMO0bmcgdGluIHThu5VuZyBxdWFuIHbhu4Egam9icwogICAgICAgICAgICBqb2JzX2RvbmVfc2Vzc2lvbiA9IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMQogICAgICAgICAgICBqb2JzX3RvZGF5ID0gam9iX3RvZGF5ICsgMQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGhvw6BuIHRow6BuaCBqb2IgLSBTZXNzaW9uOiB7am9ic19kb25lX3Nlc3Npb259L3thY2NvdW50LmdldCgnbWF4X2pvYnNfcGVyX3Nlc3Npb24nLCBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04pfSwgSMO0bSBuYXk6IHtqb2JzX3RvZGF5fS97YWNjb3VudC5nZXQoJ2pvYl9tYXhfZGF5JywgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkpfSIpCiAgICAgICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpICAjIEPhuq1wIG5o4bqtdCBsb2NhbCBkYXRhCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkgc2F1IGtoaSBsw6BtIGpvYiIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYl9tYXhfZGF5ID0gYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9iX3RvZGF5ID49IGpvYl9tYXhfZGF5OgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgbmfDoHkgKHtqb2JfdG9kYXl9L3tqb2JfbWF4X2RheX0pIikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF9zZXRfYWNjb3VudF9sb2dvdXQoc2VsZiwgYWNjb3VudF9pZDogaW50LCB1c2VybmFtZTogc3RyID0gTm9uZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIMSRw6MgbG9nb3V0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF9pZDogSUQgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVzZXJuYW1lOiBVc2VybmFtZSDEkeG7gyBsb2cgKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBU4bqhbyBtZXNzYWdlIHbhu5tpIG5nw6B5IGdp4budIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJVkgJUg6JU06JVMiKQogICAgICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYiUGjDoXQgaGnhu4duIGxvZ291dDoge2N1cnJlbnRfdGltZX0iCiAgICAgICAgICAgIAogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IHTDoGkga2hv4bqjbiB7dXNlcm5hbWUgb3IgYWNjb3VudF9pZH0gbMOgIGxvZ291dCIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nb3V0IGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lIG9yIGFjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAKICAgIGRlZiByZXNldF9leHBpcmVkX2FjY291bnRzKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budIHbDoCBkaXNhYmxlX2ZvbGxvdyDEkcOjIGjhur90IGjhuqFuCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDEuIFJlc2V0IGluYWN0aXZlIGFjY291bnRzCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGluYWN0aXZlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImluYWN0aXZlIikgb3IgW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gaW5hY3RpdmVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoSUQ6IHthY2NvdW50WydpZCddfSkgduG6q24gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBSZXNldCBkaXNhYmxlX2ZvbGxvdyBhY2NvdW50cyDEkcOjIGjhur90IGjhuqFuCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFsbF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkgb3IgW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWxsX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJkaXNhYmxlX2ZvbGxvdyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgZm9sbG93X2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiZm9sbG93X2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSDEkcOjIGjhur90IHRo4budaSBnaWFuIGRpc2FibGUgZm9sbG93CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGZvbGxvd19kaXNhYmxlX3VudGlsID4gMCBhbmQgZm9sbG93X2Rpc2FibGVfdW50aWwgPD0gY3VycmVudF90aW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gZGlzYWJsZSBmb2xsb3csIGVuYWJsZSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmVuYWJsZV9hY2NvdW50X2ZvbGxvdyhhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZS9kaXNhYmxlX2ZvbGxvdyIpCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PSBTTUFSVCBDQVJFIFNZU1RFTSA9PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAKICAgIGRlZiBfc2hvdWxkX3BlcmZvcm1fY2FyZV9zbWFydChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgY29udGV4dDogc3RyID0gImlkbGUiKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdGjDtG5nIG1pbmggeGVtIGPDsyBuw6puIGNhcmUga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgY29udGV4dDogImlkbGUiIChraMO0bmcgY8OzIGpvYikgaG/hurdjICJhZnRlcl9qb2IiIChzYXUga2hpIGzDoG0gam9iKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG7Dqm4gY2FyZSwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuZGIuZ2V0KCJlbmFibGVfY2FyZSIsIFRydWUpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIFJhbmRvbSBjaGFuY2UgY8ahIGLhuqNuCiAgICAgICAgYmFzZV9jaGFuY2UgPSBzZWxmLmRiLmdldCgiY2FyZV9jaGFuY2VfcGVyY2VudCIsIDMwKQogICAgICAgIAogICAgICAgICMgxJBp4buBdSBjaOG7iW5oIGNoYW5jZSBk4buxYSB0csOqbiBjb250ZXh0CiAgICAgICAgaWYgY29udGV4dCA9PSAiYWZ0ZXJfam9iIjoKICAgICAgICAgICAgY2hhbmNlID0gYmFzZV9jaGFuY2UgLy8gMiAgIyAxNSUgc2F1IGpvYiAow610IGjGoW4pCiAgICAgICAgZWxzZToKICAgICAgICAgICAgY2hhbmNlID0gYmFzZV9jaGFuY2UgICAgICAgIyAzMCUga2hpIGlkbGUKICAgICAgICAKICAgICAgICBpZiByYW5kb20ucmFuZGludCgxLCAxMDApID4gY2hhbmNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgaW50ZXJ2YWwKICAgICAgICBsYXN0X2NhcmVfdGltZSA9IGFjY291bnQuZ2V0KCJsYXN0X2NhcmVfdGltZSIsIDApCiAgICAgICAgY2FyZV9pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJjYXJlX2ludGVydmFsX2hvdXJzIiwgNCkgKiAzNjAwCiAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICBpZiAoY3VycmVudF90aW1lIC0gbGFzdF9jYXJlX3RpbWUpIDwgY2FyZV9pbnRlcnZhbDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHByb3h5IG7hur91IGLhuq90IGJ14buZYyBz4butIGThu6VuZwogICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgIGlmIHVzZV9wcm94eToKICAgICAgICAgICAgcHJveHlfc2VydmVyID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygicHJveHlfc2VydmVyIiwgIiIpCiAgICAgICAgICAgIGlmIG5vdCBwcm94eV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgS2jDtG5nIGNhcmUgbuG6v3UgYuG6r3QgYnXhu5ljIHByb3h5IG5oxrBuZyBjaMawYSBj4bqldSBow6xuaAogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV93b3JraW5nKHByb3h5X3NlcnZlcik6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgS2jDtG5nIGNhcmUgbuG6v3UgcHJveHkga2jDtG5nIGhv4bqhdCDEkeG7mW5nCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgIAogICAgZGVmIF9nZXRfc21hcnRfY2FyZV90eXBlKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBjb250ZXh0OiBzdHIgPSAiaWRsZSIpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBU4buxIMSR4buZbmcgY2jhu41uIGxv4bqhaSBjYXJlIHBow7kgaOG7o3AgZOG7sWEgdHLDqm4gdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBjb250ZXh0OiAiaWRsZSIgaG/hurdjICJhZnRlcl9qb2IiCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogTG/huqFpIGNhcmUgcGjDuSBo4bujcAogICAgICAgICIiIgogICAgICAgICMgUGjDom4gdMOtY2ggdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24gxJHhu4MgY2jhu41uIGNhcmUgdHlwZSBwaMO5IGjhu6NwCiAgICAgICAgdG90YWxfam9icyA9IGFjY291bnQuZ2V0KCJ0b3RhbF9qb2JzIiwgMCkKICAgICAgICBmb2xsb3dfdG9kYXkgPSBhY2NvdW50LmdldCgiZm9sbG93X3RvZGF5IiwgMCkKICAgICAgICBsYXN0X3Bvc3RfdGltZSA9IGFjY291bnQuZ2V0KCJsYXN0X3Bvc3RfbmV3ZmVlZCIsIDApCiAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgTG9naWMgdGjDtG5nIG1pbmg6CiAgICAgICAgIyAxLiBUw6BpIGtob+G6o24gbeG7m2kgKMOtdCBqb2IpIC0+IGFuIHRvw6BuIG5o4bqldAogICAgICAgIGlmIHRvdGFsX2pvYnMgPCAxMDoKICAgICAgICAgICAgcmV0dXJuICJzd2lwZV9mZWVkIgogICAgICAgIAogICAgICAgICMgMi4gVMOgaSBraG/huqNuIMSRw6MgZm9sbG93IG5oaeG7gXUgaMO0bSBuYXkgLT4gdHLDoW5oIGZvbGxvdy1yZWxhdGVkIGFjdGlvbnMKICAgICAgICBlbGlmIGZvbGxvd190b2RheSA+IDEwOgogICAgICAgICAgICByZXR1cm4gIndhdGNoX2NvbnRlbnQiICAjIHdhdGNoX3JlZWxzIGNobyBJbnN0YWdyYW0sIHdhdGNoX3ZpZGVvcyBjaG8gVGlrVG9rCiAgICAgICAgCiAgICAgICAgIyAzLiBDb250ZXh0IHNhdSBqb2IgLT4gdGjGsCBnacOjbiwgY8OzIHRo4buDIMSRxINuZyBiw6BpCiAgICAgICAgZWxpZiBjb250ZXh0ID09ICJhZnRlcl9qb2IiOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgxJHhu6cgxJFp4buBdSBraeG7h24gxJHEg25nIGLDoGkgKDIgbmfDoHkpCiAgICAgICAgICAgIHR3b19kYXlzX3NlY29uZHMgPSAyICogMjQgKiA2MCAqIDYwCiAgICAgICAgICAgIGlmIGxhc3RfcG9zdF90aW1lID09IDAgb3IgKGN1cnJlbnRfdGltZSAtIGxhc3RfcG9zdF90aW1lKSA+PSB0d29fZGF5c19zZWNvbmRzOgogICAgICAgICAgICAgICAgIyAzMCUgY2hhbmNlIMSRxINuZyBiw6BpIGtoaSDEkeG7pyDEkWnhu4F1IGtp4buHbgogICAgICAgICAgICAgICAgaWYgcmFuZG9tLnJhbmRpbnQoMSwgMTAwKSA8PSAzMDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gInBvc3RfY29udGVudCIKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByYW5kb20uY2hvaWNlKFsid2F0Y2hfY29udGVudCIsICJ2aWV3X25vdGlmaWNhdGlvbnMiXSkKICAgICAgICAKICAgICAgICAjIDQuIERlZmF1bHQgLSByYW5kb20gZ2nhu69hIGPDoWMgYWN0aW9uIGFuIHRvw6BuCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIMSRaeG7gXUga2nhu4duIMSRxINuZyBiw6BpIGNobyBpZGxlIGNvbnRleHQKICAgICAgICAgICAgdHdvX2RheXNfc2Vjb25kcyA9IDIgKiAyNCAqIDYwICogNjAKICAgICAgICAgICAgaWYgbGFzdF9wb3N0X3RpbWUgPT0gMCBvciAoY3VycmVudF90aW1lIC0gbGFzdF9wb3N0X3RpbWUpID49IHR3b19kYXlzX3NlY29uZHM6CiAgICAgICAgICAgICAgICAjIDE1JSBjaGFuY2UgxJHEg25nIGLDoGkga2hpIGlkbGUgdsOgIMSR4bunIMSRaeG7gXUga2nhu4duCiAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZGludCgxLCAxMDApIDw9IDE1OgogICAgICAgICAgICAgICAgICAgIHJldHVybiAicG9zdF9jb250ZW50IgogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHJhbmRvbS5jaG9pY2UoWyJzd2lwZV9mZWVkIiwgIndhdGNoX2NvbnRlbnQiXSkKICAgIAogICAgZGVmIF9wZXJmb3JtX3NtYXJ0X2NhcmUoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGNvbnRleHQ6IHN0ciA9ICJpZGxlIikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGNhcmUgdGjDtG5nIG1pbmggLSB04buxIMSR4buZbmcgY2jhu41uIGxv4bqhaSBjYXJlIHbDoCB0aOG7sWMgaGnhu4duCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgY29udGV4dDogImlkbGUiIGhv4bq3YyAiYWZ0ZXJfam9iIgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiLCAiIikKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBwcm94eSBu4bq/dSBi4bqvdCBideG7mWMgc+G7rSBk4bulbmcKICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgIGlmIHVzZV9wcm94eToKICAgICAgICAgICAgICAgIHByb3h5X3NlcnZlciA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoInByb3h5X3NlcnZlciIsICIiKQogICAgICAgICAgICAgICAgaWYgbm90IHByb3h5X3NlcnZlcjoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNtYXJ0IGNhcmUgYuG7iyBo4buneSAtIGLhuq90IGJ14buZYyBkw7luZyBwcm94eSBuaMawbmcgY2jGsGEgY+G6pXUgaMOsbmggcHJveHlfc2VydmVyIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfd29ya2luZyhwcm94eV9zZXJ2ZXIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU21hcnQgY2FyZSBi4buLIGjhu6d5IC0gcHJveHkge3Byb3h5X3NlcnZlcn0ga2jDtG5nIGhv4bqhdCDEkeG7mW5nIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTbWFydCBjYXJlIHPhu60gZOG7pW5nIHByb3h5OiB7cHJveHlfc2VydmVyfSBjaG8ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThu7EgxJHhu5luZyBjaOG7jW4gY2FyZSB0eXBlCiAgICAgICAgICAgIGNhcmVfdHlwZSA9IHNlbGYuX2dldF9zbWFydF9jYXJlX3R5cGUoYWNjb3VudCwgY29udGV4dCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTWFwcGluZyBtZXRob2QgduG7m2kgdMOqbiDEkeG7k25nIG5o4bqldCBnaeG7r2EgSW5zdGFncmFtIHbDoCBUaWtUb2sKICAgICAgICAgICAgY2FyZV9tZXRob2RzID0gewogICAgICAgICAgICAgICAgInN3aXBlX2ZlZWQiOiAiX2NhcmVfc3dpcGVfZmVlZCIsICAgICAgICAgICAjIMSQ4buTbmcgbmjhuqV0OiBsxrDhu5t0IGZlZWQKICAgICAgICAgICAgICAgICJ3YXRjaF9jb250ZW50Ijogc2VsZi5fZ2V0X3dhdGNoX21ldGhvZChhcHBfbmFtZSksICAjIFRow7RuZyBtaW5oOiByZWVscyB2cyB2aWRlb3MKICAgICAgICAgICAgICAgICJ2aWV3X25vdGlmaWNhdGlvbnMiOiAiX2NhcmVfdmlld19ub3RpZmljYXRpb25zIiwgICAjIMSQ4buTbmcgbmjhuqV0OiB4ZW0gdGjDtG5nIGLDoW8KICAgICAgICAgICAgICAgICJwb3N0X2NvbnRlbnQiOiAicG9zdF9uZXdmZWVkIiAgICAgICAgICAgICAgIyDEkOG7k25nIG5o4bqldDogxJHEg25nIGLDoGkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgbWV0aG9kX25hbWUgPSBjYXJlX21ldGhvZHMuZ2V0KGNhcmVfdHlwZSwgIl9jYXJlX3N3aXBlX2ZlZWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoaGFuZGxlciwgbWV0aG9kX25hbWUpOgogICAgICAgICAgICAgICAgbWV0aG9kX25hbWUgPSAiX2NhcmVfc3dpcGVfZmVlZCIgICMgRmFsbGJhY2sgYW4gdG/DoG4gbmjhuqV0CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gY2FyZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNtYXJ0IGNhcmU6IHt1c2VybmFtZX0gKHthcHBfbmFtZX0pIC0+IHtjYXJlX3R5cGV9IFt7bWV0aG9kX25hbWV9XSIpCiAgICAgICAgICAgIG1ldGhvZCA9IGdldGF0dHIoaGFuZGxlciwgbWV0aG9kX25hbWUpCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBtZXRob2QoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDs25nIGFwcCBzYXUga2hpIGNhcmUgeG9uZyAocXVhbiB0cuG7jW5nIMSR4buDIHRyw6FuaCBhcHAgY2jhuqF5IGJhY2tncm91bmQpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IHNhdSBraGkgU21hcnQgY2FyZSBjaG8ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBoYW5kbGVyLmNsb3NlX2FwcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgaGFuZGxlci5zYWZlX3NsZWVwKDIpOiAgIyBDaOG7nSBhcHAgxJHDs25nIGhvw6BuIHRvw6BuCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTYWZlIHNsZWVwIGLhu4sgaW50ZXJydXB0IGtoaSDEkcOzbmcgYXBwIHNhdSBTbWFydCBjYXJlIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDs25nIGFwcCBzYXUgU21hcnQgY2FyZToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7nWkgZ2lhbiBjYXJlCiAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiBjdXJyZW50X3RpbWUsCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGzDoCBwb3N0X2NvbnRlbnQgdsOgIHRow6BuaCBjw7RuZywgY+G6rXAgbmjhuq10IHRow6ptIGxhc3RfcG9zdF9uZXdmZWVkCiAgICAgICAgICAgICAgICBpZiBjYXJlX3R5cGUgPT0gInBvc3RfY29udGVudCI6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFbImxhc3RfcG9zdF9uZXdmZWVkIl0gPSBjdXJyZW50X3RpbWUKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNtYXJ0IGNhcmUgLSDEkcSDbmcgYsOgaSB0aMOgbmggY8O0bmc6IHt1c2VybmFtZX0sIGPhuq1wIG5o4bqtdCBsYXN0X3Bvc3RfbmV3ZmVlZCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNtYXJ0IGNhcmUgdGjDoG5oIGPDtG5nOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiU21hcnQgY2FyZSB0aOG6pXQgYuG6oWk6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHN1Y2Nlc3MKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBzbWFydCBjYXJlIGNobyB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICcnKX06IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkcOzbmcgYXBwIG5nYXkgY+G6oyBraGkgY8OzIGzhu5dpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIsICIiKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IHNhdSBs4buXaSBTbWFydCBjYXJlIikKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLmNsb3NlX2FwcCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgY2xvc2VfZXJyb3I6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSDEkcOzbmcgYXBwIHNhdSBs4buXaSBTbWFydCBjYXJlOiB7Y2xvc2VfZXJyb3J9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2dldF93YXRjaF9tZXRob2Qoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIFRy4bqjIHbhu4EgbWV0aG9kIG5hbWUgcGjDuSBo4bujcCBjaG8gdmnhu4djIHhlbSBjb250ZW50IHRoZW8gcGxhdGZvcm0KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAgKCJpbnN0YWdyYW0iIGhv4bq3YyAidGlrdG9rIikKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBUw6puIG1ldGhvZCBwaMO5IGjhu6NwCiAgICAgICAgIiIiCiAgICAgICAgaWYgYXBwX25hbWUgPT0gImluc3RhZ3JhbSI6CiAgICAgICAgICAgIHJldHVybiAiX2NhcmVfd2F0Y2hfcmVlbHMiICAgICMgSW5zdGFncmFtOiB4ZW0gcmVlbHMKICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJ0aWt0b2siOgogICAgICAgICAgICByZXR1cm4gIl9jYXJlX3dhdGNoX3ZpZGVvcyIgICAjIFRpa1RvazogeGVtIHZpZGVvcwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiAiX2NhcmVfc3dpcGVfZmVlZCIgICAgICMgRGVmYXVsdCBmYWxsYmFjawogICAgCiAgICBkZWYgX2dldF9yYW5kb21fYWNjb3VudF9mb3JfY2FyZShzZWxmKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgcmFuZG9tIDEgdMOgaSBraG/huqNuIGPhuqduIGNhcmUgKHTDoGkga2hv4bqjbiBraMO0bmcgdGjhu4MgbMOgbSBqb2IgbmjGsG5nIHbhuqtuIMSRxINuZyBuaOG6rXApCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOiBUw6BpIGtob+G6o24gY+G6p24gY2FyZSBob+G6t2MgTm9uZQogICAgICAgICIiIgogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIGNhcmVfY2FuZGlkYXRlcyA9IFtdCiAgICAgICAgCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgIyBDYXJlIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSAoZMO5IGlzX2xvZ2luPUZhbHNlKSBob+G6t2MgdMOgaSBraG/huqNuIGxvZ2luIG5oxrBuZyBraMO0bmcgdGjhu4MgbMOgbSBqb2IKICAgICAgICAgICAgICAgIHN0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiIikKICAgICAgICAgICAgICAgIGlzX2xvZ2luID0gYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJBp4buBdSBraeG7h24gY2FyZToKICAgICAgICAgICAgICAgICMgMS4gVMOgaSBraG/huqNuIGluYWN0aXZlIChj4bqnbiBjYXJlIMSR4buDIHJlYWN0aXZlKQogICAgICAgICAgICAgICAgIyAyLiBUw6BpIGtob+G6o24gxJHEg25nIG5o4bqtcCBuaMawbmcga2jDtG5nIHRo4buDIGzDoG0gam9iICh3YWl0aW5nLCBkaXNhYmxlZCBmb2xsb3csIGV0Yy4pCiAgICAgICAgICAgICAgICBpZiAoc3RhdHVzID09ICJpbmFjdGl2ZSIpIG9yIChpc19sb2dpbiBhbmQgbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpKToKICAgICAgICAgICAgICAgICAgICBpZiBzdGF0dXMgaW4gWyJhY3RpdmUiLCAid2FpdGluZyIsICJpbmFjdGl2ZSJdOiAgIyBMb+G6oWkgdHLhu6sgZGlzYWJsZWQsIGxvZ291dAogICAgICAgICAgICAgICAgICAgICAgICBjYXJlX2NhbmRpZGF0ZXMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIHJhbmRvbS5jaG9pY2UoY2FyZV9jYW5kaWRhdGVzKSBpZiBjYXJlX2NhbmRpZGF0ZXMgZWxzZSBOb25lCiAgICAgICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT0gRU5EIFNNQVJUIENBUkUgU1lTVEVNID09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICAgICAKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIHRyb25nIHRocmVhZCByacOqbmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkOiBUaHJlYWQgxJFhbmcgY2jhuqF5IEpvYlNlcnZpY2UgaG/hurdjIE5vbmUgbuG6v3UgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IHRy4bqhbmcgdGjDoWkgcnVubmluZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHRyYWNraW5nIMSR4buDIHZlcmlmeSBs4bqhaSB04burIMSR4bqndQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGNvdW50ZXJzIGtoaSBi4bqvdCDEkeG6p3UgcGhpw6puIG3hu5tpCiAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHMuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5jbGVhcigpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbygiQ2xlYXIgYWNjb3VudCB0cmFja2luZyB2w6AgcmVzZXQgZXJyb3IgY291bnRlcnMgxJHhu4MgdmVyaWZ5IGzhuqFpIHThu6sgxJHhuqd1IGtoaSBraOG7n2kgxJHhu5luZyIpCiAgICAgICAgICAgIAoKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gdGhyZWFkCiAgICAgICAgICAgIHRocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYucnVuKQogICAgICAgICAgICB0aHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgICB0aHJlYWQuc3RhcnQoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHRocmVhZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgIGRlZiByZXNldF9sb2dvdXRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgcmVzZXQgY8OhYyB0w6BpIGtob+G6o24gbG9nb3V0IHbhu4EgYWN0aXZlIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgQ2jhu4kgbsOqbiBn4buNaSBtZXRob2QgbsOgeSBraGkgY8OzIHnDqnUgY+G6p3UgxJHhurdjIGJp4buHdCB04burIGFkbWluCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24g4bufIHRy4bqhbmcgdGjDoWkgbG9nb3V0CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ291dF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJsb2dvdXQiKSBvciBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBsb2dvdXRfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCB0w6BpIGtob+G6o24gbG9nb3V0IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBmZXRjaCBqb2IgZXJyb3IgY291bnRzIGtoaSByZXNldCB0w6BpIGtob+G6o24gbG9nb3V0CiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLCAKICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSByZXNldCB0w6BpIGtob+G6o24gbG9nb3V0IikKICAgIAogICAgZGVmIGlzX2FjY291bnRfY2FuX3J1bl9qb2Ioc2VsZiwgYXBwX25hbWU6c3RyICkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGNo4bqheSBqb2Iga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgIGlmKHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBydW4oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgQ2jhuqF5IEpvYlNlcnZpY2UgdHJvbmcgdsOybmcgbOG6t3AgxJHGoW4gZ2nhuqNuIC0gbOG6pXkgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBKb2JTZXJ2aWNlIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHThu7EgxJHhu5luZy4uLiIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGRldmljZV9pZAogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICAKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQgaGnhu4duIHThuqFpLCBKb2JTZXJ2aWNlIGtow7RuZyB0aOG7gyBjaOG6oXkiKQogICAgICAgICAgICByZXR1cm4KIAogICAgICAgIHdoaWxlIHNlbGYucnVubmluZzoKICAgICAgICAgICAgIyBSZXNldCBiaeG6v24gZm9yY2Vfc3RvcCBu4bq/dSBjw7MKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICBpZiBzZWxmLmRiLmdldCgicGF1c2Vfam9iIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPDsyB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciwgdOG6oW0gZOG7q25nIHjhu60gbMO9IGpvYiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBraGkgYuG7iyB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdHJhY2tpbmcgdmFyaWFibGUga2hpIHVucmVnaXN0ZXIgcHJveHkKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfUEFVU0VEX1NFUlZFUikKICAgICAgICAgICAgICAgIGpvYl9jaGVja19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gZXhwaXJlZCDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIHNlbGYucmVzZXRfZXhwaXJlZF9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gxJHEg25nIGvDvSBwcm94eSBraMO0bmcKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBGZXRjaCBHb0xpa2UgaGVhZGVycyB0csaw4bubYyBraGkgbMOgbSBi4bqldCBr4buzIHZp4buHYyBnw6wgY+G6p24gQVBJCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gbMOgbSBt4bubaSBHb0xpa2UgaGVhZGVycyBraMO0bmcKICAgICAgICAgICAgICAgICAgICBuZWVkc19oZWFkZXJzX3JlZnJlc2ggPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLm5lZWRzX2hlYWRlcnNfcmVmcmVzaCgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gY8OzIHByb3h5IG7hur91IGPhuqduIGZldGNoIGhlYWRlcnMgbeG7m2kKICAgICAgICAgICAgICAgICAgICBpZiBuZWVkc19oZWFkZXJzX3JlZnJlc2g6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiRmV0Y2ggR29MaWtlIGhlYWRlcnMiKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBmZXRjaCBHb0xpa2UgaGVhZGVycywgbmdo4buJIDEwcyB0csaw4bubYyBraGkgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgbmVlZHNfaGVhZGVyc19yZWZyZXNoOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkdvTGlrZSBoZWFkZXJzIGPDsm4gaOG7o3AgbOG7hywga2jDtG5nIGPhuqduIMSRxINuZyBrw70gcHJveHkgxJHhu4MgZmV0Y2giKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBpbnRlcm5ldCBzYXUga2hpIHjhu60gbMO9IHByb3h5ICh2w6wgcHJveHkgY8OzIHRo4buDIOG6o25oIGjGsOG7n25nIMSR4bq/biBr4bq/dCBu4buRaSkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuY2hlY2tfaW50ZXJuZXQoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyBjw7Mga+G6v3QgbuG7kWkgaW50ZXJuZXQsIG5naOG7iSAyMHMgdsOgIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgyMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGdvbGlrZV9oZWFkZXJzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZ29saWtlX2hlYWRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJHb0xpa2UgaGVhZGVycyBraMO0bmcgaOG7o3AgbOG7hywgbmdo4buJIDVzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmZXRjaCBHb0xpa2UgaGVhZGVyczoge2V9LCBuZ2jhu4kgNXMgdsOgIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAxOiBLaeG7g20gdHJhIHbDoCDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIG7hur91IGPDsyB5w6p1IGPhuqd1CiAgICAgICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnMgYW5kIHNlbGYuX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBQcm94eSB2w6AgR29MaWtlIGhlYWRlcnMgxJHDoyDEkcaw4bujYyDEkeG6o20gYuG6o28g4bufIHRyw6puCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudHNfZm9yX2FwcChhcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgIyBTYXUga2hpIMSR4buTbmcgYuG7mSwgY2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgcXXDqXQgbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCBhbmQgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudC5nZXQoImFwcCIpID09IGFwcF9uYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDbGVhciB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHNhdSBraGkgxJHhu5NuZyBi4buZIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDI6IFTDrG0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgYWNjb3VudF90b193b3JrID0gc2VsZi5fZ2V0X25leHRfd29ya2FibGVfYWNjb3VudCgpCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50X3RvX3dvcms6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIMSRxrDhu6NjIGNo4buNbiDEkeG7gyBsw6BtIHZp4buHYzoge2FjY291bnRfdG9fd29yay5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3RvX3dvcms6CiAgICAgICAgICAgICAgICAgICAgIyBUxINuZyBjb3VudGVyIGtow7RuZyBjw7Mgam9iCiAgICAgICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgKz0gMQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyAobOG6p24ge3NlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50fSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVW5yZWdpc3RlciBwcm94eSBuZ2F5IGtoaSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyB0aeG6v3Qga2nhu4dtCiAgICAgICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJVbnJlZ2lzdGVyIHByb3h5IGRvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHRyYWNraW5nIHZhcmlhYmxlIGtoaSB1bnJlZ2lzdGVyIHByb3h5CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgxJDDs25nIHThuqV0IGPhuqMgYXBwIHNhdSAzIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID49IDM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOzbmcgdOG6pXQgY+G6oyBhcHAgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MgdHJvbmcgdGjhu51pIGdpYW4gZMOgaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSwgaGFuZGxlciBpbiBzZWxmLmpvYl9oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IGRvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoaGFuZGxlciwgYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIMSRw7NuZyBhcHA6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX05PX0FDQ09VTlRTKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVGjhu60gc21hcnQgY2FyZSBjaG8gdMOgaSBraG/huqNuIGlkbGUgdHLGsOG7m2Mga2hpIG5naOG7iQogICAgICAgICAgICAgICAgICAgIGNhcmVfYWNjb3VudCA9IHNlbGYuX2dldF9yYW5kb21fYWNjb3VudF9mb3JfY2FyZSgpCiAgICAgICAgICAgICAgICAgICAgaWYgY2FyZV9hY2NvdW50IGFuZCBzZWxmLl9zaG91bGRfcGVyZm9ybV9jYXJlX3NtYXJ0KGNhcmVfYWNjb3VudCwgImlkbGUiKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTbWFydCBjYXJlIGNobyB0w6BpIGtob+G6o24gaWRsZToge2NhcmVfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiU21hcnQgY2FyZSBpZGxlIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJDYXJlOiB7Y2FyZV9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FyZV9zdWNjZXNzID0gc2VsZi5fcGVyZm9ybV9zbWFydF9jYXJlKGNhcmVfYWNjb3VudCwgImlkbGUiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgY2FyZV9zdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU21hcnQgY2FyZSBpZGxlIHRow6BuaCBjw7RuZyBjaG8ge2NhcmVfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTmdo4buJIHNhdSBjYXJlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS5yYW5kaW50KDMwLCA2MCkpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmdo4buJIG3hu5l0IGtob+G6o25nIG5n4bqvbiB0csaw4bubYyBraGkga2nhu4NtIHRyYSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBraGkgY8OzIHTDoGkga2hv4bqjbiDEkeG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5ub19qb2JfY29uc2VjdXRpdmVfY291bnQgPSAwCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRm9yY2UgdmVyaWZ5IGFjY291bnQgbuG6v3UgY2jGsGEgxJHGsOG7o2MgdmVyaWZ5IHbDoCBjw7MgcHJveHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgICAgIHNlbGYuX2ZvcmNlX3ZlcmlmeV9hY2NvdW50c193aXRoX3Byb3h5KCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBCxrDhu5tjIDM6IFjDoWMgbmjhuq1uIGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW4gxJHhu4MgdHLDoW5oIGzDoG0gc2FpIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nIHNhdSBraGkgdmVyaWZ5CiAgICAgICAgICAgICAgICBhY2NvdW50X3RvX3dvcmsgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfdG9fd29ya1siaWQiXSkKICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3RvX3dvcmsgb3Igbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnRfdG9fd29yayk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ga2jDtG5nIHRo4buDIGzDoG0gdmnhu4djIG7hu69hIHNhdSBraGkgdmVyaWZ5LCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICAgICAgIyBDbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCB2w6wga2jDtG5nIHRo4buDIGzDoG0gdmnhu4djIG7hu69hCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBuw6puIMSRw7NuZyBhcHAga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYW5kX2Nsb3NlX2FwcF9pZl9uZWVkZWQoYWNjb3VudF90b193b3JrLmdldCgiYXBwIikgaWYgYWNjb3VudF90b193b3JrIGVsc2UgTm9uZSkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSDEkWFuZyBsw6BtIHZp4buHYyBzYXUga2hpIMSRw6MgeMOhYyBuaOG6rW4gdMOgaSBraG/huqNuIGjhu6NwIGzhu4cKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIFRydWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGN1cnJlbnQgd29ya2luZyBhY2NvdW50IHbhu5tpIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gYWNjb3VudF90b193b3JrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSB0csaw4bubYyBraGkgbMOgbSBqb2IgKG7hur91IGPhuqduKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKCJMw6BtIGpvYiIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBsw6BtIGpvYiwgbmdo4buJIDEwcyB0csaw4bubYyBraGkgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBzZWxmLl93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoYWNjb3VudF90b193b3JrKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBuw6puIMSRw7NuZyBhcHAgc2F1IGtoaSBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIG5vdCBqb2JfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgY8OzIGzhu5dpLCBjbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBxdcOpdCBs4bqhaQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgIyBDw7MgdGjhu4MgY+G6p24gxJHDs25nIGFwcAogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FuZF9jbG9zZV9hcHBfaWZfbmVlZGVkKGFjY291bnRfdG9fd29yay5nZXQoImFwcCIpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgbOG6p24gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGpvYl9jaGVja19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0KCJqb2JfY2hlY2tfaW50ZXJ2YWwiLCBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChqb2JfY2hlY2tfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kgdHJvbmcgdsOybmcgbOG6t3AgY2jDrW5oIikKICAgICAgICAgICAgICAgICMgTmdo4buJIG3hu5l0IGNow7p0IHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgzMCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgIyBOaOG6oyBwcm94eSBraGkgdGhvw6F0CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkga2hpIEpvYlNlcnZpY2UgZOG7q25nIikKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICMgUmVzZXQgdHJhY2tpbmcgdmFyaWFibGUga2hpIHVucmVnaXN0ZXIgcHJveHkKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbmjhuqMgcHJveHk6IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICMgxJDDs25nIHThuqV0IGPhuqMgYXBwIGtoaSB0aG/DoXQgSm9iU2VydmljZQogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGFwcF9uYW1lLCBoYW5kbGVyIGluIHNlbGYuam9iX2hhbmRsZXJzLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAge2FwcF9uYW1lfSBraGkgSm9iU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDs25nIGFwcDoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkpvYlNlcnZpY2UgxJHDoyBk4burbmciKQogICAgICAgICAgICAKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBKb2JTZXJ2aWNlIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBk4burbmcgSm9iU2VydmljZS4uLiIpCiAgICAgICAgCiAgICBkZWYgZm9yY2Vfc3RvcF9hbGwoc2VsZik6CiAgICAgICAgIiIiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCgogICAgZGVmIGhhbmRsZV9tcXR0X2FjY291bnRfdXBkYXRlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPhuq1wIG5o4bqtdCBhY2NvdW50IHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBBY2NvdW50IHPhur0gxJHGsOG7o2MgcmVsb2FkIHNhdSBt4buXaSBqb2IgdHJvbmcgY29udGludW91cyBwcm9jZXNzaW5nCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB0aMO0bmcgYsOhbyBj4bqtcCBuaOG6rXQgYWNjb3VudCB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9mb3JjZV9zdGFydF9zZXNzaW9uKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIG5nYXkgbOG6rXAgdOG7qWMgdOG7qyBNUVRUIHNlcnZlcgogICAgICAgIExvZ2ljIG3hu5tpIGtow7RuZyBjw7Mgc2Vzc2lvbiBjb29sZG93biBuw6puIGtow7RuZyBj4bqnbiB44butIGzDvSBnw6wgxJHhurdjIGJp4buHdAogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBi4bqvdCDEkeG6p3UgbMOgbSB2aeG7h2MgbmdheSBs4bqtcCB04bupYyB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAgICAgIyBUcm9uZyBsb2dpYyBt4bubaSwgSm9iU2VydmljZSBz4bq9IHThu7EgxJHhu5luZyBs4bqleSBqb2IgbGnDqm4gdOG7pWMgbsOqbiBraMO0bmcgY+G6p24geOG7rSBsw70gZ8OsIHRow6ptCiAgICAgICAgICAgIAogICAgZGVmIGhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoc2VsZiwgY29uZmlnX2NoYW5nZXM6IERpY3Rbc3RyLCBBbnldID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIE1RVFQgc2VydmVyCiAgICAgICAgTG9naWMgbeG7m2kga2jDtG5nIGPhuqduIHJlc3RhcnQgc2Vzc2lvbiwgY29uZmlnIHPhur0gxJHGsOG7o2Mgw6FwIGThu6VuZyBuZ2F5IGzhuq1wIHThu6ljCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnX2NoYW5nZXM6IERpY3Rpb25hcnkgY2jhu6lhIGPDoWMgdGhheSDEkeG7lWkgY29uZmlnCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB0aMO0bmcgYsOhbyBj4bqtcCBuaOG6rXQgY29uZmlnIHThu6sgc2VydmVyIHF1YSBNUVRUIikKICAgICAgICAjIExvZ2ljIG3hu5tpIGtow7RuZyBj4bqnbiB44butIGzDvSDEkeG6t2MgYmnhu4d0LCBjb25maWcgc+G6vSDEkcaw4bujYyDEkeG7jWMgbOG6oWkgdOG7qyBEQiBt4buXaSBs4bqnbiBs4bq3cAoKICAgIGRlZiBzaHV0ZG93bihzZWxmKToKICAgICAgICAiIiLEkMOzbmcgZOG7i2NoIHbhu6UsIGThu6tuZyB04bqldCBj4bqjIHdvcmtlciB0aHJlYWRzIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGThu6tuZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNodXRkb3duIFByb3h5U2VydmljZSAoc+G6vSB04buxIMSR4buZbmcgdW5yZWdpc3RlciBwcm94eSB2w6AgZOG7q25nIHVwZGF0ZSB0aHJlYWQpCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3NlcnZpY2UnKSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlOgogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnNodXRkb3duKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlIMSR4buDIHRyw6FuaCBs4buXaSB0aHJlYWQKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnZGInKSBhbmQgc2VsZi5kYjoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmNsb3NlKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHNodXRkb3duIEpvYlNlcnZpY2UiKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09IFBST1hZIENPTlZFTklFTkNFIE1FVEhPRFMgPT09PT09PT09PT09PT09PT09PT0KICAgIGRlZiByZXNldF9jdXJyZW50X3Byb3h5X2lwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgUmVzZXQgSVAgY2hvIHByb3h5IGhp4buHbiB04bqhaSAoY8OzIHRo4buDIGfhu41pIHRyb25nIHF1w6EgdHLDrG5oIGzDoG0gdmnhu4djKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgcmVzZXQgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X3N0YXR1cyhzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdHLhuqFuZyB0aMOhaSBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9zdGF0dXMoKQogICAgCiAgICBkZWYgZ2V0X3Byb3h5X2luZm8oc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjDtG5nIHRpbiBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiBwcm94eQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZ2V0X3Byb3h5X2luZm8oKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09IEVORCBQUk9YWSBDT05WRU5JRU5DRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09CiAgICAgICAgICAgIAogICAgIyBERVBSRUNBVEVEOiBLaMO0bmcgZMO5bmcgbuG7r2EsIHRoYXkgYuG6sW5nIF9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKCkKICAgICMgZGVmIF9oYXNfYWNjb3VudHNfcmVhZHlfZm9yX3dvcmsoc2VsZikgLT4gYm9vbDoKICAgICMgICAgICIiIgogICAgIyAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIHTDoGkga2hv4bqjbiBuw6BvIHPhurVuIHPDoG5nIGzDoG0gdmnhu4djIGtow7RuZwogICAgIyAgICAgCiAgICAjICAgICBSZXR1cm5zOgogICAgIyAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICMgICAgICIiIgogICAgIyAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAjICAgICAKICAgICMgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAjICAgICAgICAgaWYgc2VsZi5pc19hY2NvdW50X2Nhbl9ydW5fam9iKGFwcF9uYW1lKToKICAgICMgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICMgICAgICAgICAgICAgCiAgICAjICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdOG7qyB04bqldCBj4bqjIGFwcCB2w6Agc+G6r3AgeOG6v3AgdGhlbyBhcHAsIG5nw6B5IHThuqFvCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2Mgc+G6r3AgeOG6v3AKICAgICAgICAiIiIKICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6v20gc+G7kSBsxrDhu6NuZyB0w6BpIGtob+G6o24gdGhlbyB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgIHN0YXR1c19jb3VudHMgPSB7fQogICAgICAgICAgICBmb3IgYWNjIGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgc3RhdHVzID0gYWNjLmdldCgnc3RhdHVzJywgJ2FjdGl2ZScpCiAgICAgICAgICAgICAgICBzdGF0dXNfY291bnRzW3N0YXR1c10gPSBzdGF0dXNfY291bnRzLmdldChzdGF0dXMsIDApICsgMQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2cgdGjhu5FuZyBrw6ogdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzdGF0dXNfaW5mbyA9ICIsICIuam9pbihbZiJ7c3RhdHVzfToge2NvdW50fSIgZm9yIHN0YXR1cywgY291bnQgaW4gc3RhdHVzX2NvdW50cy5pdGVtcygpXSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FwcF9uYW1lfSAtIHtzdGF0dXNfaW5mb30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4buNYyBjw6FjIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgd29ya2FibGVfYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgc2VsZi5fY2FuX3J1bl9qb2IoYWNjKV0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHdvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuZXh0ZW5kKHdvcmthYmxlX2FjY291bnRzKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgCiAgICAgICAgIyBT4bqvcCB44bq/cCB0aGVvOgogICAgICAgICMgMS4gQXBwIG5hbWUgKMSR4buDIG5ow7NtIGPDuW5nIGFwcCBs4bqhaSB24bubaSBuaGF1KQogICAgICAgICMgMi4gTmfDoHkgdOG6oW8gdMOgaSBraG/huqNuIChjcmVhdGVkX2F0KSAtIGPFqSBuaOG6pXQgdHLGsOG7m2MKICAgICAgICAjIDMuIFPhu5Egam9iIMSRw6MgbMOgbSBow7RtIG5heSAow610IG5o4bqldCB0csaw4bubYykgLSB0aGF5IGNobyBqb2JzX2RvbmVfaW5fc2Vzc2lvbgogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICB4LmdldCgiY3JlYXRlZF9hdCIsIDApLAogICAgICAgICAgICB4LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIHJldHVybiBhbGxfd29ya2FibGVfYWNjb3VudHMKICAgICAgICAKICAgIGRlZiBfZ2V0X25leHRfd29ya2FibGVfYWNjb3VudChzZWxmKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdMOgaSBraG/huqNuIHRp4bq/cCB0aGVvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puOgogICAgICAgIDEuIFTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIChpc19sb2dpbiA9IFRydWUpCiAgICAgICAgMi4gVMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgaG/hurdjIE5vbmU6IEFjY291bnQgZGF0YSBu4bq/dSB0w6xtIHRo4bqleSwgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDE6IFTDrG0gdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdHLGsOG7m2MgKGTDuW5nIHRyYWNraW5nIGhp4buHbiB04bqhaSkKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAjIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBsw6BtIHZp4buHYyB24bubaSBhcHAgbsOgeSAoY2jhu4kga2hpIGPhuqduKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgIyBDaOG7iSB2ZXJpZnkga2hpIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gdHJvbmcgdHJhY2tpbmcgaG/hurdjIGtoaSB0cmFja2luZyBraMO0bmcgaOG7o3AgbOG7hwogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbOG6p24gxJHhuqd1Li4uIikKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRw6MgdGjhu60gdmVyaWZ5IMSR4buDIGtow7RuZyB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRyYWNraW5nIHLhu5NpLCBraMO0bmcgY+G6p24gdmVyaWZ5IG5nYXkKICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyB0cmFja2luZwogICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQpCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50IGFuZCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIGPDsyB0aOG7gyBsw6BtIHZp4buHYzoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBraMO0bmcgY8OybiBo4bujcCBs4buHLCB4w7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQsIHsiaXNfbG9naW4iOiBGYWxzZSwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2xvZ2dlZF9pbl9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIGRvIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMjogVMOsbSB0w6BpIGtob+G6o24gxJHEg25nIG5o4bqtcCB04burIGRhdGFiYXNlIChmYWxsYmFjaykKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAjIMavdSB0acOqbiB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCB04burIERCCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgibG9nZ2VkX2luIiwgRmFsc2UpIGFuZCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID0gYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXAgdHJvbmcgREI6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgMzogTuG6v3Uga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgbOG6pXkgdMOgaSBraG/huqNuIHRoZW8gdGjhu6kgdOG7sQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5leHRlbmQod29ya2FibGVfYWNjb3VudHMpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGFsbF93b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBT4bqvcCB44bq/cCB0aGVvIHRo4bupIHThu7EgxrB1IHRpw6puOiBhcHAsIG5nw6B5IHThuqFvLCBz4buRIGpvYiBow7RtIG5heQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5zb3J0KGtleT1sYW1iZGEgeDogKAogICAgICAgICAgICB4LmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICB4LmdldCgiY3JlYXRlZF9hdCIsIDApLAogICAgICAgICAgICB4LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIGFjY291bnQgPSBhbGxfd29ya2FibGVfYWNjb3VudHNbMF0KICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2M6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YWNjb3VudC5nZXQoJ2FwcCcpfSkiKQogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX3dvcmtfd2l0aF9zaW5nbGVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCB0w6BpIGtob+G6o24gLSB0aOG7sWMgaGnhu4duIG3hu5l0IGpvYiBkdXkgbmjhuqV0CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIAogICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBQcm94eSDEkcOjIMSRxrDhu6NjIHjhu60gbMO9IOG7nyBuZ2/DoGksIGtow7RuZyBj4bqnbiBraeG7g20gdHJhIGzhuqFpIOG7nyDEkcOieQogICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiBjaHV54buDbiB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgdHJhY2tpbmcgaW4tbWVtb3J5IHRoYXkgdsOsIGZpZWxkIGlzX2xvZ2luIMSR4buDIGNow61uaCB4w6FjIGjGoW4KICAgICAgICAgICAgY3VycmVudF9sb2dnZWRfaW5faWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmdldChhcHBfbmFtZSkKICAgICAgICAgICAgbmVlZHNfYWNjb3VudF9zd2l0Y2ggPSBjdXJyZW50X2xvZ2dlZF9pbl9pZCAhPSBjdXJyZW50X2FjY291bnRfaWQKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5lZWRzX2FjY291bnRfc3dpdGNoOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJD4bqnbiBjaHV54buDbiB0w6BpIGtob+G6o246IGhp4buHbiB04bqhaSBJRD17Y3VycmVudF9sb2dnZWRfaW5faWR9LCBj4bqnbiBjaHV54buDbiBzYW5nIElEPXtjdXJyZW50X2FjY291bnRfaWR9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChJRDoge2N1cnJlbnRfYWNjb3VudF9pZH0pIMSRw6MgxJHEg25nIG5o4bqtcCwga2jDtG5nIGPhuqduIGNodXnhu4NuIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgSVAgcHJveHkgY2jhu4kga2hpIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgIyBDaOG7iSByZXNldCBJUCBraGkgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ga2jDoWMgaG/hurdjIGzhuqduIMSR4bqndSB0acOqbgogICAgICAgICAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgIT0gY3VycmVudF9hY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgSVAgcHJveHkgY2hvIHTDoGkga2hv4bqjbiBt4bubaToge3VzZXJuYW1lfSAoSUQ6IHtjdXJyZW50X2FjY291bnRfaWR9KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBJUCDEkeG7gyBjw7MgSVAgbeG7m2kgY2hvIHTDoGkga2hv4bqjbiBt4bubaSAgCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmZvcmNlX3Jlc2V0X2N1cnJlbnRfaXAoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCBJUCB0aMOgbmggY8O0bmcgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAgICAgICAgICMgTMawdSBs4bqhaSBhY2NvdW50X2lkIMSRw6MgcmVzZXQgxJHhu4MgdHLDoW5oIHJlc2V0IGzhurdwIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gY3VycmVudF9hY2NvdW50X2lkCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJSZXNldCBJUCB0aOG6pXQgYuG6oWkgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCB0aeG6v3AgdOG7pWMgduG7m2kgSVAgaGnhu4duIHThuqFpIikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkcaw4bujYyByZXNldCBJUCB0csaw4bubYyDEkcOzLCBi4buPIHF1YSByZXNldCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4buJIGNodXnhu4NuIHTDoGkga2hv4bqjbiBraGkgY+G6p24gdGhp4bq/dAogICAgICAgICAgICBpZiBuZWVkc19hY2NvdW50X3N3aXRjaDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMgY2h1eeG7g24gdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHN3aXRjaF9yZXN1bHQsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0LmdldCgnc3VjY2VzcycsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uID0gc3dpdGNoX3Jlc3VsdC5nZXQoJ3JlYXNvbicsICd1bmtub3duJykKICAgICAgICAgICAgICAgICAgICAgICAgbWVzc2FnZSA9IHN3aXRjaF9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ0zhu5dpIGtow7RuZyB4w6FjIMSR4buLbmgnKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgcmVhc29uID09ICdhY2NvdW50X25vdF9mb3VuZCc6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIENo4buJIMSRw6FuaCBk4bqldSBsb2dvdXQga2hpIGNo4bqvYyBjaOG6r24ga2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdHJvbmcgZGFuaCBzw6FjaCwgxJHDoW5oIGThuqV1IGxvZ291dCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9tYXJrX2FjY291bnRfbG9nb3V0KGFjY291bnQsICJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHRyb25nIGRhbmggc8OhY2giKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEzhu5dpIGtow6FjIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24gLSBraMO0bmcgxJHDoW5oIGThuqV1IGxvZ291dCwgY2jhu4kgYsOhbyBs4buXaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge21lc3NhZ2V9LCBz4bq9IHRo4butIGzhuqFpIHNhdSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgVHLhuqMgduG7gSBGYWxzZSDEkeG7gyB0aOG7rSB0w6BpIGtob+G6o24ga2jDoWMKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgc2F1IGtoaSBjaHV54buDbiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoYXBwX25hbWUsIGN1cnJlbnRfYWNjb3VudF9pZCwgVHJ1ZSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBUxrDGoW5nIHRow61jaCB24bubaSBpbXBsZW1lbnRhdGlvbiBjxakgdHLhuqMgduG7gSBib29sZWFuCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0sIHPhur0gdGjhu60gbOG6oWkgc2F1IikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgdGjhu60gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIHNhdSBraGkgY2h1eeG7g24gdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKGFwcF9uYW1lLCBjdXJyZW50X2FjY291bnRfaWQsIFRydWUpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHEg25nIG5o4bqtcCwgYuG7jyBxdWEgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgam9iIHbhu5tpIGVycm9yIGhhbmRsaW5nCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTOG6pXkgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGpvYiA9IGhhbmRsZXIuZmV0Y2hfam9iKGFjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgICAgICAgICAgIyBUxINuZyBjb3VudGVyIGtow7RuZyBjw7Mgam9iCiAgICAgICAgICAgICAgICAgICAgbm9fam9iX2NvdW50ID0gc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzLmdldChjdXJyZW50X2FjY291bnRfaWQsIDApICsgMQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gbm9fam9iX2NvdW50CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gKGzhuqduIHtub19qb2JfY291bnR9LzUpIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyBjw7Mgam9iIDUgbOG6p24gbGnDqm4gdGnhur9wLCBjaG8gdMOgaSBraG/huqNuIG5naOG7iSAzMCBwaMO6dAogICAgICAgICAgICAgICAgICAgIGlmIG5vX2pvYl9jb3VudCA+PSA1OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGtow7RuZyBjw7Mgam9iIHtub19qb2JfY291bnR9IGzhuqduIGxpw6puIHRp4bq/cCwgY2hvIG5naOG7iSAzMCBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZD1jdXJyZW50X2FjY291bnRfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPTMwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiS2jDtG5nIGPDsyBqb2Ige25vX2pvYl9jb3VudH0gbOG6p24gbGnDqm4gdGnhur9wIgogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGVycm9yIGNvdW50IHNhdSBraGkgxJHhurd0IGluYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY+G6p24gdMOsbSB0w6BpIGtob+G6o24ga2jDoWMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBLaMO0bmcgY8OzIGpvYiBuaMawbmcgY2jGsGEgxJHhur9uIGdp4bubaSBo4bqhbiwgdGjhu60gbOG6oWkgc2F1CiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgZXJyb3IgY291bnQga2hpIGPDsyBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50X2lkIGluIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2N1cnJlbnRfYWNjb3VudF9pZF0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICMgVMSDbmcgZXJyb3IgY291bnQga2hpIGZldGNoIGpvYiBs4buXaQogICAgICAgICAgICAgICAgZXJyb3JfY291bnQgPSBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHMuZ2V0KGN1cnJlbnRfYWNjb3VudF9pZCwgMCkgKyAxCiAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbY3VycmVudF9hY2NvdW50X2lkXSA9IGVycm9yX2NvdW50CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBs4bqleSBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChs4bqnbiB7ZXJyb3JfY291bnR9LzUpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGzhu5dpIDUgbOG6p24gbGnDqm4gdGnhur9wLCBjaG8gdMOgaSBraG/huqNuIG5naOG7iSAzMCBwaMO6dAogICAgICAgICAgICAgICAgaWYgZXJyb3JfY291bnQgPj0gNToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGzhu5dpIGZldGNoIGpvYiB7ZXJyb3JfY291bnR9IGzhuqduIGxpw6puIHRp4bq/cCwgY2hvIG5naOG7iSAzMCBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZD1jdXJyZW50X2FjY291bnRfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9MzAsCiAgICAgICAgICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkzhu5dpIGZldGNoIGpvYiB7ZXJyb3JfY291bnR9IGzhuqduIGxpw6puIHRp4bq/cCIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBlcnJvciBjb3VudCBzYXUga2hpIMSR4bq3dCBpbmFjdGl2ZQogICAgICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBUcuG6oyB24buBIEZhbHNlIMSR4buDIGLDoW8gaGnhu4d1IGPhuqduIHTDrG0gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEzhu5dpIG5oxrBuZyBjaMawYSDEkeG6v24gZ2nhu5tpIGjhuqFuLCB0aOG7rSBs4bqhaSBzYXUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9kZXZpY2VfbWVzc2FnZV9mb3Jfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBqb2IgZm9sbG93IHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duCiAgICAgICAgICAgICMgUmVmcmVzaCBhY2NvdW50IGRhdGEgdOG7qyBEQiDEkeG7gyDEkeG6o20gYuG6o28gY8OzIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0CiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB24bubaSBJRCB7YWNjb3VudFsnaWQnXX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHNlbGYuX3ZhbGlkYXRlX2ZvbGxvd19qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IsIGhhbmRsZXIsIHVzZXJuYW1lKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIFNraXAgam9iIGtow7RuZyBwaOG6o2kgbOG7l2ksIGtow7RuZyDEkcOzbmcgYXBwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZhbGlkYXRlIGpvYiBi4bqxbmcgaGFuZGxlcgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fdmFsaWRhdGVfam9iX3dpdGhfaGFuZGxlcihhY2NvdW50LCBqb2IsIGhhbmRsZXIpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaSwga2jDtG5nIMSRw7NuZyBhcHAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtqb2IuZ2V0KCd0eXBlJywgJ3Vua25vd24nKX0iKQogICAgICAgICAgICBqb2JfcmVzdWx0ID0gaGFuZGxlci5leGVjdXRlX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjhu60gbMO9IGvhur90IHF14bqjIGpvYiAoYmFvIGfhu5NtIGLDoW8gY8OhbyB2w6AgY+G6rXAgbmjhuq10IHRo4buRbmcga8OqKQogICAgICAgICAgICBzZWxmLl9oYW5kbGVfam9iX3Jlc3VsdChhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQsIGhhbmRsZXIsIHVzZXJuYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTbWFydCBjYXJlIHNhdSBraGkgaOG6v3Qgam9iCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYuX3Nob3VsZF9wZXJmb3JtX2NhcmVfc21hcnQoYWNjb3VudCwgImFmdGVyX2pvYiIpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU21hcnQgY2FyZSBzYXUgam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgY2FyZV9zdWNjZXNzID0gc2VsZi5fcGVyZm9ybV9zbWFydF9jYXJlKGFjY291bnQsICJhZnRlcl9qb2IiKQogICAgICAgICAgICAgICAgICAgIGlmIGNhcmVfc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTbWFydCBjYXJlIHNhdSBqb2IgdGjDoG5oIGPDtG5nIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNtYXJ0IGNhcmUgc2F1IGpvYiB0aOG6pXQgYuG6oWkgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJC4buPIHF1YSBzbWFydCBjYXJlIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAoa2jDtG5nIMSR4bunIMSRaeG7gXUga2nhu4duKSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHNtYXJ0IGNhcmUgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtIw5RORyDEkcOzbmcgYXBwIHNhdSBt4buXaSBqb2IgLSBjaOG7iSDEkcOzbmcga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggam9iIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY8OzIGzhu5dpCiAgICAgICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoc2VsZiwgaGFuZGxlciwgYXBwX25hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyCiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiBj4bunYSB0w6BpIGtob+G6o24gdHJvbmcgYXBwIG7DoHkKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGNobyB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraGkgxJHDs25nIGFwcCIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWk6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChzZWxmLCBhcHBfbmFtZTogc3RyKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCDEkcOzbmcgYXBwIG7hur91IGtow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IGFwcF9uYW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyBhcHAgbsOgeSBraMO0bmcKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgxJHDs25nIGFwcCIpCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgZ2nhu68gYXBwIG3hu58iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIMSRw7NuZyBhcHAge2FwcF9uYW1lfToge2V9IikKICAgICAgICAKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIgPSAiUGjDoXQgaGnhu4duIGxvZ291dCIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0IHbDoCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYie3JlYXNvbn06IHtjdXJyZW50X3RpbWV9IgogICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyB0cm9uZyBtZW1vcnkKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50WyJpZCJdOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudFsnaWQnXX0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBsb2dvdXQiKQogICAgICAgIAogICAgZGVmIF91cGRhdGVfZGV2aWNlX21lc3NhZ2VfZm9yX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlIGNobyBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgIiIiCiAgICAgICAgbGluayA9IGpvYi5nZXQoJ2xpbmsnLCAnJykKICAgICAgICBpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJywgJycpCiAgICAgICAgCiAgICAgICAgbWVzc2FnZSA9IGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgbWVzc2FnZSkKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIGPhu6dhIGpvYiBzYXUga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgam9iX3N1Y2Nlc3MgPSBqb2JfcmVzdWx0WyJzdWNjZXNzIl0KICAgICAgICBqb2JfbWVzc2FnZSA9IGpvYl9yZXN1bHRbIm1lc3NhZ2UiXQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gZm9sbG93IGpvYiDEkeG6t2MgYmnhu4d0CiAgICAgICAgaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5faGFuZGxlX2ZvbGxvd19qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgROG7q25nIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5IG5oxrBuZyB0aeG6v3AgdOG7pWMgbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICAjIELDoW8gY8OhbyBr4bq/dCBxdeG6owogICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6oKICAgICAgICBzZWxmLl91cGRhdGVfam9iX3N0YXRzKGFjY291bnQsIGpvYl9zdWNjZXNzLCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLCBqb2JfcmVzdWx0KQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIFRow6BuaCBjw7RuZwogICAgICAgIAogICAgZGVmIF9oYW5kbGVfZm9sbG93X2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIMSR4bq3YyBiaeG7h3QgY2hvIGZvbGxvdyBqb2IKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRp4bq/cCB04bulYyB24bubaSB0w6BpIGtob+G6o24gbsOgeSwgRmFsc2UgbuG6v3UgY+G6p24gZOG7q25nCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZyAoc3RhdHVzIDQpIHbDoCBn4butaSB5w6p1IGPhuqd1IGNo4budIGR1eeG7h3QgKHN0YXR1cyA1KQogICAgICAgIGlmIGpvYl9zdGF0dXMgaW4gWzQsIDVdOgogICAgICAgICAgICBjbnQgPSBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgIGlmIGNudCA+PSA1OgogICAgICAgICAgICAgICAgc3RhdHVzX21zZyA9ICJmb2xsb3cgcGVuZGluZyIgaWYgam9iX3N0YXR1cyA9PSA0IGVsc2UgImfhu61pIHnDqnUgY+G6p3UgY2jhu50gZHV54buHdCIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCB7c3RhdHVzX21zZ30sIHThuqFtIGThu6tuZyB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249ZiJMacOqbiB0aeG6v3AgbOG7l2kge3N0YXR1c19tc2d9IikKICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEThu6tuZyB24bubaSB0w6BpIGtob+G6o24gbsOgeQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgIHNlbGYuX2NoZWNrX2FuZF9kaXNhYmxlX2ZvbGxvd19hZnRlcl9qb2IoYWNjb3VudCwgdXNlcm5hbWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYW5kX2Rpc2FibGVfZm9sbG93X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgdXNlcm5hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbiBzYXUga2hpIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKQogICAgICAgIG1heF9mb2xsb3dfZGF5ID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfZGF5IiwgMjApCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIMSR4bqhdCBnaeG7m2kgaOG6oW4gbmfDoHkgdHLGsOG7m2MKICAgICAgICBpZiBmb2xsb3dfdG9kYXkgPj0gbWF4X2ZvbGxvd19kYXk6CiAgICAgICAgICAgICMgVMOtbmggdGjhu51pIGdpYW4gxJHhur9uIHJlc2V0IG5nw6B5IHRp4bq/cCB0aGVvICh0w61uaCB0aGVvIHBow7p0KQogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUKICAgICAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgICAgIHRvbW9ycm93ID0gbm93LmRhdGUoKSArIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgIG5leHRfcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9tb3Jyb3csIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBz4buRIHBow7p0IHThu6sgYsOieSBnaeG7nSDEkeG6v24gdGjhu51pIMSRaeG7g20gcmVzZXQKICAgICAgICAgICAgdGltZV9kaWZmID0gbmV4dF9yZXNldF90aW1lIC0gbm93CiAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IGludCh0aW1lX2RpZmYudG90YWxfc2Vjb25kcygpIC8gNjApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gY8OzIHPhurVuIHRyb25nIGRiX3NlcnZpY2UKICAgICAgICAgICAgc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBuZ8OgeSIKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IG5nw6B5ICh7Zm9sbG93X3RvZGF5fS97bWF4X2ZvbGxvd19kYXl9KSwgZGlzYWJsZSDEkeG6v24ge25leHRfcmVzZXRfdGltZS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0iKQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgxJHhuqF0IGdp4bubaSBo4bqhbiBzZXNzaW9uCiAgICAgICAgZWxpZiBmb2xsb3dfaW5fc2Vzc2lvbiA+PSBtYXhfZm9sbG93X3Nlc3Npb246CiAgICAgICAgICAgICMgVMOtbmggdGjhu51pIGdpYW4gxJHhur9uIGtoaSBr4bq/dCB0aMO6YyBzZXNzaW9uIGhp4buHbiB04bqhaQogICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5kYi5nZXQoImpvYl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBzZXNzaW9uIC0gZGlzYWJsZSB7Y29vbGRvd25fbWludXRlc30gcGjDunQgKMSR4bq/biBraGkga+G6v3QgdGjDumMgc2Vzc2lvbikiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHThu6sgZGJfc2VydmljZSB24bubaSB0aOG7nWkgZ2lhbiBuZ2jhu4kgc2Vzc2lvbgogICAgICAgICAgICBzZWxmLmRiLmRpc2FibGVfYWNjb3VudF9mb2xsb3coCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRbImlkIl0sCiAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9Y29vbGRvd25fbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBwaGnDqm4iCiAgICAgICAgICAgICkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBwaGnDqm4gKHtmb2xsb3dfaW5fc2Vzc2lvbn0ve21heF9mb2xsb3dfc2Vzc2lvbn0pLCBkaXNhYmxlIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgIAogICAgZGVmIF92YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIGpvYiBi4bqxbmcgaGFuZGxlcgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGPhuqduIHNraXAgaG/hurdjIGNvbnRpbnVlCiAgICAgICAgIiIiCiAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBoYW5kbGVyLnZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYikKICAgICAgICBpZiBub3QgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJ2YWxpZCIsIFRydWUpOgogICAgICAgICAgICBpZiB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInNob3VsZF9za2lwIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBTa2lwIGpvYgogICAgICAgICAgICAgICAgc2tpcF9tZXNzYWdlID0gdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIkpvYiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNraXAgam9iOiB7c2tpcF9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLCAKICAgICAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc2tpcF9tZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNraXAgam9iIGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoc2tpcF9zbGVlcF90aW1lKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSm9iIGtow7RuZyBo4bujcCBs4buHOiB7dmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF92YWxpZGF0ZV9mb2xsb3dfam9iX2JlZm9yZV9leGVjdXRpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGhhbmRsZXIsIHVzZXJuYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgZm9sbG93IGpvYiB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIHRo4buxYyBoaeG7h24sIEZhbHNlIG7hur91IGPhuqduIHNraXAKICAgICAgICAiIiIKICAgICAgICAjIENo4buJIHZhbGlkYXRlIGNobyBqb2IgZm9sbG93CiAgICAgICAgaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpICE9ICJmb2xsb3ciOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2ZvbGxvd19zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfc2Vzc2lvbiIsIDUpCiAgICAgICAgZGlzYWJsZV9mb2xsb3cgPSBhY2NvdW50LmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSkKICAgICAgICBmb2xsb3dfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJmb2xsb3dfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgbm93ID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgRGVidWcgbG9nIMSR4buDIGtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaQogICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlZhbGlkYXRlIGZvbGxvdyBqb2IgY2hvIHt1c2VybmFtZX06IGRpc2FibGVfZm9sbG93PXtkaXNhYmxlX2ZvbGxvd30sIGZvbGxvd19kaXNhYmxlX3VudGlsPXtmb2xsb3dfZGlzYWJsZV91bnRpbH0sIG5vdz17bm93fSIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgYuG7iyBraMOzYSBmb2xsb3cga2jDtG5nCiAgICAgICAgaWYgZGlzYWJsZV9mb2xsb3c6CiAgICAgICAgICAgIGlmIGZvbGxvd19kaXNhYmxlX3VudGlsID4gMCBhbmQgZm9sbG93X2Rpc2FibGVfdW50aWwgPD0gbm93OgogICAgICAgICAgICAgICAgIyBI4bq/dCB0aOG7nWkgZ2lhbiBraMOzYSwgZW5hYmxlIGzhuqFpIGZvbGxvdwogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJI4bq/dCB0aOG7nWkgZ2lhbiBraMOzYSBmb2xsb3cgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCBlbmFibGUgbOG6oWkgZm9sbG93IikKICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5hYmxlX2FjY291bnRfZm9sbG93KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFbhuqtuIMSRYW5nIGLhu4sga2jDs2EgZm9sbG93CiAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoZm9sbG93X2Rpc2FibGVfdW50aWwgLSBub3cpIC8gNjApIGlmIGZvbGxvd19kaXNhYmxlX3VudGlsID4gbm93IGVsc2UgMAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyBi4buLIGtow7NhIGZvbGxvdyAoY8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0KSwgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHJlc3VsdF9za2lwID0gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiVMOgaSBraG/huqNuIMSRYW5nIGLhu4sga2jDs2EgZm9sbG93IgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIyByZXBvcnRfam9iIHPhur0gdOG7sSDEkeG7mW5nIHNraXAgam9iIGtoaSBzdGF0dXMgPSAyCiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCByZXN1bHRfc2tpcCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCg1LCAyNSkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puCiAgICAgICAgaWYgZm9sbG93X2luX3Nlc3Npb24gPj0gbWF4X2ZvbGxvd19zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puICh7Zm9sbG93X2luX3Nlc3Npb259L3ttYXhfZm9sbG93X3Nlc3Npb259KSwgaOG7p3kgam9iIikKICAgICAgICAgICAgcmVzdWx0X3NraXAgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwKICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbiIKICAgICAgICAgICAgfQogICAgICAgICAgICAjIHJlcG9ydF9qb2Igc+G6vSB04buxIMSR4buZbmcgc2tpcCBqb2Iga2hpIHN0YXR1cyA9IDIKICAgICAgICAgICAgaGFuZGxlci5yZXBvcnRfam9iKGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVl').decode('utf-8'))
