import base64
exec(base64.b64decode('aW1wb3J0IGRhdGV0aW1lCmltcG9ydCB0aW1lCmltcG9ydCByYW5kb20KaW1wb3J0IG9zCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsCmZyb20gam9icy5qb2JfYmFzZSBpbXBvcnQgQmFzZUpvYgoKY2xhc3MgSW5zdGFncmFtSm9iKEJhc2VKb2IpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSkKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gImNvbS5pbnN0YWdyYW0uYW5kcm9pZCIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gImluc3RhZ3JhbSIKICAgICAgICAKICAgIGRlZiBkdW1wX3NjcmVlbl93aXRoX3JldHJ5KHNlbGYsIG1heF9yZXRyaWVzPTMsIHdhaXRfYmV0d2Vlbl9yZXRyaWVzPTAuNSk6CiAgICAgICAgIiIiCiAgICAgICAgRHVtcCBtw6BuIGjDrG5oIFhNTCB24bubaSBjxqEgY2jhur8gdGjhu60gbOG6oWkgbuG6v3UgZ+G6t3AgbOG7l2kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBtYXhfcmV0cmllczogU+G7kSBs4bqnbiB0aOG7rSB04buRaSDEkWEKICAgICAgICAgICAgd2FpdF9iZXR3ZWVuX3JldHJpZXM6IFRo4budaSBnaWFuIGNo4budIGdp4buvYSBjw6FjIGzhuqduIHRo4butIChnacOieSkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBYTUwgY+G7p2EgbcOgbiBow6xuaCBob+G6t2MgTm9uZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfcmV0cmllcyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgxJDhu6NpIFVJIOG7lW4gxJHhu4tuaAogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfYmV0d2Vlbl9yZXRyaWVzKQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICByZXR1cm4gc2NyZWVuX3htbAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGR1bXAgWE1MIChs4bqnbiB7YXR0ZW1wdCsxfS97bWF4X3JldHJpZXN9KToge3N0cihlKX0iKQogICAgICAgICAgICAgICAgIyBUxINuZyB0aOG7nWkgZ2lhbiBjaOG7nSBjaG8gbOG6p24gdGjhu60gdGnhur9wIHRoZW8KICAgICAgICAgICAgICAgIHdhaXRfYmV0d2Vlbl9yZXRyaWVzICs9IDAuNQogICAgICAgICAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgZHVtcCBYTUwgc2F1IHttYXhfcmV0cmllc30gbOG6p24gdGjhu60iKQogICAgICAgIHJldHVybiBOb25lCiAgICAgICAgCiAgICBkZWYgaXNfaG9tZV9zY3JlZW4oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcg4bufIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgSW5zdGFncmFtIGhheSBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRYW5nIOG7nyB0cmFuZyBjaOG7pywgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgcGFja2FnZSBoaeG7h24gdOG6oWkgdHLGsOG7m2MgdGnDqm4KICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IFhNTCBtw6BuIGjDrG5oIGhp4buHbiB04bqhaSB24bubaSBjxqEgY2jhur8gdGjhu60gbOG6oWkKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgMTogQ8OzIG7DunQgIlRyYW5nIGNo4bunIiDEkcaw4bujYyBjaOG7jW4gKHNlbGVjdGVkPXRydWUpIHRyb25nIHRoYW5oIHRhYiBraMO0bmcKICAgICAgICAgICAgaG9tZV90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCwgCiAgICAgICAgICAgICAgICBjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIgogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIGhvbWVfdGFiOgogICAgICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuaXNfZWxlbWVudF9zZWxlY3RlZChob21lX3RhYik6CiAgICAgICAgICAgICAgICAgICAgbG9nb19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLCAKICAgICAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC90aXRsZV9sb2dvX2NoZXZyb25fY29udGFpbmVyIgogICAgICAgICAgICAgICAgICAgICkKCiAgICAgICAgICAgICAgICAgICAgaWYgbG9nb19idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxvZ29fYnV0dG9uLmdldCgidmlzaWJsZS10by11c2VyIikgPT0gInRydWUiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDrG0gdGjhuqV5IHRhYiAiVHJhbmcgY2jhu6ciIG5oxrBuZyBjaMawYSDEkcaw4bujYyBjaOG7jW4sIGNsaWNrIHbDoG8gxJHDswogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX3RhYikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMS41KSAgIyBUxINuZyB0aOG7nWkgZ2lhbiBjaOG7nSBsw6puIDEuNXMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDrG0gdGjhuqV5IHRhYiAiVHJhbmcgY2jhu6ciIG5oxrBuZyBjaMawYSDEkcaw4bujYyBjaOG7jW4sIGNsaWNrIHbDoG8gxJHDswogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX3RhYikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMS41KSAgIyBUxINuZyB0aOG7nWkgZ2lhbiBjaOG7nSBsw6puIDEuNXMKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAjIEtow7RuZyB0w6xtIHRo4bqleSBjw6FjIHnhur91IHThu5EgY+G7p2EgdHJhbmcgY2jhu6cKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2nhu4NtIHRyYSBtw6BuIGjDrG5oIHRyYW5nIGNo4bunIEluc3RhZ3JhbSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgIGRlZiBlbnN1cmVfaG9tZV9zY3JlZW4oc2VsZiwgbWF4X3JldHJpZXM6IGludCA9IDMpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyBtw6BuIGjDrG5oIHRyYW5nIGNo4bunIEluc3RhZ3JhbSwgbuG6v3Uga2jDtG5nIHRow6wga2jhu59pIMSR4buZbmcgbOG6oWkgYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgbWF4X3JldHJpZXM6IFPhu5EgbOG6p24gdGjhu60gdOG7kWkgxJFhCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKCgogICAgICAgIHJldHJ5X2NvdW50ID0gMAogICAgICAgIAogICAgICAgIHdoaWxlIHJldHJ5X2NvdW50IDwgbWF4X3JldHJpZXM6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIOG7nyB0cmFuZyBjaOG7pyBraMO0bmcKICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGtow7RuZyDhu58gdHJhbmcgY2jhu6csIMSRw7NuZyB2w6AgbeG7nyBs4bqhaSBhcHAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHBo4bqjaSB0cmFuZyBjaOG7pyBJbnN0YWdyYW0sIGto4bufaSDEkeG7mW5nIGzhuqFpIGFwcC4uLiIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChzZWxmLmFwcF9wYWNrYWdlKQoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20ga2hpIGPhuqduIHJlc3RhcnQgc2Vzc2lvbgogICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDIpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgZOG7q25nIHRyb25nIHF1w6EgdHLDrG5oIGVuc3VyZV9ob21lX3NjcmVlbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20ga2hpIGPhuqduIHJlc3RhcnQgc2Vzc2lvbiAgCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMTApOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgZOG7q25nIHRyb25nIHF1w6EgdHLDrG5oIGVuc3VyZV9ob21lX3NjcmVlbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgc2VsZi52YWxpZGF0ZV9hcHBfbm90X2Jhbm5lZCgpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHJldHJ5X2NvdW50ICs9IDEKICAgICAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgbeG7nyB0cmFuZyBjaOG7pyBJbnN0YWdyYW0gc2F1IHttYXhfcmV0cmllc30gbOG6p24gdGjhu60iKQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgdmFsaWRhdGVfYXBwX25vdF9iYW5uZWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gYuG7iyBiYW5uZWQKICAgICAgICAiIiIKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyB0ZXh0ICJUcmFuZyBuw6B5IGhp4buHbiBraMO0bmcgaGnhu4NuIHRo4buLIgogICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgIHBhZ2Vfbm90X2F2YWlsYWJsZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgIHRleHQ9IlRyYW5nIG7DoHkgaGnhu4duIGtow7RuZyBoaeG7g24gdGjhu4siCiAgICAgICAgKQoKICAgICAgICBpZiBwYWdlX25vdF9hdmFpbGFibGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIlBow6F0IGhp4buHbiB0cmFuZyBraMO0bmcgaGnhu4NuIHRo4buLLCDEkWFuZyByZXNldCBwcm94eSB2w6AgbMOgbSBt4bubaSIpCiAgICAgICAgICAgICMgR+G7jWkgcmVzZXRfY3VycmVudF9wcm94eSB0aMO0bmcgcXVhIHByb3h5X3NlcnZpY2UKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlOgogICAgICAgICAgICAgICAgcmVzZXRfc3VjY2VzcyA9IHNlbGYucHJveHlfc2VydmljZS5mb3JjZV9yZXNldF9jdXJyZW50X2lwKCkKICAgICAgICAgICAgICAgIGlmIHJlc2V0X3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20KICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDIpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBk4burbmcgdHJvbmcgdmFsaWRhdGVfYXBwX25vdF9iYW5uZWQiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIHbDoG8gbsO6dCAiTMOgbSBt4bubaSIKICAgICAgICAgICAgICAgICAgICByZWZyZXNoX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ9IkzDoG0gbeG7m2kiCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIHJlZnJlc2hfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIocmVmcmVzaF9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzYWZlX3NsZWVwIHJldHVybiB2YWx1ZSDEkeG7gyBjw7MgdGjhu4MgdGhvw6F0IHPhu5ttCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBk4burbmcgdHJvbmcgdmFsaWRhdGVfYXBwX25vdF9iYW5uZWQiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgYuG6pW0gbsO6dCBsw6BtIG3hu5tpIHNhdSBraGkgcmVzZXQgcHJveHkiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0ICdMw6BtIG3hu5tpJyIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJSZXNldCBwcm94eSB0aOG6pXQgYuG6oWkiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiUHJveHkgc2VydmljZSBjaMawYSDEkcaw4bujYyB0aGnhur90IGzhuq1wIikKCiAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyBj4bqjbmggYsOhbwogICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgIGFsZXJ0X2NvbnRhaW5lciA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvaWdkc19hbGVydF9kaWFsb2dfdGV4dF9jb250YWluZXIiCiAgICAgICAgKQogICAgICAgIAogICAgICAgICNLaeG7g20gdHJhIGPDsyB0aMO0bmcgYsOhbyB0aOG7qSBs4bqhaSBzYXUuCiAgICAgICAgaWYgYWxlcnRfY29udGFpbmVyOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgdGnDqnUgxJHhu4EgZGlhbG9nCiAgICAgICAgICAgIGhlYWRsaW5lID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbCgKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2lnZHNfYWxlcnRfZGlhbG9nX2hlYWRsaW5lIgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBoZWFkbGluZSBhbmQgc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChoZWFkbGluZSkgPT0gIlRo4butIGzhuqFpIHNhdSI6CiAgICAgICAgICAgICAgICAjIEzhuqV5IG7hu5lpIGR1bmcgY+G6o25oIGLDoW8KICAgICAgICAgICAgICAgIHN1YnRleHQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9pZ2RzX2FsZXJ0X2RpYWxvZ19zdWJ0ZXh0IgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBzdWJ0ZXh0OgogICAgICAgICAgICAgICAgICAgIHdhcm5pbmdfbWVzc2FnZSA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQoc3VidGV4dCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggY+G6o25oIGLDoW8gaGnhu4duIHThuqFpIHThu6sgZGIKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3dhcm5pbmdzID0gc2VsZi5kYi5nZXQoImxvZ3Mtd2FybmluZy1tZXNzYWdlIiwgW10pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUaMOqbSBj4bqjbmggYsOhbyBt4bubaQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfd2FybmluZ3MuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWUiOiBkYXRldGltZS5kYXRldGltZS5ub3coKS5pc29mb3JtYXQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3MiOiB3YXJuaW5nX21lc3NhZ2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ2jhu4kgZ2nhu68gbOG6oWkgdOG7kWkgxJFhIDIwIGxvZyBn4bqnbiBuaOG6pXQKICAgICAgICAgICAgICAgICAgICBpZiBsZW4oY3VycmVudF93YXJuaW5ncykgPiAyMDoKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF93YXJuaW5ncyA9IGN1cnJlbnRfd2FybmluZ3NbLTIwOl0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgdsOgbyBkYgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsb2dzLXdhcm5pbmctbWVzc2FnZSIsIGN1cnJlbnRfd2FybmluZ3MpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIsSQw6MgbMawdSBj4bqjbmggYsOhbzoge3dhcm5pbmdfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQuG6pW0gbsO6dCBPSyBsacOqbiB04bulYyBjaG8gxJHhur9uIGtoaSBraMO0bmcgY8OybiBkaWFsb2cKICAgICAgICAgICAgICAgICAgICBzZWxmLl9kaXNtaXNzX2FsbF9kaWFsb2dzKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAKICAgICAgICAjS2nhu4NtIHRyYSB4ZW0gY8OzIHRow7RuZyBiw6FvIHBo4bqjaSDEkcSDbmcgbmjhuq1wIGtow7RuZwogICAgICAgICMgS2nhu4NtIHRyYSBjb250YWluZXIgYmxva3MKICAgICAgICBibG9rc19jb250YWluZXIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2Jsb2tzX2NvbnRhaW5lciIKICAgICAgICApCiAgICAgICAgCiAgICAgICAgaWYgYmxva3NfY29udGFpbmVyOgogICAgICAgICAgICAjIFTDrG0gdOG6pXQgY+G6oyBjw6FjIHZpZXcgdHJvbmcgY29udGFpbmVyCiAgICAgICAgICAgIHZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQudmlldy5WaWV3IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHZpZXcgxJHhuqd1IHRpw6puIGPDsyB0ZXh0IGtow6FjIG51bGwKICAgICAgICAgICAgd2FybmluZ190ZXh0ID0gTm9uZQogICAgICAgICAgICBmb3IgdmlldyBpbiB2aWV3czoKICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHZpZXcpCiAgICAgICAgICAgICAgICBpZiB0ZXh0IGFuZCB0ZXh0LnN0cmlwKCkgYW5kIHRleHQgIT0gIm51bGwiIGFuZCB0ZXh0ICE9ICIgIiBhbmQgbGVuKHRleHQuc3RyaXAoKSkgPiAxMDoKICAgICAgICAgICAgICAgICAgICB3YXJuaW5nX3RleHQgPSB0ZXh0CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHdhcm5pbmdfdGV4dDogCiAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gbG9nb3V0IHbDoCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIELGsOG7m2MgMTogQuG6pW0gdsOgbyBtZW51CiAgICAgICAgICAgICAgICAgICAgbWVudV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iTWVudSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbWVudV9idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihtZW51X2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIELGsOG7m2MgMjogxJDhu41jIGzhuqFpIFhNTCB2w6AgdMOsbSB0ZXh0ICLEkMSDbmcgeHXhuqV0IGto4buPaSIKICAgICAgICAgICAgICAgICAgICAgICAgbWVudV94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBtZW51X3htbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKG1lbnVfeG1sLCBjbGFzc19uYW1lPSJhbmRyb2lkLnZpZXcuVmlldyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ291dF92aWV3ID0gTm9uZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB2aWV3IGluIHZpZXdzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZpZXdfdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQodmlldykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB2aWV3X3RleHQgYW5kIHZpZXdfdGV4dC5zdGFydHN3aXRoKCLEkMSDbmcgeHXhuqV0IGto4buPaSIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dvdXRfdmlldyA9IHZpZXcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqvdCBi4buPICLEkMSDbmcgeHXhuqV0IGto4buPaSIgdsOgIHRyaW0gxJHhu4MgbOG6pXkgdXNlcm5hbWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSB2aWV3X3RleHQucmVwbGFjZSgixJDEg25nIHh14bqldCBraOG7j2kiLCAiIikuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsb2dvdXRfdmlldyBhbmQgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBCxrDhu5tjIDM6IEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGFjY291bnQgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgiJWQvJW0vJXkgJUg6JU0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbiA9IGYiUGjDoXQgaGnhu4duIHnDqnUgY+G6p3UgeMOhYyBtaW5oIGzDumM6IHtjdXJyZW50X3RpbWV9IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gdGhlbyB1bmlxdWVfdXNlcm5hbWUgdsOgIGPhuq1wIG5o4bqtdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPSJpbnN0YWdyYW0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikgPT0gdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGluYWN0aXZlX3JlYXNvbiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtpbmFjdGl2ZV9yZWFzb259IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IELhuqVtIHbDoG8gIsSQxINuZyB4deG6pXQga2jhu49pIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihsb2dvdXRfdmlldykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIELGsOG7m2MgNTogWMOhYyBuaOG6rW4gxJHEg25nIHh14bqldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm1feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBjb25maXJtX3htbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlybV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlybV94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0PSLEkMSDbmcgeHXhuqV0IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNvbmZpcm1fYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGNvbmZpcm1fYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg1KSAgIyBDaOG7nSA1IGdpw6J5IGhvw6BuIHThuqV0IGxvZ291dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIMSRxINuZyB4deG6pXQga2jhu49pIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG1lbnUgxJHEg25nIHh14bqldCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4buNYyBYTUwgbWVudSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IE1lbnUiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGxvZ291dDoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgICAgICMgRmFsbGJhY2s6IMSRw7NuZyBhcHAgbuG6v3Uga2jDtG5nIGxvZ291dCDEkcaw4bujYwogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChzZWxmLmFwcF9wYWNrYWdlKQoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAKICAgIGRlZiBnZXRfYWNjb3VudHNfZnJvbV9kZXZpY2Uoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gSW5zdGFncmFtIHThu6sgdGhp4bq/dCBi4buLIiIiCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gxJFhbmcg4bufIHRyYW5nIGNo4bunIEluc3RhZ3JhbQogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmjhuqVuIHbDoG8gdGFiICJUcmFuZyBjw6EgbmjDom4iCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICBwcm9maWxlX3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPSJUcmFuZyBjw6EgbmjDom4iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHByb2ZpbGVfdGFiOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSB0YWIgVHJhbmcgY8OhIG5ow6JuIikKICAgICAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmjhuqVwIHbDoG8gdGFiIFRyYW5nIGPDoSBuaMOibgogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIocHJvZmlsZV90YWIpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgdOG7qyB0cmFuZyBjw6EgbmjDom4KICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdXNlcm5hbWUgdOG7qyB0acOqdSDEkeG7gSBs4bubbiB0cm9uZyBhY3Rpb24gYmFyCiAgICAgICAgICAgIHVzZXJuYW1lX3RpdGxlID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbCgKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsIAogICAgICAgICAgICAgICAgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9hY3Rpb25fYmFyX2xhcmdlX3RpdGxlX2F1dG9fc2l6ZSIKICAgICAgICAgICAgKQogICAgICAgICAgICBpZiBub3QgdXNlcm5hbWVfdGl0bGU6CiAgICAgICAgICAgICAgICB1c2VybmFtZV90aXRsZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgICAgICByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2FjdGlvbl9iYXJfdGl0bGUiCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lX3RpdGxlOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgwLjUpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICB1c2VybmFtZV90aXRsZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwgCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9hY3Rpb25fYmFyX2xhcmdlX3RpdGxlX2F1dG9fc2l6ZSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHVzZXJuYW1lX3RpdGxlOgogICAgICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQodXNlcm5hbWVfdGl0bGUpCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdXNlcm5hbWUgaGnhu4duIHThuqFpIHThu6sgdGnDqnUgxJHhu4E6IHtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqVwIHbDoG8gdGnDqnUgxJHhu4EgdXNlcm5hbWUgxJHhu4MgbeG7nyBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHVzZXJuYW1lX3RpdGxlKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gLSDEkeG7jWMgbOG6p24gMQogICAgICAgICAgICAgICAgYWNjb3VudHNfeG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIHThuqV0IGPhuqMgY8OhYyBwaOG6p24gdOG7rSBWaWV3R3JvdXAgY8OzIGNvbnRlbnQtZGVzYyAobMOgIHVzZXJuYW1lKQogICAgICAgICAgICAgICAgYWNjb3VudF9pdGVtcyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICBhY2NvdW50c194bWwsCiAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC52aWV3LlZpZXdHcm91cCIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBY4butIGzDvSB0w6BpIGtob+G6o24gbOG6p24gMQogICAgICAgICAgICAgICAgc2VsZi5fcHJvY2Vzc19hY2NvdW50X2l0ZW1zKGFjY291bnRfaXRlbXMsIGFjY291bnRzX3htbCwgYWNjb3VudHMpCgogICAgICAgICAgICAgICAgIyBO4bq/dSBjw7Mgbmhp4buBdSBoxqFuIDYgdMOgaSBraG/huqNuLCB2deG7kXQgbMOqbiB2w6AgxJHhu41jIHRp4bq/cAogICAgICAgICAgICAgICAgaWYgbGVuKGFjY291bnRzKSA+IDY6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHtsZW4oYWNjb3VudHMpfSB0w6BpIGtob+G6o24sIHZ14buRdCBsw6puIMSR4buDIHTDrG0gdGjDqm0iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIGzhuqduIDIgc2F1IGtoaSB2deG7kXQKICAgICAgICAgICAgICAgICAgICBhY2NvdW50c194bWxfMiA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pdGVtc18yID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50c194bWxfMiwKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC52aWV3LlZpZXdHcm91cCIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBY4butIGzDvSB0w6BpIGtob+G6o24gbOG6p24gMgogICAgICAgICAgICAgICAgICAgIGFjY291bnRzX2JlZm9yZV8ybmQgPSBsZW4oYWNjb3VudHMpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcHJvY2Vzc19hY2NvdW50X2l0ZW1zKGFjY291bnRfaXRlbXNfMiwgYWNjb3VudHNfeG1sXzIsIGFjY291bnRzKQogICAgICAgICAgICAgICAgICAgIGFjY291bnRzX2FkZGVkID0gbGVuKGFjY291bnRzKSAtIGFjY291bnRzX2JlZm9yZV8ybmQKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTOG6p24gxJHhu41jIHRo4bupIDIgdMOsbSB0aMOqbSB7YWNjb3VudHNfYWRkZWR9IHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJDaOG7iSBjw7Mge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiwga2jDtG5nIGPhuqduIHZ14buRdCB0aMOqbSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqVuIGJhY2sgxJHhu4MgxJHDs25nIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRdWF5IGzhuqFpIHRyYW5nIGNo4bunIGLhurFuZyBwaMawxqFuZyB0aOG7qWMgYmFja190b19ob21lCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gSW5zdGFncmFtIikKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAKICAgIGRlZiBfcHJvY2Vzc19hY2NvdW50X2l0ZW1zKHNlbGYsIGFjY291bnRfaXRlbXM6IExpc3QsIGFjY291bnRzX3htbDogc3RyLCBhY2NvdW50czogTGlzdFtEaWN0W3N0ciwgQW55XV0pIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gZGFuaCBzw6FjaCBhY2NvdW50IGl0ZW1zIHbDoCB0aMOqbSB2w6BvIGFjY291bnRzIGxpc3QKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50X2l0ZW1zOiBEYW5oIHPDoWNoIFZpZXdHcm91cCBlbGVtZW50cwogICAgICAgICAgICBhY2NvdW50c194bWw6IFhNTCBj4bunYSBtw6BuIGjDrG5oIGNo4bupYSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY2NvdW50czogTGlzdCDEkeG7gyB0aMOqbSB0w6BpIGtob+G6o24gdsOgbwogICAgICAgICIiIgogICAgICAgICMgVOG6oW8gc2V0IMSR4buDIHRyw6FuaCBkdXBsaWNhdGUgdXNlcm5hbWUKICAgICAgICBleGlzdGluZ191c2VybmFtZXMgPSB7YWNjLmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkgZm9yIGFjYyBpbiBhY2NvdW50c30KICAgICAgICAKICAgICAgICAjIEzhu41jIHbDoCB44butIGzDvSBjw6FjIG3hu6VjIHTDoGkga2hv4bqjbgogICAgICAgIGZvciBpdGVtIGluIGFjY291bnRfaXRlbXM6CiAgICAgICAgICAgICMgTOG6pXkgY29udGVudC1kZXNjIGPhu6dhIGl0ZW0KICAgICAgICAgICAgY29udGVudF9kZXNjID0gaXRlbS5nZXQoImNvbnRlbnQtZGVzYyIsICIiKQogICAgICAgICAgICBpZiBub3QgY29udGVudF9kZXNjIG9yIGNvbnRlbnRfZGVzYyA9PSAibnVsbCI6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDonkgY8OzIHBo4bqjaSBsw6AgbsO6dCAixJBpIMSR4bq/biBUcnVuZyB0w6JtIHTDoGkga2hv4bqjbiIga2jDtG5nCiAgICAgICAgICAgIGlmICJUcnVuZyB0w6JtIHTDoGkga2hv4bqjbiIgaW4gY29udGVudF9kZXNjOgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIELhu48gcXVhIG7DunQgIlRow6ptIHTDoGkga2hv4bqjbiIgCiAgICAgICAgICAgIGlmICJUaMOqbSB0w6BpIGtob+G6o24iIGluIGNvbnRlbnRfZGVzYzoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjhu60gbMO9IHRyxrDhu51uZyBo4bujcCBjw7MgdGjDtG5nIGLDoW8gdHJvbmcgY29udGVudC1kZXNjICh2ZDogInVzZXJuYW1lLCAxMCB0aMO0bmcgYsOhbyIpCiAgICAgICAgICAgIHVzZXJuYW1lID0gY29udGVudF9kZXNjCiAgICAgICAgICAgIGlmICIsIiBpbiBjb250ZW50X2Rlc2M6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGNvbnRlbnRfZGVzYy5zcGxpdCgiLCIpWzBdLnN0cmlwKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUGjGsMahbmcgcGjDoXAgMjogVMOsbSB0cuG7sWMgdGnhur9wIHRyb25nIGPDoWMgdmlldyBjb24KICAgICAgICAgICAgY2hpbGRfdmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBhY2NvdW50c194bWwsCiAgICAgICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkLnZpZXcuVmlldyIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBib3VuZHMgY+G7p2EgaXRlbSBoaeG7h24gdOG6oWkgxJHhu4MgdMOsbSB2aWV3IGNvbiB0aHXhu5ljIHbhu4EgbsOzCiAgICAgICAgICAgIGl0ZW1fYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGl0ZW0pCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgdmlldyBpbiBjaGlsZF92aWV3czoKICAgICAgICAgICAgICAgIHZpZXdfYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKHZpZXcpCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHZpZXcgY8OzIG7hurFtIHRyb25nIGl0ZW0ga2jDtG5nCiAgICAgICAgICAgICAgICBpZiAodmlld19ib3VuZHNbMF0gPj0gaXRlbV9ib3VuZHNbMF0gYW5kIAogICAgICAgICAgICAgICAgICAgIHZpZXdfYm91bmRzWzFdID49IGl0ZW1fYm91bmRzWzFdIGFuZCAKICAgICAgICAgICAgICAgICAgICB2aWV3X2JvdW5kc1syXSA8PSBpdGVtX2JvdW5kc1syXSBhbmQgCiAgICAgICAgICAgICAgICAgICAgdmlld19ib3VuZHNbM10gPD0gaXRlbV9ib3VuZHNbM10pOgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHZpZXdfdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQodmlldykKICAgICAgICAgICAgICAgICAgICBpZiB2aWV3X3RleHQgYW5kICJ0aMO0bmcgYsOhbyIgbm90IGluIHZpZXdfdGV4dC5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgICAgICAjIFTDrG0gdGjhuqV5IHZpZXcgY29uIGNo4bupYSB0w6puIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHZpZXdfdGV4dAogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGR1cGxpY2F0ZSB1c2VybmFtZQogICAgICAgICAgICBpZiB1c2VybmFtZS5sb3dlcigpIGluIGV4aXN0aW5nX3VzZXJuYW1lczoKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gbsOgeSBjw7MgxJFhbmcgxJHGsOG7o2MgY2jhu41uIGtow7RuZwogICAgICAgICAgICBpc19zZWxlY3RlZCA9IGl0ZW0uZ2V0KCJzZWxlY3RlZCIpID09ICJ0cnVlIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBhY2NvdW50ID0gewogICAgICAgICAgICAgICAgIm5pY2tuYW1lIjogIiIsCiAgICAgICAgICAgICAgICAidW5pcXVlX3VzZXJuYW1lIjogdXNlcm5hbWUsCiAgICAgICAgICAgICAgICAidW5pcXVlX2lkIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBpc19zZWxlY3RlZCwKICAgICAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiAiIiwKICAgICAgICAgICAgICAgICJqb2JfZW5hYmxlIjogVHJ1ZSwKICAgICAgICAgICAgICAgICJsZXZlbCI6IDMsCiAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgICAgICBleGlzdGluZ191c2VybmFtZXMuYWRkKHVzZXJuYW1lLmxvd2VyKCkpCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBJbnN0YWdyYW06IHt1c2VybmFtZX0gKHNlbGVjdGVkOiB7aXNfc2VsZWN0ZWR9KSIpCiAgICAKICAgIGRlZiBfZGlzbWlzc19hbGxfZGlhbG9ncyhzZWxmLCBtYXhfYXR0ZW1wdHM6IGludCA9IDUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgQuG6pW0gbsO6dCBPSyBsacOqbiB04bulYyBjaG8gxJHhur9uIGtoaSBraMO0bmcgY8OybiBkaWFsb2cgbsOgbwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG1heF9hdHRlbXB0czogU+G7kSBs4bqnbiB0aOG7rSB04buRaSDEkWEKICAgICAgICAiIiIKICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfYXR0ZW1wdHMpOgogICAgICAgICAgICAjIEzhuqV5IGzhuqFpIFhNTCDEkeG7gyB0w6xtIG7DunQgT0sKICAgICAgICAgICAgY3VycmVudF94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICBpZiBub3QgY3VycmVudF94bWw6CiAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIG9rX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgICAgICBjdXJyZW50X3htbCwKICAgICAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvaWdkc19hbGVydF9kaWFsb2dfcHJpbWFyeV9idXR0b24iCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG9rX2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihva19idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGLhuqVtIE9LIGzhuqduIHthdHRlbXB0ICsgMX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBLaMO0bmcgY8OybiBuw7p0IE9LLCB0aG/DoXQgdsOybmcgbOG6t3AKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgxJHDs25nIGjhur90IGRpYWxvZyIpCiAgICAgICAgICAgICAgICBicmVhawogICAgCiAgICBkZWYgYmFja190b19ob21lKHNlbGYsIG1heF9iYWNrX2NvdW50OiBpbnQgPSA1LCBtYXhfcmV0cmllczogaW50ID0gMSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBRdWF5IGzhuqFpIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgSW5zdGFncmFtCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgbWF4X2JhY2tfY291bnQ6IFPhu5EgbOG6p24gbmjhuqVuIEJhY2sgdOG7kWkgxJFhIHRyxrDhu5tjIGtoaSB0aOG7rSBraOG7n2kgxJHhu5luZyBs4bqhaSBhcHAKICAgICAgICAgICAgbWF4X3JldHJpZXM6IFPhu5EgbOG6p24gdGjhu60ga2jhu59pIMSR4buZbmcgbOG6oWkgYXBwIHThu5FpIMSRYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIOG7nyB0cmFuZyBjaOG7pyBjaMawYQogICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJBhbmcgdMOsbSBjw6FjaCBxdWF5IHbhu4EgdHJhbmcgY2jhu6cgSW5zdGFncmFtLi4uIikKICAgICAgICAKICAgICAgICAjIFRo4butIGzhuqFpIHRvw6BuIGLhu5kgcXXDoSB0csOsbmggdOG7kWkgxJFhIG1heF9yZXRyaWVzIGzhuqduCiAgICAgICAgZm9yIHJldHJ5IGluIHJhbmdlKG1heF9yZXRyaWVzKToKICAgICAgICAgICAgIyBUaOG7rSBi4bqlbSBuw7p0IGJhY2sgdOG7kWkgxJFhIG1heF9iYWNrX2NvdW50IGzhuqduCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKG1heF9iYWNrX2NvdW50KToKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgc2FmZV9zbGVlcCByZXR1cm4gdmFsdWUgxJHhu4MgY8OzIHRo4buDIHRob8OhdCBz4bubbQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBk4burbmcgdHJvbmcgcXXDoSB0csOsbmggYmFja190b19ob21lIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIHbhu4EgdHJhbmcgY2jhu6cgY2jGsGEKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBxdWF5IHbhu4EgdHJhbmcgY2jhu6cgc2F1IHtpKzF9IGzhuqduIGLhuqVtIGJhY2sgKGzhuqduIHRo4butIHtyZXRyeSsxfSkiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IHbhuqtuIGtow7RuZyB24buBIMSRxrDhu6NjIHRyYW5nIGNo4bunLCBraWxsIGFwcCB2w6AgbeG7nyBs4bqhaQogICAgICAgICAgICBpZiByZXRyeSA8IG1heF9yZXRyaWVzIC0gMTogICMgQ2jhu4kgbG9nIGPhuqNuaCBiw6FvIG7hur91IGPDsm4gbOG6p24gdGjhu60gdGnhur9wIHRoZW8KICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgduG7gSB0cmFuZyBjaOG7pyBzYXUge21heF9iYWNrX2NvdW50fSBs4bqnbiBi4bqlbSBiYWNrLCB0aOG7rSBraOG7n2kgxJHhu5luZyBs4bqhaSBhcHAgKGzhuqduIHRo4butIHtyZXRyeSsxfS97bWF4X3JldHJpZXN9KS4uLiIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyB24buBIHRyYW5nIGNo4bunIHNhdSB7bWF4X2JhY2tfY291bnR9IGzhuqduIGLhuqVtIGJhY2sgKGzhuqduIHRo4butIGN14buRaSB7cmV0cnkrMX0ve21heF9yZXRyaWVzfSkuLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20KICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgyKToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB5w6p1IGPhuqd1IGThu6tuZyB0cm9uZyBxdcOhIHRyw6xuaCBiYWNrX3RvX2hvbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBzYWZlX3NsZWVwIHJldHVybiB2YWx1ZSDEkeG7gyBjw7MgdGjhu4MgdGhvw6F0IHPhu5ttICAKICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg1KToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB5w6p1IGPhuqd1IGThu6tuZyB0cm9uZyBxdcOhIHRyw6xuaCBiYWNrX3RvX2hvbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBpZiBub3Qgc2VsZi52YWxpZGF0ZV9hcHBfbm90X2Jhbm5lZCgpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgeGVtIGPDsyDhu58gdHJhbmcgY2jhu6cga2jDtG5nCiAgICAgICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHF1YXkgduG7gSB0cmFuZyBjaOG7pyBzYXUga2hpIGto4bufaSDEkeG7mW5nIGzhuqFpIGFwcCAobOG6p24gdGjhu60ge3JldHJ5KzF9KSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIHbhu4EgdHJhbmcgY2jhu6cgbmdheSBj4bqjIHNhdSB7bWF4X3JldHJpZXN9IGzhuqduIHRo4butIGto4bufaSDEkeG7mW5nIGzhuqFpIGFwcCIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIAoKICAgIAogICAgZGVmIG1hcF9nb2xpa2VfYWNjb3VudHMoc2VsZiwgZ29saWtlX2FjY291bnRzOiBMaXN0W0RpY3Rbc3RyLCBBbnldXSwgZGV2aWNlX2FjY291bnRzOiBMaXN0W0RpY3Rbc3RyLCBBbnldXSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgw4FuaCB44bqhIHTDoGkga2hv4bqjbiB04burIEdvTGlrZSB2w6BvIHTDoGkga2hv4bqjbiB0csOqbiB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBnb2xpa2VfYWNjb3VudHM6IERhbmggc8OhY2ggdMOgaSBraG/huqNuIHThu6sgR29MaWtlIEFQSQogICAgICAgICAgICBkZXZpY2VfYWNjb3VudHM6IERhbmggc8OhY2ggdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyDDoW5oIHjhuqEKICAgICAgICAiIiIKICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3UgdOG7qyBHb0xpa2UKICAgICAgICAgICAgZ29saWtlX2RhdGEgPSB7fQogICAgICAgICAgICBmb3IgYWNjIGluIGdvbGlrZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICMgVHLDrWNoIHh14bqldCB0aMO0bmcgdGluIHThu6sgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICAgICAgZ29saWtlX2FjY291bnQgPSB7CiAgICAgICAgICAgICAgICAgICAgImdvbGlrZV9pZCI6IGFjYy5nZXQoImlkIiksCiAgICAgICAgICAgICAgICAgICAgIm5pY2tuYW1lIjogYWNjLmdldCgiaW5zdGFncmFtX2Z1bGxfbmFtZSIpIG9yIGFjYy5nZXQoImluc3RhZ3JhbV91c2VybmFtZSIpLAogICAgICAgICAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBhY2MuZ2V0KCJpbnN0YWdyYW1faWQiKSwKICAgICAgICAgICAgICAgICAgICAidW5pcXVlX3VzZXJuYW1lIjogYWNjLmdldCgiaW5zdGFncmFtX3VzZXJuYW1lIiksCiAgICAgICAgICAgICAgICAgICAgImF2YXRhcl90aHVtYiI6IGFjYy5nZXQoInByb2ZpbGVfcGljX3VybCIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgdW5pcXVlX3VzZXJuYW1lIGzDoG0ga2jDs2EgxJHhu4MgZOG7hSDDoW5oIHjhuqEKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gZ29saWtlX2FjY291bnRbInVuaXF1ZV91c2VybmFtZSJdCiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBnb2xpa2VfZGF0YVt1c2VybmFtZS5sb3dlcigpXSA9IGdvbGlrZV9hY2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIMOBbmggeOG6oSB24bubaSB0w6BpIGtob+G6o24gdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIGZvciBkZXZpY2VfYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGRldmljZV9hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWUgaW4gZ29saWtlX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgIyDEkMOjIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoIEdvTGlrZQogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdOG7qyBHb0xpa2UgdsOgbyB0w6BpIGtob+G6o24gdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICAgICAgZ29saWtlX2luZm8gPSBnb2xpa2VfZGF0YVt1c2VybmFtZV0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJnb2xpa2VfaWQiOiBnb2xpa2VfaW5mb1siZ29saWtlX2lkIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19nb2xpa2VfbGlua2VkIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgImF2YXRhcl90aHVtYiI6IGdvbGlrZV9pbmZvWyJhdmF0YXJfdGh1bWIiXSBvciBkZXZpY2VfYWNjb3VudC5nZXQoImF2YXRhcl90aHVtYiIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgInVuaXF1ZV9pZCI6IGdvbGlrZV9pbmZvWyJ1bmlxdWVfaWQiXSBvciBkZXZpY2VfYWNjb3VudC5nZXQoInVuaXF1ZV9pZCIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgIm5pY2tuYW1lIjogZ29saWtlX2luZm9bIm5pY2tuYW1lIl0gb3IgZGV2aWNlX2FjY291bnQuZ2V0KCJuaWNrbmFtZSIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gSUQgdMOgaSBraG/huqNuIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGRldmljZV9hY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gREIKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdsOgbyBkZXZpY2VfYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIG1hcHBlZF9hY2NvdW50cy5hcHBlbmQoZGV2aWNlX2FjY291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEgdMOgaSBraG/huqNuIEluc3RhZ3JhbToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gbWFwcGVkX2FjY291bnRzCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMOhbmggeOG6oSB0w6BpIGtob+G6o24gSW5zdGFncmFtIikKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICBkZWYgZ2V0X3JlcG9ydF9wYXlsb2FkKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBU4bqhbyBwYXlsb2FkIGNobyB2aeG7h2MgYsOhbyBjw6FvIGhvw6BuIHRow6BuaCBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBQYXlsb2FkIGNobyBBUEkgYsOhbyBjw6FvCiAgICAgICAgIiIiCiAgICAgICAgZ29saWtlX2lkID0gYWNjb3VudC5nZXQoImdvbGlrZV9pZCIpCiAgICAgICAgam9iX2lkID0gam9iLmdldCgiaWQiKQogICAgICAgIAogICAgICAgIGlmIG5vdCBnb2xpa2VfaWQgb3Igbm90IGpvYl9pZDoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIlRoaeG6v3UgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gaG/hurdjIGpvYiDEkeG7gyB04bqhbyBwYXlsb2FkIGLDoW8gY8OhbyIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJpbnN0YWdyYW1fdXNlcnNfYWR2ZXJ0aXNpbmdfaWQiOiBqb2JfaWQsCiAgICAgICAgICAgICJpbnN0YWdyYW1fYWNjb3VudF9pZCI6IGdvbGlrZV9pZCwKICAgICAgICAgICAgImFzeW5jIjogVHJ1ZSwKICAgICAgICAgICAgImRhdGEiOiBOb25lCiAgICAgICAgfSAgICAKICAgICAgICAgIAogICAgCiAgICAKICAgIGRlZiBleGVjdXRlX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyB0aOG7sWMgaGnhu4duIGpvYiwgYmFvIGfhu5NtOgogICAgICAgICAgICAgICAgLSBzdGF0dXMgKGludCk6IE3DoyB0cuG6oW5nIHRow6FpIGpvYgogICAgICAgICAgICAgICAgICAgIDA6IENoxrBhIHRo4buxYyBoaeG7h24KICAgICAgICAgICAgICAgICAgICAxOiBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAyOiBUaOG6pXQgYuG6oWksIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcKICAgICAgICAgICAgICAgICAgICAzOiBUaOG6pXQgYuG6oWksIMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgICAgICAgICA0OiBUaOG6pXQgYuG6oWksIHnDqnUgY+G6p3UgxJFhbmcgY2jhu50KICAgICAgICAgICAgICAgIC0gbWVzc2FnZSAoc3RyKTogVGjDtG5nIGLDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIC0gc3VjY2VzcyAoYm9vbCk6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgIGpvYl9saW5rID0gam9iLmdldCgibGluayIsICIiKQogICAgICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJBhbmcgdGjhu7FjIGhp4buHbiBqb2Ige2pvYl9pZH0gbG/huqFpIHtqb2JfdHlwZX0gduG7m2kgbGluayB7am9iX2xpbmt9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBsb+G6oWkgam9iIMSRxrDhu6NjIGjhu5cgdHLhu6MKICAgICAgICAgICAgaWYgam9iX3R5cGUgbm90IGluIFsiZm9sbG93IiwgImxpa2UiXToKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBmIkxv4bqhaSBqb2Ige2pvYl90eXBlfSBraMO0bmcgxJHGsOG7o2MgaOG7lyB0cuG7oyIKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcobWVzc2FnZSkKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBtZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IgdGhlbyBsb+G6oWkKICAgICAgICAgICAgam9iX3N0YXR1cyA9IDAgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgbMOgbQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgam9iX3R5cGUgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICBqb2Jfc3RhdHVzID0gc2VsZi5fcGVyZm9ybV9mb2xsb3dfam9iKGpvYl9saW5rKQogICAgICAgICAgICBlbGlmIGpvYl90eXBlID09ICJsaWtlIjoKICAgICAgICAgICAgICAgIGpvYl9zdGF0dXMgPSBzZWxmLl9wZXJmb3JtX2xpa2Vfam9iKGpvYl9saW5rKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBr4bq/dCBxdeG6oyB0cuG6oyB24buBIGThu7FhIHRyw6puIGpvYl9zdGF0dXMKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0X2Zyb21fc3RhdHVzKGpvYl9zdGF0dXMsIGpvYl90eXBlKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBtZXNzYWdlID0gZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2I6IHtzdHIoZSl9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgbWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDIsIG1lc3NhZ2UsIEZhbHNlKQogICAgCiAgICBkZWYgX2NyZWF0ZV9qb2JfcmVzdWx0X2Zyb21fc3RhdHVzKHNlbGYsIGpvYl9zdGF0dXM6IGludCwgam9iX3R5cGU6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVOG6oW8ga+G6v3QgcXXhuqMgam9iIHThu6sgc3RhdHVzIGNvZGUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2Jfc3RhdHVzOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IgdOG7qyBfcGVyZm9ybV94eHhfam9iCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iIChmb2xsb3csIGxpa2UpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyBqb2IKICAgICAgICAiIiIKICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDE6ICAjIFRow6BuaCBjw7RuZwogICAgICAgICAgICBtZXNzYWdlID0gZiLEkMOjIGhvw6BuIHRow6BuaCBqb2Ige2pvYl90eXBlfSB0aMOgbmggY8O0bmciCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8obWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDEsIG1lc3NhZ2UsIFRydWUpCiAgICAgICAgZWxpZiBqb2Jfc3RhdHVzID09IDI6ICAjIEtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcKICAgICAgICAgICAgbWVzc2FnZSA9IGYiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZyDEkeG7gyB0aOG7sWMgaGnhu4duIGpvYiB7am9iX3R5cGV9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgyLCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gMzogICMgQuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgbWVzc2FnZSA9IGYixJDDoyBi4buLIHVuZm9sbG93L3VubGlrZSB0cm9uZyBqb2Ige2pvYl90eXBlfSIKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhtZXNzYWdlKQogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB1bmZvbGxvdyDEkeG7gyBKb2JTZXJ2aWNlIHjhu60gbMO9CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgzLCBtZXNzYWdlLCBGYWxzZSwgdW5mb2xsb3c9VHJ1ZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gNDogICMgWcOqdSBj4bqndSDEkWFuZyBjaOG7nQogICAgICAgICAgICBtZXNzYWdlID0gZiJZw6p1IGPhuqd1IMSRYW5nIGNo4budIHRyb25nIGpvYiB7am9iX3R5cGV9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCg0LCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gNTogICMgR+G7rWkgecOqdSBj4bqndSBjaOG7nSBkdXnhu4d0CiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIkfhu61pIHnDqnUgY+G6p3UgY2jhu50gZHV54buHdCB7am9iX3R5cGV9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCg1LCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gNjogICMgxJDhuqF0IGdp4bubaSBo4bqhbiBob+G6t2MgYuG7iyBraMOzYQogICAgICAgICAgICBtZXNzYWdlID0gZiJKb2Ige2pvYl90eXBlfSBi4buLIGjhu6d5IGRvIMSR4bqhdCBnaeG7m2kgaOG6oW4gaG/hurdjIHTDoGkga2hv4bqjbiBi4buLIGtow7NhIgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCg2LCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICBlbHNlOiAgIyBUcuG6oW5nIHRow6FpIGtow7RuZyB4w6FjIMSR4buLbmgKICAgICAgICAgICAgbWVzc2FnZSA9IGYiVHLhuqFuZyB0aMOhaSBraMO0bmcgeMOhYyDEkeG7i25oIGtoaSB0aOG7sWMgaGnhu4duIGpvYiB7am9iX3R5cGV9IChzdGF0dXM6IHtqb2Jfc3RhdHVzfSkiCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgwLCBtZXNzYWdlLCBGYWxzZSkKICAgIAogICAgZGVmIF9wZXJmb3JtX2ZvbGxvd19qb2Ioc2VsZiwgcHJvZmlsZV9saW5rOiBzdHIpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGpvYiBmb2xsb3cgdHLDqm4gSW5zdGFncmFtCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcHJvZmlsZV9saW5rOiBMaW5rIMSR4bq/biB0cmFuZyBjw6EgbmjDom4gY+G6p24gZm9sbG93CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogVHLhuqFuZyB0aMOhaSBqb2IgKDA6IGNoxrBhIGzDoG0sIDE6IGhvw6BuIHRow6BuaCwgMjogbOG7l2ksIDM6IGLhu4sgdW5mb2xsb3cpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLDrWNoIHh14bqldCB1c2VybmFtZSB04burIFVSTAogICAgICAgICAgICBpbXBvcnQgcmUKICAgICAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgICAgICB1c2VybmFtZV9tYXRjaCA9IHJlLnNlYXJjaChyJ2luc3RhZ3JhbVwuY29tLyhbXi9dKyknLCBwcm9maWxlX2xpbmspCiAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZV9tYXRjaDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIHRyw61jaCB4deG6pXQgdXNlcm5hbWUgdOG7qyBsaW5rOiB7cHJvZmlsZV9saW5rfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHVzZXJuYW1lID0gdXNlcm5hbWVfbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmFuZG9tIGNo4buNbiAxIHRyb25nIDIgY8OhY2g6IHTDrG0ga2nhur9tIGhv4bq3YyBt4bufIHRy4buxYyB0aeG6v3AgbGluawogICAgICAgICAgICBpZiByYW5kb20uY2hvaWNlKFtUcnVlLCBGYWxzZV0pOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk3hu58gdHJhbmcgY8OhIG5ow6JuIGLhurFuZyBjw6FjaCB0w6xtIGtp4bq/bToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAjIEPDoWNoIDE6IFTDrG0ga2nhur9tIHVzZXJuYW1lIChjw6FjaCBjxakpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyDEkMOzbmcgY8OhYyBkaWFsb2cgbuG6v3UgY8OzCiAgICAgICAgICAgICAgICAgICAgZGlhbG9nID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iRGlhbG9nIikKICAgICAgICAgICAgICAgICAgICBpZiBkaWFsb2c6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVGFwIHbDoG8ga2h1IHbhu7FjIHRy4buRbmcgxJHhu4MgxJHDs25nIGRpYWxvZwogICAgICAgICAgICAgICAgICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gc2VsZi5oZWxwZXIuZ2V0X3NjcmVlbl9zaXplKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKGludCh3aWR0aCowLjIpLCBpbnQoaGVpZ2h0KjAuMikpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxLjUpICAjIFTEg25nIHRo4budaSBnaWFuIGNo4budIGzDqm4gMS41cwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTeG7nyB0cmFuZyB0w6xtIGtp4bq/bSAKICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBkdW1wIG3DoG4gaMOsbmgsIHRo4butIG3hu58gYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fdXJsKHByb2ZpbGVfbGluayxzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNCkgICMgVMSDbmcgdGjhu51pIGdpYW4gY2jhu50gbMOqbiA0cwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWFyY2hfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL3NlYXJjaF90YWIiKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VhcmNoX3RhYjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSB0YWIgVMOsbSBraeG6v20sIHRo4butIG3hu58gYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fdXJsKHByb2ZpbGVfbGluayxzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNCkgICMgVMSDbmcgdGjhu51pIGdpYW4gY2jhu50gbMOqbiA0cwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX3RhYikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkgICMgVMSDbmcgdGjhu51pIGdpYW4gY2jhu50gbMOqbiAycwogICAgICAgICAgICAgICAgICAgIHNlYXJjaF90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQocmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9zZWFyY2hfdGFiIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VhcmNoX3RhYiBvciBub3Qgc2VsZi5oZWxwZXIuaXNfZWxlbWVudF9zZWxlY3RlZChzZWFyY2hfdGFiKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlYXJjaF90YWIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpIAoKICAgICAgICAgICAgICAgICAgICAjIE5o4bqlbiB2w6BvIHRoYW5oIHTDrG0ga2nhur9tCiAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgZHVtcCBtw6BuIGjDrG5oIGtoaSB0w6xtIMO0IG5o4bqtcCwgdGjhu60gbeG7nyBi4bqxbmcgbGluayB0cuG7sWMgdGnhur9wIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocHJvZmlsZV9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg0KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWFyY2hfaW5wdXQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvYWN0aW9uX2Jhcl9zZWFyY2hfZWRpdF90ZXh0IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VhcmNoX2lucHV0OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX3RhYikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpIAogICAgICAgICAgICAgICAgICAgICAgICBzZWFyY2hfaW5wdXQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQocmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9hY3Rpb25fYmFyX3NlYXJjaF9lZGl0X3RleHQiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWFyY2hfaW5wdXQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgw7Qgbmjhuq1wIHTDrG0ga2nhur9tLCB0aOG7rSBt4bufIGLhurFuZyBsaW5rIHRy4buxYyB0aeG6v3AiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX3VybChwcm9maWxlX2xpbmssc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDQpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBYw7NhIG7hu5lpIGR1bmcgdMOsbSBraeG6v20gaGnhu4duIHThuqFpIG7hur91IGPDswogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzZWFyY2hfaW5wdXQpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEuNSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5o4bqtcCB1c2VybmFtZSBj4bqnbiB0w6xtIHbhu5tpIGvDvSB04buxIEAgcGjDrWEgdHLGsOG7m2MKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5pbnB1dF90ZXh0KGYie3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDUpICAjIFTEg25nIHRo4budaSBnaWFuIGNo4budIGzDqm4gNXMgxJHhu4Mga+G6v3QgcXXhuqMgdMOsbSBraeG6v20gaGnhu4duIMSR4bqneSDEkeG7pwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVMOsbSBr4bq/dCBxdeG6oyB0aGVvIHJlc291cmNlLWlkIGPhu6UgdGjhu4MKICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpICAjIFRob8OhdCB0w6xtIGtp4bq/bQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBkdW1wIG3DoG4gaMOsbmgga+G6v3QgcXXhuqMgdMOsbSBraeG6v20sIHRo4butIG3hu58gYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fdXJsKHByb2ZpbGVfbGluayxzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNCkKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgdXNlcl9yZXN1bHQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvcm93X3NlYXJjaF91c2VyX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgICAgICBpZiB1c2VyX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHVzZXJfcmVzdWx0KQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSB0aGVvIHJlc291cmNlLWlkLCB0aOG7rSB0w6xtIHRoZW8ga+G6v3QgcXXhuqMgdGjDtG5nIHRoxrDhu51uZwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKHNjcmVlbl94bWwsIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkxpbmVhckxheW91dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdF9mb3VuZCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRfdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQocmVzdWx0KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlcm5hbWUubG93ZXIoKSBpbiByZXN1bHRfdGV4dC5sb3dlcigpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihyZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0X2ZvdW5kID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCByZXN1bHRfZm91bmQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB0cm9uZyBr4bq/dCBxdeG6oyB0w6xtIGtp4bq/bSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocHJvZmlsZV9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHTDrG0ga2nhur9tIHTDoGkga2hv4bqjbjoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgY8OzIGzhu5dpLCBz4butIGThu6VuZyBwaMawxqFuZyB0aOG7qWMgbeG7nyBsaW5rCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocHJvZmlsZV9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDQpICAjIFTEg25nIHRo4budaSBnaWFuIGNo4budIGzDqm4gNHMKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgQ8OhY2ggMjogTeG7nyB0cuG7sWMgdGnhur9wIFVSTCB0aMO0bmcgcXVhIGhlbHBlci5vcGVuX3VybCgpCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTeG7nyB0cmFuZyBjw6EgbmjDom4gYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cDoge3Byb2ZpbGVfbGlua30iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocHJvZmlsZV9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNCkgICMgVMSDbmcgdGjhu51pIGdpYW4gY2jhu50gbMOqbiA0cwogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7nSB0aMOqbSBjaG8gdHJhbmcgaOG7kyBzxqEgdOG6o2kgeG9uZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgRm9sbG93IHRoZW8gcmVzb3VyY2UtaWQgY2jDrW5oIHjDoWMKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBkdW1wIG3DoG4gaMOsbmgga2hpIHTDrG0gbsO6dCBmb2xsb3ciKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBmb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL3Byb2ZpbGVfaGVhZGVyX2ZvbGxvd19idXR0b24iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkgdGhlbyByZXNvdXJjZS1pZCwgdGjhu60gdMOsbSB0aGVvIHRleHQKICAgICAgICAgICAgaWYgbm90IGZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCB0aGVvIGTDtWkgdGhlbyByZXNvdXJjZS1pZCwgdGjhu60gdMOsbSB0aGVvIHRleHQiKQogICAgICAgICAgICAgICAgIyBUw6xtIG7DunQgdGhlbyB0ZXh0CiAgICAgICAgICAgICAgICBmb2xsb3dfdGV4dHMgPSBbIlRoZW8gZMO1aSIsICJGb2xsb3ciLCAixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyIsICLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIHRleHQgaW4gZm9sbG93X3RleHRzOgogICAgICAgICAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHRleHQ9dGV4dCkKICAgICAgICAgICAgICAgICAgICBpZiBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSBs4bqhaSBs4bqnbiBu4buvYSBu4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBmb2xsb3cKICAgICAgICAgICAgaWYgbm90IGZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCB0aGVvIGTDtWkg4bufIGzhuqduIMSR4bqndSwgdGjhu60gdnXhu5F0IG3DoG4gaMOsbmggdsOgIHTDrG0gbOG6oWkiKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEuNSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGR1bXAgbcOgbiBow6xuaCBraGkgdMOsbSBs4bqhaSBuw7p0IGZvbGxvdyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvcHJvZmlsZV9oZWFkZXJfZm9sbG93X2J1dHRvbiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICMgVMOsbSBuw7p0IHRoZW8gdGV4dAogICAgICAgICAgICAgICAgICAgIGZvbGxvd190ZXh0cyA9IFsiVGhlbyBkw7VpIiwgIkZvbGxvdyIsICLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIiwgIsSQw6MgecOqdSBj4bqndSIsICJSZXF1ZXN0ZWQiXQogICAgICAgICAgICAgICAgICAgIGZvciB0ZXh0IGluIGZvbGxvd190ZXh0czoKICAgICAgICAgICAgICAgICAgICAgICAgZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgdGV4dD10ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IHRoZW8gZMO1aSBzYXUgbmhp4buBdSBs4bqnbiB0aOG7rSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0ZXh0IGPhu6dhIG7DunQKICAgICAgICAgICAgYnV0dG9uX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KGZvbGxvd19idXR0b24pCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUZXh0IGPhu6dhIG7DunQgZm9sbG93OiB7YnV0dG9uX3RleHR9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgbMOgICLEkGFuZyB0aGVvIGTDtWkiIGhv4bq3YyAiRm9sbG93aW5nIiB0aMOsIMSRw6MgZm9sbG93IHLhu5NpCiAgICAgICAgICAgIGlmIGJ1dHRvbl90ZXh0IGluIFsixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyJdOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgdGhlbyBkw7VpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IHThu6sgdHLGsOG7m2MiKQogICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgbMOgICLEkMOjIHnDqnUgY+G6p3UiIGhv4bq3YyAiUmVxdWVzdGVkIiB0aMOsIMSRw6MgecOqdSBj4bqndSBmb2xsb3cgcuG7k2kKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIl06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB5w6p1IGPhuqd1IHRoZW8gZMO1aSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB04burIHRyxrDhu5tjIikKICAgICAgICAgICAgICAgIHJldHVybiA1CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGzDoCAiVGhlbyBkw7VpIiBob+G6t2MgIkZvbGxvdyIgdGjDrCBjbGljayB2w6BvIG7DunQKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyJUaGVvIGTDtWkiLCAiRm9sbG93Il06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUaOG7sWMgaGnhu4duIGNsaWNrIHbDoG8gbsO6dCB0aGVvIGTDtWkiKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGZvbGxvd19idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykgICMgVMSDbmcgdGjhu51pIGdpYW4gY2jhu50gbMOqbiAycwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBkaWFsb2cgaGnhu4duIGzDqm4ga2jDtG5nCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgICAgICMgS2jDtG5nIHRo4buDIGtp4buDbSB0cmEgZGlhbG9nLCBuaMawbmcgY8OzIHRo4buDIMSRw6MgdGhlbyBkw7VpIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB0cuG6oW5nIHRow6FpIG7DunQKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZGlhbG9nX2NvbnRhaW5lciA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9kaWFsb2dfY29udGFpbmVyIikKICAgICAgICAgICAgICAgIGlmIGRpYWxvZ19jb250YWluZXI6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgdGjDtG5nIGLDoW8gIlRo4butIGzhuqFpIHNhdSIga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgcmV0cnlfdGV4dCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgdGV4dD0iVGjhu60gbOG6oWkgc2F1IikKICAgICAgICAgICAgICAgICAgICBpZiByZXRyeV90ZXh0OgogICAgICAgICAgICAgICAgICAgICAgICAjIELhuqVtIG7DunQgT0sgbGnDqm4gdOG7pWMgY2hvIMSR4bq/biBraGkga2jDtG5nIGPDsm4gZGlhbG9nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Rpc21pc3NfYWxsX2RpYWxvZ3MoKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJKb2Iga2jDtG5nIGhvw6BuIHRow6BuaCwgYuG7iyBnaeG7m2kgaOG6oW4gdGhlbyBkw7VpICh0aOG7rSBs4bqhaSBzYXUpIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDMKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgdGjDtG5nIGLDoW8gIlnDqnUgY+G6p3UgY+G7p2EgYuG6oW4gxJFhbmcgY2jhu50iIGtow7RuZwogICAgICAgICAgICAgICAgICAgIHdhaXRpbmdfdGV4dCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgdGV4dD0iWcOqdSBj4bqndSBj4bunYSBi4bqhbiDEkWFuZyBjaOG7nSIpCiAgICAgICAgICAgICAgICAgICAgaWYgd2FpdGluZ190ZXh0OgogICAgICAgICAgICAgICAgICAgICAgICAjIELhuqVtIG7DunQgT0sgbGnDqm4gdOG7pWMgY2hvIMSR4bq/biBraGkga2jDtG5nIGPDsm4gZGlhbG9nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Rpc21pc3NfYWxsX2RpYWxvZ3MoKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJIb8OgbiB0aMOgbmgsIHnDqnUgY+G6p3UgdGhlbyBkw7VpIMSRYW5nIGNo4budIGR1eeG7h3QiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgbMOgIGRpYWxvZyBraMOhYywgYuG6pW0gT0sgbGnDqm4gdOG7pWMKICAgICAgICAgICAgICAgICAgICBzZWxmLl9kaXNtaXNzX2FsbF9kaWFsb2dzKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24geMOhYyBuaOG6rW4gdGhlbyBkw7VpIGtow7RuZyAodMOgaSBraG/huqNuIHJpw6puZyB0xrApCiAgICAgICAgICAgICAgICBjb25maXJtX2NvbnRhaW5lciA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9sYXlvdXRfY29udGFpbmVyX2JvdHRvbV9zaGVldCIpCiAgICAgICAgICAgICAgICBpZiBjb25maXJtX2NvbnRhaW5lcjoKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gbsO6dCAiVGhlbyBkw7VpIiB0cm9uZyBjb250YWluZXIKICAgICAgICAgICAgICAgICAgICBjb25maXJtX2ZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHRleHQ9IlRoZW8gZMO1aSIsY2xhc3NfbmFtZT0iYW5kcm9pZC52aWV3LlZpZXciKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBjb25maXJtX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbmZpcm1fZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgdGV4dD0iRm9sbG93IixjbGFzc19uYW1lPSJhbmRyb2lkLnZpZXcuVmlldyIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIGNvbmZpcm1fZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGNvbmZpcm1fZm9sbG93X2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB0ZXh0IHNhdSBraGkgbmjhuqVuIHRoZW8gZMO1aQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgICAgICMgS2jDtG5nIHRo4buDIGtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBuw7p0LCBuaMawbmcgY8OzIHRo4buDIMSRw6MgdGhlbyBkw7VpIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVwZGF0ZWRfZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9wcm9maWxlX2hlYWRlcl9mb2xsb3dfYnV0dG9uIikKICAgICAgICAgICAgICAgIGlmIG5vdCB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgIyBUaOG7rSB0w6xtIGzhuqFpIHRoZW8gdGV4dAogICAgICAgICAgICAgICAgICAgIGZvbGxvd190ZXh0cyA9IFsixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyIsICLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIiwgIlRoZW8gZMO1aSIsICJGb2xsb3ciXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvciB0ZXh0IGluIGZvbGxvd190ZXh0czoKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9mb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCB0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHVwZGF0ZWRfZm9sbG93X2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY8OhYyB0csaw4budbmcgaOG7o3Aga2jDoWMgbmhhdQogICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfdGV4dCBpbiBbIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiRm9sbG93IHRow6BuaCBjw7RuZyEiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgICAgICAgIGVsaWYgdXBkYXRlZF90ZXh0IGluIFsixJDDoyB5w6p1IGPhuqd1IiwgIlJlcXVlc3RlZCJdOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIGfhu61pIHnDqnUgY+G6p3UgdGhlbyBkw7VpIHRow6BuaCBjw7RuZyEiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gNQogICAgICAgICAgICAgICAgICAgIGVsaWYgdXBkYXRlZF90ZXh0IGluIFsiVGhlbyBkw7VpIiwgIkZvbGxvdyJdOgogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgdGjDtG5nIGLDoW8gIlnDqnUgY+G6p3UgY+G7p2EgYuG6oW4gxJFhbmcgY2jhu50iIGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEuNSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmR1bXBfc2NyZWVuX3dpdGhfcmV0cnkoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgS2jDtG5nIHRo4buDIGtp4buDbSB0cmEgdGnhur9wLCBnaeG6oyDEkeG7i25oIGzDoCDEkcOjIGfhu61pIHnDqnUgY+G6p3UgdGhlbyBkw7VpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHdhaXRpbmdfdGV4dCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgdGV4dD0iWcOqdSBj4bqndSBj4bunYSBi4bqhbiDEkWFuZyBjaOG7nSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHdhaXRpbmdfdGV4dDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgQuG6pW0gbsO6dCBPSyBsacOqbiB04bulYyBjaG8gxJHhur9uIGtoaSBraMO0bmcgY8OybiBkaWFsb2cKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Rpc21pc3NfYWxsX2RpYWxvZ3MoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiSG/DoG4gdGjDoG5oLCB5w6p1IGPhuqd1IHRoZW8gZMO1aSDEkWFuZyBjaOG7nSBkdXnhu4d0IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiA0CiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAKCiAKCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJGb2xsb3cga2jDtG5nIHRow6BuaCBjw7RuZywgdGV4dCBj4bunYSBuw7p0IGzDoDoge3VwZGF0ZWRfdGV4dH0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEtow7RuZyB0w6xtIHRo4bqleSBuw7p0LCBjw7MgdGjhu4MgxJHDoyBmb2xsb3cgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgZm9sbG93IHNhdSBraGkgbmjhuqVuLCBnaeG6oyDEkeG7i25oIMSRw6MgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJUZXh0IGPhu6dhIG7DunQga2jDtG5nIGto4bubcCB24bubaSAnVGhlbyBkw7VpJyBob+G6t2MgJ0ZvbGxvdyc6IHtidXR0b25fdGV4dH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gam9iIGZvbGxvdzoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gMgogICAgCiAgICBkZWYgX3BlcmZvcm1fbGlrZV9qb2Ioc2VsZiwgcG9zdF9saW5rOiBzdHIpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGpvYiBsaWtlIGLDoGkgxJHEg25nIHRyw6puIEluc3RhZ3JhbQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHBvc3RfbGluazogTGluayDEkeG6v24gYsOgaSDEkcSDbmcgY+G6p24gbGlrZQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRy4bqhbmcgdGjDoWkgam9iICgwOiBjaMawYSBsw6BtLCAxOiBob8OgbiB0aMOgbmgsIDI6IGzhu5dpLCAzOiBi4buLIHVubGlrZSkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk3hu58gYsOgaSDEkcSDbmcgYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cDoge3Bvc3RfbGlua30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIHRy4buxYyB0aeG6v3AgVVJMIHRow7RuZyBxdWEgaGVscGVyLm9wZW5fdXJsKCkKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocG9zdF9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4budIHRyYW5nIGLDoGkgxJHEg25nIHThuqNpIHhvbmcgduG7m2kgdGjhu51pIGdpYW4gbmfhuqt1IG5oacOqbgogICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCg0LCA2KSAgIyBUxINuZyB0aOG7nWkgZ2lhbiBjaOG7nSBsw6puIDQtNnMKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIGNo4budIHt3YWl0X3RpbWV9cyDEkeG7gyB0cmFuZyB04bqjaSB4b25nLi4uIikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfdGltZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVnXhu5F0IG5o4bq5IGzDqm4gdHLDqm4ga2hv4bqjbmcgMSBu4butYSBtw6BuIGjDrG5oIMSR4buDIGhp4buDbiB0aOG7iyBuw7p0IGxpa2UKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVnXhu5F0IG5o4bq5IMSR4buDIGhp4buDbiB0aOG7iyBuw7p0IGxpa2UiKQogICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxLjUpICAjIFTEg25nIHRo4budaSBnaWFuIGNo4budIGzDqm4gMS41cwogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgbGlrZSB0aGVvIHJlc291cmNlLWlkCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmR1bXBfc2NyZWVuX3dpdGhfcmV0cnkoKQogICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgZHVtcCBtw6BuIGjDrG5oIGtoaSB0w6xtIG7DunQgbGlrZSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL3Jvd19mZWVkX2J1dHRvbl9saWtlIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5LCB0aOG7rSB2deG7kXQgbOG6p24gbuG7r2EKICAgICAgICAgICAgaWYgbm90IGxpa2VfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgbGlrZSwgdGjhu60gdnXhu5F0IGzhuqduIG7hu69hIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxLjUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmR1bXBfc2NyZWVuX3dpdGhfcmV0cnkoKQogICAgICAgICAgICAgICAgaWYgbm90IHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBkdW1wIG3DoG4gaMOsbmgga2hpIHTDrG0gbOG6oWkgbsO6dCBsaWtlIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvcm93X2ZlZWRfYnV0dG9uX2xpa2UiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgduG6q24ga2jDtG5nIHTDrG0gdGjhuqV5IHRoZW8gcmVzb3VyY2UtaWQsIHRo4butIHTDrG0gdGhlbyBjb250ZW50LWRlc2MKICAgICAgICAgICAgaWYgbm90IGxpa2VfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVGjhu60gdMOsbSBuw7p0IGxpa2UgdGhlbyBjb250ZW50LWRlc2MiKQogICAgICAgICAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iVGjDrWNoIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGxpa2VfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSB24bubaSB0ZXh0IHRp4bq/bmcgQW5oCiAgICAgICAgICAgICAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iTGlrZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IHbhuqtuIGtow7RuZyB0w6xtIHRo4bqleSwgYsOhbyBs4buXaQogICAgICAgICAgICBpZiBub3QgbGlrZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgbGlrZSBzYXUgbmhp4buBdSBs4bqnbiB0aOG7rSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBsaWtlIGNoxrBhIGLhurFuZyB0aHXhu5ljIHTDrW5oIHNlbGVjdGVkCiAgICAgICAgICAgIGlzX3NlbGVjdGVkID0gc2VsZi5oZWxwZXIuaXNfZWxlbWVudF9zZWxlY3RlZChsaWtlX2J1dHRvbikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Ugc2VsZWN0ZWQga2jDtG5nIGPDsyBnacOhIHRy4buLLCB0aOG7rSB0w6xtIG7DunQgIkLhu48gdGjDrWNoIiBob+G6t2MgIlVubGlrZSIKICAgICAgICAgICAgaWYgbm90IGlzX3NlbGVjdGVkOgogICAgICAgICAgICAgICAgdW5saWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPSJC4buPIHRow61jaCIpCiAgICAgICAgICAgICAgICBpZiBub3QgdW5saWtlX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICB1bmxpa2VfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9IlVubGlrZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlzX3NlbGVjdGVkID0gYm9vbCh1bmxpa2VfYnV0dG9uKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3UgxJHDoyBsaWtlIHLhu5NpIHRow6wgaG/DoG4gdGjDoG5oCiAgICAgICAgICAgIGlmIGlzX3NlbGVjdGVkOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBsaWtlIGLDoGkgdmnhur90IG7DoHkgdOG7qyB0csaw4bubYyIpCiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTGlrZSBiw6BpIHZp4bq/dAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJOaOG6pW4gbsO6dCBsaWtlIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGxpa2VfYnV0dG9uKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikgICMgVMSDbmcgdGjhu51pIGdpYW4gY2jhu50gbMOqbiAycwogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSDEkcOjIGxpa2UgdGjDoG5oIGPDtG5nIGNoxrBhCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmR1bXBfc2NyZWVuX3dpdGhfcmV0cnkoKQogICAgICAgICAgICBpZiBub3Qgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICMgS2jDtG5nIHRo4buDIGtp4buDbSB0cmEsIGdp4bqjIMSR4buLbmggxJHDoyBsaWtlIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHRo4buDIGtp4buDbSB0cmEgbOG6oWkgdHLhuqFuZyB0aMOhaSBsaWtlLCBnaeG6oyDEkeG7i25oIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGNoZWNrX3VubGlrZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPSJC4buPIHRow61jaCIpCiAgICAgICAgICAgIGlmIG5vdCBjaGVja191bmxpa2U6CiAgICAgICAgICAgICAgICBjaGVja191bmxpa2UgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iVW5saWtlIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgYuG6sW5nIHJlc291cmNlLWlkIHbDoCBzZWxlY3RlZAogICAgICAgICAgICBpZiBub3QgY2hlY2tfdW5saWtlOgogICAgICAgICAgICAgICAgbGlrZV9idXR0b25fYWZ0ZXIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvcm93X2ZlZWRfYnV0dG9uX2xpa2UiKQogICAgICAgICAgICAgICAgaWYgbGlrZV9idXR0b25fYWZ0ZXIgYW5kIHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b25fYWZ0ZXIpOgogICAgICAgICAgICAgICAgICAgIGNoZWNrX3VubGlrZSA9IFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBjaGVja191bmxpa2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIGxpa2UgYsOgaSB2aeG6v3QgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHjDoWMgbmjhuq1uIMSRw6MgbGlrZSBiw6BpIHZp4bq/dCIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2IgbGlrZToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAKICAgIGRlZiBfY2FyZV9zd2lwZV9mZWVkKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlZ14buRdCBi4bqjbmcgdGluIEluc3RhZ3JhbSB24bubaSB0aOG7nWkgZ2lhbiAyLTUgcGjDunQsIGPDsyB0aOG7gyBsaWtlIGLDoGkgbuG6v3UgZOG7q25nIGzDonUiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJhbmRvbSB0aOG7nWkgZ2lhbiB2deG7kXQgdOG7qyAyLTUgcGjDunQKICAgICAgICAgICAgdG90YWxfdGltZSA9IHJhbmRvbS5yYW5kaW50KDEyMCwgMzAwKSAgIyAyLTUgcGjDunQKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSB2deG7kXQgYuG6o25nIHRpbiB0cm9uZyB7dG90YWxfdGltZX0gZ2nDonkiKQogICAgICAgICAgICAKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHN3aXBlX2NvdW50ID0gMAogICAgICAgICAgICBsaWtlX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkgPCB0b3RhbF90aW1lOgogICAgICAgICAgICAgICAgc3dpcGVfY291bnQgKz0gMQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRo4budaSBnaWFuIGThu6tuZyBuZ+G6q3Ugbmhpw6puIHThu6sgMi0xMCBnacOieQogICAgICAgICAgICAgICAgcGF1c2VfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDEwKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiJWdeG7kXQgbOG6p24ge3N3aXBlX2NvdW50fSwgZOG7q25nIHtwYXVzZV90aW1lfXMiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGThu6tuZyBsw6J1IGjGoW4gNXMgdGjDrCBjw7MgMTAlIGNoYW5jZSBsaWtlIGLDoGkgKGdp4bqjbSB04burIDIwJSkKICAgICAgICAgICAgICAgIGlmIHBhdXNlX3RpbWUgPiA1IGFuZCByYW5kb20ucmFuZGludCgxLCAxMDApIDw9IDEwOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlRo4butIGxpa2UgYsOgaSB2aeG6v3QgbsOgeS4uLiIpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIFTDrG0gbsO6dCBsaWtlIHRyb25nIGZlZWQKICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9yb3dfZmVlZF9idXR0b25fbGlrZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsaWtlX2J1dHRvbiBhbmQgbm90IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihsaWtlX2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBsaWtlIGLDoGkgdmnhur90ICh04buVbmc6IHtsaWtlX2NvdW50fSBsaWtlcykiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVGjDqm0gdGjhu51pIGdpYW4gY2jhu50gc2F1IGtoaSBsaWtlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDEsIDIpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiJLaMO0bmcgdGjhu4MgbGlrZSBiw6BpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEThu6tuZyB0aGVvIHRo4budaSBnaWFuIMSRw6MgcmFuZG9tCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHBhdXNlX3RpbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgZWxhcHNlZCA9IHRpbWUudGltZSgpIC0gc3RhcnRfdGltZQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIHZ14buRdCBmZWVkOiB7c3dpcGVfY291bnR9IGzhuqduIHZ14buRdCwge2xpa2VfY291bnR9IGxpa2VzIHRyb25nIHtlbGFwc2VkOi4xZn1zIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUXVheSBs4bqhaSB0cmFuZyBjaOG7pwogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHZ14buRdCBmZWVkOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2NhcmVfd2F0Y2hfcmVlbHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMaw4bubdCByZWVsIHbhu5tpIHRo4budaSBnaWFuIGThu6tuZyByYW5kb20gdsOgIGPDsyB0aOG7gyBsaWtlIHZpZGVvIG7hur91IGThu6tuZyBsw6J1IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgbMaw4bubdCByZWVsLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgdHLGsOG7m2MKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjw7MgdGFiIHJlZWwga2jDtG5nCiAgICAgICAgICAgIHJlZWxfdGFiID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0aW1lb3V0PTUsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvY2xpcHNfdGFiIikKICAgICAgICAgICAgaWYgbm90IHJlZWxfdGFiOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiBSZWVsIChjbGlwc190YWIpIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihyZWVsX3RhYikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDUpCiAgICAgICAgICAgIAogICAgICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgdG90YWxfd2FpdCA9IHJhbmRvbS5yYW5kaW50KDEyMCwgMTgwKSAgIyAyLTMgcGjDunQKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlThu5VuZyB0aOG7nWkgZ2lhbiBsxrDhu5t0IHJlZWwgc+G6vSBsw6Age3RvdGFsX3dhaXR9IGdpw6J5IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsYXBzZWQgPSAwCiAgICAgICAgICAgIHN3aXBlX2NvdW50ID0gMAogICAgICAgICAgICBsaWtlX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgZWxhcHNlZCA8IHRvdGFsX3dhaXQ6CiAgICAgICAgICAgICAgICBzd2lwZV9jb3VudCArPSAxCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIsSQYW5nIHZ14buRdCByZWVsIGzhuqduIHRo4bupIHtzd2lwZV9jb3VudH0iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRo4budaSBnaWFuIHhlbSB2aWRlbyByYW5kb20gdOG7qyAyLTEwcwogICAgICAgICAgICAgICAgdmlkZW9fdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDEwKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiJYZW0gdmlkZW8gbsOgeSB7dmlkZW9fdGltZX0gZ2nDonkuLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGThu6tuZyBsw6J1IGjGoW4gM3MgdGjDrCBjw7MgMjAlIGNoYW5jZSBsaWtlIHZpZGVvIChnaeG6o20gdOG7qyA2MCUpCiAgICAgICAgICAgICAgICBpZiB2aWRlb190aW1lID4gMyBhbmQgcmFuZG9tLnJhbmRpbnQoMSwgMTAwKSA8PSAyMDoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2jhu50gbeG7mXQgY2jDunQgxJHhu4MgdmlkZW8gbG9hZAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgVMOsbSBuw7p0IGxpa2UgdHJvbmcgcmVlbAogICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSBuw7p0IGxpa2UgdGhlbyBjw6FjIHJlc291cmNlLWlkIGtow6FjIG5oYXUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2xpa2VfYnV0dG9uIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBsaWtlX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPSJUaMOtY2giKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGxpa2VfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9Ikxpa2UiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsaWtlX2J1dHRvbiBhbmQgbm90IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlRo4butIGxpa2UgdmlkZW8gcmVlbCBuw6B5Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIobGlrZV9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlrZV9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbGlrZSB2aWRlbyByZWVsICh04buVbmc6IHtsaWtlX2NvdW50fSBsaWtlcykiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgWGVtIHRow6ptIDItMTBzIHNhdSBraGkgbGlrZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4dHJhX3RpbWUgPSByYW5kb20ucmFuZGludCgyLCAxMCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIlhlbSB0aMOqbSB7ZXh0cmFfdGltZX1zIHNhdSBraGkgbGlrZSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChleHRyYV90aW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBsaWtlIGhv4bq3YyDEkcOjIGxpa2UgcuG7k2kiKQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIktow7RuZyB0aOG7gyBkdW1wIHNjcmVlbiDEkeG7gyB0w6xtIG7DunQgbGlrZSIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIktow7RuZyB0aOG7gyBsaWtlIHZpZGVvIHJlZWw6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgROG7q25nIHRoZW8gdGjhu51pIGdpYW4gxJHDoyByYW5kb20KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAodmlkZW9fdGltZSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGVsYXBzZWQgPSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGZvcmNlIHN0b3AKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMC4xKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJU4buVbmcgc+G7kSBs4bqnbiB2deG7kXQ6IHtzd2lwZV9jb3VudH0sIHtsaWtlX2NvdW50fSBsaWtlcyIpCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgbMaw4bubdCB4b25nIGPDoWMgcmVlbCwgcXVheSBs4bqhaSB0cmFuZyBjaOG7py4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFF1YXkgbOG6oWkgdHJhbmcgY2jhu6cKICAgICAgICAgICAgaWYgbm90IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQoY29udGVudF9kZXNjPSJUcmFuZyBjaOG7pyIsIHRpbWVvdXQ9NSk6CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIiwgdGltZW91dD01KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgcXVheSBs4bqhaSB0cmFuZyBjaOG7pyBzYXUga2hpIGzGsOG7m3QgcmVlbC4iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbMaw4bubdCByZWVsOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfY2FyZV92aWV3X3N0b3JpZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiWGVtIHN0b3J5IDMtNSBzdG9yeSB24bubaSB04buRYyDEkeG7mSBuZ+G6q3Ugbmhpw6puIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRo4budaSBnaWFuIHhlbSBzdG9yeSBjdeG7kWkgY8O5bmcgdOG7qyBhY2NvdW50CiAgICAgICAgICAgIGxhc3Rfdmlld19zdG9yaWVzID0gYWNjb3VudC5nZXQoImxhc3Rfdmlld19zdG9yaWVzIiwgMCkKICAgICAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICBpZiBsYXN0X3ZpZXdfc3RvcmllcyA+IDAgYW5kIChjdXJyZW50X3RpbWUgLSBsYXN0X3ZpZXdfc3RvcmllcykgPCAxMDgwMDogICMgMyB0aeG6v25nID0gMTA4MDAgZ2nDonkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkNoxrBhIMSR4bunIDMgdGnhur9uZyBr4buDIHThu6sgbOG6p24geGVtIHN0b3J5IGN14buRaSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgICMgVMOsbSB04bqldCBj4bqjIHN0b3J5IHRodW1ibmFpbHMgdGhlbyByZXNvdXJjZS1pZAogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgc3RvcnlfdGh1bWJzID0gW10KICAgICAgICAgICAgaWYgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgIHN0b3J5X3RodW1icyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbChzY3JlZW5feG1sLCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2F2YXRhcl9pbWFnZV92aWV3IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBjw7Mgw610IG5o4bqldCAyIHN0b3J5IHRow6wgbeG7m2kgbMOgbQogICAgICAgICAgICBpZiBsZW4oc3RvcnlfdGh1bWJzKSA8IDI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiS2jDtG5nIMSR4bunIHN0b3J5IMSR4buDIHhlbSAoY2jhu4kgY8OzIHtsZW4oc3RvcnlfdGh1bWJzKX0gc3RvcnkpLCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSYW5kb20gY2jhu41uIHN0b3J5IHThu6sgdGjhu6kgMiDEkeG6v24gY3Xhu5FpCiAgICAgICAgICAgIHN0YXJ0X2luZGV4ID0gcmFuZG9tLnJhbmRpbnQoMSwgbGVuKHN0b3J5X3RodW1icykgLSAxKQogICAgICAgICAgICBzZWxlY3RlZF9zdG9yeSA9IHN0b3J5X3RodW1ic1tzdGFydF9pbmRleF0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQuG6pW0gdsOgbyBzdG9yeSDEkcaw4bujYyBjaOG7jW4KICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlbGVjdGVkX3N0b3J5KQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgWGVtIDMtOCBzdG9yeSB24bubaSB04buRYyDEkeG7mSBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgIG51bV9zdG9yaWVzID0gcmFuZG9tLnJhbmRpbnQoMywgOCkKICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UobnVtX3N0b3JpZXMpOgogICAgICAgICAgICAgICAgIyBUaOG7nWkgZ2lhbiB4ZW0gc3Rvcnk6IG5n4bqvbiBob+G6t2MgZMOgaSBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgICAgICB3YWl0ID0gcmFuZG9tLnVuaWZvcm0oMS4wLCAzLjApIGlmIHJhbmRvbS5jaG9pY2UoW1RydWUsIEZhbHNlXSkgZWxzZSByYW5kb20udW5pZm9ybSgzLjAsIDUuMCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YWl0KQogICAgICAgICAgICAgICAgIyBDaHV54buDbiBzYW5nIHN0b3J5IHRp4bq/cCB0aGVvIGLhurFuZyBjw6FjaCBi4bqlbSB2w6BvIHbhu4sgdHLDrSBuZ+G6q3Ugbmhpw6puIOG7nyBnaeG7r2EgbcOgbiBow6xuaAogICAgICAgICAgICAgICAgd2lkdGgsIGhlaWdodCA9IHNlbGYuaGVscGVyLmdldF9zY3JlZW5fc2l6ZSgpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9yaWdodCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRob8OhdCBzdG9yeSB2aWV3ZXIKICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7nWkgZ2lhbiB4ZW0gc3RvcnkgY3Xhu5FpIGPDuW5nIHbDoG8gYWNjb3VudAogICAgICAgICAgICBpZiBhY2NvdW50IGFuZCAiaWQiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsibGFzdF92aWV3X3N0b3JpZXMiOiBjdXJyZW50X3RpbWUsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgeGVtIHN0b3J5OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2NhcmVfdmlld19ub3RpZmljYXRpb25zKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIk3hu58gdGFiIHRow7RuZyBiw6FvIHbDoCBjdeG7mW4gbmjhurkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDE6IEtp4buDbSB0cmEgY8OzIG5vdGlmaWNhdGlvbiBiYWRnZSBraMO0bmcKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbm90aWZpY2F0aW9uX2JhZGdlID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2xlZF9iYWRnZSIpCiAgICAgICAgICAgIGlmIG5vdCBub3RpZmljYXRpb25fYmFkZ2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJLaMO0bmcgY8OzIG5vdGlmaWNhdGlvbiBiYWRnZSwgYuG7jyBxdWEgeGVtIHRow7RuZyBiw6FvIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogQuG6pW0gdsOgbyBub3RpZmljYXRpb24gdGFiCiAgICAgICAgICAgIG5vdGlmaWNhdGlvbl90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvbm90aWZpY2F0aW9uIikKICAgICAgICAgICAgaWYgbm90IG5vdGlmaWNhdGlvbl90YWI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbm90aWZpY2F0aW9uIHRhYiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIobm90aWZpY2F0aW9uX3RhYikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDIsIDMpKSAgIyDEkOG7jWMgMi0zcwogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDM6IFJhbmRvbSB44butIGzDvQogICAgICAgICAgICBpZiByYW5kb20uY2hvaWNlKFtUcnVlLCBGYWxzZV0pOgogICAgICAgICAgICAgICAgIyBUw6xtIHbDoCBi4bqlbSB2w6BvIHN0b3J5IHJvdwogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpCiAgICAgICAgICAgICAgICBpZiBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgICAgIHN0b3J5X3Jvd3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoc2NyZWVuX3htbCwgcmVzb3VyY2VfaWQ9ImFjdGl2aXR5X2ZlZWRfbmV3c2ZlZWRfc3Rvcnlfcm93IikKICAgICAgICAgICAgICAgICAgICBpZiBzdG9yeV9yb3dzIGFuZCBsZW4oc3Rvcnlfcm93cykgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAjIFJhbmRvbSBjaOG7jW4gaW5kZXggdOG7qyAxLTMgKGhv4bq3YyDDrXQgaMahbiBu4bq/dSBraMO0bmcgxJHhu6cpCiAgICAgICAgICAgICAgICAgICAgICAgIG1heF9pbmRleCA9IG1pbigzLCBsZW4oc3Rvcnlfcm93cykgLSAxKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBtYXhfaW5kZXggPj0gMToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX2luZGV4ID0gcmFuZG9tLnJhbmRpbnQoMSwgbWF4X2luZGV4KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0ZWRfc3RvcnkgPSBzdG9yeV9yb3dzW3NlbGVjdGVkX2luZGV4XQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlbGVjdGVkX3N0b3J5KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDMsIDQpKSAgIyBDaOG7nSAzLTRzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gMS0zIGzhuqduCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgXyBpbiByYW5nZShyYW5kb20ucmFuZGludCgxLCAzKSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgxLCAyKSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgUmFuZG9tIHZ14buRdCBsw6puIGhv4bq3YyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5jaG9pY2UoW1RydWUsIEZhbHNlXSk6CiAgICAgICAgICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiAxLTMgbOG6p24KICAgICAgICAgICAgICAgICAgICBmb3IgXyBpbiByYW5nZShyYW5kb20ucmFuZGludCgxLCAzKSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDEsIDIpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDQ6IFF1YXkgbOG6oWkgaG9tZQogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB4ZW0gdGjDtG5nIGLDoW86IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBwZXJmb3JtX2NhcmUoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIkxlZ2FjeSBtZXRob2QgLSByZWRpcmVjdHMgdG8gU21hcnQgQ2FyZSBTeXN0ZW0gZm9yIGNvbnNpc3RlbmN5IiIiCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkNodXnhu4NuIGjGsOG7m25nIHBlcmZvcm1fY2FyZSBJbnN0YWdyYW0gc2FuZyBTbWFydCBDYXJlIFN5c3RlbSBjaG8gdMOgaSBraG/huqNuOiB7YWNjb3VudFsndW5pcXVlX3VzZXJuYW1lJ119IikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUmFuZG9tIGNo4buNbiAxIHRyb25nIDMgU21hcnQgQ2FyZSBtZXRob2RzIMSR4buDIHTGsMahbmcgdGjDrWNoIHbhu5tpIGxlZ2FjeQogICAgICAgICAgICBzbWFydF9jYXJlX2FjdGlvbnMgPSBbCiAgICAgICAgICAgICAgICBzZWxmLl9jYXJlX3N3aXBlX2ZlZWQsCiAgICAgICAgICAgICAgICBzZWxmLl9jYXJlX3dhdGNoX3JlZWxzLCAKICAgICAgICAgICAgICAgIHNlbGYuX2NhcmVfdmlld19ub3RpZmljYXRpb25zCiAgICAgICAgICAgIF0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmFuZG9tIGNo4buNbiBhY3Rpb24KICAgICAgICAgICAgc2VsZWN0ZWRfYWN0aW9uID0gcmFuZG9tLmNob2ljZShzbWFydF9jYXJlX2FjdGlvbnMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gU21hcnQgQ2FyZSBhY3Rpb24KICAgICAgICAgICAgcmV0dXJuIHNlbGVjdGVkX2FjdGlvbihhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gU21hcnQgQ2FyZSBjaG8gSW5zdGFncmFtOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBwb3N0X25ld2ZlZWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDEg25nIOG6o25oIGNobyBJbnN0YWdyYW0gLSBvcHRpb25hbCBjYXJlIGFjdGl2aXR5CiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSDEkcSDbmcg4bqjbmggY2hvIHTDoGkga2hv4bqjbjoge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMTogxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pyBJbnN0YWdyYW0KICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgdsOgbyB0cmFuZyBjaOG7pyBJbnN0YWdyYW0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMjogUmFuZG9tIHPhu5EgbMaw4bujbmcg4bqjbmggdsOgIHThuqNpIHbhu4EKICAgICAgICAgICAgaW1hZ2VfY291bnQgPSByYW5kb20ucmFuZGludCgxLCA1KQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiUmFuZG9tIHtpbWFnZV9jb3VudH0g4bqjbmggxJHhu4MgxJHEg25nIGLDoGkiKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuZG93bmxvYWRfaW1hZ2UoY291bnQ9aW1hZ2VfY291bnQpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiVOG6o2kg4bqjbmggdGjhuqV0IGLhuqFpLCBi4buPIHF1YSDEkcSDbmcgYsOgaSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBCxrDhu5tjIDM6IE5o4bqlbiBuw7p0IHThuqFvIGLDoGkgdmnhur90IChjcmVhdGlvbl90YWIgaG/hurdjIG7DunQgKykKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6pW0gbsO6dCB04bqhbyBiw6BpIHZp4bq/dC4uLiIpCiAgICAgICAgICAgIGFkZF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvY3JlYXRpb25fdGFiIiwgdGltZW91dD01KQogICAgICAgICAgICBpZiBub3QgYWRkX2J1dHRvbjoKICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSBuw7p0ICsg4bufIHbhu4sgdHLDrSBraMOhYwogICAgICAgICAgICAgICAgYWRkX2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQocmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9hY3Rpb25fYmFyX2J1dHRvbnNfY29udGFpbmVyX2xlZnQiLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBpZiBub3QgYWRkX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAjIFRo4butIGPDoWMgY8OhY2ggdMOsbSBraMOhYwogICAgICAgICAgICAgICAgICAgIGFkZF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iTmV3IHBvc3QiLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGFkZF9idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iQWRkIiwgdGltZW91dD01KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgYWRkX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IHThuqFvIGLDoGkgdmnhur90IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgIyBDaOG7nSBjYW1lcmEgZGVzdGluYXRpb24gZmVlZAogICAgICAgICAgICBjYW1lcmFfZGVzdCA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQodGltZW91dD01LCByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2NhbV9kZXN0X2ZlZWQiKQogICAgICAgICAgICBpZiBub3QgY2FtZXJhX2Rlc3Q6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgY2FtX2Rlc3RfZmVlZCIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVMOsbSB0aOG6pXkgdGjDrCBjbGljawogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGNhbWVyYV9kZXN0KQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBpbWFnZV9jb3VudCA+IDE6CiAgICAgICAgICAgICAgICAjIELGsOG7m2MgNDogQuG6pW0gIkNI4buMTiBOSEnhu4BVIiBu4bq/dSBj4bqnbiBjaOG7jW4gbmhp4buBdSDhuqNuaAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6pW0gJ0NI4buMTiBOSEnhu4BVJy4uLiIpCiAgICAgICAgICAgICAgICBtdWx0aV9zZWxlY3RfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudCh0ZXh0PSJDSOG7jE4gTkhJ4buAVSIsIHRpbWVvdXQ9MykKICAgICAgICAgICAgICAgIGlmIG5vdCBtdWx0aV9zZWxlY3RfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSB0aGVvIGNvbnRlbnQtZGVzYwogICAgICAgICAgICAgICAgICAgIG11bHRpX3NlbGVjdF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iTsO6dCBjaOG7jW4gbmhp4buBdSIsIHRpbWVvdXQ9MykKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbXVsdGlfc2VsZWN0X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBUaOG7rSB0w6xtIHRoZW8gcmVzb3VyY2UtaWQKICAgICAgICAgICAgICAgICAgICAgICAgbXVsdGlfc2VsZWN0X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQocmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9tdWx0aV9zZWxlY3Rfc2xpZGVfYnV0dG9uX2FsdCIsIHRpbWVvdXQ9MykKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IG11bHRpX3NlbGVjdF9idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCAnQ0jhu4xOIE5ISeG7gFUnIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyA1OiBDaOG7jW4g4bqjbmggdGhlbyBz4buRIGzGsOG7o25nIMSRw6MgcmFuZG9tCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQ2jhu41uIHtpbWFnZV9jb3VudH0g4bqjbmggdOG7qyB0aMawIHZp4buHbi4uLiIpCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyBkdW1wIG3DoG4gaMOsbmggxJHhu4MgdMOsbSDhuqNuaCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBnYWxsZXJ5X2l0ZW1zID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvZ2FsbGVyeV9ncmlkX2l0ZW1fdGh1bWJuYWlsIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGdhbGxlcnlfaXRlbXM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IOG6o25oIG7DoG8gdHJvbmcgdGjGsCB2aeG7h24iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buNbiBz4buRIGzGsOG7o25nIOG6o25oIHRoZW8gecOqdSBj4bqndSAodOG7kWkgxJFhIGzDoCBz4buRIOG6o25oIGPDsyBz4bq1bikKICAgICAgICAgICAgICAgICMgQuG7jyBxdWEg4bqjbmggxJHhuqd1IHRpw6puIHbDrCBJbnN0YWdyYW0gxJHDoyB04buxIMSR4buZbmcgY2jhu41uCiAgICAgICAgICAgICAgICBpdGVtc190b19zZWxlY3QgPSBtaW4oaW1hZ2VfY291bnQsIGxlbihnYWxsZXJ5X2l0ZW1zKSkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKGdhbGxlcnlfaXRlbXMpfSDhuqNuaCwgc+G6vSBjaOG7jW4ge2l0ZW1zX3RvX3NlbGVjdH0g4bqjbmggKGLhu48gcXVhIOG6o25oIMSR4bqndSB0acOqbiDEkcOjIMSRxrDhu6NjIGNo4buNbiB04buxIMSR4buZbmcpIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBC4bqvdCDEkeG6p3UgdOG7qyDhuqNuaCB0aOG7qSAyIChpbmRleCAxKSB2w6wg4bqjbmggxJHhuqd1IHRpw6puIMSRw6MgxJHGsOG7o2MgY2jhu41uIHThu7EgxJHhu5luZwogICAgICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMSwgaXRlbXNfdG9fc2VsZWN0KToKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoZ2FsbGVyeV9pdGVtc1tpXSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGNo4buNbiDhuqNuaCB7aSsxfS97aXRlbXNfdG9fc2VsZWN0fSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJU4buVbmcgY+G7mW5nIMSRw6MgY2jhu41uIHtpdGVtc190b19zZWxlY3R9IOG6o25oICgxIOG6o25oIHThu7EgxJHhu5luZyArIHtpdGVtc190b19zZWxlY3QtMX0g4bqjbmggdGjhu6cgY8O0bmcpIikKCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIMSQ4buRaSB24bubaSAxIOG6o25oLCBjaOG7iSBj4bqnbiBjaOG7jW4g4bqjbmggxJHhuqd1IHRpw6puCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJDaOG7jW4g4bqjbmggxJHhuqd1IHRpw6puIHRyb25nIHRoxrAgdmnhu4duLi4uIikKICAgICAgICAgICAgICAgICMgS2jDtG5nIGPhuqduIHdhaXRfdG9fdGFwX2VsZW1lbnQgY2hvIHhwYXRoIHBo4bupYyB04bqhcCwgZMO5bmcgZmluZF9lbGVtZW50IHRow7RuZyB0aMaw4budbmcKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmR1bXBfc2NyZWVuX3dpdGhfcmV0cnkoKQogICAgICAgICAgICAgICAgaWYgbm90IHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGR1bXAgbcOgbiBow6xuaCDEkeG7gyB0w6xtIOG6o25oIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIOG6o25oIMSR4bqndSB0acOqbiB0cm9uZyBnYWxsZXJ5CiAgICAgICAgICAgICAgICBmaXJzdF9pbWFnZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuSW1hZ2VWaWV3IikKICAgICAgICAgICAgICAgIGlmIG5vdCBmaXJzdF9pbWFnZToKICAgICAgICAgICAgICAgICAgICAjIFRo4butIHTDrG0gdGhlbyByZXNvdXJjZS1pZAogICAgICAgICAgICAgICAgICAgIGdhbGxlcnlfaXRlbXMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoc2NyZWVuX3htbCwgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9nYWxsZXJ5X2dyaWRfaXRlbV90aHVtYm5haWwiKQogICAgICAgICAgICAgICAgICAgIGlmIGdhbGxlcnlfaXRlbXM6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpcnN0X2ltYWdlID0gZ2FsbGVyeV9pdGVtc1swXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgZmlyc3RfaW1hZ2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IOG6o25oIHRyb25nIHRoxrAgdmnhu4duIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUYXAgdsOgbyDhuqNuaCDEkeG6p3UgdGnDqm4KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihmaXJzdF9pbWFnZSkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgxLCAyKSkKCiAgICAgICAgICAgICMgQsaw4bubYyA2OiBC4bqlbSBuw7p0IE5leHQKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6pW0gbsO6dCBOZXh0Li4uIikKICAgICAgICAgICAgbmV4dF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvbmV4dF9idXR0b25fdGV4dHZpZXciLCB0aW1lb3V0PTEwKQogICAgICAgICAgICBpZiBub3QgbmV4dF9idXR0b246CiAgICAgICAgICAgICAgICAjIFRo4butIHTDrG0gbsO6dCBOZXh0IGLhurFuZyB0ZXh0CiAgICAgICAgICAgICAgICBuZXh0X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQodGV4dD0iVGnhur9wIiwgdGltZW91dD01KQogICAgICAgICAgICAgICAgaWYgbm90IG5leHRfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIG5leHRfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IlRp4bq/cCIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgbmV4dF9idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IFRp4bq/cCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICMgQsaw4bubYyA3OiBOaOG6pW4gVGnhur9wIGzhuqduIG7hu69hIChi4buPIHF1YSBlZGl0KQogICAgICAgICAgICBuZXh0X2J1dHRvbjIgPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHRleHQ9IlRp4bq/cCIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgaWYgbm90IG5leHRfYnV0dG9uMjoKICAgICAgICAgICAgICAgIG5leHRfYnV0dG9uMiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQoY29udGVudF9kZXNjPSJUaeG6v3AiLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIGlmIG5leHRfYnV0dG9uMjoKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgyLCAzKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhbGlkYXRlX25leHQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iVGnhur9wIikKCiAgICAgICAgICAgIGlmIHZhbGlkYXRlX25leHQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgdXAgYsOgaSB2aeG6v3QsIELhuqVtIFRp4bq/cCBraMO0bmcgxJHGsOG7o2MiKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9Ikjhu6d5IiwgdGltZW91dD01KQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgODogVGjDqm0gY2FwdGlvbiAodMO5eSBjaOG7jW4pCiAgICAgICAgICAgIGNhcHRpb25fZmllbGQgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iV3JpdGUgYSBjYXB0aW9uLi4uIikKICAgICAgICAgICAgaWYgbm90IGNhcHRpb25fZmllbGQ6CiAgICAgICAgICAgICAgICAjIFRo4butIHTDrG0gdGhlbyBjw6FjaCBraMOhYwogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuZHVtcF9zY3JlZW5fd2l0aF9yZXRyeSgpIAogICAgICAgICAgICAgICAgaWYgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICAgICBjYXB0aW9uX2ZpZWxkID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCB0ZXh0PSJXcml0ZSBhIGNhcHRpb24uLi4iKQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBjYXB0aW9uX2ZpZWxkOgogICAgICAgICAgICAgICAgICAgICAgICAjIFTDrG0gZmllbGQgY2jhu6lhIHThu6sgImNhcHRpb24iCiAgICAgICAgICAgICAgICAgICAgICAgIGFsbF9lbGVtZW50cyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbChzY3JlZW5feG1sLCBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5FZGl0VGV4dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBlbGVtZW50IGluIGFsbF9lbGVtZW50czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBlbGVtZW50LmdldCgidGV4dCIsICIiKS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBoaW50ID0gZWxlbWVudC5nZXQoImhpbnQiLCAiIikubG93ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgImNhcHRpb24iIGluIHRleHQgb3IgImNhcHRpb24iIGluIGhpbnQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FwdGlvbl9maWVsZCA9IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICBpZiBjYXB0aW9uX2ZpZWxkOgogICAgICAgICAgICAgICAgIyBSYW5kb20gdGjDqm0gY2FwdGlvbiBob+G6t2Mga2jDtG5nICg3MCUgY8ahIGjhu5lpIGPDsyBjYXB0aW9uKQogICAgICAgICAgICAgICAgaWYgcmFuZG9tLmNob2ljZShbVHJ1ZSwgVHJ1ZSwgVHJ1ZSwgVHJ1ZSwgVHJ1ZSwgVHJ1ZSwgVHJ1ZSwgRmFsc2UsIEZhbHNlLCBGYWxzZV0pOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgIyDEkOG7jWMgY2FwdGlvbnMgdOG7qyBmaWxlIHRlbXBsYXRlCiAgICAgICAgICAgICAgICAgICAgICAgIGNhcHRpb25fZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKG9zLnBhdGguZGlybmFtZShvcy5wYXRoLmRpcm5hbWUoX19maWxlX18pKSwgInRlbXBsYXRlIiwgImNhcHRpb25zX2luc3RhZ3JhbS50eHQiKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhjYXB0aW9uX2ZpbGVfcGF0aCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oY2FwdGlvbl9maWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXB0aW9ucyA9IFtsaW5lLnN0cmlwKCkgZm9yIGxpbmUgaW4gZi5yZWFkbGluZXMoKSBpZiBsaW5lLnN0cmlwKCldCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNhcHRpb25zOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkX2NhcHRpb24gPSByYW5kb20uY2hvaWNlKGNhcHRpb25zKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihjYXB0aW9uX2ZpZWxkKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnR5cGVfdGV4dChzZWxlY3RlZF9jYXB0aW9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHRow6ptIGNhcHRpb246IHtzZWxlY3RlZF9jYXB0aW9ufSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIkZpbGUgY2FwdGlvbnMgdHLhu5FuZyIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIHbhu4EgZW1vamkgbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhbGxiYWNrX2NhcHRpb25zID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICLwn4yfIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAi4pyoIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAi8J+ZgiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIvCfk7giLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICLwn5KrIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAi8J+MuCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIvCfjokiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICLwn5KdIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGNhcHRpb25fZmllbGQpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnR5cGVfdGV4dChyYW5kb20uY2hvaWNlKGZhbGxiYWNrX2NhcHRpb25zKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IGZpbGUgY2FwdGlvbnMsIHPhu60gZOG7pW5nIGVtb2ppIGZhbGxiYWNrIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHhu41jIGZpbGUgY2FwdGlvbnM6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICMgRmFsbGJhY2sgduG7gSBlbW9qaSBu4bq/dSBjw7MgbOG7l2kKICAgICAgICAgICAgICAgICAgICAgICAgZmFsbGJhY2tfY2FwdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAi8J+MnyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAi4pyoIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAi8J+ZgiIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAi8J+TuCIKICAgICAgICAgICAgICAgICAgICAgICAgXQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoY2FwdGlvbl9maWVsZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudHlwZV90ZXh0KHJhbmRvbS5jaG9pY2UoZmFsbGJhY2tfY2FwdGlvbnMpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICMgQsaw4bubYyA5OiBOaOG6pW4gQ2hpYSBz4bq7IMSR4buDIMSRxINuZyBiw6BpCiAgICAgICAgICAgIHNoYXJlX2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQodGV4dD0iQ2hpYSBz4bq7IiwgdGltZW91dD01KQogICAgICAgICAgICBpZiBub3Qgc2hhcmVfYnV0dG9uOgogICAgICAgICAgICAgICAgc2hhcmVfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IkNoaWEgc+G6uyIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgICAgIGlmIG5vdCBzaGFyZV9idXR0b246CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgQ2hpYSBz4bq7IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oMywgNSkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIELGsOG7m2MgMTA6IEtp4buDbSB0cmEgxJHEg25nIHRow6BuaCBjw7RuZyB2w6AgcXVheSB24buBIGhvbWUKICAgICAgICAgICAgIyBDw7MgdGjhu4MgY8OzIHBvcHVwICJQb3N0IHNoYXJlZCIgaG/hurdjIHThu7EgxJHhu5luZyB24buBIGZlZWQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgb2tfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudCh0ZXh0PSJPSyIsIHRpbWVvdXQ9MykKICAgICAgICAgICAgICAgIGlmIG5vdCBva19idXR0b246CiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudCh0ZXh0PSJYb25nIiwgdGltZW91dD0zKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBRdWF5IHbhu4EgdHJhbmcgY2jhu6cKICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQxINuZyDhuqNuaCB0aMOgbmggY8O0bmcgY2hvIHTDoGkga2hv4bqjbjoge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSDEkcSDbmcg4bqjbmg6IHtlfSIpCiAgICAgICAgICAgICMgVGjhu60gcXVheSB24buBIHRyYW5nIGNo4bunIG7hur91IGPDsyBs4buXaQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2goc2VsZiwgdGFyZ2V0X2FjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGPDoWMgdGhhbyB0w6FjIFVJIMSR4buDIGNodXnhu4NuIHTDoGkga2hv4bqjbiBJbnN0YWdyYW0KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXJnZXRfYWNjb3VudDogVMOgaSBraG/huqNuIGPhuqduIGNodXnhu4NuIMSR4bq/bgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBib29sLAogICAgICAgICAgICAgICAgJ3JlYXNvbic6IHN0ciAobuG6v3UgdGjhuqV0IGLhuqFpKSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJzogc3RyCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICduYXZpZ2F0aW9uX2Vycm9yJywKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6ICdLaMO0bmcgdGjhu4MgxJHhur9uIHRyYW5nIGNo4bunIEluc3RhZ3JhbScKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE5o4bqlbiB2w6BvIHRhYiAiVHJhbmcgY8OhIG5ow6JuIgogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgcHJvZmlsZV90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iVHJhbmcgY8OhIG5ow6JuIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBwcm9maWxlX3RhYjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgdGFiIFRyYW5nIGPDoSBuaMOibiIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAndWlfZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0w6xtIHRo4bqleSB0YWIgVHJhbmcgY8OhIG5ow6JuJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmjhuqVwIHbDoG8gdGFiIFRyYW5nIGPDoSBuaMOibgogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIocHJvZmlsZV90YWIpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHVzZXJuYW1lIHThu6sgdGnDqnUgxJHhu4EgbOG7m24gdHJvbmcgYWN0aW9uIGJhcgogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgdXNlcm5hbWVfdGl0bGUgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCwgCiAgICAgICAgICAgICAgICByZXNvdXJjZV9pZD0iY29tLmluc3RhZ3JhbS5hbmRyb2lkOmlkL2FjdGlvbl9iYXJfbGFyZ2VfdGl0bGVfYXV0b19zaXplIgogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZV90aXRsZToKICAgICAgICAgICAgICAgIHVzZXJuYW1lX3RpdGxlID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbCgKICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvYWN0aW9uX2Jhcl90aXRsZSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lX3RpdGxlOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgwLjUpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICB1c2VybmFtZV90aXRsZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwgCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9hY3Rpb25fYmFyX2xhcmdlX3RpdGxlX2F1dG9fc2l6ZSIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZV90aXRsZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgdGnDqnUgxJHhu4EgdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAncmVhc29uJzogJ3VpX2Vycm9yJywKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6ICdLaMO0bmcgdMOsbSB0aOG6pXkgdGnDqnUgxJHhu4EgdXNlcm5hbWUnCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBOaOG6pXAgdsOgbyB0acOqdSDEkeG7gSB1c2VybmFtZSDEkeG7gyBt4bufIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1c2VybmFtZV90aXRsZSkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHTDqm4gdMOgaSBraG/huqNuIGPhuqduIGNodXnhu4NuIMSR4bq/bgogICAgICAgICAgICB0YXJnZXRfdXNlcm5hbWUgPSB0YXJnZXRfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHRy4buxYyB0aeG6v3AgdMOgaSBraG/huqNuIHRoZW8gdGV4dCAoY8OhY2ggxJHGoW4gZ2nhuqNuIG5o4bqldCkKICAgICAgICAgICAgYWNjb3VudHNfeG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgdGFyZ2V0X2l0ZW0gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKGFjY291bnRzX3htbCwgdGV4dD10YXJnZXRfdXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSwgdnXhu5F0IGzDqm4gdsOgIHTDrG0gbOG6oWkKICAgICAgICAgICAgaWYgbm90IHRhcmdldF9pdGVtOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0g4bufIGzhuqduIMSR4bqndSwgdnXhu5F0IGzDqm4gdsOgIHTDrG0gbOG6oWkiKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgbOG6oWkgWE1MIHbDoCB0w6xtIGzhuqFpCiAgICAgICAgICAgICAgICBhY2NvdW50c194bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAgICAgdGFyZ2V0X2l0ZW0gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKGFjY291bnRzX3htbCwgdGV4dD10YXJnZXRfdXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgdGFyZ2V0X2l0ZW06CiAgICAgICAgICAgICAgICAjIFRo4butIHTDrG0gdGhlbyBjb250ZW50LWRlc2MgKGPDsyB0aOG7gyBjaOG7qWEgdGjDtG5nIGLDoW8pCiAgICAgICAgICAgICAgICB0YXJnZXRfaXRlbXMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoYWNjb3VudHNfeG1sLCBjbGFzc19uYW1lPSJhbmRyb2lkLnZpZXcuVmlld0dyb3VwIikKICAgICAgICAgICAgICAgIGZvciBpdGVtIGluIHRhcmdldF9pdGVtczoKICAgICAgICAgICAgICAgICAgICBjb250ZW50X2Rlc2MgPSBpdGVtLmdldCgiY29udGVudC1kZXNjIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgaWYgdGFyZ2V0X3VzZXJuYW1lIGluIGNvbnRlbnRfZGVzYyBhbmQgIlRow6ptIHTDoGkga2hv4bqjbiIgbm90IGluIGNvbnRlbnRfZGVzYyBhbmQgIlRydW5nIHTDom0gdMOgaSBraG/huqNuIiBub3QgaW4gY29udGVudF9kZXNjOgogICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXRfaXRlbSA9IGl0ZW0KICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB0YXJnZXRfaXRlbToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBJbnN0YWdyYW0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbMOgIGLhu4sgdsO0IGhp4buHdSBow7NhIHRyb25nIERCCiAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KHRhcmdldF9hY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJkaXNhYmxlZCIsCiAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfcmVhc29uIjogIlTDoGkga2hv4bqjbiBraMO0bmcgY8OzIHRyw6puIHRoaeG6v3QgYuG7iyIsCiAgICAgICAgICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5o4bqlbiBCYWNrIMSR4buDIMSRw7NuZyBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBRdWF5IHbhu4EgdHJhbmcgY2jhu6cKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAncmVhc29uJzogJ2FjY291bnRfbm90X2ZvdW5kJywKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBJbnN0YWdyYW0nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBOaOG6pXAgdsOgbyB0w6BpIGtob+G6o24gbeG7pWMgdGnDqnUKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHRhcmdldF9pdGVtKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20KICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg1KTogICMgxJDhu6NpIGNodXnhu4NuIHTDoGkga2hv4bqjbiBob8OgbiB04bqldAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgZOG7q25nIHRyb25nIHN3aXRjaF90b19hY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdpbnRlcnJ1cHRlZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnQuG7iyBk4burbmcgdHJvbmcgcXXDoSB0csOsbmggY2h1eeG7g24gdMOgaSBraG/huqNuJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIGNodXnhu4NuIHTDoGkga2hv4bqjbiB0aMOgbmggY8O0bmcgY2jGsGEKICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGN1cnJlbnRfdXNlcm5hbWUgPT0gdGFyZ2V0X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY2h1eeG7g24gdMOgaSBraG/huqNuIHRow6BuaCBjw7RuZyBzYW5nIHt0YXJnZXRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBUcnVlLCAKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnxJDDoyBjaHV54buDbiB0w6BpIGtob+G6o24gdGjDoG5oIGPDtG5nIHNhbmcge3RhcmdldF91c2VybmFtZX0nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIsSQw6MgYuG6pW0gdsOgbyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gbmjGsG5nIGtp4buDbSB0cmEgbOG6oWkgdGjhuqV5IMSRYW5nIMSRxINuZyBuaOG6rXAgbMOgIHtjdXJyZW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAnc3dpdGNoX3ZlcmlmaWNhdGlvbl9mYWlsZWQnLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogZifEkMOjIGLhuqVtIHbDoG8gdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IG5oxrBuZyBraeG7g20gdHJhIGzhuqFpIHRo4bqleSDEkWFuZyDEkcSDbmcgbmjhuq1wIGzDoCB7Y3VycmVudF91c2VybmFtZX0nCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuIEluc3RhZ3JhbSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBxdWF5IHbhu4EgdHJhbmcgY2jhu6cKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdleGNlcHRpb24nLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ0zhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24gSW5zdGFncmFtOiB7c3RyKGUpfScKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgIGRlZiBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoc2VsZikgLT4gT3B0aW9uYWxbc3RyXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB1c2VybmFtZSBj4bunYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0ciBob+G6t2MgTm9uZTogVXNlcm5hbWUgY+G7p2EgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAsIGhv4bq3YyBOb25lIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICAjIEPDoWNoIDE6IMSQ4buNYyB04burIGF2YXRhcl9pbWFnZV92aWV3IOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgYXZhdGFyX3ZpZXcgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvYXZhdGFyX2ltYWdlX3ZpZXciKQogICAgICAgICAgICBpZiBhdmF0YXJfdmlldzoKICAgICAgICAgICAgICAgIGNvbnRlbnRfZGVzYyA9IGF2YXRhcl92aWV3LmdldCgiY29udGVudC1kZXNjIiwgIiIpCiAgICAgICAgICAgICAgICAjIGNvbnRlbnQtZGVzYyBk4bqhbmc6ICJUaW4gY+G7p2EgbmdvdGhpeWVuMjYwMTAwNTksIDAvMSwgQ2jGsGEgeGVtIgogICAgICAgICAgICAgICAgaWYgY29udGVudF9kZXNjIGFuZCAiVGluIGPhu6dhICIgaW4gY29udGVudF9kZXNjOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBjb250ZW50X2Rlc2Muc3BsaXQoIlRpbiBj4bunYSAiLCAxKVsxXS5zcGxpdCgiLCIsIDEpWzBdLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBs4bqleSB1c2VybmFtZSB04burIHRyYW5nIGNo4bunOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBj4bqvdCBjaHXhu5dpIGzhuqV5IHVzZXJuYW1lIHThu6sgY29udGVudC1kZXNjOiB7ZX0iKQoKICAgICAgICAgICAgIyBDw6FjaCAyOiBO4bq/dSBraMO0bmcgdGjDoG5oIGPDtG5nIOG7nyBjw6FjaCAxLCB0aOG7rSB2w6BvIHRyYW5nIGPDoSBuaMOibgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJLaMO0bmcgbOG6pXkgxJHGsOG7o2MgdXNlcm5hbWUgdOG7qyB0cmFuZyBjaOG7pywgdGjhu60gdsOgbyB0cmFuZyBjw6EgbmjDom4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBOaOG6pW4gdsOgbyB0YWIgIlRyYW5nIGPDoSBuaMOibiIKICAgICAgICAgICAgcHJvZmlsZV90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iVHJhbmcgY8OhIG5ow6JuIikKICAgICAgICAgICAgaWYgbm90IHByb2ZpbGVfdGFiOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSB0YWIgVHJhbmcgY8OhIG5ow6JuIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIocHJvZmlsZV90YWIpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQoKICAgICAgICAgICAgIyDEkOG7jWMgdXNlcm5hbWUgdOG7qyB0acOqdSDEkeG7gSBs4bubbiB0cm9uZyBhY3Rpb24gYmFyCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICB1c2VybmFtZV90aXRsZSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLCAKICAgICAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvYWN0aW9uX2Jhcl9sYXJnZV90aXRsZV9hdXRvX3NpemUiCiAgICAgICAgICAgICkKICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lX3RpdGxlOgogICAgICAgICAgICAgICAgdXNlcm5hbWVfdGl0bGUgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgcmVzb3VyY2VfaWQ9ImNvbS5pbnN0YWdyYW0uYW5kcm9pZDppZC9hY3Rpb25fYmFyX3RpdGxlIgogICAgICAgICAgICApCiAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZV90aXRsZToKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfZG93bigpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfZG93bigpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAgICAgdXNlcm5hbWVfdGl0bGUgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKAogICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsIAogICAgICAgICAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uaW5zdGFncmFtLmFuZHJvaWQ6aWQvYWN0aW9uX2Jhcl9sYXJnZV90aXRsZV9hdXRvX3NpemUiCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiB1c2VybmFtZV90aXRsZToKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dCh1c2VybmFtZV90aXRsZSkKICAgICAgICAgICAgICAgICMgUXVheSBs4bqhaSB0cmFuZyBjaOG7pwogICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbOG6pXkgdXNlcm5hbWUgdOG7qyB0cmFuZyBjw6EgbmjDom46IHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIHVzZXJuYW1lCgogICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSB0acOqdSDEkeG7gSwgdGjhu60gdMOsbSBiaeG7g3UgdMaw4bujbmcgdHJhbmcgY8OhIG5ow6JuIGtow6FjCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIktow7RuZyB0w6xtIHRo4bqleSB0acOqdSDEkeG7gSB1c2VybmFtZSwgdGjhu60gdMOsbSB0aGVvIGPDoWNoIGtow6FjIikKICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgbOG6pXkgdXNlcm5hbWUgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAiKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgZ2V0X2pvYl9wYXJhbXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRoYW0gc+G7kSDEkeG7gyBn4buNaSBBUEkgbOG6pXkgam9iIGNobyBJbnN0YWdyYW0KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGhhbSBz4buRCiAgICAgICAgIiIiCiAgICAgICAgZ29saWtlX2lkID0gYWNjb3VudC5nZXQoImdvbGlrZV9pZCIpCiAgICAgICAgaWYgbm90IGdvbGlrZV9pZDoKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJpbnN0YWdyYW1fYWNjb3VudF9pZCI6IGdvbGlrZV9pZCwKICAgICAgICAgICAgImRhdGEiOiAibnVsbCIKICAgICAgICB9').decode('utf-8'))
