import base64
exec(base64.b64decode('aW1wb3J0IHBhaG8ubXF0dC5jbGllbnQgYXMgbXF0dAppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBqc29uCmltcG9ydCB0aW1lCmltcG9ydCB1dWlkCmltcG9ydCBvcwpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbCwgQ2FsbGFibGUsIFVuaW9uCmltcG9ydCBjb25maWcKaW1wb3J0IHV0aWxzCmltcG9ydCBzb2NrZXQKaW1wb3J0IHJhbmRvbQppbXBvcnQgc3VicHJvY2VzcwoKIyBMb2dnZXIKbG9nZ2VyID0gdXRpbHMuZ2V0X2xvZ2dlcigiTVFUVFNlcnZpY2UiKQoKY2xhc3MgTVFUVFNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfc2VydmljZSwgZGV2aWNlX2lkLCBoZWxwZXJfc2VydmljZT1Ob25lLCBqb2Jfc2VydmljZT1Ob25lLCBtaW5pbmdfc2VydmljZT1Ob25lKToKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIHNlcnZpY2UKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyX3NlcnZpY2UgPSBoZWxwZXJfc2VydmljZQogICAgICAgIHNlbGYuam9iX3NlcnZpY2UgPSBqb2Jfc2VydmljZSAgIyBUaMOqbSByZWZlcmVuY2UgxJHhur9uIEpvYlNlcnZpY2UKICAgICAgICBzZWxmLm1pbmluZ19zZXJ2aWNlID0gbWluaW5nX3NlcnZpY2UgICMgVGjDqm0gcmVmZXJlbmNlIMSR4bq/biBNaW5pbmdTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgIyBD4bqldSBow6xuaCBNUVRUCiAgICAgICAgc2VsZi5jbGllbnRfaWQgPSBmIntjb25maWcuTVFUVF9DTElFTlRfSURfUFJFRklYfV97cmFuZG9tLnJhbmRpbnQoMSwgOTkpfV97ZGV2aWNlX2lkfSIKICAgICAgICBzZWxmLmJyb2tlcl91cmwgPSBjb25maWcuTVFUVF9TRVJWRVJTW2NvbmZpZy5NT0RFXQogICAgICAgIHNlbGYuYnJva2VyX2FkZHJlc3MgPSBzZWxmLmJyb2tlcl91cmwucmVwbGFjZSgibXF0dDovLyIsICIiKS5zcGxpdCgiOiIpWzBdCiAgICAgICAgc2VsZi5icm9rZXJfcG9ydCA9IGludChzZWxmLmJyb2tlcl91cmwuc3BsaXQoIjoiKVstMV0pIGlmICI6IiBpbiBzZWxmLmJyb2tlcl91cmwgZWxzZSAxODgzCiAgICAgICAgc2VsZi51c2VybmFtZSA9IGNvbmZpZy5NUVRUX1VTRVJOQU1FCiAgICAgICAgc2VsZi5wYXNzd29yZCA9IGNvbmZpZy5NUVRUX1BBU1NXT1JECiAgICAgICAgCiAgICAgICAgIyBUcuG6oW5nIHRow6FpIGvhur90IG7hu5FpCiAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgIHNlbGYuY2xpZW50ID0gTm9uZQogICAgICAgIHNlbGYuZGV2aWNlX2lkID0gZGV2aWNlX2lkCiAgICAgICAgCiAgICAgICAgIyBSZWNvbm5lY3Rpb24gbG9naWMKICAgICAgICBzZWxmLnJlY29ubmVjdF9kZWxheSA9IDEgICMgQuG6r3QgxJHhuqd1IHbhu5tpIDEgZ2nDonkKICAgICAgICBzZWxmLm1heF9yZWNvbm5lY3RfZGVsYXkgPSA2MCAgIyBU4buRaSDEkWEgNjAgZ2nDonkKICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCA9IDAKICAgICAgICBzZWxmLmxhc3RfZGlzY29ubmVjdF90aW1lID0gMAogICAgICAgIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3QgPSBGYWxzZSAgIyBGbGFnIMSR4buDIHBow6JuIGJp4buHdCBkaXNjb25uZWN0IGPDsyBjaOG7pyDDvSB2w6Aga2jDtG5nIGNo4bunIMO9CiAgICAgICAgCiAgICAgICAgIyBUb3BpY3MKICAgICAgICBzZWxmLnRvcGljX2NsaWVudF9zeW5jID0gY29uZmlnLk1RVFRfVE9QSUNfQ0xJRU5UX1NZTkMKICAgICAgICBzZWxmLnRvcGljX3NlcnZlcl90YXNrID0gZiJ7Y29uZmlnLk1RVFRfVE9QSUNfU0VSVkVSX1RBU0tfUFJFRklYfS97c2VsZi5kZXZpY2VfaWR9IgogICAgICAgIAogICAgICAgICMgUXXhuqNuIGzDvSB0YXNrIHbDoCBzeW5jCiAgICAgICAgc2VsZi50YXNrX2hhbmRsZXJzID0ge30KICAgICAgICBzZWxmLnN5bmNfdGhyZWFkID0gTm9uZQogICAgICAgIHNlbGYuc3luY19pbnRlcnZhbCA9IGNvbmZpZy5TWU5DX0lOVEVSVkFMCiAgICAgICAgc2VsZi5zeW5jX3J1bm5pbmcgPSBGYWxzZQogICAgCiAgICBkZWYgc2V0X2pvYl9zZXJ2aWNlKHNlbGYsIGpvYl9zZXJ2aWNlKToKICAgICAgICAiIiIKICAgICAgICDEkOG6t3QgSm9iU2VydmljZSDEkeG7gyB44butIGzDvSBjw6FjIHRow7RuZyBiw6FvIGNvbmZpZyB1cGRhdGUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2Jfc2VydmljZTogSW5zdGFuY2UgY+G7p2EgSm9iU2VydmljZQogICAgICAgICIiIgogICAgICAgIHNlbGYuam9iX3NlcnZpY2UgPSBqb2Jfc2VydmljZQogICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIMSR4bq3dCBKb2JTZXJ2aWNlIGNobyBNUVRUU2VydmljZSIpCiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBzZWxmLnN0b3BfZXZlbnQgPSB0aHJlYWRpbmcuRXZlbnQoKQogICAgICAgIHNlbGYuc3luY19pbnRlcnZhbCA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoInN5bmNfaW50ZXJ2YWwiLCBjb25maWcuU1lOQ19JTlRFUlZBTCkKICAgICAgICAKICAgICAgICAjIFRoZW8gZMO1aSBSQU0gxJHhu4MgdOG7sSDEkeG7mW5nIHJlYm9vdAogICAgICAgIHNlbGYucmFtX3VzYWdlX2hpc3RvcnkgPSBbXSAgIyBMxrB1IDMgbOG6p24gxJFvIFJBTSBn4bqnbiBuaOG6pXQKICAgICAgICBzZWxmLmhpZ2hfcmFtX3RocmVzaG9sZCA9IDg4ICAjIE5nxrDhu6FuZyBSQU0gY2FvICglKQogICAgICAgIHNlbGYuY29uc2VjdXRpdmVfaGlnaF9yYW1fbGltaXQgPSAzICAjIFPhu5EgbOG6p24gbGnDqm4gdGnhur9wIFJBTSBjYW8gdHLGsOG7m2Mga2hpIHJlYm9vdAogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBtw7RpIHRyxrDhu51uZyBUZXJtdXgKICAgICAgICBzZWxmLmlzX3Rlcm11eCA9ICdURVJNVVhfVkVSU0lPTicgaW4gb3MuZW52aXJvbiBvciAnL2RhdGEvZGF0YS9jb20udGVybXV4JyBpbiBvcy5lbnZpcm9uLmdldCgnUEFUSCcsICcnKQogICAgICAgIGlmIHNlbGYuaXNfdGVybXV4OgogICAgICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgY2jhuqF5IHRyb25nIG3DtGkgdHLGsOG7nW5nIFRlcm11eCIpCgogICAgZGVmIF9jcmVhdGVfY2xpZW50KHNlbGYpIC0+IG1xdHQuQ2xpZW50OgogICAgICAgICIiIlThuqFvIHbDoCBj4bqldSBow6xuaCBNUVRUIGNsaWVudCIiIgogICAgICAgIGNsaWVudCA9IE5vbmUKCiAgICAgICAgIyBUaOG7rSB04bqhbyB24bubaSBBUEkgdjIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNsaWVudCA9IG1xdHQuQ2xpZW50KAogICAgICAgICAgICAgICAgY2xpZW50X2lkPXNlbGYuY2xpZW50X2lkLAogICAgICAgICAgICAgICAgY2xlYW5fc2Vzc2lvbj1UcnVlLAogICAgICAgICAgICAgICAgcHJvdG9jb2w9bXF0dC5NUVRUdjMxMSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrX2FwaV92ZXJzaW9uPWdldGF0dHIobXF0dC5DYWxsYmFja0FQSVZlcnNpb24sICdWRVJTSU9OMicsIE5vbmUpCiAgICAgICAgICAgICkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlThuqFvIE1RVFQgY2xpZW50IHbhu5tpIEFQSSB2MiIpCiAgICAgICAgZXhjZXB0IChBdHRyaWJ1dGVFcnJvciwgVHlwZUVycm9yKToKICAgICAgICAgICAgIyBGYWxsYmFjayBBUEkgdjEKICAgICAgICAgICAgY2xpZW50ID0gbXF0dC5DbGllbnQoCiAgICAgICAgICAgICAgICBjbGllbnRfaWQ9c2VsZi5jbGllbnRfaWQsCiAgICAgICAgICAgICAgICBjbGVhbl9zZXNzaW9uPVRydWUsCiAgICAgICAgICAgICAgICBwcm90b2NvbD1tcXR0Lk1RVFR2MzExCiAgICAgICAgICAgICkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlThuqFvIE1RVFQgY2xpZW50IHbhu5tpIEFQSSB2MSIpCiAgICAgICAgCiAgICAgICAgIyBD4bqldSBow6xuaCB4w6FjIHRo4buxYyBu4bq/dSBjw7MKICAgICAgICBpZiBzZWxmLnVzZXJuYW1lIGFuZCBzZWxmLnBhc3N3b3JkOgogICAgICAgICAgICBjbGllbnQudXNlcm5hbWVfcHdfc2V0KHNlbGYudXNlcm5hbWUsIHNlbGYucGFzc3dvcmQpCiAgICAgICAgCiAgICAgICAgIyDEkMSDbmcga8O9IGNhbGxiYWNrCiAgICAgICAgY2xpZW50Lm9uX2Nvbm5lY3QgPSBzZWxmLl9vbl9jb25uZWN0CiAgICAgICAgY2xpZW50Lm9uX21lc3NhZ2UgPSBzZWxmLl9vbl9tZXNzYWdlCiAgICAgICAgY2xpZW50Lm9uX2Rpc2Nvbm5lY3QgPSBzZWxmLl9vbl9kaXNjb25uZWN0CiAgICAgICAgCiAgICAgICAgIyBD4bqldSBow6xuaCBrZWVwLWFsaXZlIGTDoGkgaMahbiB2w6AgcmVjb25uZWN0aW9uCiAgICAgICAgY2xpZW50LnJlY29ubmVjdF9kZWxheV9zZXQobWluX2RlbGF5PTEsIG1heF9kZWxheT02MCkKICAgICAgICAKICAgICAgICByZXR1cm4gY2xpZW50CgogICAgZGVmIGNvbm5lY3Qoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiJL4bq/dCBu4buRaSDEkeG6v24gTVFUVCBicm9rZXIgduG7m2kgZXhwb25lbnRpYWwgYmFja29mZiIiIgogICAgICAgIGRlZiBjYW5fY29ubmVjdChob3N0OiBzdHIsIHBvcnQ6IGludCwgdGltZW91dDogZmxvYXQgPSAzLjApIC0+IGJvb2w6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggc29ja2V0LmNyZWF0ZV9jb25uZWN0aW9uKChob3N0LCBwb3J0KSwgdGltZW91dD10aW1lb3V0KToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIG1haW5faG9zdCA9IHNlbGYuYnJva2VyX2FkZHJlc3MKICAgICAgICBtYWluX3BvcnQgPSBzZWxmLmJyb2tlcl9wb3J0CiAgICAgICAgZmFsbGJhY2tfaG9zdCA9ICIxMC4wLjAuNiIKICAgICAgICBmYWxsYmFja19wb3J0ID0gOTAyMAoKICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgbuG7kWkgc29ja2V0IHThu5tpIGPhuqMgMiBJUAogICAgICAgIG1haW5fb2sgPSBjYW5fY29ubmVjdChtYWluX2hvc3QsIG1haW5fcG9ydCkKICAgICAgICBmYWxsYmFja19vayA9IGNhbl9jb25uZWN0KGZhbGxiYWNrX2hvc3QsIGZhbGxiYWNrX3BvcnQpCiAgICAgICAgaWYgbWFpbl9vazoKICAgICAgICAgICAgY29ubmVjdF9ob3N0ID0gbWFpbl9ob3N0CiAgICAgICAgICAgIGNvbm5lY3RfcG9ydCA9IG1haW5fcG9ydAogICAgICAgIGVsaWYgZmFsbGJhY2tfb2s6CiAgICAgICAgICAgIGNvbm5lY3RfaG9zdCA9IGZhbGxiYWNrX2hvc3QKICAgICAgICAgICAgY29ubmVjdF9wb3J0ID0gZmFsbGJhY2tfcG9ydAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyBr4bq/dCBu4buRaSDEkcaw4bujYyBzb2NrZXQgdOG7m2kgY+G6oyB7bWFpbl9ob3N0fTp7bWFpbl9wb3J0fSBs4bqrbiB7ZmFsbGJhY2tfaG9zdH06e2ZhbGxiYWNrX3BvcnR9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBU4bqhbyBjbGllbnQgbeG7m2kgbuG6v3UgY2jGsGEgY8OzIGhv4bq3YyBjbGllbnQgY8WpIGLhu4sgbOG7l2kKICAgICAgICAgICAgaWYgc2VsZi5jbGllbnQgaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50ID0gc2VsZi5fY3JlYXRlX2NsaWVudCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHRy4bqhbmcgdGjDoWkKICAgICAgICAgICAgc2VsZi5zdG9wX2V2ZW50LmNsZWFyKCkKICAgICAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgICAgICBzZWxmLm1hbnVhbF9kaXNjb25uZWN0ID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcga+G6v3QgbuG7kWkgdOG7m2kgTVFUVCBicm9rZXIge2Nvbm5lY3RfaG9zdH06e2Nvbm5lY3RfcG9ydH0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBrZWVwYWxpdmUgbOG7m24gaMahbiAoMTIwIGdpw6J5IHRoYXkgdsOsIDYwKSDEkeG7gyBwaMOhdCBoaeG7h24gbeG6pXQga+G6v3QgbuG7kWkKICAgICAgICAgICAgIyBLaGkgbeG6pXQgbeG6oW5nIHLhu5NpIGPDsyBs4bqhaSwgY2xpZW50IHPhur0gdOG7sSDEkeG7mW5nIHJlY29ubmVjdCBxdWEgX29uX2Rpc2Nvbm5lY3QgY2FsbGJhY2sKICAgICAgICAgICAgc2VsZi5jbGllbnQuY29ubmVjdF9hc3luYyhjb25uZWN0X2hvc3QsIGNvbm5lY3RfcG9ydCwga2VlcGFsaXZlPTEyMCkKICAgICAgICAgICAgc2VsZi5jbGllbnQubG9vcF9zdGFydCgpCgogICAgICAgICAgICBkZWYgX3dhaXRfY29ubmVjdGVkKHRpbWVvdXRfc2VjOiBpbnQgPSAxNSkgLT4gYm9vbDoKICAgICAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKHRpbWVvdXRfc2VjKToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgIGlmIF93YWl0X2Nvbm5lY3RlZCgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZyDEkeG6v24gTVFUVCBicm9rZXIge2Nvbm5lY3RfaG9zdH06e2Nvbm5lY3RfcG9ydH0iKQogICAgICAgICAgICAgICAgc2VsZi5icm9rZXJfYWRkcmVzcyA9IGNvbm5lY3RfaG9zdAogICAgICAgICAgICAgICAgc2VsZi5icm9rZXJfcG9ydCA9IGNvbm5lY3RfcG9ydAogICAgICAgICAgICAgICAgIyBSZXNldCByZWNvbm5lY3QgZGVsYXkga2hpIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfZGVsYXkgPSAxCiAgICAgICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCA9IDAKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJL4bq/dCBu4buRaSBNUVRUIHRo4bqldCBi4bqhaSB04bubaSB7Y29ubmVjdF9ob3N0fTp7Y29ubmVjdF9wb3J0fSIpCiAgICAgICAgICAgICAgICBzZWxmLl9jbGVhbnVwX2NsaWVudCgpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBr4bq/dCBu4buRaSBNUVRUOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHNlbGYuX2NsZWFudXBfY2xpZW50KCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9jbGVhbnVwX2NsaWVudChzZWxmKToKICAgICAgICAiIiJE4buNbiBk4bq5cCBNUVRUIGNsaWVudCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5jbGllbnQ6CiAgICAgICAgICAgICAgICBzZWxmLmNsaWVudC5sb29wX3N0b3AoKQogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQuZGlzY29ubmVjdCgpCiAgICAgICAgICAgICAgICBzZWxmLmNsaWVudCA9IE5vbmUKICAgICAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgZOG7jW4gZOG6uXAgTVFUVCBjbGllbnQ6IHtlfSIpCgogICAgZGVmIGVuc3VyZV9jb25uZWN0ZWQoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiLEkOG6o20gYuG6o28ga+G6v3QgbuG7kWkgTVFUVCB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbiBjw6FjIHRoYW8gdMOhYyB24bubaSByYXRlIGxpbWl0aW5nIiIiCiAgICAgICAgaWYgc2VsZi5pc19jb25uZWN0ZWQ6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIMSRYW5nIHRyb25nIHF1w6EgdHLDrG5oIHJlY29ubmVjdCBraMO0bmcKICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGlmIGN1cnJlbnRfdGltZSAtIHNlbGYubGFzdF9kaXNjb25uZWN0X3RpbWUgPCA1OiAgIyBDaOG7nSDDrXQgbmjhuqV0IDUgZ2nDonkgdOG7qyBs4bqnbiBkaXNjb25uZWN0IGN14buRaQogICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQYW5nIHRyb25nIHRo4budaSBnaWFuIGNvb2xkb3duIHJlY29ubmVjdCwgY2jhu50uLi4iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk1RVFQgY2jGsGEga+G6v3QgbuG7kWksIMSRYW5nIHRo4butIGvhur90IG7hu5FpIGzhuqFpLi4uIikKICAgICAgICByZXR1cm4gc2VsZi5jb25uZWN0KCkKCiAgICBkZWYgX29uX2Nvbm5lY3Qoc2VsZiwgY2xpZW50LCB1c2VyZGF0YSwgZmxhZ3MsIHJjLCBwcm9wZXJ0aWVzPU5vbmUpOgogICAgICAgICIiIkNhbGxiYWNrIGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmciIiIKICAgICAgICBpZiByYyA9PSAwOgogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IFRydWUKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nIHThu5tpIE1RVFQgYnJva2VyIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDEg25nIGvDvSBuaOG6rW4gdGFzawogICAgICAgICAgICBzZWxmLmNsaWVudC5zdWJzY3JpYmUoc2VsZi50b3BpY19zZXJ2ZXJfdGFzaywgcW9zPTEpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkcSDbmcga8O9IG5o4bqtbiB0YXNrIHThuqFpOiB7c2VsZi50b3BpY19zZXJ2ZXJfdGFza30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4butaSB0aMO0bmcgYsOhbyBr4bq/dCBu4buRaQogICAgICAgICAgICBzZWxmLnNlbmRfY29ubmVjdF9ub3RpZmljYXRpb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCByZWNvbm5lY3QgY291bnRlciBraGkga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ID0gMAogICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9kZWxheSA9IDEKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJL4bq/dCBu4buRaSBNUVRUIHRo4bqldCBi4bqhaSB24bubaSBtw6MgbOG7l2k6IHtyY30iKQogICAgICAgICAgICAjIFTEg25nIHJlY29ubmVjdCBjb3VudCBraGkga+G6v3QgbuG7kWkgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ICs9IDEKCiAgICBkZWYgX29uX2Rpc2Nvbm5lY3Qoc2VsZiwgY2xpZW50LCB1c2VyZGF0YSwgcmMsIHByb3BlcnRpZXM9Tm9uZSwgcmVhc29uX2NvZGU9Tm9uZSwgKiprd2FyZ3MpOgogICAgICAgICIiIkNhbGxiYWNrIGtoaSBuZ+G6r3Qga+G6v3QgbuG7kWkgduG7m2kgY8ahIGNo4bq/IHJlY29ubmVjdCB0aMO0bmcgbWluaCIiIgogICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gRmFsc2UKICAgICAgICBzZWxmLmxhc3RfZGlzY29ubmVjdF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICBpZiBzZWxmLm1hbnVhbF9kaXNjb25uZWN0OgogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBuZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCB0aGVvIHnDqnUgY+G6p3UiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgaWYgcmMgIT0gMDoKICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfY291bnQgKz0gMQogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIk5n4bqvdCBr4bq/dCBu4buRaSBNUVRUIGtow7RuZyBtb25nIG114buRbiBs4bqnbiB7c2VsZi5yZWNvbm5lY3RfY291bnR9IHbhu5tpIG3DoyBs4buXaToge3JjfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4buJIGF1dG8tcmVjb25uZWN0IG7hur91IGtow7RuZyBwaOG6o2kgbWFudWFsIGRpc2Nvbm5lY3QKICAgICAgICAgICAgaWYgbm90IHNlbGYuc3RvcF9ldmVudC5pc19zZXQoKToKICAgICAgICAgICAgICAgIHNlbGYuX3NjaGVkdWxlX3JlY29ubmVjdCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mgbmfhuq90IGvhur90IG7hu5FpIE1RVFQiKQoKICAgIGRlZiBfc2NoZWR1bGVfcmVjb25uZWN0KHNlbGYpOgogICAgICAgICIiIkzDqm4gbOG7i2NoIGvhur90IG7hu5FpIGzhuqFpIG3hu5dpIDMwIGdpw6J5LCBs4bq3cCB2w7QgaOG6oW4gxJHhur9uIGtoaSBk4burbmcgYXBwIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIlPhur0gdGjhu60ga+G6v3QgbuG7kWkgbOG6oWkgc2F1IDMwIGdpw6J5Li4uIikKICAgICAgICAKICAgICAgICBkZWYgcmVjb25uZWN0X2xvb3AoKToKICAgICAgICAgICAgd2hpbGUgbm90IHNlbGYuc3RvcF9ldmVudC5pc19zZXQoKSBhbmQgbm90IHNlbGYubWFudWFsX2Rpc2Nvbm5lY3Q6CiAgICAgICAgICAgICAgICAjIENo4budIDMwIGdpw6J5LCBjw7MgdGjhu4MgYuG7iyBuZ+G6r3QgYuG7n2kgc3RvcF9ldmVudAogICAgICAgICAgICAgICAgaWYgc2VsZi5zdG9wX2V2ZW50LndhaXQoMzApOgogICAgICAgICAgICAgICAgICAgIGJyZWFrICAjIELhu4sgZOG7q25nLCB0aG/DoXQgbG9vcAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHRy4bqhbmcgdGjDoWkgdHLGsOG7m2Mga2hpIHRo4butIGvhur90IG7hu5FpCiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZCBvciBzZWxmLm1hbnVhbF9kaXNjb25uZWN0OgogICAgICAgICAgICAgICAgICAgIGJyZWFrICAjIMSQw6Mga+G6v3QgbuG7kWkgaG/hurdjIGLhu4sgZOG7q25nIHRo4bunIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4butIGvhur90IG7hu5FpIGzhuqFpIE1RVFQgKGzhuqduIHtzZWxmLnJlY29ubmVjdF9jb3VudH0pIikKICAgICAgICAgICAgICAgIGlmIHNlbGYuY29ubmVjdCgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJL4bq/dCBu4buRaSBs4bqhaSBNUVRUIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsgICMgS+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nLCB0aG/DoXQgbG9vcAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJL4bq/dCBu4buRaSBs4bqhaSBNUVRUIHRo4bqldCBi4bqhaSBs4bqnbiB7c2VsZi5yZWNvbm5lY3RfY291bnR9LCB0aOG7rSBs4bqhaSBzYXUgMzAgZ2nDonkuLi4iKQogICAgICAgIAogICAgICAgICMgQ2jhuqF5IHRyb25nIHRocmVhZCByacOqbmcgxJHhu4Mga2jDtG5nIGJsb2NrCiAgICAgICAgdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9cmVjb25uZWN0X2xvb3AsIGRhZW1vbj1UcnVlKS5zdGFydCgpCgogICAgZGVmIF9zYWZlX3B1Ymxpc2goc2VsZiwgdG9waWM6IHN0ciwgcGF5bG9hZDogc3RyLCBxb3M6IGludCA9IDEpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgR+G7rWkgbWVzc2FnZSBhbiB0b8OgbiB24bubaSBraeG7g20gdHJhIGvhur90IG7hu5FpIHRyxrDhu5tjIGtoaSBwdWJsaXNoCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdG9waWM6IE1RVFQgdG9waWMKICAgICAgICAgICAgcGF5bG9hZDogTuG7mWkgZHVuZyBtZXNzYWdlIChzdHJpbmcpCiAgICAgICAgICAgIHFvczogUXVhbGl0eSBvZiBTZXJ2aWNlICgwLCAxLCBob+G6t2MgMikKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBn4butaSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2Nvbm5lY3RlZCgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IE1RVFQgY2jGsGEga+G6v3QgbuG7kWkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmNsaWVudC5wdWJsaXNoKHRvcGljLCBwYXlsb2FkLCBxb3M9cW9zKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0LnJjID09IG1xdHQuTVFUVF9FUlJfU1VDQ0VTUzoKICAgICAgICAgICAgICAgICNsb2dnZXIuaW5mbyhmIsSQw6MgZ+G7rWkgbWVzc2FnZSB0aMOgbmggY8O0bmcgxJHhur9uIHt0b3BpY30iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBn4butaSBtZXNzYWdlIMSR4bq/biB7dG9waWN9OiB7bXF0dC5lcnJvcl9zdHJpbmcocmVzdWx0LnJjKX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbmRfdGFza19yZXBvcnQoc2VsZiwgdGFza19pZDogc3RyLCBkZXZpY2VfaWQ6IHN0ciwgc3RhdHVzOiBzdHIsIGNsaWVudF9tZXNzYWdlOiBzdHIgPSAiIik6CiAgICAgICAgIiIiR+G7rWkgYsOhbyBjw6FvIGvhur90IHF14bqjIHRo4buxYyBoaeG7h24gdGFzayIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVwb3J0X2RhdGEgPSB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6IHRhc2tfaWQsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cywKICAgICAgICAgICAgICAgICJjbGllbnRfbWVzc2FnZSI6IGNsaWVudF9tZXNzYWdlLAogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgc2VsZi5fc2FmZV9wdWJsaXNoKCJkbmR2aW5hL2NsaWVudC90YXNrX3JlcG9ydCIsIGpzb24uZHVtcHMocmVwb3J0X2RhdGEpKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBn4butaSBiw6FvIGPDoW8gdGFzayB7dGFza19pZH0gduG7m2kgdHLhuqFuZyB0aMOhaSB7c3RhdHVzfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgYsOhbyBjw6FvIHRhc2s6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbmRfY29ubmVjdF9ub3RpZmljYXRpb24oc2VsZik6CiAgICAgICAgIiIiR+G7rWkgdGjDtG5nIGLDoW8ga+G6v3QgbuG7kWkgxJHhur9uIHNlcnZlciIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY29ubmVjdF9kYXRhID0gewogICAgICAgICAgICAgICAgImRldmljZV9pZCI6IHNlbGYuZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgc2VsZi5fc2FmZV9wdWJsaXNoKCJkbmR2aW5hL2NsaWVudC9jb25uZWN0IiwganNvbi5kdW1wcyhjb25uZWN0X2RhdGEpKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBn4butaSB0aMO0bmcgYsOhbyBr4bq/dCBu4buRaSBjaG8gdGhp4bq/dCBi4buLIHtzZWxmLmRldmljZV9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiByZWdpc3Rlcl90YXNrX2hhbmRsZXIoc2VsZiwgdGFza190eXBlOiBzdHIsIGhhbmRsZXI6IENhbGxhYmxlKToKICAgICAgICAiIiIKICAgICAgICDEkMSDbmcga8O9IGhhbmRsZXIgY2hvIGxv4bqhaSB0YXNrCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza190eXBlOiBMb+G6oWkgdGFzawogICAgICAgICAgICBoYW5kbGVyOiBIw6BtIHjhu60gbMO9IHRhc2sKICAgICAgICAiIiIKICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnNbdGFza190eXBlXSA9IGhhbmRsZXIKICAgIAogICAgZGVmIF9yZWFkX3JlY2VudF9sb2dzKHNlbGYsIG51bV9saW5lcz0yMDApOgogICAgICAgICIiIgogICAgICAgIMSQ4buNYyBjw6FjIGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQgdOG7qyBmaWxlIGFwcC5sb2cKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBudW1fbGluZXM6IFPhu5EgZMOybmcgbG9nIGPhuqduIMSR4buNYyAobeG6t2MgxJHhu4tuaCAxMDApCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3Rbc3RyXTogRGFuaCBzw6FjaCBjw6FjIGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQgaG/hurdjIHRow7RuZyBiw6FvIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dfZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKGNvbmZpZy5CQVNFX0RJUiwgImFwcC5sb2ciKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGxvZ19maWxlX3BhdGgpOgogICAgICAgICAgICAgICAgIyBGaWxlIGNoxrBhIMSRxrDhu6NjIHThuqFvIGLhu59pIGxvZ2dpbmcgc3lzdGVtCiAgICAgICAgICAgICAgICByZXR1cm4gW2YiW0lORk9dIEZpbGUgbG9nIGNoxrBhIMSRxrDhu6NjIHThuqFvLCBjaMawYSBjw7MgbG9nIG7DoG8iXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu60gxJHhu41jIGZpbGUgduG7m2kgcmV0cnkgxJHhu4MgdHLDoW5oIHh1bmcgxJHhu5l0CiAgICAgICAgICAgIG1heF9yZXRyaWVzID0gMwogICAgICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfcmV0cmllcyk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGxvZ19maWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdpZ25vcmUnKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBudW1fbGluZXMgZMOybmcgY3Xhu5FpIGPDuW5nCiAgICAgICAgICAgICAgICAgICAgcmVjZW50X2xpbmVzID0gbGluZXNbLW51bV9saW5lczpdIGlmIGxlbihsaW5lcykgPiBudW1fbGluZXMgZWxzZSBsaW5lcwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTG/huqFpIGLhu48ga8O9IHThu7EgeHXhu5FuZyBkw7JuZyB2w6AgY8OhYyBraG/huqNuZyB0cuG6r25nIHRo4burYQogICAgICAgICAgICAgICAgICAgIHJlY2VudF9sb2dzID0gW2xpbmUuc3RyaXAoKSBmb3IgbGluZSBpbiByZWNlbnRfbGluZXMgaWYgbGluZS5zdHJpcCgpXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiByZWNlbnRfbG9ncwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZXhjZXB0IChQZXJtaXNzaW9uRXJyb3IsIElPRXJyb3IsIE9TRXJyb3IpIGFzIGZpbGVfZXJyb3I6CiAgICAgICAgICAgICAgICAgICAgaWYgYXR0ZW1wdCA8IG1heF9yZXRyaWVzIC0gMToKICAgICAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgwLjEpICAjIENo4budIDEwMG1zIHLhu5NpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtmIltFUlJPUl0gS2jDtG5nIHRo4buDIMSR4buNYyBmaWxlIGxvZzoge3N0cihmaWxlX2Vycm9yKX0iXQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHJldHVybiBbZiJbRVJST1JdIEzhu5dpIMSR4buNYyBmaWxlIGxvZzoge3N0cihlKX0iXQoKICAgIGRlZiBzeW5jX2RhdGEoc2VsZik6CiAgICAgICAgIiIixJDhu5NuZyBi4buZIGThu68gbGnhu4d1IHbhu5tpIHNlcnZlciIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBO4bq/dSBjaMawYSBr4bq/dCBu4buRaSBNUVRULCBraMO0bmcgdGjhu4MgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJDaMawYSBr4bq/dCBu4buRaSBNUVRULCBraMO0bmcgdGjhu4MgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgaGVscGVyIHNlcnZpY2UKICAgICAgICAgICAgaGVscGVyID0gc2VsZi5oZWxwZXJfc2VydmljZQogICAgICAgICAgICBpZiBub3QgaGVscGVyOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgY8OzIGhlbHBlciBzZXJ2aWNlLCBraMO0bmcgdGjhu4MgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGV2aWNlX2lkCiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZGIuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgeMOhYyDEkeG7i25oIGRldmljZV9pZCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIGRldmljZV9pbmZvID0gTm9uZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZXZpY2VfaW5mb19yZXNwb25zZSA9IGhlbHBlci5nZXRfZGV2aWNlX2luZm8oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGzhuqV5IHRow6BuaCBjw7RuZywgbMawdSB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgICAgICBpZiBkZXZpY2VfaW5mb19yZXNwb25zZVsic3RhdHVzIl0gPT0gInN1Y2Nlc3MiIGFuZCAiZGF0YSIgaW4gZGV2aWNlX2luZm9fcmVzcG9uc2U6CiAgICAgICAgICAgICAgICAgICAgIyBMxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNhdmVfZGV2aWNlX2luZm8oZGV2aWNlX2luZm9fcmVzcG9uc2VbImRhdGEiXSkKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfaW5mbyA9IGRldmljZV9pbmZvX3Jlc3BvbnNlWyJkYXRhIl0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRoZW8gZMO1aSBSQU0gxJHhu4MgdOG7sSDEkeG7mW5nIHJlYm9vdAogICAgICAgICAgICAgICAgICAgIHNlbGYuX21vbml0b3JfcmFtX3VzYWdlKGRldmljZV9pbmZvKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgbOG6pXkgdGjDtG5nIHRpbiB0aGnhur90IGLhu4s6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2MgdGjDtG5nIHRpbiB0aGnhur90IGLhu4ssIHPhu60gZOG7pW5nIHRow7RuZyB0aW4gxJHDoyBsxrB1IHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIG5vdCBkZXZpY2VfaW5mbzoKICAgICAgICAgICAgICAgIGRldmljZV9pbmZvID0gc2VsZi5kYi5nZXRfZGV2aWNlX2luZm8oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBkZXZpY2VfaW5mbzoKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIHRow7RuZyB0aW4gdGhp4bq/dCBi4buLLCDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UgY8OzIHRo4buDIGtow7RuZyDEkeG6p3kgxJHhu6ciKQogICAgICAgICAgICAgICAgZGV2aWNlX2luZm8gPSB7fQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgICAgIGRldmljZV9jb25maWcgPSBzZWxmLmRiLmdldF9hbGxfZGV2aWNlX2NvbmZpZygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu5lwIGPDoWMgdHLhuqFuZyB0aMOhaSBydW50aW1lIChwYXVzZV9qb2IsIGRldmljZV9pc193b3JraW5nLCBkZXZpY2VfbWVzc2FnZSkgdsOgbyBkZXZpY2VfaW5mbwogICAgICAgICAgICBmb3IgcnVudGltZV9rZXkgaW4gWyJwYXVzZV9qb2IiLCAiZGV2aWNlX2lzX3dvcmtpbmciLCAiZGV2aWNlX21lc3NhZ2UiXToKICAgICAgICAgICAgICAgIGlmIHJ1bnRpbWVfa2V5IGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2luZm9bcnVudGltZV9rZXldID0gZGV2aWNlX2NvbmZpZy5wb3AocnVudGltZV9rZXkpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgR2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIG7hur91IGNoxrBhIGPhuqV1IGjDrG5oCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2luZm9bcnVudGltZV9rZXldID0gRmFsc2UgaWYgcnVudGltZV9rZXkgIT0gImRldmljZV9tZXNzYWdlIiBlbHNlICIiCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExv4bqhaSBi4buPIGdvbGlrZV9yZXBvcnQga2jhu49pIGRldmljZV9jb25maWcgxJHhu4MgZ+G7rWkgcmnDqm5nCiAgICAgICAgICAgIGdvbGlrZV9yZXBvcnQgPSBOb25lCiAgICAgICAgICAgIGlmICJnb2xpa2VfcmVwb3J0IiBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgZ29saWtlX3JlcG9ydCA9IGRldmljZV9jb25maWcucG9wKCJnb2xpa2VfcmVwb3J0IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG/huqFpIGLhu48gZ29saWtlX2FwaV9iYXNlIGto4buPaSBkZXZpY2VfY29uZmlnCiAgICAgICAgICAgIGlmICJnb2xpa2VfYXBpX2Jhc2UiIGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBkZXZpY2VfY29uZmlnLnBvcCgiZ29saWtlX2FwaV9iYXNlIikKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygixJDDoyBsb+G6oWkgYuG7jyBnb2xpa2VfYXBpX2Jhc2Uga2jhu49pIGThu68gbGnhu4d1IMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IG1pbmluZ19pbmZvIHThu6sgbWluaW5nX3NlcnZpY2UgKG7hur91IGPDsykKICAgICAgICAgICAgbWluaW5nX2luZm8gPSBOb25lCiAgICAgICAgICAgIGlmIHNlbGYubWluaW5nX3NlcnZpY2U6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbWluaW5nX3N1bW1hcnkgPSBzZWxmLm1pbmluZ19zZXJ2aWNlLmdldF9taW5pbmdfc3VtbWFyeSgpCiAgICAgICAgICAgICAgICAgICAgaWYgbWluaW5nX3N1bW1hcnkuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICAgICAgICAgIG1pbmluZ19pbmZvID0gbWluaW5nX3N1bW1hcnkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiTOG6pXkgbWluaW5nIGluZm86IHttaW5pbmdfaW5mby5nZXQoJ3J1bm5pbmdfbWluZXJzJywgMCl9L3ttaW5pbmdfaW5mby5nZXQoJ3RvdGFsX21pbmVycycsIDApfSBtaW5lcnMiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGzhuqV5IG1pbmluZyBpbmZvOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgY8OhYyB0w6BpIGtob+G6o24gY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHBlbmRpbmdfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9wZW5kaW5nX3N5bmNfaXRlbXMoImFjY291bnRzIiwgbGltaXQ9NTApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGPDoWMgam9iIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICBwZW5kaW5nX2pvYnMgPSBzZWxmLmRiLmdldF9wZW5kaW5nX3N5bmNfaXRlbXMoImpvYnNfaGlzdG9yeSIsIGxpbWl0PTUwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG7jWMgMjAwIGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQKICAgICAgICAgICAgcmVjZW50X2xvZ3MgPSBzZWxmLl9yZWFkX3JlY2VudF9sb2dzKDIwMCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHBheWxvYWQKICAgICAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2luZm8iOiBkZXZpY2VfaW5mbywKICAgICAgICAgICAgICAgICJkZXZpY2VfY29uZmlnIjogZGV2aWNlX2NvbmZpZywKICAgICAgICAgICAgICAgICJtZXRhX2RhdGEiOiB7CiAgICAgICAgICAgICAgICAgICAgImRldmljZV9sb2dzIjogcmVjZW50X2xvZ3MKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGdvbGlrZV9yZXBvcnQgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIGdvbGlrZV9yZXBvcnQ6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJnb2xpa2VfcmVwb3J0Il0gPSBnb2xpa2VfcmVwb3J0CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIG1pbmluZ19pbmZvIG7hur91IGPDswogICAgICAgICAgICBpZiBtaW5pbmdfaW5mbzoKICAgICAgICAgICAgICAgIHBheWxvYWRbIm1pbmluZ19pbmZvIl0gPSBtaW5pbmdfaW5mbwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gdMOgaSBraG/huqNuIGNoxrBhIMSR4buTbmcgYuG7mSBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgcGVuZGluZ19hY2NvdW50czoKICAgICAgICAgICAgICAgIHBheWxvYWRbImFjY291bnRzIl0gPSBwZW5kaW5nX2FjY291bnRzCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkOG7k25nIGLhu5kge2xlbihwZW5kaW5nX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGNoxrBhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBqb2IgY2jGsGEgxJHhu5NuZyBi4buZIG7hur91IGPDswogICAgICAgICAgICBpZiBwZW5kaW5nX2pvYnM6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJqb2JzIl0gPSBwZW5kaW5nX2pvYnMKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQ4buTbmcgYuG7mSB7bGVuKHBlbmRpbmdfam9icyl9IGpvYiBjaMawYSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7rWkgZOG7ryBsaeG7h3UKICAgICAgICAgICAgc2VsZi5fc2FmZV9wdWJsaXNoKGNvbmZpZy5NUVRUX1RPUElDX0NMSUVOVF9TWU5DLCBqc29uLmR1bXBzKHBheWxvYWQpKQogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IHbhu5tpIHNlcnZlciIpCiAgICAKICAgIGRlZiBzdGFydF9zeW5jX3RocmVhZChzZWxmKToKICAgICAgICAiIiJC4bqvdCDEkeG6p3UgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciIiIKICAgICAgICBpZiBzZWxmLnN5bmNfdGhyZWFkIGlzIG5vdCBOb25lIGFuZCBzZWxmLnN5bmNfdGhyZWFkLmlzX2FsaXZlKCk6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJUaHJlYWQgxJHhu5NuZyBi4buZIMSRw6MgxJFhbmcgY2jhuqF5IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLnN0b3BfZXZlbnQuY2xlYXIoKQogICAgICAgIHNlbGYuc3luY190aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLl9zeW5jX2xvb3AsIGRhZW1vbj1UcnVlKQogICAgICAgIHNlbGYuc3luY190aHJlYWQuc3RhcnQoKQogICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGto4bufaSDEkeG7mW5nIHRocmVhZCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIikKICAgIAogICAgZGVmIF9zeW5jX2xvb3Aoc2VsZik6CiAgICAgICAgIiIiTG9vcCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyBt4buXaSB7c2VsZi5zeW5jX2ludGVydmFsfSBnacOieSIpCgogICAgICAgIHdoaWxlIG5vdCBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCkgYW5kIHNlbGYucnVubmluZzoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgc2VsZi5pc19jb25uZWN0ZWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX2RhdGEoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBxdcOhIHRyw6xuaCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nOiB7c3RyKGUpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBOZ2jhu4kgxJHhur9uIGzhuqduIMSR4buTbmcgYuG7mSB0aeG6v3AgdGhlbwogICAgICAgICAgICBmb3IgXyBpbiByYW5nZShzZWxmLnN5bmNfaW50ZXJ2YWwpOgogICAgICAgICAgICAgICAgaWYgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgIAogICAgZGVmIHN0b3Bfc3luY190aHJlYWQoc2VsZik6CiAgICAgICAgIiIiROG7q25nIHRocmVhZCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIiIiCiAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBzZWxmLnN0b3BfZXZlbnQuc2V0KCkKICAgICAgICBpZiBzZWxmLnN5bmNfdGhyZWFkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLnN5bmNfdGhyZWFkLmpvaW4odGltZW91dD0yLjApCiAgICAgICAgICAgIHNlbGYuc3luY190aHJlYWQgPSBOb25lCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgZOG7q25nIHRocmVhZCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIikKICAgIAogICAgZGVmIGRpc2Nvbm5lY3Qoc2VsZik6CiAgICAgICAgIiIiTmfhuq90IGvhur90IG7hu5FpIE1RVFQiIiIKICAgICAgICBzZWxmLm1hbnVhbF9kaXNjb25uZWN0ID0gVHJ1ZSAgIyDEkMOhbmggZOG6pXUgxJHDonkgbMOgIGRpc2Nvbm5lY3QgY8OzIGNo4bunIMO9CiAgICAgICAgc2VsZi5zdG9wX3N5bmNfdGhyZWFkKCkKICAgICAgICAKICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5jbGllbnQubG9vcF9zdG9wKCkKICAgICAgICAgICAgc2VsZi5jbGllbnQuZGlzY29ubmVjdCgpCiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gRmFsc2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mgbmfhuq90IGvhur90IG7hu5FpIE1RVFQiKQogICAgICAgIAogICAgICAgICMgROG7q25nIHThuqV0IGPhuqMgYXV0by1yZWNvbm5lY3QKICAgICAgICBzZWxmLnN0b3BfZXZlbnQuc2V0KCkKICAgIAogICAgZGVmIHNldHVwX21xdHRfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiVGhp4bq/dCBs4bqtcCBjw6FjIGhhbmRsZXIgY2hvIE1RVFQgdGFza3MiIiIKICAgICAgICAjIMSQxINuZyBrw70gY8OhYyB0YXNrIGhhbmRsZXIgbeG6t2MgxJHhu4tuaAogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfY29uZmlnIiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9kZXZpY2VfY29uZmlnKQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfc3luY2VkIiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9zeW5jZWQpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoImFjY291bnRfdXBkYXRlIiwgc2VsZi5faGFuZGxlX2FjY291bnRfdXBkYXRlKQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfcHJveHkiLCBzZWxmLl9oYW5kbGVfdXBkYXRlX3Byb3h5KQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfbWluaW5nX2NvbmZpZyIsIHNlbGYuX2hhbmRsZV9taW5pbmdfY29uZmlnX3VwZGF0ZSkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygixJDDoyB0aGnhur90IGzhuq1wIGPDoWMgTVFUVCB0YXNrIGhhbmRsZXIiKQogICAgCiAgICBkZWYgX2hhbmRsZV9taW5pbmdfY29uZmlnX3VwZGF0ZShzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgdXBkYXRlIG1pbmluZyBjb25maWcgdOG7qyBzZXJ2ZXIKICAgICAgICAKICAgICAgICBUYXNrIGZvcm1hdCB04burIHNlcnZlciBNUVRUOgogICAgICAgIHsKICAgICAgICAgICAgInRhc2tfaWQiOiAidGFza18xMjM0NTY3ODkwXzEyMyIsCiAgICAgICAgICAgICJkZXZpY2VfaWQiOiAiZGV2aWNlLTAwMSIsCiAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAidXBkYXRlX21pbmluZ19jb25maWciLAogICAgICAgICAgICAiZGF0YSI6IHsKICAgICAgICAgICAgICAgICJtaW5pbmdfY29uZmlnIjogWwogICAgICAgICAgICAgICAgICAgIHsgImNvaW5fbmFtZSI6ICJWUlNDIiwgIm1pbmluZ190b29sIjogImNjbWluZXIiLCAiY29uZmlnIjogey4uLn0gfSwKICAgICAgICAgICAgICAgICAgICB7ICJjb2luX25hbWUiOiAiREVSTyIsICJtaW5pbmdfdG9vbCI6ICJhc3Ryb21pbmVyIiwgImNvbmZpZyI6IHsuLi59IH0KICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgfSwKICAgICAgICAgICAgIm1lc3NhZ2UiOiAiQ+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIG1pbmluZyIsCiAgICAgICAgICAgICJ0aW1lc3RhbXAiOiAiMjAyNS0xMC0yOFQuLi4iCiAgICAgICAgfQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza19pZCA9IHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKQogICAgICAgICAgICBkZXZpY2VfaWQgPSB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgICAgICBkYXRhID0gdGFza19kYXRhLmdldCgiZGF0YSIsIHt9KQogICAgICAgICAgICBtaW5pbmdfY29uZmlnX2FycmF5ID0gZGF0YS5nZXQoIm1pbmluZ19jb25maWciLCBbXSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IG1pbmluZyBjb25maWcgdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG1pbmluZ19zZXJ2aWNlIGPDsyB04buTbiB04bqhaSBraMO0bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYubWluaW5nX3NlcnZpY2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSAiTWluaW5nIHNlcnZpY2UgY2jGsGEgxJHGsOG7o2Mga2jhu59pIHThuqFvIgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBtaW5pbmdfY29uZmlnX2FycmF5OgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gIk1pbmluZyBjb25maWcgYXJyYXkgcuG7l25nIgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBjb25maWcgb2JqZWN0IMSR4buDIGfhu61pIHNhbmcgbWluaW5nIEFQSQogICAgICAgICAgICAjIGF1dG9fc3RhcnQgbeG6t2MgxJHhu4tuaCB0cnVlCiAgICAgICAgICAgICMgbGFzdF9zeW5jX2NvbmZpZyBsw6AgdGltZXN0YW1wIGhp4buHbiB04bqhaQogICAgICAgICAgICBjb25maWdfdG9fc3luYyA9IHsKICAgICAgICAgICAgICAgICJsYXN0X3N5bmNfY29uZmlnIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICJhdXRvX3N0YXJ0IjogVHJ1ZSwKICAgICAgICAgICAgICAgICJtaW5lcnMiOiBtaW5pbmdfY29uZmlnX2FycmF5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h14bqpbiBi4buLIHN5bmMge2xlbihtaW5pbmdfY29uZmlnX2FycmF5KX0gbWluZXJzIHbhu5tpIGF1dG9fc3RhcnQ9VHJ1ZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFN5bmMgY29uZmlnIHThu6sgTVFUVAogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5taW5pbmdfc2VydmljZS5zeW5jX2NvbmZpZ19mcm9tX21xdHQoY29uZmlnX3RvX3N5bmMpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgIyBM4bqleSBzdW1tYXJ5IMSR4buDIGLDoW8gY8OhbwogICAgICAgICAgICAgICAgc3VtbWFyeSA9IHNlbGYubWluaW5nX3NlcnZpY2UuZ2V0X21pbmluZ19zdW1tYXJ5KCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWVzc2FnZSA9ICgKICAgICAgICAgICAgICAgICAgICBmIsSQw6MgY+G6rXAgbmjhuq10IG1pbmluZyBjb25maWc6ICIKICAgICAgICAgICAgICAgICAgICBmIntzdW1tYXJ5LmdldCgncnVubmluZ19taW5lcnMnLCAwKX0ve3N1bW1hcnkuZ2V0KCd0b3RhbF9taW5lcnMnLCAwKX0gbWluZXJzIHJ1bm5pbmciCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKG1lc3NhZ2UpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIG1lc3NhZ2UpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSAiS2jDtG5nIHRo4buDIHN5bmMgbWluaW5nIGNvbmZpZyIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgeOG7rSBsw70gbWluaW5nIGNvbmZpZyB1cGRhdGUiKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIiksCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKSwKICAgICAgICAgICAgICAgICJmYWlsZWQiLAogICAgICAgICAgICAgICAgZiJM4buXaToge3N0cihlKX0iCiAgICAgICAgICAgICkKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX3VwZGF0ZV9kZXZpY2VfY29uZmlnKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICBjb25maWdfZGF0YSA9IHRhc2tfZGF0YS5nZXQoImNvbmZpZ19kYXRhIiwge30pCiAgICAgICAgICAgIGlmIG5vdCBjb25maWdfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJE4buvIGxp4buHdSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgcuG7l25nIikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiROG7ryBsaeG7h3UgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIHLhu5duZyIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSB04burbmcgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNhdmVfZGV2aWNlX2NvbmZpZyhjb25maWdfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izogeycsICcuam9pbihjb25maWdfZGF0YS5rZXlzKCkpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGzDoCBjaMawYSBzeW5jIMSR4buDIMSR4bqjbSBi4bqjbyB0aMO0bmcgdGluIG3hu5tpIG5o4bqldCDEkcaw4bujYyBn4butaSBsw6puIHNlcnZlcgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfYWNjb3VudHMgPSBzZWxmLmRiLm1hcmtfYWxsX2FjY291bnRzX25vdF9zeW5jZWQoKQogICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfYWNjb3VudHMgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IHt1cGRhdGVkX2FjY291bnRzfSB0w6BpIGtob+G6o24gbMOgIGNoxrBhIHN5bmMgc2F1IGtoaSBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gY+G6p24gxJHDoW5oIGThuqV1IGNoxrBhIHN5bmMiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24gY2jGsGEgc3luYzoge2V9IikKICAgICAgICAgICAgICAgICAgICAjIEtow7RuZyBmYWlsIHRhc2sgdsOsIHZp4buHYyBj4bqtcCBuaOG6rXQgY29uZmlnIMSRw6MgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHN5bmNfaW50ZXJ2YWwgbuG6v3UgbsOzIHRoYXkgxJHhu5VpCiAgICAgICAgICAgICAgICBpZiAic3luY19pbnRlcnZhbCIgaW4gY29uZmlnX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgbmV3X3N5bmNfaW50ZXJ2YWwgPSBjb25maWdfZGF0YVsic3luY19pbnRlcnZhbCJdCiAgICAgICAgICAgICAgICAgICAgaWYgbmV3X3N5bmNfaW50ZXJ2YWwgIT0gc2VsZi5zeW5jX2ludGVydmFsOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkPhuq1wIG5o4bqtdCBzeW5jX2ludGVydmFsIHThu6sge3NlbGYuc3luY19pbnRlcnZhbH0gdGjDoG5oIHtuZXdfc3luY19pbnRlcnZhbH0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN5bmNfaW50ZXJ2YWwgPSBuZXdfc3luY19pbnRlcnZhbAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaOG7n2kgxJHhu5luZyBs4bqhaSB0aHJlYWQgxJHhu5NuZyBi4buZIG7hur91IMSRYW5nIGNo4bqheQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnN5bmNfdGhyZWFkIGlzIG5vdCBOb25lIGFuZCBzZWxmLnN5bmNfdGhyZWFkLmlzX2FsaXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIMSR4buZbmcgbOG6oWkgdGhyZWFkIMSR4buTbmcgYuG7mSB24bubaSBraG/huqNuZyB0aOG7nWkgZ2lhbiBt4bubaSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN0b3Bfc3luY190aHJlYWQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjDtG5nIGLDoW8gY2hvIEpvYlNlcnZpY2UgduG7gSB04bqldCBj4bqjIGNvbmZpZyB1cGRhdGUKICAgICAgICAgICAgICAgIGlmIHNlbGYuam9iX3NlcnZpY2UgYW5kIGhhc2F0dHIoc2VsZi5qb2Jfc2VydmljZSwgJ2hhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUnKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiVGjDtG5nIGLDoW8gSm9iU2VydmljZSB24buBIGNvbmZpZyB1cGRhdGUiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX3NlcnZpY2UuaGFuZGxlX21xdHRfY29uZmlnX3VwZGF0ZShjb25maWdfZGF0YSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMb2cgdGjDqm0gdGjDtG5nIHRpbiB24buBIGpvYi1yZWxhdGVkIGNvbmZpZ3MKICAgICAgICAgICAgICAgIGpvYl9yZWxhdGVkX2tleXMgPSBbIm1heF9qb2JzX3Blcl9kYXkiLCAibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAiam9iX2ludGVydmFsX3NlY29uZHMiLCAiY2FyZV9pbl93b3JraW5nX2pvYiJdCiAgICAgICAgICAgICAgICBpZiBhbnkoa2V5IGluIGNvbmZpZ19kYXRhIGZvciBrZXkgaW4gam9iX3JlbGF0ZWRfa2V5cyk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIEpvYlNlcnZpY2UgxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQiKQogICAgICAgICAgICAgICAgICAgICMgSm9iU2VydmljZSBz4bq9IHjhu60gbMO9IGxvZ2ljIHJlc3RhcnQgc2Vzc2lvbiBu4bq/dSBj4bqnbiB0aGnhur90CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR+G7rWkgYsOhbyBjw6FvIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgInN1Y2Nlc3MiLCBmIsSQw6MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izogeycsICcuam9pbihjb25maWdfZGF0YS5rZXlzKCkpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izoge3N0cihlKX0iCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfc3luY2VkKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgc2VydmVyIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRfY291bnQgPSAwCiAgICAgICAgICAgIGpvYl9jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiAiYWNjb3VudHMiIGluIGRhdGEgYW5kIGlzaW5zdGFuY2UoZGF0YVsiYWNjb3VudHMiXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudF91dWlkIGluIGRhdGFbImFjY291bnRzIl06CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5tYXJrX2FzX3N5bmNlZCgiYWNjb3VudHMiLCBhY2NvdW50X3V1aWQpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIMSR4buTbmcgYuG7mToge2FjY291bnRfdXVpZH0iKQogICAgICAgICAgICAgICAgYWNjb3VudF9jb3VudCA9IGxlbihkYXRhWyJhY2NvdW50cyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgam9iIMSRw6MgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGlmICJqb2JzIiBpbiBkYXRhIGFuZCBpc2luc3RhbmNlKGRhdGFbImpvYnMiXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3Igam9iX3V1aWQgaW4gZGF0YVsiam9icyJdOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIubWFya19hc19zeW5jZWQoImpvYnNfaGlzdG9yeSIsIGpvYl91dWlkKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSBqb2IgxJHDoyDEkeG7k25nIGLhu5k6IHtqb2JfdXVpZH0iKQogICAgICAgICAgICAgICAgam9iX2NvdW50ID0gbGVuKGRhdGFbImpvYnMiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSGnhu4NuIHRo4buLIHRow7RuZyBiw6FvIHThu5VuZyBo4bujcCBob+G6t2MgdGjDtG5nIGLDoW8gdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgIm1lc3NhZ2UiIGluIHRhc2tfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjDtG5nIGLDoW8gdOG7qyBzZXJ2ZXI6IHt0YXNrX2RhdGFbJ21lc3NhZ2UnXX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBIaeG7g24gdGjhu4sgdGjDtG5nIGLDoW8gdOG7lW5nIGjhu6NwIG7hur91IGtow7RuZyBjw7MgbWVzc2FnZSB04burIHNlcnZlcgogICAgICAgICAgICAgICAgaWYgYWNjb3VudF9jb3VudCA+IDAgb3Igam9iX2NvdW50ID4gMDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZzoge2FjY291bnRfY291bnR9IHTDoGkga2hv4bqjbiwge2pvYl9jb3VudH0gam9iIikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIAogICAgCiAgICBkZWYgX2hhbmRsZV9hY2NvdW50X3VwZGF0ZShzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgY+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyIGPDsyBj4bqldSB0csO6YzoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgInRhc2tfaWQiOiAidGFza18xNzQ5Mzk5NTM2MjcyXzY0MSIsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogImExMjVmNjI0ZjQxYTRmN2MiLAogICAgICAgICAgICAgICAgInRhc2tfdHlwZSI6ICJhY2NvdW50X3VwZGF0ZSIsCiAgICAgICAgICAgICAgICAiZGF0YSI6IHsKICAgICAgICAgICAgICAgICAgICAiYXBwIjogImluc3RhZ3JhbSIsCiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJpbmFjdGl2ZSIsCgogICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAzMCwKICAgICAgICAgICAgICAgICAgICAiam9iX2VuYWJsZSI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgImFjY291bnRfdXVpZCI6ICI3ZWQ5NTU3ZC03NmE0LTQ3ZjctODg1MC03Y2VlZjBjNjkwYWYiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAicGVuZGluZyIKICAgICAgICAgICAgfQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza19pZCA9IHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKQogICAgICAgICAgICBkZXZpY2VfaWQgPSB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgICAgICBkYXRhID0gdGFza19kYXRhLmdldCgiZGF0YSIsIHt9KQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gecOqdSBj4bqndSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBkYXRhIG9yICJhY2NvdW50X3V1aWQiIG5vdCBpbiBkYXRhOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkThu68gbGnhu4d1IHTDoGkga2hv4bqjbiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgIkThu68gbGnhu4d1IHTDoGkga2hv4bqjbiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHTDoGkga2hv4bqjbiB04burIERCCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50X2J5X3V1aWQoZGF0YVsiYWNjb3VudF91dWlkIl0pCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHbhu5tpIFVVSUQ6IHtkYXRhWydhY2NvdW50X3V1aWQnXX0iCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7fQogICAgICAgICAgICB2YWxpZF9maWVsZHMgPSBbInN0YXR1cyIsICJqb2JfZW5hYmxlIiwgImpvYl9kaXNhYmxlX3VudGlsIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IiwgImZvbGxvd19kaXNhYmxlX3VudGlsIiwgImZvbGxvd190b2RheSIsICJmb2xsb3dfaW5fc2Vzc2lvbiIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICJtYXhfZm9sbG93X2RheSIsICJtYXhfZm9sbG93X3Nlc3Npb24iLCAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiJdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3Ugc3RhdHVzID0gImRlbGV0ZSIgdGjDrCB4w7NhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgPT0gImRlbGV0ZSI6CiAgICAgICAgICAgICAgICBhY2NvdW50X3V1aWQgPSBkYXRhWyJhY2NvdW50X3V1aWQiXQogICAgICAgICAgICAgICAgYWNjb3VudF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiVW5rbm93biIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgeMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IChVVUlEOiB7YWNjb3VudF91dWlkfSkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIDEuIFjDs2EgdOG6pXQgY+G6oyBqb2IgaGlzdG9yeSBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGpvYl9oaXN0b3J5X2RlbGV0ZWQgPSBzZWxmLmRiLmRlbGV0ZV9qb2JfaGlzdG9yeV9ieV9hY2NvdW50KGFjY291bnRfdXVpZCkKICAgICAgICAgICAgICAgIGlmIGpvYl9oaXN0b3J5X2RlbGV0ZWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHjDs2Egam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIHjDs2Egam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgMi4gWMOzYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGFjY291bnRfZGVsZXRlZCA9IHNlbGYuZGIuZGVsZXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgIGlmIGFjY291bnRfZGVsZXRlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgeMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IChJRDoge2FjY291bnRbJ2lkJ119KSBraOG7j2kgZGF0YWJhc2UiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgZiLEkMOjIHjDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiS2jDtG5nIHRo4buDIHjDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRhdGEuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGtleSBpbiB2YWxpZF9maWVsZHM6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFba2V5XSA9IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB1cGRhdGVfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIHRow7RuZyB0aW4gY+G6p24gY+G6rXAgbmjhuq10IikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiS2jDtG5nIGPDsyB0aMO0bmcgdGluIGPhuqduIGPhuq1wIG5o4bqtdCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGzhuqFpIHbDoG8gREIKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJycpfSAoVVVJRDoge2RhdGFbJ2FjY291bnRfdXVpZCddfSkgduG7m2kgZOG7ryBsaeG7h3U6IHt1cGRhdGVfZGF0YX0iKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgInN1Y2Nlc3MiLCBmIsSQw6MgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICcnKX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICcnKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuOiB7c3RyKGUpfSIKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfcHJveHkoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCBwcm94eQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlciBjw7MgY+G6pXUgdHLDumM6CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJ0YXNrX2lkIjogInRhc2tfMTc0OTM5OTUzNjI3Ml82NDEiLAogICAgICAgICAgICAgICAgImRldmljZV9pZCI6ICJhMTI1ZjYyNGY0MWE0ZjdjIiwKICAgICAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAidXBkYXRlX3Byb3h5IiwKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAgICJwcm94eV9jb25maWciOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICJwcm94eV80NTYiLAogICAgICAgICAgICAgICAgICAgICAgICAiaG9zdCI6ICJwcm94eS5leGFtcGxlLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJwb3J0IjogODA4MCwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIjogInVzZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAicGFzc3dvcmQiOiAicGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImh0dHAiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogInBlbmRpbmciCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHByb3h5IHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHByb3h5X2NvbmZpZyA9IGRhdGEKICAgICAgICAgICAgaWYgbm90IHByb3h5X2NvbmZpZzoKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJUaGnhur91IHRow7RuZyB0aW4gcHJveHlfY29uZmlnIHRyb25nIGThu68gbGnhu4d1IHRhc2siCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgY+G6pXUgaMOsbmggcHJveHkgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfY29uZmlnIiwgcHJveHlfY29uZmlnKQogICAgICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIHnDqnUgY+G6p3UgcHJveHkgdsOsIMSRw6Mgbmjhuq1uIMSRxrDhu6NjIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfcmVxdWVzdGVkIiwgMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggcHJveHk6IHtwcm94eV9jb25maWdbJ25hbWUnXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu61pIGLDoW8gY8OhbyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHN1Y2Nlc3NfbXNnID0gZiLEkMOjIGPhuq1wIG5o4bqtdCBwcm94eToge3Byb3h5X2NvbmZpZ1snbmFtZSddfSIKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgc3VjY2Vzc19tc2cpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSBraGkgbMawdSBj4bqldSBow6xuaCBwcm94eToge3N0cihlKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgcHJveHk6IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCgogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIMSR4buZbmcgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBjw6FjIGhhbmRsZXIgdHLGsOG7m2Mga2hpIGvhur90IG7hu5FpCiAgICAgICAgICAgIHNlbGYuc2V0dXBfbXF0dF9oYW5kbGVycygpCiAgICAgICAgICAgIHNlbGYuY29ubmVjdCgpCiAgICAgICAgICAgICMgS2jhu59pIMSR4buZbmcgc3luYyB0aHJlYWQgc2F1IGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgc2VsZi5zdGFydF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZSB2w6AgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgTVFUVCBzZXJ2aWNlIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9vbl9tZXNzYWdlKHNlbGYsIGNsaWVudCwgdXNlcmRhdGEsIG1zZywgcHJvcGVydGllcz1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBDYWxsYmFjayBraGkgbmjhuq1uIMSRxrDhu6NjIG1lc3NhZ2UgdOG7qyBNUVRUIGJyb2tlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNsaWVudDogTVFUVCBjbGllbnQgaW5zdGFuY2UKICAgICAgICAgICAgdXNlcmRhdGE6IFVzZXIgZGF0YSDEkcaw4bujYyB0cnV54buBbiB2w6BvIGNsaWVudAogICAgICAgICAgICBtc2c6IE1lc3NhZ2Ugb2JqZWN0IGNo4bupYSB0b3BpYyB2w6AgcGF5bG9hZAogICAgICAgICAgICBwcm9wZXJ0aWVzOiBQcm9wZXJ0aWVzIGPhu6dhIG1lc3NhZ2UgKE1RVFQgdjUpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljOiB7bXNnLnRvcGljfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFBhcnNlIHBheWxvYWQgSlNPTgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXlsb2FkID0ganNvbi5sb2Fkcyhtc2cucGF5bG9hZC5kZWNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIGV4Y2VwdCBqc29uLkpTT05EZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBwYXJzZSBKU09OIHThu6sgcGF5bG9hZDoge21zZy5wYXlsb2FkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70gbWVzc2FnZSBk4buxYSB0csOqbiB0b3BpYwogICAgICAgICAgICBpZiBtc2cudG9waWMgPT0gc2VsZi50b3BpY19zZXJ2ZXJfdGFzazoKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9zZXJ2ZXJfdGFzayhwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljIGtow7RuZyB4w6FjIMSR4buLbmg6IHttc2cudG9waWN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgeOG7rSBsw70gbWVzc2FnZToge3N0cihlKX0iKQoKICAgIGRlZiBfaGFuZGxlX3NlcnZlcl90YXNrKHNlbGYsIHBheWxvYWQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcGF5bG9hZDogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza190eXBlID0gcGF5bG9hZC5nZXQoInRhc2tfdHlwZSIpCiAgICAgICAgICAgIGlmIG5vdCB0YXNrX3R5cGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiTmjhuq1uIHRhc2sga2jDtG5nIGPDsyB0YXNrX3R5cGUiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJOaOG6rW4gdGFzayB04burIHNlcnZlcjoge3Rhc2tfdHlwZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBoYW5kbGVyIHTGsMahbmcg4bupbmcgbuG6v3UgxJHDoyDEkcSDbmcga8O9CiAgICAgICAgICAgIGlmIHRhc2tfdHlwZSBpbiBzZWxmLnRhc2tfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnNbdGFza190eXBlXShwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgaGFuZGxlciBjaG8gdGFza190eXBlOiB7dGFza190eXBlfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgeOG7rSBsw70gdGFzayB04burIHNlcnZlcjoge3N0cihlKX0iKQogICAgCiAgICBkZWYgX21vbml0b3JfcmFtX3VzYWdlKHNlbGYsIGRldmljZV9pbmZvOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgVGhlbyBkw7VpIFJBTSB2w6AgdOG7sSDEkeG7mW5nIHJlYm9vdCBu4bq/dSBSQU0gY2FvIGxpw6puIHThu6VjCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGV2aWNlX2luZm86IFRow7RuZyB0aW4gdGhp4bq/dCBi4buLIGNo4bupYSBSQU0gdXNhZ2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOtbmggcGjhuqduIHRyxINtIFJBTSBz4butIGThu6VuZyB04burIHJhbV90b3RhbCB2w6AgcmFtX3VzZWQKICAgICAgICAgICAgcmFtX3RvdGFsID0gZGV2aWNlX2luZm8uZ2V0KCJyYW1fdG90YWwiLCAwKQogICAgICAgICAgICByYW1fdXNlZCA9IGRldmljZV9pbmZvLmdldCgicmFtX3VzZWQiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmFtX3RvdGFsID4gMCBhbmQgcmFtX3VzZWQgPj0gMDoKICAgICAgICAgICAgICAgIHJhbV91c2FnZV9wZXJjZW50ID0gKHJhbV91c2VkIC8gcmFtX3RvdGFsKSAqIDEwMAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOtbmggdG/DoW4gUkFNOiB7cmFtX3VzZWR9TUIve3JhbV90b3RhbH1NQiA9IHtyYW1fdXNhZ2VfcGVyY2VudDouMWZ9JSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiB0aOG7rSBs4bqleSB0cuG7sWMgdGnhur9wIHThu6sgZGV2aWNlX2luZm8KICAgICAgICAgICAgICAgIHJhbV91c2FnZV9wZXJjZW50ID0gZGV2aWNlX2luZm8uZ2V0KCJyYW1fcGVyY2VudGFnZSIsIDApCiAgICAgICAgICAgICAgICBpZiByYW1fdXNhZ2VfcGVyY2VudCA9PSAwOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiS2jDtG5nIGPDsyB0aMO0bmcgdGluIFJBTSBo4bujcCBs4buHLCBz4butIGThu6VuZyBnacOhIHRy4buLIG3hurdjIMSR4buLbmggMCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJT4butIGThu6VuZyByYW1fcGVyY2VudGFnZSB0cuG7sWMgdGnhur9wOiB7cmFtX3VzYWdlX3BlcmNlbnQ6LjFmfSUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gdsOgbyBs4buLY2ggc+G7rSAoY2jhu4kgZ2nhu68gbOG6oWkgMyBs4bqnbiBn4bqnbiBuaOG6pXQpCiAgICAgICAgICAgIHNlbGYucmFtX3VzYWdlX2hpc3RvcnkuYXBwZW5kKHJhbV91c2FnZV9wZXJjZW50KQogICAgICAgICAgICBpZiBsZW4oc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSkgPiBzZWxmLmNvbnNlY3V0aXZlX2hpZ2hfcmFtX2xpbWl0OgogICAgICAgICAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeS5wb3AoMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJBTSBoaeG7h24gdOG6oWk6IHtyYW1fdXNhZ2VfcGVyY2VudDouMWZ9JSAobOG7i2NoIHPhu606IHtbZid7eDouMWZ9JScgZm9yIHggaW4gc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeV19KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgY8OzIMSR4bunIDMgbOG6p24gxJFvIHbDoCB04bqldCBj4bqjIMSR4buBdSA+IG5nxrDhu6FuZwogICAgICAgICAgICBpZiBsZW4oc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSkgPj0gc2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdDoKICAgICAgICAgICAgICAgIGlmIGFsbCh1c2FnZSA+IHNlbGYuaGlnaF9yYW1fdGhyZXNob2xkIGZvciB1c2FnZSBpbiBzZWxmLnJhbV91c2FnZV9oaXN0b3J5KToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlJBTSBjYW8gbGnDqm4gdOG7pWMge3NlbGYuY29uc2VjdXRpdmVfaGlnaF9yYW1fbGltaXR9IGzhuqduICg+e3NlbGYuaGlnaF9yYW1fdGhyZXNob2xkfSUpOiB7W2Yne3g6LjFmfSUnIGZvciB4IGluIHNlbGYucmFtX3VzYWdlX2hpc3RvcnldfSIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkLhuq90IMSR4bqndSByZWJvb3QgdGhp4bq/dCBi4buLIMSR4buDIGdp4bqjaSBwaMOzbmcgUkFNLi4uIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gcmVib290CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fcmVib290X2RldmljZSgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBn4butaSBs4buHbmggcmVib290IHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgbOG7i2NoIHPhu60gc2F1IGtoaSByZWJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeS5jbGVhcigpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgdGjhu7FjIGhp4buHbiByZWJvb3QgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdGhlbyBkw7VpIFJBTToge2V9IikKICAgIAogICAgZGVmIF9yZWJvb3RfZGV2aWNlKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiByZWJvb3QgdGhp4bq/dCBi4buLIHF1YSBBREIKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIERFVklDRV9JUCB04burIGNvbmZpZyB0aGF5IHbDrCBBREJfSE9TVAogICAgICAgICAgICBkZXZpY2VfYWRkcmVzcyA9IGYie2NvbmZpZy5ERVZJQ0VfSVB9Ontjb25maWcuQURCX1BPUlR9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4buHbmggcmVib290IHF1YSBBREIKICAgICAgICAgICAgY21kID0gWyJhZGIiLCAiLXMiLCBkZXZpY2VfYWRkcmVzcywgInJlYm9vdCJdCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gcmVib290IHRoaeG6v3QgYuG7izogeycgJy5qb2luKGNtZCl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKAogICAgICAgICAgICAgICAgY21kLAogICAgICAgICAgICAgICAgY2hlY2s9VHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICAgICAgdGV4dD1UcnVlLAogICAgICAgICAgICAgICAgdGltZW91dD0xMCAgIyBUaW1lb3V0IDEwIGdpw6J5CiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTOG7h25oIHJlYm9vdCDEkcOjIMSRxrDhu6NjIGfhu61pIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLlRpbWVvdXRFeHBpcmVkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiVGltZW91dCBraGkgZ+G7rWkgbOG7h25oIHJlYm9vdCAodGhp4bq/dCBi4buLIGPDsyB0aOG7gyDEkWFuZyByZWJvb3QpIikKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgQ29pIG5oxrAgdGjDoG5oIGPDtG5nIHbDrCBjw7MgdGjhu4MgdGhp4bq/dCBi4buLIMSRYW5nIHJlYm9vdAogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvciBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiByZWJvb3Q6IHtlLnN0ZGVycn0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IGzhu4duaCBhZGIsIGtow7RuZyB0aOG7gyByZWJvb3QgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraMO0bmcgeMOhYyDEkeG7i25oIGtoaSByZWJvb3QgdGhp4bq/dCBi4buLOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2U=').decode('utf-8'))
