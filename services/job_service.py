import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19TRVNTSU9OID0gIsSQYW5nIHRyb25nIHBoacOqbiBsw6BtIHZp4buHYyIKICAgIE1TR19TRVNTSU9OX0NPT0xET1dOID0gIk5naOG7iSBuZ8ahaSBnaeG7r2EgY8OhYyBwaGnDqm4iCiAgICAKICAgICMgQWNjb3VudCBzdGF0dXMgcmVhc29ucwogICAgUkVBU09OX0RBSUxZX0xJTUlUID0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiCiAgICBSRUFTT05fU0VTU0lPTl9MSU1JVCA9ICLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIHBoacOqbiIKICAgIFJFQVNPTl9GT0xMT1dfU0VTU0lPTl9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbGxvdyB0cm9uZyBwaGnDqm4iCgpjbGFzcyBKb2JTZXJ2aWNlOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSwgbXF0dF9zZXJ2aWNlPU5vbmUpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGJfc2VydmljZTogRGF0YWJhc2VTZXJ2aWNlIMSR4buDIGzGsHUgdHLhu68gZOG7ryBsaeG7h3UKICAgICAgICAgICAgaGVscGVyX3NlcnZpY2U6IEhlbHBlclNlcnZpY2UgxJHhu4MgdMawxqFuZyB0w6FjIHbhu5tpIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBnb2xpa2Vfc2VydmljZTogR29MaWtlU2VydmljZSDEkeG7gyBn4buNaSBBUEkgR29MaWtlCiAgICAgICAgICAgIG1xdHRfc2VydmljZTogTVFUVFNlcnZpY2UgxJHhu4MgZ+G7rWkgdGjDtG5nIGLDoW8gKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHNlbGYuZGIgPSBkYl9zZXJ2aWNlCiAgICAgICAgc2VsZi5oZWxwZXIgPSBoZWxwZXJfc2VydmljZQogICAgICAgIHNlbGYuZ29saWtlX3NlcnZpY2UgPSBnb2xpa2Vfc2VydmljZQogICAgICAgIHNlbGYubXF0dF9zZXJ2aWNlID0gbXF0dF9zZXJ2aWNlCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlcgogICAgICAgIHNlbGYuam9iX2hhbmRsZXJzID0ge30KICAgICAgICAKICAgICAgICAjIEZsYWcgxJFp4buBdSBraGnhu4NuCiAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBUaMO0bmcgdGluIHbhu4EgY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0IC0gbOG6pXkgdOG7qyBkYXRhYmFzZSBob+G6t2MgY29uZmlnCiAgICAgICAgc2VsZi5lbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAKICAgICAgICAjIExvY2sgxJHhu4MgxJHhu5NuZyBi4buZIHRy4bqhbmcgdGjDoWkKICAgICAgICBzZWxmLl9sb2NrID0gdGhyZWFkaW5nLkxvY2soKQogICAgICAgIAogICAgICAgICMgRGljdGlvbmFyeSDEkeG7gyBsxrB1IHPhu5EgbOG6p24gdGjhu60gam9iIHRo4bqldCBi4bqhaSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHMgPSB7fQogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gbGnDqm4gdGnhur9wIGpvYiBmb2xsb3cgdHLhuqMgduG7gSBzdGF0dXMgNCAocGVuZGluZykKICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyBUcuG6oW5nIHRow6FpIHByb3h5IGhp4buHbiB04bqhaQogICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9pZCA9IE5vbmUKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IE5vbmUKICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSAwCiAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlID0gTm9uZSAgIyBUYWJsZSBuYW1lIMSRxrDhu6NjIGPhuqVwIHThu6sgcHJveHkgc2VydmVyCiAgICAgICAgc2VsZi5wcm94eV9sYXN0X3VwZGF0ZSA9IDAgICMgVGjhu51pIGdpYW4gdXBkYXRlIGN14buRaSBjw7luZwogICAgICAgIAogICAgICAgICMgxJDhur9tIHPhu5EgbOG6p24gdGjhuqV0IGLhuqFpIGtoaSBzZXR1cCBwcm94eQogICAgICAgIHNlbGYucHJveHlfc2V0dXBfZmFpbF9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFjDs2EgcHJveHkgdGFibGUgbmFtZSBjxakga2jhu49pIGRldmljZSBjb25maWcga2hpIGto4bufaSB04bqhbwogICAgICAgIHNlbGYuZGIuc2V0X2RldmljZV9jb25maWcoInByb3h5X3RhYmxlX25hbWUiLCBOb25lKQogICAgICAgIAogICAgICAgICMgVHLhuqFuZyB0aMOhaSBj4bqtcCBuaOG6rXQgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQKICAgICAgICBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbiA9IEZhbHNlICAjIEPhuqduIHJlc3RhcnQgc2Vzc2lvbiBkbyBjb25maWcgdGhheSDEkeG7lWkKICAgICAgICAKICAgIGRlZiBzYWZlX3NsZWVwKHNlbGYsIHNlY29uZHM6IGZsb2F0KSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE5n4bunIGFuIHRvw6BuLCBjw7MgdGjhu4MgZOG7q25nIGzhuqFpIG5nYXkgbOG6rXAgdOG7qWMga2hpIGZvcmNlX3N0b3AgxJHGsOG7o2MgxJHhurd0IHRow6BuaCBUcnVlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2Vjb25kczogU+G7kSBnacOieSBj4bqnbiBuZ+G7pwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IG5n4bunIMSR4bunIHRo4budaSBnaWFuLCBGYWxzZSBu4bq/dSBi4buLIGThu6tuZyBs4bqhaQogICAgICAgICIiIgogICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIGNoZWNrX2ludGVydmFsID0gSm9iU2VydmljZUNvbnN0YW50cy5ERUZBVUxUX0NIRUNLX0lOVEVSVkFMICAjIEtp4buDbSB0cmEgbeG7l2kgMC41IGdpw6J5CiAgICAgICAgCiAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgc2Vjb25kczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyB5w6p1IGPhuqd1IGThu6tuZyBob+G6t2MgcmVzdGFydCBzZXNzaW9uCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgIyBO4bq/dSBjw7MgecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24sIHRob8OhdCBraOG7j2kgc2xlZXAgbmdheSBs4bqtcCB04bupYwogICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE5n4bunIG3hu5l0IGtob+G6o25nIG5n4bqvbgogICAgICAgICAgICBzbGVlcF90aW1lID0gbWluKGNoZWNrX2ludGVydmFsLCBzZWNvbmRzIC0gKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkpCiAgICAgICAgICAgIGlmIHNsZWVwX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChzbGVlcF90aW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSBIZWxwZXJTZXJ2aWNlCiAgICAgICAgaGVscGVyX3N1Y2Nlc3MsIGhlbHBlcl9kYXRhID0gdXRpbHMuY2hlY2tfaGVscGVyX3NlcnZpY2Uoc2VsZi5oZWxwZXIpCiAgICAgICAgaWYgbm90IGhlbHBlcl9zdWNjZXNzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBr4bq/dCBu4buRaSDEkeG6v24gSGVscGVyU2VydmljZS4gVnVpIGzDsm5nIGtp4buDbSB0cmEgbOG6oWkuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyBu4bq/dSBjw7MKICAgICAgICBpZiBoZWxwZXJfZGF0YSBhbmQgImRhdGEiIGluIGhlbHBlcl9kYXRhOgogICAgICAgICAgICBzZWxmLmRiLnNhdmVfZGV2aWNlX2luZm8oaGVscGVyX2RhdGEpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBsxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLOiB7aGVscGVyX2RhdGFbJ2RhdGEnXS5nZXQoJ2RldmljZV9tb2RlbCcsICdVbmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICMgMy4gTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MKICAgICAgICBzZWxmLl9zYXZlX2RlZmF1bHRfY29uZmlncygpCiAgICAgICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSB2w6AgbOG6pXkgR29MaWtlIGhlYWRlcnMgbuG6v3UgY+G6p24KICAgICAgICBnb2xpa2Vfc3VjY2VzcyA9IHNlbGYuZ29saWtlX3NlcnZpY2UuZmV0Y2hfZ29saWtlX2hlYWRlcnNfd2l0aF9yZXRyeSgpCiAgICAgICAgaWYgbm90IGdvbGlrZV9zdWNjZXNzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBs4bqleSBHb0xpa2UgaGVhZGVycy4gVnVpIGzDsm5nIGtp4buDbSB0cmEgbOG6oWkuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyA1LiBLaOG7n2kgdOG6oW8gY8OhYyBqb2IgaGFuZGxlcgogICAgICAgIHNlbGYuX2luaXRfam9iX2hhbmRsZXJzKCkKICAgICAgICAKICAgICAgICAjIDYuIEto4bufaSB04bqhbyBuZ8OgeSBjdeG7kWkgY8O5bmcgxJHDoyByZXNldCBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIHRvZGF5ID0gbm93LmRhdGUoKQogICAgICAgIGpvYl9ob3VyID0gc2VsZi5kYi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgIHJlc2V0X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5jb21iaW5lKHRvZGF5LCBkYXRldGltZS50aW1lKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wKSkKICAgICAgICAKICAgICAgICAjIEzhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZyB04burIGRhdGFiYXNlCiAgICAgICAgbGFzdF9yZXNldF9kYXRlX3N0ciA9IHNlbGYuZGIuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKQogICAgICAgIAogICAgICAgIGlmIG5vdCBsYXN0X3Jlc2V0X2RhdGVfc3RyOgogICAgICAgICAgICAjIE7hur91IGhp4buHbiB04bqhaSDEkcOjIHF1YSBnaeG7nSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heSwgxJHDoW5oIGThuqV1IMSRw6MgcmVzZXQKICAgICAgICAgICAgaWYgbm93ID49IHJlc2V0X3RpbWU6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG6v24gZ2nhu50gcmVzZXQsIMSRw6FuaCBk4bqldSBsw6AgxJHDoyByZXNldCBuZ8OgeSBow7RtIHF1YQogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gdG9kYXkgLSBkYXRldGltZS50aW1lZGVsdGEoZGF5cz0xKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsYXN0X3Jlc2V0X2RhdGUiLCBsYXN0X3Jlc2V0X2RhdGUuaXNvZm9ybWF0KCkpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jhu59pIHThuqFvIG5nw6B5IHJlc2V0OiB7bGFzdF9yZXNldF9kYXRlfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gdGjhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZzoge2xhc3RfcmVzZXRfZGF0ZV9zdHJ9IikKICAgICAgICAKICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gVHJ1ZQogICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgdOG6oW8gSm9iU2VydmljZSB0aMOgbmggY8O0bmcuIikKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY+G7p2EgbeG7mXQgYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIGPhuqduIGtp4buDbSB0cmEKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWksIEZhbHNlIG7hur91IGtow7RuZyBj4bqnbgogICAgICAgICIiIgogICAgICAgICMgTOG6pXkgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdOG7qyBkYXRhYmFzZQogICAgICAgIHN5bmNfc3RhdHVzX2tleSA9IGYie2FwcF9uYW1lfV9zeW5jX3N0YXR1cyIKICAgICAgICBzeW5jX3N0YXR1cyA9IHNlbGYuZGIuZ2V0KHN5bmNfc3RhdHVzX2tleSwgRmFsc2UpICAjIE3hurdjIMSR4buLbmggbMOgIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgICMgTuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZIHRow6wgY+G6p24gxJHhu5NuZyBi4buZIGzhuqFpCiAgICAgICAgcmV0dXJuIG5vdCBzeW5jX3N0YXR1cwogICAgICAgIAogICAgZGVmIF91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyLCBzdGF0dXM6IGJvb2wgPSBUcnVlKSAtPiBOb25lOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY+G7p2EgbeG7mXQgYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICBzdGF0dXM6IFRydWUgbuG6v3UgxJHDoyDEkeG7k25nIGLhu5ksIEZhbHNlIG7hur91IGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICIiIgogICAgICAgIHN5bmNfc3RhdHVzX2tleSA9IGYie2FwcF9uYW1lfV9zeW5jX3N0YXR1cyIKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgIHNlbGYuZGIuc2V0KHN5bmNfc3RhdHVzX2tleSwgc3RhdHVzKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX06IHtzdGF0dXN9IikKICAgICAgICAKICAgIGRlZiBfc3luY19hY2NvdW50c19mb3JfYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIG3hu5l0IGFwcCBj4bulIHRo4buDCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4g4bupbmcgZOG7pW5nIGPhuqduIMSR4buTbmcgYuG7mQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSR4buTbmcgYuG7mSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgam9iIGhhbmRsZXIgY2hvIHthcHBfbmFtZX0sIGLhu48gcXVhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgCiAgICAgICAgdHJ5OgoKICAgICAgICAgICAgIyAxLiDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgYWNjb3VudHMgPSBoYW5kbGVyLnN5bmNfYWNjb3VudHNfdG9fZGIoKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhu5NuZyBi4buZIHtsZW4oYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIDIuIE1hcCB0w6BpIGtob+G6o24gR29MaWtlCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgZ29saWtlX2FjY291bnRzID0gaGFuZGxlci5nZXRfZ29saWtlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGdvbGlrZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSB7bGVuKGdvbGlrZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBHb0xpa2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMOBbmggeOG6oSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIG1hcHBlZF9hY2NvdW50cyA9IGhhbmRsZXIubWFwX2dvbGlrZV9hY2NvdW50cyhnb2xpa2VfYWNjb3VudHMsIGRldmljZV9hY2NvdW50cykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMOhbmggeOG6oSB7bGVuKG1hcHBlZF9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IHbhu5tpIEdvTGlrZSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gR29MaWtlIG7DoG8gY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIFRydWUpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgbMOgIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICBzZWxmLl91cGRhdGVfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSwgRmFsc2UpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIF9zYXZlX2RlZmF1bHRfY29uZmlncyhzZWxmKToKICAgICAgICAiIiJMxrB1IGPDoWMgY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaCB2w6BvIGRhdGFiYXNlIG7hur91IGNoxrBhIGPDsyIiIgogICAgICAgIGRlZmF1bHRfY29uZmlncyA9IHsKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBsacOqbiBxdWFuIMSR4bq/biB0aOG7nWkgZ2lhbiBsw6BtIGpvYgogICAgICAgICAgICAiam9iX2hvdXIiOiBjb25maWcuSk9CX0hPVVIsCiAgICAgICAgICAgICJqb2JfY29vbGRvd25fbWludXRlcyI6IGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMsCiAgICAgICAgICAgICJqb2JfY2hlY2tfaW50ZXJ2YWwiOiBjb25maWcuSk9CX0NIRUNLX0lOVEVSVkFMLAogICAgICAgICAgICAiY29vbGRvd25fZ2V0X2pvYl9nb2xpa2UiOiAzMCwgICMgVGjhu51pIGdpYW4gY2jhu50gKHBow7p0KSBraGkga2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBHb0xpa2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gc+G7kSBsxrDhu6NuZyBqb2IKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9kYXkiOiBjb25maWcuTUFYX0pPQlNfUEVSX0RBWSwKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICAicGF1c2Vfam9iIjogRmFsc2UsCiAgICAgICAgICAgICMgVHLhuqFuZyB0aMOhaSB0aGnhur90IGLhu4sgxJFhbmcgbMOgbSB2aeG7h2MKICAgICAgICAgICAgImRldmljZV9pc193b3JraW5nIjogRmFsc2UsCiAgICAgICAgICAgICJkZXZpY2VfbWVzc2FnZSI6ICIiLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBEYW5oIHPDoWNoIGPDoWMgYXBwIMSRxrDhu6NjIGvDrWNoIGhv4bqhdAogICAgICAgICAgICAiZW5hYmxlZF9hcHBzIjogY29uZmlnLkVOQUJMRURfQVBQUywKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBjaG8gcGjDqXAgY2jEg20gc8OzYyBraGkgbMOgbSBqb2IKICAgICAgICAgICAgImNhcmVfaW5fd29ya2luZ19qb2IiOiBGYWxzZSwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggZ2nDoSB04buRaSB0aGnhu4N1IGNobyBqb2IgZm9sbG93CiAgICAgICAgICAgICJtaW5fZm9sbG93X3ByaWNlIjogMjAsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIHByb3h5CiAgICAgICAgICAgICJ1c2VfcHJveHkiOiBGYWxzZSwgICMgQ8OzIHPhu60gZOG7pW5nIHByb3h5IGtow7RuZwogICAgICAgICAgICAicHJveHlfc2VydmVyIjogImh0dHA6Ly8xMC4wLjAuNTo5MDMyIiwgICMgU2VydmVyIHByb3h5IG3hurdjIMSR4buLbmgKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGVmYXVsdF9jb25maWdzLml0ZW1zKCk6CiAgICAgICAgICAgICMgQ2jhu4kgbMawdSBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoa2V5KSBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6MgbMawdSBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oOiB7a2V5fT17dmFsdWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPhuqV1IGjDrG5oIHtrZXl9IMSRw6MgdOG7k24gdOG6oWk6IHtzZWxmLmRiLmdldChrZXkpfSIpCiAgICAgICAgCiAgICBkZWYgX2luaXRfam9iX2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyIiIiCiAgICAgICAgIyBpbml0IHRow6wgc+G6vSBpbml0IGhhbmRsZXJzIGNobyB04bqldCBj4bqjIGPDoWMgYXBwLCBsw6BtIGFwcCBuw6BvIHRow6wgc+G6vSB0aGVvIGPhuqV1IGjDrG5oIGzhuqV5IHThu6sgZGF0YWJhc2UKICAgICAgICBmb3IgYXBwX25hbWUgaW4gY29uZmlnLkVOQUJMRURfQVBQUzoKICAgICAgICAgICAgaWYgYXBwX25hbWUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2tKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gSW5zdGFncmFtSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBraOG7n2kgdOG6oW8ge2xlbihzZWxmLmpvYl9oYW5kbGVycyl9IGpvYiBoYW5kbGVyOiB7JywgJy5qb2luKHNlbGYuam9iX2hhbmRsZXJzLmtleXMoKSl9IikKICAgICAgICAKICAgIGRlZiBfcmVzZXRfZGFpbHlfY291bnRlcnMoc2VsZik6CiAgICAgICAgIiIiUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgdsOgbyBnaeG7nSDEkcaw4bujYyBj4bqldSBow6xuaCIiIgogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBnaeG7nSByZXNldCB04burIGPhuqV1IGjDrG5oIGhv4bq3YyB04burIGRhdGFiYXNlIG7hur91IGPDswogICAgICAgIGpvYl9ob3VyID0gc2VsZi5kYi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgIAogICAgICAgICMgVMOtbmggdGjhu51pIMSRaeG7g20gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgaWYgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gZGF0ZXRpbWUuZGF0ZS5mcm9taXNvZm9ybWF0KGxhc3RfcmVzZXRfZGF0ZV9zdHIpCiAgICAgICAgICAgIGV4Y2VwdCBWYWx1ZUVycm9yOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYixJDhu4tuaCBk4bqhbmcgbmfDoHkgcmVzZXQga2jDtG5nIGjhu6NwIGzhu4c6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIHF1YSBnaeG7nSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heSBjaMawYSB2w6AgY2jGsGEgcmVzZXQgdHJvbmcgbmfDoHkgaMO0bSBuYXkKICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZSBhbmQgKGxhc3RfcmVzZXRfZGF0ZSBpcyBOb25lIG9yIGxhc3RfcmVzZXRfZGF0ZSA8IHRvZGF5KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IChnaeG7nSByZXNldDoge2pvYl9ob3VyfTowMCkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBjw6FjIGLhu5kgxJHhur9tIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbgogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBz4buRIGpvYiBow7RtIG5heSB2w6Agc+G7kSBqb2IgdHJvbmcgcGhpw6puCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImxhc3Rfdmlld19zdG9yaWVzIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHbDrCDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5LAogICAgICAgICAgICAgICAgICAgICMgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgdGjDoG5oIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAiaW5hY3RpdmUiIGFuZCBhY2NvdW50LmdldCgiaW5hY3RpdmVfcmVhc29uIikgPT0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBhY3RpdmUgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBzYXUga2hpIHJlc2V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6BvIHtub3cuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG5nw6B5IMSRw6MgcmVzZXQgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkuaXNvZm9ybWF0KCkpCiAgICAgICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBjaOG6oXkgam9iIGNobyB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgY2jhuqF5IGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMi4gS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBj4bqnbiB0aGnhur90CiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMy4gxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5CiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4KICAgICAgICBpZiBzZWxmLl9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIGpvYiB0cm9uZyBwaGnDqm4iKQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0ixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdOG7kWkgxJFhIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgY8ahIGLhuqNuIGPhu6dhIHTDoGkga2hv4bqjbiIiIgogICAgICAgIGFjY291bnRfc3RhdHVzID0gYWNjb3VudC5nZXQoInN0YXR1cyIsICJhY3RpdmUiKQogICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIGLhu4sgZGlzYWJsZWQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJkaXNhYmxlZCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dCwga2jDtG5nIGNobyBjaOG6oXkgam9iCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImxvZ291dCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyBpbmFjdGl2ZSwga2nhu4NtIHRyYSB0aOG7nWkgZ2lhbiBjb29sZG93bgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJpbmFjdGl2ZSI6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9oYW5kbGVfaW5hY3RpdmVfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJY4butIGzDvSB0w6BpIGtob+G6o24gxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUiIiIKICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJqb2JfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjb29sZG93biwgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSB0aW1lLnRpbWUoKToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICJsYXN0X2NhcmVfdGltZSI6IDAsCiAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBGYWxzZSwKICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6ICIiCiAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBDaMawYSBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBjb29sZG93bl9yZW1haW4gPSBpbnQoKGpvYl9kaXNhYmxlX3VudGlsIC0gdGltZS50aW1lKCkpIC8gNjApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gY2jhu50gKGPDsm4ge2Nvb2xkb3duX3JlbWFpbn0gcGjDunQpIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYQogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiBj4bunYSB0w6BpIGtob+G6o24gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcCB24bubaSBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgaWYgYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0gPSBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIGpvYl9tYXhfZGF5CiAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImpvYl9tYXhfZGF5Il0gPSBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgIGlmIHVwZGF0ZV9kYXRhOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOzbmcgYXBwIHTGsMahbmcg4bupbmcgduG7m2kgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBjb25maWcuQVBQX1BBQ0tBR0VTOgogICAgICAgICAgICBzZWxmLmhlbHBlci5jbG9zZV9hcHAoY29uZmlnLkFQUF9QQUNLQUdFU1thcHBfbmFtZV0pCiAgICAgICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgcmV0dXJuIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheQogICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBwaGnDqm4ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICByZXR1cm4gam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2pvYl9zdGF0cyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgc3VjY2VzczogYm9vbCA9IFRydWUsIGpvYl90eXBlOiBzdHIgPSBOb25lKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc3VjY2VzczogVHJ1ZSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgam9iX3R5cGU6IExv4bqhaSBqb2IgKGZvbGxvdywgbGlrZSwgZXRjLikKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBqb2IgY8ahIGLhuqNuCiAgICAgICAgc2VsZi5fdXBkYXRlX2Jhc2ljX2pvYl9zdGF0cyhhY2NvdW50LCBzdWNjZXNzKQogICAgICAgIAogICAgICAgICMgUmVzZXQgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIG7hur91IGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgCiAgICAgICAgIyDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcAogICAgICAgIGFjY291bnQgPSBzZWxmLl9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB44butIGzDvSBnaeG7m2kgaOG6oW4gcGhpw6puCiAgICAgICAgc2VsZi5fY2hlY2tfc2Vzc2lvbl9saW1pdF9hZnRlcl9qb2IoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeQogICAgICAgIHNlbGYuX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihhY2NvdW50KQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gdGjhu5FuZyBrw6ogcmnDqm5nIGNobyBqb2IgZm9sbG93CiAgICAgICAgaWYgc3VjY2VzcyBhbmQgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9mb2xsb3dfc3RhdHMoYWNjb3VudCkKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9iYXNpY19qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wpOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IgY8ahIGLhuqNuIC0gY2jhu4kgxJHhur9tIGpvYiB0aMOgbmggY8O0bmciIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIENo4buJIHTEg25nIGNvdW50ZXJzIGtoaSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgdXBkYXRlX2RhdGEudXBkYXRlKHsKICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiBqb2JfdG9kYXkgKyAxLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogam9ic19kb25lX2luX3Nlc3Npb24gKyAxLAogICAgICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBhY2NvdW50LmdldCgidG90YWxfam9icyIsIDApICsgMQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKSAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgZGF0YQogICAgICAgIAogICAgZGVmIF9jaGVja19zZXNzaW9uX2xpbWl0X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gcGhpw6puIHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2pvYnNfcGVyX3Nlc3Npb24gPSBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgaWYgam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBsw6BtIMSR4bunIHttYXhfam9ic19wZXJfc2Vzc2lvbn0gam9iIHRyb25nIHBoacOqbiIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPSLEkMOjIGhvw6BuIHRow6BuaCBz4buRIGpvYiB04buRaSDEkWEgdHJvbmcgcGhpw6puIikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5IHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5ICh7am9iX3RvZGF5fS97am9iX21heF9kYXl9KSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfc2V0X2FjY291bnRfbG9nb3V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgdXNlcm5hbWU6IHN0ciA9IE5vbmUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICB1c2VybmFtZTogVXNlcm5hbWUgxJHhu4MgbG9nIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICJUw6BpIGtob+G6o24gxJHDoyBi4buLIGxvZ291dCIsCiAgICAgICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24ge3VzZXJuYW1lIG9yIGFjY291bnRfaWR9IGzDoCBsb2dvdXQiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ291dCBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZSBvciBhY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgdMOgaSBraG/huqNuIGxvZ291dDoge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9mb2xsb3dfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiByacOqbmcgY2hvIGZvbGxvdyBqb2IgdGjDoG5oIGPDtG5nICjEkcOjIGLhu48gZ2nhu5tpIGjhuqFuIGZvbGxvdykiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgZm9sbG93X3RvZGF5ID0gYWNjb3VudC5nZXQoImZvbGxvd190b2RheSIsIDApICsgMQogICAgICAgIGZvbGxvd19pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImZvbGxvd19pbl9zZXNzaW9uIiwgMCkgKyAxCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgc+G7kSBsaeG7h3UgZm9sbG93IHRow6BuaCBjw7RuZwogICAgICAgIHVwZGF0ZV9mb2xsb3cgPSB7CiAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiBmb2xsb3dfdG9kYXksCiAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGZvbGxvd19pbl9zZXNzaW9uLAogICAgICAgICAgICAibGFzdF9mb2xsb3dfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyI6IEZhbHNlLCAgIyBMdcO0biBsdcO0biDEkeG7gyBGYWxzZSB2w6wgxJHDoyBi4buPIGdp4bubaSBo4bqhbgogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfQogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2ZvbGxvdykKICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgdGjhu7FjIGhp4buHbiBmb2xsb3cgdGjDoG5oIGPDtG5nICh7Zm9sbG93X3RvZGF5fSBmb2xsb3cgaMO0bSBuYXkpIikKICAgICAgICAKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIHRyb25nIHRocmVhZCByacOqbmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkOiBUaHJlYWQgxJFhbmcgY2jhuqF5IEpvYlNlcnZpY2UgaG/hurdjIE5vbmUgbuG6v3UgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IHRy4bqhbmcgdGjDoWkgcnVubmluZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHRocmVhZAogICAgICAgICAgICB0aHJlYWQgPSB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLnJ1bikKICAgICAgICAgICAgdGhyZWFkLmRhZW1vbiA9IFRydWUKICAgICAgICAgICAgdGhyZWFkLnN0YXJ0KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB0aHJlYWQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgcmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJpbmFjdGl2ZSIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGluYWN0aXZlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgeyJzdGF0dXMiOiAiYWN0aXZlIiwgImlzX3N5bmMiOiBGYWxzZX0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IChJRDoge2FjY291bnRbJ2lkJ119KSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNo4budLCDEkcOjIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChqb2JfZGlzYWJsZV91bnRpbCAtIGN1cnJlbnRfdGltZSkgLyA2MCkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGPDsm4ge3JlbWFpbmluZ19taW51dGVzfSBwaMO6dCDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIHTDoGkga2hv4bqjbiBpbmFjdGl2ZSIpCiAgICAgICAgICAgIAogICAgZGVmIHJlc2V0X2xvZ291dF9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCByZXNldCBjw6FjIHTDoGkga2hv4bqjbiBsb2dvdXQgduG7gSBhY3RpdmUga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICBDaOG7iSBuw6puIGfhu41pIG1ldGhvZCBuw6B5IGtoaSBjw7MgecOqdSBj4bqndSDEkeG6t2MgYmnhu4d0IHThu6sgYWRtaW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBsb2dvdXQKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgbG9nb3V0X2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImxvZ291dCIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGxvZ291dF9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgcmVzZXQgdMOgaSBraG/huqNuIGxvZ291dCIpCiAgICAKICAgIGRlZiBpc19hY2NvdW50X2Nhbl9ydW5fam9iKHNlbGYsIGFwcF9uYW1lOnN0ciApIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBjaOG6oXkgam9iIGtow7RuZwogICAgICAgICIiIgogICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICBpZihzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENo4bqheSBKb2JTZXJ2aWNlIHRyb25nIG3hu5l0IHbDsm5nIGzhurdwIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHRoZW8gcGhpw6puCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuaXNfaW5pdGlhbGl6ZWQ6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmluaXRpYWxpemUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLiBLaMO0bmcgdGjhu4MgY2jhuqF5LiIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGNo4bqheSBKb2JTZXJ2aWNlIHbhu5tpIGxvZ2ljIGzDoG0gdmnhu4djIHRoZW8gcGhpw6puLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgeMOhYyDEkeG7i25oIGRldmljZV9pZCBoaeG7h24gdOG6oWksIEpvYlNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICB3aGlsZSBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICMgUmVzZXQgYmnhur9uIGZvcmNlX3N0b3AgbuG6v3UgY8OzCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIsIHThuqFtIGThu6tuZyB44butIGzDvSBqb2IiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG5nYXkga2hpIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3JlZ2lzdGVyZWQnKSBhbmQgc2VsZi5wcm94eV9yZWdpc3RlcmVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX1BBVVNFRF9TRVJWRVIpCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldCgiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBwaOG6o2kgZG8gZm9yY2VfcmVzdGFydF9zZXNzaW9uIGtow7RuZwogICAgICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IGzDoCByZXN0YXJ0IHNlc3Npb24sIHRp4bq/cCB04bulYyB2w7JuZyBs4bq3cCB0aGF5IHbDrCBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyBwaOG6o2kgcmVzdGFydCBzZXNzaW9uIHRow6wgbeG7m2kgYnJlYWsKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgc2VsZi5fcmVzZXRfZGFpbHlfY291bnRlcnMoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nQogICAgICAgICAgICBzZWxmLnJlc2V0X2luYWN0aXZlX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBj4bqtcCBuaOG6rXQgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQKICAgICAgICAgICAgaWYgbm90IHNlbGYuY2hlY2tfYW5kX2hhbmRsZV9zZXJ2ZXJfdXBkYXRlcygpOgogICAgICAgICAgICAgICAgIyBD4bqnbiByZXN0YXJ0IHNlc3Npb24gZG8gY29uZmlnIHRoYXkgxJHhu5VpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiUmVzdGFydCBzZXNzaW9uIGRvIGNvbmZpZyB0aGF5IMSR4buVaSB04burIHNlcnZlciIpCiAgICAgICAgICAgICAgICAjIFJlc2V0IHRo4budaSBnaWFuIGNvb2xkb3duIMSR4buDIGLhuq90IMSR4bqndSBzZXNzaW9uIG5nYXkgbOG6rXAgdOG7qWMKICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSAwCiAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG7hur91IMSRYW5nIHPhu60gZOG7pW5nCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3JlZ2lzdGVyZWQnKSBhbmQgc2VsZi5wcm94eV9yZWdpc3RlcmVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBkbyByZXN0YXJ0IHNlc3Npb24iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3VucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgY29udGludWUgICMgQuG6r3QgxJHhuqd1IGzhuqFpIHThu6sgxJHhuqd1IHbDsm5nIGzhurdwCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kgZ2nhu69hIGPDoWMgcGhpw6puIGtow7RuZwogICAgICAgICAgICAgICAgaWYgc2VsZi5faXNfaW5fc2Vzc2lvbl9jb29sZG93bigpOgogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZ19taW51dGVzID0gaW50KChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBpbnQodGltZS50aW1lKCkpKSAvIDYwKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYie0pvYlNlcnZpY2VDb25zdGFudHMuTVNHX1NFU1NJT05fQ09PTERPV059IChjw7JuIHtyZW1haW5pbmdfbWludXRlc30gcGjDunQpIikKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbeG7l2kgNSBnacOieSDEkeG7gyBjw7MgdGjhu4MgdGhvw6F0IHPhu5ttIGtoaSBjw7MgecOqdSBj4bqndQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIHBo4bqjaSBkbyBmb3JjZV9yZXN0YXJ0X3Nlc3Npb24ga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2VfcmVzdGFydF9zZXNzaW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTuG6v3UgbMOgIHJlc3RhcnQgc2Vzc2lvbiwgdGnhur9wIHThu6VjIHbDsm5nIGzhurdwIHRoYXkgdsOsIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgcGjhuqNpIHJlc3RhcnQgc2Vzc2lvbiB0aMOsIG3hu5tpIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHRyxrDhu5tjIHRpw6puCiAgICAgICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnMgYW5kIHNlbGYuX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gY2hvIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRzX2Zvcl9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIChzYXUga2hpIMSRw6MgxJHhu5NuZyBi4buZKQogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIG5vdCBhbGxfd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmjhuqMgcHJveHkgbmdheSBu4bq/dSDEkWFuZyBz4butIGThu6VuZwogICAgICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIGhhc2F0dHIoc2VsZiwgJ3Byb3h5X3JlZ2lzdGVyZWQnKSBhbmQgc2VsZi5wcm94eV9yZWdpc3RlcmVkOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkgZG8ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBKb2JTZXJ2aWNlQ29uc3RhbnRzLk1TR19ERVZJQ0VfTk9fQUNDT1VOVFMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBC4bqvdCDEkeG6p3Ugc2Vzc2lvbiBjb29sZG93biB0aGF5IHbDrCBzbGVlcCBuZ+G6r24KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MsIGLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkgbmjGsCBzYXUgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGFydF9zZXNzaW9uX2Nvb2xkb3duKCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buJIGzhuqV5IHByb3h5IGtoaSDEkcOjIGNo4bqvYyBjaOG6r24gY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX3Byb3h5X3JlcXVpcmVtZW50KCk6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqnbiBwcm94eSBuaMawbmcgY2jGsGEgY8OzLCBjaOG7nSAxMCBnacOieSBy4buTaSBraeG7g20gdHJhIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfV0FJVElOR19QUk9YWSkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgcGjhuqNpIGRvIGZvcmNlX3Jlc3RhcnRfc2Vzc2lvbiBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBsw6AgcmVzdGFydCBzZXNzaW9uLCB0aeG6v3AgdOG7pWMgdsOybmcgbOG6t3AgdGhheSB2w6wgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyBwaOG6o2kgcmVzdGFydCBzZXNzaW9uIHRow6wgbeG7m2kgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELhuq90IMSR4bqndSBwaGnDqm4gbMOgbSB2aeG7h2MgduG7m2kgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyBz4bq1biBzw6BuZwogICAgICAgICAgICAgICAgc2VsZi5fd29ya19zZXNzaW9uKGFsbF93b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IHbDoCBi4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVsZWFzZV9wcm94eV9hZnRlcl9zZXNzaW9uKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXJ0X3Nlc3Npb25fY29vbGRvd24oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCIpCiAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIHBo4bqjaSBkbyBmb3JjZV9yZXN0YXJ0X3Nlc3Npb24ga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTuG6v3UgbMOgIHJlc3RhcnQgc2Vzc2lvbiwgdGnhur9wIHThu6VjIHbDsm5nIGzhurdwIHRoYXkgdsOsIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHBo4bqjaSByZXN0YXJ0IHNlc3Npb24gdGjDrCBt4bubaSBicmVhawogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJKb2JTZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgICAgICAgICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgSm9iU2VydmljZSIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgZGVmIGZvcmNlX3N0b3BfYWxsKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZyIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQoKICAgIGRlZiBoYW5kbGVfbXF0dF9hY2NvdW50X3VwZGF0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBj4bqtcCBuaOG6rXQgYWNjb3VudCB04burIE1RVFQgc2VydmVyCiAgICAgICAgQWNjb3VudCBz4bq9IMSRxrDhu6NjIHJlbG9hZCBzYXUgbeG7l2kgam9iIHRyb25nIF93b3JrX2FjY291bnRfc2Vzc2lvbgogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgdGjDtG5nIGLDoW8gY+G6rXAgbmjhuq10IGFjY291bnQgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgCiAgICBkZWYgaGFuZGxlX21xdHRfZm9yY2Vfc3RhcnRfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB5w6p1IGPhuqd1IGLhuq90IMSR4bqndSBzZXNzaW9uIG5nYXkgbOG6rXAgdOG7qWMgdOG7qyBNUVRUIHNlcnZlcgogICAgICAgIELhu48gcXVhIHRo4budaSBnaWFuIG5naOG7iSBoaeG7h24gdOG6oWkKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IHNlc3Npb24gbmdheSBs4bqtcCB04bupYyB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICBpZiBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkLhu48gcXVhIHRo4budaSBnaWFuIG5naOG7iSB2w6AgYuG6r3QgxJHhuqd1IHNlc3Npb24gbmdheSIpCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSAwCiAgICAgICAgICAgIAogICAgZGVmIGhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoc2VsZiwgY29uZmlnX2NoYW5nZXM6IERpY3Rbc3RyLCBBbnldID0gTm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIE1RVFQgc2VydmVyCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gY8OzIGPhuqduIHJlc3RhcnQgc2Vzc2lvbiBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfY2hhbmdlczogRGljdGlvbmFyeSBjaOG7qWEgY8OhYyB0aGF5IMSR4buVaSBjb25maWcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHRow7RuZyBiw6FvIGPhuq1wIG5o4bqtdCBjb25maWcgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgICAgIAogICAgICAgICMgSW1wb3J0IGNvbmZpZyDEkeG7gyBs4bqleSBkYW5oIHPDoWNoIHJlc3RhcnQgcmVxdWlyZWQgY29uZmlncwogICAgICAgIGltcG9ydCBjb25maWcgYXMgYXBwX2NvbmZpZwogICAgICAgIHJlc3RhcnRfcmVxdWlyZWRfY29uZmlncyA9IGdldGF0dHIoYXBwX2NvbmZpZywgJ1JFU1RBUlRfUkVRVUlSRURfQ09ORklHUycsIFsKICAgICAgICAgICAgImVuYWJsZWRfYXBwcyIsICJtYXhfam9ic19wZXJfZGF5IiwgIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgCiAgICAgICAgICAgICJqb2JfY29vbGRvd25fbWludXRlcyIsICJ1c2VfcHJveHkiLCAicHJveHlfc2VydmVyIiwgImpvYl9ob3VyIgogICAgICAgIF0pCiAgICAgICAgCiAgICAgICAgbmVlZF9yZXN0YXJ0ID0gRmFsc2UKICAgICAgICAKICAgICAgICBpZiBjb25maWdfY2hhbmdlczoKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHThu6tuZyBjb25maWcgY8OzIGPhuqduIHJlc3RhcnQga2jDtG5nCiAgICAgICAgICAgIGZvciBjb25maWdfa2V5IGluIGNvbmZpZ19jaGFuZ2VzLmtleXMoKToKICAgICAgICAgICAgICAgIGlmIGNvbmZpZ19rZXkgaW4gcmVzdGFydF9yZXF1aXJlZF9jb25maWdzOgogICAgICAgICAgICAgICAgICAgIG5lZWRfcmVzdGFydCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNvbmZpZyB7Y29uZmlnX2tleX0gdGhheSDEkeG7lWksIGPhuqduIHJlc3RhcnQgc2Vzc2lvbiIpCiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIE7hur91IGtow7RuZyBjw7MgdGjDtG5nIHRpbiBjaGkgdGnhur90LCBjb2kgbmjGsCBj4bqnbiByZXN0YXJ0CiAgICAgICAgICAgIG5lZWRfcmVzdGFydCA9IFRydWUKICAgICAgICAgICAgCiAgICAgICAgaWYgbmVlZF9yZXN0YXJ0OgogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbiA9IFRydWUKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkOG6t3QgZmxhZyByZXN0YXJ0IHNlc3Npb24gZG8gY29uZmlnIHRoYXkgxJHhu5VpIikKICAgICAgICAgICAgICAgIAogICAgZGVmIGNoZWNrX2FuZF9oYW5kbGVfc2VydmVyX3VwZGF0ZXMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gY8OhYyBj4bqtcCBuaOG6rXQgdOG7qyBzZXJ2ZXIKICAgICAgICDEkMaw4bujYyBn4buNaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmggdsOgIHRyb25nIF93b3JrX3Nlc3Npb24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIHRp4bq/cCB04bulYywgRmFsc2UgbuG6v3UgY+G6p24gcmVzdGFydCBzZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgZmxhZyByZXN0YXJ0IHNlc3Npb24KICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIHnDqnUgY+G6p3UgcmVzdGFydCBzZXNzaW9uIGRvIGNvbmZpZyB0aGF5IMSR4buVaSIpCiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3Jlc3RhcnRfc2Vzc2lvbiA9IEZhbHNlICAjIFJlc2V0IGZsYWcKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBCw6FvIGhp4buHdSBj4bqnbiByZXN0YXJ0IHNlc3Npb24KICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIFRp4bq/cCB04bulYyBiw6xuaCB0aMaw4budbmcKCiAgICBkZWYgc2h1dGRvd24oc2VsZik6CiAgICAgICAgIiIixJDDs25nIGThu4tjaCB24bulLCBk4burbmcgdOG6pXQgY+G6oyB3b3JrZXIgdGhyZWFkcyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBk4burbmcKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBHaeG6o2kgcGjDs25nIHByb3h5IG7hur91IGPDswogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgICAgICBzZWxmLl9yZWxlYXNlX3Byb3h5X2FmdGVyX3Nlc3Npb24oKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2UgxJHhu4MgdHLDoW5oIGzhu5dpIHRocmVhZAogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdkYicpIGFuZCBzZWxmLmRiOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuY2xvc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSDEkcOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2U6IHtzdHIoZSl9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgc2h1dGRvd24gSm9iU2VydmljZSIpCiAgICAKICAgIGRlZiBfcHJveHlfYXBpX2NhbGwoc2VsZiwgZW5kcG9pbnQ6IHN0ciwgZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBH4buNaSBBUEkgcHJveHkgc2VydmVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZW5kcG9pbnQ6IEVuZHBvaW50IEFQSSAocmVnaXN0ZXIsIHVwZGF0ZSwgdW5yZWdpc3RlciwgcmVzZXQtaXApCiAgICAgICAgICAgIGRhdGE6IEThu68gbGnhu4d1IGfhu61pCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgcmVzcG9uc2UgaG/hurdjIE5vbmUgbuG6v3UgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCByZXF1ZXN0cwogICAgICAgICAgICAKICAgICAgICAgICAgcHJveHlfc2VydmVyID0gc2VsZi5kYi5nZXQoInByb3h5X3NlcnZlciIsICJodHRwOi8vMTAuMC4wLjU6OTAzMiIpCiAgICAgICAgICAgIHVybCA9IGYie3Byb3h5X3NlcnZlcn0ve2VuZHBvaW50fSIKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3BvbnNlID0gcmVxdWVzdHMucG9zdCh1cmwsIGpzb249ZGF0YSwgdGltZW91dD0xMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlLnN0YXR1c19jb2RlID09IDIwMDoKICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIlByb3h5IEFQSSB7ZW5kcG9pbnR9IGZhaWxlZCB3aXRoIHN0YXR1cyB7cmVzcG9uc2Uuc3RhdHVzX2NvZGV9OiB7cmVzcG9uc2UudGV4dH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu41pIFByb3h5IEFQSSB7ZW5kcG9pbnR9OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgX3JlZ2lzdGVyX3Byb3h5KHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDEg25nIGvDvSB24bubaSBwcm94eSBzZXJ2ZXIgxJHhu4MgxJHGsOG7o2MgY+G6pXAgcGjDoXQgdGFibGUKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRxrDhu6NjIGPhuqVwIHRhYmxlIGhv4bq3YyDEkcOjIGPDsyB0YWJsZSwgRmFsc2UgbuG6v3UgdsOgbyBxdWV1ZSBob+G6t2MgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgbG9jYWwgSVAgdOG7qyBoZWxwZXIgc2VydmljZQogICAgICAgICAgICBsb2NhbF9pcCA9IHNlbGYuaGVscGVyLmdldF9sb2NhbF9pcCgpCiAgICAgICAgICAgIGlmIG5vdCBsb2NhbF9pcDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGzhuqV5IGxvY2FsIElQLCBi4buPIHF1YSDEkcSDbmcga8O9IHByb3h5IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgZGF0YSA9IHsibG9jYWxfaXAiOiBsb2NhbF9pcH0KICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLl9wcm94eV9hcGlfY2FsbCgicmVnaXN0ZXIiLCBkYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHJlc3BvbnNlOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc3RhdHVzID0gcmVzcG9uc2UuZ2V0KCJzdGF0dXMiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3RhdHVzID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgICMgxJDGsOG7o2MgY+G6pXAgdGFibGUgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICB0YWJsZV9uYW1lID0gcmVzcG9uc2UuZ2V0KCJkYXRhIiwge30pLmdldCgidGFibGVfbmFtZSIpCiAgICAgICAgICAgICAgICBhY3Rpb24gPSByZXNwb25zZS5nZXQoImRhdGEiLCB7fSkuZ2V0KCJhY3Rpb24iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGUgPSB0YWJsZV9uYW1lCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZSA9IGYie3RhYmxlX25hbWV9IgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzGsHUgcHJveHkgdGFibGUgbmFtZSB2w6BvIGRldmljZSBjb25maWcgxJHhu4MgZ+G7rWkgbMOqbiBzZXJ2ZXIKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2RldmljZV9jb25maWcoInByb3h5X3RhYmxlX25hbWUiLCB0YWJsZV9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlByb3h5IMSRw6MgxJHGsOG7o2MgY+G6pXAgdGFibGU6IHt0YWJsZV9uYW1lfSAoYWN0aW9uOiB7YWN0aW9ufSkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu41pIHJlc2V0LWlwIMSR4buDIMSR4buVaSBJUCBt4bubaQogICAgICAgICAgICAgICAgaWYgdGFibGVfbmFtZToKICAgICAgICAgICAgICAgICAgICBwcG9lX25hbWUgPSB0YWJsZV9uYW1lLnJlcGxhY2UoInRvXyIsICIiKSAgIyBDaHV54buDbiAidG9fcHBwb2UyIiB0aMOgbmggInBwcG9lMiIKICAgICAgICAgICAgICAgICAgICByZXNldF9kYXRhID0geyJwcG9lX25hbWUiOiBmIntwcG9lX25hbWV9In0gCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJlc2V0X3Jlc3BvbnNlID0gc2VsZi5fcHJveHlfYXBpX2NhbGwoInJlc2V0LWlwIiwgcmVzZXRfZGF0YSkKICAgICAgICAgICAgICAgICAgICBpZiByZXNldF9yZXNwb25zZSBhbmQgcmVzZXRfcmVzcG9uc2UuZ2V0KCJzdGF0dXMiKSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyByZXNldCBJUCBjaG8ge3Jlc2V0X2RhdGFbJ3Bwb2VfbmFtZSddfSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgcmVzZXQgSVAgY2hvIHtyZXNldF9kYXRhWydwcG9lX25hbWUnXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsaWYgc3RhdHVzID09ICJxdWV1ZWQiOgogICAgICAgICAgICAgICAgIyBWw6BvIHF1ZXVlIGNo4budCiAgICAgICAgICAgICAgICBxdWV1ZV9wb3NpdGlvbiA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIHt9KS5nZXQoInF1ZXVlX3Bvc2l0aW9uIiwgMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUHJveHkgc2VydmVyIGZ1bGwsIHbDoG8gaMOgbmcgxJHhu6NpIHbhu4sgdHLDrSB7cXVldWVfcG9zaXRpb259IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJQcm94eSByZWdpc3RlciB0aOG6pXQgYuG6oWk6IHtyZXNwb25zZS5nZXQoJ21lc3NhZ2UnLCAnVW5rbm93biBlcnJvcicpfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMSRxINuZyBrw70gcHJveHkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF91cGRhdGVfcHJveHkoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGltZXN0YW1wIHPhu60gZOG7pW5nIHByb3h5CiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB1cGRhdGUgdGjDoG5oIGPDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGxvY2FsIElQIHThu6sgaGVscGVyIHNlcnZpY2UKICAgICAgICAgICAgbG9jYWxfaXAgPSBzZWxmLmhlbHBlci5nZXRfbG9jYWxfaXAoKQogICAgICAgICAgICBpZiBub3QgbG9jYWxfaXA6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGzhuqV5IGxvY2FsIElQLCBi4buPIHF1YSB1cGRhdGUgcHJveHkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBkYXRhID0geyJsb2NhbF9pcCI6IGxvY2FsX2lwfQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuX3Byb3h5X2FwaV9jYWxsKCJ1cGRhdGUiLCBkYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3RhdHVzIikgPT0gInN1Y2Nlc3MiOgogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9sYXN0X3VwZGF0ZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICAjIExvZyB0aMO0bmcgdGluIHThu6sgcmVzcG9uc2UgbuG6v3UgY8OzCiAgICAgICAgICAgICAgICBkYXRhID0gcmVzcG9uc2UuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgICAgICB0YWJsZV9uYW1lID0gZGF0YS5nZXQoInRhYmxlX25hbWUiLCAidW5rbm93biIpCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJQcm94eSB1cGRhdGUgdGjDoG5oIGPDtG5nIGNobyB0YWJsZToge3RhYmxlX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlByb3h5IHVwZGF0ZSB0aOG6pXQgYuG6oWk6IHtyZXNwb25zZS5nZXQoJ21lc3NhZ2UnKSBpZiByZXNwb25zZSBlbHNlICdObyByZXNwb25zZSd9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB1cGRhdGUgcHJveHk6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3VucmVnaXN0ZXJfcHJveHkoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBI4buneSDEkcSDbmcga8O9IHbDoCBnaeG6o2kgcGjDs25nIHRhYmxlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB1bnJlZ2lzdGVyIHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBM4bqleSBsb2NhbCBJUCB04burIGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGxvY2FsX2lwID0gc2VsZi5oZWxwZXIuZ2V0X2xvY2FsX2lwKCkKICAgICAgICAgICAgaWYgbm90IGxvY2FsX2lwOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyBs4bqleSBsb2NhbCBJUCwgYuG7jyBxdWEgdW5yZWdpc3RlciBwcm94eSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGRhdGEgPSB7ImxvY2FsX2lwIjogbG9jYWxfaXB9CiAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5fcHJveHlfYXBpX2NhbGwoInVucmVnaXN0ZXIiLCBkYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3RhdHVzIikgPT0gInN1Y2Nlc3MiOgogICAgICAgICAgICAgICAgcmVsZWFzZWRfdGFibGUgPSByZXNwb25zZS5nZXQoImRhdGEiLCB7fSkuZ2V0KCJyZWxlYXNlZF90YWJsZSIpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdW5yZWdpc3RlciBwcm94eSB2w6AgZ2nhuqNpIHBow7NuZyB0YWJsZToge3JlbGVhc2VkX3RhYmxlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaSBwcm94eQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlID0gTm9uZQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X25hbWUgPSBOb25lCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X2xhc3RfdXBkYXRlID0gMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFjDs2EgcHJveHkgdGFibGUgbmFtZSBraOG7j2kgZGV2aWNlIGNvbmZpZwogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfZGV2aWNlX2NvbmZpZygicHJveHlfdGFibGVfbmFtZSIsIE5vbmUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlByb3h5IHVucmVnaXN0ZXIgdGjhuqV0IGLhuqFpOiB7cmVzcG9uc2UuZ2V0KCdtZXNzYWdlJykgaWYgcmVzcG9uc2UgZWxzZSAnTm8gcmVzcG9uc2UnfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgdW5yZWdpc3RlciBwcm94eToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfY2hlY2tfcHJveHlfcmVxdWlyZW1lbnQoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCDEkcSDbmcga8O9IHByb3h5IG7hur91IGPhuqduCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgcHJveHkgaG/hurdjIGtow7RuZyBj4bqnbiBwcm94eSwgRmFsc2UgbuG6v3UgY+G6p24gcHJveHkgbmjGsG5nIGNoxrBhIMSRxrDhu6NjIGPhuqVwCiAgICAgICAgIiIiCiAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgIAogICAgICAgIGlmIG5vdCB1c2VfcHJveHk6CiAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBj4bqnbiBwcm94eQogICAgICAgICAgICAKICAgICAgICAjIE7hur91IMSRw6MgY8OzIHRhYmxlIHRow6wgcmV0dXJuIFRydWUKICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICMgQ2jGsGEgY8OzIHRhYmxlLCB0aOG7rSDEkcSDbmcga8O9CiAgICAgICAgcmV0dXJuIHNlbGYuX3JlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgCiAgICBkZWYgX2dldF9wcm94eV9kaXNwbGF5X25hbWUoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHTDqm4gaGnhu4NuIHRo4buLIGNobyBwcm94eSBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFTDqm4gaGnhu4NuIHRo4buLIGPhu6dhIHByb3h5CiAgICAgICAgIiIiCiAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X25hbWU6CiAgICAgICAgICAgIHJldHVybiBzZWxmLmN1cnJlbnRfcHJveHlfbmFtZQogICAgICAgIGVsaWYgc2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlOgogICAgICAgICAgICByZXR1cm4gZiJ7c2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlfSIKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gIlVua25vd24iCiAgICAgICAgICAgIAogICAgZGVmIF9zZXR1cF9wcm94eV9mb3Jfc2Vzc2lvbihzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRoaeG6v3QgbOG6rXAgcHJveHkgY2hvIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGhp4bq/dCBs4bqtcCB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgICMgTuG6v3UgxJHDoyBjw7MgdGFibGUgcHJveHkgdGjDrCBzZXR1cCB4b25nIHLhu5NpCiAgICAgICAgaWYgc2VsZi5jdXJyZW50X3Byb3h5X3RhYmxlOgogICAgICAgICAgICBwcm94eV9uYW1lID0gc2VsZi5fZ2V0X3Byb3h5X2Rpc3BsYXlfbmFtZSgpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUHJveHkge3Byb3h5X25hbWV9IMSRw6Mgc+G6tW4gc8OgbmcgY2hvIHBoacOqbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgY2jGsGEgY8OzIHRow6wgxJHEg25nIGvDvQogICAgICAgIHJldHVybiBzZWxmLl9yZWdpc3Rlcl9wcm94eSgpCiAgICBkZWYgX3JlbGVhc2VfcHJveHlfYWZ0ZXJfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiJHaeG6o2kgcGjDs25nIHByb3h5IHNhdSBraGkga+G6v3QgdGjDumMgcGhpw6puIGzDoG0gdmnhu4djIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgICAgICBwcm94eV9uYW1lID0gc2VsZi5fZ2V0X3Byb3h5X2Rpc3BsYXlfbmFtZSgpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGdp4bqjaSBwaMOzbmcgcHJveHkge3Byb3h5X25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBH4buNaSBBUEkgdW5yZWdpc3RlcgogICAgICAgICAgICAgICAgaWYgc2VsZi5fdW5yZWdpc3Rlcl9wcm94eSgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBnaeG6o2kgcGjDs25nIHByb3h5IHtwcm94eV9uYW1lfSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkdp4bqjaSBwaMOzbmcgcHJveHkge3Byb3h5X25hbWV9IHRo4bqldCBi4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGdp4bqjaSBwaMOzbmcgcHJveHkiKQogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGdp4bqjaSBwaMOzbmcgcHJveHkge3NlbGYuY3VycmVudF9wcm94eV9uYW1lIG9yIHNlbGYuY3VycmVudF9wcm94eV9pZCBvciAndW5rbm93bid9IikKICAgICAgICAgICAgCiAgICAjIERFUFJFQ0FURUQ6IEtow7RuZyBkw7luZyBu4buvYSwgdGhheSBi4bqxbmcgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoKQogICAgIyBkZWYgX2hhc19hY2NvdW50c19yZWFkeV9mb3Jfd29yayhzZWxmKSAtPiBib29sOgogICAgIyAgICAgIiIiCiAgICAjICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAjICAgICAKICAgICMgICAgIFJldHVybnM6CiAgICAjICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgIyAgICAgIiIiCiAgICAjICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICMgICAgIAogICAgIyAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICMgICAgICAgICBpZiBzZWxmLmlzX2FjY291bnRfY2FuX3J1bl9qb2IoYXBwX25hbWUpOgogICAgIyAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIF9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB04burIHThuqV0IGPhuqMgYXBwIHbDoCBz4bqvcCB44bq/cCB0aGVvIGFwcCwgbmfDoHkgdOG6oW8KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBz4bqvcCB44bq/cAogICAgICAgICIiIgogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq/bSBz4buRIGzGsOG7o25nIHTDoGkga2hv4bqjbiB0aGVvIHRy4bqhbmcgdGjDoWkKICAgICAgICAgICAgc3RhdHVzX2NvdW50cyA9IHt9CiAgICAgICAgICAgIGZvciBhY2MgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBzdGF0dXMgPSBhY2MuZ2V0KCdzdGF0dXMnLCAnYWN0aXZlJykKICAgICAgICAgICAgICAgIHN0YXR1c19jb3VudHNbc3RhdHVzXSA9IHN0YXR1c19jb3VudHMuZ2V0KHN0YXR1cywgMCkgKyAxCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZyB0aOG7kW5nIGvDqiB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgIHN0YXR1c19pbmZvID0gIiwgIi5qb2luKFtmIntzdGF0dXN9OiB7Y291bnR9IiBmb3Igc3RhdHVzLCBjb3VudCBpbiBzdGF0dXNfY291bnRzLml0ZW1zKCldKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YXBwX25hbWV9IC0ge3N0YXR1c19pbmZvfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhu41jIGPDoWMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHtsZW4od29ya2FibGVfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5leHRlbmQod29ya2FibGVfYWNjb3VudHMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyB7YXBwX25hbWV9IikKICAgICAgICAKICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW86CiAgICAgICAgIyAxLiBBcHAgbmFtZSAoxJHhu4MgbmjDs20gY8O5bmcgYXBwIGzhuqFpIHbhu5tpIG5oYXUpCiAgICAgICAgIyAyLiBOZ8OgeSB04bqhbyB0w6BpIGtob+G6o24gKGNyZWF0ZWRfYXQpIC0gY8WpIG5o4bqldCB0csaw4bubYwogICAgICAgICMgMy4gU+G7kSBqb2IgxJHDoyBsw6BtIHRyb25nIHBoacOqbiAow610IG5o4bqldCB0csaw4bubYykKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgeC5nZXQoImNyZWF0ZWRfYXQiLCAwKSwKICAgICAgICAgICAgeC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICApKQogICAgICAgIAogICAgICAgIHJldHVybiBhbGxfd29ya2FibGVfYWNjb3VudHMKICAgICAgICAKICAgIGRlZiBfd29ya19zZXNzaW9uKHNlbGYsIGFsbF93b3JrYWJsZV9hY2NvdW50czogTGlzdFtEaWN0W3N0ciwgQW55XV0gPSBOb25lKToKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIG3hu5l0IHBoacOqbiBsw6BtIHZp4buHYyBob8OgbiBjaOG7iW5oIHbhu5tpIGPGoSBjaOG6vyBt4bubaSIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAKICAgICAgICAjIMSQw6FuaCBk4bqldSDEkWFuZyB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX1dPUktJTkdfU0VTU0lPTikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHRydXnhu4FuIGRhbmggc8OhY2ggdMOgaSBraG/huqNuLCBs4bqleSBs4bqhaSB04burIGRhdGFiYXNlCiAgICAgICAgICAgIGlmIGFsbF93b3JrYWJsZV9hY2NvdW50cyBpcyBOb25lOgogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gc2VsZi5fZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB7bGVuKGFsbF93b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gdmnhu4djIHR14bqnbiB04buxIHbhu5tpIHThu6tuZyB0w6BpIGtob+G6o24KICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWxsX3dvcmthYmxlX2FjY291bnRzOgogICAgICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlciB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBj4bqtcCBuaOG6rXQgY29uZmlnIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5jaGVja19hbmRfaGFuZGxlX3NlcnZlcl91cGRhdGVzKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiB5w6p1IGPhuqd1IHJlc3RhcnQgc2Vzc2lvbiBkbyBjb25maWcgdGhheSDEkeG7lWkgdHJvbmcgcGhpw6puIGzDoG0gdmnhu4djIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gICMgVGhvw6F0IGto4buPaSBfd29ya19zZXNzaW9uIMSR4buDIHJlc3RhcnQgdOG7qyBydW4oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldCB04burIGRhdGFiYXNlCiAgICAgICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBu4bq/dSBzZXJ2ZXIgecOqdSBj4bqndQogICAgICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhhcHBfbmFtZSk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTZXJ2ZXIgecOqdSBj4bqndSDEkeG7k25nIGLhu5kgbOG6oWkgdMOgaSBraG/huqNuIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRzX2Zvcl9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBs4bqhaSB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiBzYXUga2hpIMSR4buTbmcgYuG7mQogICAgICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IGFjY291bnQgb3Igbm90IHNlbGYuX2Nhbl9ydW5fam9iKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBhY2NvdW50X3Jlc3VsdCA9IHNlbGYuX3dvcmtfYWNjb3VudF9zZXNzaW9uKGFjY291bnQsIGhhbmRsZXIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDs25nIGFwcCBzYXUga2hpIGzDoG0geG9uZyB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGhhbmRsZXIuY2xvc2VfYXBwKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMw6BtIGNoxINtIHPDs2Mgc2F1IGtoaSBo4bq/dCBqb2IgKG7hur91IMSRxrDhu6NjIGLhuq10KQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGNhcmVfaW5fd29ya2luZ19qb2IgPSBzZWxmLmRiLmdldCgiY2FyZV9pbl93b3JraW5nX2pvYiIsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIGlmIGNhcmVfaW5fd29ya2luZ19qb2IgYW5kIGhhc2F0dHIoaGFuZGxlciwgInBlcmZvcm1fY2FyZSIpIGFuZCBjYWxsYWJsZShoYW5kbGVyLnBlcmZvcm1fY2FyZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBjaMSDbSBzw7NjIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnBlcmZvcm1fY2FyZShhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIGVsaWYgbm90IGNhcmVfaW5fd29ya2luZ19qb2I6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkNoxINtIHPDs2MgYuG7iyB04bqvdCwgYuG7jyBxdWEgY2jEg20gc8OzYyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBjaMSDbSBzw7NjIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBi4buLIGdpw6FuIMSRb+G6oW4sIGThu6tuZyBwaGnDqm4KICAgICAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50X3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMpOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGvhur90IHRow7pjIHBoacOqbiBsw6BtIHZp4buHYwogICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgCiAgICAjIERFUFJFQ0FURUQ6IFBoxrDGoW5nIHRo4bupYyBuw6B5IGtow7RuZyBkw7luZyBu4buvYSBkbyBjaHV54buDbiBzYW5nIGPGoSBjaOG6vyBt4bubaQogICAgIyBkZWYgX3dvcmtfd2l0aF9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICMgICAgICIiIgogICAgIyAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICMgICAgIAogICAgIyAgICAgQXJnczoKICAgICMgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAgY+G6p24gbMOgbSB2aeG7h2MKICAgICMgICAgICAgICAKICAgICMgICAgIFJldHVybnM6CiAgICAjICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBob8OgbiB0aMOgbmgsIEZhbHNlIG7hur91IGLhu4sgZ2nDoW4gxJFv4bqhbgogICAgIyAgICAgIiIiCiAgICAjICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBsw6BtIHZp4buHYyB24bubaSB7YXBwX25hbWV9IikKICAgICMgICAgIAogICAgIyAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgIyAgICAgCiAgICAjICAgICAjIEzDoG0gdmnhu4djIHR14bqnbiB04buxIHbhu5tpIHThu6tuZyB0w6BpIGtob+G6o24gKHJlYWwtdGltZSByZWxvYWQpCiAgICAjICAgICB3aGlsZSBUcnVlOgogICAgIyAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICMgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9zdG9wIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAjICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICMgICAgICAgICAgICAgICAgIAogICAgIyAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgIyAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAjICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUGjDoXQgaGnhu4duIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIGtoaSBsw6BtIHZp4buHYyB24bubaSB7YXBwX25hbWV9IikKICAgICMgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAjICAgICAgICAgCiAgICAjICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBt4bubaSBuaOG6pXQgKGPDsyB0aOG7gyB0aGF5IMSR4buVaSB04burIHNlcnZlcikKICAgICMgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICMgICAgICAgICAKICAgICMgICAgICAgICAjIEzhu41jIGPDoWMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgIyAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAjICAgICAgICAgCiAgICAjICAgICAgICAgaWYgbm90IHdvcmthYmxlX2FjY291bnRzOgogICAgIyAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyB7YXBwX25hbWV9IikKICAgICMgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICMgICAgICAgICAgICAgCiAgICAjICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiBjw7Mgam9ic19kb25lX2luX3Nlc3Npb24gdGjhuqVwIG5o4bqldCDEkeG7gyBsw6BtIHZp4buHYwogICAgIyAgICAgICAgIHdvcmthYmxlX2FjY291bnRzLnNvcnQoa2V5PWxhbWJkYSB4OiB4LmdldCgnam9ic19kb25lX2luX3Nlc3Npb24nLCAwKSkKICAgICMgICAgICAgICBhY2NvdW50ID0gd29ya2FibGVfYWNjb3VudHNbMF0KICAgICMgICAgICAgICAKICAgICMgICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBsw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgICMgQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24gbsOgeQogICAgIyAgICAgICAgIHN3aXRjaF9yZXN1bHQgPSBoYW5kbGVyLnN3aXRjaF90b19hY2NvdW50KGFjY291bnQpCiAgICAjICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQ6CiAgICAjICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAjICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBuw6B5IGPDsyB24bqlbiDEkeG7gSB2w6AgdGjhu60gdMOgaSBraG/huqNuIGtow6FjCiAgICAjICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoYWNjb3VudFsiaWQiXSwgaW5hY3RpdmVfcmVhc29uPSJM4buXaSBjaHV54buDbiB0w6BpIGtob+G6o24iKQogICAgIyAgICAgICAgICAgICBjb250aW51ZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgICAgICAjIEzDoG0gxJHhu6cgc+G7kSBqb2IgdHJvbmcgcGhpw6puIGNobyB0w6BpIGtob+G6o24gbsOgeQogICAgIyAgICAgICAgIGFjY291bnRfcmVzdWx0ID0gc2VsZi5fd29ya19hY2NvdW50X3Nlc3Npb24oYWNjb3VudCwgaGFuZGxlcikKICAgICMgICAgICAgICAKICAgICMgICAgICAgICAjIEzDoG0gY2jEg20gc8OzYyBzYXUga2hpIGjhur90IGpvYgogICAgIyAgICAgICAgIHRyeToKICAgICMgICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICMgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiBjaMSDbSBzw7NjIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgIyAgICAgICAgICAgICAgICAgaGFuZGxlci5wZXJmb3JtX2NhcmUoYWNjb3VudCkKICAgICMgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAjICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9OiB7ZX0iKQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgICAgICAjIE7hur91IGLhu4sgZ2nDoW4gxJFv4bqhbiwgcmV0dXJuIEZhbHNlCiAgICAjICAgICAgICAgaWYgbm90IGFjY291bnRfcmVzdWx0OgogICAgIyAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICMgICAgICAgICAgICAgCiAgICAjICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICMgICAgICAgICAjIChjw7MgdGjhu4MgY8OzIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyIHRyb25nIGzDumMgbMOgbSB2aeG7h2MpCiAgICAjICAgICAgICAgdXBkYXRlZF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICMgICAgICAgICByZW1haW5pbmdfd29ya2FibGUgPSBbYWNjIGZvciBhY2MgaW4gdXBkYXRlZF9hY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgIyAgICAgICAgIAogICAgIyAgICAgICAgIGlmIG5vdCByZW1haW5pbmdfd29ya2FibGU6CiAgICAjICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBob8OgbiB0aMOgbmggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyB7YXBwX25hbWV9IikKICAgICMgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgZGVmIF93b3JrX2FjY291bnRfc2Vzc2lvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlcikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMw6BtIHZp4buHYyB24bubaSBt4buZdCB0w6BpIGtob+G6o24gdHJvbmcgcGhpw6puCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBob8OgbiB0aMOgbmgsIEZhbHNlIG7hur91IGLhu4sgZ2nDoW4gxJFv4bqhbgogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICBqb2JzX2RvbmUgPSAwCiAgICAgICAgY2FyZV9jb3VudGVyID0gMAogICAgICAgIGNvbmZpZ19yZWxvYWRfY291bnRlciA9IDAgICMgxJDhur9tIMSR4buDIHJlbG9hZCBj4bqldSBow6xuaCDEkeG7i25oIGvhu7MKICAgICAgICBub19qb2JfY291bnQgPSAwICAjIMSQ4bq/bSBz4buRIGzhuqduIGtow7RuZyBs4bqleSDEkcaw4bujYyBqb2IgbGnDqm4gdGnhur9wCiAgICAgICAgbWF4X25vX2pvYl9hdHRlbXB0cyA9IDMgICMgU+G7kSBs4bqnbiB04buRaSDEkWEgdGjhu60gbOG6pXkgam9iIGtoaSBraMO0bmcgY8OzCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiJMw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICBpZiBub3Qgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgcGjhuqNpIGRvIHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dCBraMO0bmcKICAgICAgICAgICAgIyBO4bq/dSBoYW5kbGVyIGPDsyBtZXRob2QgY2hlY2tfYWNjb3VudF9leGlzdHMsIHPhu60gZOG7pW5nIG7DswogICAgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICdjaGVja19hY2NvdW50X2V4aXN0cycpIGFuZCBjYWxsYWJsZShoYW5kbGVyLmNoZWNrX2FjY291bnRfZXhpc3RzKToKICAgICAgICAgICAgICAgIGlmIG5vdCBoYW5kbGVyLmNoZWNrX2FjY291bnRfZXhpc3RzKGFjY291bnQpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBi4buLIGxvZ291dCwgxJHDoW5oIGThuqV1IHRy4bqhbmcgdGjDoWkgbG9nb3V0IikKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogIlTDoGkga2hv4bqjbiDEkcOjIGLhu4sgbG9nb3V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgUmV0dXJuIFRydWUgxJHhu4MgdGnhur9wIHThu6VjIHbhu5tpIHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbwogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgY8OzIG1ldGhvZCBjaGVja19hY2NvdW50X2V4aXN0cyBob+G6t2MgbOG7l2kga2jDoWMsIMSRw6FuaCBk4bqldSBpbmFjdGl2ZQogICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0iTOG7l2kgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgUmV0dXJuIFRydWUgxJHhu4MgdGnhur9wIHThu6VjIHbhu5tpIHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbwogICAgICAgIAogICAgICAgIHdoaWxlIFRydWU6CiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMdcO0biByZWxvYWQgYWNjb3VudCDhu58gxJHhuqd1IHbDsm5nIGzhurdwIMSR4buDIMSR4bqjbSBi4bqjbyBk4buvIGxp4buHdSBt4bubaSBuaOG6pXQgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSBzYXUga2hpIHJlbG9hZCwgZOG7q25nIHNlc3Npb24iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBjaOG6oXkgam9iIGtow7RuZyBzYXUga2hpIHJlbG9hZAogICAgICAgICAgICBpZiBub3Qgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGtow7RuZyB0aOG7gyBjaOG6oXkgam9iIG7hu69hIHNhdSBraGkgcmVsb2FkIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB5w6p1IGPhuqd1IHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICBpZiBzZWxmLmRiLmdldCgicGF1c2Vfam9iIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJQaMOhdCBoaeG7h24gecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIga2hpIGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBj4bqtcCBuaOG6rXQgY29uZmlnIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmNoZWNrX2FuZF9oYW5kbGVfc2VydmVyX3VwZGF0ZXMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUGjDoXQgaGnhu4duIHnDqnUgY+G6p3UgcmVzdGFydCBzZXNzaW9uIGRvIGNvbmZpZyB0aGF5IMSR4buVaSBraGkgbMOgbSB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRob8OhdCDEkeG7gyByZXN0YXJ0IHNlc3Npb24KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBVcGRhdGUgcHJveHkgdGltZXN0YW1wIG3hu5dpIDIwIGdpw6J5IG7hur91IMSRYW5nIHPhu60gZOG7pW5nIHByb3h5CiAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLmN1cnJlbnRfcHJveHlfdGFibGU6CiAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgaWYgY3VycmVudF90aW1lIC0gc2VsZi5wcm94eV9sYXN0X3VwZGF0ZSA+PSAyMDoKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl91cGRhdGVfcHJveHkoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCLEkMOjIHVwZGF0ZSBwcm94eSB0aW1lc3RhbXAiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJVcGRhdGUgcHJveHkgdGltZXN0YW1wIHRo4bqldCBi4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVsb2FkIGPhuqV1IGjDrG5oIHTDoGkga2hv4bqjbiB04burIGRhdGFiYXNlIG3hu5dpIDUgam9iIMSR4buDIHBo4bqjbiDDoW5oIHRoYXkgxJHhu5VpIHThu6sgc2VydmVyCiAgICAgICAgICAgIGNvbmZpZ19yZWxvYWRfY291bnRlciArPSAxCiAgICAgICAgICAgIGlmIGNvbmZpZ19yZWxvYWRfY291bnRlciA+PSA1OgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUmVsb2FkIGPhuqV1IGjDrG5oIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IHThu6sgZGF0YWJhc2UgKMSRw6MgcmVsb2FkIOG7nyDEkeG6p3UgdsOybmcgbOG6t3ApIikKICAgICAgICAgICAgICAgIGNvbmZpZ19yZWxvYWRfY291bnRlciA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gcGhpw6puIGhp4buHbiB04bqhaQogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBqb2JzX2RvbmVfaW5fc2Vzc2lvbiA+PSBtYXhfam9ic19wZXJfc2Vzc2lvbjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBob8OgbiB0aMOgbmggxJHhu6cgam9iIHRyb25nIHBoacOqbiAoe2pvYnNfZG9uZV9pbl9zZXNzaW9ufS97bWF4X2pvYnNfcGVyX3Nlc3Npb259KSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgTOG6pXkgam9iCiAgICAgICAgICAgICAgICBqb2IgPSBoYW5kbGVyLmZldGNoX2pvYihhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3Qgam9iOgogICAgICAgICAgICAgICAgICAgIG5vX2pvYl9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaMO0bmcgY8OzIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gKGzhuqduIHtub19qb2JfY291bnR9L3ttYXhfbm9fam9iX2F0dGVtcHRzfSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIGzhuqV5IMSRxrDhu6NjIGpvYiBxdcOhIG5oaeG7gXUgbOG6p24sIGThu6tuZyBwaGnDqm4gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgICAgICBpZiBub19qb2JfY291bnQgPj0gbWF4X25vX2pvYl9hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBraMO0bmcgbOG6pXkgxJHGsOG7o2Mgam9iIHNhdSB7bWF4X25vX2pvYl9hdHRlbXB0c30gbOG6p24gdGjhu60sIGThu6tuZyBwaGnDqm4gbMOgbSB2aeG7h2MiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmdo4buJIG3hu5l0IGNow7p0IHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnJhbmRpbnQoMTAsIDIwKSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBraGkgbOG6pXkgxJHGsOG7o2Mgam9iCiAgICAgICAgICAgICAgICBub19qb2JfY291bnQgPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZQogICAgICAgICAgICAgICAgbGluayA9IGpvYi5nZXQoJ2xpbmsnLCAnJykKICAgICAgICAgICAgICAgIGlmIGxpbmsuc3RhcnRzd2l0aCgnaHR0cHM6Ly93d3cuaW5zdGFncmFtLmNvbS8nKToKICAgICAgICAgICAgICAgICAgICBsaW5rID0gbGluay5yZXBsYWNlKCdodHRwczovL3d3dy5pbnN0YWdyYW0uY29tLycsICcnKQogICAgICAgICAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgICAgICAgICAgbGluayA9IGxpbmsucmVwbGFjZSgnaHR0cHM6Ly93d3cudGlrdG9rLmNvbS8nLCAnJykKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7dXNlcm5hbWV9XVt7am9iLmdldCgndHlwZScpfV1be2xpbmt9XSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVmFsaWRhdGUgam9iCiAgICAgICAgICAgICAgICB2YWxpZGF0aW9uX3Jlc3VsdCA9IGhhbmRsZXIudmFsaWRhdGVfam9iX2JlZm9yZV9leGVjdXRpb24oYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJ2YWxpZCIsIFRydWUpOgogICAgICAgICAgICAgICAgICAgIGlmIHZhbGlkYXRpb25fcmVzdWx0LmdldCgic2hvdWxkX3NraXAiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgU2tpcCBqb2IKICAgICAgICAgICAgICAgICAgICAgICAgc2tpcF9tZXNzYWdlID0gdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIkpvYiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU2tpcCBqb2I6IHtza2lwX21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHNraXBfbWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNraXAgam9iIGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBHacOjbiB0aOG7nWkgZ2lhbiBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIGzhuqV5L2jhu6d5IGpvYiBsacOqbiB04bulYwogICAgICAgICAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOZ2jhu4kge3NraXBfc2xlZXBfdGltZX1zIHNhdSBraGkgc2tpcCBqb2IgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hzoge3ZhbGlkYXRpb25fcmVzdWx0LmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgICAgICAgICBqb2JfcmVzdWx0ID0gaGFuZGxlci5leGVjdXRlX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgWOG7rSBsw70ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIGpvYl9zdGF0dXMgPSBqb2JfcmVzdWx0WyJzdGF0dXMiXQogICAgICAgICAgICAgICAgam9iX3N1Y2Nlc3MgPSBqb2JfcmVzdWx0WyJzdWNjZXNzIl0KICAgICAgICAgICAgICAgIGpvYl9tZXNzYWdlID0gam9iX3Jlc3VsdFsibWVzc2FnZSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgWOG7rSBsw70gbOG7l2kgZm9sbG93IHBlbmRpbmcKICAgICAgICAgICAgICAgIGlmIGpvYl9zdGF0dXMgPT0gNCBhbmQgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICAgICAgICAgIGNudCA9IHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzLmdldChhY2NvdW50WyJpZCJdLCAwKSArIDEKICAgICAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IGNudAogICAgICAgICAgICAgICAgICAgIGlmIGNudCA+PSA1OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgNSBs4bqnbiBsacOqbiB0aeG6v3AgZm9sbG93IHBlbmRpbmcsIHThuqFtIGThu6tuZyB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKGFjY291bnRbImlkIl0sIGluYWN0aXZlX3JlYXNvbj0iTGnDqm4gdGnhur9wIGzhu5dpIGZvbGxvdyBwZW5kaW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mb2xsb3dfcGVuZGluZ19jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbGlmIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsOhbyBjw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCBqb2JfcmVzdWx0KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqgogICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2pvYl9zdGF0cyhhY2NvdW50LCBqb2Jfc3VjY2Vzcywgam9iLmdldCgidHlwZSIsICIiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSZWxvYWQgYWNjb3VudCBzYXUga2hpIHVwZGF0ZSDEkeG7gyBjw7MgZOG7ryBsaeG7h3UgbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkvhur90IHF14bqjIGpvYiB7am9ic19kb25lX2luX3Nlc3Npb259L3ttYXhfam9ic19wZXJfc2Vzc2lvbn06IHtqb2JfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENo4buJIHTEg25nIGNhcmVfY291bnRlciBraGkgam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgaWYgam9iX3N1Y2Nlc3M6CiAgICAgICAgICAgICAgICAgICAgam9ic19kb25lICs9IDEKICAgICAgICAgICAgICAgICAgICBjYXJlX2NvdW50ZXIgKz0gMQogICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIENoxINtIHPDs2Mgc2F1IG3hu5dpIDMtNSBqb2IgdGjDoG5oIGPDtG5nIChyYW5kb20pCiAgICAgICAgICAgICAgICAgICAgIyBpZiBjYXJlX2NvdW50ZXIgPj0gcmFuZG9tLnJhbmRpbnQoMywgNSk6CiAgICAgICAgICAgICAgICAgICAgIyAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgICAgICAgICBpZiBoYXNhdHRyKGhhbmRsZXIsICJwZXJmb3JtX2NhcmUiKSBhbmQgY2FsbGFibGUoaGFuZGxlci5wZXJmb3JtX2NhcmUpOgogICAgICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgbmjhurkgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBjYXJlX2NvdW50ZXIgPSAwCiAgICAgICAgICAgICAgICAgICAgIyAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICMgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBjaMSDbSBzw7NjIG5o4bq5OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6r24gZ2nhu69hIGPDoWMgam9iCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS5yYW5kaW50KDIsIDUpKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfc3RhcnRfc2Vzc2lvbl9jb29sZG93bihzZWxmKToKICAgICAgICAiIiJC4bqvdCDEkeG6p3UgdGjhu51pIGdpYW4gbmdo4buJIGdp4buvYSBjw6FjIHBoacOqbiIiIgogICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmRiLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCA2MCkKICAgICAgICBzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgPSBpbnQodGltZS50aW1lKCkpICsgKGNvb2xkb3duX21pbnV0ZXMgKiA2MCkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSBuZ2jhu4kgbmfGoWkge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IGdp4buvYSBjw6FjIHBoacOqbiIpCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgZiJ7Sm9iU2VydmljZUNvbnN0YW50cy5NU0dfU0VTU0lPTl9DT09MRE9XTn0gKHtjb29sZG93bl9taW51dGVzfSBwaMO6dCkiKQogICAgICAgIAogICAgICAgICMgQuG6pW0gbsO6dCBIb21lIHbDoCBt4bufIFRlcm11eCBraGkgYuG6r3QgxJHhuqd1IG5naOG7iSBuZ8ahaQogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkLhuqVtIG7DunQgSG9tZSB2w6AgbeG7nyBUZXJtdXggxJHhu4Mgbmdo4buJIG5nxqFpIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQuG6pW0gbsO6dCBIb21lCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2hvbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7nSBt4buZdCBjaMO6dCBy4buTaSBt4bufIFRlcm11eAogICAgICAgICAgICB0aW1lLnNsZWVwKDIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fYXBwKCJjb20udGVybXV4IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBi4bqlbSBIb21lIHbDoCBt4bufIFRlcm11eDoge2V9IikKICAgICAgICAKICAgIGRlZiBfaXNfaW5fc2Vzc2lvbl9jb29sZG93bihzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBuZ2jhu4kgZ2nhu69hIGPDoWMgcGhpw6puIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJFhbmcgdHJvbmcgdGjhu51pIGdpYW4gbmdo4buJCiAgICAgICAgIiIiCiAgICAgICAgIyBO4bq/dSBjw7MgecOqdSBj4bqndSByZXN0YXJ0IHNlc3Npb24sIGLhu48gcXVhIGNvdW50ZG93bgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9yZXN0YXJ0X3Nlc3Npb246CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgcmVzdGFydCBzZXNzaW9uLCBi4buPIHF1YSB0aOG7nWkgZ2lhbiBuZ2jhu4kiKQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lIDw9IDA6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB0aOG7nWkgZ2lhbiBjb29sZG93biBoaeG7h24gdOG6oWkKICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgaWYgY3VycmVudF90aW1lIDwgc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lOgogICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoc2VsZi5wcm94eV9zZXNzaW9uX2VuZF90aW1lIC0gY3VycmVudF90aW1lKSAvIDYwKQogICAgICAgICAgICByZW1haW5pbmdfc2Vjb25kcyA9IChzZWxmLnByb3h5X3Nlc3Npb25fZW5kX3RpbWUgLSBjdXJyZW50X3RpbWUpICUgNjAKICAgICAgICAgICAgaWYgcmVtYWluaW5nX21pbnV0ZXMgPiAwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0IHtyZW1haW5pbmdfc2Vjb25kc30gZ2nDonkgbmdo4buJIG5nxqFpIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPDsm4ge3JlbWFpbmluZ19zZWNvbmRzfSBnacOieSBuZ2jhu4kgbmfGoWkiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGjhur90IHRo4budaSBnaWFuIG5naOG7iSBuZ8ahaSwgYuG6r3QgxJHhuqd1IHBoacOqbiBsw6BtIHZp4buHYyBt4bubaSIpCiAgICAgICAgICAgIHNlbGYucHJveHlfc2Vzc2lvbl9lbmRfdGltZSA9IDAKICAgICAgICAgICAgcmV0dXJuIEZhbHNl').decode('utf-8'))
