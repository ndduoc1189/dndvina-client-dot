import base64
exec(base64.b64decode('aW1wb3J0IHBhaG8ubXF0dC5jbGllbnQgYXMgbXF0dAppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBqc29uCmltcG9ydCB0aW1lCmltcG9ydCB1dWlkCmltcG9ydCBvcwpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbCwgQ2FsbGFibGUsIFVuaW9uCmltcG9ydCBjb25maWcKaW1wb3J0IHV0aWxzCmltcG9ydCBzb2NrZXQKaW1wb3J0IHJhbmRvbQppbXBvcnQgc3VicHJvY2VzcwoKIyBMb2dnZXIKbG9nZ2VyID0gdXRpbHMuZ2V0X2xvZ2dlcigiTVFUVFNlcnZpY2UiKQoKY2xhc3MgTVFUVFNlcnZpY2U6CiAgICBkZWYgX19pbml0X18oc2VsZiwgZGJfc2VydmljZSwgZGV2aWNlX2lkLCBoZWxwZXJfc2VydmljZT1Ob25lLCBqb2Jfc2VydmljZT1Ob25lKToKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIHNlcnZpY2UKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyX3NlcnZpY2UgPSBoZWxwZXJfc2VydmljZQogICAgICAgIHNlbGYuam9iX3NlcnZpY2UgPSBqb2Jfc2VydmljZSAgIyBUaMOqbSByZWZlcmVuY2UgxJHhur9uIEpvYlNlcnZpY2UKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIE1RVFQKICAgICAgICBzZWxmLmNsaWVudF9pZCA9IGYie2NvbmZpZy5NUVRUX0NMSUVOVF9JRF9QUkVGSVh9X3tyYW5kb20ucmFuZGludCgxLCA5OSl9X3tkZXZpY2VfaWR9IgogICAgICAgIHNlbGYuYnJva2VyX3VybCA9IGNvbmZpZy5NUVRUX1NFUlZFUlNbY29uZmlnLk1PREVdCiAgICAgICAgc2VsZi5icm9rZXJfYWRkcmVzcyA9IHNlbGYuYnJva2VyX3VybC5yZXBsYWNlKCJtcXR0Oi8vIiwgIiIpLnNwbGl0KCI6IilbMF0KICAgICAgICBzZWxmLmJyb2tlcl9wb3J0ID0gaW50KHNlbGYuYnJva2VyX3VybC5zcGxpdCgiOiIpWy0xXSkgaWYgIjoiIGluIHNlbGYuYnJva2VyX3VybCBlbHNlIDE4ODMKICAgICAgICBzZWxmLnVzZXJuYW1lID0gY29uZmlnLk1RVFRfVVNFUk5BTUUKICAgICAgICBzZWxmLnBhc3N3b3JkID0gY29uZmlnLk1RVFRfUEFTU1dPUkQKICAgICAgICAKICAgICAgICAjIFRy4bqhbmcgdGjDoWkga+G6v3QgbuG7kWkKICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5jbGllbnQgPSBOb25lCiAgICAgICAgc2VsZi5kZXZpY2VfaWQgPSBkZXZpY2VfaWQKICAgICAgICAKICAgICAgICAjIFJlY29ubmVjdGlvbiBsb2dpYwogICAgICAgIHNlbGYucmVjb25uZWN0X2RlbGF5ID0gMSAgIyBC4bqvdCDEkeG6p3UgduG7m2kgMSBnacOieQogICAgICAgIHNlbGYubWF4X3JlY29ubmVjdF9kZWxheSA9IDYwICAjIFThu5FpIMSRYSA2MCBnacOieQogICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ID0gMAogICAgICAgIHNlbGYubGFzdF9kaXNjb25uZWN0X3RpbWUgPSAwCiAgICAgICAgc2VsZi5tYW51YWxfZGlzY29ubmVjdCA9IEZhbHNlICAjIEZsYWcgxJHhu4MgcGjDom4gYmnhu4d0IGRpc2Nvbm5lY3QgY8OzIGNo4bunIMO9IHbDoCBraMO0bmcgY2jhu6cgw70KICAgICAgICAKICAgICAgICAjIFRvcGljcwogICAgICAgIHNlbGYudG9waWNfY2xpZW50X3N5bmMgPSBjb25maWcuTVFUVF9UT1BJQ19DTElFTlRfU1lOQwogICAgICAgIHNlbGYudG9waWNfc2VydmVyX3Rhc2sgPSBmIntjb25maWcuTVFUVF9UT1BJQ19TRVJWRVJfVEFTS19QUkVGSVh9L3tzZWxmLmRldmljZV9pZH0iCiAgICAgICAgCiAgICAgICAgIyBRdeG6o24gbMO9IHRhc2sgdsOgIHN5bmMKICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnMgPSB7fQogICAgICAgIHNlbGYuc3luY190aHJlYWQgPSBOb25lCiAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gY29uZmlnLlNZTkNfSU5URVJWQUwKICAgICAgICBzZWxmLnN5bmNfcnVubmluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBzZXRfam9iX3NlcnZpY2Uoc2VsZiwgam9iX3NlcnZpY2UpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBKb2JTZXJ2aWNlIMSR4buDIHjhu60gbMO9IGPDoWMgdGjDtG5nIGLDoW8gY29uZmlnIHVwZGF0ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9zZXJ2aWNlOiBJbnN0YW5jZSBj4bunYSBKb2JTZXJ2aWNlCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5qb2Jfc2VydmljZSA9IGpvYl9zZXJ2aWNlCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgxJHhurd0IEpvYlNlcnZpY2UgY2hvIE1RVFRTZXJ2aWNlIikKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYuc3RvcF9ldmVudCA9IHRocmVhZGluZy5FdmVudCgpCiAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygic3luY19pbnRlcnZhbCIsIGNvbmZpZy5TWU5DX0lOVEVSVkFMKQogICAgICAgIAogICAgICAgICMgVGhlbyBkw7VpIFJBTSDEkeG7gyB04buxIMSR4buZbmcgcmVib290CiAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSA9IFtdICAjIEzGsHUgMyBs4bqnbiDEkW8gUkFNIGfhuqduIG5o4bqldAogICAgICAgIHNlbGYuaGlnaF9yYW1fdGhyZXNob2xkID0gODggICMgTmfGsOG7oW5nIFJBTSBjYW8gKCUpCiAgICAgICAgc2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdCA9IDMgICMgU+G7kSBs4bqnbiBsacOqbiB0aeG6v3AgUkFNIGNhbyB0csaw4bubYyBraGkgcmVib290CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIG3DtGkgdHLGsOG7nW5nIFRlcm11eAogICAgICAgIHNlbGYuaXNfdGVybXV4ID0gJ1RFUk1VWF9WRVJTSU9OJyBpbiBvcy5lbnZpcm9uIG9yICcvZGF0YS9kYXRhL2NvbS50ZXJtdXgnIGluIG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpCiAgICAgICAgaWYgc2VsZi5pc190ZXJtdXg6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBjaOG6oXkgdHJvbmcgbcO0aSB0csaw4budbmcgVGVybXV4IikKCiAgICBkZWYgX2NyZWF0ZV9jbGllbnQoc2VsZikgLT4gbXF0dC5DbGllbnQ6CiAgICAgICAgIiIiVOG6oW8gdsOgIGPhuqV1IGjDrG5oIE1RVFQgY2xpZW50IiIiCiAgICAgICAgY2xpZW50ID0gTm9uZQoKICAgICAgICAjIFRo4butIHThuqFvIHbhu5tpIEFQSSB2MgogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpZW50ID0gbXF0dC5DbGllbnQoCiAgICAgICAgICAgICAgICBjbGllbnRfaWQ9c2VsZi5jbGllbnRfaWQsCiAgICAgICAgICAgICAgICBjbGVhbl9zZXNzaW9uPVRydWUsCiAgICAgICAgICAgICAgICBwcm90b2NvbD1tcXR0Lk1RVFR2MzExLAogICAgICAgICAgICAgICAgY2FsbGJhY2tfYXBpX3ZlcnNpb249Z2V0YXR0cihtcXR0LkNhbGxiYWNrQVBJVmVyc2lvbiwgJ1ZFUlNJT04yJywgTm9uZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYyIikKICAgICAgICBleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBUeXBlRXJyb3IpOgogICAgICAgICAgICAjIEZhbGxiYWNrIEFQSSB2MQogICAgICAgICAgICBjbGllbnQgPSBtcXR0LkNsaWVudCgKICAgICAgICAgICAgICAgIGNsaWVudF9pZD1zZWxmLmNsaWVudF9pZCwKICAgICAgICAgICAgICAgIGNsZWFuX3Nlc3Npb249VHJ1ZSwKICAgICAgICAgICAgICAgIHByb3RvY29sPW1xdHQuTVFUVHYzMTEKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYxIikKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIHjDoWMgdGjhu7FjIG7hur91IGPDswogICAgICAgIGlmIHNlbGYudXNlcm5hbWUgYW5kIHNlbGYucGFzc3dvcmQ6CiAgICAgICAgICAgIGNsaWVudC51c2VybmFtZV9wd19zZXQoc2VsZi51c2VybmFtZSwgc2VsZi5wYXNzd29yZCkKICAgICAgICAKICAgICAgICAjIMSQxINuZyBrw70gY2FsbGJhY2sKICAgICAgICBjbGllbnQub25fY29ubmVjdCA9IHNlbGYuX29uX2Nvbm5lY3QKICAgICAgICBjbGllbnQub25fbWVzc2FnZSA9IHNlbGYuX29uX21lc3NhZ2UKICAgICAgICBjbGllbnQub25fZGlzY29ubmVjdCA9IHNlbGYuX29uX2Rpc2Nvbm5lY3QKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIGtlZXAtYWxpdmUgZMOgaSBoxqFuIHbDoCByZWNvbm5lY3Rpb24KICAgICAgICBjbGllbnQucmVjb25uZWN0X2RlbGF5X3NldChtaW5fZGVsYXk9MSwgbWF4X2RlbGF5PTYwKQogICAgICAgIAogICAgICAgIHJldHVybiBjbGllbnQKCiAgICBkZWYgY29ubmVjdChzZWxmKSAtPiBib29sOgogICAgICAgICIiIkvhur90IG7hu5FpIMSR4bq/biBNUVRUIGJyb2tlciB24bubaSBleHBvbmVudGlhbCBiYWNrb2ZmIiIiCiAgICAgICAgZGVmIGNhbl9jb25uZWN0KGhvc3Q6IHN0ciwgcG9ydDogaW50LCB0aW1lb3V0OiBmbG9hdCA9IDMuMCkgLT4gYm9vbDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBzb2NrZXQuY3JlYXRlX2Nvbm5lY3Rpb24oKGhvc3QsIHBvcnQpLCB0aW1lb3V0PXRpbWVvdXQpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgbWFpbl9ob3N0ID0gc2VsZi5icm9rZXJfYWRkcmVzcwogICAgICAgIG1haW5fcG9ydCA9IHNlbGYuYnJva2VyX3BvcnQKICAgICAgICBmYWxsYmFja19ob3N0ID0gIjEwLjAuMC42IgogICAgICAgIGZhbGxiYWNrX3BvcnQgPSA5MDIwCgogICAgICAgICMgS2nhu4NtIHRyYSBr4bq/dCBu4buRaSBzb2NrZXQgdOG7m2kgY+G6oyAyIElQCiAgICAgICAgbWFpbl9vayA9IGNhbl9jb25uZWN0KG1haW5faG9zdCwgbWFpbl9wb3J0KQogICAgICAgIGZhbGxiYWNrX29rID0gY2FuX2Nvbm5lY3QoZmFsbGJhY2tfaG9zdCwgZmFsbGJhY2tfcG9ydCkKICAgICAgICBpZiBtYWluX29rOgogICAgICAgICAgICBjb25uZWN0X2hvc3QgPSBtYWluX2hvc3QKICAgICAgICAgICAgY29ubmVjdF9wb3J0ID0gbWFpbl9wb3J0CiAgICAgICAgZWxpZiBmYWxsYmFja19vazoKICAgICAgICAgICAgY29ubmVjdF9ob3N0ID0gZmFsbGJhY2tfaG9zdAogICAgICAgICAgICBjb25uZWN0X3BvcnQgPSBmYWxsYmFja19wb3J0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIGvhur90IG7hu5FpIMSRxrDhu6NjIHNvY2tldCB04bubaSBj4bqjIHttYWluX2hvc3R9OnttYWluX3BvcnR9IGzhuqtuIHtmYWxsYmFja19ob3N0fTp7ZmFsbGJhY2tfcG9ydH0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFThuqFvIGNsaWVudCBt4bubaSBu4bq/dSBjaMawYSBjw7MgaG/hurdjIGNsaWVudCBjxakgYuG7iyBs4buXaQogICAgICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBzZWxmLl9jcmVhdGVfY2xpZW50KCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzZWxmLnN0b3BfZXZlbnQuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3QgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBr4bq/dCBu4buRaSB04bubaSBNUVRUIGJyb2tlciB7Y29ubmVjdF9ob3N0fTp7Y29ubmVjdF9wb3J0fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGtlZXBhbGl2ZSBs4bubbiBoxqFuICgxMjAgZ2nDonkgdGhheSB2w6wgNjApCiAgICAgICAgICAgIHNlbGYuY2xpZW50LmNvbm5lY3RfYXN5bmMoY29ubmVjdF9ob3N0LCBjb25uZWN0X3BvcnQsIGtlZXBhbGl2ZT0xMjApCiAgICAgICAgICAgIHNlbGYuY2xpZW50Lmxvb3Bfc3RhcnQoKQoKICAgICAgICAgICAgZGVmIF93YWl0X2Nvbm5lY3RlZCh0aW1lb3V0X3NlYzogaW50ID0gMTUpIC0+IGJvb2w6CiAgICAgICAgICAgICAgICBmb3IgXyBpbiByYW5nZSh0aW1lb3V0X3NlYyk6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19jb25uZWN0ZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgxKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICBpZiBfd2FpdF9jb25uZWN0ZWQoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcgxJHhur9uIE1RVFQgYnJva2VyIHtjb25uZWN0X2hvc3R9Ontjb25uZWN0X3BvcnR9IikKICAgICAgICAgICAgICAgIHNlbGYuYnJva2VyX2FkZHJlc3MgPSBjb25uZWN0X2hvc3QKICAgICAgICAgICAgICAgIHNlbGYuYnJva2VyX3BvcnQgPSBjb25uZWN0X3BvcnQKICAgICAgICAgICAgICAgICMgUmVzZXQgcmVjb25uZWN0IGRlbGF5IGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2RlbGF5ID0gMQogICAgICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfY291bnQgPSAwCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS+G6v3QgbuG7kWkgTVFUVCB0aOG6pXQgYuG6oWkgdOG7m2kge2Nvbm5lY3RfaG9zdH06e2Nvbm5lY3RfcG9ydH0iKQogICAgICAgICAgICAgICAgc2VsZi5fY2xlYW51cF9jbGllbnQoKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkga+G6v3QgbuG7kWkgTVFUVDoge3N0cihlKX0iKQogICAgICAgICAgICBzZWxmLl9jbGVhbnVwX2NsaWVudCgpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfY2xlYW51cF9jbGllbnQoc2VsZik6CiAgICAgICAgIiIiROG7jW4gZOG6uXAgTVFUVCBjbGllbnQiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuY2xpZW50OgogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQubG9vcF9zdG9wKCkKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50LmRpc2Nvbm5lY3QoKQogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBOb25lCiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gRmFsc2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGThu41uIGThurlwIE1RVFQgY2xpZW50OiB7ZX0iKQoKICAgIGRlZiBlbnN1cmVfY29ubmVjdGVkKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIixJDhuqNtIGLhuqNvIGvhur90IG7hu5FpIE1RVFQgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24gY8OhYyB0aGFvIHTDoWMgduG7m2kgcmF0ZSBsaW1pdGluZyIiIgogICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyB0cm9uZyBxdcOhIHRyw6xuaCByZWNvbm5lY3Qga2jDtG5nCiAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICBpZiBjdXJyZW50X3RpbWUgLSBzZWxmLmxhc3RfZGlzY29ubmVjdF90aW1lIDwgNTogICMgQ2jhu50gw610IG5o4bqldCA1IGdpw6J5IHThu6sgbOG6p24gZGlzY29ubmVjdCBjdeG7kWkKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCLEkGFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBjb29sZG93biByZWNvbm5lY3QsIGNo4budLi4uIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci53YXJuaW5nKCJNUVRUIGNoxrBhIGvhur90IG7hu5FpLCDEkWFuZyB0aOG7rSBr4bq/dCBu4buRaSBs4bqhaS4uLiIpCiAgICAgICAgcmV0dXJuIHNlbGYuY29ubmVjdCgpCgogICAgZGVmIF9vbl9jb25uZWN0KHNlbGYsIGNsaWVudCwgdXNlcmRhdGEsIGZsYWdzLCByYywgcHJvcGVydGllcz1Ob25lKToKICAgICAgICAiIiJDYWxsYmFjayBraGkga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nIiIiCiAgICAgICAgaWYgcmMgPT0gMDoKICAgICAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBUcnVlCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZyB04bubaSBNUVRUIGJyb2tlciIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQxINuZyBrw70gbmjhuq1uIHRhc2sKICAgICAgICAgICAgc2VsZi5jbGllbnQuc3Vic2NyaWJlKHNlbGYudG9waWNfc2VydmVyX3Rhc2ssIHFvcz0xKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHEg25nIGvDvSBuaOG6rW4gdGFzayB04bqhaToge3NlbGYudG9waWNfc2VydmVyX3Rhc2t9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7rWkgdGjDtG5nIGLDoW8ga+G6v3QgbuG7kWkKICAgICAgICAgICAgc2VsZi5zZW5kX2Nvbm5lY3Rfbm90aWZpY2F0aW9uKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgcmVjb25uZWN0IGNvdW50ZXIga2hpIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZwogICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCA9IDAKICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfZGVsYXkgPSAxCiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS+G6v3QgbuG7kWkgTVFUVCB0aOG6pXQgYuG6oWkgduG7m2kgbcOjIGzhu5dpOiB7cmN9IikKICAgICAgICAgICAgIyBUxINuZyByZWNvbm5lY3QgY291bnQga2hpIGvhur90IG7hu5FpIHRo4bqldCBi4bqhaQogICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCArPSAxCgogICAgZGVmIF9vbl9kaXNjb25uZWN0KHNlbGYsIGNsaWVudCwgdXNlcmRhdGEsIHJjLCBwcm9wZXJ0aWVzPU5vbmUsIHJlYXNvbl9jb2RlPU5vbmUsICoqa3dhcmdzKToKICAgICAgICAiIiJDYWxsYmFjayBraGkgbmfhuq90IGvhur90IG7hu5FpIHbhu5tpIGPGoSBjaOG6vyByZWNvbm5lY3QgdGjDtG5nIG1pbmgiIiIKICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5sYXN0X2Rpc2Nvbm5lY3RfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgCiAgICAgICAgaWYgc2VsZi5tYW51YWxfZGlzY29ubmVjdDoKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mgbmfhuq90IGvhur90IG7hu5FpIE1RVFQgdGhlbyB5w6p1IGPhuqd1IikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgIGlmIHJjICE9IDA6CiAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ICs9IDEKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJOZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCBraMO0bmcgbW9uZyBtdeG7kW4gbOG6p24ge3NlbGYucmVjb25uZWN0X2NvdW50fSB24bubaSBtw6MgbOG7l2k6IHtyY30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7iSBhdXRvLXJlY29ubmVjdCBu4bq/dSBraMO0bmcgcGjhuqNpIG1hbnVhbCBkaXNjb25uZWN0CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCk6CiAgICAgICAgICAgICAgICBzZWxmLl9zY2hlZHVsZV9yZWNvbm5lY3QoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIG5n4bqvdCBr4bq/dCBu4buRaSBNUVRUIikKCiAgICBkZWYgX3NjaGVkdWxlX3JlY29ubmVjdChzZWxmKToKICAgICAgICAiIiJMw6puIGzhu4tjaCBr4bq/dCBu4buRaSBs4bqhaSB24bubaSBleHBvbmVudGlhbCBiYWNrb2ZmIiIiCiAgICAgICAgIyBUw61uaCBkZWxheSB24bubaSBleHBvbmVudGlhbCBiYWNrb2ZmCiAgICAgICAgZGVsYXkgPSBtaW4oc2VsZi5yZWNvbm5lY3RfZGVsYXkgKiAoMiAqKiBtaW4oc2VsZi5yZWNvbm5lY3RfY291bnQgLSAxLCA2KSksIHNlbGYubWF4X3JlY29ubmVjdF9kZWxheSkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIlPhur0gdGjhu60ga+G6v3QgbuG7kWkgbOG6oWkgc2F1IHtkZWxheX0gZ2nDonkuLi4iKQogICAgICAgIAogICAgICAgIGRlZiByZWNvbm5lY3RfYWZ0ZXJfZGVsYXkoKToKICAgICAgICAgICAgaWYgbm90IHNlbGYuc3RvcF9ldmVudC53YWl0KGRlbGF5KTogICMgQ2jhu50gZGVsYXkgc2Vjb25kcywgdHLhu6sga2hpIGLhu4sgc3RvcAogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuaXNfY29ubmVjdGVkIGFuZCBub3Qgc2VsZi5tYW51YWxfZGlzY29ubmVjdDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4butIGvhur90IG7hu5FpIGzhuqFpIE1RVFQgKGzhuqduIHtzZWxmLnJlY29ubmVjdF9jb3VudH0pIikKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmNvbm5lY3QoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkvhur90IG7hu5FpIGzhuqFpIE1RVFQgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIE7hur91IHbhuqtuIHRo4bqldCBi4bqhaSwgbMOqbiBs4buLY2ggdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5yZWNvbm5lY3RfY291bnQgPCAxMDogICMgR2nhu5tpIGjhuqFuIHPhu5EgbOG6p24gdGjhu60KICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3NjaGVkdWxlX3JlY29ubmVjdCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIsSQw6MgdGjhu60ga+G6v3QgbuG7kWkgbOG6oWkgTVFUVCBxdcOhIG5oaeG7gXUgbOG6p24sIHThuqFtIGThu6tuZyBhdXRvLXJlY29ubmVjdCIpCiAgICAgICAgCiAgICAgICAgIyBDaOG6oXkgdHJvbmcgdGhyZWFkIHJpw6puZyDEkeG7gyBraMO0bmcgYmxvY2sKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1yZWNvbm5lY3RfYWZ0ZXJfZGVsYXksIGRhZW1vbj1UcnVlKS5zdGFydCgpCgogICAgZGVmIF9zYWZlX3B1Ymxpc2goc2VsZiwgdG9waWM6IHN0ciwgcGF5bG9hZDogc3RyLCBxb3M6IGludCA9IDEpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgR+G7rWkgbWVzc2FnZSBhbiB0b8OgbiB24bubaSBraeG7g20gdHJhIGvhur90IG7hu5FpIHRyxrDhu5tjIGtoaSBwdWJsaXNoCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdG9waWM6IE1RVFQgdG9waWMKICAgICAgICAgICAgcGF5bG9hZDogTuG7mWkgZHVuZyBtZXNzYWdlIChzdHJpbmcpCiAgICAgICAgICAgIHFvczogUXVhbGl0eSBvZiBTZXJ2aWNlICgwLCAxLCBob+G6t2MgMikKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBn4butaSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2Nvbm5lY3RlZCgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IE1RVFQgY2jGsGEga+G6v3QgbuG7kWkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmNsaWVudC5wdWJsaXNoKHRvcGljLCBwYXlsb2FkLCBxb3M9cW9zKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0LnJjID09IG1xdHQuTVFUVF9FUlJfU1VDQ0VTUzoKICAgICAgICAgICAgICAgICNsb2dnZXIuaW5mbyhmIsSQw6MgZ+G7rWkgbWVzc2FnZSB0aMOgbmggY8O0bmcgxJHhur9uIHt0b3BpY30iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBn4butaSBtZXNzYWdlIMSR4bq/biB7dG9waWN9OiB7bXF0dC5lcnJvcl9zdHJpbmcocmVzdWx0LnJjKX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbmRfdGFza19yZXBvcnQoc2VsZiwgdGFza19pZDogc3RyLCBkZXZpY2VfaWQ6IHN0ciwgc3RhdHVzOiBzdHIsIGNsaWVudF9tZXNzYWdlOiBzdHIgPSAiIik6CiAgICAgICAgIiIiR+G7rWkgYsOhbyBjw6FvIGvhur90IHF14bqjIHRo4buxYyBoaeG7h24gdGFzayIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVwb3J0X2RhdGEgPSB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6IHRhc2tfaWQsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cywKICAgICAgICAgICAgICAgICJjbGllbnRfbWVzc2FnZSI6IGNsaWVudF9tZXNzYWdlLAogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgc2VsZi5fc2FmZV9wdWJsaXNoKCJkbmR2aW5hL2NsaWVudC90YXNrX3JlcG9ydCIsIGpzb24uZHVtcHMocmVwb3J0X2RhdGEpKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBn4butaSBiw6FvIGPDoW8gdGFzayB7dGFza19pZH0gduG7m2kgdHLhuqFuZyB0aMOhaSB7c3RhdHVzfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgYsOhbyBjw6FvIHRhc2s6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbmRfY29ubmVjdF9ub3RpZmljYXRpb24oc2VsZik6CiAgICAgICAgIiIiR+G7rWkgdGjDtG5nIGLDoW8ga+G6v3QgbuG7kWkgxJHhur9uIHNlcnZlciIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY29ubmVjdF9kYXRhID0gewogICAgICAgICAgICAgICAgImRldmljZV9pZCI6IHNlbGYuZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgc2VsZi5fc2FmZV9wdWJsaXNoKCJkbmR2aW5hL2NsaWVudC9jb25uZWN0IiwganNvbi5kdW1wcyhjb25uZWN0X2RhdGEpKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBn4butaSB0aMO0bmcgYsOhbyBr4bq/dCBu4buRaSBjaG8gdGhp4bq/dCBi4buLIHtzZWxmLmRldmljZV9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiByZWdpc3Rlcl90YXNrX2hhbmRsZXIoc2VsZiwgdGFza190eXBlOiBzdHIsIGhhbmRsZXI6IENhbGxhYmxlKToKICAgICAgICAiIiIKICAgICAgICDEkMSDbmcga8O9IGhhbmRsZXIgY2hvIGxv4bqhaSB0YXNrCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza190eXBlOiBMb+G6oWkgdGFzawogICAgICAgICAgICBoYW5kbGVyOiBIw6BtIHjhu60gbMO9IHRhc2sKICAgICAgICAiIiIKICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnNbdGFza190eXBlXSA9IGhhbmRsZXIKICAgIAogICAgZGVmIF9yZWFkX3JlY2VudF9sb2dzKHNlbGYsIG51bV9saW5lcz0yMDApOgogICAgICAgICIiIgogICAgICAgIMSQ4buNYyBjw6FjIGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQgdOG7qyBmaWxlIGFwcC5sb2cKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBudW1fbGluZXM6IFPhu5EgZMOybmcgbG9nIGPhuqduIMSR4buNYyAobeG6t2MgxJHhu4tuaCAxMDApCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3Rbc3RyXTogRGFuaCBzw6FjaCBjw6FjIGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQgaG/hurdjIHRow7RuZyBiw6FvIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dfZmlsZV9wYXRoID0gb3MucGF0aC5qb2luKGNvbmZpZy5CQVNFX0RJUiwgImFwcC5sb2ciKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IG9zLnBhdGguZXhpc3RzKGxvZ19maWxlX3BhdGgpOgogICAgICAgICAgICAgICAgIyBGaWxlIGNoxrBhIMSRxrDhu6NjIHThuqFvIGLhu59pIGxvZ2dpbmcgc3lzdGVtCiAgICAgICAgICAgICAgICByZXR1cm4gW2YiW0lORk9dIEZpbGUgbG9nIGNoxrBhIMSRxrDhu6NjIHThuqFvLCBjaMawYSBjw7MgbG9nIG7DoG8iXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu60gxJHhu41jIGZpbGUgduG7m2kgcmV0cnkgxJHhu4MgdHLDoW5oIHh1bmcgxJHhu5l0CiAgICAgICAgICAgIG1heF9yZXRyaWVzID0gMwogICAgICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfcmV0cmllcyk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKGxvZ19maWxlX3BhdGgsICdyJywgZW5jb2Rpbmc9J3V0Zi04JywgZXJyb3JzPSdpZ25vcmUnKSBhcyBmOgogICAgICAgICAgICAgICAgICAgICAgICBsaW5lcyA9IGYucmVhZGxpbmVzKCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBudW1fbGluZXMgZMOybmcgY3Xhu5FpIGPDuW5nCiAgICAgICAgICAgICAgICAgICAgcmVjZW50X2xpbmVzID0gbGluZXNbLW51bV9saW5lczpdIGlmIGxlbihsaW5lcykgPiBudW1fbGluZXMgZWxzZSBsaW5lcwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTG/huqFpIGLhu48ga8O9IHThu7EgeHXhu5FuZyBkw7JuZyB2w6AgY8OhYyBraG/huqNuZyB0cuG6r25nIHRo4burYQogICAgICAgICAgICAgICAgICAgIHJlY2VudF9sb2dzID0gW2xpbmUuc3RyaXAoKSBmb3IgbGluZSBpbiByZWNlbnRfbGluZXMgaWYgbGluZS5zdHJpcCgpXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6MgxJHhu41jIHtsZW4ocmVjZW50X2xvZ3MpfSBkw7JuZyBsb2cgZ+G6p24gbmjhuqV0IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZW50X2xvZ3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCAoUGVybWlzc2lvbkVycm9yLCBJT0Vycm9yLCBPU0Vycm9yKSBhcyBmaWxlX2Vycm9yOgogICAgICAgICAgICAgICAgICAgIGlmIGF0dGVtcHQgPCBtYXhfcmV0cmllcyAtIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMC4xKSAgIyBDaOG7nSAxMDBtcyBy4buTaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbZiJbRVJST1JdIEtow7RuZyB0aOG7gyDEkeG7jWMgZmlsZSBsb2c6IHtzdHIoZmlsZV9lcnJvcil9Il0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4gW2YiW0VSUk9SXSBM4buXaSDEkeG7jWMgZmlsZSBsb2c6IHtzdHIoZSl9Il0KCiAgICBkZWYgc3luY19kYXRhKHNlbGYpOgogICAgICAgICIiIsSQ4buTbmcgYuG7mSBk4buvIGxp4buHdSB24bubaSBzZXJ2ZXIiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTuG6v3UgY2jGsGEga+G6v3QgbuG7kWkgTVFUVCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiBub3Qgc2VsZi5pc19jb25uZWN0ZWQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiQ2jGsGEga+G6v3QgbuG7kWkgTVFUVCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGhlbHBlciA9IHNlbGYuaGVscGVyX3NlcnZpY2UKICAgICAgICAgICAgaWYgbm90IGhlbHBlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIGPDsyBoZWxwZXIgc2VydmljZSwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZAogICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQsIGtow7RuZyB0aOG7gyDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfaW5mbyA9IE5vbmUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlX2luZm9fcmVzcG9uc2UgPSBoZWxwZXIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBs4bqleSB0aMOgbmggY8O0bmcsIGzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgZGV2aWNlX2luZm9fcmVzcG9uc2VbInN0YXR1cyJdID09ICJzdWNjZXNzIiBhbmQgImRhdGEiIGluIGRldmljZV9pbmZvX3Jlc3BvbnNlOgogICAgICAgICAgICAgICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zYXZlX2RldmljZV9pbmZvKGRldmljZV9pbmZvX3Jlc3BvbnNlWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBkZXZpY2VfaW5mb19yZXNwb25zZVsiZGF0YSJdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUaGVvIGTDtWkgUkFNIMSR4buDIHThu7EgxJHhu5luZyByZWJvb3QKICAgICAgICAgICAgICAgICAgICBzZWxmLl9tb25pdG9yX3JhbV91c2FnZShkZXZpY2VfaW5mbykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIGzhuqV5IMSRxrDhu6NjIHRow7RuZyB0aW4gdGhp4bq/dCBi4buLLCBz4butIGThu6VuZyB0aMO0bmcgdGluIMSRw6MgbMawdSB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBpZiBub3QgZGV2aWNlX2luZm86CiAgICAgICAgICAgICAgICBkZXZpY2VfaW5mbyA9IHNlbGYuZGIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgZGV2aWNlX2luZm86CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIGPDsyB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iywgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IGPDsyB0aOG7gyBraMO0bmcgxJHhuqd5IMSR4bunIikKICAgICAgICAgICAgICAgIGRldmljZV9pbmZvID0ge30KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfY29uZmlnID0gc2VsZi5kYi5nZXRfYWxsX2RldmljZV9jb25maWcoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buZcCBjw6FjIHRy4bqhbmcgdGjDoWkgcnVudGltZSAocGF1c2Vfam9iLCBkZXZpY2VfaXNfd29ya2luZywgZGV2aWNlX21lc3NhZ2UpIHbDoG8gZGV2aWNlX2luZm8KICAgICAgICAgICAgZm9yIHJ1bnRpbWVfa2V5IGluIFsicGF1c2Vfam9iIiwgImRldmljZV9pc193b3JraW5nIiwgImRldmljZV9tZXNzYWdlIl06CiAgICAgICAgICAgICAgICBpZiBydW50aW1lX2tleSBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgICAgIGRldmljZV9pbmZvW3J1bnRpbWVfa2V5XSA9IGRldmljZV9jb25maWcucG9wKHJ1bnRpbWVfa2V5KQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaCBu4bq/dSBjaMawYSBj4bqldSBow6xuaAogICAgICAgICAgICAgICAgICAgIGRldmljZV9pbmZvW3J1bnRpbWVfa2V5XSA9IEZhbHNlIGlmIHJ1bnRpbWVfa2V5ICE9ICJkZXZpY2VfbWVzc2FnZSIgZWxzZSAiIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBnb2xpa2VfcmVwb3J0IGto4buPaSBkZXZpY2VfY29uZmlnIMSR4buDIGfhu61pIHJpw6puZwogICAgICAgICAgICBnb2xpa2VfcmVwb3J0ID0gTm9uZQogICAgICAgICAgICBpZiAiZ29saWtlX3JlcG9ydCIgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGdvbGlrZV9yZXBvcnQgPSBkZXZpY2VfY29uZmlnLnBvcCgiZ29saWtlX3JlcG9ydCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExv4bqhaSBi4buPIGdvbGlrZV9hcGlfYmFzZSBraOG7j2kgZGV2aWNlX2NvbmZpZwogICAgICAgICAgICBpZiAiZ29saWtlX2FwaV9iYXNlIiBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZy5wb3AoImdvbGlrZV9hcGlfYmFzZSIpCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQw6MgbG/huqFpIGLhu48gZ29saWtlX2FwaV9iYXNlIGto4buPaSBk4buvIGxp4buHdSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgY8OhYyB0w6BpIGtob+G6o24gY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHBlbmRpbmdfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9wZW5kaW5nX3N5bmNfaXRlbXMoImFjY291bnRzIiwgbGltaXQ9NTApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGPDoWMgam9iIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICBwZW5kaW5nX2pvYnMgPSBzZWxmLmRiLmdldF9wZW5kaW5nX3N5bmNfaXRlbXMoImpvYnNfaGlzdG9yeSIsIGxpbWl0PTUwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG7jWMgMjAwIGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQKICAgICAgICAgICAgcmVjZW50X2xvZ3MgPSBzZWxmLl9yZWFkX3JlY2VudF9sb2dzKDIwMCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHBheWxvYWQKICAgICAgICAgICAgcGF5bG9hZCA9IHsKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2luZm8iOiBkZXZpY2VfaW5mbywKICAgICAgICAgICAgICAgICJkZXZpY2VfY29uZmlnIjogZGV2aWNlX2NvbmZpZywKICAgICAgICAgICAgICAgICJtZXRhX2RhdGEiOiB7CiAgICAgICAgICAgICAgICAgICAgImRldmljZV9sb2dzIjogcmVjZW50X2xvZ3MKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGdvbGlrZV9yZXBvcnQgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIGdvbGlrZV9yZXBvcnQ6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJnb2xpa2VfcmVwb3J0Il0gPSBnb2xpa2VfcmVwb3J0CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSB0w6BpIGtob+G6o24gY2jGsGEgxJHhu5NuZyBi4buZIG7hur91IGPDswogICAgICAgICAgICBpZiBwZW5kaW5nX2FjY291bnRzOgogICAgICAgICAgICAgICAgcGF5bG9hZFsiYWNjb3VudHMiXSA9IHBlbmRpbmdfYWNjb3VudHMKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQ4buTbmcgYuG7mSB7bGVuKHBlbmRpbmdfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gY2jGsGEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGpvYiBjaMawYSDEkeG7k25nIGLhu5kgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHBlbmRpbmdfam9iczoKICAgICAgICAgICAgICAgIHBheWxvYWRbImpvYnMiXSA9IHBlbmRpbmdfam9icwogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDhu5NuZyBi4buZIHtsZW4ocGVuZGluZ19qb2JzKX0gam9iIGNoxrBhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBH4butaSBk4buvIGxp4buHdQogICAgICAgICAgICBzZWxmLl9zYWZlX3B1Ymxpc2goY29uZmlnLk1RVFRfVE9QSUNfQ0xJRU5UX1NZTkMsIGpzb24uZHVtcHMocGF5bG9hZCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZyB0aMO0bmcgdGluIHbhu4Egc+G7kSBkw7JuZyBsb2cgxJHDoyBn4butaQogICAgICAgICAgICBpZiByZWNlbnRfbG9nczoKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6MgZ+G7rWkge2xlbihyZWNlbnRfbG9ncyl9IGTDsm5nIGxvZyBn4bqnbiBuaOG6pXQgbMOqbiBzZXJ2ZXIiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UgduG7m2kgc2VydmVyIikKICAgIAogICAgZGVmIHN0YXJ0X3N5bmNfdGhyZWFkKHNlbGYpOgogICAgICAgICIiIkLhuq90IMSR4bqndSB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIiIgogICAgICAgIGlmIHNlbGYuc3luY190aHJlYWQgaXMgbm90IE5vbmUgYW5kIHNlbGYuc3luY190aHJlYWQuaXNfYWxpdmUoKToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlRocmVhZCDEkeG7k25nIGLhu5kgxJHDoyDEkWFuZyBjaOG6oXkiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYuc3RvcF9ldmVudC5jbGVhcigpCiAgICAgICAgc2VsZi5zeW5jX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuX3N5bmNfbG9vcCwgZGFlbW9uPVRydWUpCiAgICAgICAgc2VsZi5zeW5jX3RocmVhZC5zdGFydCgpCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mga2jhu59pIMSR4buZbmcgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciKQogICAgCiAgICBkZWYgX3N5bmNfbG9vcChzZWxmKToKICAgICAgICAiIiJMb29wIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciIiIKICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIG3hu5dpIHtzZWxmLnN5bmNfaW50ZXJ2YWx9IGdpw6J5IikKCiAgICAgICAgd2hpbGUgbm90IHNlbGYuc3RvcF9ldmVudC5pc19zZXQoKSBhbmQgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnN5bmNfZGF0YSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHRyb25nIHF1w6EgdHLDrG5oIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmc6IHtzdHIoZSl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE5naOG7iSDEkeG6v24gbOG6p24gxJHhu5NuZyBi4buZIHRp4bq/cCB0aGVvCiAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKHNlbGYuc3luY19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCkgb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgdGltZS5zbGVlcCgxKQogICAgCiAgICBkZWYgc3RvcF9zeW5jX3RocmVhZChzZWxmKToKICAgICAgICAiIiJE4burbmcgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciIiIKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYuc3RvcF9ldmVudC5zZXQoKQogICAgICAgIGlmIHNlbGYuc3luY190aHJlYWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuc3luY190aHJlYWQuam9pbih0aW1lb3V0PTIuMCkKICAgICAgICAgICAgc2VsZi5zeW5jX3RocmVhZCA9IE5vbmUKICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBk4burbmcgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciKQogICAgCiAgICBkZWYgZGlzY29ubmVjdChzZWxmKToKICAgICAgICAiIiJOZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIiIgogICAgICAgIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3QgPSBUcnVlICAjIMSQw6FuaCBk4bqldSDEkcOieSBsw6AgZGlzY29ubmVjdCBjw7MgY2jhu6cgw70KICAgICAgICBzZWxmLnN0b3Bfc3luY190aHJlYWQoKQogICAgICAgIAogICAgICAgIGlmIHNlbGYuY2xpZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmNsaWVudC5sb29wX3N0b3AoKQogICAgICAgICAgICBzZWxmLmNsaWVudC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBuZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIpCiAgICAgICAgCiAgICAgICAgIyBE4burbmcgdOG6pXQgY+G6oyBhdXRvLXJlY29ubmVjdAogICAgICAgIHNlbGYuc3RvcF9ldmVudC5zZXQoKQogICAgCiAgICBkZWYgc2V0dXBfbXF0dF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJUaGnhur90IGzhuq1wIGPDoWMgaGFuZGxlciBjaG8gTVFUVCB0YXNrcyIiIgogICAgICAgICMgxJDEg25nIGvDvSBjw6FjIHRhc2sgaGFuZGxlciBt4bq3YyDEkeG7i25oCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9jb25maWciLCBzZWxmLl9oYW5kbGVfdXBkYXRlX2RldmljZV9jb25maWcpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9zeW5jZWQiLCBzZWxmLl9oYW5kbGVfdXBkYXRlX3N5bmNlZCkKICAgICAgICBzZWxmLnJlZ2lzdGVyX3Rhc2tfaGFuZGxlcigiYWNjb3VudF91cGRhdGUiLCBzZWxmLl9oYW5kbGVfYWNjb3VudF91cGRhdGUpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInZlcmlmeV9nb2xpa2UiLCBzZWxmLl9oYW5kbGVfdmVyaWZ5X2dvbGlrZSkKICAgICAgICBzZWxmLnJlZ2lzdGVyX3Rhc2tfaGFuZGxlcigidXBkYXRlX3Byb3h5Iiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9wcm94eSkKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygixJDDoyB0aGnhur90IGzhuq1wIGPDoWMgTVFUVCB0YXNrIGhhbmRsZXIiKQogICAgICAgIAogICAgZGVmIF9oYW5kbGVfdXBkYXRlX2RldmljZV9jb25maWcoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyB04burIHNlcnZlciAodGFza19pZDoge3Rhc2tfaWR9KSIpCiAgICAgICAgICAgIGNvbmZpZ19kYXRhID0gdGFza19kYXRhLmdldCgiY29uZmlnX2RhdGEiLCB7fSkKICAgICAgICAgICAgaWYgbm90IGNvbmZpZ19kYXRhOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkThu68gbGnhu4d1IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyBy4buXbmciKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsICJE4buvIGxp4buHdSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgcuG7l25nIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHThu6tuZyBj4bqldSBow6xuaCB0aGnhur90IGLhu4sKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIuc2F2ZV9kZXZpY2VfY29uZmlnKGNvbmZpZ19kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7JywgJy5qb2luKGNvbmZpZ19kYXRhLmtleXMoKSl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gbMOgIGNoxrBhIHN5bmMgxJHhu4MgxJHhuqNtIGLhuqNvIHRow7RuZyB0aW4gbeG7m2kgbmjhuqV0IMSRxrDhu6NjIGfhu61pIGzDqm4gc2VydmVyCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9hY2NvdW50cyA9IHNlbGYuZGIubWFya19hbGxfYWNjb3VudHNfbm90X3N5bmNlZCgpCiAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlZF9hY2NvdW50cyA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkcOhbmggZOG6pXUge3VwZGF0ZWRfYWNjb3VudHN9IHTDoGkga2hv4bqjbiBsw6AgY2jGsGEgc3luYyBzYXUga2hpIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4siKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBj4bqnbiDEkcOhbmggZOG6pXUgY2jGsGEgc3luYyIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBjaMawYSBzeW5jOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgICMgS2jDtG5nIGZhaWwgdGFzayB2w6wgdmnhu4djIGPhuq1wIG5o4bqtdCBjb25maWcgxJHDoyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgc3luY19pbnRlcnZhbCBu4bq/dSBuw7MgdGhheSDEkeG7lWkKICAgICAgICAgICAgICAgIGlmICJzeW5jX2ludGVydmFsIiBpbiBjb25maWdfZGF0YToKICAgICAgICAgICAgICAgICAgICBuZXdfc3luY19pbnRlcnZhbCA9IGNvbmZpZ19kYXRhWyJzeW5jX2ludGVydmFsIl0KICAgICAgICAgICAgICAgICAgICBpZiBuZXdfc3luY19pbnRlcnZhbCAhPSBzZWxmLnN5bmNfaW50ZXJ2YWw6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6rXAgbmjhuq10IHN5bmNfaW50ZXJ2YWwgdOG7qyB7c2VsZi5zeW5jX2ludGVydmFsfSB0aMOgbmgge25ld19zeW5jX2ludGVydmFsfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY19pbnRlcnZhbCA9IG5ld19zeW5jX2ludGVydmFsCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEto4bufaSDEkeG7mW5nIGzhuqFpIHRocmVhZCDEkeG7k25nIGLhu5kgbuG6v3UgxJFhbmcgY2jhuqF5CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuc3luY190aHJlYWQgaXMgbm90IE5vbmUgYW5kIHNlbGYuc3luY190aHJlYWQuaXNfYWxpdmUoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJLaOG7n2kgxJHhu5luZyBs4bqhaSB0aHJlYWQgxJHhu5NuZyBi4buZIHbhu5tpIGtob+G6o25nIHRo4budaSBnaWFuIG3hu5tpIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3RvcF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN0YXJ0X3N5bmNfdGhyZWFkKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaMO0bmcgYsOhbyBjaG8gSm9iU2VydmljZSB24buBIHThuqV0IGPhuqMgY29uZmlnIHVwZGF0ZQogICAgICAgICAgICAgICAgaWYgc2VsZi5qb2Jfc2VydmljZSBhbmQgaGFzYXR0cihzZWxmLmpvYl9zZXJ2aWNlLCAnaGFuZGxlX21xdHRfY29uZmlnX3VwZGF0ZScpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJUaMO0bmcgYsOhbyBKb2JTZXJ2aWNlIHbhu4EgY29uZmlnIHVwZGF0ZSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5qb2Jfc2VydmljZS5oYW5kbGVfbXF0dF9jb25maWdfdXBkYXRlKGNvbmZpZ19kYXRhKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIExvZyB0aMOqbSB0aMO0bmcgdGluIHbhu4Egam9iLXJlbGF0ZWQgY29uZmlncwogICAgICAgICAgICAgICAgam9iX3JlbGF0ZWRfa2V5cyA9IFsibWF4X2pvYnNfcGVyX2RheSIsICJtYXhfam9ic19wZXJfc2Vzc2lvbiIsICJqb2JfaW50ZXJ2YWxfc2Vjb25kcyIsICJjYXJlX2luX3dvcmtpbmdfam9iIl0KICAgICAgICAgICAgICAgIGlmIGFueShrZXkgaW4gY29uZmlnX2RhdGEgZm9yIGtleSBpbiBqb2JfcmVsYXRlZF9rZXlzKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gSm9iU2VydmljZSDEkcOjIMSRxrDhu6NjIGPhuq1wIG5o4bqtdCIpCiAgICAgICAgICAgICAgICAgICAgIyBKb2JTZXJ2aWNlIHPhur0geOG7rSBsw70gbG9naWMgcmVzdGFydCBzZXNzaW9uIG7hur91IGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBH4butaSBiw6FvIGPDoW8gdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIGYixJDDoyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7JywgJy5qb2luKGNvbmZpZ19kYXRhLmtleXMoKSl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gIktow7RuZyB0aOG7gyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7c3RyKGUpfSIKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgdGFza19pZCA9IHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKQogICAgICAgICAgICBkZXZpY2VfaWQgPSB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQoKICAgIGRlZiBfaGFuZGxlX3VwZGF0ZV9zeW5jZWQoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJOaOG6rW4gecOqdSBj4bqndSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdOG7qyBzZXJ2ZXIiKQogICAgICAgICAgICBkYXRhID0gdGFza19kYXRhLmdldCgiZGF0YSIsIHt9KQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudF9jb3VudCA9IDAKICAgICAgICAgICAgam9iX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIMSRw6MgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGlmICJhY2NvdW50cyIgaW4gZGF0YSBhbmQgaXNpbnN0YW5jZShkYXRhWyJhY2NvdW50cyJdLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50X3V1aWQgaW4gZGF0YVsiYWNjb3VudHMiXToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLm1hcmtfYXNfc3luY2VkKCJhY2NvdW50cyIsIGFjY291bnRfdXVpZCkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIMSRw6MgxJHhu5NuZyBi4buZOiB7YWNjb3VudF91dWlkfSIpCiAgICAgICAgICAgICAgICBhY2NvdW50X2NvdW50ID0gbGVuKGRhdGFbImFjY291bnRzIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBqb2IgxJHDoyDEkeG7k25nIGLhu5kKICAgICAgICAgICAgaWYgImpvYnMiIGluIGRhdGEgYW5kIGlzaW5zdGFuY2UoZGF0YVsiam9icyJdLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciBqb2JfdXVpZCBpbiBkYXRhWyJqb2JzIl06CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5tYXJrX2FzX3N5bmNlZCgiam9ic19oaXN0b3J5Iiwgam9iX3V1aWQpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IGpvYiDEkcOjIMSR4buTbmcgYuG7mToge2pvYl91dWlkfSIpCiAgICAgICAgICAgICAgICBqb2JfY291bnQgPSBsZW4oZGF0YVsiam9icyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBIaeG7g24gdGjhu4sgdGjDtG5nIGLDoW8gdOG7lW5nIGjhu6NwIGhv4bq3YyB0aMO0bmcgYsOhbyB04burIHNlcnZlcgogICAgICAgICAgICBpZiAibWVzc2FnZSIgaW4gdGFza19kYXRhOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaMO0bmcgYsOhbyB04burIHNlcnZlcjoge3Rhc2tfZGF0YVsnbWVzc2FnZSddfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEhp4buDbiB0aOG7iyB0aMO0bmcgYsOhbyB04buVbmcgaOG7o3AgbuG6v3Uga2jDtG5nIGPDsyBtZXNzYWdlIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50X2NvdW50ID4gMCBvciBqb2JfY291bnQgPiAwOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kgdGjDoG5oIGPDtG5nOiB7YWNjb3VudF9jb3VudH0gdMOgaSBraG/huqNuLCB7am9iX2NvdW50fSBqb2IiKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5k6IHtzdHIoZSl9IikKICAgICAgICAgICAgCiAgICAKICAgIGRlZiBfaGFuZGxlX2FjY291bnRfdXBkYXRlKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIgY8OzIGPhuqV1IHRyw7pjOgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6ICJ0YXNrXzE3NDkzOTk1MzYyNzJfNjQxIiwKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiAiYTEyNWY2MjRmNDFhNGY3YyIsCiAgICAgICAgICAgICAgICAidGFza190eXBlIjogImFjY291bnRfdXBkYXRlIiwKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAgICJhcHAiOiAiaW5zdGFncmFtIiwKICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAiam9iX21heF9kYXkiOiAxMDgsCiAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDMwLAogICAgICAgICAgICAgICAgICAgICJqb2JfZW5hYmxlIjogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiYWNjb3VudF91dWlkIjogIjdlZDk1NTdkLTc2YTQtNDdmNy04ODUwLTdjZWVmMGM2OTBhZiIKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICIiLAogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJwZW5kaW5nIgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIGRhdGEgPSB0YXNrX2RhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGRhdGEgb3IgImFjY291bnRfdXVpZCIgbm90IGluIGRhdGE6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiROG7ryBsaeG7h3UgdMOgaSBraG/huqNuIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiROG7ryBsaeG7h3UgdMOgaSBraG/huqNuIGtow7RuZyBo4bujcCBs4buHIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIHThu6sgREIKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnRfYnlfdXVpZChkYXRhWyJhY2NvdW50X3V1aWQiXSkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gduG7m2kgVVVJRDoge2RhdGFbJ2FjY291bnRfdXVpZCddfSIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgICAgIHZhbGlkX2ZpZWxkcyA9IFsic3RhdHVzIiwgImpvYl9tYXhfZGF5IiwgIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgImpvYl9lbmFibGUiLCAiam9iX2Rpc2FibGVfdW50aWwiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciLCAiZm9sbG93X2Rpc2FibGVfdW50aWwiLCAiZm9sbG93X3RvZGF5IiwgImZvbGxvd19pbl9zZXNzaW9uIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgIm1heF9mb2xsb3dfZGF5IiwgIm1heF9mb2xsb3dfc2Vzc2lvbiIsICJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIl0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBzdGF0dXMgPSAiZGVsZXRlIiB0aMOsIHjDs2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGlmIGRhdGEuZ2V0KCJzdGF0dXMiKSA9PSAiZGVsZXRlIjoKICAgICAgICAgICAgICAgIGFjY291bnRfdXVpZCA9IGRhdGFbImFjY291bnRfdXVpZCJdCiAgICAgICAgICAgICAgICBhY2NvdW50X3VzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICJVbmtub3duIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gecOqdSBj4bqndSB4w7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0gKFVVSUQ6IHthY2NvdW50X3V1aWR9KSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgMS4gWMOzYSB04bqldCBj4bqjIGpvYiBoaXN0b3J5IGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgam9iX2hpc3RvcnlfZGVsZXRlZCA9IHNlbGYuZGIuZGVsZXRlX2pvYl9oaXN0b3J5X2J5X2FjY291bnQoYWNjb3VudF91dWlkKQogICAgICAgICAgICAgICAgaWYgam9iX2hpc3RvcnlfZGVsZXRlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgeMOzYSBqb2IgaGlzdG9yeSBj4bunYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgeMOzYSBqb2IgaGlzdG9yeSBj4bunYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyAyLiBYw7NhIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgYWNjb3VudF9kZWxldGVkID0gc2VsZi5kYi5kZWxldGVfYWNjb3VudChhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgaWYgYWNjb3VudF9kZWxldGVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB4w7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIGto4buPaSBkYXRhYmFzZSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgInN1Y2Nlc3MiLCBmIsSQw6MgeMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJLaMO0bmcgdGjhu4MgeMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGF0YS5pdGVtcygpOgogICAgICAgICAgICAgICAgaWYga2V5IGluIHZhbGlkX2ZpZWxkczoKICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVtrZXldID0gdmFsdWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHVwZGF0ZV9kYXRhOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyBjw7MgdGjDtG5nIHRpbiBj4bqnbiBj4bqtcCBuaOG6rXQiKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsICJLaMO0bmcgY8OzIHRow7RuZyB0aW4gY+G6p24gY+G6rXAgbmjhuq10IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgbOG6oWkgdsOgbyBEQgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgc3VjY2VzcyA9IHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnJyl9IChVVUlEOiB7ZGF0YVsnYWNjb3VudF91dWlkJ119KSB24bubaSBk4buvIGxp4buHdToge3VwZGF0ZV9kYXRhfSIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIGYixJDDoyBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJycpfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0aOG7gyBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJycpfSIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9tc2cgPSBmIkzhu5dpIHjhu60gbMO9IGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o246IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQoKICAgIGRlZiBfaGFuZGxlX3ZlcmlmeV9nb2xpa2Uoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHZlcmlmeSB0w6BpIGtob+G6o24gZ29saWtlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyIGPDsyBj4bqldSB0csO6YzoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgInRhc2tfaWQiOiAidGFza18xNzQ5Mzk5NTM2MjcyXzY0MSIsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogImExMjVmNjI0ZjQxYTRmN2MiLAogICAgICAgICAgICAgICAgInRhc2tfdHlwZSI6ICJ2ZXJpZnlfZ29saWtlIiwKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAgICJhcHAiOiAiaW5zdGFncmFtIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogInBlbmRpbmciCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgdmVyaWZ5IGdvbGlrZSB04burIHNlcnZlciAodGFza19pZDoge3Rhc2tfaWR9KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIMSRxINuZyBrw70gcHJveHkgbuG6v3UgY+G6p24gdHLGsOG7m2Mga2hpIHZlcmlmeSBHb0xpa2UgYWNjb3VudHMKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLmpvYl9zZXJ2aWNlLCAncHJveHlfc2VydmljZScpOgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuam9iX3NlcnZpY2UucHJveHlfc2VydmljZS5jaGVja19wcm94eV9yZXF1aXJlbWVudCgpOgogICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJLaMO0bmcgdGjhu4MgbOG6pXkgcHJveHkgY2hvIHZp4buHYyB2ZXJpZnkgR29MaWtlIGFjY291bnRzIgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGVycm9yX21zZykKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBwcm94eV9zZXJ2aWNlIHRyb25nIGpvYl9zZXJ2aWNlIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGFwcF9uYW1lID0gZGF0YS5nZXQoImFwcCIpCiAgICAgICAgICAgIGlmIG5vdCBhcHBfbmFtZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJUaGnhur91IHRow7RuZyB0aW4gYXBwIHRyb25nIGThu68gbGnhu4d1IHRhc2siCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEltcG9ydCBnb2xpa2Vfc2VydmljZSBraGkgY+G6p24gdGhp4bq/dAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIHNlcnZpY2VzLmdvbGlrZV9zZXJ2aWNlIGltcG9ydCBHb2xpa2VTZXJ2aWNlCiAgICAgICAgICAgICAgICBnb2xpa2Vfc2VydmljZSA9IEdvbGlrZVNlcnZpY2Uoc2VsZi5kYikKICAgICAgICAgICAgZXhjZXB0IEltcG9ydEVycm9yIGFzIGU6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0aOG7gyBpbXBvcnQgR29saWtlU2VydmljZToge3N0cihlKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBjaMawYSBsacOqbiBr4bq/dCBnb2xpa2UKICAgICAgICAgICAgdW5saW5rZWRfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50c19ieV9hcHBfYW5kX2dvbGlrZV9zdGF0dXMoYXBwX25hbWUsIGlzX2xpbmtlZD1GYWxzZSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB1bmxpbmtlZF9hY2NvdW50czoKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSBuw6BvIGNoxrBhIGxpw6puIGvhur90IGdvbGlrZSIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbih1bmxpbmtlZF9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IGNoxrBhIGxpw6puIGvhur90IGdvbGlrZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFZlcmlmeSB04burbmcgdMOgaSBraG/huqNuCiAgICAgICAgICAgIHZlcmlmaWNhdGlvbl9yZXN1bHRzID0gW10KICAgICAgICAgICAgc3VjY2Vzc19jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIHVubGlua2VkX2FjY291bnRzOgogICAgICAgICAgICAgICAgdW5pcXVlX3VzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiBub3QgdW5pcXVlX3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIElEIHthY2NvdW50LmdldCgnaWQnKX0ga2jDtG5nIGPDsyB1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIEfhu41pIEFQSSB2ZXJpZnkgYWNjb3VudCBxdWEgZ29saWtlX3NlcnZpY2UKICAgICAgICAgICAgICAgICAgICBlbmRwb2ludCA9IGYiL3thcHBfbmFtZX0tYWNjb3VudC92ZXJpZnktYWNjb3VudCIKICAgICAgICAgICAgICAgICAgICB2ZXJpZnlfZGF0YSA9IHsib2JqZWN0X2lkIjogdW5pcXVlX3VzZXJuYW1lfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVOG6oW8gVVJMIMSR4bqneSDEkeG7pwogICAgICAgICAgICAgICAgICAgIHVybCA9IGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9e2VuZHBvaW50fSIKICAgICAgICAgICAgICAgICAgICByZXN1bHQgPSBnb2xpa2Vfc2VydmljZS5hcGlfcmVxdWVzdCh1cmwsIG1ldGhvZD0iUE9TVCIsIHBheWxvYWQ9dmVyaWZ5X2RhdGEpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgcmVzdWx0LmdldCgic3VjY2VzcyIpIGFuZCByZXN1bHQuZ2V0KCJzdGF0dXMiKSA9PSAyMDA6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVmVyaWZ5IHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlID0gcmVzdWx0LmdldCgibWVzc2FnZSIsICJUaMOgbmggY8O0bmchIikKICAgICAgICAgICAgICAgICAgICAgICAgdmVyaWZpY2F0aW9uX3Jlc3VsdHMuYXBwZW5kKGYiW1RSVUVdW3t1bmlxdWVfdXNlcm5hbWV9XToge21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc19jb3VudCArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxpw6puIGvhur90IHRyb25nIGRhdGFiYXNlCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX2dvbGlrZV9saW5rZWQiOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImdvbGlrZV91c2VyX2lkIjogcmVzdWx0LmdldCgiZGF0YSIsIHt9KS5nZXQoInVzZXJfaWQiKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZ5IHRow6BuaCBjw7RuZyB0w6BpIGtob+G6o24ge3VuaXF1ZV91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIFZlcmlmeSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JfbWVzc2FnZSA9IHJlc3VsdC5nZXQoIm1lc3NhZ2UiLCAiTOG7l2kga2jDtG5nIHjDoWMgxJHhu4tuaCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHZlcmlmaWNhdGlvbl9yZXN1bHRzLmFwcGVuZChmIltGQUxTRV1be3VuaXF1ZV91c2VybmFtZX1dOiB7ZXJyb3JfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlZlcmlmeSB0aOG6pXQgYuG6oWkgdMOgaSBraG/huqNuIHt1bmlxdWVfdXNlcm5hbWV9OiB7ZXJyb3JfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBlcnJvcl9tZXNzYWdlID0gZiJM4buXaSBraGkgdmVyaWZ5OiB7c3RyKGUpfSIKICAgICAgICAgICAgICAgICAgICB2ZXJpZmljYXRpb25fcmVzdWx0cy5hcHBlbmQoZiJbRkFMU0VdW3t1bmlxdWVfdXNlcm5hbWV9XToge2Vycm9yX21lc3NhZ2V9IikKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IHTDoGkga2hv4bqjbiB7dW5pcXVlX3VzZXJuYW1lfToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBiw6FvIGPDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgcmVwb3J0X21lc3NhZ2UgPSAiXG4iLmpvaW4odmVyaWZpY2F0aW9uX3Jlc3VsdHMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIGLDoW8gY8OhbyB0YXNrCiAgICAgICAgICAgIGlmIHN1Y2Nlc3NfY291bnQgPT0gbGVuKHVubGlua2VkX2FjY291bnRzKToKICAgICAgICAgICAgICAgICMgVOG6pXQgY+G6oyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiVmVyaWZ5IHRow6BuaCBjw7RuZyB7c3VjY2Vzc19jb3VudH0ve2xlbih1bmxpbmtlZF9hY2NvdW50cyl9IHTDoGkga2hv4bqjbjpcbntyZXBvcnRfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgZ29saWtlIGhvw6BuIHRow6BuaDoge3N1Y2Nlc3NfY291bnR9L3tsZW4odW5saW5rZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgQ8OzIG3hu5l0IHPhu5EgdGjhuqV0IGLhuqFpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGYiVmVyaWZ5IHRow6BuaCBjw7RuZyB7c3VjY2Vzc19jb3VudH0ve2xlbih1bmxpbmtlZF9hY2NvdW50cyl9IHTDoGkga2hv4bqjbjpcbntyZXBvcnRfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJWZXJpZnkgZ29saWtlIGhvw6BuIHRow6BuaCB24bubaSBs4buXaToge3N1Y2Nlc3NfY291bnR9L3tsZW4odW5saW5rZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSB2ZXJpZnkgZ29saWtlOiB7c3RyKGUpfSIKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfcHJveHkoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCBwcm94eQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlciBjw7MgY+G6pXUgdHLDumM6CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJ0YXNrX2lkIjogInRhc2tfMTc0OTM5OTUzNjI3Ml82NDEiLAogICAgICAgICAgICAgICAgImRldmljZV9pZCI6ICJhMTI1ZjYyNGY0MWE0ZjdjIiwKICAgICAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAidXBkYXRlX3Byb3h5IiwKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAgICJwcm94eV9jb25maWciOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICJwcm94eV80NTYiLAogICAgICAgICAgICAgICAgICAgICAgICAiaG9zdCI6ICJwcm94eS5leGFtcGxlLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJwb3J0IjogODA4MCwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIjogInVzZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAicGFzc3dvcmQiOiAicGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImh0dHAiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogInBlbmRpbmciCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHByb3h5IHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHByb3h5X2NvbmZpZyA9IGRhdGEKICAgICAgICAgICAgaWYgbm90IHByb3h5X2NvbmZpZzoKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJUaGnhur91IHRow7RuZyB0aW4gcHJveHlfY29uZmlnIHRyb25nIGThu68gbGnhu4d1IHRhc2siCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgY+G6pXUgaMOsbmggcHJveHkgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfY29uZmlnIiwgcHJveHlfY29uZmlnKQogICAgICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIHnDqnUgY+G6p3UgcHJveHkgdsOsIMSRw6Mgbmjhuq1uIMSRxrDhu6NjIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfcmVxdWVzdGVkIiwgMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggcHJveHk6IHtwcm94eV9jb25maWdbJ25hbWUnXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu61pIGLDoW8gY8OhbyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHN1Y2Nlc3NfbXNnID0gZiLEkMOjIGPhuq1wIG5o4bqtdCBwcm94eToge3Byb3h5X2NvbmZpZ1snbmFtZSddfSIKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgc3VjY2Vzc19tc2cpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSBraGkgbMawdSBj4bqldSBow6xuaCBwcm94eToge3N0cihlKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgcHJveHk6IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCgogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIMSR4buZbmcgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBjw6FjIGhhbmRsZXIgdHLGsOG7m2Mga2hpIGvhur90IG7hu5FpCiAgICAgICAgICAgIHNlbGYuc2V0dXBfbXF0dF9oYW5kbGVycygpCiAgICAgICAgICAgIHNlbGYuY29ubmVjdCgpCiAgICAgICAgICAgICMgS2jhu59pIMSR4buZbmcgc3luYyB0aHJlYWQgc2F1IGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgc2VsZi5zdGFydF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZSB2w6AgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgTVFUVCBzZXJ2aWNlIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9vbl9tZXNzYWdlKHNlbGYsIGNsaWVudCwgdXNlcmRhdGEsIG1zZywgcHJvcGVydGllcz1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBDYWxsYmFjayBraGkgbmjhuq1uIMSRxrDhu6NjIG1lc3NhZ2UgdOG7qyBNUVRUIGJyb2tlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNsaWVudDogTVFUVCBjbGllbnQgaW5zdGFuY2UKICAgICAgICAgICAgdXNlcmRhdGE6IFVzZXIgZGF0YSDEkcaw4bujYyB0cnV54buBbiB2w6BvIGNsaWVudAogICAgICAgICAgICBtc2c6IE1lc3NhZ2Ugb2JqZWN0IGNo4bupYSB0b3BpYyB2w6AgcGF5bG9hZAogICAgICAgICAgICBwcm9wZXJ0aWVzOiBQcm9wZXJ0aWVzIGPhu6dhIG1lc3NhZ2UgKE1RVFQgdjUpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljOiB7bXNnLnRvcGljfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFBhcnNlIHBheWxvYWQgSlNPTgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXlsb2FkID0ganNvbi5sb2Fkcyhtc2cucGF5bG9hZC5kZWNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIGV4Y2VwdCBqc29uLkpTT05EZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBwYXJzZSBKU09OIHThu6sgcGF5bG9hZDoge21zZy5wYXlsb2FkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70gbWVzc2FnZSBk4buxYSB0csOqbiB0b3BpYwogICAgICAgICAgICBpZiBtc2cudG9waWMgPT0gc2VsZi50b3BpY19zZXJ2ZXJfdGFzazoKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9zZXJ2ZXJfdGFzayhwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljIGtow7RuZyB4w6FjIMSR4buLbmg6IHttc2cudG9waWN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgeOG7rSBsw70gbWVzc2FnZToge3N0cihlKX0iKQoKICAgIGRlZiBfaGFuZGxlX3NlcnZlcl90YXNrKHNlbGYsIHBheWxvYWQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcGF5bG9hZDogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza190eXBlID0gcGF5bG9hZC5nZXQoInRhc2tfdHlwZSIpCiAgICAgICAgICAgIGlmIG5vdCB0YXNrX3R5cGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiTmjhuq1uIHRhc2sga2jDtG5nIGPDsyB0YXNrX3R5cGUiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJOaOG6rW4gdGFzayB04burIHNlcnZlcjoge3Rhc2tfdHlwZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBoYW5kbGVyIHTGsMahbmcg4bupbmcgbuG6v3UgxJHDoyDEkcSDbmcga8O9CiAgICAgICAgICAgIGlmIHRhc2tfdHlwZSBpbiBzZWxmLnRhc2tfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnNbdGFza190eXBlXShwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgaGFuZGxlciBjaG8gdGFza190eXBlOiB7dGFza190eXBlfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgeOG7rSBsw70gdGFzayB04burIHNlcnZlcjoge3N0cihlKX0iKQogICAgCiAgICBkZWYgX21vbml0b3JfcmFtX3VzYWdlKHNlbGYsIGRldmljZV9pbmZvOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgVGhlbyBkw7VpIFJBTSB2w6AgdOG7sSDEkeG7mW5nIHJlYm9vdCBu4bq/dSBSQU0gY2FvIGxpw6puIHThu6VjCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGV2aWNlX2luZm86IFRow7RuZyB0aW4gdGhp4bq/dCBi4buLIGNo4bupYSBSQU0gdXNhZ2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgcGjhuqduIHRyxINtIFJBTSB0cuG7sWMgdGnhur9wIHThu6sgZGV2aWNlX2luZm8gKG3hurdjIMSR4buLbmggbMOgIDAgbuG6v3Uga2jDtG5nIGPDsykKICAgICAgICAgICAgcmFtX3VzYWdlX3BlcmNlbnQgPSBkZXZpY2VfaW5mby5nZXQoInJhbV9wZXJjZW50YWdlIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJhbV91c2FnZV9wZXJjZW50ID09IDA6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIktow7RuZyBjw7MgdGjDtG5nIHRpbiByYW1fcGVyY2VudGFnZSB0cm9uZyBkZXZpY2VfaW5mbywgc+G7rSBk4bulbmcgZ2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIDAiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSB2w6BvIGzhu4tjaCBz4butIChjaOG7iSBnaeG7ryBs4bqhaSAzIGzhuqduIGfhuqduIG5o4bqldCkKICAgICAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeS5hcHBlbmQocmFtX3VzYWdlX3BlcmNlbnQpCiAgICAgICAgICAgIGlmIGxlbihzZWxmLnJhbV91c2FnZV9oaXN0b3J5KSA+IHNlbGYuY29uc2VjdXRpdmVfaGlnaF9yYW1fbGltaXQ6CiAgICAgICAgICAgICAgICBzZWxmLnJhbV91c2FnZV9oaXN0b3J5LnBvcCgwKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiUkFNIGhp4buHbiB04bqhaToge3JhbV91c2FnZV9wZXJjZW50Oi4xZn0lIChs4buLY2ggc+G7rToge1tmJ3t4Oi4xZn0lJyBmb3IgeCBpbiBzZWxmLnJhbV91c2FnZV9oaXN0b3J5XX0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBjw7MgxJHhu6cgMyBs4bqnbiDEkW8gdsOgIHThuqV0IGPhuqMgxJHhu4F1ID4gbmfGsOG7oW5nCiAgICAgICAgICAgIGlmIGxlbihzZWxmLnJhbV91c2FnZV9oaXN0b3J5KSA+PSBzZWxmLmNvbnNlY3V0aXZlX2hpZ2hfcmFtX2xpbWl0OgogICAgICAgICAgICAgICAgaWYgYWxsKHVzYWdlID4gc2VsZi5oaWdoX3JhbV90aHJlc2hvbGQgZm9yIHVzYWdlIGluIHNlbGYucmFtX3VzYWdlX2hpc3RvcnkpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUkFNIGNhbyBsacOqbiB04bulYyB7c2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdH0gbOG6p24gKD57c2VsZi5oaWdoX3JhbV90aHJlc2hvbGR9JSk6IHtbZid7eDouMWZ9JScgZm9yIHggaW4gc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeV19IikKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiQuG6r3QgxJHhuqd1IHJlYm9vdCB0aGnhur90IGLhu4sgxJHhu4MgZ2nhuqNpIHBow7NuZyBSQU0uLi4iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiByZWJvb3QKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9yZWJvb3RfZGV2aWNlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGfhu61pIGzhu4duaCByZWJvb3QgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBs4buLY2ggc+G7rSBzYXUga2hpIHJlYm9vdAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJhbV91c2FnZV9oaXN0b3J5LmNsZWFyKCkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB0aOG7sWMgaGnhu4duIHJlYm9vdCB0aGnhur90IGLhu4siKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB0aGVvIGTDtWkgUkFNOiB7ZX0iKQogICAgCiAgICBkZWYgX3JlYm9vdF9kZXZpY2Uoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIHJlYm9vdCB0aGnhur90IGLhu4sgcXVhIEFEQgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgREVWSUNFX0lQIHThu6sgY29uZmlnIHRoYXkgdsOsIEFEQl9IT1NUCiAgICAgICAgICAgIGRldmljZV9hZGRyZXNzID0gZiJ7Y29uZmlnLkRFVklDRV9JUH06e2NvbmZpZy5BREJfUE9SVH0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhu4duaCByZWJvb3QgcXVhIEFEQgogICAgICAgICAgICBjbWQgPSBbImFkYiIsICItcyIsIGRldmljZV9hZGRyZXNzLCAicmVib290Il0KICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiByZWJvb3QgdGhp4bq/dCBi4buLOiB7JyAnLmpvaW4oY21kKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oCiAgICAgICAgICAgICAgICBjbWQsCiAgICAgICAgICAgICAgICBjaGVjaz1UcnVlLAogICAgICAgICAgICAgICAgc3Rkb3V0PXN1YnByb2Nlc3MuUElQRSwKICAgICAgICAgICAgICAgIHN0ZGVycj1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgICAgICB0ZXh0PVRydWUsCiAgICAgICAgICAgICAgICB0aW1lb3V0PTEwICAjIFRpbWVvdXQgMTAgZ2nDonkKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJM4buHbmggcmVib290IMSRw6MgxJHGsOG7o2MgZ+G7rWkgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IHN1YnByb2Nlc3MuVGltZW91dEV4cGlyZWQ6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJUaW1lb3V0IGtoaSBn4butaSBs4buHbmggcmVib290ICh0aGnhur90IGLhu4sgY8OzIHRo4buDIMSRYW5nIHJlYm9vdCkiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBDb2kgbmjGsCB0aMOgbmggY8O0bmcgdsOsIGPDsyB0aOG7gyB0aGnhur90IGLhu4sgxJFhbmcgcmVib290CiAgICAgICAgZXhjZXB0IHN1YnByb2Nlc3MuQ2FsbGVkUHJvY2Vzc0Vycm9yIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIHJlYm9vdDoge2Uuc3RkZXJyfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGV4Y2VwdCBGaWxlTm90Rm91bmRFcnJvcjoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgbOG7h25oIGFkYiwga2jDtG5nIHRo4buDIHJlYm9vdCB0aGnhur90IGLhu4siKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtow7RuZyB4w6FjIMSR4buLbmgga2hpIHJlYm9vdCB0aGnhur90IGLhu4s6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQ==').decode('utf-8'))
