import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwsIENhbGxhYmxlCmZyb20gYWJjIGltcG9ydCBBQkMsIGFic3RyYWN0bWV0aG9kCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmltcG9ydCB1cmxsaWIucGFyc2UKaW1wb3J0IHJhbmRvbQppbXBvcnQgY29uZmlnCiMgVOG6oW8gbG9nZ2VyIGNobyBCYXNlSm9iCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkJhc2VKb2IiKQoKY2xhc3MgQmFzZUpvYihBQkMpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gIiIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gIiIKICAgICAgICAjIEjDoG0gc2xlZXAgbeG6t2MgxJHhu4tuaCBsw6AgdGltZS5zbGVlcAogICAgICAgIHNlbGYuX3NsZWVwX2Z1bmMgPSB0aW1lLnNsZWVwCiAgICAgICAgIyBU4bqhbyBsb2dnZXIgY2hvIGluc3RhbmNlIGPhu6UgdGjhu4MKICAgICAgICBzZWxmLmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoZiJKb2Iue3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgc+G7kSBs4bqnbiB1bmZvbGxvdy91bmxpa2UgdOG6oW0gdGjhu51pIHRoZW8gYWNjb3VudF9pZAogICAgICAgIHNlbGYudW5mb2xsb3dfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIFByb3h5IHNlcnZpY2Ugc+G6vSDEkcaw4bujYyBzZXQgc2F1IGtoaSBraOG7n2kgdOG6oW8KICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UgPSBOb25lCiAgICAgICAgCiAgICBkZWYgc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZiwgcHJveHlfc2VydmljZSk6CiAgICAgICAgIiIiCiAgICAgICAgVGhp4bq/dCBs4bqtcCBwcm94eSBzZXJ2aWNlIGNobyBqb2IgaGFuZGxlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHByb3h5X3NlcnZpY2U6IFByb3h5U2VydmljZSBpbnN0YW5jZQogICAgICAgICIiIgogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IHByb3h5X3NlcnZpY2UKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0aGnhur90IGzhuq1wIHByb3h5IHNlcnZpY2UgY2hvIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgIAogICAgQGFic3RyYWN0bWV0aG9kCiAgICBkZWYgZ2V0X2FjY291bnRzX2Zyb21fZGV2aWNlKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIiIiCiAgICAgICAgcGFzcwoKICAgICAgICAKICAgIGRlZiBzeW5jX2FjY291bnRzX3RvX2RiKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sgdsOgbyBkYXRhYmFzZSB2w6AgbWFwIHbhu5tpIHTDoGkga2hv4bqjbiBHb0xpa2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5nZXRfYWNjb3VudHNfZnJvbV9kZXZpY2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICBhbmRyb2lkX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIGhp4buHbiBjw7MgdHJvbmcgREIgY2hvIGFwcCBuw6B5CiAgICAgICAgICAgIGV4aXN0aW5nX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPXNlbGYuYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHNldCBjw6FjIHVuaXF1ZV91c2VybmFtZSB04burIHRoaeG6v3QgYuG7iyDEkeG7gyBk4buFIHNvIHPDoW5oCiAgICAgICAgICAgIGRldmljZV91c2VybmFtZXMgPSBzZXQoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX3VzZXJuYW1lcy5hZGQodXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIHRyb25nIERCIG3DoCBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4sgLT4gxJHDoW5oIGThuqV1IGxvZ291dAogICAgICAgICAgICBmb3IgZXhpc3RpbmdfYWNjb3VudCBpbiBleGlzdGluZ19hY2NvdW50czoKICAgICAgICAgICAgICAgIGV4aXN0aW5nX3VzZXJuYW1lID0gZXhpc3RpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiBleGlzdGluZ191c2VybmFtZSBhbmQgZXhpc3RpbmdfdXNlcm5hbWUgbm90IGluIGRldmljZV91c2VybmFtZXM6CiAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24gY8OzIHRyb25nIERCIG5oxrBuZyBraMO0bmcgY8OzIHRyw6puIHRoaeG6v3QgYuG7iyAtPiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgIT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2V4aXN0aW5nX3VzZXJuYW1lfSBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4ssIMSRw6FuaCBk4bqldSBsb2dvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGV4aXN0aW5nX2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBob+G6t2MgdGjDqm0gbeG7m2kgdsOgbyBEQgogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAjIFRow6ptIHRow7RuZyB0aW4gYXBwIHbDoCBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIGFjY291bnRbImFwcCJdID0gc2VsZi5hcHBfbmFtZQogICAgICAgICAgICAgICAgYWNjb3VudFsiZGV2aWNlX2lkIl0gPSBhbmRyb2lkX2lkCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBsw6AgY2jGsGEgxJHhu5NuZyBi4buZIMSR4buDIGfhu61pIGzDqm4gc2VydmVyCiAgICAgICAgICAgICAgICBhY2NvdW50WyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWkgY2jGsGEgZOG7sWEgdsOgbyB1bmlxdWVfdXNlcm5hbWUgKyBhcHAKICAgICAgICAgICAgICAgIGV4aXN0aW5nX2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50X2J5X3VuaXF1ZV91c2VybmFtZShzZWxmLmFwcF9uYW1lLCBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIGhp4buHbiBjw7MKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gZXhpc3RpbmdfYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSB0w6BpIGtob+G6o24gdHJvbmcgREIgxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgbG9nb3V0IG5oxrBuZyB4deG6pXQgaGnhu4duIGzhuqFpIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAibG9nb3V0IjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBDaOG7iSBj4bqtcCBuaOG6rXQgbmjhu69uZyB0csaw4budbmcgY+G6p24gdGhp4bq/dCwga2jDtG5nIGdoaSDEkcOoIHRvw6BuIGLhu5kgcmVjb3JkCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogYWNjb3VudC5nZXQoImxhc3RfdXBkYXRlIiwgaW50KHRpbWUudGltZSgpKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSDEkcOjIHh14bqldCBoaeG7h24gbOG6oWkgdHLDqm4gdGhp4bq/dCBi4buLLCByZXNldCB04burIGxvZ291dCB24buBIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBDaOG7iSBj4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBjxqEgYuG6o24sIGdp4buvIG5ndXnDqm4gY8OhYyBjb3VudGVyIHbDoCB0aOG7kW5nIGvDqgogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGFjY291bnQuZ2V0KCJsYXN0X3VwZGF0ZSIsIGludCh0aW1lLnRpbWUoKSkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ2jhu4kgY+G6rXAgbmjhuq10IHN0YXR1cyBu4bq/dSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIGtow7RuZyBwaOG6o2kgYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQuZ2V0KCJzdGF0dXMiKSAhPSAiYWN0aXZlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJzdGF0dXMiXSA9IGV4aXN0aW5nX2FjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBUaMOqbSB0w6BpIGtob+G6o24gbeG7m2kgduG7m2kgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBhY2NvdW50WyJzdGF0dXMiXSA9ICJhY3RpdmUiCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5hZGRfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2F1IGtoaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLLCB0aOG7sWMgaGnhu4duIG1hcHBpbmcgduG7m2kgR29MaWtlCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbWFwcGluZyB0w6BpIGtob+G6o24ge3NlbGYuYXBwX25hbWV9IHbhu5tpIEdvTGlrZS4uLiIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gR29MaWtlCiAgICAgICAgICAgICAgICBnb2xpa2VfYWNjb3VudHMgPSBzZWxmLmdldF9nb2xpa2VfYWNjb3VudHMoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHtsZW4oZ29saWtlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIMSRw6MgY+G6rXAgbmjhuq10IHThu6sgREIKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2RldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1zZWxmLmFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBtYXBwaW5nCiAgICAgICAgICAgICAgICAgICAgbWFwcGVkX2NvdW50ID0gc2VsZi5tYXBfZ29saWtlX2FjY291bnRzKGdvbGlrZV9hY2NvdW50cywgdXBkYXRlZF9kZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtYXBwZWRfY291bnQsIGludCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIG1hcHBpbmcge21hcHBlZF9jb3VudH0gdMOgaSBraG/huqNuIHtzZWxmLmFwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggbWFwcGluZyB0w6BpIGtob+G6o24ge3NlbGYuYXBwX25hbWV9IHbhu5tpIEdvTGlrZSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7c2VsZi5hcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIG1hcHBpbmcgduG7m2kgR29MaWtlOiB7ZX0iKQogICAgICAgICAgICAgICAgIyBLaMO0bmcgdGhyb3cgZXhjZXB0aW9uIHbDrCBzeW5jIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iyDEkcOjIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfYWNjb3VudHMKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAKICAgIGRlZiBpc19nb2xpa2VfYXV0aGVudGljYXRlZChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIMSRw6MgY8OzIHRow7RuZyB0aW4geMOhYyB0aOG7sWMgR29MaWtlIGNoxrBhCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIHjDoWMgdGjhu7FjLCBGYWxzZSBu4bq/dSBjaMawYQogICAgICAgICIiIgogICAgICAgIGdvbGlrZV9oZWFkZXJzID0gc2VsZi5kYi5nZXQoImdvbGlrZV9oZWFkZXJzIiwge30pCiAgICAgICAgcmV0dXJuIGJvb2woZ29saWtlX2hlYWRlcnMgYW5kICJhdXRob3JpemF0aW9uIiBpbiBnb2xpa2VfaGVhZGVycykKICAgIAogICAgZGVmIGFwaV9yZXF1ZXN0KHNlbGYsIHVybDogc3RyLCBtZXRob2Q6IHN0ciA9ICJHRVQiLCBwYXlsb2FkOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBH4buNaSBBUEkgR29MaWtlIHRow7RuZyBxdWEgR29MaWtlU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHVybDogVVJMIGPhu6dhIEFQSQogICAgICAgICAgICBtZXRob2Q6IFBoxrDGoW5nIHRo4bupYyBIVFRQIChHRVQgaG/hurdjIFBPU1QpCiAgICAgICAgICAgIHBheWxvYWQ6IEThu68gbGnhu4d1IGfhu61pIMSRaSAoY2hvIFBPU1QgcmVxdWVzdCkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogS+G6v3QgcXXhuqMgQVBJIG7hur91IHRow6BuaCBjw7RuZywgTm9uZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgZ+G7jWkgQVBJOiBHb0xpa2VTZXJ2aWNlIGNoxrBhIMSRxrDhu6NjIGN1bmcgY+G6pXAgY2hvIHtzZWxmLmFwcF9uYW1lfSBqb2IiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IHBheWxvYWQgY2hvIEdFVCByZXF1ZXN0IC0gdGjDqm0gdsOgbyBVUkwKICAgICAgICBpZiBtZXRob2QudXBwZXIoKSA9PSAiR0VUIiBhbmQgcGF5bG9hZDoKICAgICAgICAgICAgIyBU4bqhbyBxdWVyeSBzdHJpbmcgdOG7qyBwYXlsb2FkCiAgICAgICAgICAgIHF1ZXJ5X3BhcmFtcyA9IFtdCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIHBheWxvYWQuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIHZhbHVlIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIHF1ZXJ5X3BhcmFtcy5hcHBlbmQoZiJ7dXJsbGliLnBhcnNlLnF1b3RlKGtleSl9PXt1cmxsaWIucGFyc2UucXVvdGUoc3RyKHZhbHVlKSl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gcXVlcnkgc3RyaW5nIHbDoG8gVVJMCiAgICAgICAgICAgIGlmIHF1ZXJ5X3BhcmFtczoKICAgICAgICAgICAgICAgIHNlcGFyYXRvciA9ICImIiBpZiAiPyIgaW4gdXJsIGVsc2UgIj8iCiAgICAgICAgICAgICAgICB1cmwgPSBmInt1cmx9e3NlcGFyYXRvcn17JyYnLmpvaW4ocXVlcnlfcGFyYW1zKX0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq3dCBwYXlsb2FkIHbhu4EgTm9uZSB2w6wgxJHDoyDEkcawYSB2w6BvIFVSTAogICAgICAgICAgICBwYXlsb2FkID0gTm9uZQogICAgICAgIAogICAgICAgIHJldHVybiBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kLCBwYXlsb2FkKQogICAgCiAgICBkZWYgZ2V0X2dvbGlrZV9hY2NvdW50cyhzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMSRxINuZyBrw70gduG7m2kgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkMaw4budbmcgZOG6q24gQVBJIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVybCA9IGYie3NlbGYuZ2V0X2FjY291bnRfdXJsKCl9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KHVybCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIFtdKQogICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgbWFwX2dvbGlrZV9hY2NvdW50cyhzZWxmLCBnb2xpa2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dLCBkZXZpY2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICDDgW5oIHjhuqEgdMOgaSBraG/huqNuIHThu6sgR29MaWtlIHbDoG8gdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyBHb0xpa2UgQVBJCiAgICAgICAgICAgIGRldmljZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMOhbmggeOG6oQogICAgICAgICIiIgogICAgICAgICMgUGjGsMahbmcgdGjhu6ljIG3hurdjIMSR4buLbmgsIGPhuqduIG92ZXJyaWRlIOG7nyBs4bubcCBjb24KICAgICAgICByZXR1cm4gW10KICAgIAogICAgZGVmIGZldGNoX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gam9iIHThu6sgR29MaWtlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogVGjDtG5nIHRpbiBqb2IgbuG6v3UgY8OzLCBOb25lIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDGsOG7nW5nIGThuqtuIEFQSSBs4bqleSBqb2IKICAgICAgICAgICAgdXJsID0gZiJ7c2VsZi5nZXRfam9ic191cmwoKX0iCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRoYW0gc+G7kSB0w7l5IHRoZW8gbG/huqFpIGFwcAogICAgICAgICAgICBwYXJhbXMgPSBzZWxmLmdldF9qb2JfcGFyYW1zKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIEFQSQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuYXBpX3JlcXVlc3QodXJsLCAiR0VUIiwgcGFyYW1zKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3VjY2VzcyIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGpvYiA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBqb2I6CiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3Ugam9iCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYubWFwX2pvYl9kYXRhKGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBs4bqleSBqb2IiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICBkZWYgbWFwX2pvYl9kYXRhKHNlbGYsIGpvYl9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQ2h14bqpbiBow7NhIGThu68gbGnhu4d1IGpvYiB04burIEFQSQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9kYXRhOiBE4buvIGxp4buHdSBqb2IgdOG7qyBBUEkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IEThu68gbGnhu4d1IGpvYiDEkcOjIGNodeG6qW4gaMOzYQogICAgICAgICIiIgogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhcHAiOiBzZWxmLmFwcF9uYW1lLAogICAgICAgICAgICAiaWQiOiBqb2JfZGF0YS5nZXQoImlkIiksCiAgICAgICAgICAgICJsaW5rIjogam9iX2RhdGEuZ2V0KCJsaW5rIiksCiAgICAgICAgICAgICJ0eXBlIjogam9iX2RhdGEuZ2V0KCJ0eXBlIiksCiAgICAgICAgICAgICJvYmplY3RfaWQiOiBqb2JfZGF0YS5nZXQoIm9iamVjdF9pZCIpLAogICAgICAgICAgICAicHJpY2VfYWZ0ZXJfY29zdCI6IGpvYl9kYXRhLmdldCgicHJpY2VfYWZ0ZXJfY29zdCIpLAogICAgICAgICAgICAic3RhdHVzIjogImlkbGUiLCAgIyBTdGF0dXMgbeG6t2MgxJHhu4tuaCBsw6AgaWRsZQogICAgICAgICAgICAicmF3X2RhdGEiOiBqb2JfZGF0YSAgIyBMxrB1IGzhuqFpIGThu68gbGnhu4d1IGfhu5FjIMSR4buDIHRoYW0ga2jhuqNvIGtoaSBj4bqnbgogICAgICAgIH0KICAgIAogICAgZGVmIHZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCB2YWxpZGF0ZSBqb2IgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyB2YWxpZGF0aW9uOgogICAgICAgICAgICAgICAgLSB2YWxpZCAoYm9vbCk6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICAgICAgICAgLSBzaG91bGRfc2tpcCAoYm9vbCk6IFRydWUgbuG6v3UgbsOqbiBza2lwIGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgICAgICAgICAtIHJlYXNvbiAoc3RyKTogTMO9IGRvIGtow7RuZyBo4bujcCBs4buHIGhv4bq3YyBza2lwCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGNoaSB0aeG6v3QKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgIGpvYl9wcmljZSA9IGpvYi5nZXQoInByaWNlX2FmdGVyX2Nvc3QiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYiBmb2xsb3cKICAgICAgICAgICAgaWYgam9iX3R5cGUgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICAjIDEuIEtp4buDbSB0cmEgZ2nDoSB0aeG7gW4gY+G7p2Egam9iIGZvbGxvdwogICAgICAgICAgICAgICAgbWluX2ZvbGxvd19wcmljZSA9IHNlbGYuZGIuZ2V0KCJtaW5fZm9sbG93X3ByaWNlIiwgMzApICAjIE3hurdjIMSR4buLbmggMzAKICAgICAgICAgICAgICAgIGlmIGpvYl9wcmljZSA8IG1pbl9mb2xsb3dfcHJpY2U6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAgICAgInZhbGlkIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJzaG91bGRfc2tpcCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZiJKb2IgZm9sbG93IGPDsyBnacOhIHtqb2JfcHJpY2V9IDwge21pbl9mb2xsb3dfcHJpY2V9LCBza2lwIGpvYi4iCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6MgYuG7jyBraeG7g20gdHJhIGtow7NhIGZvbGxvdyB2w6wga2jDtG5nIGPDsm4gZ2nhu5tpIGjhuqFuIGZvbGxvdwogICAgICAgICAgICAKICAgICAgICAgICAgIyBKb2IgaOG7o3AgbOG7hwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInZhbGlkIjogVHJ1ZSwKICAgICAgICAgICAgICAgICJzaG91bGRfc2tpcCI6IEZhbHNlLAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiSm9iIGjhu6NwIGzhu4ciCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdmFsaWRhdGUgam9iOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAidmFsaWQiOiBGYWxzZSwKICAgICAgICAgICAgICAgICJzaG91bGRfc2tpcCI6IEZhbHNlLAogICAgICAgICAgICAgICAgInJlYXNvbiI6ICJ2YWxpZGF0aW9uX2Vycm9yIiwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogZiJM4buXaSBraGkgdmFsaWRhdGUgam9iOiB7c3RyKGUpfSIKICAgICAgICAgICAgfQogICAgCiAgICBkZWYgZXhlY3V0ZV9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiBqb2IsIGJhbyBn4buTbToKICAgICAgICAgICAgICAgIC0gc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgICAgICAwOiBDaMawYSB0aOG7sWMgaGnhu4duCiAgICAgICAgICAgICAgICAgICAgMTogVGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgMjogVGjhuqV0IGLhuqFpLCBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgICAgICAgICAgMzogVGjhuqV0IGLhuqFpLCDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICAtIHN1Y2Nlc3MgKGJvb2wpOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBN4bq3YyDEkeG7i25oIGtow7RuZyBsw6BtIGfDrCwgY+G6p24gb3ZlcnJpZGUg4bufIGzhu5twIGNvbgogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGpvYiBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAic3RhdHVzIjogMCwKICAgICAgICAgICAgIm1lc3NhZ2UiOiAiQ2jGsGEgdGjhu7FjIGhp4buHbiBqb2IiLAogICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlCiAgICAgICAgfQogICAgCiAgICBkZWYgcmVwb3J0X2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgcmVzdWx0OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBCw6FvIGPDoW8ga+G6v3QgcXXhuqMgam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICByZXN1bHQ6IEvhur90IHF14bqjIHRo4buxYyBoaeG7h24gam9iIGJhbyBn4buTbToKICAgICAgICAgICAgICAgIC0gc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgICAgICAxOiBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAyOiBUaOG6pXQgYuG6oWksIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcKICAgICAgICAgICAgICAgICAgICAzOiBUaOG6pXQgYuG6oWksIMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgICAgIC0gbWVzc2FnZSAoc3RyKTogVGjDtG5nIGLDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIC0gc3VjY2VzcyAoYm9vbCk6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBiw6FvIGPDoW8gdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAgICAgam9iX3R5cGUgPSBqb2IuZ2V0KCJ0eXBlIiwgIiIpCiAgICAgICAgICAgIGpvYl9zdGF0dXMgPSByZXN1bHQuZ2V0KCJzdGF0dXMiLCAwKQogICAgICAgICAgICBqb2Jfc3VjY2VzcyA9IHJlc3VsdC5nZXQoInN1Y2Nlc3MiLCBGYWxzZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR2hpIGzhuqFpIGzhu4tjaCBz4butIGpvYgogICAgICAgICAgICBzZWxmLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIGPDsyBJRCBqb2IgxJHhu4MgYsOhbyBjw6FvIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGpvYiB2w6AgeOG7rSBsw70gdMawxqFuZyDhu6luZwogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBzdGF0dXMgbMOgIDIgKGzhu5dpIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcpLCBo4buneSBqb2IgdsOgIGLDoW8gY8OhbyB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSAyOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiB7am9iX2lkfSwga2jDtG5nIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZywgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHJldHVybiBzZWxmLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Ugc3RhdHVzIGzDoCAzICjEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlKSwgxJHhur9tIHPhu5EgbOG6p24gdsOgIHThuqFtIGThu6tuZyB0w6BpIGtob+G6o24ga2hpIMSR4bqhdCA1IGzhuqduCiAgICAgICAgICAgIGlmIGpvYl9zdGF0dXMgPT0gMzoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICBhY2NvdW50X3VzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgSOG7p3kgam9iIGhp4buHbiB04bqhaQogICAgICAgICAgICAgICAgc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgc+G7kSBs4bqnbiB1bmZvbGxvdy91bmxpa2UgaGnhu4duIHThuqFpIHThu6sgbWVtb3J5IHbDoCB0xINuZyBsw6puIDEKICAgICAgICAgICAgICAgIHVuZm9sbG93X2NvdW50ID0gc2VsZi51bmZvbGxvd19jb3VudHMuZ2V0KGFjY291bnRfaWQsIDApICsgMQogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19jb3VudHNbYWNjb3VudF9pZF0gPSB1bmZvbGxvd19jb3VudAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiUGjDoXQgaGnhu4duIGLhu4sgdW5mb2xsb3cvdW5saWtlIGzhuqduIHt1bmZvbGxvd19jb3VudH0sIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IGPhuqV1IGjDrG5oIHPhu5EgbOG6p24gdOG7kWkgxJFhIHbDoCB0aOG7nWkgZ2lhbiBwZW5hbHR5IHThu6sgY29uZmlnIGhv4bq3YyBkYXRhYmFzZQogICAgICAgICAgICAgICAgbWF4X3VuZm9sbG93X2F0dGVtcHRzID0gc2VsZi5kYi5nZXQoIm1heF91bmZvbGxvd19hdHRlbXB0cyIsIGNvbmZpZy5NQVhfVU5GT0xMT1dfQVRURU1QVFMpCiAgICAgICAgICAgICAgICB1bmZvbGxvd19wZW5hbHR5X2hvdXJzID0gc2VsZi5kYi5nZXQoInVuZm9sbG93X3BlbmFsdHlfaG91cnMiLCBjb25maWcuVU5GT0xMT1dfUEVOQUxUWV9IT1VSUykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSDEkeG6oXQgc+G7kSBs4bqnbiB04buRaSDEkWEgdGjDrCB04bqhbSBk4burbmcgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBpZiB1bmZvbGxvd19jb3VudCA+PSBtYXhfdW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0gxJHDoyBi4buLIHVuZm9sbG93L3VubGlrZSB7dW5mb2xsb3dfY291bnR9IGzhuqduIC0gVOG6oW0gZOG7q25nIHt1bmZvbGxvd19wZW5hbHR5X2hvdXJzfWgiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVOG6oW0gZOG7q25nIHTDoGkga2hv4bqjbiB0aGVvIGPhuqV1IGjDrG5oIHbDoCByZXNldCBjb3VudGVyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZCwgCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9dW5mb2xsb3dfcGVuYWx0eV9ob3VycyAqIDYwLCAgIyBDaHV54buDbiB04burIGdp4budIHNhbmcgcGjDunQKICAgICAgICAgICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiQuG7iyBwaMOhdCBoaeG7h24gdW5mb2xsb3cvdW5saWtlIHt1bmZvbGxvd19jb3VudH0gbOG6p24iCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciB0cm9uZyBtZW1vcnkgc2F1IGtoaSB04bqhbSBk4burbmcKICAgICAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2NvdW50c1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIlTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0gKHtzZWxmLmFwcF9uYW1lfSkgYuG7iyB04bqhbSBk4burbmcge3VuZm9sbG93X3BlbmFsdHlfaG91cnN9aCBkbyB1bmZvbGxvdy91bmxpa2Uge3VuZm9sbG93X2NvdW50fSBs4bqnbiIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IGPDsm4ge21heF91bmZvbGxvd19hdHRlbXB0cyAtIHVuZm9sbG93X2NvdW50fSBs4bqnbiBj4bqjbmggYsOhbyB0csaw4bubYyBraGkgYuG7iyB04bqhbSBk4burbmciKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGpvYl9zdGF0dXMgPT0gNDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJZw6p1IGPhuqd1IMSRYW5nIGNo4budIHRyb25nIGpvYiB7am9iX3R5cGV9LCBo4buneSBqb2IiKQogICAgICAgICAgICAgICAgc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Ugam9iIHRow6BuaCBjw7RuZywgYsOhbyBjw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgIGlmIGpvYl9zdWNjZXNzOgogICAgICAgICAgICAgICAgIyBVUkwgQVBJIGLDoW8gY8OhbyBqb2IKICAgICAgICAgICAgICAgIHVybCA9IGYiYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vY29tcGxldGUtam9icyIKICAgICAgICAgICAgICAgIHVybCA9IGYiYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vY29tcGxldGUtam9icyIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBU4bqhbyBwYXlsb2FkIGNobyBiw6FvIGPDoW8gam9iCiAgICAgICAgICAgICAgICBwYXlsb2FkID0gc2VsZi5nZXRfcmVwb3J0X3BheWxvYWQoYWNjb3VudCwgam9iKQogICAgICAgICAgICAgICAgaWYgbm90IHBheWxvYWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB04bqhbyBwYXlsb2FkIGNobyBiw6FvIGPDoW8gam9iIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUaOG7rSBn4buNaSBBUEkgdOG7kWkgxJFhIDMgbOG6p24KICAgICAgICAgICAgICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKDMpOgogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5hcGlfcmVxdWVzdCh1cmwsICJQT1NUIiwgcGF5bG9hZCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBiw6FvIGPDoW8gam9iIHtqb2JfaWR9IHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIgdW5mb2xsb3cvdW5saWtlIHRyb25nIG1lbW9yeSBraGkgam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50X2lkIGluIHNlbGYudW5mb2xsb3dfY291bnRzIGFuZCBzZWxmLnVuZm9sbG93X2NvdW50c1thY2NvdW50X2lkXSA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2NvdW50c1thY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYixJDDoyByZXNldCB1bmZvbGxvd19jb3VudCB24buBIDAgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGVsaWYgcmVzcG9uc2UgYW5kIHJlc3BvbnNlLmdldCgic3RhdHVzIikgPT0gNDAwOgogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXNwb25zZS5nZXQoJ21lc3NhZ2UnLCAnJykKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJbe2F0dGVtcHQgKyAxfV0gQsOhbyBjw6FvIGpvYiBs4buXaToge2Vycm9yX21zZ30sIHRo4butIGzhuqFpIHNhdSA1cy4uLiIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJQaOG6o24gaOG7k2kga2jDtG5nIG1vbmcgxJHhu6NpIGtoaSBiw6FvIGPDoW8gam9iOiB7cmVzcG9uc2V9IikKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdGjDoG5oIGPDtG5nIHNhdSAzIGzhuqduIHRo4butLCBo4buneSBqb2IKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGLDoW8gY8OhbyBqb2Ige2pvYl9pZH0gc2F1IDMgbOG6p24gdGjhu60iKQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuc2tpcF9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBKb2Iga2jDtG5nIHRow6BuaCBjw7RuZywgaOG7p3kgam9iCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiSm9iIHtqb2JfaWR9IGtow7RuZyB0aMOgbmggY8O0bmcsIGjhu6d5IGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9yZXBvcnRfcGF5bG9hZChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVOG6oW8gcGF5bG9hZCBjaG8gdmnhu4djIGLDoW8gY8OhbyBob8OgbiB0aMOgbmggam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogUGF5bG9hZCBjaG8gQVBJIGLDoW8gY8OhbwogICAgICAgICIiIgogICAgICAgIGdvbGlrZV9pZCA9IGFjY291bnQuZ2V0KCJnb2xpa2VfaWQiKQogICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAKICAgICAgICBpZiBub3QgZ29saWtlX2lkIG9yIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJUaGnhur91IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhv4bq3YyBqb2IgxJHhu4MgdOG6oW8gcGF5bG9hZCBiw6FvIGPDoW8iKQogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgImFkc19pZCI6IGpvYl9pZCwKICAgICAgICAgICAgImFjY291bnRfaWQiOiBnb2xpa2VfaWQsCiAgICAgICAgICAgICJhc3luYyI6IFRydWUsCiAgICAgICAgICAgICJkYXRhIjogTm9uZQogICAgICAgIH0KICAgIAogICAgZGVmIGdldF9za2lwX3BheWxvYWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFThuqFvIHBheWxvYWQgY2hvIHZp4buHYyBi4buPIHF1YS9o4buneSBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBQYXlsb2FkIGNobyBBUEkgc2tpcCBqb2IKICAgICAgICAiIiIKICAgICAgICBnb2xpa2VfaWQgPSBhY2NvdW50LmdldCgiZ29saWtlX2lkIikKICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgam9iX3R5cGUgPSBqb2IuZ2V0KCJ0eXBlIikKICAgICAgICBvYmplY3RfaWQgPSBqb2IuZ2V0KCJvYmplY3RfaWQiKQogICAgICAgIAogICAgICAgIGlmIG5vdCBnb2xpa2VfaWQgb3Igbm90IGpvYl9pZDoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIlRoaeG6v3UgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gaG/hurdjIGpvYiDEkeG7gyB04bqhbyBwYXlsb2FkIGjhu6d5IikKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhZHNfaWQiOiBqb2JfaWQsCiAgICAgICAgICAgICJhY2NvdW50X2lkIjogZ29saWtlX2lkLAogICAgICAgICAgICAib2JqZWN0X2lkIjogb2JqZWN0X2lkLAogICAgICAgICAgICAidHlwZSI6IGpvYl90eXBlCiAgICAgICAgfQogICAgICAgIAogICAgZGVmIHNraXBfam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIELhu48gcXVhL2jhu6d5IGpvYiBoaeG7h24gdOG6oWkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgaOG7p3kgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFVSTCBBUEkgxJHhu4Mgc2tpcCBqb2IKICAgICAgICAgICAgdXJsID0gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vc2tpcC1qb2JzIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBwYXlsb2FkIGNobyB2aeG7h2Mgc2tpcCBqb2IKICAgICAgICAgICAgcGF5bG9hZCA9IHNlbGYuZ2V0X3NraXBfcGF5bG9hZChhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIGlmIG5vdCBwYXlsb2FkOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB04bqhbyBwYXlsb2FkIGNobyBza2lwIGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgQVBJCiAgICAgICAgICAgIHJlc3BvbnNlID0gc2VsZi5hcGlfcmVxdWVzdCh1cmwsICJQT1NUIiwgcGF5bG9hZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBo4buneSBqb2Ige2pvYi5nZXQoJ2lkJyl9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkjhu6d5IGpvYiB7am9iLmdldCgnaWQnKX0gdGjhuqV0IGLhuqFpOiB7cmVzcG9uc2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBo4buneSBqb2IiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGRlZiBjbG9zZV9hcHAoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcAogICAgICAgICIiIgogICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgZGVmIGdldF9hcGlfYmFzZV91cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBn4buRYyBj4bunYSBBUEkgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgZ+G7kWMKICAgICAgICAiIiIKICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfSIKICAgIAogICAgZGVmIGdldF9hY2NvdW50X3VybChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgVVJMIEFQSSB0w6BpIGtob+G6o24gY+G7p2EgR29MaWtlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIHTDoGkga2hv4bqjbgogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0ve3NlbGYuYXBwX25hbWV9LWFjY291bnQiCiAgICAKICAgIGRlZiBnZXRfam9ic191cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgam9icyBj4bunYSBHb0xpa2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgam9icwogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vam9icyIKICAgIAogICAgZGVmIGdldF9qb2JfcmVwb3J0X3VybChzZWxmLCBqb2JfaWQ6IHN0cikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgYsOhbyBjw6FvIGpvYiBj4bunYSBHb0xpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfaWQ6IElEIGPhu6dhIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgYsOhbyBjw6FvIGpvYgogICAgICAgICIiIgogICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0ve3NlbGYuYXBwX25hbWV9L2pvYnMve2pvYl9pZH0vcmVwb3J0IgogICAgCiAgICBkZWYgZ2V0X2pvYl9wYXJhbXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRoYW0gc+G7kSDEkeG7gyBn4buNaSBBUEkgbOG6pXkgam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRoYW0gc+G7kQogICAgICAgICIiIgogICAgICAgICMgTeG6t2MgxJHhu4tuaCBraMO0bmcgY8OzIHRoYW0gc+G7kSwgY+G6p24gb3ZlcnJpZGUg4bufIGzhu5twIGNvbgogICAgICAgIHJldHVybiB7fQogICAgCiAgICBkZWYgZ2V0X2FjY291bnRzX2Zyb21fZGV2aWNlKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIlBoxrDGoW5nIHRo4bupYyBjxqEgc+G7nyDEkeG7gyBs4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiwgY+G6p24gb3ZlcnJpZGUg4bufIGNsYXNzIGNvbiIiIgogICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYsIHNsZWVwX2Z1bmM6IENhbGxhYmxlW1tmbG9hdF0sIGJvb2xdKToKICAgICAgICAiIiIKICAgICAgICDEkOG6t3QgaMOgbSBzbGVlcCB0w7l5IGNo4buJbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBzbGVlcF9mdW5jOiBIw6BtIHNsZWVwIG5o4bqtbiBt4buZdCB0aGFtIHPhu5EgbMOgIHPhu5EgZ2nDonkgdsOgIHRy4bqjIHbhu4EgVHJ1ZSBu4bq/dSBzbGVlcCDEkeG7pyB0aOG7nWkgZ2lhbiwKICAgICAgICAgICAgICAgICAgICAgICAgRmFsc2UgbuG6v3UgYuG7iyBk4burbmcgbOG6oWkKICAgICAgICAiIiIKICAgICAgICBzZWxmLl9zbGVlcF9mdW5jID0gc2xlZXBfZnVuYwogICAgICAgIAogICAgZGVmIHNhZmVfc2xlZXAoc2VsZiwgc2Vjb25kczogZmxvYXQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTmfhu6cgYW4gdG/DoG4sIGPDsyB0aOG7gyBk4burbmcgbOG6oWkgbmdheSBs4bqtcCB04bupYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNlY29uZHM6IFPhu5EgZ2nDonkgY+G6p24gbmfhu6cKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuZ+G7pyDEkeG7pyB0aOG7nWkgZ2lhbiwgRmFsc2UgbuG6v3UgYuG7iyBk4burbmcgbOG6oWkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5fc2xlZXBfZnVuYyhzZWNvbmRzKQogICAgCiAgICBkZWYgc3dpdGNoX3RvX2FjY291bnQoc2VsZiwgdGFyZ2V0X2FjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIENodXnhu4NuIMSR4buVaSBzYW5nIHTDoGkga2hv4bqjbiBt4bulYyB0acOqdQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhcmdldF9hY2NvdW50OiBUw6BpIGtob+G6o24gY+G6p24gY2h1eeG7g24gxJHhur9uCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY2h1eeG7g24gxJHhu5VpIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJBhbmcgY2h1eeG7g24gxJHhu5VpIHNhbmcgdMOgaSBraG/huqNuIHt0YXJnZXRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICd1bmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhurd0IHRo4budaSBnaWFuIGNo4budIHThu5FpIMSRYSAoZ2nDonkpCiAgICAgICAgICAgIHRpbWVvdXQgPSA2MAogICAgICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdXNlcm5hbWUgY+G7p2EgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAKICAgICAgICAgICAgY3VycmVudF91c2VybmFtZSA9IHNlbGYuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgdGFyZ2V0X3VzZXJuYW1lID0gdGFyZ2V0X2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAgxJHDum5nIHTDoGkga2hv4bqjbiBy4buTaSwga2jDtG5nIGPhuqduIGNodXnhu4NuIMSR4buVaQogICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lIGFuZCBjdXJyZW50X3VzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIMSRxINuZyBuaOG6rXAgdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IHLhu5NpIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGNoxrBhIMSRxINuZyBuaOG6rXAgxJHDum5nIHTDoGkga2hv4bqjbiwgdGjhu7FjIGhp4buHbiBjaHV54buDbiDEkeG7lWkKICAgICAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgdGltZW91dDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIFBoxrDGoW5nIHRo4bupYyBuw6B5IHPhur0gxJHGsOG7o2MgZ2hpIMSRw6ggYuG7n2kgbOG7m3AgY29uIHTDuXkgdGhlbyDhu6luZyBk4bulbmcKICAgICAgICAgICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5fcGVyZm9ybV9hY2NvdW50X3N3aXRjaCh0YXJnZXRfYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgICAgICAgICAjIMSQ4bujaSBt4buZdCBjaMO6dCDEkeG7gyDhu6luZyBk4bulbmcgbG9hZCB4b25nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHhlbSDEkcOjIGNodXnhu4NuIMSRw7puZyB0w6BpIGtob+G6o24gY2jGsGEKICAgICAgICAgICAgICAgICAgICAgICAgbmV3X3VzZXJuYW1lID0gc2VsZi5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbmV3X3VzZXJuYW1lIGFuZCBuZXdfdXNlcm5hbWUgPT0gdGFyZ2V0X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnJlc2V0X2xvZ2luX3N0YXR1c19ieV9hcHAoc2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQodGFyZ2V0X2FjY291bnRbImlkIl0sIHsiaXNfbG9naW4iOiBUcnVlLCAiaXNfc3luYyI6IEZhbHNlfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGNoxrBhIHRow6BuaCBjw7RuZywgxJHhu6NpIG3hu5l0IGNow7p0IHLhu5NpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuOiB7c3RyKGUpfSIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSBzYXUge3RpbWVvdXR9IGdpw6J5IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfcGVyZm9ybV9hY2NvdW50X3N3aXRjaChzZWxmLCB0YXJnZXRfYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBjw6FjIHRoYW8gdMOhYyBVSSDEkeG7gyBjaHV54buDbiB0w6BpIGtob+G6o24KICAgICAgICBQaMawxqFuZyB0aOG7qWMgbsOgeSBj4bqnbiDEkcaw4bujYyBnaGkgxJHDqCBi4bufaSBs4bubcCBjb24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXJnZXRfYWNjb3VudDogVMOgaSBraG/huqNuIGPhuqduIGNodXnhu4NuIMSR4bq/bgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgIyBQaMawxqFuZyB0aOG7qWMgY8ahIHPhu58gY2jhu4kgbG9nIGPhuqNuaCBiw6FvCiAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlBoxrDGoW5nIHRo4bupYyBfcGVyZm9ybV9hY2NvdW50X3N3aXRjaCBjaMawYSDEkcaw4bujYyB0cmnhu4NuIGtoYWkgY2hvIHtzZWxmLl9fY2xhc3NfXy5fX25hbWVfX30iKQogICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZShzZWxmKSAtPiBPcHRpb25hbFtzdHJdOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyIGhv4bq3YyBOb25lOiBVc2VybmFtZSBj4bunYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgaG/hurdjIE5vbmUgbuG6v3Uga2jDtG5nIGPDswogICAgICAgICIiIgogICAgICAgICMgUGjGsMahbmcgdGjhu6ljIGPGoSBz4bufIGNo4buJIGxvZyBj4bqjbmggYsOhbwogICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJQaMawxqFuZyB0aOG7qWMgZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lIGNoxrBhIMSRxrDhu6NjIHRyaeG7g24ga2hhaSBjaG8ge3NlbGYuX19jbGFzc19fLl9fbmFtZV9ffSIpCiAgICAgICAgcmV0dXJuIE5vbmUKICAgIAogICAgZGVmIHJlY29yZF9qb2JfaGlzdG9yeShzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgcmVzdWx0OiBEaWN0W3N0ciwgQW55XSkgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEdoaSBs4bqhaSBs4buLY2ggc+G7rSBqb2IgdsOgbyBkYXRhYmFzZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgcmVzdWx0OiBL4bq/dCBxdeG6oyB0aOG7sWMgaGnhu4duIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVVSUQgY+G7p2EgYuG6o24gZ2hpIGzhu4tjaCBz4butIGpvYiBob+G6t2MgY2h14buXaSBy4buXbmcgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZAogICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h14bqpbiBi4buLIGThu68gbGnhu4d1IGpvYiBoaXN0b3J5CiAgICAgICAgICAgIGpvYl9kYXRhID0gewogICAgICAgICAgICAgICAgImFjY291bnRfdXVpZCI6IGFjY291bnQuZ2V0KCJhY2NvdW50X3V1aWQiLCAiIiksCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgImFwcCI6IHNlbGYuYXBwX25hbWUsCiAgICAgICAgICAgICAgICAiam9iX2lkIjogam9iLmdldCgiaWQiLCAiIiksCiAgICAgICAgICAgICAgICAiam9iX3R5cGUiOiBqb2IuZ2V0KCJ0eXBlIiwgIiIpLAogICAgICAgICAgICAgICAgIm9iamVjdF9pZCI6IGpvYi5nZXQoIm9iamVjdF9pZCIsICIiKSwKICAgICAgICAgICAgICAgICJsaW5rIjogam9iLmdldCgibGluayIsICIiKSwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiByZXN1bHQuZ2V0KCJzdGF0dXMiLCAwKSwKICAgICAgICAgICAgICAgICJzdWNjZXNzIjogcmVzdWx0LmdldCgic3VjY2VzcyIsIEZhbHNlKSwKICAgICAgICAgICAgICAgICJwcmljZSI6IGpvYi5nZXQoInByaWNlX2FmdGVyX2Nvc3QiLCAwKSwKICAgICAgICAgICAgICAgICJlcnJvcl9tZXNzYWdlIjogcmVzdWx0LmdldCgibWVzc2FnZSIsICIiKSBpZiBub3QgcmVzdWx0LmdldCgic3VjY2VzcyIsIEZhbHNlKSBlbHNlICIiLAogICAgICAgICAgICAgICAgImNyZWF0ZWRfYXQiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZSAgIyDEkOG6o20gYuG6o28gdHLhuqFuZyB0aMOhaSBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgIGpvYl91dWlkID0gc2VsZi5kYi5hZGRfam9iX2hpc3Rvcnkoam9iX2RhdGEpCiAgICAgICAgICAgIGlmIGpvYl91dWlkOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiLEkMOjIGzGsHUgbOG7i2NoIHPhu60gam9iIHtqb2IuZ2V0KCdpZCcpfSB2w6BvIGRhdGFiYXNlIHbhu5tpIFVVSUQ6IHtqb2JfdXVpZH0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBsxrB1IGzhu4tjaCBz4butIGpvYiB7am9iLmdldCgnaWQnKX0gdsOgbyBkYXRhYmFzZSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gam9iX3V1aWQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGdoaSBs4buLY2ggc+G7rSBqb2IiKQogICAgICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgcmVwb3J0X2pvYl9jb21wbGV0ZWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIHJlcG9ydF9kYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgQsOhbyBjw6FvIGpvYiDEkcOjIGhvw6BuIHRow6BuaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgcmVwb3J0X2RhdGE6IEThu68gbGnhu4d1IGLDoW8gY8OhbwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgYsOhbyBjw6FvIHThu6sgQVBJCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGpvYl9pZCB04burIGpvYgogICAgICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgICAgIGlmIG5vdCBqb2JfaWQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYl9pZCB0cm9uZyBqb2IiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiAiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYl9pZCB0cm9uZyBqb2IifQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2h14bqpbiBi4buLIGThu68gbGnhu4d1IGLDoW8gY8OhbwogICAgICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgImlkIjogam9iX2lkLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IFRydWUKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBiw6FvIGPDoW8gbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHJlcG9ydF9kYXRhOgogICAgICAgICAgICAgICAgcGF5bG9hZC51cGRhdGUocmVwb3J0X2RhdGEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkgYsOhbyBjw6FvIGpvYiDEkcOjIGhvw6BuIHRow6BuaAogICAgICAgICAgICB1cmwgPSBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS9hZHZlcnRpc2luZy9wdWJsaXNoZXJzL3tzZWxmLmFwcF9uYW1lfS9jb21wbGV0ZS1qb2JzIgogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kPSJQT1NUIiwgcGF5bG9hZD1wYXlsb2FkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGhvw6BuIHRow6BuaCIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGhvw6BuIHRow6BuaCJ9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgYsOhbyBjw6FvIGpvYiB7am9iX2lkfSBob8OgbiB0aMOgbmggdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MiLCAibWVzc2FnZSI6ICLEkMOjIGLDoW8gY8OhbyBqb2IgaG/DoG4gdGjDoG5oIHRow6BuaCBjw7RuZyIsICJkYXRhIjogcmVzdWx0fQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmgiKQogICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6IGYiTOG7l2kga2hpIGLDoW8gY8OhbyBqb2IgxJHDoyBob8OgbiB0aMOgbmg6IHtzdHIoZSl9In0KICAgICAgICAgICAgCiAgICBkZWYgcmVwb3J0X2pvYl9za2lwcGVkKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCByZWFzb246IHN0ciA9ICIiKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBCw6FvIGPDoW8gam9iIMSRw6MgYuG7iyBi4buPIHF1YQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGpvYjogVGjDtG5nIHRpbiBqb2IKICAgICAgICAgICAgcmVhc29uOiBMw70gZG8gYuG7jyBxdWEgam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyBiw6FvIGPDoW8gdOG7qyBBUEkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgam9iX2lkIHThu6sgam9iCiAgICAgICAgICAgIGpvYl9pZCA9IGpvYi5nZXQoImlkIikKICAgICAgICAgICAgaWYgbm90IGpvYl9pZDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgam9iX2lkIHRyb25nIGpvYiIpCiAgICAgICAgICAgICAgICByZXR1cm4geyJzdGF0dXMiOiAiZXJyb3IiLCAibWVzc2FnZSI6ICJLaMO0bmcgdMOsbSB0aOG6pXkgam9iX2lkIHRyb25nIGpvYiJ9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3UgYsOhbyBjw6FvCiAgICAgICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICAiaWQiOiBqb2JfaWQKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBsw70gZG8gbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHJlYXNvbjoKICAgICAgICAgICAgICAgIHBheWxvYWRbInJlYXNvbiJdID0gcmVhc29uCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWEKICAgICAgICAgICAgdXJsID0gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vc2tpcC1qb2JzIgogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLmFwaV9yZXF1ZXN0KHVybCwgbWV0aG9kPSJQT1NUIiwgcGF5bG9hZD1wYXlsb2FkKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogImVycm9yIiwgIm1lc3NhZ2UiOiAiS2jDtG5nIHRo4buDIGLDoW8gY8OhbyBqb2IgxJHDoyBi4buLIGLhu48gcXVhIn0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBiw6FvIGPDoW8gam9iIHtqb2JfaWR9IGLhu4sgYuG7jyBxdWEgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgcmV0dXJuIHsic3RhdHVzIjogInN1Y2Nlc3MiLCAibWVzc2FnZSI6ICLEkMOjIGLDoW8gY8OhbyBqb2IgYuG7iyBi4buPIHF1YSB0aMOgbmggY8O0bmciLCAiZGF0YSI6IHJlc3VsdH0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBiw6FvIGPDoW8gam9iIMSRw6MgYuG7iyBi4buPIHF1YSIpCiAgICAgICAgICAgIHJldHVybiB7InN0YXR1cyI6ICJlcnJvciIsICJtZXNzYWdlIjogZiJM4buXaSBraGkgYsOhbyBjw6FvIGpvYiDEkcOjIGLhu4sgYuG7jyBxdWE6IHtzdHIoZSl9In0KICAgIAogICAgZGVmIGdldF9hY2NvdW50X2xpc3RfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfSIKICAgICAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9kZXRhaWxfdXJsKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGNoaSB0aeG6v3QgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBVUkwgQVBJIGNoaSB0aeG6v3QgdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIGYie2NvbmZpZy5HT0xJS0VfQVBJX0JBU0V9L3tzZWxmLmFwcF9uYW1lfS1hY2NvdW50IgogICAgICAgIAogICAgZGVmIGdldF9qb2JfbGlzdF91cmwoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IFVSTCBBUEkgZGFuaCBzw6FjaCBqb2IKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgZGFuaCBzw6FjaCBqb2IKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gZiJ7Y29uZmlnLkdPTElLRV9BUElfQkFTRX0vYWR2ZXJ0aXNpbmcvcHVibGlzaGVycy97c2VsZi5hcHBfbmFtZX0vam9icyIKICAgICAgICAKICAgIGRlZiBnZXRfam9iX3JlcG9ydF91cmwoc2VsZiwgam9iX2lkOiBzdHIpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBVUkwgQVBJIGLDoW8gY8OhbyBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfaWQ6IElEIGPhu6dhIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVSTCBBUEkgYsOhbyBjw6FvIGpvYgogICAgICAgICIiIgogICAgICAgIHJldHVybiBmIntjb25maWcuR09MSUtFX0FQSV9CQVNFfS97c2VsZi5hcHBfbmFtZX0vam9icy97am9iX2lkfS9yZXBvcnQi').decode('utf-8'))
