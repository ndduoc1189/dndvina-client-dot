import base64
exec(base64.b64decode('aW1wb3J0IHBhaG8ubXF0dC5jbGllbnQgYXMgbXF0dAppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBqc29uCmltcG9ydCB0aW1lCmltcG9ydCB1dWlkCmltcG9ydCBvcwppbXBvcnQgYmFzZTY0CmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsLCBDYWxsYWJsZSwgVW5pb24KaW1wb3J0IGNvbmZpZwppbXBvcnQgdXRpbHMKaW1wb3J0IHNvY2tldAppbXBvcnQgcmFuZG9tCmltcG9ydCBzdWJwcm9jZXNzCgojIExvZ2dlcgpsb2dnZXIgPSB1dGlscy5nZXRfbG9nZ2VyKCJNUVRUU2VydmljZSIpCgpjbGFzcyBNUVRUU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBkZXZpY2VfaWQsIGhlbHBlcl9zZXJ2aWNlPU5vbmUsIGpvYl9zZXJ2aWNlPU5vbmUsIG1pbmluZ19zZXJ2aWNlPU5vbmUpOgogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgc2VydmljZQogICAgICAgIHNlbGYuZGIgPSBkYl9zZXJ2aWNlCiAgICAgICAgc2VsZi5oZWxwZXJfc2VydmljZSA9IGhlbHBlcl9zZXJ2aWNlCiAgICAgICAgc2VsZi5qb2Jfc2VydmljZSA9IGpvYl9zZXJ2aWNlICAjIFRow6ptIHJlZmVyZW5jZSDEkeG6v24gSm9iU2VydmljZQogICAgICAgIHNlbGYubWluaW5nX3NlcnZpY2UgPSBtaW5pbmdfc2VydmljZSAgIyBUaMOqbSByZWZlcmVuY2UgxJHhur9uIE1pbmluZ1NlcnZpY2UKICAgICAgICAKICAgICAgICAjIFN0cmVhbSBsb2cgc3RhdGUKICAgICAgICBzZWxmLnN0cmVhbV9hY3RpdmUgPSBGYWxzZQogICAgICAgIHNlbGYuc3RyZWFtX3RocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLnN0cmVhbV9zdG9wX2V2ZW50ID0gdGhyZWFkaW5nLkV2ZW50KCkKICAgICAgICBzZWxmLnN0cmVhbV90aW1lb3V0ID0gNjAgICMgNjAgc2Vjb25kcyBkZWZhdWx0CiAgICAgICAgc2VsZi5zdHJlYW1fbGFzdF9hY3Rpdml0eSA9IDAKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIE1RVFQKICAgICAgICBzZWxmLmNsaWVudF9pZCA9IGYie2NvbmZpZy5NUVRUX0NMSUVOVF9JRF9QUkVGSVh9X3tyYW5kb20ucmFuZGludCgxLCA5OSl9X3tkZXZpY2VfaWR9IgogICAgICAgIHNlbGYuYnJva2VyX3VybCA9IGNvbmZpZy5NUVRUX1NFUlZFUlNbY29uZmlnLk1PREVdCiAgICAgICAgc2VsZi5icm9rZXJfYWRkcmVzcyA9IHNlbGYuYnJva2VyX3VybC5yZXBsYWNlKCJtcXR0Oi8vIiwgIiIpLnNwbGl0KCI6IilbMF0KICAgICAgICBzZWxmLmJyb2tlcl9wb3J0ID0gaW50KHNlbGYuYnJva2VyX3VybC5zcGxpdCgiOiIpWy0xXSkgaWYgIjoiIGluIHNlbGYuYnJva2VyX3VybCBlbHNlIDE4ODMKICAgICAgICBzZWxmLnVzZXJuYW1lID0gY29uZmlnLk1RVFRfVVNFUk5BTUUKICAgICAgICBzZWxmLnBhc3N3b3JkID0gY29uZmlnLk1RVFRfUEFTU1dPUkQKICAgICAgICAKICAgICAgICAjIFRy4bqhbmcgdGjDoWkga+G6v3QgbuG7kWkKICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5jbGllbnQgPSBOb25lCiAgICAgICAgc2VsZi5kZXZpY2VfaWQgPSBkZXZpY2VfaWQKICAgICAgICAKICAgICAgICAjIFJlY29ubmVjdGlvbiBsb2dpYwogICAgICAgIHNlbGYucmVjb25uZWN0X2RlbGF5ID0gMSAgIyBC4bqvdCDEkeG6p3UgduG7m2kgMSBnacOieQogICAgICAgIHNlbGYubWF4X3JlY29ubmVjdF9kZWxheSA9IDYwICAjIFThu5FpIMSRYSA2MCBnacOieQogICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ID0gMAogICAgICAgIHNlbGYubGFzdF9kaXNjb25uZWN0X3RpbWUgPSAwCiAgICAgICAgc2VsZi5tYW51YWxfZGlzY29ubmVjdCA9IEZhbHNlICAjIEZsYWcgxJHhu4MgcGjDom4gYmnhu4d0IGRpc2Nvbm5lY3QgY8OzIGNo4bunIMO9IHbDoCBraMO0bmcgY2jhu6cgw70KICAgICAgICAKICAgICAgICAjIFRvcGljcwogICAgICAgIHNlbGYudG9waWNfY2xpZW50X3N5bmMgPSBjb25maWcuTVFUVF9UT1BJQ19DTElFTlRfU1lOQwogICAgICAgIHNlbGYudG9waWNfc2VydmVyX3Rhc2sgPSBmIntjb25maWcuTVFUVF9UT1BJQ19TRVJWRVJfVEFTS19QUkVGSVh9L3tzZWxmLmRldmljZV9pZH0iCiAgICAgICAgCiAgICAgICAgIyBRdeG6o24gbMO9IHRhc2sgdsOgIHN5bmMKICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnMgPSB7fQogICAgICAgIHNlbGYuc3luY190aHJlYWQgPSBOb25lCiAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gY29uZmlnLlNZTkNfSU5URVJWQUwKICAgICAgICBzZWxmLnN5bmNfcnVubmluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBzZXRfam9iX3NlcnZpY2Uoc2VsZiwgam9iX3NlcnZpY2UpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBKb2JTZXJ2aWNlIMSR4buDIHjhu60gbMO9IGPDoWMgdGjDtG5nIGLDoW8gY29uZmlnIHVwZGF0ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9zZXJ2aWNlOiBJbnN0YW5jZSBj4bunYSBKb2JTZXJ2aWNlCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5qb2Jfc2VydmljZSA9IGpvYl9zZXJ2aWNlCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgxJHhurd0IEpvYlNlcnZpY2UgY2hvIE1RVFRTZXJ2aWNlIikKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYuc3RvcF9ldmVudCA9IHRocmVhZGluZy5FdmVudCgpCiAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygic3luY19pbnRlcnZhbCIsIGNvbmZpZy5TWU5DX0lOVEVSVkFMKQogICAgICAgIAogICAgICAgICMgVGhlbyBkw7VpIFJBTSDEkeG7gyB04buxIMSR4buZbmcgcmVib290CiAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSA9IFtdICAjIEzGsHUgMyBs4bqnbiDEkW8gUkFNIGfhuqduIG5o4bqldAogICAgICAgIHNlbGYuaGlnaF9yYW1fdGhyZXNob2xkID0gODggICMgTmfGsOG7oW5nIFJBTSBjYW8gKCUpCiAgICAgICAgc2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdCA9IDMgICMgU+G7kSBs4bqnbiBsacOqbiB0aeG6v3AgUkFNIGNhbyB0csaw4bubYyBraGkgcmVib290CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIG3DtGkgdHLGsOG7nW5nIFRlcm11eAogICAgICAgIHNlbGYuaXNfdGVybXV4ID0gJ1RFUk1VWF9WRVJTSU9OJyBpbiBvcy5lbnZpcm9uIG9yICcvZGF0YS9kYXRhL2NvbS50ZXJtdXgnIGluIG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpCiAgICAgICAgaWYgc2VsZi5pc190ZXJtdXg6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBjaOG6oXkgdHJvbmcgbcO0aSB0csaw4budbmcgVGVybXV4IikKCiAgICBkZWYgX2NyZWF0ZV9jbGllbnQoc2VsZikgLT4gbXF0dC5DbGllbnQ6CiAgICAgICAgIiIiVOG6oW8gdsOgIGPhuqV1IGjDrG5oIE1RVFQgY2xpZW50IiIiCiAgICAgICAgY2xpZW50ID0gTm9uZQoKICAgICAgICAjIFRo4butIHThuqFvIHbhu5tpIEFQSSB2MgogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpZW50ID0gbXF0dC5DbGllbnQoCiAgICAgICAgICAgICAgICBjbGllbnRfaWQ9c2VsZi5jbGllbnRfaWQsCiAgICAgICAgICAgICAgICBjbGVhbl9zZXNzaW9uPVRydWUsCiAgICAgICAgICAgICAgICBwcm90b2NvbD1tcXR0Lk1RVFR2MzExLAogICAgICAgICAgICAgICAgY2FsbGJhY2tfYXBpX3ZlcnNpb249Z2V0YXR0cihtcXR0LkNhbGxiYWNrQVBJVmVyc2lvbiwgJ1ZFUlNJT04yJywgTm9uZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYyIikKICAgICAgICBleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBUeXBlRXJyb3IpOgogICAgICAgICAgICAjIEZhbGxiYWNrIEFQSSB2MQogICAgICAgICAgICBjbGllbnQgPSBtcXR0LkNsaWVudCgKICAgICAgICAgICAgICAgIGNsaWVudF9pZD1zZWxmLmNsaWVudF9pZCwKICAgICAgICAgICAgICAgIGNsZWFuX3Nlc3Npb249VHJ1ZSwKICAgICAgICAgICAgICAgIHByb3RvY29sPW1xdHQuTVFUVHYzMTEKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYxIikKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIHjDoWMgdGjhu7FjIG7hur91IGPDswogICAgICAgIGlmIHNlbGYudXNlcm5hbWUgYW5kIHNlbGYucGFzc3dvcmQ6CiAgICAgICAgICAgIGNsaWVudC51c2VybmFtZV9wd19zZXQoc2VsZi51c2VybmFtZSwgc2VsZi5wYXNzd29yZCkKICAgICAgICAKICAgICAgICAjIMSQxINuZyBrw70gY2FsbGJhY2sKICAgICAgICBjbGllbnQub25fY29ubmVjdCA9IHNlbGYuX29uX2Nvbm5lY3QKICAgICAgICBjbGllbnQub25fbWVzc2FnZSA9IHNlbGYuX29uX21lc3NhZ2UKICAgICAgICBjbGllbnQub25fZGlzY29ubmVjdCA9IHNlbGYuX29uX2Rpc2Nvbm5lY3QKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIGtlZXAtYWxpdmUgZMOgaSBoxqFuIHbDoCByZWNvbm5lY3Rpb24KICAgICAgICBjbGllbnQucmVjb25uZWN0X2RlbGF5X3NldChtaW5fZGVsYXk9MSwgbWF4X2RlbGF5PTYwKQogICAgICAgIAogICAgICAgIHJldHVybiBjbGllbnQKCiAgICBkZWYgY29ubmVjdChzZWxmKSAtPiBib29sOgogICAgICAgICIiIkvhur90IG7hu5FpIMSR4bq/biBNUVRUIGJyb2tlciB24bubaSBleHBvbmVudGlhbCBiYWNrb2ZmIiIiCiAgICAgICAgZGVmIGNhbl9jb25uZWN0KGhvc3Q6IHN0ciwgcG9ydDogaW50LCB0aW1lb3V0OiBmbG9hdCA9IDMuMCkgLT4gYm9vbDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBzb2NrZXQuY3JlYXRlX2Nvbm5lY3Rpb24oKGhvc3QsIHBvcnQpLCB0aW1lb3V0PXRpbWVvdXQpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgbWFpbl9ob3N0ID0gc2VsZi5icm9rZXJfYWRkcmVzcwogICAgICAgIG1haW5fcG9ydCA9IHNlbGYuYnJva2VyX3BvcnQKICAgICAgICBmYWxsYmFja19ob3N0ID0gIjEwLjAuMC42IgogICAgICAgIGZhbGxiYWNrX3BvcnQgPSA5MDIwCgogICAgICAgICMgS2nhu4NtIHRyYSBr4bq/dCBu4buRaSBzb2NrZXQgdOG7m2kgY+G6oyAyIElQCiAgICAgICAgbWFpbl9vayA9IGNhbl9jb25uZWN0KG1haW5faG9zdCwgbWFpbl9wb3J0KQogICAgICAgIGZhbGxiYWNrX29rID0gY2FuX2Nvbm5lY3QoZmFsbGJhY2tfaG9zdCwgZmFsbGJhY2tfcG9ydCkKICAgICAgICBpZiBtYWluX29rOgogICAgICAgICAgICBjb25uZWN0X2hvc3QgPSBtYWluX2hvc3QKICAgICAgICAgICAgY29ubmVjdF9wb3J0ID0gbWFpbl9wb3J0CiAgICAgICAgZWxpZiBmYWxsYmFja19vazoKICAgICAgICAgICAgY29ubmVjdF9ob3N0ID0gZmFsbGJhY2tfaG9zdAogICAgICAgICAgICBjb25uZWN0X3BvcnQgPSBmYWxsYmFja19wb3J0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIGvhur90IG7hu5FpIMSRxrDhu6NjIHNvY2tldCB04bubaSBj4bqjIHttYWluX2hvc3R9OnttYWluX3BvcnR9IGzhuqtuIHtmYWxsYmFja19ob3N0fTp7ZmFsbGJhY2tfcG9ydH0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFThuqFvIGNsaWVudCBt4bubaSBu4bq/dSBjaMawYSBjw7MgaG/hurdjIGNsaWVudCBjxakgYuG7iyBs4buXaQogICAgICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBzZWxmLl9jcmVhdGVfY2xpZW50KCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzZWxmLnN0b3BfZXZlbnQuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3QgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBr4bq/dCBu4buRaSB04bubaSBNUVRUIGJyb2tlciB7Y29ubmVjdF9ob3N0fTp7Y29ubmVjdF9wb3J0fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGtlZXBhbGl2ZSBs4bubbiBoxqFuICgxMjAgZ2nDonkgdGhheSB2w6wgNjApIMSR4buDIHBow6F0IGhp4buHbiBt4bqldCBr4bq/dCBu4buRaQogICAgICAgICAgICAjIEtoaSBt4bqldCBt4bqhbmcgcuG7k2kgY8OzIGzhuqFpLCBjbGllbnQgc+G6vSB04buxIMSR4buZbmcgcmVjb25uZWN0IHF1YSBfb25fZGlzY29ubmVjdCBjYWxsYmFjawogICAgICAgICAgICBzZWxmLmNsaWVudC5jb25uZWN0X2FzeW5jKGNvbm5lY3RfaG9zdCwgY29ubmVjdF9wb3J0LCBrZWVwYWxpdmU9MTIwKQogICAgICAgICAgICBzZWxmLmNsaWVudC5sb29wX3N0YXJ0KCkKCiAgICAgICAgICAgIGRlZiBfd2FpdF9jb25uZWN0ZWQodGltZW91dF9zZWM6IGludCA9IDE1KSAtPiBib29sOgogICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UodGltZW91dF9zZWMpOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgaWYgX3dhaXRfY29ubmVjdGVkKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nIMSR4bq/biBNUVRUIGJyb2tlciB7Y29ubmVjdF9ob3N0fTp7Y29ubmVjdF9wb3J0fSIpCiAgICAgICAgICAgICAgICBzZWxmLmJyb2tlcl9hZGRyZXNzID0gY29ubmVjdF9ob3N0CiAgICAgICAgICAgICAgICBzZWxmLmJyb2tlcl9wb3J0ID0gY29ubmVjdF9wb3J0CiAgICAgICAgICAgICAgICAjIFJlc2V0IHJlY29ubmVjdCBkZWxheSBraGkga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9kZWxheSA9IDEKICAgICAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkvhur90IG7hu5FpIE1RVFQgdGjhuqV0IGLhuqFpIHThu5tpIHtjb25uZWN0X2hvc3R9Ontjb25uZWN0X3BvcnR9IikKICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFudXBfY2xpZW50KCkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGvhur90IG7hu5FpIE1RVFQ6IHtzdHIoZSl9IikKICAgICAgICAgICAgc2VsZi5fY2xlYW51cF9jbGllbnQoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2NsZWFudXBfY2xpZW50KHNlbGYpOgogICAgICAgICIiIkThu41uIGThurlwIE1RVFQgY2xpZW50IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLmNsaWVudDoKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50Lmxvb3Bfc3RvcCgpCiAgICAgICAgICAgICAgICBzZWxmLmNsaWVudC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50ID0gTm9uZQogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBk4buNbiBk4bq5cCBNUVRUIGNsaWVudDoge2V9IikKCiAgICBkZWYgZW5zdXJlX2Nvbm5lY3RlZChzZWxmKSAtPiBib29sOgogICAgICAgICIiIsSQ4bqjbSBi4bqjbyBr4bq/dCBu4buRaSBNUVRUIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duIGPDoWMgdGhhbyB0w6FjIHbhu5tpIHJhdGUgbGltaXRpbmciIiIKICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgdHJvbmcgcXXDoSB0csOsbmggcmVjb25uZWN0IGtow7RuZwogICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgaWYgY3VycmVudF90aW1lIC0gc2VsZi5sYXN0X2Rpc2Nvbm5lY3RfdGltZSA8IDU6ICAjIENo4budIMOtdCBuaOG6pXQgNSBnacOieSB04burIGzhuqduIGRpc2Nvbm5lY3QgY3Xhu5FpCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygixJBhbmcgdHJvbmcgdGjhu51pIGdpYW4gY29vbGRvd24gcmVjb25uZWN0LCBjaOG7nS4uLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBsb2dnZXIud2FybmluZygiTVFUVCBjaMawYSBr4bq/dCBu4buRaSwgxJFhbmcgdGjhu60ga+G6v3QgbuG7kWkgbOG6oWkuLi4iKQogICAgICAgIHJldHVybiBzZWxmLmNvbm5lY3QoKQoKICAgIGRlZiBfb25fY29ubmVjdChzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCBmbGFncywgcmMsIHByb3BlcnRpZXM9Tm9uZSk6CiAgICAgICAgIiIiQ2FsbGJhY2sga2hpIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZyIiIgogICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gVHJ1ZQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcgdOG7m2kgTVFUVCBicm9rZXIiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMSDbmcga8O9IG5o4bqtbiB0YXNrCiAgICAgICAgICAgIHNlbGYuY2xpZW50LnN1YnNjcmliZShzZWxmLnRvcGljX3NlcnZlcl90YXNrLCBxb3M9MSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRxINuZyBrw70gbmjhuq1uIHRhc2sgdOG6oWk6IHtzZWxmLnRvcGljX3NlcnZlcl90YXNrfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpCiAgICAgICAgICAgIHNlbGYuc2VuZF9jb25uZWN0X25vdGlmaWNhdGlvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHJlY29ubmVjdCBjb3VudGVyIGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfY291bnQgPSAwCiAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2RlbGF5ID0gMQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkvhur90IG7hu5FpIE1RVFQgdGjhuqV0IGLhuqFpIHbhu5tpIG3DoyBs4buXaToge3JjfSIpCiAgICAgICAgICAgICMgVMSDbmcgcmVjb25uZWN0IGNvdW50IGtoaSBr4bq/dCBu4buRaSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfY291bnQgKz0gMQoKICAgIGRlZiBfb25fZGlzY29ubmVjdChzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCByYywgcHJvcGVydGllcz1Ob25lLCByZWFzb25fY29kZT1Ob25lLCAqKmt3YXJncyk6CiAgICAgICAgIiIiQ2FsbGJhY2sga2hpIG5n4bqvdCBr4bq/dCBu4buRaSB24bubaSBjxqEgY2jhur8gcmVjb25uZWN0IHRow7RuZyBtaW5oIiIiCiAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgIHNlbGYubGFzdF9kaXNjb25uZWN0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIAogICAgICAgIGlmIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3Q6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIG5n4bqvdCBr4bq/dCBu4buRaSBNUVRUIHRoZW8gecOqdSBj4bqndSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCArPSAxCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTmfhuq90IGvhur90IG7hu5FpIE1RVFQga2jDtG5nIG1vbmcgbXXhu5FuIGzhuqduIHtzZWxmLnJlY29ubmVjdF9jb3VudH0gduG7m2kgbcOjIGzhu5dpOiB7cmN9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu4kgYXV0by1yZWNvbm5lY3QgbuG6v3Uga2jDtG5nIHBo4bqjaSBtYW51YWwgZGlzY29ubmVjdAogICAgICAgICAgICBpZiBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpOgogICAgICAgICAgICAgICAgc2VsZi5fc2NoZWR1bGVfcmVjb25uZWN0KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBuZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIpCgogICAgZGVmIF9zY2hlZHVsZV9yZWNvbm5lY3Qoc2VsZik6CiAgICAgICAgIiIiTMOqbiBs4buLY2gga+G6v3QgbuG7kWkgbOG6oWkgbeG7l2kgMzAgZ2nDonksIGzhurdwIHbDtCBo4bqhbiDEkeG6v24ga2hpIGThu6tuZyBhcHAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiU+G6vSB0aOG7rSBr4bq/dCBu4buRaSBs4bqhaSBzYXUgMzAgZ2nDonkuLi4iKQogICAgICAgIAogICAgICAgIGRlZiByZWNvbm5lY3RfbG9vcCgpOgogICAgICAgICAgICB3aGlsZSBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpIGFuZCBub3Qgc2VsZi5tYW51YWxfZGlzY29ubmVjdDoKICAgICAgICAgICAgICAgICMgQ2jhu50gMzAgZ2nDonksIGPDsyB0aOG7gyBi4buLIG5n4bqvdCBi4bufaSBzdG9wX2V2ZW50CiAgICAgICAgICAgICAgICBpZiBzZWxmLnN0b3BfZXZlbnQud2FpdCgzMCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgICMgQuG7iyBk4burbmcsIHRob8OhdCBsb29wCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgdHLhuqFuZyB0aMOhaSB0csaw4bubYyBraGkgdGjhu60ga+G6v3QgbuG7kWkKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkIG9yIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3Q6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgICMgxJDDoyBr4bq/dCBu4buRaSBob+G6t2MgYuG7iyBk4burbmcgdGjhu6cgY8O0bmcKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu60ga+G6v3QgbuG7kWkgbOG6oWkgTVFUVCAobOG6p24ge3NlbGYucmVjb25uZWN0X2NvdW50fSkiKQogICAgICAgICAgICAgICAgaWYgc2VsZi5jb25uZWN0KCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkvhur90IG7hu5FpIGzhuqFpIE1RVFQgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICBicmVhayAgIyBL4bq/dCBu4buRaSB0aMOgbmggY8O0bmcsIHRob8OhdCBsb29wCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkvhur90IG7hu5FpIGzhuqFpIE1RVFQgdGjhuqV0IGLhuqFpIGzhuqduIHtzZWxmLnJlY29ubmVjdF9jb3VudH0sIHRo4butIGzhuqFpIHNhdSAzMCBnacOieS4uLiIpCiAgICAgICAgCiAgICAgICAgIyBDaOG6oXkgdHJvbmcgdGhyZWFkIHJpw6puZyDEkeG7gyBraMO0bmcgYmxvY2sKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1yZWNvbm5lY3RfbG9vcCwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKCiAgICBkZWYgX3NhZmVfcHVibGlzaChzZWxmLCB0b3BpYzogc3RyLCBwYXlsb2FkOiBzdHIsIHFvczogaW50ID0gMSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBH4butaSBtZXNzYWdlIGFuIHRvw6BuIHbhu5tpIGtp4buDbSB0cmEga+G6v3QgbuG7kWkgdHLGsOG7m2Mga2hpIHB1Ymxpc2gKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0b3BpYzogTVFUVCB0b3BpYwogICAgICAgICAgICBwYXlsb2FkOiBO4buZaSBkdW5nIG1lc3NhZ2UgKHN0cmluZykKICAgICAgICAgICAgcW9zOiBRdWFsaXR5IG9mIFNlcnZpY2UgKDAsIDEsIGhv4bq3YyAyKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGfhu61pIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfY29ubmVjdGVkKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgZ+G7rWkgbWVzc2FnZSDEkeG6v24ge3RvcGljfTogTVFUVCBjaMawYSBr4bq/dCBu4buRaSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuY2xpZW50LnB1Ymxpc2godG9waWMsIHBheWxvYWQsIHFvcz1xb3MpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXN1bHQucmMgPT0gbXF0dC5NUVRUX0VSUl9TVUNDRVNTOgogICAgICAgICAgICAgICAgI2xvZ2dlci5pbmZvKGYixJDDoyBn4butaSBtZXNzYWdlIHRow6BuaCBjw7RuZyDEkeG6v24ge3RvcGljfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IHttcXR0LmVycm9yX3N0cmluZyhyZXN1bHQucmMpfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgbWVzc2FnZSDEkeG6v24ge3RvcGljfToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VuZF90YXNrX3JlcG9ydChzZWxmLCB0YXNrX2lkOiBzdHIsIGRldmljZV9pZDogc3RyLCBzdGF0dXM6IHN0ciwgY2xpZW50X21lc3NhZ2U6IHN0ciA9ICIiKToKICAgICAgICAiIiJH4butaSBiw6FvIGPDoW8ga+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiB0YXNrIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXBvcnRfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJ0YXNrX2lkIjogdGFza19pZCwKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogc3RhdHVzLAogICAgICAgICAgICAgICAgImNsaWVudF9tZXNzYWdlIjogY2xpZW50X21lc3NhZ2UsCiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBzZWxmLl9zYWZlX3B1Ymxpc2goImRuZHZpbmEvY2xpZW50L3Rhc2tfcmVwb3J0IiwganNvbi5kdW1wcyhyZXBvcnRfZGF0YSkpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGfhu61pIGLDoW8gY8OhbyB0YXNrIHt0YXNrX2lkfSB24bubaSB0cuG6oW5nIHRow6FpIHtzdGF0dXN9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBn4butaSBiw6FvIGPDoW8gdGFzazoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VuZF9jb25uZWN0X25vdGlmaWNhdGlvbihzZWxmKToKICAgICAgICAiIiJH4butaSB0aMO0bmcgYsOhbyBr4bq/dCBu4buRaSDEkeG6v24gc2VydmVyIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb25uZWN0X2RhdGEgPSB7CiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogc2VsZi5kZXZpY2VfaWQsCiAgICAgICAgICAgICAgICAidGltZXN0YW1wIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiBzZWxmLl9zYWZlX3B1Ymxpc2goImRuZHZpbmEvY2xpZW50L2Nvbm5lY3QiLCBqc29uLmR1bXBzKGNvbm5lY3RfZGF0YSkpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpIGNobyB0aGnhur90IGLhu4sge3NlbGYuZGV2aWNlX2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgdGjDtG5nIGLDoW8ga+G6v3QgbuG7kWk6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHJlZ2lzdGVyX3Rhc2tfaGFuZGxlcihzZWxmLCB0YXNrX3R5cGU6IHN0ciwgaGFuZGxlcjogQ2FsbGFibGUpOgogICAgICAgICIiIgogICAgICAgIMSQxINuZyBrw70gaGFuZGxlciBjaG8gbG/huqFpIHRhc2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX3R5cGU6IExv4bqhaSB0YXNrCiAgICAgICAgICAgIGhhbmRsZXI6IEjDoG0geOG7rSBsw70gdGFzawogICAgICAgICIiIgogICAgICAgIHNlbGYudGFza19oYW5kbGVyc1t0YXNrX3R5cGVdID0gaGFuZGxlcgogICAgCiAgICBkZWYgX3JlYWRfcmVjZW50X2xvZ3Moc2VsZiwgbnVtX2xpbmVzPTIwMCk6CiAgICAgICAgIiIiCiAgICAgICAgxJDhu41jIGPDoWMgZMOybmcgbG9nIGfhuqduIG5o4bqldCB04burIGZpbGUgYXBwLmxvZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIG51bV9saW5lczogU+G7kSBkw7JuZyBsb2cgY+G6p24gxJHhu41jICht4bq3YyDEkeG7i25oIDEwMCkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtzdHJdOiBEYW5oIHPDoWNoIGPDoWMgZMOybmcgbG9nIGfhuqduIG5o4bqldCBob+G6t2MgdGjDtG5nIGLDoW8gbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ19maWxlX3BhdGggPSBvcy5wYXRoLmpvaW4oY29uZmlnLkJBU0VfRElSLCAiYXBwLmxvZyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMobG9nX2ZpbGVfcGF0aCk6CiAgICAgICAgICAgICAgICAjIEZpbGUgY2jGsGEgxJHGsOG7o2MgdOG6oW8gYuG7n2kgbG9nZ2luZyBzeXN0ZW0KICAgICAgICAgICAgICAgIHJldHVybiBbZiJbSU5GT10gRmlsZSBsb2cgY2jGsGEgxJHGsOG7o2MgdOG6oW8sIGNoxrBhIGPDsyBsb2cgbsOgbyJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSDEkeG7jWMgZmlsZSB24bubaSByZXRyeSDEkeG7gyB0csOhbmggeHVuZyDEkeG7mXQKICAgICAgICAgICAgbWF4X3JldHJpZXMgPSAzCiAgICAgICAgICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKG1heF9yZXRyaWVzKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4obG9nX2ZpbGVfcGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnLCBlcnJvcnM9J2lnbm9yZScpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGxpbmVzID0gZi5yZWFkbGluZXMoKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IG51bV9saW5lcyBkw7JuZyBjdeG7kWkgY8O5bmcKICAgICAgICAgICAgICAgICAgICByZWNlbnRfbGluZXMgPSBsaW5lc1stbnVtX2xpbmVzOl0gaWYgbGVuKGxpbmVzKSA+IG51bV9saW5lcyBlbHNlIGxpbmVzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBrw70gdOG7sSB4deG7kW5nIGTDsm5nIHbDoCBjw6FjIGtob+G6o25nIHRy4bqvbmcgdGjhu6thCiAgICAgICAgICAgICAgICAgICAgcmVjZW50X2xvZ3MgPSBbbGluZS5zdHJpcCgpIGZvciBsaW5lIGluIHJlY2VudF9saW5lcyBpZiBsaW5lLnN0cmlwKCldCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlY2VudF9sb2dzCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBleGNlcHQgKFBlcm1pc3Npb25FcnJvciwgSU9FcnJvciwgT1NFcnJvcikgYXMgZmlsZV9lcnJvcjoKICAgICAgICAgICAgICAgICAgICBpZiBhdHRlbXB0IDwgbWF4X3JldHJpZXMgLSAxOgogICAgICAgICAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDAuMSkgICMgQ2jhu50gMTAwbXMgcuG7k2kgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2YiW0VSUk9SXSBLaMO0bmcgdGjhu4MgxJHhu41jIGZpbGUgbG9nOiB7c3RyKGZpbGVfZXJyb3IpfSJdCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcmV0dXJuIFtmIltFUlJPUl0gTOG7l2kgxJHhu41jIGZpbGUgbG9nOiB7c3RyKGUpfSJdCgogICAgZGVmIHN5bmNfZGF0YShzZWxmKToKICAgICAgICAiIiLEkOG7k25nIGLhu5kgZOG7ryBsaeG7h3UgduG7m2kgc2VydmVyIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE7hur91IGNoxrBhIGvhur90IG7hu5FpIE1RVFQsIGtow7RuZyB0aOG7gyDEkeG7k25nIGLhu5kKICAgICAgICAgICAgaWYgbm90IHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkNoxrBhIGvhur90IG7hu5FpIE1RVFQsIGtow7RuZyB0aOG7gyDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBoZWxwZXIgc2VydmljZQogICAgICAgICAgICBoZWxwZXIgPSBzZWxmLmhlbHBlcl9zZXJ2aWNlCiAgICAgICAgICAgIGlmIG5vdCBoZWxwZXI6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyBjw7MgaGVscGVyIHNlcnZpY2UsIGtow7RuZyB0aOG7gyDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQKICAgICAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB4w6FjIMSR4buLbmggZGV2aWNlX2lkLCBraMO0bmcgdGjhu4MgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBOb25lCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRldmljZV9pbmZvX3Jlc3BvbnNlID0gaGVscGVyLmdldF9kZXZpY2VfaW5mbygpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTuG6v3UgbOG6pXkgdGjDoG5oIGPDtG5nLCBsxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgICAgIGlmIGRldmljZV9pbmZvX3Jlc3BvbnNlWyJzdGF0dXMiXSA9PSAic3VjY2VzcyIgYW5kICJkYXRhIiBpbiBkZXZpY2VfaW5mb19yZXNwb25zZToKICAgICAgICAgICAgICAgICAgICAjIEzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4sgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2F2ZV9kZXZpY2VfaW5mbyhkZXZpY2VfaW5mb19yZXNwb25zZVsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGRldmljZV9pbmZvID0gZGV2aWNlX2luZm9fcmVzcG9uc2VbImRhdGEiXQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVGhlbyBkw7VpIFJBTSDEkeG7gyB04buxIMSR4buZbmcgcmVib290CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbW9uaXRvcl9yYW1fdXNhZ2UoZGV2aWNlX2luZm8pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBs4bqleSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7izoge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYyB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iywgc+G7rSBk4bulbmcgdGjDtG5nIHRpbiDEkcOjIGzGsHUgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pbmZvOgogICAgICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBzZWxmLmRiLmdldF9kZXZpY2VfaW5mbygpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pbmZvOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyBjw7MgdGjDtG5nIHRpbiB0aGnhur90IGLhu4ssIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSBjw7MgdGjhu4Mga2jDtG5nIMSR4bqneSDEkeG7pyIpCiAgICAgICAgICAgICAgICBkZXZpY2VfaW5mbyA9IHt9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2NvbmZpZyA9IHNlbGYuZGIuZ2V0X2FsbF9kZXZpY2VfY29uZmlnKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7mXAgY8OhYyB0cuG6oW5nIHRow6FpIHJ1bnRpbWUgKHBhdXNlX2pvYiwgZGV2aWNlX2lzX3dvcmtpbmcsIGRldmljZV9tZXNzYWdlKSB2w6BvIGRldmljZV9pbmZvCiAgICAgICAgICAgIGZvciBydW50aW1lX2tleSBpbiBbInBhdXNlX2pvYiIsICJkZXZpY2VfaXNfd29ya2luZyIsICJkZXZpY2VfbWVzc2FnZSJdOgogICAgICAgICAgICAgICAgaWYgcnVudGltZV9rZXkgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfaW5mb1tydW50aW1lX2tleV0gPSBkZXZpY2VfY29uZmlnLnBvcChydW50aW1lX2tleSkKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBHacOhIHRy4buLIG3hurdjIMSR4buLbmggbuG6v3UgY2jGsGEgY+G6pXUgaMOsbmgKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfaW5mb1tydW50aW1lX2tleV0gPSBGYWxzZSBpZiBydW50aW1lX2tleSAhPSAiZGV2aWNlX21lc3NhZ2UiIGVsc2UgIiIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG/huqFpIGLhu48gZ29saWtlX3JlcG9ydCBraOG7j2kgZGV2aWNlX2NvbmZpZyDEkeG7gyBn4butaSByacOqbmcKICAgICAgICAgICAgZ29saWtlX3JlcG9ydCA9IE5vbmUKICAgICAgICAgICAgaWYgImdvbGlrZV9yZXBvcnQiIGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBnb2xpa2VfcmVwb3J0ID0gZGV2aWNlX2NvbmZpZy5wb3AoImdvbGlrZV9yZXBvcnQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBnb2xpa2VfYXBpX2Jhc2Uga2jhu49pIGRldmljZV9jb25maWcKICAgICAgICAgICAgaWYgImdvbGlrZV9hcGlfYmFzZSIgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWcucG9wKCJnb2xpa2VfYXBpX2Jhc2UiKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCLEkMOjIGxv4bqhaSBi4buPIGdvbGlrZV9hcGlfYmFzZSBraOG7j2kgZOG7ryBsaeG7h3UgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgbWluaW5nX2luZm8gdOG7qyBtaW5pbmdfc2VydmljZSAobuG6v3UgY8OzKQogICAgICAgICAgICBtaW5pbmdfaW5mbyA9IE5vbmUKICAgICAgICAgICAgaWYgc2VsZi5taW5pbmdfc2VydmljZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtaW5pbmdfc3VtbWFyeSA9IHNlbGYubWluaW5nX3NlcnZpY2UuZ2V0X21pbmluZ19zdW1tYXJ5KCkKICAgICAgICAgICAgICAgICAgICBpZiBtaW5pbmdfc3VtbWFyeS5nZXQoInN1Y2Nlc3MiKToKICAgICAgICAgICAgICAgICAgICAgICAgbWluaW5nX2luZm8gPSBtaW5pbmdfc3VtbWFyeQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJM4bqleSBtaW5pbmcgaW5mbzoge21pbmluZ19pbmZvLmdldCgncnVubmluZ19taW5lcnMnLCAwKX0ve21pbmluZ19pbmZvLmdldCgndG90YWxfbWluZXJzJywgMCl9IG1pbmVycyIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbOG6pXkgbWluaW5nIGluZm86IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBjw6FjIHTDoGkga2hv4bqjbiBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgcGVuZGluZ19hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X3BlbmRpbmdfc3luY19pdGVtcygiYWNjb3VudHMiLCBsaW1pdD01MCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgY8OhYyBqb2IgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHBlbmRpbmdfam9icyA9IHNlbGYuZGIuZ2V0X3BlbmRpbmdfc3luY19pdGVtcygiam9ic19oaXN0b3J5IiwgbGltaXQ9NTApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4buNYyAyMDAgZMOybmcgbG9nIGfhuqduIG5o4bqldAogICAgICAgICAgICByZWNlbnRfbG9ncyA9IHNlbGYuX3JlYWRfcmVjZW50X2xvZ3MoMjAwKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gcGF5bG9hZAogICAgICAgICAgICBwYXlsb2FkID0gewogICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICJkZXZpY2VfaW5mbyI6IGRldmljZV9pbmZvLAogICAgICAgICAgICAgICAgImRldmljZV9jb25maWciOiBkZXZpY2VfY29uZmlnLAogICAgICAgICAgICAgICAgIm1ldGFfZGF0YSI6IHsKICAgICAgICAgICAgICAgICAgICAiZGV2aWNlX2xvZ3MiOiByZWNlbnRfbG9ncwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZ29saWtlX3JlcG9ydCBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgZ29saWtlX3JlcG9ydDoKICAgICAgICAgICAgICAgIHBheWxvYWRbImdvbGlrZV9yZXBvcnQiXSA9IGdvbGlrZV9yZXBvcnQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gbWluaW5nX2luZm8gbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIG1pbmluZ19pbmZvOgogICAgICAgICAgICAgICAgcGF5bG9hZFsibWluaW5nX2luZm8iXSA9IG1pbmluZ19pbmZvCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSB0w6BpIGtob+G6o24gY2jGsGEgxJHhu5NuZyBi4buZIG7hur91IGPDswogICAgICAgICAgICBpZiBwZW5kaW5nX2FjY291bnRzOgogICAgICAgICAgICAgICAgcGF5bG9hZFsiYWNjb3VudHMiXSA9IHBlbmRpbmdfYWNjb3VudHMKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQ4buTbmcgYuG7mSB7bGVuKHBlbmRpbmdfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gY2jGsGEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGpvYiBjaMawYSDEkeG7k25nIGLhu5kgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHBlbmRpbmdfam9iczoKICAgICAgICAgICAgICAgIHBheWxvYWRbImpvYnMiXSA9IHBlbmRpbmdfam9icwogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDhu5NuZyBi4buZIHtsZW4ocGVuZGluZ19qb2JzKX0gam9iIGNoxrBhIMSR4buTbmcgYuG7mSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBH4butaSBk4buvIGxp4buHdQogICAgICAgICAgICBzZWxmLl9zYWZlX3B1Ymxpc2goY29uZmlnLk1RVFRfVE9QSUNfQ0xJRU5UX1NZTkMsIGpzb24uZHVtcHMocGF5bG9hZCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UgduG7m2kgc2VydmVyIikKICAgIAogICAgZGVmIHN0YXJ0X3N5bmNfdGhyZWFkKHNlbGYpOgogICAgICAgICIiIkLhuq90IMSR4bqndSB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIiIgogICAgICAgIGlmIHNlbGYuc3luY190aHJlYWQgaXMgbm90IE5vbmUgYW5kIHNlbGYuc3luY190aHJlYWQuaXNfYWxpdmUoKToKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlRocmVhZCDEkeG7k25nIGLhu5kgxJHDoyDEkWFuZyBjaOG6oXkiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgc2VsZi5ydW5uaW5nID0gVHJ1ZQogICAgICAgIHNlbGYuc3RvcF9ldmVudC5jbGVhcigpCiAgICAgICAgc2VsZi5zeW5jX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYuX3N5bmNfbG9vcCwgZGFlbW9uPVRydWUpCiAgICAgICAgc2VsZi5zeW5jX3RocmVhZC5zdGFydCgpCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mga2jhu59pIMSR4buZbmcgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciKQogICAgCiAgICBkZWYgX3N5bmNfbG9vcChzZWxmKToKICAgICAgICAiIiJMb29wIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciIiIKICAgICAgICBsb2dnZXIuaW5mbyhmIkLhuq90IMSR4bqndSDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIG3hu5dpIHtzZWxmLnN5bmNfaW50ZXJ2YWx9IGdpw6J5IikKCiAgICAgICAgd2hpbGUgbm90IHNlbGYuc3RvcF9ldmVudC5pc19zZXQoKSBhbmQgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnN5bmNfZGF0YSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHRyb25nIHF1w6EgdHLDrG5oIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmc6IHtzdHIoZSl9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE5naOG7iSDEkeG6v24gbOG6p24gxJHhu5NuZyBi4buZIHRp4bq/cCB0aGVvCiAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKHNlbGYuc3luY19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICBpZiBzZWxmLnN0b3BfZXZlbnQuaXNfc2V0KCkgb3Igbm90IHNlbGYucnVubmluZzoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgdGltZS5zbGVlcCgxKQogICAgCiAgICBkZWYgc3RvcF9zeW5jX3RocmVhZChzZWxmKToKICAgICAgICAiIiJE4burbmcgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciIiIKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYuc3RvcF9ldmVudC5zZXQoKQogICAgICAgIGlmIHNlbGYuc3luY190aHJlYWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuc3luY190aHJlYWQuam9pbih0aW1lb3V0PTIuMCkKICAgICAgICAgICAgc2VsZi5zeW5jX3RocmVhZCA9IE5vbmUKICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBk4burbmcgdGhyZWFkIMSR4buTbmcgYuG7mSB04buxIMSR4buZbmciKQogICAgCiAgICBkZWYgZGlzY29ubmVjdChzZWxmKToKICAgICAgICAiIiJOZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIiIgogICAgICAgIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3QgPSBUcnVlICAjIMSQw6FuaCBk4bqldSDEkcOieSBsw6AgZGlzY29ubmVjdCBjw7MgY2jhu6cgw70KICAgICAgICBzZWxmLnN0b3Bfc3luY190aHJlYWQoKQogICAgICAgIAogICAgICAgICMgROG7q25nIHN0cmVhbSBu4bq/dSDEkWFuZyBjaOG6oXkKICAgICAgICBzZWxmLnN0b3Bfc3RyZWFtKCkKICAgICAgICAKICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5jbGllbnQubG9vcF9zdG9wKCkKICAgICAgICAgICAgc2VsZi5jbGllbnQuZGlzY29ubmVjdCgpCiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gRmFsc2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6Mgbmfhuq90IGvhur90IG7hu5FpIE1RVFQiKQogICAgICAgIAogICAgICAgICMgROG7q25nIHThuqV0IGPhuqMgYXV0by1yZWNvbm5lY3QKICAgICAgICBzZWxmLnN0b3BfZXZlbnQuc2V0KCkKICAgIAogICAgZGVmIHNldHVwX21xdHRfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiVGhp4bq/dCBs4bqtcCBjw6FjIGhhbmRsZXIgY2hvIE1RVFQgdGFza3MiIiIKICAgICAgICAjIMSQxINuZyBrw70gY8OhYyB0YXNrIGhhbmRsZXIgbeG6t2MgxJHhu4tuaAogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfY29uZmlnIiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9kZXZpY2VfY29uZmlnKQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfc3luY2VkIiwgc2VsZi5faGFuZGxlX3VwZGF0ZV9zeW5jZWQpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoImFjY291bnRfdXBkYXRlIiwgc2VsZi5faGFuZGxlX2FjY291bnRfdXBkYXRlKQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfcHJveHkiLCBzZWxmLl9oYW5kbGVfdXBkYXRlX3Byb3h5KQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJ1cGRhdGVfbWluaW5nX2NvbmZpZyIsIHNlbGYuX2hhbmRsZV9taW5pbmdfY29uZmlnX3VwZGF0ZSkKICAgICAgICBzZWxmLnJlZ2lzdGVyX3Rhc2tfaGFuZGxlcigic3RyZWFtX2xvZyIsIHNlbGYuX2hhbmRsZV9zdHJlYW1fbG9nKQogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIHRoaeG6v3QgbOG6rXAgY8OhYyBNUVRUIHRhc2sgaGFuZGxlciIpCiAgICAKICAgIGRlZiBfaGFuZGxlX21pbmluZ19jb25maWdfdXBkYXRlKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayB1cGRhdGUgbWluaW5nIGNvbmZpZyB04burIHNlcnZlcgogICAgICAgIAogICAgICAgIFRhc2sgZm9ybWF0IHThu6sgc2VydmVyIE1RVFQ6CiAgICAgICAgewogICAgICAgICAgICAidGFza19pZCI6ICJ0YXNrXzEyMzQ1Njc4OTBfMTIzIiwKICAgICAgICAgICAgImRldmljZV9pZCI6ICJkZXZpY2UtMDAxIiwKICAgICAgICAgICAgInRhc2tfdHlwZSI6ICJ1cGRhdGVfbWluaW5nX2NvbmZpZyIsCiAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgIm1pbmluZ19jb25maWciOiBbCiAgICAgICAgICAgICAgICAgICAgeyAiY29pbl9uYW1lIjogIlZSU0MiLCAibWluaW5nX3Rvb2wiOiAiY2NtaW5lciIsICJjb25maWciOiB7Li4ufSB9LAogICAgICAgICAgICAgICAgICAgIHsgImNvaW5fbmFtZSI6ICJERVJPIiwgIm1pbmluZ190b29sIjogImFzdHJvbWluZXIiLCAiY29uZmlnIjogey4uLn0gfQogICAgICAgICAgICAgICAgXQogICAgICAgICAgICB9LAogICAgICAgICAgICAibWVzc2FnZSI6ICJD4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggbWluaW5nIiwKICAgICAgICAgICAgInRpbWVzdGFtcCI6ICIyMDI1LTEwLTI4VC4uLiIKICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIGRhdGEgPSB0YXNrX2RhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgIG1pbmluZ19jb25maWdfYXJyYXkgPSBkYXRhLmdldCgibWluaW5nX2NvbmZpZyIsIFtdKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gecOqdSBj4bqndSBj4bqtcCBuaOG6rXQgbWluaW5nIGNvbmZpZyB04burIHNlcnZlciAodGFza19pZDoge3Rhc2tfaWR9KSIpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTWluaW5nIGNvbmZpZyB04burIE1RVFQgY8OzIHtsZW4obWluaW5nX2NvbmZpZ19hcnJheSl9IG1pbmVyczoiKQogICAgICAgICAgICBmb3IgbWluZXIgaW4gbWluaW5nX2NvbmZpZ19hcnJheToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiICAtIHttaW5lci5nZXQoJ2NvaW5fbmFtZScsICdVbmtub3duJyl9ICh7bWluZXIuZ2V0KCdtaW5pbmdfdG9vbCcsICdVbmtub3duJyl9KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbWluaW5nX3NlcnZpY2UgY8OzIHThu5NuIHThuqFpIGtow7RuZwogICAgICAgICAgICBpZiBub3Qgc2VsZi5taW5pbmdfc2VydmljZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJNaW5pbmcgc2VydmljZSBjaMawYSDEkcaw4bujYyBraOG7n2kgdOG6oW8iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IG1pbmluZ19jb25maWdfYXJyYXk6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSAiTWluaW5nIGNvbmZpZyBhcnJheSBy4buXbmciCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIGNvbmZpZyBvYmplY3QgxJHhu4MgZ+G7rWkgc2FuZyBtaW5pbmcgQVBJCiAgICAgICAgICAgICMgYXV0b19zdGFydCBt4bq3YyDEkeG7i25oIHRydWUKICAgICAgICAgICAgIyBsYXN0X3N5bmNfY29uZmlnIGzDoCB0aW1lc3RhbXAgaGnhu4duIHThuqFpCiAgICAgICAgICAgIGNvbmZpZ190b191cGRhdGUgPSB7CiAgICAgICAgICAgICAgICAibGFzdF9zeW5jX2NvbmZpZyI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAiYXV0b19zdGFydCI6IFRydWUsCiAgICAgICAgICAgICAgICAibWluZXJzIjogbWluaW5nX2NvbmZpZ19hcnJheQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIHVwZGF0ZSB7bGVuKG1pbmluZ19jb25maWdfYXJyYXkpfSBtaW5lcnMgduG7m2kgYXV0b19zdGFydD1UcnVlIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgdHLhu7FjIHRp4bq/cCB1cGRhdGVfY29uZmlnIChmb3JjZT1UcnVlIG3hurdjIMSR4buLbmgpIMSR4buDIMSRw6ggY29uZmlnCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYubWluaW5nX3NlcnZpY2UudXBkYXRlX2NvbmZpZyhjb25maWdfdG9fdXBkYXRlKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0LmdldCgic3VjY2VzcyIpOgogICAgICAgICAgICAgICAgIyBM4bqleSBzdW1tYXJ5IMSR4buDIGLDoW8gY8OhbwogICAgICAgICAgICAgICAgc3VtbWFyeSA9IHNlbGYubWluaW5nX3NlcnZpY2UuZ2V0X21pbmluZ19zdW1tYXJ5KCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWVzc2FnZSA9ICgKICAgICAgICAgICAgICAgICAgICBmIsSQw6MgY+G6rXAgbmjhuq10IG1pbmluZyBjb25maWc6ICIKICAgICAgICAgICAgICAgICAgICBmIntzdW1tYXJ5LmdldCgncnVubmluZ19taW5lcnMnLCAwKX0ve3N1bW1hcnkuZ2V0KCd0b3RhbF9taW5lcnMnLCAwKX0gbWluZXJzIHJ1bm5pbmciCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKG1lc3NhZ2UpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIG1lc3NhZ2UpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0aOG7gyB1cGRhdGUgbWluaW5nIGNvbmZpZzoge3Jlc3VsdC5nZXQoJ2Vycm9yJywgJ1Vua25vd24gZXJyb3InKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHjhu60gbMO9IG1pbmluZyBjb25maWcgdXBkYXRlIikKICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KAogICAgICAgICAgICAgICAgdGFza19kYXRhLmdldCgidGFza19pZCIpLAogICAgICAgICAgICAgICAgdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIiksCiAgICAgICAgICAgICAgICAiZmFpbGVkIiwKICAgICAgICAgICAgICAgIGYiTOG7l2k6IHtzdHIoZSl9IgogICAgICAgICAgICApCiAgICAgICAgCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfZGV2aWNlX2NvbmZpZyhzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza19pZCA9IHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKQogICAgICAgICAgICBkZXZpY2VfaWQgPSB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gecOqdSBj4bqndSBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgY29uZmlnX2RhdGEgPSB0YXNrX2RhdGEuZ2V0KCJjb25maWdfZGF0YSIsIHt9KQogICAgICAgICAgICBpZiBub3QgY29uZmlnX2RhdGE6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiROG7ryBsaeG7h3UgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIHLhu5duZyIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgIkThu68gbGnhu4d1IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyBy4buXbmciKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgdOG7q25nIGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi5zYXZlX2RldmljZV9jb25maWcoY29uZmlnX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4s6IHsnLCAnLmpvaW4oY29uZmlnX2RhdGEua2V5cygpKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBsw6AgY2jGsGEgc3luYyDEkeG7gyDEkeG6o20gYuG6o28gdGjDtG5nIHRpbiBt4bubaSBuaOG6pXQgxJHGsOG7o2MgZ+G7rWkgbMOqbiBzZXJ2ZXIKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2FjY291bnRzID0gc2VsZi5kYi5tYXJrX2FsbF9hY2NvdW50c19ub3Rfc3luY2VkKCkKICAgICAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX2FjY291bnRzID4gMDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRw6FuaCBk4bqldSB7dXBkYXRlZF9hY2NvdW50c30gdMOgaSBraG/huqNuIGzDoCBjaMawYSBzeW5jIHNhdSBraGkgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIGPhuqduIMSRw6FuaCBk4bqldSBjaMawYSBzeW5jIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgdMOgaSBraG/huqNuIGNoxrBhIHN5bmM6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgIyBLaMO0bmcgZmFpbCB0YXNrIHbDrCB2aeG7h2MgY+G6rXAgbmjhuq10IGNvbmZpZyDEkcOjIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBzeW5jX2ludGVydmFsIG7hur91IG7DsyB0aGF5IMSR4buVaQogICAgICAgICAgICAgICAgaWYgInN5bmNfaW50ZXJ2YWwiIGluIGNvbmZpZ19kYXRhOgogICAgICAgICAgICAgICAgICAgIG5ld19zeW5jX2ludGVydmFsID0gY29uZmlnX2RhdGFbInN5bmNfaW50ZXJ2YWwiXQogICAgICAgICAgICAgICAgICAgIGlmIG5ld19zeW5jX2ludGVydmFsICE9IHNlbGYuc3luY19pbnRlcnZhbDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJD4bqtcCBuaOG6rXQgc3luY19pbnRlcnZhbCB04burIHtzZWxmLnN5bmNfaW50ZXJ2YWx9IHRow6BuaCB7bmV3X3N5bmNfaW50ZXJ2YWx9IikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gbmV3X3N5bmNfaW50ZXJ2YWwKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgS2jhu59pIMSR4buZbmcgbOG6oWkgdGhyZWFkIMSR4buTbmcgYuG7mSBu4bq/dSDEkWFuZyBjaOG6oXkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5zeW5jX3RocmVhZCBpcyBub3QgTm9uZSBhbmQgc2VsZi5zeW5jX3RocmVhZC5pc19hbGl2ZSgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSDEkeG7mW5nIGzhuqFpIHRocmVhZCDEkeG7k25nIGLhu5kgduG7m2kga2hv4bqjbmcgdGjhu51pIGdpYW4gbeG7m2kiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zdG9wX3N5bmNfdGhyZWFkKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3RhcnRfc3luY190aHJlYWQoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFRow7RuZyBiw6FvIGNobyBKb2JTZXJ2aWNlIHbhu4EgdOG6pXQgY+G6oyBjb25maWcgdXBkYXRlCiAgICAgICAgICAgICAgICBpZiBzZWxmLmpvYl9zZXJ2aWNlIGFuZCBoYXNhdHRyKHNlbGYuam9iX3NlcnZpY2UsICdoYW5kbGVfbXF0dF9jb25maWdfdXBkYXRlJyk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlRow7RuZyBiw6FvIEpvYlNlcnZpY2UgduG7gSBjb25maWcgdXBkYXRlIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmpvYl9zZXJ2aWNlLmhhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUoY29uZmlnX2RhdGEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTG9nIHRow6ptIHRow7RuZyB0aW4gduG7gSBqb2ItcmVsYXRlZCBjb25maWdzCiAgICAgICAgICAgICAgICBqb2JfcmVsYXRlZF9rZXlzID0gWyJtYXhfam9ic19wZXJfZGF5IiwgIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgImpvYl9pbnRlcnZhbF9zZWNvbmRzIiwgImNhcmVfaW5fd29ya2luZ19qb2IiXQogICAgICAgICAgICAgICAgaWYgYW55KGtleSBpbiBjb25maWdfZGF0YSBmb3Iga2V5IGluIGpvYl9yZWxhdGVkX2tleXMpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJD4bqldSBow6xuaCBsacOqbiBxdWFuIMSR4bq/biBKb2JTZXJ2aWNlIMSRw6MgxJHGsOG7o2MgY+G6rXAgbmjhuq10IikKICAgICAgICAgICAgICAgICAgICAjIEpvYlNlcnZpY2Ugc+G6vSB44butIGzDvSBsb2dpYyByZXN0YXJ0IHNlc3Npb24gbuG6v3UgY+G6p24gdGhp4bq/dAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu61pIGLDoW8gY8OhbyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgZiLEkMOjIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4s6IHsnLCAnLmpvaW4oY29uZmlnX2RhdGEua2V5cygpKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSAiS2jDtG5nIHRo4buDIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4siCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9tc2cgPSBmIkzhu5dpIHjhu60gbMO9IGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4s6IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCgogICAgZGVmIF9oYW5kbGVfdXBkYXRlX3N5bmNlZChzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuZGVidWcoIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB04burIHNlcnZlciIpCiAgICAgICAgICAgIGRhdGEgPSB0YXNrX2RhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50X2NvdW50ID0gMAogICAgICAgICAgICBqb2JfY291bnQgPSAwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gxJHDoyDEkeG7k25nIGLhu5kKICAgICAgICAgICAgaWYgImFjY291bnRzIiBpbiBkYXRhIGFuZCBpc2luc3RhbmNlKGRhdGFbImFjY291bnRzIl0sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIGFjY291bnRfdXVpZCBpbiBkYXRhWyJhY2NvdW50cyJdOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIubWFya19hc19zeW5jZWQoImFjY291bnRzIiwgYWNjb3VudF91dWlkKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gxJHDoyDEkeG7k25nIGLhu5k6IHthY2NvdW50X3V1aWR9IikKICAgICAgICAgICAgICAgIGFjY291bnRfY291bnQgPSBsZW4oZGF0YVsiYWNjb3VudHMiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGpvYiDEkcOjIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiAiam9icyIgaW4gZGF0YSBhbmQgaXNpbnN0YW5jZShkYXRhWyJqb2JzIl0sIGxpc3QpOgogICAgICAgICAgICAgICAgZm9yIGpvYl91dWlkIGluIGRhdGFbImpvYnMiXToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLm1hcmtfYXNfc3luY2VkKCJqb2JzX2hpc3RvcnkiLCBqb2JfdXVpZCkKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOhbmggZOG6pXUgam9iIMSRw6MgxJHhu5NuZyBi4buZOiB7am9iX3V1aWR9IikKICAgICAgICAgICAgICAgIGpvYl9jb3VudCA9IGxlbihkYXRhWyJqb2JzIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEhp4buDbiB0aOG7iyB0aMO0bmcgYsOhbyB04buVbmcgaOG7o3AgaG/hurdjIHRow7RuZyBiw6FvIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmICJtZXNzYWdlIiBpbiB0YXNrX2RhdGE6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRow7RuZyBiw6FvIHThu6sgc2VydmVyOiB7dGFza19kYXRhWydtZXNzYWdlJ119IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgSGnhu4NuIHRo4buLIHRow7RuZyBiw6FvIHThu5VuZyBo4bujcCBu4bq/dSBraMO0bmcgY8OzIG1lc3NhZ2UgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgICAgIGlmIGFjY291bnRfY291bnQgPiAwIG9yIGpvYl9jb3VudCA+IDA6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4buTbmcgYuG7mSB0aMOgbmggY8O0bmc6IHthY2NvdW50X2NvdW50fSB0w6BpIGtob+G6o24sIHtqb2JfY291bnR9IGpvYiIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHjhu60gbMO9IGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgIAogICAgZGVmIF9oYW5kbGVfYWNjb3VudF91cGRhdGUoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlciBjw7MgY+G6pXUgdHLDumM6CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJ0YXNrX2lkIjogInRhc2tfMTc0OTM5OTUzNjI3Ml82NDEiLAogICAgICAgICAgICAgICAgImRldmljZV9pZCI6ICJhMTI1ZjYyNGY0MWE0ZjdjIiwKICAgICAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAiYWNjb3VudF91cGRhdGUiLAogICAgICAgICAgICAgICAgImRhdGEiOiB7CiAgICAgICAgICAgICAgICAgICAgImFwcCI6ICJpbnN0YWdyYW0iLAogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiaW5hY3RpdmUiLAoKICAgICAgICAgICAgICAgICAgICAiam9iX3RvZGF5IjogMzAsCiAgICAgICAgICAgICAgICAgICAgImpvYl9lbmFibGUiOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICJhY2NvdW50X3V1aWQiOiAiN2VkOTU1N2QtNzZhNC00N2Y3LTg4NTAtN2NlZWYwYzY5MGFmIgogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogInBlbmRpbmciCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB04burIHNlcnZlciAodGFza19pZDoge3Rhc2tfaWR9KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgZGF0YSBvciAiYWNjb3VudF91dWlkIiBub3QgaW4gZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJE4buvIGxp4buHdSB0w6BpIGtob+G6o24ga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsICJE4buvIGxp4buHdSB0w6BpIGtob+G6o24ga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyBEQgogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudF9ieV91dWlkKGRhdGFbImFjY291bnRfdXVpZCJdKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB24bubaSBVVUlEOiB7ZGF0YVsnYWNjb3VudF91dWlkJ119IgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0ge30KICAgICAgICAgICAgdmFsaWRfZmllbGRzID0gWyJzdGF0dXMiLCAiam9iX2VuYWJsZSIsICJqb2JfZGlzYWJsZV91bnRpbCIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX2ZvbGxvdyIsICJmb2xsb3dfZGlzYWJsZV91bnRpbCIsICJmb2xsb3dfdG9kYXkiLCAiZm9sbG93X2luX3Nlc3Npb24iLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAibWF4X2ZvbGxvd19kYXkiLCAibWF4X2ZvbGxvd19zZXNzaW9uIiwgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IHN0YXR1cyA9ICJkZWxldGUiIHRow6wgeMOzYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgaWYgZGF0YS5nZXQoInN0YXR1cyIpID09ICJkZWxldGUiOgogICAgICAgICAgICAgICAgYWNjb3VudF91dWlkID0gZGF0YVsiYWNjb3VudF91dWlkIl0KICAgICAgICAgICAgICAgIGFjY291bnRfdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIlVua25vd24iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IHjDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSAoVVVJRDoge2FjY291bnRfdXVpZH0pIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyAxLiBYw7NhIHThuqV0IGPhuqMgam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBqb2JfaGlzdG9yeV9kZWxldGVkID0gc2VsZi5kYi5kZWxldGVfam9iX2hpc3RvcnlfYnlfYWNjb3VudChhY2NvdW50X3V1aWQpCiAgICAgICAgICAgICAgICBpZiBqb2JfaGlzdG9yeV9kZWxldGVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB4w7NhIGpvYiBoaXN0b3J5IGPhu6dhIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyB4w7NhIGpvYiBoaXN0b3J5IGPhu6dhIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIDIuIFjDs2EgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBhY2NvdW50X2RlbGV0ZWQgPSBzZWxmLmRiLmRlbGV0ZV9hY2NvdW50KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50X2RlbGV0ZWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHjDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSAoSUQ6IHthY2NvdW50WydpZCddfSkga2jhu49pIGRhdGFiYXNlIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIGYixJDDoyB4w7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSBmIktow7RuZyB0aOG7gyB4w7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudF91c2VybmFtZX0iCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkYXRhLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBpZiBrZXkgaW4gdmFsaWRfZmllbGRzOgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhW2tleV0gPSB2YWx1ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgdXBkYXRlX2RhdGE6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIGPDsyB0aMO0bmcgdGluIGPhuqduIGPhuq1wIG5o4bqtdCIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgIktow7RuZyBjw7MgdGjDtG5nIHRpbiBj4bqnbiBj4bqtcCBuaOG6rXQiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSBs4bqhaSB2w6BvIERCCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICBzdWNjZXNzID0gc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICcnKX0gKFVVSUQ6IHtkYXRhWydhY2NvdW50X3V1aWQnXX0pIHbhu5tpIGThu68gbGnhu4d1OiB7dXBkYXRlX2RhdGF9IikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgZiLEkMOjIGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnJyl9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiS2jDtG5nIHRo4buDIGPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnJyl9IgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbjoge3N0cihlKX0iCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCgogICAgZGVmIF9oYW5kbGVfdXBkYXRlX3Byb3h5KHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggcHJveHkKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIgY8OzIGPhuqV1IHRyw7pjOgogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6ICJ0YXNrXzE3NDkzOTk1MzYyNzJfNjQxIiwKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiAiYTEyNWY2MjRmNDFhNGY3YyIsCiAgICAgICAgICAgICAgICAidGFza190eXBlIjogInVwZGF0ZV9wcm94eSIsCiAgICAgICAgICAgICAgICAiZGF0YSI6IHsKICAgICAgICAgICAgICAgICAgICAicHJveHlfY29uZmlnIjogewogICAgICAgICAgICAgICAgICAgICAgICAiaWQiOiAicHJveHlfNDU2IiwKICAgICAgICAgICAgICAgICAgICAgICAgImhvc3QiOiAicHJveHkuZXhhbXBsZS5jb20iLAogICAgICAgICAgICAgICAgICAgICAgICAicG9ydCI6IDgwODAsCiAgICAgICAgICAgICAgICAgICAgICAgICJ1c2VybmFtZSI6ICJ1c2VyIiwKICAgICAgICAgICAgICAgICAgICAgICAgInBhc3N3b3JkIjogInBhc3MiLAogICAgICAgICAgICAgICAgICAgICAgICAidHlwZSI6ICJodHRwIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICIiLAogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJwZW5kaW5nIgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIGRhdGEgPSB0YXNrX2RhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCBwcm94eSB04burIHNlcnZlciAodGFza19pZDoge3Rhc2tfaWR9KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBwcm94eV9jb25maWcgPSBkYXRhCiAgICAgICAgICAgIGlmIG5vdCBwcm94eV9jb25maWc6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSAiVGhp4bq/dSB0aMO0bmcgdGluIHByb3h5X2NvbmZpZyB0cm9uZyBk4buvIGxp4buHdSB0YXNrIgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGPhuqV1IGjDrG5oIHByb3h5IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X2NvbmZpZyIsIHByb3h5X2NvbmZpZykKICAgICAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaSB5w6p1IGPhuqd1IHByb3h5IHbDrCDEkcOjIG5o4bqtbiDEkcaw4bujYyBwcm94eQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoInByb3h5X3JlcXVlc3RlZCIsIDApCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHByb3h5OiB7cHJveHlfY29uZmlnWyduYW1lJ119IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBH4butaSBiw6FvIGPDoW8gdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICBzdWNjZXNzX21zZyA9IGYixJDDoyBj4bqtcCBuaOG6rXQgcHJveHk6IHtwcm94eV9jb25maWdbJ25hbWUnXX0iCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsIHN1Y2Nlc3NfbXNnKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTOG7l2kga2hpIGzGsHUgY+G6pXUgaMOsbmggcHJveHk6IHtzdHIoZSl9IgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IHByb3h5OiB7c3RyKGUpfSIKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgdGFza19pZCA9IHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKQogICAgICAgICAgICBkZXZpY2VfaWQgPSB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQoKICAgIGRlZiBfaGFuZGxlX3N0cmVhbV9zY3JlZW4oc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHN0cmVhbSBtw6BuIGjDrG5oCiAgICAgICAgCiAgICAgICAgVGFzayBmb3JtYXQ6CiAgICAgICAgewogICAgICAgICAgICAidGFza19pZCI6ICJ0YXNrXzEyMzQ1Njc4OTBfMTIzIiwKICAgICAgICAgICAgImRldmljZV9pZCI6ICJkZXZpY2UtMDAxIiwKICAgICAgICAgICAgInRhc2tfdHlwZSI6ICJzdHJlYW1fc2NyZWVuIiwKICAgICAgICAgICAgIm1lc3NhZ2UiOiAiQuG6r3QgxJHhuqd1IHN0cmVhbSBtw6BuIGjDrG5oIiwKICAgICAgICAgICAgInRpbWVzdGFtcCI6ICIyMDI1LTEwLTMxVC4uLiIKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgTG9naWM6CiAgICAgICAgLSBTY3JlZW5zaG90IG3hu5dpIDAuNXMgduG7m2kgcmVzaXplPXRydWUKICAgICAgICAtIFB1Ymxpc2ggbMOqbiB0b3BpYzogZG5kdmluYS9jbGllbnQvc3RyZWFtL3tkZXZpY2VfaWR9CiAgICAgICAgLSBUaW1lb3V0IDYwcywgcmVzZXQgbuG6v3Ugbmjhuq1uIHRhc2sgbeG7m2kKICAgICAgICAtIFThu7EgxJHhu5luZyBk4burbmcgc2F1IDYwcyBraMO0bmcgaG/huqF0IMSR4buZbmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3Ugc3RyZWFtIG3DoG4gaMOsbmggdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGhlbHBlcl9zZXJ2aWNlCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmhlbHBlcl9zZXJ2aWNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gIkhlbHBlciBzZXJ2aWNlIGNoxrBhIMSRxrDhu6NjIGto4bufaSB04bqhbyIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHRpbWVvdXQgbuG6v3UgxJFhbmcgc3RyZWFtCiAgICAgICAgICAgIGlmIHNlbGYuc3RyZWFtX2FjdGl2ZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJTdHJlYW0gxJFhbmcgY2jhuqF5LCByZXNldCB0aW1lb3V0IHbhu4EgNjBzIikKICAgICAgICAgICAgICAgIHNlbGYuc3RyZWFtX2xhc3RfYWN0aXZpdHkgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgInN1Y2Nlc3MiLCAixJDDoyByZXNldCBzdHJlYW0gdGltZW91dCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQuG6r3QgxJHhuqd1IHN0cmVhbSBt4bubaQogICAgICAgICAgICBsb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IHN0cmVhbSBtw6BuIGjDrG5oIG3hu5tpIikKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnN0cmVhbV9sYXN0X2FjdGl2aXR5ID0gdGltZS50aW1lKCkKICAgICAgICAgICAgc2VsZi5zdHJlYW1fc3RvcF9ldmVudC5jbGVhcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFN0YXJ0IHN0cmVhbSB0aHJlYWQKICAgICAgICAgICAgc2VsZi5zdHJlYW1fdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCgKICAgICAgICAgICAgICAgIHRhcmdldD1zZWxmLl9zdHJlYW1fc2NyZWVuX2xvb3AsCiAgICAgICAgICAgICAgICBhcmdzPShkZXZpY2VfaWQsKSwKICAgICAgICAgICAgICAgIGRhZW1vbj1UcnVlCiAgICAgICAgICAgICkKICAgICAgICAgICAgc2VsZi5zdHJlYW1fdGhyZWFkLnN0YXJ0KCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgIsSQw6MgYuG6r3QgxJHhuqd1IHN0cmVhbSBtw6BuIGjDrG5oIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9tc2cgPSBmIkzhu5dpIHjhu60gbMO9IHN0cmVhbSBzY3JlZW46IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIiksCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKSwKICAgICAgICAgICAgICAgICJmYWlsZWQiLAogICAgICAgICAgICAgICAgZXJyb3JfbXNnCiAgICAgICAgICAgICkKICAgIAogICAgZGVmIF9zdHJlYW1fbG9nX2xvb3Aoc2VsZiwgZGV2aWNlX2lkOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIExvb3Agc3RyZWFtIGxvZyByZWFsdGltZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRldmljZV9pZDogRGV2aWNlIElEIMSR4buDIHB1Ymxpc2ggbMOqbiB0b3BpYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc3RyZWFtX3RvcGljID0gZiJkbmR2aW5hL2NsaWVudC9sb2cve2RldmljZV9pZH0iCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTG9nIHN0cmVhbSBsb29wIHN0YXJ0ZWQsIHB1Ymxpc2hpbmcgdG86IHtzdHJlYW1fdG9waWN9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNlY3V0aXZlX2Vycm9ycyA9IDAKICAgICAgICAgICAgbWF4X2NvbnNlY3V0aXZlX2Vycm9ycyA9IDUKICAgICAgICAgICAgCiAgICAgICAgICAgIHdoaWxlIHNlbGYuc3RyZWFtX2FjdGl2ZSBhbmQgbm90IHNlbGYuc3RyZWFtX3N0b3BfZXZlbnQuaXNfc2V0KCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRpbWVvdXQgKDYwcykKICAgICAgICAgICAgICAgICAgICBlbGFwc2VkID0gdGltZS50aW1lKCkgLSBzZWxmLnN0cmVhbV9sYXN0X2FjdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgaWYgZWxhcHNlZCA+PSBzZWxmLnN0cmVhbV90aW1lb3V0OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkxvZyBzdHJlYW0gdGltZW91dCBzYXUge3NlbGYuc3RyZWFtX3RpbWVvdXR9cywgxJFhbmcgZOG7q25nLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGPDsyBxdcOhIG5oaeG7gXUgbOG7l2kgbGnDqm4gdGnhur9wLCBk4burbmcgc3RyZWFtCiAgICAgICAgICAgICAgICAgICAgaWYgY29uc2VjdXRpdmVfZXJyb3JzID49IG1heF9jb25zZWN1dGl2ZV9lcnJvcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIlF1w6Egbmhp4buBdSBs4buXaSBsacOqbiB0aeG6v3AgKHtjb25zZWN1dGl2ZV9lcnJvcnN9KSwgZOG7q25nIGxvZyBzdHJlYW0iKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgbG9nIGVudHJpZXMgdOG7qyBxdWV1ZQogICAgICAgICAgICAgICAgICAgIHBlbmRpbmdfbG9ncyA9IHV0aWxzLmdldF9wZW5kaW5nX2xvZ3MoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIHBlbmRpbmdfbG9nczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBlcnJvciBjb3VudGVyIGtoaSBjw7MgbG9nCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNlY3V0aXZlX2Vycm9ycyA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgVOG6oW8gcGF5bG9hZCDEkeG7gyBwdWJsaXNoCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbV9wYXlsb2FkID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImxvZ3MiOiBwZW5kaW5nX2xvZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZW91dF9yZW1haW5pbmciOiBpbnQoc2VsZi5zdHJlYW1fdGltZW91dCAtIGVsYXBzZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUHVibGlzaCBsw6puIE1RVFQKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2FmZV9wdWJsaXNoKHN0cmVhbV90b3BpYywganNvbi5kdW1wcyhzdHJlYW1fcGF5bG9hZCksIHFvcz0wKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgU2xlZXAgMC41cyB0csaw4bubYyBraGkgY2hlY2sgdGnhur9wCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgwLjUpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgY29uc2VjdXRpdmVfZXJyb3JzICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBsb2cgc3RyZWFtIGxvb3AgKHtjb25zZWN1dGl2ZV9lcnJvcnN9L3ttYXhfY29uc2VjdXRpdmVfZXJyb3JzfSk6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgwLjUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFudXAKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gRmFsc2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkxvZyBzdHJlYW0gxJHDoyBk4burbmciKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGxvZyBzdHJlYW0gbG9vcDoge2V9IikKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gRmFsc2UKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAjIEFsd2F5cyBzdG9wIGxvZyBzdHJlYW1pbmcga2hpIGxvb3Aga+G6v3QgdGjDumMKICAgICAgICAgICAgdXRpbHMuc3RvcF9sb2dfc3RyZWFtKCkKICAgIAogICAgZGVmIHN0b3Bfc3RyZWFtKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBsb2cgc3RyZWFtIiIiCiAgICAgICAgaWYgc2VsZi5zdHJlYW1fYWN0aXZlOgogICAgICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIGxvZyBzdHJlYW0uLi4iKQogICAgICAgICAgICBzZWxmLnN0cmVhbV9hY3RpdmUgPSBGYWxzZQogICAgICAgICAgICBzZWxmLnN0cmVhbV9zdG9wX2V2ZW50LnNldCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFN0b3AgbG9nIHN0cmVhbWluZwogICAgICAgICAgICB1dGlscy5zdG9wX2xvZ19zdHJlYW0oKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi5zdHJlYW1fdGhyZWFkOgogICAgICAgICAgICAgICAgc2VsZi5zdHJlYW1fdGhyZWFkLmpvaW4odGltZW91dD0yLjApCiAgICAgICAgICAgICAgICBzZWxmLnN0cmVhbV90aHJlYWQgPSBOb25lCgogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIMSR4buZbmcgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVGhp4bq/dCBs4bqtcCBjw6FjIGhhbmRsZXIgdHLGsOG7m2Mga2hpIGvhur90IG7hu5FpCiAgICAgICAgICAgIHNlbGYuc2V0dXBfbXF0dF9oYW5kbGVycygpCiAgICAgICAgICAgIHNlbGYuY29ubmVjdCgpCiAgICAgICAgICAgICMgS2jhu59pIMSR4buZbmcgc3luYyB0aHJlYWQgc2F1IGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgc2VsZi5zdGFydF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZSB2w6AgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgTVFUVCBzZXJ2aWNlIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9vbl9tZXNzYWdlKHNlbGYsIGNsaWVudCwgdXNlcmRhdGEsIG1zZywgcHJvcGVydGllcz1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBDYWxsYmFjayBraGkgbmjhuq1uIMSRxrDhu6NjIG1lc3NhZ2UgdOG7qyBNUVRUIGJyb2tlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNsaWVudDogTVFUVCBjbGllbnQgaW5zdGFuY2UKICAgICAgICAgICAgdXNlcmRhdGE6IFVzZXIgZGF0YSDEkcaw4bujYyB0cnV54buBbiB2w6BvIGNsaWVudAogICAgICAgICAgICBtc2c6IE1lc3NhZ2Ugb2JqZWN0IGNo4bupYSB0b3BpYyB2w6AgcGF5bG9hZAogICAgICAgICAgICBwcm9wZXJ0aWVzOiBQcm9wZXJ0aWVzIGPhu6dhIG1lc3NhZ2UgKE1RVFQgdjUpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljOiB7bXNnLnRvcGljfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFBhcnNlIHBheWxvYWQgSlNPTgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwYXlsb2FkID0ganNvbi5sb2Fkcyhtc2cucGF5bG9hZC5kZWNvZGUoJ3V0Zi04JykpCiAgICAgICAgICAgIGV4Y2VwdCBqc29uLkpTT05EZWNvZGVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBwYXJzZSBKU09OIHThu6sgcGF5bG9hZDoge21zZy5wYXlsb2FkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70gbWVzc2FnZSBk4buxYSB0csOqbiB0b3BpYwogICAgICAgICAgICBpZiBtc2cudG9waWMgPT0gc2VsZi50b3BpY19zZXJ2ZXJfdGFzazoKICAgICAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9zZXJ2ZXJfdGFzayhwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJOaOG6rW4gbWVzc2FnZSB04burIHRvcGljIGtow7RuZyB4w6FjIMSR4buLbmg6IHttc2cudG9waWN9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgeOG7rSBsw70gbWVzc2FnZToge3N0cihlKX0iKQoKICAgIGRlZiBfaGFuZGxlX3NlcnZlcl90YXNrKHNlbGYsIHBheWxvYWQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcGF5bG9hZDogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlcgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza190eXBlID0gcGF5bG9hZC5nZXQoInRhc2tfdHlwZSIpCiAgICAgICAgICAgIGlmIG5vdCB0YXNrX3R5cGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiTmjhuq1uIHRhc2sga2jDtG5nIGPDsyB0YXNrX3R5cGUiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJOaOG6rW4gdGFzayB04burIHNlcnZlcjoge3Rhc2tfdHlwZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBoYW5kbGVyIHTGsMahbmcg4bupbmcgbuG6v3UgxJHDoyDEkcSDbmcga8O9CiAgICAgICAgICAgIGlmIHRhc2tfdHlwZSBpbiBzZWxmLnRhc2tfaGFuZGxlcnM6CiAgICAgICAgICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnNbdGFza190eXBlXShwYXlsb2FkKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgaGFuZGxlciBjaG8gdGFza190eXBlOiB7dGFza190eXBlfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgeOG7rSBsw70gdGFzayB04burIHNlcnZlcjoge3N0cihlKX0iKQogICAgCiAgICBkZWYgX21vbml0b3JfcmFtX3VzYWdlKHNlbGYsIGRldmljZV9pbmZvOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgVGhlbyBkw7VpIFJBTSB2w6AgdOG7sSDEkeG7mW5nIHJlYm9vdCBu4bq/dSBSQU0gY2FvIGxpw6puIHThu6VjCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZGV2aWNlX2luZm86IFRow7RuZyB0aW4gdGhp4bq/dCBi4buLIGNo4bupYSBSQU0gdXNhZ2UKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOtbmggcGjhuqduIHRyxINtIFJBTSBz4butIGThu6VuZyB04burIHJhbV90b3RhbCB2w6AgcmFtX3VzZWQKICAgICAgICAgICAgcmFtX3RvdGFsID0gZGV2aWNlX2luZm8uZ2V0KCJyYW1fdG90YWwiLCAwKQogICAgICAgICAgICByYW1fdXNlZCA9IGRldmljZV9pbmZvLmdldCgicmFtX3VzZWQiLCAwKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmFtX3RvdGFsID4gMCBhbmQgcmFtX3VzZWQgPj0gMDoKICAgICAgICAgICAgICAgIHJhbV91c2FnZV9wZXJjZW50ID0gKHJhbV91c2VkIC8gcmFtX3RvdGFsKSAqIDEwMAogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOtbmggdG/DoW4gUkFNOiB7cmFtX3VzZWR9TUIve3JhbV90b3RhbH1NQiA9IHtyYW1fdXNhZ2VfcGVyY2VudDouMWZ9JSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiB0aOG7rSBs4bqleSB0cuG7sWMgdGnhur9wIHThu6sgZGV2aWNlX2luZm8KICAgICAgICAgICAgICAgIHJhbV91c2FnZV9wZXJjZW50ID0gZGV2aWNlX2luZm8uZ2V0KCJyYW1fcGVyY2VudGFnZSIsIDApCiAgICAgICAgICAgICAgICBpZiByYW1fdXNhZ2VfcGVyY2VudCA9PSAwOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiS2jDtG5nIGPDsyB0aMO0bmcgdGluIFJBTSBo4bujcCBs4buHLCBz4butIGThu6VuZyBnacOhIHRy4buLIG3hurdjIMSR4buLbmggMCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJT4butIGThu6VuZyByYW1fcGVyY2VudGFnZSB0cuG7sWMgdGnhur9wOiB7cmFtX3VzYWdlX3BlcmNlbnQ6LjFmfSUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gdsOgbyBs4buLY2ggc+G7rSAoY2jhu4kgZ2nhu68gbOG6oWkgMyBs4bqnbiBn4bqnbiBuaOG6pXQpCiAgICAgICAgICAgIHNlbGYucmFtX3VzYWdlX2hpc3RvcnkuYXBwZW5kKHJhbV91c2FnZV9wZXJjZW50KQogICAgICAgICAgICBpZiBsZW4oc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSkgPiBzZWxmLmNvbnNlY3V0aXZlX2hpZ2hfcmFtX2xpbWl0OgogICAgICAgICAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeS5wb3AoMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJBTSBoaeG7h24gdOG6oWk6IHtyYW1fdXNhZ2VfcGVyY2VudDouMWZ9JSAobOG7i2NoIHPhu606IHtbZid7eDouMWZ9JScgZm9yIHggaW4gc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeV19KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgY8OzIMSR4bunIDMgbOG6p24gxJFvIHbDoCB04bqldCBj4bqjIMSR4buBdSA+IG5nxrDhu6FuZwogICAgICAgICAgICBpZiBsZW4oc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSkgPj0gc2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdDoKICAgICAgICAgICAgICAgIGlmIGFsbCh1c2FnZSA+IHNlbGYuaGlnaF9yYW1fdGhyZXNob2xkIGZvciB1c2FnZSBpbiBzZWxmLnJhbV91c2FnZV9oaXN0b3J5KToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlJBTSBjYW8gbGnDqm4gdOG7pWMge3NlbGYuY29uc2VjdXRpdmVfaGlnaF9yYW1fbGltaXR9IGzhuqduICg+e3NlbGYuaGlnaF9yYW1fdGhyZXNob2xkfSUpOiB7W2Yne3g6LjFmfSUnIGZvciB4IGluIHNlbGYucmFtX3VzYWdlX2hpc3RvcnldfSIpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkLhuq90IMSR4bqndSByZWJvb3QgdGhp4bq/dCBi4buLIMSR4buDIGdp4bqjaSBwaMOzbmcgUkFNLi4uIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gcmVib290CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5fcmVib290X2RldmljZSgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBn4butaSBs4buHbmggcmVib290IHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgbOG7i2NoIHPhu60gc2F1IGtoaSByZWJvb3QKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeS5jbGVhcigpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgdGjhu7FjIGhp4buHbiByZWJvb3QgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdGhlbyBkw7VpIFJBTToge2V9IikKICAgIAogICAgZGVmIF9yZWJvb3RfZGV2aWNlKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiByZWJvb3QgdGhp4bq/dCBi4buLIHF1YSBBREIKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIERFVklDRV9JUCB04burIGNvbmZpZyB0aGF5IHbDrCBBREJfSE9TVAogICAgICAgICAgICBkZXZpY2VfYWRkcmVzcyA9IGYie2NvbmZpZy5ERVZJQ0VfSVB9Ontjb25maWcuQURCX1BPUlR9IgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4buHbmggcmVib290IHF1YSBBREIKICAgICAgICAgICAgY21kID0gWyJhZGIiLCAiLXMiLCBkZXZpY2VfYWRkcmVzcywgInJlYm9vdCJdCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gcmVib290IHRoaeG6v3QgYuG7izogeycgJy5qb2luKGNtZCl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKAogICAgICAgICAgICAgICAgY21kLAogICAgICAgICAgICAgICAgY2hlY2s9VHJ1ZSwKICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICAgICAgdGV4dD1UcnVlLAogICAgICAgICAgICAgICAgdGltZW91dD0xMCAgIyBUaW1lb3V0IDEwIGdpw6J5CiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTOG7h25oIHJlYm9vdCDEkcOjIMSRxrDhu6NjIGfhu61pIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLlRpbWVvdXRFeHBpcmVkOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiVGltZW91dCBraGkgZ+G7rWkgbOG7h25oIHJlYm9vdCAodGhp4bq/dCBi4buLIGPDsyB0aOG7gyDEkWFuZyByZWJvb3QpIikKICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgQ29pIG5oxrAgdGjDoG5oIGPDtG5nIHbDrCBjw7MgdGjhu4MgdGhp4bq/dCBi4buLIMSRYW5nIHJlYm9vdAogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLkNhbGxlZFByb2Nlc3NFcnJvciBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiByZWJvb3Q6IHtlLnN0ZGVycn0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBleGNlcHQgRmlsZU5vdEZvdW5kRXJyb3I6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IGzhu4duaCBhZGIsIGtow7RuZyB0aOG7gyByZWJvb3QgdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraMO0bmcgeMOhYyDEkeG7i25oIGtoaSByZWJvb3QgdGhp4bq/dCBi4buLOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2U=').decode('utf-8'))
