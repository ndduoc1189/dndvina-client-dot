import base64
exec(base64.b64decode('aW1wb3J0IGRhdGV0aW1lCmltcG9ydCB0aW1lCmltcG9ydCByYW5kb20KaW1wb3J0IHJlCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsCmZyb20gam9icy5qb2JfYmFzZSBpbXBvcnQgQmFzZUpvYgoKY2xhc3MgVGlrdG9rSm9iKEJhc2VKb2IpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSkKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gImNvbS5zcy5hbmRyb2lkLnVnYy50cmlsbCIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gInRpa3RvayIKICAgICAgICAKICAgICAgICAjIE92ZXJyaWRlIGRlZmF1bHQgY29uZmlnIGNobyBUaWtUb2sKICAgICAgICBzZWxmLl9kZWZhdWx0X2NvbmZpZy51cGRhdGUoewogICAgICAgICAgICAiYWN0aW9uX3dlaWdodHMiOiB7CiAgICAgICAgICAgICAgICAibmV3c2ZlZWQiOiAxMCwgICAgICAjIDEwJSB2deG7kXQgYuG6o25nIHRpbiAow610IGjGoW4gdsOsIFRpa1RvayBjaOG7pyB54bq/dSBsw6AgdmlkZW8pCiAgICAgICAgICAgICAgICAicmVlbHMiOiAyNSwgICAgICAgICAjIDI1JSB4ZW0gdmlkZW8gKGNow61uaCBj4bunYSBUaWtUb2spIAogICAgICAgICAgICAgICAgIm5vdGlmaWNhdGlvbiI6IDgsICAgIyA4JSB4ZW0gdGjDtG5nIGLDoW8KICAgICAgICAgICAgICAgICJwcm9maWxlIjogMTIsICAgICAgICMgMTIlIHhlbSBwcm9maWxlCiAgICAgICAgICAgICAgICAiam9iIjogMjAsICAgICAgICAgICAjIDIwJSBsw6BtIGpvYiAoZ2nhu68gbmd1ecOqbikKICAgICAgICAgICAgICAgICJleHBsb3JlIjogMTUsICAgICAgICMgMTUlIGtow6FtIHBow6EgKGNhbyBoxqFuIHbDrCBUaWtUb2sgaGF5IHN1Z2dlc3QpCiAgICAgICAgICAgICAgICAic2VhcmNoIjogNSwgICAgICAgICAjIDUlIHTDrG0ga2nhur9tICjDrXQgaMahbiB2w6wgVGlrVG9rIGThu7FhIHbDoG8gYWxnb3JpdGhtKQogICAgICAgICAgICAgICAgImxpdmUiOiA1ICAgICAgICAgICAgIyA1JSB4ZW0gbGl2ZXN0cmVhbSAoYWN0aW9uIHJpw6puZyBj4bunYSBUaWtUb2spCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJtYXhfYWN0aW9uc19wZXJfc2Vzc2lvbiI6IDM1LCAgIyBUaWtUb2sgY8OzIHRo4buDIG5oaeG7gXUgYWN0aW9ucyBoxqFuIFlvdVR1YmUgKDM1KQogICAgICAgIH0pCiAgICAgICAgCiAgICAgICAgIyBDYWNoZSBjaG8gY3VycmVudCB1c2VybmFtZSDEkeG7gyB0csOhbmggY2hlY2sgcXXDoSBuaGnhu4F1CiAgICAgICAgc2VsZi5fY2FjaGVkX3VzZXJuYW1lID0gTm9uZQogICAgICAgIHNlbGYuX3VzZXJuYW1lX2NhY2hlX3RpbWUgPSAwCiAgICAgICAgc2VsZi5fdXNlcm5hbWVfY2FjaGVfdHRsID0gNjAgICMgQ2FjaGUgNjAgZ2nDonkKICAgIAogICAgZGVmIGdldF9zdXBwb3J0ZWRfYWN0aW9ucyhzZWxmKSAtPiBMaXN0W3N0cl06CiAgICAgICAgIiIiCiAgICAgICAgT3ZlcnJpZGUgZGFuaCBzw6FjaCBhY3Rpb25zIMSRxrDhu6NjIFRpa1RvayBo4buXIHRy4bujCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtzdHJdOiBEYW5oIHPDoWNoIGFjdGlvbnMgVGlrVG9rIGjhu5cgdHLhu6MKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gbGlzdChzZWxmLmdldF9hY3Rpb25fd2VpZ2h0cygpLmtleXMoKSkKICAgICAgICAKICAgIGRlZiBnZXRfYWNjb3VudHNfZnJvbV9kZXZpY2Uoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gVGlrdG9rIHThu6sgdGhp4bq/dCBi4buLIiIiCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgZW5zdXJlX2hvbWVfc2NyZWVuKCkgdGhheSB2w6wgY2jhu4kgd2FpdF9mb3JfZWxlbWVudAogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgdOG6o2kgbcOgbiBow6xuaCBjaMOtbmggVGlrVG9rIHNhdSAyMCBnacOieSIpCiAgICAgICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCAiSOG7kyBzxqEiIHbDoCBuaOG6pXAgdsOgbwogICAgICAgICAgICBpZiBub3Qgc2VsZi5fbmF2aWdhdGVfdG9fcHJvZmlsZV90YWIoKToKICAgICAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyBtZW51IGjhu5Mgc8ahIMSR4buDIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9vcGVuX3Byb2ZpbGVfbWVudSgpOgogICAgICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IFhNTCBtw6BuIGjDrG5oIHNhdSBraGkgbeG7nyBtZW51CiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgIlRow6ptIHTDoGkga2hv4bqjbiIKICAgICAgICAgICAgYWRkX2FjY291bnRfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9IlRow6ptIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBhZGRfYWNjb3VudF9idXR0b246CiAgICAgICAgICAgICAgICAjIFTDrG0gZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gKFJlY3ljbGVyVmlldykgLSBsw6AgY2hhIGPhu6dhIG7DunQgIlRow6ptIHTDoGkga2hv4bqjbiIKICAgICAgICAgICAgICAgIHJlY3ljbGVyX3ZpZXcgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSB04bqldCBj4bqjIFJlY3ljbGVyVmlldwogICAgICAgICAgICAgICAgYWxsX3JlY3ljbGVyX3ZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsIAogICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWR4LnJlY3ljbGVydmlldy53aWRnZXQuUmVjeWNsZXJWaWV3IgogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gUmVjeWNsZXJWaWV3IGNo4bupYSBjw6FjIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgZm9yIHJ2IGluIGFsbF9yZWN5Y2xlcl92aWV3czoKICAgICAgICAgICAgICAgICAgICBydl9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHMocnYpCiAgICAgICAgICAgICAgICAgICAgYWRkX2FjY291bnRfYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGFkZF9hY2NvdW50X2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGFkZF9hY2NvdW50X2J1dHRvbiBjw7MgbuG6sW0gdHJvbmcgcmVjeWNsZXJfdmlldyBraMO0bmcKICAgICAgICAgICAgICAgICAgICBpZiAocnZfYm91bmRzWzBdIDw9IGFkZF9hY2NvdW50X2JvdW5kc1swXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgcnZfYm91bmRzWzFdIDw9IGFkZF9hY2NvdW50X2JvdW5kc1sxXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgcnZfYm91bmRzWzJdID49IGFkZF9hY2NvdW50X2JvdW5kc1syXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgcnZfYm91bmRzWzNdID49IGFkZF9hY2NvdW50X2JvdW5kc1szXSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlY3ljbGVyX3ZpZXcgPSBydgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiByZWN5Y2xlcl92aWV3OgogICAgICAgICAgICAgICAgICAgICMgVMOsbSB04bqldCBj4bqjIG7DunQgKEJ1dHRvbikgdHJvbmcgUmVjeWNsZXJWaWV3IGLhurFuZyBjbGFzcyB0aGF5IHbDrCByZXNvdXJjZS1pZAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfYnV0dG9ucyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3IgYnV0dG9uIGluIGFjY291bnRfYnV0dG9uczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBC4buPIHF1YSBuw7p0ICJUaMOqbSB0w6BpIGtob+G6o24iCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJ1dHRvbi5nZXQoImNvbnRlbnQtZGVzYyIpID09ICJUaMOqbSB0w6BpIGtob+G6o24iOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgTOG6pXkgdMOqbiB0w6BpIGtob+G6o24gdOG7qyBjb250ZW50LWRlc2MKICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiLCAiIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUw6xtIFRleHRWaWV3IHRyb25nIGJ1dHRvbiBi4bqxbmcgY2xhc3MgdGhheSB2w6wgcmVzb3VyY2UtaWQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHR2aWV3cyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LlRleHRWaWV3IgogICAgICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEzhu41jIHRleHR2aWV3IHRoZW8gYm91bmRzIMSR4buDIHTDrG0gxJHDum5nIGPDoWkgdGh14buZYyB24buBIGJ1dHRvbiBuw6B5CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGJ1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciB0diBpbiB0ZXh0dmlld3M6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKHR2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dl9ib3VuZHNbMF0gPj0gYnV0dG9uX2JvdW5kc1swXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzWzFdID49IGJ1dHRvbl9ib3VuZHNbMV0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kc1syXSA8PSBidXR0b25fYm91bmRzWzJdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHNbM10gPD0gYnV0dG9uX2JvdW5kc1szXSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHR2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgxJHhu4Mga2jDtG5nIGzhuqV5IHBo4bqjaSB0ZXh0IHLhu5duZyBob+G6t2MgIm51bGwiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIHRleHQgIT0gIm51bGwiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcm5hbWUgPSB0ZXh0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBC4buPIHF1YSBuw7p0ICLEkMOzbmciCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lID09ICLEkMOzbmciOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkWFuZyDEkcSDbmcgbmjhuq1wIGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICBpc19jdXJyZW50ID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgVMOsbSBk4bqldSBraeG7g20gdHJvbmcgYnV0dG9uIGLhurFuZyBjb250ZW50LWRlc2MKICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2ttYXJrcyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250ZW50X2Rlc2M9IkThuqV1IGtp4buDbSIKICAgICAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBk4bqldSBraeG7g20gY8OzIHRodeG7mWMgduG7gSBidXR0b24gbsOgeSBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uX2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhidXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBjaGVjayBpbiBjaGVja21hcmtzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGNoZWNrKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNoZWNrX2JvdW5kc1swXSA+PSBidXR0b25fYm91bmRzWzBdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrX2JvdW5kc1sxXSA+PSBidXR0b25fYm91bmRzWzFdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrX2JvdW5kc1syXSA8PSBidXR0b25fYm91bmRzWzJdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoZWNrX2JvdW5kc1szXSA8PSBidXR0b25fYm91bmRzWzNdKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc19jdXJyZW50ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEPFqW5nIGPDsyB0aOG7gyBraeG7g20gdHJhIHRodeG7mWMgdMOtbmggc2VsZWN0ZWQKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYnV0dG9uLmdldCgic2VsZWN0ZWQiKSA9PSAidHJ1ZSI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpc19jdXJyZW50ID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHVzZXJuYW1lIGjhu6NwIGzhu4cgdHLGsOG7m2Mga2hpIHRow6ptIHbDoG8gZGFuaCBzw6FjaAogICAgICAgICAgICAgICAgICAgICAgICBpZiB1c2VybmFtZSBhbmQgdXNlcm5hbWUgIT0gIm51bGwiIGFuZCB1c2VybmFtZS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBM4buNYyB0aMOqbSBjw6FjIHTDqm4ga2jDtG5nIHBo4bqjaSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lIG5vdCBpbiBbIkPDoGkgxJHhurd0IiwgIkPDoGkgxJHhurd0IHTDoGkga2hv4bqjbiIsICJUw7l5IGNo4buNbiIsICJNZW51Il06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm5pY2tuYW1lIjogdXNlcm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlxdWVfdXNlcm5hbWUiOiB1c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInVuaXF1ZV9pZCI6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGlzX2N1cnJlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvYl9lbmFibGUiOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGV2ZWwiOiAxLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRzLmFwcGVuZChhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFF1YXkgbOG6oWkgbcOgbiBow6xuaCBjaMOtbmgKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDAuNSkKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIFRpa1RvayIpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50cwogICAgCiAgICBkZWYgcGVyZm9ybV9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIlRo4buxYyBoaeG7h24gY8O0bmcgdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiBUaWtUb2siIiIKICAgICAgICAjIFPhu60gZOG7pW5nIHBoxrDGoW5nIHRo4bupYyBj4bunYSBs4bubcCBjaGEKICAgICAgICBzdXBlcigpLnBlcmZvcm1fam9iKGFjY291bnQpCiAgICAgICAgCiAgICBkZWYgcGVyZm9ybV9jYXJlKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKToKICAgICAgICAiIiIKICAgICAgICBOdcO0aSB0w6BpIGtob+G6o24gVGlrVG9rIC0gTGVnYWN5IG1ldGhvZCwgc+G7rSBk4bulbmcgU21hcnQgQ2FyZSBt4bubaQogICAgICAgIEJhY2t3YXJkIGNvbXBhdGliaWxpdHk6IGNodXnhu4NuIGjGsOG7m25nIHNhbmcgU21hcnQgQ2FyZSBtZXRob2RzCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIG51w7RpIHTDoGkga2hv4bqjbiBUaWtUb2s6IHthY2NvdW50Wyd1bmlxdWVfdXNlcm5hbWUnXX0gKGxlZ2FjeSBtZXRob2QpIikKICAgICAgICAKICAgICAgICAjIFPhu60gZOG7pW5nIFNtYXJ0IENhcmUgbWV0aG9kIHRoYXkgdsOsIG1pbmkgY2FyZSBjxakKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgY2FyZV9tZXRob2RzID0gWyJfY2FyZV9zd2lwZV9mZWVkIiwgIl9jYXJlX3dhdGNoX3ZpZGVvcyJdCiAgICAgICAgc2VsZWN0ZWRfbWV0aG9kID0gcmFuZG9tLmNob2ljZShjYXJlX21ldGhvZHMpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBtZXRob2QgPSBnZXRhdHRyKHNlbGYsIHNlbGVjdGVkX21ldGhvZCkKICAgICAgICAgICAgc3VjY2VzcyA9IG1ldGhvZChhY2NvdW50KQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTGVnYWN5IGNhcmUgdXNpbmcge3NlbGVjdGVkX21ldGhvZH06IHsnc3VjY2VzcycgaWYgc3VjY2VzcyBlbHNlICdmYWlsZWQnfSIpCiAgICAgICAgICAgIHJldHVybiBzdWNjZXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkxlZ2FjeSBjYXJlIGVycm9yOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBwZXJmb3JtX21pbmlfY2FyZShzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIG1pbmkgY2FyZSBjaG8gdMOgaSBraG/huqNuIFRpa1RvazoKICAgICAgICAxLiBW4buBIHRyYW5nIGNo4bunLCB4w6FjIG5o4bqtbiB0YWIgxJHhu4EgeHXhuqV0CiAgICAgICAgMi4gTMaw4bubdCDEkeG7gSB4deG6pXQgdHJvbmcgMi0zIHBow7p0CiAgICAgICAgMy4gTmfhuqt1IG5oacOqbiBi4bqlbSB2w6BvIEjhu5lwIHRoxrAsIGThu6tuZyAyLTVzLCB2deG7kXQgbMOqbiwgcXVheSBs4bqhaSB0cmFuZyBjaOG7pwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbWluaSBjYXJlIGNobyB0w6BpIGtob+G6o24gVGlrVG9rOiB7YWNjb3VudFsndW5pcXVlX3VzZXJuYW1lJ119IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMS4gxJDhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgdsOgIHjDoWMgbmjhuq1uIHRhYiDEkeG7gSB4deG6pXQKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHbhu4EgdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB2w6AgY2xpY2sgdsOgbyB0YWIgIkTDoG5oIGNobyBi4bqhbiIgKHRhYiDEkeG7gSB4deG6pXQpCiAgICAgICAgICAgIGZvcl95b3VfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IkTDoG5oIGNobyBi4bqhbiIpCiAgICAgICAgICAgIGlmIG5vdCBmb3JfeW91X3RhYjoKICAgICAgICAgICAgICAgIGZvcl95b3VfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iRMOgbmggY2hvIGLhuqFuIikKICAgICAgICAgICAgaWYgbm90IGZvcl95b3VfdGFiOgogICAgICAgICAgICAgICAgZm9yX3lvdV90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iRm9yIFlvdSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgZm9yX3lvdV90YWI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSB0YWIgxJHhu4EgeHXhuqV0LCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihmb3JfeW91X3RhYikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiDEkeG7gSB4deG6pXQsIGdp4bqjIMSR4buLbmggxJFhbmcg4bufIHRhYiDEkcO6bmciKQoKICAgICAgICAgICAgIyAyLiBMxrDhu5t0IMSR4buBIHh14bqldCB0cm9uZyAxLTMgcGjDunQKICAgICAgICAgICAgc2Nyb2xsX2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQoNjAsIDE4MCkgICMgMS0zIHBow7p0CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbMaw4bubdCDEkeG7gSB4deG6pXQgdHJvbmcge3Njcm9sbF9kdXJhdGlvbn0gZ2nDonkuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHZpZGVvX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkgPCBzY3JvbGxfZHVyYXRpb246CiAgICAgICAgICAgICAgICAjIEzGsOG7m3QgbMOqbiDEkeG7gyBjaHV54buDbiB2aWRlbyB0aeG6v3AgdGhlbwogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgdmlkZW9fY291bnQgKz0gMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6q3Ugbmhpw6puIDMtOCBnacOieSBnaeG7r2EgY8OhYyB2aWRlbyAobmjGsCBuZ8aw4budaSBkw7luZyB0aOG6rXQpCiAgICAgICAgICAgICAgICB3YXRjaF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgOCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YXRjaF90aW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJhbmRvbSBjw7MgMTAlIGto4bqjIG7Eg25nIGLhuqVtIGxpa2UgdmlkZW8KICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IDAuMTogICMgMTAlIGNoYW5jZQogICAgICAgICAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgICAgICAgICAgICAgaWYgbGlrZV9idXR0b24gYW5kIG5vdCBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGxpa2VfYnV0dG9uKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUmFuZG9tIGxpa2UgdmlkZW8gdHJvbmcga2hpIG1pbmkgY2FyZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihsaWtlX2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmFuZG9tIGPDsyA1JSBraOG6oyBuxINuZyBi4bqlbSBzaGFyZQogICAgICAgICAgICAgICAgaWYgcmFuZG9tLnJhbmRvbSgpIDwgMC4wNTogICMgNSUgY2hhbmNlCiAgICAgICAgICAgICAgICAgICAgc2hhcmVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iQ2hpYSBz4bq7IikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2hhcmVfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzaGFyZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJTaGFyZSIpCiAgICAgICAgICAgICAgICAgICAgaWYgc2hhcmVfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJSYW5kb20gY2xpY2sgc2hhcmUgdHJvbmcga2hpIG1pbmkgY2FyZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzaGFyZV9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAjIE5o4bqlbiBiYWNrIMSR4buDIMSRw7NuZyBkaWFsb2cgc2hhcmUKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbMaw4bubdCB7dmlkZW9fY291bnR9IHZpZGVvIHRyb25nIHtzY3JvbGxfZHVyYXRpb259IGdpw6J5IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gTmfhuqt1IG5oacOqbiBi4bqlbSB2w6BvIEjhu5lwIHRoxrAgKDUwJSBraOG6oyBuxINuZykKICAgICAgICAgICAgaWYgcmFuZG9tLnJhbmRvbSgpIDwgMC41OiAgIyA1MCUgY2hhbmNlCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJSYW5kb20gdHJ1eSBj4bqtcCBI4buZcCB0aMawLi4uIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIHbDoCBjbGljayB2w6BvIEjhu5lwIHRoxrAKICAgICAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9Ikjhu5lwIHRoxrAiKQogICAgICAgICAgICAgICAgaWYgaW5ib3hfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlTDrG0gdGjhuqV5IEjhu5lwIHRoxrAsIMSRYW5nIGNsaWNrIHbDoG8uLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihpbmJveF9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBE4burbmcgbOG6oWkgMi01IGdpw6J5CiAgICAgICAgICAgICAgICAgICAgd2FpdF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMiwgNSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiROG7q25nIGzhuqFpIHt3YWl0X3RpbWV9IGdpw6J5IHRyb25nIEjhu5lwIHRoxrAuLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YWl0X3RpbWUpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiB0cm9uZyBI4buZcCB0aMawCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVnXhu5F0IGzDqm4gdHJvbmcgSOG7mXAgdGjGsC4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUXVheSBs4bqhaSB0cmFuZyBjaOG7pwogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlF1YXkgbOG6oWkgdHJhbmcgY2jhu6cgdOG7qyBI4buZcCB0aMawLi4uIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5iYWNrX3RvX2hvbWUoKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHF1YXkgduG7gSB0cmFuZyBjaOG7pyB04burIEjhu5lwIHRoxrAiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBI4buZcCB0aMawIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlNraXAgdHJ1eSBj4bqtcCBI4buZcCB0aMawIGzhuqduIG7DoHkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gduG7gSB0cmFuZyBjaOG7pyBjdeG7kWkgY8O5bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgc2F1IG1pbmkgY2FyZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkhvw6BuIHRow6BuaCBtaW5pIGNhcmUgY2hvIHTDoGkga2hv4bqjbiBUaWtUb2s6IHthY2NvdW50Wyd1bmlxdWVfdXNlcm5hbWUnXX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIG1pbmkgY2FyZSBjaG8gdMOgaSBraG/huqNuIFRpa1Rvazoge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhu5EgZ+G6r25nIHbhu4EgdHJhbmcgY2jhu6cgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3Jlc3RhcnRfYXBwKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB2w6AgbeG7nyBs4bqhaQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQYW5nIMSRw7NuZyBhcHAgVGlrVG9rLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDs25nIGFwcAogICAgICAgICAgICBzZWxmLmhlbHBlci5mb3JjZV9zdG9wX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyBs4bqhaSBhcHAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJBhbmcgbeG7nyBs4bqhaSBhcHAgVGlrVG9rLi4uIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu50gYXBwIHThuqNpIHhvbmcKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgYXBwIMSRw6MgbeG7nyB0aMOgbmggY8O0bmcgY2jGsGEKICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfYXBwKCkgPT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgcmVzdGFydCBhcHAgVGlrVG9rIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIlJlc3RhcnQgYXBwIFRpa1RvayB0aOG6pXQgYuG6oWkiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHJlc3RhcnQgYXBwIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9zY3JvbGxfZm9yX3lvdV9mZWVkKHNlbGYsIGR1cmF0aW9uX3NlY29uZHM6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrDhu5t0IGZlZWQgxJHhu4EgeHXhuqV0IHRyb25nIGtob+G6o25nIHRo4budaSBnaWFuIG5o4bqldCDEkeG7i25oCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgZHVyYXRpb25fc2Vjb25kczogVGjhu51pIGdpYW4gbMaw4bubdCAoZ2nDonkpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0YXJ0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICBzY3JvbGxfY291bnQgPSAwCiAgICAgICAgICAgIAogICAgICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUgPCBkdXJhdGlvbl9zZWNvbmRzOgogICAgICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiDEkeG7gyBjaHV54buDbiB2aWRlbyB0aeG6v3AgdGhlbwogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2Nyb2xsX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuqt1IG5oacOqbiAyLTYgZ2nDonkgbmjGsCBuZ8aw4budaSBkw7luZyB0aOG6rXQgeGVtIHZpZGVvCiAgICAgICAgICAgICAgICB3YXRjaF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMiwgNikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YXRjaF90aW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJhbmRvbSB0aOG7iW5oIHRob+G6o25nIGThu6tuZyBsw6J1IGjGoW4gKG5oxrAgxJFhbmcgeGVtIHZpZGVvIHRow7ogduG7iykKICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kaW50KDEsIDEwKSA9PSAxOiAgIyAxMCUgeMOhYyBzdeG6pXQKICAgICAgICAgICAgICAgICAgICBsb25nX3dhdGNoX3RpbWUgPSByYW5kb20ucmFuZGludCg4LCAxNSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiROG7q25nIHhlbSB2aWRlbyBsw6J1IGjGoW46IHtsb25nX3dhdGNoX3RpbWV9cyIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKGxvbmdfd2F0Y2hfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMb2cgdGnhur9uIHRyw6xuaCBt4buXaSAzMCBnacOieQogICAgICAgICAgICAgICAgZWxhcHNlZCA9IHRpbWUudGltZSgpIC0gc3RhcnRfdGltZQogICAgICAgICAgICAgICAgaWYgZWxhcHNlZCA+IDAgYW5kIGludChlbGFwc2VkKSAlIDMwID09IDAgYW5kIHNjcm9sbF9jb3VudCA+IDA6CiAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nID0gZHVyYXRpb25fc2Vjb25kcyAtIGVsYXBzZWQKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBsxrDhu5t0IHtzY3JvbGxfY291bnR9IHZpZGVvLCBjw7JuIGzhuqFpIHtpbnQocmVtYWluaW5nKX1zIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggbMaw4bubdCDEkeG7gSB4deG6pXQ6IHtzY3JvbGxfY291bnR9IHZpZGVvIHRyb25nIHtkdXJhdGlvbl9zZWNvbmRzfXMiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzGsOG7m3QgZmVlZCDEkeG7gSB4deG6pXQiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9pbnRlcmFjdF93aXRoX2luYm94KHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVMawxqFuZyB0w6FjIHbhu5tpIEjhu5lwIHRoxrA6IGLhuqVtIHbDoG8sIGThu6tuZyAyLTVzLCB2deG7kXQgbMOqbgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSBuw7p0IEjhu5lwIHRoxrAKICAgICAgICAgICAgaW5ib3hfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iSOG7mXAgdGjGsCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaW5ib3hfYnV0dG9uOgogICAgICAgICAgICAgICAgIyBUaOG7rSB0w6xtIHRoZW8gdGV4dAogICAgICAgICAgICAgICAgaW5ib3hfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9Ikjhu5lwIHRoxrAiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGluYm94X2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IEjhu5lwIHRoxrAiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsaWNrIHbDoG8gSOG7mXAgdGjGsAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkGFuZyBjbGljayB2w6BvIEjhu5lwIHRoxrAiKQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoaW5ib3hfYnV0dG9uKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBE4burbmcgbOG6oWkgMi01IGdpw6J5CiAgICAgICAgICAgIHdhaXRfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDUpCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJE4burbmcgdHJvbmcgSOG7mXAgdGjGsCB7d2FpdF90aW1lfXMiKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2FpdF90aW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiB0cm9uZyBI4buZcCB0aMawCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlZ14buRdCBsw6puIHRyb25nIEjhu5lwIHRoxrAiKQogICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSB0aGFvIHTDoWMgdnXhu5F0IGzDqm4gdGjDqm0gMS0yIGzhuqduIG7hu69hCiAgICAgICAgICAgIGFkZGl0aW9uYWxfc3dpcGVzID0gcmFuZG9tLnJhbmRpbnQoMSwgMikKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2UoYWRkaXRpb25hbF9zd2lwZXMpOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDAuNSwgMS41KSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkhvw6BuIHRow6BuaCB0xrDGoW5nIHTDoWMgduG7m2kgSOG7mXAgdGjGsCIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgdMawxqFuZyB0w6FjIHbhu5tpIEjhu5lwIHRoxrAiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgZ2V0X2F2YWlsYWJsZV9qb2JzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIGPDoWMgam9iIGto4bqjIGThu6VuZyB04burIEdvTGlrZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIGpvYiBob+G6t2MgbGlzdCBy4buXbmcgbuG6v3Uga2jDtG5nIGPDswogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmdvbGlrZV9zZXJ2aWNlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIGzhuqV5IGpvYjogR29MaWtlU2VydmljZSBjaMawYSDEkcaw4bujYyBjdW5nIGPhuqVwIikKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBH4buNaSBBUEkgbOG6pXkgam9iCiAgICAgICAgICAgIGpvYl91cmwgPSBzZWxmLmdldF9qb2JzX3VybCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHRoYW0gc+G7kQogICAgICAgICAgICBwYXJhbXMgPSBzZWxmLmdldF9qb2JfcGFyYW1zKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu41pIEFQSQogICAgICAgICAgICByZXNwb25zZSA9IHNlbGYuYXBpX3JlcXVlc3Qoam9iX3VybCwgIkdFVCIsIHBhcmFtcykKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3BvbnNlIGFuZCByZXNwb25zZS5nZXQoInN1Y2Nlc3MiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBqb2JfZGF0YSA9IHJlc3BvbnNlLmdldCgiZGF0YSIsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBqb2JfZGF0YToKICAgICAgICAgICAgICAgICAgICAjIENodeG6qW4gaMOzYSBk4buvIGxp4buHdSBqb2IKICAgICAgICAgICAgICAgICAgICBqb2IgPSBzZWxmLm1hcF9qb2JfZGF0YShqb2JfZGF0YSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSBqb2Ige2pvYlsnaWQnXX0gbG/huqFpIHtqb2JbJ3R5cGUnXX0gY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudFsndW5pcXVlX3VzZXJuYW1lJ119IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gW2pvYl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gW10KICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzhuqV5IGRhbmggc8OhY2ggam9iIikKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAKICAgIGRlZiBleGVjdXRlX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBqb2I6IFRow7RuZyB0aW4gam9iCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyB0aOG7sWMgaGnhu4duIGpvYiwgYmFvIGfhu5NtOgogICAgICAgICAgICAgICAgLSBzdGF0dXMgKGludCk6IE3DoyB0cuG6oW5nIHRow6FpIGpvYgogICAgICAgICAgICAgICAgICAgIDA6IENoxrBhIHRo4buxYyBoaeG7h24KICAgICAgICAgICAgICAgICAgICAxOiBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICAyOiBUaOG6pXQgYuG6oWksIGtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcKICAgICAgICAgICAgICAgICAgICAzOiBUaOG6pXQgYuG6oWksIMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgICAgICAgICA0OiBUaOG6pXQgYuG6oWksIHnDqnUgY+G6p3UgxJFhbmcgY2jhu50KICAgICAgICAgICAgICAgIC0gbWVzc2FnZSAoc3RyKTogVGjDtG5nIGLDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgICAgIC0gc3VjY2VzcyAoYm9vbCk6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGpvYl90eXBlID0gam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgIGpvYl9saW5rID0gam9iLmdldCgibGluayIsICIiKQogICAgICAgICAgICBqb2JfaWQgPSBqb2IuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJBhbmcgdGjhu7FjIGhp4buHbiBqb2Ige2pvYl9pZH0gbG/huqFpIHtqb2JfdHlwZX0gduG7m2kgbGluayB7am9iX2xpbmt9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBsb+G6oWkgam9iIMSRxrDhu6NjIGjhu5cgdHLhu6MKICAgICAgICAgICAgaWYgam9iX3R5cGUgbm90IGluIFsiZm9sbG93IiwgImxpa2UiXToKICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBmIkxv4bqhaSBqb2Ige2pvYl90eXBlfSBraMO0bmcgxJHGsOG7o2MgaOG7lyB0cuG7oyIKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcobWVzc2FnZSkKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6IDIsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiBtZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBqb2IgdGhlbyBsb+G6oWkKICAgICAgICAgICAgam9iX3N0YXR1cyA9IDAgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgbMOgbQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgam9iX3R5cGUgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICBqb2Jfc3RhdHVzID0gc2VsZi5fcGVyZm9ybV9mb2xsb3dfam9iKGpvYl9saW5rKQogICAgICAgICAgICBlbGlmIGpvYl90eXBlID09ICJsaWtlIjoKICAgICAgICAgICAgICAgIGpvYl9zdGF0dXMgPSBzZWxmLl9wZXJmb3JtX2xpa2Vfam9iKGpvYl9saW5rKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBW4buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKCiAgICAgICAgICAgICMgVOG6oW8ga+G6v3QgcXXhuqMgdHLhuqMgduG7gSBk4buxYSB0csOqbiBqb2Jfc3RhdHVzCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdF9mcm9tX3N0YXR1cyhqb2Jfc3RhdHVzLCBqb2JfdHlwZSkKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbWVzc2FnZSA9IGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gam9iOiB7c3RyKGUpfSIKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgyLCBtZXNzYWdlLCBGYWxzZSkKICAgIAogICAgZGVmIF9jcmVhdGVfam9iX3Jlc3VsdF9mcm9tX3N0YXR1cyhzZWxmLCBqb2Jfc3RhdHVzOiBpbnQsIGpvYl90eXBlOiBzdHIpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFThuqFvIGvhur90IHF14bqjIGpvYiB04burIHN0YXR1cyBjb2RlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgam9iX3N0YXR1czogTcOjIHRy4bqhbmcgdGjDoWkgam9iIHThu6sgX3BlcmZvcm1feHh4X2pvYgogICAgICAgICAgICBqb2JfdHlwZTogTG/huqFpIGpvYiAoZm9sbG93LCBsaWtlKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgam9iCiAgICAgICAgIiIiCiAgICAgICAgaWYgam9iX3N0YXR1cyA9PSAxOiAgIyBUaMOgbmggY8O0bmcKICAgICAgICAgICAgbWVzc2FnZSA9IGYixJDDoyBob8OgbiB0aMOgbmggam9iIHtqb2JfdHlwZX0gdGjDoG5oIGPDtG5nIgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgxLCBtZXNzYWdlLCBUcnVlKQogICAgICAgIGVsaWYgam9iX3N0YXR1cyA9PSAyOiAgIyBLaMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIktow7RuZyB0aOG7gyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcgxJHhu4MgdGjhu7FjIGhp4buHbiBqb2Ige2pvYl90eXBlfSIKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhtZXNzYWdlKQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoMiwgbWVzc2FnZSwgRmFsc2UpCiAgICAgICAgZWxpZiBqb2Jfc3RhdHVzID09IDM6ICAjIELhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIsSQ4buRaSB0xrDhu6NuZyDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlIgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHVuZm9sbG93IMSR4buDIEpvYlNlcnZpY2UgeOG7rSBsw70KICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDMsIG1lc3NhZ2UsIEZhbHNlLCB1bmZvbGxvdz1UcnVlKQogICAgICAgIGVsaWYgam9iX3N0YXR1cyA9PSA0OiAgIyBZw6p1IGPhuqd1IMSRYW5nIGNo4budCiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIlnDqnUgY+G6p3UgxJFhbmcgY2jhu50gdHJvbmcgam9iIHtqb2JfdHlwZX0iCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcobWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDQsIG1lc3NhZ2UsIEZhbHNlKQogICAgICAgIGVsc2U6ICAjIFRo4bqldCBi4bqhaSBob+G6t2MgdHLhuqFuZyB0aMOhaSBraMOhYwogICAgICAgICAgICBtZXNzYWdlID0gZiJUaOG7sWMgaGnhu4duIGpvYiB7am9iX3R5cGV9IHRo4bqldCBi4bqhaSB24bubaSB0cuG6oW5nIHRow6FpIHtqb2Jfc3RhdHVzfSIKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IobWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KGpvYl9zdGF0dXMgaWYgam9iX3N0YXR1cyA+IDAgZWxzZSAwLCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfc3RhdHVzX2RpYWxvZyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgZGlhbG9nICJUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIgdsOgIHjhu60gbMO9IG7hur91IGPDswogICAgICAgIFNhdSBraGkgYuG6pW0gT0ssIGtp4buDbSB0cmEgeGVtIGPDsyB24buBIHRyYW5nIGNo4bunIGtow7RuZyB2w6Agc3luYyBhY2NvdW50cwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIGRpYWxvZyB2w6AgY+G6p24gbmfhu6tuZyBob+G6oXQgxJHhu5luZyB0w6BpIGtob+G6o24sIEZhbHNlIG7hur91IGtow7RuZyBjw7MgZGlhbG9nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIENo4budIG3hu5l0IGNow7p0IMSR4buDIGRpYWxvZyBjw7MgdGjhu4MgeHXhuqV0IGhp4buHbgogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBkaWFsb2cgY8OzIHRleHQgIlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIgogICAgICAgICAgICBzdGF0dXNfZGlhbG9nID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN0YXR1c19kaWFsb2c6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJQaMOhdCBoaeG7h24gZGlhbG9nICdUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiciKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gZWxlbWVudCBjw7MgcmVzb3VyY2UtaWQ9ImFuZHJvaWQ6aWQvbWVzc2FnZSIKICAgICAgICAgICAgICAgIG1lc3NhZ2VfZWxlbWVudCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChyZXNvdXJjZV9pZD0iYW5kcm9pZDppZC9tZXNzYWdlIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbWVzc2FnZV9lbGVtZW50OgogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2VfdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQobWVzc2FnZV9lbGVtZW50KQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiVGjDtG5nIGLDoW8gdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o246IHttZXNzYWdlX3RleHR9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzGsHUgdGjDtG5nIGLDoW8gdsOgbyBkYXRhYmFzZSBob+G6t2MgbG9nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJDUklUSUNBTDogVMOgaSBraG/huqNuIGLhu4sgaOG6oW4gY2jhur8gLSB7bWVzc2FnZV90ZXh0fSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIHbDoCBjbGljayBuw7p0IE9LL8SQw7NuZyDEkeG7gyDEkcOzbmcgZGlhbG9nCiAgICAgICAgICAgICAgICAgICAgb2tfY2xpY2tlZCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgb2tfYnV0dG9ucyA9IFsiT0siLCAixJDDs25nIiwgIlTDtGkgaGnhu4N1IiwgIsSQ4buTbmcgw70iXQogICAgICAgICAgICAgICAgICAgIGZvciBidG5fdGV4dCBpbiBva19idXR0b25zOgogICAgICAgICAgICAgICAgICAgICAgICBva19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD1idG5fdGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgb2tfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKG9rX2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGLhuqVtIG7DunQgJ3tidG5fdGV4dH0nIMSR4buDIMSRw7NuZyBkaWFsb2ciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2tfY2xpY2tlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgb2tfY2xpY2tlZDoKICAgICAgICAgICAgICAgICAgICAgICAgIyBDaOG7nSA1IGdpw6J5IHbDoCBraeG7g20gdHJhIHRyYW5nIGNo4bunIHRyb25nIDUgbOG6p24KICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQ2jhu50gNXMgdsOgIGtp4buDbSB0cmEgdHJhbmcgY2jhu6cgdHJvbmcgNSBs4bqnbi4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg1KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaG9tZV9zY3JlZW5fZGV0ZWN0ZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZSg1KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJLaeG7g20gdHJhIHRyYW5nIGNo4bunIGzhuqduIHthdHRlbXB0ICsgMX0vNSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIMSRw6MgduG7gSB0cmFuZyBjaOG7pyAtIGPDsyBraOG6oyBuxINuZyB0w6BpIGtob+G6o24gYuG7iyBsb2dvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvbWVfc2NyZWVuX2RldGVjdGVkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhvbWVfc2NyZWVuX2RldGVjdGVkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHN5bmMgYWNjb3VudHMgxJHhu4Mga2nhu4NtIHRyYSBhY2NvdW50IGPDsyBjw7JuIHRyb25nIGRhbmggc8OhY2gga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUaOG7sWMgaGnhu4duIHN5bmMgYWNjb3VudHMgxJHhu4Mga2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbi4uLiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X2RldmljZV9hY2NvdW50cyA9IHNlbGYuZ2V0X2FjY291bnRzX2Zyb21fZGV2aWNlKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lcyA9IHthY2MuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIikubG93ZXIoKSBmb3IgYWNjIGluIGN1cnJlbnRfZGV2aWNlX2FjY291bnRzfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gVGlrVG9rIHThu6sgREIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYl9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1zZWxmLmFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjw6FjIHTDoGkga2hv4bqjbiB0cm9uZyBEQiBjw7MgY8OybiB04buTbiB04bqhaSB0csOqbiB0aGnhur90IGLhu4sga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGRiX2FjY291bnQgaW4gZGJfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRiX3VzZXJuYW1lID0gZGJfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRiX3VzZXJuYW1lIGFuZCBkYl91c2VybmFtZSBub3QgaW4gY3VycmVudF91c2VybmFtZXM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBraMO0bmcgY8OybiB04buTbiB04bqhaSB0csOqbiB0aGnhur90IGLhu4sgLSDEkcOhbmggZOG6pXUgbmfhu6tuZyBob+G6oXQgxJHhu5luZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7ZGJfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgY8OybiB0cm9uZyBkYW5oIHPDoWNoIHRoaeG6v3QgYuG7iyAtIMSRw6FuaCBk4bqldSBuZ+G7q25nIGhv4bqhdCDEkeG7mW5nIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJpbmFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImpvYl9lbmFibGUiOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAicmVhc29uIjogIlTDoGkga2hv4bqjbiBi4buLIGxvZyBvdXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChkYl9hY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24ge2RiX2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gbmfhu6tuZyBob+G6oXQgxJHhu5luZyB24bubaSBsw70gZG86IFTDoGkga2hv4bqjbiBi4buLIGxvZyBvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgU3luYyBs4bqhaSBhY2NvdW50cyBt4bubaQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIHN5bmNfZXJyb3I6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKHN5bmNfZXJyb3IsICJM4buXaSBraGkgc3luYyBhY2NvdW50cyBzYXUga2hpIHBow6F0IGhp4buHbiBkaWFsb2cgdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIlTDrG0gdGjhuqV5IGRpYWxvZyAnVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24nIG5oxrBuZyBraMO0bmcgdMOsbSB0aOG6pXkgbWVzc2FnZSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgZGlhbG9nIHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9wZXJmb3JtX2ZvbGxvd19qb2Ioc2VsZiwgcHJvZmlsZV9saW5rOiBzdHIpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGpvYiBmb2xsb3cgdHLDqm4gVGlrVG9rCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcHJvZmlsZV9saW5rOiBMaW5rIMSR4bq/biB0cmFuZyBjw6EgbmjDom4gY+G6p24gZm9sbG93IChk4bqhbmc6IGh0dHBzOi8vd3d3LnRpa3Rvay5jb20vQHVzZXJuYW1lKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRy4bqhbmcgdGjDoWkgam9iICgwOiBjaMawYSBsw6BtLCAxOiBob8OgbiB0aMOgbmgsIDI6IGzhu5dpLCAzOiBi4buLIHVuZm9sbG93LCA0OiB5w6p1IGPhuqd1IGNo4budLCA1OiBn4butaSB5w6p1IGPhuqd1KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gxJFhbmcg4bufIHRyYW5nIGNo4bunCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRyw61jaCB4deG6pXQgdXNlcm5hbWUgdOG7qyBVUkwgVGlrVG9rIMSR4buDIHPhu60gZOG7pW5nIGNobyBsb2dnaW5nCiAgICAgICAgICAgIHVzZXJuYW1lX21hdGNoID0gcmUuc2VhcmNoKHIndGlrdG9rXC5jb20vQChbXi8/XSspJywgcHJvZmlsZV9saW5rKQogICAgICAgICAgICBpZiBub3QgdXNlcm5hbWVfbWF0Y2g6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyB0csOtY2ggeHXhuqV0IHVzZXJuYW1lIHThu6sgbGluazoge3Byb2ZpbGVfbGlua30iKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICB1c2VybmFtZSA9IHVzZXJuYW1lX21hdGNoLmdyb3VwKDEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE3hu58gdHJhbmcgY8OhIG5ow6JuCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9vcGVuX3Byb2ZpbGVfcGFnZShwcm9maWxlX2xpbmspOgogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu50gdGjDqm0gY2hvIHRyYW5nIGjhu5Mgc8ahIHThuqNpIHhvbmcKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCBGb2xsb3cgdGhlbyBjw6FjIGPDoWNoIGtow6FjIG5oYXUKICAgICAgICAgICAgZm9sbG93X2J1dHRvbiA9IE5vbmUKICAgICAgICAgICAgIyBM4bqleSBYTUwgbeG7mXQgbOG6p24gxJHhu4Mgc28gc8OhbmgKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCgogICAgICAgICAgICAjIEPDoWNoIDE6IFTDrG0gdGhlbyB0ZXh0IHRp4bq/bmcgVmnhu4d0IHbDoCB0aeG6v25nIEFuaAogICAgICAgICAgICBmb2xsb3dfdGV4dHMgPSBbIlRoZW8gZMO1aSIsICJGb2xsb3ciLCAixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyIsICLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIiwiR+G7rWkg8J+RiyJdCiAgICAgICAgICAgIGZvciB0ZXh0IGluIGZvbGxvd190ZXh0czoKICAgICAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHRleHQ9dGV4dCkKICAgICAgICAgICAgICAgIGlmIGZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICMgQ8OhY2ggMjogVMOsbSB0aGVvIGNvbnRlbnQtZGVzYyBu4bq/dSBjaMawYSB0w6xtIHRo4bqleQogICAgICAgICAgICBpZiBub3QgZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgIGZvbGxvd19kZXNjcyA9IFsiVGhlbyBkw7VpIiwgIkZvbGxvdyIsICLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIl0KICAgICAgICAgICAgICAgIGZvciBkZXNjIGluIGZvbGxvd19kZXNjczoKICAgICAgICAgICAgICAgICAgICBmb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9ZGVzYykKICAgICAgICAgICAgICAgICAgICBpZiBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSBs4bqhaSBs4bqnbiBu4buvYSBu4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBmb2xsb3cKICAgICAgICAgICAgaWYgbm90IGZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCB0aGVvIGTDtWkg4bufIGzhuqduIMSR4bqndSwgdGjhu60gdnXhu5F0IG3DoG4gaMOsbmggdsOgIHTDrG0gbOG6oWkiKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEuNSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICAjIFRo4butIGzhuqFpIHThuqV0IGPhuqMgY8OhYyBjw6FjaAogICAgICAgICAgICAgICAgZm9yIHRleHQgaW4gZm9sbG93X3RleHRzOgogICAgICAgICAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHRleHQ9dGV4dCkKICAgICAgICAgICAgICAgICAgICBpZiBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgdGhlbyBkw7VpIHNhdSBuaGnhu4F1IGzhuqduIHRo4butIikKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRleHQgY+G7p2EgbsO6dAogICAgICAgICAgICBidXR0b25fdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQoZm9sbG93X2J1dHRvbikKICAgICAgICAgICAgYnV0dG9uX3Jlc291cmNlX2lkID0gZm9sbG93X2J1dHRvbi5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUZXh0IGPhu6dhIG7DunQgZm9sbG93OiAne2J1dHRvbl90ZXh0fScsIHJlc291cmNlLWlkOiAne2J1dHRvbl9yZXNvdXJjZV9pZH0nIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGhp4buHbiB04bqhaQogICAgICAgICAgICBpZiBidXR0b25fdGV4dCBpbiBbIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciLCJH4butaSDwn5GLIl06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0aGVvIGTDtWkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdOG7qyB0csaw4bubYyIpCiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIl06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB5w6p1IGPhuqd1IHRoZW8gZMO1aSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB04burIHRyxrDhu5tjIikKICAgICAgICAgICAgICAgIHJldHVybiA1CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGzDoCAiVGhlbyBkw7VpIiBob+G6t2MgIkZvbGxvdyIgdGjDrCBjbGljayB2w6BvIG7DunQKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyJUaGVvIGTDtWkiLCAiRm9sbG93Il06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUaOG7sWMgaGnhu4duIGNsaWNrIHbDoG8gbsO6dCB0aGVvIGTDtWkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoZm9sbG93X2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg0KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgZGlhbG9nICJUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2NoZWNrX2FjY291bnRfc3RhdHVzX2RpYWxvZygpOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJUw6BpIGtob+G6o24gYuG7iyBo4bqhbiBjaOG6vywgbmfhu6tuZyBob+G6oXQgxJHhu5luZyB2w6AgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbmfhu6tuZyBob+G6oXQgxJHhu5luZwogICAgICAgICAgICAgICAgICAgICMgVHLhuqMgduG7gSBzdGF0dXMgMiDEkeG7gyBiw6FvIGzhu5dpIHbDoCBo4buneSBqb2IKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFZ14buRdCB4deG7kW5nIDEgbOG6p24gxJHhu4MgcmVmcmVzaCB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgZGlhbG9nIGhp4buHbiBsw6puIGtow7RuZwogICAgICAgICAgICAgICAgIyBzY3JlZW5feG1sID0gc2VsZi5kdW1wX3NjcmVlbl93aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICMgaWYgc2NyZWVuX3htbDoKICAgICAgICAgICAgICAgICMgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgY+G6o25oIGLDoW8gaG/hurdjIGdp4bubaSBo4bqhbgogICAgICAgICAgICAgICAgIyAgICAgZGlhbG9ncyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbChzY3JlZW5feG1sLCBjbGFzc19uYW1lPSJhbmRyb2lkLmFwcC5EaWFsb2ciKQogICAgICAgICAgICAgICAgIyAgICAgZm9yIGRpYWxvZyBpbiBkaWFsb2dzOgogICAgICAgICAgICAgICAgIyAgICAgICAgIGRpYWxvZ190ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChkaWFsb2cpCiAgICAgICAgICAgICAgICAjICAgICAgICAgaWYgYW55KGtleXdvcmQgaW4gZGlhbG9nX3RleHQubG93ZXIoKSBmb3Iga2V5d29yZCBpbiBbInRo4butIGzhuqFpIHNhdSIsICJnaeG7m2kgaOG6oW4iLCAibGltaXQiLCAidHJ5IGFnYWluIl0pOgogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICAjIFTDrG0gdsOgIG5o4bqlbiBuw7p0IE9LL8SQw7NuZwogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBva19idXR0b25zID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKHNjcmVlbl94bWwsIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIpCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIGZvciBidG4gaW4gb2tfYnV0dG9uczoKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgICAgIGJ0bl90ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChidG4pCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICBpZiBidG5fdGV4dCBhbmQgYnRuX3RleHQubG93ZXIoKSBpbiBbIm9rIiwgIsSRw7NuZyIsICJ0w7RpIGhp4buDdSIsICLEkeG7k25nIMO9Il06CiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGJ0bikKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJKb2Iga2jDtG5nIGhvw6BuIHRow6BuaCwgYuG7iyBnaeG7m2kgaOG6oW4gdGhlbyBkw7VpIikKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgcmV0dXJuIDMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHRleHQgc2F1IGtoaSBuaOG6pW4gdGhlbyBkw7VpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIGzhuqFpIG7DunQgZm9sbG93IMSR4buDIGtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSAtIMawdSB0acOqbiB0aGVvIHJlc291cmNlLWlkIG7hur91IGPDswogICAgICAgICAgICAgICAgdXBkYXRlZF9mb2xsb3dfYnV0dG9uID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGPDsyByZXNvdXJjZV9pZCwgdMOsbSB0aGVvIHJlc291cmNlX2lkIHRyxrDhu5tjCiAgICAgICAgICAgICAgICBpZiBidXR0b25fcmVzb3VyY2VfaWQ6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9mb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHJlc291cmNlX2lkPWJ1dHRvbl9yZXNvdXJjZV9pZCkKICAgICAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHTDrG0gbOG6oWkgbsO6dCBmb2xsb3cgdGhlbyByZXNvdXJjZS1pZDoge2J1dHRvbl9yZXNvdXJjZV9pZH0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSB0aGVvIHJlc291cmNlX2lkIGhv4bq3YyBraMO0bmcgY8OzIHJlc291cmNlX2lkLCB0w6xtIHRoZW8gdGV4dAogICAgICAgICAgICAgICAgaWYgbm90IHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBmb2xsb3dfdGV4dHMgPSBbIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciLCAixJDDoyB5w6p1IGPhuqd1IiwgIlJlcXVlc3RlZCIsICJUaGVvIGTDtWkiLCAiRm9sbG93Il0KICAgICAgICAgICAgICAgICAgICBmb3IgdGV4dCBpbiBmb2xsb3dfdGV4dHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRmFsbGJhY2s6IHTDrG0gdGhlbyBjb250ZW50LWRlc2MKICAgICAgICAgICAgICAgIGlmIG5vdCB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgZm9sbG93X2Rlc2NzID0gWyJUaGVvIGTDtWkiLCAiRm9sbG93IiwgIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciXQogICAgICAgICAgICAgICAgICAgIGZvciBkZXNjIGluIGZvbGxvd19kZXNjczoKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9mb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz1kZXNjKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX2ZvbGxvd19idXR0b246CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF90ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dCh1cGRhdGVkX2ZvbGxvd19idXR0b24pCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9yZXNvdXJjZV9pZCA9IHVwZGF0ZWRfZm9sbG93X2J1dHRvbi5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlNhdSBraGkgY2xpY2sgZm9sbG93OiB0ZXh0PSd7dXBkYXRlZF90ZXh0fScsIHJlc291cmNlLWlkPSd7dXBkYXRlZF9yZXNvdXJjZV9pZH0nIikKICAgICAgICAgICAgICAgICAgICAjIFRyaW0gd2hpdGVzcGFjZSB04burIHVwZGF0ZWRfdGV4dAogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfdGV4dCA9IHVwZGF0ZWRfdGV4dC5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDoWMgdHLGsOG7nW5nIGjhu6NwIGtow6FjIG5oYXUKICAgICAgICAgICAgICAgICAgICBpZiB1cGRhdGVkX3RleHQgaW4gWyLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIiwgIk5o4bqvbiB0aW4iLCAiTWVzc2FnZSIsIkfhu61pIPCfkYsiXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiRm9sbG93IHRow6BuaCBjw7RuZyEiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAgICAgICAgIGVsaWYgdXBkYXRlZF90ZXh0IGluIFsixJDDoyB5w6p1IGPhuqd1IiwgIlJlcXVlc3RlZCJdOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIGfhu61pIHnDqnUgY+G6p3UgdGhlbyBkw7VpIHRow6BuaCBjw7RuZyEiKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gNQogICAgICAgICAgICAgICAgICAgIGVsaWYgdXBkYXRlZF90ZXh0IGluIFsiVGhlbyBkw7VpIiwgIkZvbGxvdyJdOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkZvbGxvdyBraMO0bmcgdGjDoG5oIGPDtG5nLCB0ZXh0IGPhu6dhIG7DunQgduG6q24gbMOgOiB7dXBkYXRlZF90ZXh0fSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAzCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJGb2xsb3cga2jDtG5nIHRow6BuaCBjw7RuZywgdGV4dCBj4bunYSBuw7p0IGzDoDoge3VwZGF0ZWRfdGV4dH0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMwogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEtow7RuZyB0w6xtIHRo4bqleSBuw7p0LCBjw7MgdGjhu4MgxJHDoyBmb2xsb3cgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgZm9sbG93IHNhdSBraGkgbmjhuqVuLCBnaeG6oyDEkeG7i25oIMSRw6MgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJUZXh0IGPhu6dhIG7DunQga2jDtG5nIGto4bubcCB24bubaSAnVGhlbyBkw7VpJyBob+G6t2MgJ0ZvbGxvdyc6IHtidXR0b25fdGV4dH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gam9iIGZvbGxvdzoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gMgogICAgCiAgICBkZWYgX29wZW5fcHJvZmlsZV9wYWdlKHNlbGYsIHByb2ZpbGVfbGluazogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE3hu58gdHJhbmcgcHJvZmlsZSBUaWtUb2sgYuG6sW5nIHTDrG0ga2nhur9tIGhv4bq3YyBsaW5rIHRy4buxYyB0aeG6v3AKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcm9maWxlX2xpbms6IExpbmsgxJHhur9uIHRyYW5nIGPDoSBuaMOibgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRyw61jaCB4deG6pXQgdXNlcm5hbWUgdOG7qyBVUkwgVGlrVG9rCiAgICAgICAgICAgIHVzZXJuYW1lX21hdGNoID0gcmUuc2VhcmNoKHIndGlrdG9rXC5jb20vQChbXi8/XSspJywgcHJvZmlsZV9saW5rKQogICAgICAgICAgICBpZiBub3QgdXNlcm5hbWVfbWF0Y2g6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyB0csOtY2ggeHXhuqV0IHVzZXJuYW1lIHThu6sgbGluazoge3Byb2ZpbGVfbGlua30iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgdXNlcm5hbWUgPSB1c2VybmFtZV9tYXRjaC5ncm91cCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSYW5kb20gY2jhu41uIDEgdHJvbmcgMiBjw6FjaDogdMOsbSBraeG6v20gaG/hurdjIG3hu58gdHLhu7FjIHRp4bq/cCBsaW5rCiAgICAgICAgICAgIGlmIHJhbmRvbS5jaG9pY2UoW1RydWUsIEZhbHNlXSk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTeG7nyB0cmFuZyBjw6EgbmjDom4gYuG6sW5nIGPDoWNoIHTDrG0ga2nhur9tOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICMgVGjhu60gbeG7nyBi4bqxbmcgdMOsbSBraeG6v20KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9vcGVuX3Byb2ZpbGVfYnlfc2VhcmNoKHVzZXJuYW1lKToKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDrG0ga2nhur9tIHRo4bqldCBi4bqhaSwgZmFsbGJhY2sgc2FuZyBt4bufIGxpbmsKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIGtp4bq/bSB0aOG6pXQgYuG6oWksIG3hu58gYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocHJvZmlsZV9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDQpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEPDoWNoIDI6IE3hu58gdHLhu7FjIHRp4bq/cCBVUkwgdGjDtG5nIHF1YSBoZWxwZXIub3Blbl91cmwoKQogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk3hu58gdHJhbmcgY8OhIG5ow6JuIGLhurFuZyBsaW5rIHRy4buxYyB0aeG6v3A6IHtwcm9maWxlX2xpbmt9IikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fdXJsKHByb2ZpbGVfbGluayxzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENo4budIHRow6ptIGNobyB0cmFuZyBo4buTIHPGoSB04bqjaSB4b25nCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIHbDoG8gxJHDum5nIHByb2ZpbGUga2jDtG5nIGLhurFuZyBjw6FjaCB0w6xtIGJ1dHRvbiBjw7MgdGV4dCA9IEB1c2VybmFtZQogICAgICAgICAgICAjIFTDrG0gYnV0dG9uIGPDsyB0ZXh0IGNow61uaCB4w6FjIGLhurFuZyBAdXNlcm5hbWUgKFRpa1RvayBsdcO0biBjw7MgQCB0csaw4bubYyB1c2VybmFtZSkKICAgICAgICAgICAgYXRfdXNlcm5hbWVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIsIHRleHQ9ZiJAe3VzZXJuYW1lfSIpCiAgICAgICAgICAgIGlmIGF0X3VzZXJuYW1lX2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHjDoWMgbmjhuq1uIHbDoG8gxJHDum5nIHByb2ZpbGUgY+G7p2Ege3VzZXJuYW1lfSAodMOsbSB0aOG6pXkgYnV0dG9uIGPDsyB0ZXh0OiAnQHt1c2VybmFtZX0nKSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdMOsbSB0aOG6pXkgYnV0dG9uIGPDsyB0ZXh0ID0gJ0B7dXNlcm5hbWV9JyB0csOqbiBtw6BuIGjDrG5oLCBjw7MgdGjhu4Mga2jDtG5nIHbDoG8gxJHDum5nIHByb2ZpbGUiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIG3hu58gdHJhbmcgcHJvZmlsZToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9vcGVuX3Byb2ZpbGVfYnlfc2VhcmNoKHNlbGYsIHVzZXJuYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTeG7nyB0cmFuZyBwcm9maWxlIFRpa1RvayBi4bqxbmcgY8OhY2ggdMOsbSBraeG6v20gdXNlcm5hbWUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB1c2VybmFtZTogVXNlcm5hbWUgY+G7p2EgdMOgaSBraG/huqNuIGPhuqduIHTDrG0KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUw6xtIHRhYiB0w6xtIGtp4bq/bSAtIHRo4butIHBoxrDGoW5nIHBow6FwIHRy4buxYyB0aeG6v3AgdHLGsOG7m2MKICAgICAgICAgICAgc2VhcmNoX3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlTDrG0ga2nhur9tIikKICAgICAgICAgICAgaWYgc2VhcmNoX3RhYjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlTDrG0gdGjhuqV5IHRhYiB0w6xtIGtp4bq/bSB0cuG7sWMgdGnhur9wIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzZWFyY2hfdGFiKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSwgZMO5bmcgcGjGsMahbmcgcGjDoXAgYWx0ZXJuYXRpdmUKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSB0YWIgVMOsbSBraeG6v20gdHLhu7FjIHRp4bq/cCwgdGjhu60gcGjGsMahbmcgcGjDoXAgYWx0ZXJuYXRpdmUiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIER1bXAgWE1MIG3hu5l0IGzhuqduIMSR4buDIHjhu60gbMO9CiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgZHVtcCBYTUwgbcOgbiBow6xuaCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBjw6FjIHRleHQgdGhheSB0aOG6vyB0cm9uZyBYTUwKICAgICAgICAgICAgICAgIGFsdGVybmF0aXZlX3RleHRzID0gWyJC4bqhbiBiw6giLCAixJBhbmcgZm9sbG93IiwgIkTDoG5oIGNobyBi4bqhbiJdCiAgICAgICAgICAgICAgICBmb3VuZF9lbGVtZW50ID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgdGV4dCBpbiBhbHRlcm5hdGl2ZV90ZXh0czoKICAgICAgICAgICAgICAgICAgICBlbGVtZW50ID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9dGV4dCkKICAgICAgICAgICAgICAgICAgICBpZiBlbGVtZW50OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdGV4dCB0aGFtIGNoaeG6v3UgJ3t0ZXh0fScgdHJvbmcgWE1MIikKICAgICAgICAgICAgICAgICAgICAgICAgZm91bmRfZWxlbWVudCA9IGVsZW1lbnQKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgbm90IGZvdW5kX2VsZW1lbnQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSB0ZXh0IHRoYW0gY2hp4bq/dSBuw6BvIHRyb25nIFhNTCIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBlbGVtZW50IGNoYQogICAgICAgICAgICAgICAgcGFyZW50X2VsZW1lbnQgPSBzZWxmLmhlbHBlci5maW5kX3BhcmVudF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBmb3VuZF9lbGVtZW50KQogICAgICAgICAgICAgICAgaWYgbm90IHBhcmVudF9lbGVtZW50OgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgdMOsbSB0aOG6pXkgZWxlbWVudCBjaGEgdHJvbmcgWE1MIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgZ3JhbmRfZWxlbWVudCA9IHNlbGYuaGVscGVyLmZpbmRfcGFyZW50X2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIHBhcmVudF9lbGVtZW50KQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBncmFuZF9lbGVtZW50OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IGdyYW5kX2VsZW1lbnQgdHJvbmcgWE1MIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOtbmggdG/DoW4gdOG7jWEgxJHhu5kgdsOgIGNsaWNrCiAgICAgICAgICAgICAgICBib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHMoZ3JhbmRfZWxlbWVudCkKICAgICAgICAgICAgICAgIHgxLCB5MSwgeDIsIHkyID0gYm91bmRzCiAgICAgICAgICAgICAgICB4ID0geDIgKyA1MAogICAgICAgICAgICAgICAgeSA9ICh5MSArIHkyKSAvLyAyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw61uaCB0b8OhbiB04buNYSDEkeG7mSB0YWIgdMOsbSBraeG6v206IHg9e3h9LCB5PXt5fSAodOG7qyBib3VuZHMgY2hhOiB7Ym91bmRzfSkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELhuqVtIHbDoG8gdOG7jWEgxJHhu5kgxJHDoyB0w61uaAogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIHbDoG8gxJHGsOG7o2MgdHJhbmcgdMOsbSBraeG6v20ga2jDtG5nCiAgICAgICAgICAgIHNlYXJjaF9pbnB1dCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5FZGl0VGV4dCIpCiAgICAgICAgICAgIGlmIG5vdCBzZWFyY2hfaW5wdXQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHbDoG8gdHJhbmcgdMOsbSBraeG6v20gLSBraMO0bmcgdMOsbSB0aOG6pXkgw7Qgbmjhuq1wIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBOaOG6rXAgdXNlcm5hbWUgY+G6p24gdMOsbQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX2lucHV0KQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMS41KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBow6BtIGlucHV0X3RleHQgbeG7mXQgbOG6p24gZHV5IG5o4bqldAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJBhbmcgbmjhuq1wIHRleHQ6ICd7dXNlcm5hbWV9JyIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLmlucHV0X3RleHQoZiJ7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg2KQoKICAgICAgICAgICAgIyBUw6xtIG7DunQgVMOsbSBraeG6v20gdsOgIGNsaWNrCiAgICAgICAgICAgIHNlYXJjaF9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIiwgdGV4dD0iVMOsbSBraeG6v20iKQogICAgICAgICAgICBpZiBzZWFyY2hfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgbsO6dCAnVMOsbSBraeG6v20nLCDEkWFuZyBjbGljay4uLiIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgJ1TDrG0ga2nhur9tJyIpCiAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gc2VhcmNoIHbhu5tpIGVudGVyIGtleQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfZW50ZXIoKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpIAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHRhYiAiTmfGsOG7nWkgZMO5bmciIHbDoCBjbGljayB2w6BvIG7DsyAtIMSR4bujaSB04buRaSDEkWEgMTBzCiAgICAgICAgICAgIHVzZXJfdGFiID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PSJOZ8aw4budaSBkw7luZyIsIHRpbWVvdXQ9MTApCiAgICAgICAgICAgIGlmIG5vdCB1c2VyX3RhYjoKICAgICAgICAgICAgICAgIHVzZXJfdGFiID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudChjb250ZW50X2Rlc2M9Ik5nxrDhu51pIGTDuW5nIiwgdGltZW91dD02KQoKICAgICAgICAgICAgaWYgdXNlcl90YWI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSB0YWIgTmfGsOG7nWkgZMO5bmcsIMSRYW5nIGNsaWNrIHbDoG8uLi4iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHVzZXJfdGFiKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgdGFiIE5nxrDhu51pIGTDuW5nIHNhdSAxMHMiKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBUZXh0VmlldyBjw7MgdGV4dCBjaMOtbmggeMOhYyBi4bqxbmcgdXNlcm5hbWUgKGtow7RuZyBjw7MgQCkgLSDEkeG7o2kgdOG7kWkgxJFhIDZzCiAgICAgICAgICAgIHVzZXJuYW1lX2VsZW1lbnQgPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9dXNlcm5hbWUsIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LlRleHRWaWV3IiwgdGltZW91dD02KQoKICAgICAgICAgICAgaWYgdXNlcm5hbWVfZWxlbWVudDoKICAgICAgICAgICAgICAgICMgQ2xpY2sgdsOgbyBlbGVtZW50IMSR4bqndSB0acOqbiB0w6xtIMSRxrDhu6NjCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0sIMSRYW5nIGNsaWNrIHbDoG8uLi4iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHVzZXJuYW1lX2VsZW1lbnQpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB0cm9uZyBr4bq/dCBxdeG6oyB0w6xtIGtp4bq/bSBzYXUgMTBzIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdMOsbSBraeG6v20gdMOgaSBraG/huqNuOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX3BlcmZvcm1fbGlrZV9qb2Ioc2VsZiwgcG9zdF9saW5rOiBzdHIpIC0+IGludDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIGpvYiBsaWtlIHZpZGVvIHRyw6puIFRpa1RvawogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHBvc3RfbGluazogTGluayDEkeG6v24gdmlkZW8gY+G6p24gbGlrZQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBpbnQ6IFRy4bqhbmcgdGjDoWkgam9iICgwOiBjaMawYSBsw6BtLCAxOiBob8OgbiB0aMOgbmgsIDI6IGzhu5dpLCAzOiDEkcOjIGxpa2UgdHLGsOG7m2MgxJHDsykKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwoKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJN4bufIHZpZGVvIFRpa1RvayBi4bqxbmcgbGluayB0cuG7sWMgdGnhur9wOiB7cG9zdF9saW5rfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE3hu58gdHLhu7FjIHRp4bq/cCBVUkwgdGjDtG5nIHF1YSBoZWxwZXIub3Blbl91cmwoKQogICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX3VybChwb3N0X2xpbmssc2VsZi5hcHBfcGFja2FnZSkKCiAgICAgICAgICAgICMgUmFuZG9tIG5naOG7iSAzLTEwIGdpw6J5IG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjDtG5nIHRoxrDhu51uZwogICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIG5naOG7iSB7d2FpdF90aW1lfXMgbmjGsCBuZ8aw4budaSBkw7luZyB0aMO0bmcgdGjGsOG7nW5nLi4uIikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfdGltZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBuw7p0IGxpa2UgYuG6sW5nIGNvbnRlbnQtZGVzYyAiVGjDrWNoIHZpZGVvLiIKICAgICAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLl9maW5kX2xpa2VfYnV0dG9uKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBsaWtlX2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGxpa2UgdHLDqm4gbcOgbiBow6xuaCIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIG7DunQgbGlrZSBiYW4gxJHhuqd1CiAgICAgICAgICAgIGluaXRpYWxfY29udGVudF9kZXNjID0gbGlrZV9idXR0b24uZ2V0KCJjb250ZW50LWRlc2MiLCAiIikKICAgICAgICAgICAgaW5pdGlhbF9yZXNvdXJjZV9pZCA9IGxpa2VfYnV0dG9uLmdldCgicmVzb3VyY2UtaWQiLCAiIikKICAgICAgICAgICAgaW5pdGlhbF9zZWxlY3RlZCA9IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVHLhuqFuZyB0aMOhaSBuw7p0IGxpa2UgYmFuIMSR4bqndTogc2VsZWN0ZWQ9e2luaXRpYWxfc2VsZWN0ZWR9LCBjb250ZW50LWRlc2M9J3tpbml0aWFsX2NvbnRlbnRfZGVzY30nLCByZXNvdXJjZS1pZD0ne2luaXRpYWxfcmVzb3VyY2VfaWR9JyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgxJHDoyBsaWtlIHThu6sgdHLGsOG7m2MKICAgICAgICAgICAgaWYgaW5pdGlhbF9zZWxlY3RlZCBvciAiQuG7jyB0aMOtY2giIGluIGluaXRpYWxfY29udGVudF9kZXNjIG9yICJVbmxpa2UiIGluIGluaXRpYWxfY29udGVudF9kZXNjOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVmlkZW8gxJHDoyDEkcaw4bujYyBsaWtlIHThu6sgdHLGsOG7m2MiKQogICAgICAgICAgICAgICAgcmVzdWx0ID0gMyAgIyDEkMOjIGxpa2UgdHLGsOG7m2MgxJHDswogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGxpa2UgdmlkZW8KICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuX2F0dGVtcHRfbGlrZV92aWRlbyhsaWtlX2J1dHRvbikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2F1IGtoaSBsaWtlIHhvbmcsIHZ14buRdCByYW5kb20gMi01IHZpZGVvIHLhu5NpIHbhu4EgdHJhbmcgY2jhu6cKICAgICAgICAgICAgaWYgcmVzdWx0ID09IDE6ICAjIFRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgc2VsZi5fc2Nyb2xsX3ZpZGVvc19hbmRfcmV0dXJuX2hvbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHJlc3VsdAogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2IgbGlrZToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gMgoKICAgIGRlZiBfZmluZF9saWtlX2J1dHRvbihzZWxmKToKICAgICAgICAiIiJUw6xtIG7DunQgbGlrZSB0csOqbiB2aWRlbyBUaWtUb2siIiIKICAgICAgICAjIFRo4butIGPDoWMgY8OhY2ggdMOsbSBraMOhYyBuaGF1IGNobyBuw7p0IGxpa2UKICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRow61jaCIpCiAgICAgICAgaWYgbm90IGxpa2VfYnV0dG9uOgogICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9Ikxpa2UiKQogICAgICAgIGlmIG5vdCBsaWtlX2J1dHRvbjoKICAgICAgICAgICAgIyBUw6xtIHRoZW8gcmVzb3VyY2UtaWQgaG/hurdjIHhwYXRoCiAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHJlc291cmNlX2lkPSJjb20uc3MuYW5kcm9pZC51Z2MudHJpbGw6aWQvbGlrZV9idXR0b24iKQogICAgICAgIHJldHVybiBsaWtlX2J1dHRvbgoKICAgIGRlZiBfYXR0ZW1wdF9saWtlX3ZpZGVvKHNlbGYsIGxpa2VfYnV0dG9uKToKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIGxpa2UgdmlkZW8sIMawdSB0acOqbiBi4bqlbSByYW5kb20gdOG7jWEgxJHhu5ksIGZhbGxiYWNrIHNhbmcgYuG6pW0gbsO6dCBsaWtlIiIiCiAgICAgICAgIyBM4bqleSBrw61jaCB0aMaw4bubYyBtw6BuIGjDrG5oIMSR4buDIHTDrW5oIHThu41hIMSR4buZIHJhbmRvbQogICAgICAgIHdpZHRoLCBoZWlnaHQgPSBzZWxmLmhlbHBlci5nZXRfc2NyZWVuX3NpemUoKQogICAgICAgIAogICAgICAgICMgVGjhu60gYuG6pW0gcmFuZG9tIHThu41hIMSR4buZIHRyxrDhu5tjIChkb3VibGUgY2xpY2spCiAgICAgICAgeCA9IGludCh3aWR0aCAqIHJhbmRvbS51bmlmb3JtKDAuNSwgMC42KSkKICAgICAgICB5ID0gaW50KGhlaWdodCAqIHJhbmRvbS51bmlmb3JtKDAuNSwgMC42KSkKICAgICAgICAKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGjhu60gZG91YmxlIGNsaWNrIHThuqFpIHThu41hIMSR4buZICh7eH0sIHt5fSkgxJHhu4MgbGlrZSB2aWRlbyIpCiAgICAgICAgCiAgICAgICAgIyBUaOG7sWMgaGnhu4duIGRvdWJsZSBjbGljawogICAgICAgIHNlbGYuaGVscGVyLnRhcCh4LCB5KQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgwLjEpCiAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpICAjIENo4budIGFuaW1hdGlvbgogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBr4bq/dCBxdeG6oyBzYXUgZG91YmxlIGNsaWNrCiAgICAgICAgaWYgc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0ixJDDoyB0aMOtY2ggdmlkZW8iKToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBsaWtlIHZpZGVvIHRow6BuaCBjw7RuZyBi4bqxbmcgZG91YmxlIGNsaWNrIikKICAgICAgICAgICAgcmV0dXJuIDEKCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBkb3VibGUgY2xpY2sga2jDtG5nIHRow6BuaCBjw7RuZywgYuG6pW0gdHLhu7FjIHRp4bq/cCB2w6BvIG7DunQgbGlrZQogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkRvdWJsZSBjbGljayBjaMawYSBsaWtlIMSRxrDhu6NjLCBi4bqlbSB0cuG7sWMgdGnhur9wIHbDoG8gbsO6dCBsaWtlIikKICAgICAgICAKICAgICAgICAjIEzhuqV5IGzhuqFpIHRow7RuZyB0aW4gbsO6dCBsaWtlIG3hu5tpIG5o4bqldAogICAgICAgIGN1cnJlbnRfbGlrZV9idXR0b24gPSBzZWxmLl9maW5kX2xpa2VfYnV0dG9uKCkKICAgICAgICBpZiBub3QgY3VycmVudF9saWtlX2J1dHRvbjoKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgbGlrZSDEkeG7gyBi4bqlbSB0cuG7sWMgdGnhur9wIikKICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAKICAgICAgICAjIELhuqVtIHbDoG8gbsO6dCBsaWtlCiAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnQoY3VycmVudF9saWtlX2J1dHRvbikKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMgc2F1IGtoaSBi4bqlbSBuw7p0CiAgICAgICAgbGlrZV9idXR0b25fZmluYWwgPSBzZWxmLl9maW5kX2xpa2VfYnV0dG9uKCkKICAgICAgICBpZiBsaWtlX2J1dHRvbl9maW5hbDoKICAgICAgICAgICAgaXNfc2VsZWN0ZWRfZmluYWwgPSBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGxpa2VfYnV0dG9uX2ZpbmFsKQogICAgICAgICAgICBjb250ZW50X2Rlc2NfZmluYWwgPSBsaWtlX2J1dHRvbl9maW5hbC5nZXQoImNvbnRlbnQtZGVzYyIsICIiKQogICAgICAgICAgICByZXNvdXJjZV9pZF9maW5hbCA9IGxpa2VfYnV0dG9uX2ZpbmFsLmdldCgicmVzb3VyY2UtaWQiLCAiIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJTYXUga2hpIGLhuqVtIG7DunQgbGlrZTogc2VsZWN0ZWQ9e2lzX3NlbGVjdGVkX2ZpbmFsfSwgY29udGVudC1kZXNjPSd7Y29udGVudF9kZXNjX2ZpbmFsfScsIHJlc291cmNlLWlkPSd7cmVzb3VyY2VfaWRfZmluYWx9JyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBpc19zZWxlY3RlZF9maW5hbCBvciAiQuG7jyB0aMOtY2giIGluIGNvbnRlbnRfZGVzY19maW5hbCBvciAiVW5saWtlIiBpbiBjb250ZW50X2Rlc2NfZmluYWw6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIGxpa2UgdmlkZW8gdGjDoG5oIGPDtG5nIGLhurFuZyBjbGljayBuw7p0IikKICAgICAgICAgICAgICAgIHJldHVybiAxCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbGlrZSB2aWRlbyBzYXUga2hpIHRo4butIGPhuqMgMiBjw6FjaCIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgIGVsc2U6CiAgICAgICAgICAgICMgS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgxJHhu4Mga2nhu4NtIHRyYSwgZ2nhuqMgxJHhu4tuaCB0aMOgbmggY8O0bmcKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgbGlrZSDEkeG7gyBraeG7g20gdHJhLCBnaeG6oyDEkeG7i25oIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgIHJldHVybiAxCgogICAgZGVmIF9zY3JvbGxfdmlkZW9zX2FuZF9yZXR1cm5faG9tZShzZWxmKToKICAgICAgICAiIiJWdeG7kXQgcmFuZG9tIDItNSB2aWRlbyBy4buTaSB24buBIHRyYW5nIGNo4bunIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFJhbmRvbSBz4buRIGzGsOG7o25nIHZpZGVvIHPhur0gdnXhu5F0ICgyLTUpCiAgICAgICAgICAgIG51bV92aWRlb3MgPSByYW5kb20ucmFuZGludCgyLCA1KQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU+G6vSB2deG7kXQgcXVhIHtudW1fdmlkZW9zfSB2aWRlbyB0csaw4bubYyBraGkgduG7gSB0cmFuZyBjaOG7pyIpCiAgICAgICAgICAgIAogICAgICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gc2VsZi5oZWxwZXIuZ2V0X3NjcmVlbl9zaXplKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKG51bV92aWRlb3MpOgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVnXhu5F0IHZpZGVvIHRo4bupIHtpKzF9L3tudW1fdmlkZW9zfSIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIHJhbmRvbSAyLTQgZ2nDonkgbmjGsCBuZ8aw4budaSBkw7luZyB0aOG6rXQKICAgICAgICAgICAgICAgIHdhaXRfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDQpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2FpdF90aW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBW4buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkhvw6BuIHRow6BuaCB2deG7kXQgdmlkZW8sIMSRYW5nIHF1YXkgduG7gSB0cmFuZyBjaOG7pyIpCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSB2deG7kXQgdmlkZW86IHtzdHIoZSl9IikKICAgICAgICAgICAgIyBW4bqrbiBj4buRIGfhuq9uZyB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgCiAgICBkZWYgZ2V0X2pvYl9wYXJhbXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRoYW0gc+G7kSDEkeG7gyBn4buNaSBBUEkgbOG6pXkgam9iIGNobyBUaWtUb2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGhhbSBz4buRCiAgICAgICAgIiIiCiAgICAgICAgZ29saWtlX2lkID0gYWNjb3VudC5nZXQoImdvbGlrZV9pZCIpCiAgICAgICAgaWYgbm90IGdvbGlrZV9pZDoKICAgICAgICAgICAgcmV0dXJuIHt9CiAgICAgICAgICAgIAogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICJhY2NvdW50X2lkIjogZ29saWtlX2lkLAogICAgICAgICAgICAiZGF0YSI6ICJudWxsIgogICAgICAgIH0KICAgICAgICAKICAgIGRlZiBzeW5jX2FjY291bnRzX3RvX2RiKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sgdsOgbyBkYXRhYmFzZQogICAgICAgIEdoaSDEkcOoIHBoxrDGoW5nIHRo4bupYyBj4bunYSBs4bubcCBjaGEgxJHhu4MgxJHhuqNtIGLhuqNvIGNo4buJIGPDsyBt4buZdCB0w6BpIGtob+G6o24gxJHGsOG7o2MgxJHDoW5oIGThuqV1IGzDoCDEkWFuZyBsb2dpbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gVGlrVG9rIHRyb25nIERCCiAgICAgICAgICAgIHNlbGYuZGIucmVzZXRfbG9naW5fc3RhdHVzX2J5X2FwcChzZWxmLmFwcF9uYW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfYWNjb3VudHMgPSBzZWxmLmdldF9hY2NvdW50c19mcm9tX2RldmljZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZCB04burIGRhdGFiYXNlCiAgICAgICAgICAgIGFuZHJvaWRfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gaGnhu4duIGPDsyB0cm9uZyBEQiBjaG8gYXBwIG7DoHkKICAgICAgICAgICAgZXhpc3RpbmdfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9c2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gc2V0IGPDoWMgdW5pcXVlX3VzZXJuYW1lIHThu6sgdGhp4bq/dCBi4buLIMSR4buDIGThu4Ugc28gc8OhbmgKICAgICAgICAgICAgZGV2aWNlX3VzZXJuYW1lcyA9IHNldCgpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGRldmljZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfdXNlcm5hbWVzLmFkZCh1c2VybmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gdHJvbmcgREIgbcOgIGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iyAtPiDEkcOhbmggZOG6pXUgbG9nb3V0CiAgICAgICAgICAgIGZvciBleGlzdGluZ19hY2NvdW50IGluIGV4aXN0aW5nX2FjY291bnRzOgogICAgICAgICAgICAgICAgZXhpc3RpbmdfdXNlcm5hbWUgPSBleGlzdGluZ19hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX3VzZXJuYW1lIGFuZCBleGlzdGluZ191c2VybmFtZSBub3QgaW4gZGV2aWNlX3VzZXJuYW1lczoKICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBjw7MgdHJvbmcgREIgbmjGsG5nIGtow7RuZyBjw7MgdHLDqm4gdGhp4bq/dCBi4buLIC0+IGxvZ291dAogICAgICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQuZ2V0KCJzdGF0dXMiKSAhPSAibG9nb3V0IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7ZXhpc3RpbmdfdXNlcm5hbWV9IGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iywgxJHDoW5oIGThuqV1IGxvZ291dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoZXhpc3RpbmdfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJsb2dvdXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6ICJUw6BpIGtob+G6o24ga2jDtG5nIGPDsm4gdHLDqm4gdGhp4bq/dCBi4buLIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgaG/hurdjIHRow6ptIG3hu5tpIHbDoG8gREIKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gZGV2aWNlX2FjY291bnRzOgogICAgICAgICAgICAgICAgIyBUaMOqbSB0aMO0bmcgdGluIGFwcCB2w6AgZGV2aWNlX2lkCiAgICAgICAgICAgICAgICBhY2NvdW50WyJhcHAiXSA9IHNlbGYuYXBwX25hbWUKICAgICAgICAgICAgICAgIGFjY291bnRbImRldmljZV9pZCJdID0gYW5kcm9pZF9pZAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgbMOgIGNoxrBhIMSR4buTbmcgYuG7mSDEkeG7gyBn4butaSBsw6puIHNlcnZlcgogICAgICAgICAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHTDoGkga2hv4bqjbiDEkcOjIHThu5NuIHThuqFpIGNoxrBhIGThu7FhIHbDoG8gdW5pcXVlX3VzZXJuYW1lICsgYXBwCiAgICAgICAgICAgICAgICBleGlzdGluZ19hY2NvdW50ID0gc2VsZi5kYi5nZXRfYWNjb3VudF9ieV91bmlxdWVfdXNlcm5hbWUoc2VsZi5hcHBfbmFtZSwgYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50OgogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiBoaeG7h24gY8OzIC0gY2jhu4kgxJHhu5NuZyBi4buZIHRy4bqhbmcgdGjDoWkgbG9naW4vbG9nb3V0CiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGV4aXN0aW5nX2FjY291bnRbImlkIl0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIENodeG6qW4gYuG7iyBk4buvIGxp4buHdSBj4bqtcCBuaOG6rXQgdOG7kWkgdGhp4buDdQogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBhY2NvdW50LmdldCgiaXNfbG9naW4iLCBGYWxzZSksCiAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGFjY291bnQuZ2V0KCJsYXN0X3VwZGF0ZSIsIGludCh0aW1lLnRpbWUoKSkpLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSB0w6BpIGtob+G6o24gdHJvbmcgREIgxJFhbmcg4bufIHRy4bqhbmcgdGjDoWkgbG9nb3V0IG5oxrBuZyB4deG6pXQgaGnhu4duIGzhuqFpIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgICAgIGlmIGV4aXN0aW5nX2FjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAibG9nb3V0IjoKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB04burIGxvZ291dCB24buBIGFjdGl2ZSB2w6AgeMOzYSBpbmFjdGl2ZV9yZWFzb24KICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFbInN0YXR1cyJdID0gImFjdGl2ZSIKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFbImluYWN0aXZlX3JlYXNvbiJdID0gIiIKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSDEkcOjIHh14bqldCBoaeG7h24gbOG6oWkgdHLDqm4gdGhp4bq/dCBi4buLLCByZXNldCB04burIGxvZ291dCB24buBIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSDEkcOjIGFjdGl2ZSB0aMOsIGdp4buvIG5ndXnDqm4gc3RhdHVzLCBraMO0bmcgdGhheSDEkeG7lWkgZ8OsIGtow6FjCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gdHJvbmcge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBUaMOqbSB0w6BpIGtob+G6o24gbeG7m2kgduG7m2kgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBhY2NvdW50WyJzdGF0dXMiXSA9ICJhY3RpdmUiCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5hZGRfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIHRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBjaG8ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gZGV2aWNlX2FjY291bnRzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7c2VsZi5hcHBfbmFtZX0iKQogICAgICAgICAgICByZXR1cm4gW10KCiAgICBkZWYgbWFwX2dvbGlrZV9hY2NvdW50cyhzZWxmLCBnb2xpa2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dLCBkZXZpY2VfYWNjb3VudHM6IExpc3RbRGljdFtzdHIsIEFueV1dKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICDDgW5oIHjhuqEgdMOgaSBraG/huqNuIHThu6sgR29MaWtlIHbDoG8gdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyBHb0xpa2UgQVBJCiAgICAgICAgICAgIGRldmljZV9hY2NvdW50czogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMOhbmggeOG6oQogICAgICAgICIiIgogICAgICAgIG1hcHBlZF9hY2NvdW50cyA9IFtdCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIENodeG6qW4gaMOzYSBk4buvIGxp4buHdSB04burIEdvTGlrZQogICAgICAgICAgICBnb2xpa2VfZGF0YSA9IHt9CiAgICAgICAgICAgIGZvciBhY2MgaW4gZ29saWtlX2FjY291bnRzOgogICAgICAgICAgICAgICAgIyBUcsOtY2ggeHXhuqV0IHRow7RuZyB0aW4gdOG7qyB0w6BpIGtob+G6o24gR29MaWtlCiAgICAgICAgICAgICAgICBnb2xpa2VfYWNjb3VudCA9IHsKICAgICAgICAgICAgICAgICAgICAiZ29saWtlX2lkIjogYWNjLmdldCgiaWQiKSwKICAgICAgICAgICAgICAgICAgICAibmlja25hbWUiOiBhY2MuZ2V0KCJuaWNrbmFtZSIpLAogICAgICAgICAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBhY2MuZ2V0KCJ1bmlxdWVfaWQiKSwKICAgICAgICAgICAgICAgICAgICAidW5pcXVlX3VzZXJuYW1lIjogYWNjLmdldCgidW5pcXVlX3VzZXJuYW1lIiksCiAgICAgICAgICAgICAgICAgICAgImF2YXRhcl90aHVtYiI6IGFjYy5nZXQoImF2YXRhcl90aHVtYiIpCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgU+G7rSBk4bulbmcgdW5pcXVlX3VzZXJuYW1lIGzDoG0ga2jDs2EgxJHhu4MgZOG7hSDDoW5oIHjhuqEKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gZ29saWtlX2FjY291bnRbInVuaXF1ZV91c2VybmFtZSJdCiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICBnb2xpa2VfZGF0YVt1c2VybmFtZS5sb3dlcigpXSA9IGdvbGlrZV9hY2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIMOBbmggeOG6oSB24bubaSB0w6BpIGtob+G6o24gdHLDqm4gdGhp4bq/dCBi4buLCiAgICAgICAgICAgIGZvciBkZXZpY2VfYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGRldmljZV9hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWUgaW4gZ29saWtlX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgIyDEkMOjIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoIEdvTGlrZQogICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdOG7qyBHb0xpa2UgdsOgbyB0w6BpIGtob+G6o24gdGhp4bq/dCBi4buLCiAgICAgICAgICAgICAgICAgICAgZ29saWtlX2luZm8gPSBnb2xpa2VfZGF0YVt1c2VybmFtZV0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluCiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICJnb2xpa2VfaWQiOiBnb2xpa2VfaW5mb1siZ29saWtlX2lkIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19nb2xpa2VfbGlua2VkIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgImF2YXRhcl90aHVtYiI6IGdvbGlrZV9pbmZvWyJhdmF0YXJfdGh1bWIiXSBvciBkZXZpY2VfYWNjb3VudC5nZXQoImF2YXRhcl90aHVtYiIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgInVuaXF1ZV9pZCI6IGdvbGlrZV9pbmZvWyJ1bmlxdWVfaWQiXSBvciBkZXZpY2VfYWNjb3VudC5nZXQoInVuaXF1ZV9pZCIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gSUQgdMOgaSBraG/huqNuIHRyb25nIERCCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGRldmljZV9hY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHbDoG8gREIKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdsOgbyBkZXZpY2VfYWNjb3VudAogICAgICAgICAgICAgICAgICAgICAgICBkZXZpY2VfYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIG1hcHBlZF9hY2NvdW50cy5hcHBlbmQoZGV2aWNlX2FjY291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEgdMOgaSBraG/huqNuIFRpa1Rvazoge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gbWFwcGVkX2FjY291bnRzCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMOhbmggeOG6oSB0w6BpIGtob+G6o24gVGlrVG9rIikKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAKICAgIGRlZiBfbmF2aWdhdGVfdG9fcHJvZmlsZV90YWIoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkGnhu4F1IGjGsOG7m25nIMSR4bq/biB0YWIgaOG7kyBzxqEgVGlrVG9rCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gxJFhbmcg4bufIHRyYW5nIGNo4bunCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIHbDoG8gbsO6dCAiSOG7kyBzxqEiCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICBwcm9maWxlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudF9pbl94bWwoc2NyZWVuX3htbCwgY29udGVudF9kZXNjPSJI4buTIHPGoSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgcHJvZmlsZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgSOG7kyBzxqEiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHByb2ZpbGVfYnV0dG9uKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZGlhbG9nICJLaMO0bmcgY2hvIHBow6lwIiBu4bq/dSBjw7MKICAgICAgICAgICAgbm90X2FsbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJLaMO0bmcgY2hvIHBow6lwIikKICAgICAgICAgICAgaWYgbm90X2FsbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgJ0tow7RuZyBjaG8gcGjDqXAnLCDEkWFuZyBjbGljayDEkeG7gyDEkcOzbmcuLi4iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKG5vdF9hbGxvd19idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6AgeOG7rSBsw70gZGlhbG9nICJMxrB1IGzhuqFpIMSRxINuZyBuaOG6rXAgbOG6p24gc2F1IiBu4bq/dSBjw7MKICAgICAgICAgICAgc2F2ZV9sb2dpbl9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iTMawdSB0aMO0bmcgdGluIMSRxINuZyBuaOG6rXAiKQogICAgICAgICAgICBpZiBzYXZlX2xvZ2luX2J1dHRvbjoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgJ0zGsHUgbOG6oWkgxJHEg25nIG5o4bqtcCBs4bqnbiBzYXUnLCDEkWFuZyBjbGljayDEkeG7gyDEkcOzbmcuLi4iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNhdmVfbG9naW5fYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgoKICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiAxIGzhuqduIMSR4buDIHThuqNpIMSR4bqneSDEkeG7pyBu4buZaSBkdW5nCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX2Rvd24oKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgxJFp4buBdSBoxrDhu5tuZyDEkeG6v24gdGFiIGjhu5Mgc8ahIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfb3Blbl9wcm9maWxlX21lbnUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBN4bufIG1lbnUgaOG7kyBzxqEgKGRhbmggc8OhY2ggdMOgaSBraG/huqNuKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gMSBs4bqnbiDEkeG7gyBsw6BtIG3hu5tpIGdpYW8gZGnhu4duIHRyxrDhu5tjIGtoaSB0w6xtIG7DunQgbWVudQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgIyBUw6xtIG7DunQgbWVudSBo4buTIHPGoQogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgbWVudV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iTWVudSBo4buTIHPGoSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgbWVudV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgTWVudSBo4buTIHPGoSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHThu41hIMSR4buZIGPhu6dhIG7DunQgbWVudSB2w6AgY2xpY2sgduG7m2kgxJHhu5kgbOG7h2NoIG5n4bqrdSBuaGnDqm4KICAgICAgICAgICAgYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKG1lbnVfYnV0dG9uKQogICAgICAgICAgICB4MSwgeTEsIHgyLCB5MiA9IGJvdW5kcwogICAgICAgICAgICB5ID0gKCh5MiAtIHkxKSAvLyAyKSArIHkxCiAgICAgICAgICAgIHggPSB4MiAvLyAyCiAgICAgICAgICAgIHggKz0gcmFuZG9tLnJhbmRpbnQoLTEwLCAxMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcCh4LCB5KQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKCiAgICAgICAgICAgICMga2nhu4NtIHRyYSBkaWFsb2cgdGV4dD0iRm9sbG93IGLhuqFuIGLDqCBj4bunYSBi4bqhbiIKCiAgICAgICAgICAgIGZvbGxvd19mcmllbmRzX2RpYWxvZyA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJGb2xsb3cgYuG6oW4gYsOoIGPhu6dhIGLhuqFuIikKICAgICAgICAgICAgaWYgZm9sbG93X2ZyaWVuZHNfZGlhbG9nOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIGRpYWxvZyAnRm9sbG93IGLhuqFuIGLDqCBj4bunYSBi4bqhbicsIMSRYW5nIGNsaWNrIMSR4buDIMSRw7NuZy4uLiIpCiAgICAgICAgICAgICAgICBjbG9zZV9kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSLEkMOzbmciKQogICAgICAgICAgICAgICAgaWYgY2xvc2VfZGlhbG9nOgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihjbG9zZV9kaWFsb2cpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIG3hu58gbWVudSBo4buTIHPGoSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgIGRlZiBpc19ob21lX3NjcmVlbihzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyDhu58gbcOgbiBow6xuaCB0cmFuZyBjaOG7pyBUaWtUb2sga2jDtG5nCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkWFuZyDhu58gdHJhbmcgY2jhu6csIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpIHRyxrDhu5tjIHRpw6puCiAgICAgICAgICAgIGN1cnJlbnRfcGFja2FnZSA9IHNlbGYuaGVscGVyLmdldF9jdXJyZW50X3BhY2thZ2UoKQogICAgICAgICAgICBpZiBjdXJyZW50X3BhY2thZ2UgIT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDsyBuw7p0ICJUcmFuZyBjaOG7pyIgxJHGsOG7o2MgY2jhu41uIChzZWxlY3RlZD10cnVlKSB0cm9uZyB0aGFuaCB0YWIga2jDtG5nCiAgICAgICAgICAgIGhvbWVfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iVHJhbmcgY2jhu6ciKQogICAgICAgICAgICBpZiBob21lX3RhYjoKICAgICAgICAgICAgICAgIGlmIHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQoaG9tZV90YWIpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgdMOsbSB0aOG6pXkgdGFiICJUcmFuZyBjaOG7pyIgbmjGsG5nIGNoxrBhIMSRxrDhu6NjIGNo4buNbiwgY2xpY2sgdsOgbyDEkcOzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGhvbWVfdGFiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxLjUpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBLaMO0bmcgdMOsbSB0aOG6pXkgY8OhYyB54bq/dSB04buRIGPhu6dhIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgbcOgbiBow6xuaCB0cmFuZyBjaOG7pyBUaWtUb2siKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGVuc3VyZV9ob21lX3NjcmVlbihzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gbcOgbiBow6xuaCB0cmFuZyBjaOG7pyBUaWtUb2sKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZyB24buBIHRyYW5nIGNo4bunCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgcGFja2FnZSBoaeG7h24gdOG6oWkgdHLGsOG7m2MgdGnDqm4KICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkFwcCBoaeG7h24gdOG6oWkgKHtjdXJyZW50X3BhY2thZ2V9KSBraMO0bmcgcGjhuqNpIFRpa1RvaywgbeG7nyBhcHAgVGlrVG9rLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMTApICAjIFTEg25nIGzDqm4gMTAgZ2nDonkgxJHhu4MgYXBwIGto4bufaSDEkeG7mW5nIGhvw6BuIHRvw6BuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBwb3B1cCBQSU4gdHJvbmcgNXMgc2F1IGtoaSBt4bufIGFwcAogICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfcGluX3BvcHVwKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWYWxpZGF0ZSBhcHAga2jDtG5nIGLhu4sgYmFubmVkIHNhdSBraGkgbeG7nwogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYudmFsaWRhdGVfYXBwX25vdF9iYW5uZWQoKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiQXBwIFRpa1RvayBjw7MgduG6pW4gxJHhu4EgKGJhbm5lZC9j4bqjbmggYsOhbykiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIOG7nyB0cmFuZyBjaOG7pyBjaMawYQogICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIOG7nyB0cmFuZyBjaOG7pyBUaWtUb2siKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGNoxrBhLCBj4buRIGfhuq9uZyB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHJldHVybiBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgxJHhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiB2YWxpZGF0ZV9hcHBfbm90X2Jhbm5lZChzZWxmKToKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28ga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBi4buLIGJhbm5lZAogICAgICAgICIiIgogICAgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgY+G6o25oIGLDoW8gY2h1bmcKICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAjIEtp4buDbSB0cmEgZGlhbG9nICJD4bqtcCBuaOG6rXQgQ2jDrW5oIHPDoWNoIHF1eeG7gW4gcmnDqm5nIHTGsCIKICAgICAgICBwcml2YWN5X3VwZGF0ZV9lbGVtZW50cyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgdGV4dD0iQ+G6rXAgbmjhuq10IENow61uaCBzw6FjaCBxdXnhu4FuIHJpw6puZyB0xrAiCiAgICAgICAgKQoKICAgICAgICBpZiBwcml2YWN5X3VwZGF0ZV9lbGVtZW50czoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIGRpYWxvZyAnQ+G6rXAgbmjhuq10IENow61uaCBzw6FjaCBxdXnhu4FuIHJpw6puZyB0xrAnLCDEkWFuZyB44butIGzDvS4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCAixJDDoyBoaeG7g3UiIHbDoCBi4bqlbSB0cuG7sWMgdGnhur9wCiAgICAgICAgICAgIHVuZGVyc3RhbmRfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IsSQw6MgaGnhu4N1IikKICAgICAgICAgICAgaWYgdW5kZXJzdGFuZF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIodW5kZXJzdGFuZF9idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBUaOG7rSB0w6xtIHbhu5tpIGPDoWMgdGV4dCBraMOhYwogICAgICAgICAgICAgICAgZm9yIHRleHQgaW4gWyJUaeG6v3AgdOG7pWMiLCAixJDhu5NuZyDDvSIsICJDb250aW51ZSIsICJBZ3JlZSIsICJDaOG6pXAgbmjhuq1uIiwgIkFjY2VwdCJdOgogICAgICAgICAgICAgICAgICAgIGJ1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICAgICAgaWYgYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyAiVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iCiAgICAgICAgYWNjb3VudF9zdGF0dXNfZWxlbWVudHMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgIHRleHQ9IlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIgogICAgICAgICkKCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXNfZWxlbWVudHM6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgxJHEg25nIHh14bqldCB0w6BpIGtob+G6o24uLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgY8OzIGlkIGzDoCBidXR0b24xIHbDoCBi4bqlbQogICAgICAgICAgICBidXR0b24xID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHJlc291cmNlX2lkPSJhbmRyb2lkOmlkL2J1dHRvbjEiKQogICAgICAgICAgICBpZiBidXR0b24xOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGJ1dHRvbjEpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMTApCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKCiAgICAgICAgIyBUw6xtIGRpYWxvZyBj4bqjbmggYsOhbyBi4bqxbmcgSUQgaG/hurdjIGNvbnRlbnQtZGVzYyBjw7MgY2jhu6lhICJj4bqjbmggYsOhbyIsICJs4buXaSIsICJ0aMO0bmcgYsOhbyIKICAgICAgICBhbGVydF9kaWFsb2dzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkLmFwcC5EaWFsb2ciCiAgICAgICAgKQogICAgICAgIAogICAgICAgIGZvciBkaWFsb2cgaW4gYWxlcnRfZGlhbG9nczoKICAgICAgICAgICAgIyBUw6xtIHRleHQgdHJvbmcgZGlhbG9nCiAgICAgICAgICAgIHRleHRfdmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuVGV4dFZpZXciCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciB0ZXh0X3ZpZXcgaW4gdGV4dF92aWV3czoKICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHRleHRfdmlldykKICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIGFueShrZXl3b3JkIGluIHRleHQubG93ZXIoKSBmb3Iga2V5d29yZCBpbiBbImPhuqNuaCBiw6FvIiwgImzhu5dpIiwgInRow7RuZyBiw6FvIiwgImLhu4sga2jDs2EiLCAidmkgcGjhuqFtIl0pOgogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCBj4bqjbmggYsOhbyBoaeG7h24gdOG6oWkgdOG7qyBkYgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfd2FybmluZ3MgPSBzZWxmLmRiLmdldCgibG9ncy13YXJuaW5nLW1lc3NhZ2UiLCBbXSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRow6ptIGPhuqNuaCBiw6FvIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgY3VycmVudF93YXJuaW5ncy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICAgICAidGltZSI6IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCgpLAogICAgICAgICAgICAgICAgICAgICAgICAibWVzcyI6IHRleHQKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgQ2jhu4kgZ2nhu68gbOG6oWkgdOG7kWkgxJFhIDIwIGxvZyBn4bqnbiBuaOG6pXQKICAgICAgICAgICAgICAgICAgICBpZiBsZW4oY3VycmVudF93YXJuaW5ncykgPiAyMDoKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudF93YXJuaW5ncyA9IGN1cnJlbnRfd2FybmluZ3NbLTIwOl0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgdsOgbyBkYgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJsb2dzLXdhcm5pbmctbWVzc2FnZSIsIGN1cnJlbnRfd2FybmluZ3MpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIsSQw6MgbMawdSBj4bqjbmggYsOhbyBUaWtUb2s6IHt0ZXh0fSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIG7DunQgT0sgaG/hurdjIMSQw7NuZyDEkeG7gyDEkcOzbmcgZGlhbG9nCiAgICAgICAgICAgICAgICAgICAgYnV0dG9ucyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBmb3IgYnV0dG9uIGluIGJ1dHRvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl90ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChidXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGJ1dHRvbl90ZXh0IGFuZCBidXR0b25fdGV4dC5sb3dlcigpIGluIFsib2siLCAixJHDs25nIiwgInTDtGkgaGnhu4N1IiwgIsSR4buTbmcgw70iXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihidXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEPDsyBj4bqjbmggYsOhbyB0aMOsIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBjw7MgY+G6o25oIGLDoW8KICAgIAogICAgZGVmIF9oYW5kbGVfZGlhbG9nc19hbmRfbmF2aWdhdGVfaG9tZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBPdmVycmlkZSDEkeG7gyB44butIGzDvSBkaWFsb2cgc3BlY2lmaWMgY+G7p2EgVGlrVG9rIHbDoCBuYXZpZ2F0ZSB24buBIGhvbWUKICAgICAgICAiIiIKICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZygixJBhbmcgeOG7rSBsw70gVGlrVG9rIGRpYWxvZ3MgdsOgIG5hdmlnYXRlIHbhu4EgaG9tZS4uLiIpCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSBjw6FjIGRpYWxvZyBUaWtUb2sgc3BlY2lmaWMKICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGlhbG9nICJD4bqtcCBuaOG6rXQgQ2jDrW5oIHPDoWNoIHF1eeG7gW4gcmnDqm5nIHTGsCIKICAgICAgICB1bmRlcnN0YW5kX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSLEkMOjIGhp4buDdSIpCiAgICAgICAgaWYgdW5kZXJzdGFuZF9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw7NuZyBkaWFsb2cgJ8SQw6MgaGnhu4N1JyIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1bmRlcnN0YW5kX2J1dHRvbikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyAiTMawdSB0aMO0bmcgdGluIMSRxINuZyBuaOG6rXAiCiAgICAgICAgc2F2ZV9sb2dpbl9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iTMawdSB0aMO0bmcgdGluIMSRxINuZyBuaOG6rXAiKQogICAgICAgIGlmIHNhdmVfbG9naW5fYnV0dG9uOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOzbmcgZGlhbG9nICdMxrB1IHRow7RuZyB0aW4gxJHEg25nIG5o4bqtcCciKQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2F2ZV9sb2dpbl9idXR0b24pCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgIkZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4iCiAgICAgICAgY2xvc2VfZnJpZW5kc19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSLEkMOzbmciKQogICAgICAgIGlmIGNsb3NlX2ZyaWVuZHNfZGlhbG9nOgogICAgICAgICAgICBmb2xsb3dfZnJpZW5kc19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iRm9sbG93IGLhuqFuIGLDqCBj4bunYSBi4bqhbiIpCiAgICAgICAgICAgIGlmIGZvbGxvd19mcmllbmRzX2RpYWxvZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw7NuZyBkaWFsb2cgJ0ZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4nIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihjbG9zZV9mcmllbmRzX2RpYWxvZykKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgICAgICMgU2F1IGtoaSB44butIGzDvSBkaWFsb2csIHRo4butIG5hdmlnYXRlIHbhu4EgaG9tZQogICAgICAgIGlmIG5vdCBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICMgVMOsbSBuw7p0ICJUcmFuZyBjaOG7pyIKICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iVHJhbmcgY2jhu6ciKQogICAgICAgICAgICBpZiBub3QgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgaWYgbm90IGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iSG9tZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJC4bqlbSBuw7p0IFRyYW5nIGNo4bunIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogbmjhuqVuIGJhY2sgbeG7mXQgdsOgaSBs4bqnbgogICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UoMyk6CiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgIAogICAgZGVmIGJhY2tfdG9faG9tZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFF1YXkgduG7gSB0cmFuZyBjaOG7pyBUaWtUb2sgdOG7qyBi4bqldCBr4buzIG3DoG4gaMOsbmggbsOgbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nIHbhu4EgdHJhbmcgY2jhu6cKICAgICAgICAiIiIKICAgICAgICBtYXhfYXR0ZW1wdHMgPSA1CiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUXVheSB24buBIHRyYW5nIGNo4bunIFRpa1RvayIpCiAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UobWF4X2F0dGVtcHRzKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSDEkcOjIOG7nyB0cmFuZyBjaOG7pyBjaMawYQogICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6Mg4bufIHRyYW5nIGNo4bunIFRpa1RvayIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duIHRoYW8gdMOhYwogICAgICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgICAgICBpZiBjdXJyZW50X3BhY2thZ2UgIT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiQXBwIGhp4buHbiB04bqhaSAoe2N1cnJlbnRfcGFja2FnZX0pIGtow7RuZyBwaOG6o2kgVGlrVG9rLCBt4bufIGzhuqFpIGFwcCBUaWtUb2suLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fYXBwKHNlbGYuYXBwX3BhY2thZ2UpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEwKSAgIyBUxINuZyBsw6puIDEwIGdpw6J5IMSR4buDIGFwcCBraOG7n2kgxJHhu5luZyBob8OgbiB0b8OgbgogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSBzYXUga2hpIG3hu58gYXBwCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBuw7p0ICJUcmFuZyBjaOG7pyIg4bufIGJvdHRvbSBuYXZpZ2F0aW8KICAgICAgICAgICAgICAgIGhvbWVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgICAgIGlmIG5vdCBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgICAgIGlmIG5vdCBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJIb21lIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX2J1dHRvbikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgaG9tZSwgdGjhu60gbmjhuqVuIGJhY2sKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBj4buRIGfhuq9uZyB24buBIHRyYW5nIGNo4bunIChs4bqnbiB7YXR0ZW1wdCArIDF9KToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgcXVheSB24buBIHRyYW5nIGNo4bunIFRpa1RvayBzYXUgbmhp4buBdSBs4bqnbiB0aOG7rSIpCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBzd2l0Y2hfYWNjb3VudChzZWxmLCB0YXJnZXRfYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIENodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1RvayBraMOhYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhcmdldF9hY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBib29sLAogICAgICAgICAgICAgICAgJ3JlYXNvbic6IHN0ciAobuG6v3UgdGjhuqV0IGLhuqFpKSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJzogc3RyCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0YXJnZXRfdXNlcm5hbWUgPSB0YXJnZXRfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1Rvazoge3RhcmdldF91c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBJbnZhbGlkYXRlIHVzZXJuYW1lIGNhY2hlIGtoaSBi4bqvdCDEkeG6p3Ugc3dpdGNoCiAgICAgICAgICAgIHNlbGYuaW52YWxpZGF0ZV91c2VybmFtZV9jYWNoZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cgKHJldHJ5IG1lY2hhbmlzbSkKICAgICAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UoMyk6ICAjIFRo4butIDMgbOG6p24KICAgICAgICAgICAgICAgIGlmIHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGVsaWYgYXR0ZW1wdCA9PSAyOiAgIyBM4bqnbiBjdeG7kWkgY8O5bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyDEkeG6v24gdHJhbmcgY2jhu6cgVGlrVG9rIHNhdSAzIGzhuqduIHRo4butIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICduYXZpZ2F0aW9uX2Vycm9yJywKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnS2jDtG5nIHRo4buDIMSR4bq/biB0cmFuZyBjaOG7pyBUaWtUb2sgc2F1IG5oaeG7gXUgbOG6p24gdGjhu60nCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVGjhu60gbOG6p24ge2F0dGVtcHQgKyAxfTogS2jDtG5nIHRo4buDIMSR4bq/biB0cmFuZyBjaOG7pywgdGjhu60gbOG6oWkuLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWw6BvIHRyYW5nIGjhu5Mgc8ahCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9uYXZpZ2F0ZV90b19wcm9maWxlX3RhYigpOgogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAncmVhc29uJzogJ25hdmlnYXRpb25fZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0aOG7gyB2w6BvIHRyYW5nIGjhu5Mgc8ahIFRpa1RvaycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgI2tp4buDbSB0cmEgxJHDum5nIHVzZXJuYW1lIHLhu5NpIHRow6wgcmV0dXJuIHRydWUKICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9ZiJAe3RhcmdldF91c2VybmFtZX0iKToKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBUcnVlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogZiLEkMOjIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1Rvazoge3RhcmdldF91c2VybmFtZX0iCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAjIFZ14buRdCBsw6puIDEgbOG6p24KICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIG1lbnUgaOG7kyBzxqEKICAgICAgICAgICAgaWYgbm90IHNlbGYuX29wZW5fcHJvZmlsZV9tZW51KCk6CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAndWlfZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0aOG7gyBt4bufIG1lbnUgaOG7kyBzxqEgVGlrVG9rJwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgYWRkX2FjY291bnRfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9IlRow6ptIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgYWRkX2FjY291bnRfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBtZW51IHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAndWlfZXJyb3InLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJzogJ0tow7RuZyB0w6xtIHRo4bqleSBtZW51IHTDoGkga2hv4bqjbiBUaWtUb2snCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbgogICAgICAgICAgICBhY2NvdW50X2J1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICB0YXJnZXRfaXRlbSA9IE5vbmUKICAgICAgICAgICAgZm9yIGJ1dHRvbiBpbiBhY2NvdW50X2J1dHRvbnM6CiAgICAgICAgICAgICAgICBpZiBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiKSA9PSAiVGjDqm0gdMOgaSBraG/huqNuIiBvciBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiKSA9PSAixJDDs25nIjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBidXR0b24uZ2V0KCJjb250ZW50LWRlc2MiLCAiIikKICAgICAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZToKICAgICAgICAgICAgICAgICAgICB0ZXh0dmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LlRleHRWaWV3IgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBidXR0b25fYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGJ1dHRvbikKICAgICAgICAgICAgICAgICAgICBmb3IgdHYgaW4gdGV4dHZpZXdzOgogICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHModHYpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0dl9ib3VuZHNbMF0gPj0gYnV0dG9uX2JvdW5kc1swXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kc1sxXSA+PSBidXR0b25fYm91bmRzWzFdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzWzJdIDw9IGJ1dHRvbl9ib3VuZHNbMl0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHNbM10gPD0gYnV0dG9uX2JvdW5kc1szXSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dCh0dikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIHRleHQgIT0gIm51bGwiOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gdGV4dAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgICAgICB0YXJnZXRfaXRlbSA9IGJ1dHRvbgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB0YXJnZXRfaXRlbToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSB0cm9uZyBkYW5oIHPDoWNoIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGzDoCBi4buLIHbDtCBoaeG7h3UgaMOzYSB0cm9uZyBEQgogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudCh0YXJnZXRfYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiZGlzYWJsZWQiLAogICAgICAgICAgICAgICAgICAgICJkaXNhYmxlX3JlYXNvbiI6ICJUw6BpIGtob+G6o24ga2jDtG5nIGPDsyB0csOqbiB0aGnhur90IGLhu4siLAogICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOaOG6pW4gQmFjayDEkeG7gyDEkcOzbmcgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUXVheSB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdhY2NvdW50X25vdF9mb3VuZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ0tow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdHJvbmcgZGFuaCBzw6FjaCBUaWtUb2snCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBOaOG6pXAgdsOgbyB0w6BpIGtob+G6o24gbeG7pWMgdGnDqnUKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHRhcmdldF9pdGVtKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHNhZmVfc2xlZXAgcmV0dXJuIHZhbHVlIMSR4buDIGPDsyB0aOG7gyB0aG/DoXQgc+G7m20KICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg2KTogICMgxJDhu6NpIGNodXnhu4NuIHTDoGkga2hv4bqjbiBob8OgbiB04bqldAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgZOG7q25nIHRyb25nIHN3aXRjaF90b19hY2NvdW50IikKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgJ3JlYXNvbic6ICdpbnRlcnJ1cHRlZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnQuG7iyBk4burbmcgdHJvbmcgcXXDoSB0csOsbmggY2h1eeG7g24gdMOgaSBraG/huqNuIFRpa1RvaycKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBjaHV54buDbiB0w6BpIGtob+G6o24gdGjDoG5oIGPDtG5nIGNoxrBhCiAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWUgPSBzZWxmLmdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBjdXJyZW50X3VzZXJuYW1lID09IHRhcmdldF91c2VybmFtZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkMOjIGNodXnhu4NuIHTDoGkga2hv4bqjbiB0aMOgbmggY8O0bmcgc2FuZyB7dGFyZ2V0X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogVHJ1ZSwgCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiBmJ8SQw6MgY2h1eeG7g24gdMOgaSBraG/huqNuIHRow6BuaCBjw7RuZyBzYW5nIHt0YXJnZXRfdXNlcm5hbWV9JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiLEkMOjIGLhuqVtIHbDoG8gdMOgaSBraG/huqNuIHt0YXJnZXRfdXNlcm5hbWV9IG5oxrBuZyBraeG7g20gdHJhIGzhuqFpIHRo4bqleSDEkWFuZyDEkcSDbmcgbmjhuq1wIGzDoCB7Y3VycmVudF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAnc3VjY2Vzcyc6IEZhbHNlLCAKICAgICAgICAgICAgICAgICAgICAncmVhc29uJzogJ3N3aXRjaF92ZXJpZmljYXRpb25fZmFpbGVkJywKICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnxJDDoyBi4bqlbSB2w6BvIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSBuaMawbmcga2nhu4NtIHRyYSBs4bqhaSB0aOG6pXkgxJFhbmcgxJHEg25nIG5o4bqtcCBsw6Age2N1cnJlbnRfdXNlcm5hbWV9JwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIHF1YXkgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAncmVhc29uJzogJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnTOG7l2kga2hpIGNodXnhu4NuIHTDoGkga2hv4bqjbiBUaWtUb2s6IHtzdHIoZSl9JwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgZGVmIF9wZXJmb3JtX2FjY291bnRfc3dpdGNoKHNlbGYsIHRhcmdldF9hY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBjw6FjIHRoYW8gdMOhYyBVSSDEkeG7gyBjaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFyZ2V0X2FjY291bnQ6IFTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbiDEkeG6v24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IHsKICAgICAgICAgICAgICAgICdzdWNjZXNzJzogYm9vbCwKICAgICAgICAgICAgICAgICdyZWFzb24nOiBzdHIgKG7hur91IHRo4bqldCBi4bqhaSksCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IHN0cgogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gc2VsZi5zd2l0Y2hfYWNjb3VudCh0YXJnZXRfYWNjb3VudCkKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzd2l0Y2hfcmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgIHJldHVybiBzd2l0Y2hfcmVzdWx0CiAgICAgICAgICAgIGVsaWYgc3dpdGNoX3Jlc3VsdDoKICAgICAgICAgICAgICAgIHJldHVybiB7J3N1Y2Nlc3MnOiBUcnVlLCAnbWVzc2FnZSc6ICdDaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rIHRow6BuaCBjw7RuZyd9CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJzogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICdyZWFzb24nOiAnc3dpdGNoX2ZhaWxlZCcsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnOiAnS2jDtG5nIHRo4buDIGNodXnhu4NuIHTDoGkga2hv4bqjbiBUaWtUb2snCiAgICAgICAgICAgICAgICB9CiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGNodXnhu4NuIHTDoGkga2hv4bqjbiBUaWtUb2siKQogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAncmVhc29uJzogJ2V4Y2VwdGlvbicsCiAgICAgICAgICAgICAgICAnbWVzc2FnZSc6IGYnTOG7l2kga2hpIHRo4buxYyBoaeG7h24gY2h1eeG7g24gdMOgaSBraG/huqNuIFRpa1Rvazoge3N0cihlKX0nCiAgICAgICAgICAgIH0KICAgIAogICAgZGVmIGdldF9jdXJyZW50X2xvZ2dlZF9pbl91c2VybmFtZShzZWxmKSAtPiBPcHRpb25hbFtzdHJdOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiBUaWtUb2sgxJFhbmcgxJHEg25nIG5o4bqtcCAoduG7m2kgY2FjaGUpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyIGhv4bq3YyBOb25lOiBVc2VybmFtZSBj4bunYSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCwgaG/hurdjIE5vbmUgbuG6v3Uga2jDtG5nIGPDswogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGNhY2hlIHRyxrDhu5tjCiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIGlmIChzZWxmLl9jYWNoZWRfdXNlcm5hbWUgYW5kIAogICAgICAgICAgICAgICAgY3VycmVudF90aW1lIC0gc2VsZi5fdXNlcm5hbWVfY2FjaGVfdGltZSA8IHNlbGYuX3VzZXJuYW1lX2NhY2hlX3R0bCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIlPhu60gZOG7pW5nIGNhY2hlZCB1c2VybmFtZToge3NlbGYuX2NhY2hlZF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhY2hlZF91c2VybmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGFwcCBjw7MgxJFhbmcgbeG7nyBraMO0bmcgdHLGsOG7m2MKICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIkFwcCBUaWtUb2sgY2jGsGEgbeG7nywga2jDtG5nIHRo4buDIGzhuqV5IHVzZXJuYW1lIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCgogICAgICAgICAgICAjIEzGsHUgdHLhuqFuZyB0aMOhaSBoaeG7h24gdOG6oWkgKGtow7RuZyBmb3JjZSB24buBIGhvbWUgxJHhu4MgdHLDoW5oIGNvbmZsaWN0KQogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgaWYgbm90IHNjcmVlbl94bWw6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUcsaw4bubYyB0acOqbiB0aOG7rSB0w6xtIHVzZXJuYW1lIOG7nyBtw6BuIGjDrG5oIGhp4buHbiB04bqhaQogICAgICAgICAgICB1c2VybmFtZSA9IHNlbGYuX2V4dHJhY3RfdXNlcm5hbWVfZnJvbV9zY3JlZW4oc2NyZWVuX3htbCkKICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjYWNoZQogICAgICAgICAgICAgICAgc2VsZi5fY2FjaGVkX3VzZXJuYW1lID0gdXNlcm5hbWUKICAgICAgICAgICAgICAgIHNlbGYuX3VzZXJuYW1lX2NhY2hlX3RpbWUgPSBjdXJyZW50X3RpbWUKICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgdMOsbSB0aOG6pXksIHRo4butIG5hdmlnYXRlIMSR4bq/biBwcm9maWxlIChjaOG7iSBraGkgY+G6p24gdGhp4bq/dCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuX25hdmlnYXRlX3RvX3Byb2ZpbGVfdGFiKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBWdeG7kXQgeHXhu5FuZyB2w6AgY2jhu50KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX2Rvd24oKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpICAjIEdp4bqjbSB0aOG7nWkgZ2lhbiBjaOG7nQoKICAgICAgICAgICAgICAgICMgVMOsbSB1c2VybmFtZSB0cm9uZyB0cmFuZyBo4buTIHPGoQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHNlbGYuX2V4dHJhY3RfdXNlcm5hbWVfZnJvbV9zY3JlZW4oc2NyZWVuX3htbCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBRdWF5IGzhuqFpIHRyYW5nIGNo4bunIG5oYW5oCiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYiTOG6pXkgdXNlcm5hbWUgdOG7qyBwcm9maWxlOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjYWNoZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NhY2hlZF91c2VybmFtZSA9IHVzZXJuYW1lCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXNlcm5hbWVfY2FjaGVfdGltZSA9IGN1cnJlbnRfdGltZQogICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgbOG6pXkgdXNlcm5hbWUgdOG7qyBwcm9maWxlIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kgbmF2aWdhdGUgcHJvZmlsZSDEkeG7gyBs4bqleSB1c2VybmFtZToge2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbOG6pXkgdXNlcm5hbWU6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBpbnZhbGlkYXRlX3VzZXJuYW1lX2NhY2hlKHNlbGYpOgogICAgICAgICIiIljDs2EgY2FjaGUgdXNlcm5hbWUgKGfhu41pIGtoaSBzd2l0Y2ggYWNjb3VudCkiIiIKICAgICAgICBzZWxmLl9jYWNoZWRfdXNlcm5hbWUgPSBOb25lCiAgICAgICAgc2VsZi5fdXNlcm5hbWVfY2FjaGVfdGltZSA9IDAKICAgIAogICAgZGVmIF9leHRyYWN0X3VzZXJuYW1lX2Zyb21fc2NyZWVuKHNlbGYsIHNjcmVlbl94bWw6IHN0cikgLT4gT3B0aW9uYWxbc3RyXToKICAgICAgICAiIiIKICAgICAgICBFeHRyYWN0IHVzZXJuYW1lIHThu6sgWE1MIG3DoG4gaMOsbmggaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgc2NyZWVuX3htbDogWE1MIGPhu6dhIG3DoG4gaMOsbmgKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgVXNlcm5hbWUgaG/hurdjIE5vbmUKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSB0cm9uZyBjw6FjIEJ1dHRvbiBjw7MgdGjhu4MgY2jhu6lhIHVzZXJuYW1lCiAgICAgICAgICAgIGJ1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgYnV0dG9uIGluIGJ1dHRvbnM6CiAgICAgICAgICAgICAgICB0ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChidXR0b24pCiAgICAgICAgICAgICAgICBpZiB0ZXh0IGFuZCB0ZXh0LnN0YXJ0c3dpdGgoIkAiKSBhbmQgbGVuKHRleHQpID4gMToKICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHRleHRbMTpdICAjIELhu48ga8O9IHThu7EgQAogICAgICAgICAgICAgICAgICAgIGlmIGxlbih1c2VybmFtZSkgPiAyOiAgIyBVc2VybmFtZSBo4bujcCBs4buHCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB1c2VybmFtZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7rSB0w6xtIHRyb25nIFRleHRWaWV3CiAgICAgICAgICAgIHRleHRfdmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuVGV4dFZpZXciCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciB0ZXh0X3ZpZXcgaW4gdGV4dF92aWV3czoKICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHRleHRfdmlldykKICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIHRleHQuc3RhcnRzd2l0aCgiQCIpIGFuZCBsZW4odGV4dCkgPiAxOgogICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gdGV4dFsxOl0gICMgQuG7jyBrw70gdOG7sSBACiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHVzZXJuYW1lKSA+IDI6ICAjIFVzZXJuYW1lIGjhu6NwIGzhu4cKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHVzZXJuYW1lCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBleHRyYWN0IHVzZXJuYW1lOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT0gU01BUlQgQ0FSRSBNRVRIT0RTICjEkOG7k25nIG5o4bqldCB24bubaSBJbnN0YWdyYW0pID09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIF9jYXJlX3N3aXBlX2ZlZWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMaw4bubdCBmZWVkIFRpa1RvayBuaOG6uSBuaMOgbmcgLSB0xrDGoW5nIMSRxrDGoW5nIEluc3RhZ3JhbSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6r3QgxJHhuqd1IGzGsOG7m3QgZmVlZCBUaWtUb2suLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgIyBC4bqlbSB2w6BvIGNo4buvIMSQ4buBIHh14bqldCBob+G6t2MgRMOgbmggY2hvIGLhuqFuCiAgICAgICAgICAgIGJ0bl9mb3J5b3UgPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9IsSQ4buBIHh14bqldCIsIHRpbWVvdXQ9MikKICAgICAgICAgICAgaWYgbm90IGJ0bl9mb3J5b3U6CiAgICAgICAgICAgICAgICBidG5fZm9yeW91ID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PSJEw6BuaCBjaG8gYuG6oW4iLCB0aW1lb3V0PTIpCiAgICAgICAgICAgIGlmIGJ0bl9mb3J5b3U6CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnRuX2ZvcnlvdSkKCiAgICAgICAgICAgICMgTMaw4bubdCA1LTEwIHZpZGVvIG5n4bqrdSBuaGnDqm4KICAgICAgICAgICAgbnVtX3N3aXBlcyA9IHJhbmRvbS5yYW5kaW50KDUsIDEwKQogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShudW1fc3dpcGVzKToKICAgICAgICAgICAgICAgICMgVGjhu51pIGdpYW4geGVtIG5n4bqrdSBuaGnDqm4gMi01IGdpw6J5CiAgICAgICAgICAgICAgICB3YXRjaF90aW1lID0gcmFuZG9tLnVuaWZvcm0oMiwgNSkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYiTMaw4bubdCB2aWRlbyB7aSsxfS97bnVtX3N3aXBlc30sIHhlbSB7d2F0Y2hfdGltZTouMWZ9cyIpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2F0Y2hfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDw7MgMTAlIGto4bqjIG7Eg25nIGxpa2UgdmlkZW8ga2hpIHhlbSA+PSAzIGdpw6J5IChnaeG6o20gdOG7qyAxNSUpCiAgICAgICAgICAgICAgICBpZiB3YXRjaF90aW1lID49IDMgYW5kIHJhbmRvbS5yYW5kb20oKSA8IDAuMTA6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuX2ZpbmRfbGlrZV9idXR0b24oKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsaWtlX2J1dHRvbiBhbmQgbm90IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUaOG7rSBkb3VibGUgdGFwIMSR4buDIGxpa2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoLCBoZWlnaHQgPSBzZWxmLmhlbHBlci5nZXRfc2NyZWVuX3NpemUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGludCh3aWR0aCAqIHJhbmRvbS51bmlmb3JtKDAuNSwgMC42KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBpbnQoaGVpZ2h0ICogcmFuZG9tLnVuaWZvcm0oMC41LCAwLjYpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC4xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiLEkMOjIGxpa2UgdmlkZW8ge2krMX0gdHJvbmcgY2FyZSBmZWVkIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MgICMgQuG7jyBxdWEgbOG7l2kgbGlrZSwgdGnhur9wIHThu6VjIHhlbQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBmb3JjZSBzdG9wCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDAuMSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBsxrDhu5t0IHtudW1fc3dpcGVzfSB2aWRlbyBUaWtUb2siKQogICAgICAgICAgICAjIFbhu4EgdHJhbmcgY2jhu6cgc2F1IGtoaSBjYXJlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgbMaw4bubdCBmZWVkIFRpa1Rvazoge2V9IikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2NhcmVfd2F0Y2hfdmlkZW9zKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlhlbSB2aWRlbyBUaWtUb2sgdHJvbmcgdGjhu51pIGdpYW4gZMOgaSAtIHTGsMahbmcgxJHGsMahbmcgd2F0Y2hfcmVlbHMgSW5zdGFncmFtIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgeGVtIHZpZGVvIFRpa1Rvay4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHRvdGFsX3dhdGNoX3RpbWUgPSByYW5kb20ucmFuZGludCg2MCwgMTUwKSAgIyAxLTIuNSBwaMO6dAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU+G6vSB4ZW0gdmlkZW8gVGlrVG9rIHRyb25nIHt0b3RhbF93YXRjaF90aW1lfSBnacOieSIpCiAgICAgICAgICAgIAogICAgICAgICAgICB2aWRlb19jb3VudCA9IDAKICAgICAgICAgICAgd2hpbGUgKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkgPCB0b3RhbF93YXRjaF90aW1lOgogICAgICAgICAgICAgICAgdmlkZW9fY291bnQgKz0gMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFhlbSB2aWRlbyBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIHdhdGNoX2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQoMywgMTIpICAjIDMtMTIgZ2nDonkgbeG7l2kgdmlkZW8KICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmRlYnVnKGYiWGVtIHZpZGVvIHt2aWRlb19jb3VudH0gdHJvbmcge3dhdGNoX2R1cmF0aW9ufXMiKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhdGNoX2R1cmF0aW9uKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPDsyAyNSUga2jhuqMgbsSDbmcgbGlrZSB2aWRlbyBraGkgeGVtID49IDUgZ2nDonkgKGdp4bqjbSB04burIDIwJSkKICAgICAgICAgICAgICAgIGlmIHdhdGNoX2R1cmF0aW9uID49IDUgYW5kIHJhbmRvbS5yYW5kb20oKSA8IDAuMjU6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuX2ZpbmRfbGlrZV9idXR0b24oKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBsaWtlX2J1dHRvbiBhbmQgbm90IHNlbGYuaGVscGVyLmlzX2VsZW1lbnRfc2VsZWN0ZWQobGlrZV9idXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBUaOG7rSBkb3VibGUgdGFwIMSR4buDIGxpa2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpZHRoLCBoZWlnaHQgPSBzZWxmLmhlbHBlci5nZXRfc2NyZWVuX3NpemUoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgeCA9IGludCh3aWR0aCAqIHJhbmRvbS51bmlmb3JtKDAuNSwgMC42KSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHkgPSBpbnQoaGVpZ2h0ICogcmFuZG9tLnVuaWZvcm0oMC41LCAwLjYpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC4xKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwKHgsIHkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiLEkMOjIGxpa2UgdmlkZW8ge3ZpZGVvX2NvdW50fSB0cm9uZyBjYXJlIHdhdGNoIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MgICMgQuG7jyBxdWEgbOG7l2kgbGlrZSwgdGnhur9wIHThu6VjIHhlbQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFZ14buRdCBzYW5nIHZpZGVvIHRp4bq/cCB0aGVvCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgZm9yY2Ugc3RvcAogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgwLjEpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgeGVtIHt2aWRlb19jb3VudH0gdmlkZW8gVGlrVG9rIHRyb25nIHtpbnQodGltZS50aW1lKCkgLSBzdGFydF90aW1lKX1zIikKICAgICAgICAgICAgIyBW4buBIHRyYW5nIGNo4bunIHNhdSBraGkgY2FyZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHhlbSB2aWRlbyBUaWtUb2s6IHtlfSIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9jYXJlX3ZpZXdfbm90aWZpY2F0aW9ucyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJYZW0gdGjDtG5nIGLDoW8gVGlrVG9rIC0gdMawxqFuZyDEkcawxqFuZyBJbnN0YWdyYW0iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSB4ZW0gdGjDtG5nIGLDoW8gVGlrVG9rLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIHbDoG8gSOG7mXAgdGjGsCAoaW5ib3gpCiAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoCiAgICAgICAgICAgICAgICB0aW1lb3V0PTUsCiAgICAgICAgICAgICAgICBjb250ZW50X2Rlc2M9Ikjhu5lwIHRoxrAiCiAgICAgICAgICAgICkgb3Igc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCgKICAgICAgICAgICAgICAgIHRpbWVvdXQ9NSwKICAgICAgICAgICAgICAgIHJlc291cmNlX2lkPSJjb20uc3MuYW5kcm9pZC51Z2MudHJpbGw6aWQvY3U5IiAgIyBUaWtUb2sgaW5ib3ggYnV0dG9uCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBpbmJveF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBI4buZcCB0aMawIFRpa1RvayIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihpbmJveF9idXR0b24pCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYZW0gdGjDtG5nIGLDoW8gdHJvbmcgMTAtMjAgZ2nDonkKICAgICAgICAgICAgdmlld190aW1lID0gcmFuZG9tLnJhbmRpbnQoMTAsIDIwKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5kZWJ1ZyhmIlhlbSB0aMO0bmcgYsOhbyB0cm9uZyB7dmlld190aW1lfXMiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiB4deG7kW5nIMSR4buDIHhlbSB0aMO0bmcgYsOhbwogICAgICAgICAgICBmb3IgXyBpbiByYW5nZShyYW5kb20ucmFuZGludCgyLCA0KSk6CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oMSwgMykpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAodmlld190aW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBRdWF5IGzhuqFpIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgeGVtIHRow7RuZyBiw6FvIFRpa1RvayIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSB4ZW0gdGjDtG5nIGLDoW8gVGlrVG9rOiB7ZX0iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PSBFTkQgU01BUlQgQ0FSRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIF9jaGVja19waW5fcG9wdXAoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSBwb3B1cCBQSU4gdsOgIG5o4bqtcCBtw6MgUElOIG7hur91IGPDswogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIktp4buDbSB0cmEgcG9wdXAgUElOIFRpa1RvayB0cm9uZyA1IGdpw6J5Li4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgd2FpdF9mb3JfZWxlbWVudCDEkeG7gyBraeG7g20gdHJhIHBvcHVwIHRyb25nIDUgZ2nDonkKICAgICAgICAgICAgcGluX3BvcHVwID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCgKICAgICAgICAgICAgICAgIGNvbnRlbnRfZGVzYz0iQuG6oW4gxJHDoyBz4bq1biBzw6BuZyDEkcOzbmcgVGlrVG9rPyIsCiAgICAgICAgICAgICAgICB0aW1lb3V0PTUKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcGluX3BvcHVwOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUGjDoXQgaGnhu4duIHBvcHVwIFBJTiBUaWtUb2ssIMSRYW5nIG5o4bqtcCBtw6MuLi4iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIHbDoG8gc+G7kSAiMSIgCiAgICAgICAgICAgICAgICBkaWdpdF8xID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IjEiKQogICAgICAgICAgICAgICAgaWYgZGlnaXRfMToKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoZGlnaXRfMSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTmjhuq1wIG3DoyBQSU4gMTIzNAogICAgICAgICAgICAgICAgICAgIGZvciBkaWdpdCBpbiBbIjEiLCIyIiwgIjMiLCAiNCJdOgogICAgICAgICAgICAgICAgICAgICAgICBkaWdpdF9lbGVtZW50ID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50cyh0ZXh0PWRpZ2l0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBkaWdpdF9lbGVtZW50IGFuZCBsZW4oZGlnaXRfZWxlbWVudCkgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGRpZ2l0X2VsZW1lbnRbbGVuKGRpZ2l0X2VsZW1lbnQpLTFdKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDAuNSkKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgc+G7kSB7ZGlnaXR9IHRyb25nIHBvcHVwIFBJTiIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQodGV4dD0iUXVheSBs4bqhaSB0aWt0b2siLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBuaOG6rXAgbcOjIFBJTiAxMjM0IikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikgICMgQ2jhu50gcG9wdXAgxJHDs25nCgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJUw6xtIHRo4bqleSBwb3B1cCBQSU4gbmjGsG5nIGtow7RuZyB0w6xtIHRo4bqleSBz4buRIDEiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoIktow7RuZyBjw7MgcG9wdXAgUElOIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkga2nhu4NtIHRyYSBwb3B1cCBQSU46IHtlfSIpCiAgICAKICAgIGRlZiBwb3N0X25ld2ZlZWQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDEg25nIHZpZGVvIGNobyBUaWtUb2sgLSBwbGFjZWhvbGRlciBtZXRob2QgxJHhu4MgxJHhu5NuZyBuaOG6pXQgduG7m2kgSW5zdGFncmFtCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSAocGxhY2Vob2xkZXIgaW1wbGVtZW50YXRpb24pCiAgICAgICAgIiIiCgogICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBhY2MgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGlmIGFjYyA9PSJuZGQxMTg5MCI6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgxJHEg25nIHZpZGVvIGNobyBUaWtUb2sgdMOgaSBraG/huqNuOiB7YWNjfSIpCgogICAgICAgICMgQsaw4bubYyAxOiBC4bqlbSBxdWF5CiAgICAgICAgbmV4dF9idXR0b24yID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IlF1YXkiLCB0aW1lb3V0PTUpCiAgICAgICAgaWYgbm90IG5leHRfYnV0dG9uMjoKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IFF1YXkgxJHhu4MgxJHEg25nIHZpZGVvIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDIgYuG6pW0gY2hvIHBow6lwCiAgICAgICAgd2hpbGUgc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChyZXNvdXJjZV9pZD0iY29tLmFuZHJvaWQucGFja2FnZWluc3RhbGxlcjppZC9wZXJtaXNzaW9uX2FsbG93X2J1dHRvbiIsIHRpbWVvdXQ9NSk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkLhuqVtIG7DunQgY2hvIHBow6lwLi4uIikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgogICAgICAgICNCxrDhu5tjIDMgYuG6pW0gdsOgbyBi4buZIHPGsHUgdOG6rXAKICAgICAgICByZWNvcmRfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudChjb250ZW50X2Rlc2M9IlF1YXkgdmlkZW8iLCB0aW1lb3V0PTEwKQogICAgICAgIGlmIG5vdCByZWNvcmRfYnV0dG9uOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgJ1F1YXkgdmlkZW8nIikKICAgICAgICAgICAgY2xvc2VfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQw7NuZyIsIHRpbWVvdXQ9MikKICAgICAgICAgICAgaWYgY2xvc2VfYnV0dG9uOgogICAgICAgICAgICAgICAgY2xvc2VfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQw7NuZyIsIHRpbWVvdXQ9MikKICAgICAgICAgICAgaWYgY2xvc2VfYnV0dG9uOgogICAgICAgICAgICAgICAgY2xvc2VfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQw7NuZyIsIHRpbWVvdXQ9MikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDI6IFJhbmRvbSBz4buRIGzGsOG7o25nIOG6o25oIHbDoCB04bqjaSB24buBCiAgICAgICAgaW1hZ2VfY291bnQgPSByYW5kb20ucmFuZGludCgzLCA1KQogICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJSYW5kb20ge2ltYWdlX2NvdW50fSDhuqNuaCDEkeG7gyDEkcSDbmcgYsOgaSIpCiAgICAgICAgaWYgbm90IHNlbGYuaGVscGVyLmRvd25sb2FkX2ltYWdlKGNvdW50PWltYWdlX2NvdW50KToKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiVOG6o2kg4bqjbmggdGjhuqV0IGLhuqFpLCBi4buPIHF1YSDEkcSDbmcgYsOgaSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQoKICAgICAgICAjIEzhuqV5IGJvdW5kcyBj4bunYSByZWNvcmRfYnV0dG9uIHbDoCB0w61uaCB0b8OhbiB04buNYSDEkeG7mQogICAgICAgIGJvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhyZWNvcmRfYnV0dG9uKQogICAgICAgIHgxLCB5MSwgeDIsIHkyID0gYm91bmRzCiAgICAgICAgeSA9ICh5MSArIHkyKSAvLyAyICAjIHkg4bufIGdp4buvYSBj4bunYSBlbGVtZW50CiAgICAgICAgeCA9IHgyICAjIHgg4bufIGPhuqFuaCBwaOG6o2kKICAgICAgICB0YXBfeCA9IHggKyA2MCAgIyB4ICsgNjAKICAgICAgICB0YXBfeSA9IHkKCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRhcCB2w6BvIHThu41hIMSR4buZICh7dGFwX3h9LCB7dGFwX3l9KSAtIGPhuqFuaCBwaOG6o2kgY+G7p2EgbsO6dCBRdWF5IHZpZGVvICsgNjBweCIpCiAgICAgICAgc2VsZi5oZWxwZXIudGFwKHRhcF94LCB0YXBfeSkKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgNCBi4bqlbSBjaG8gcGjDqXAKICAgICAgICB3aGlsZSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHJlc291cmNlX2lkPSJjb20uYW5kcm9pZC5wYWNrYWdlaW5zdGFsbGVyOmlkL3Blcm1pc3Npb25fYWxsb3dfYnV0dG9uIiwgdGltZW91dD01KToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiQuG6pW0gbsO6dCBjaG8gcGjDqXAuLi4iKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAKICAgICAgICAjIELGsOG7m2MgNSBjaOG7jW4g4bqjbmgKICAgICAgICAjIFTDrG0gR3JpZFZpZXcgxJHhu4MgY2jhu41uIOG6o25oCiAgICAgICAgZ3JpZF92aWV3ID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkdyaWRWaWV3IikKICAgICAgICBpZiBub3QgZ3JpZF92aWV3OgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IEdyaWRWaWV3IMSR4buDIGNo4buNbiDhuqNuaCIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICMgTOG6pXkgdOG6pXQgY+G6oyBjw6FjIGJ1dHRvbiBsw6AgY29uIGPhu6dhIEdyaWRWaWV3CiAgICAgICAgYnV0dG9uc19pbl9ncmlkID0gc2VsZi5oZWxwZXIuZmluZF9jaGlsZF9lbGVtZW50cyhncmlkX3ZpZXcsIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHtsZW4oYnV0dG9uc19pbl9ncmlkKX0gYnV0dG9uIHRyb25nIEdyaWRWaWV3IikKICAgICAgICBpZiBub3QgYnV0dG9uc19pbl9ncmlkIG9yIGxlbihidXR0b25zX2luX2dyaWQpID09IDA6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgY8OzIOG6o25oIG7DoG8gdHJvbmcgR3JpZFZpZXcgxJHhu4MgY2jhu41uIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBDaOG7jW4gdOG7qyBpdGVtIHThu6sgMCDEkeG6v24gaW1hZ2VfY291bnQtMQogICAgICAgIGl0ZW1zX3RvX3NlbGVjdCA9IG1pbihpbWFnZV9jb3VudCwgbGVuKGJ1dHRvbnNfaW5fZ3JpZCkpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkNo4buNbiB7aXRlbXNfdG9fc2VsZWN0fSDhuqNuaCB04burIEdyaWRWaWV3IikKICAgICAgICBmb3IgaSBpbiByYW5nZShpdGVtc190b19zZWxlY3QpOgogICAgICAgICAgICBidXR0b24gPSBidXR0b25zX2luX2dyaWRbaV0KICAgICAgICAgICAgc2VsZi5sb2dnZXIuZGVidWcoZiJDaOG7jW4g4bqjbmggdGjhu6kge2krMX0iKQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnV0dG9uKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQoKICAgICAgICAjIFTDrG0gdsOgIGLhuqVtIG7DunQgQXV0b0N1dAogICAgICAgIG5leHRfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF90b190YXBfZWxlbWVudCh0ZXh0PSJBdXRvQ3V0IiwgdGltZW91dD01KQogICAgICAgIGlmIG5vdCBuZXh0X2J1dHRvbjoKICAgICAgICAgICAgbmV4dF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iQXV0b0N1dCIsIHRpbWVvdXQ9NSkKICAgICAgICBpZiBub3QgbmV4dF9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCAnQXV0b0N1dCcgc2F1IGtoaSBjaOG7jW4g4bqjbmgiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCgogICAgICAgICMgQ2jhu50gaGnhu4d1IOG7qW5nICLEkGFuZyB44butIGzDvS4uLiIgaG/DoG4gdOG6pXQKICAgICAgICB3YWl0X2NvdW50PTAKICAgICAgICB3aGlsZSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9IsSQYW5nIHjhu60gbMO9Li4uIiwgdGltZW91dD0yKSA6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQYW5nIHjhu60gbMO9Li4uIikKICAgICAgICAgICAgd2FpdF9jb3VudCArPSAxCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICBpZiB3YWl0X2NvdW50ID49IDIwMDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJDaOG7nSBxdcOhIGzDonUgY2hvIGhp4buHdSDhu6luZyAnxJBhbmcgeOG7rSBsw70uLi4nLCBi4buPIHF1YSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBwYWNrYWdlIGhp4buHbiB04bqhaQogICAgICAgIGN1cnJlbnRfcGFja2FnZSA9IHNlbGYuaGVscGVyLmdldF9jdXJyZW50X3BhY2thZ2UoKQogICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiUGFja2FnZSBoaeG7h24gdOG6oWkgKHtjdXJyZW50X3BhY2thZ2V9KSBraMO0bmcgxJHDum5nLCBt4bufIGzhuqFpIGFwcCBUaWtUb2suLi4iKQogICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSBwYWNrYWdlIHNhdSBraGkgbeG7nyBhcHAKICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJW4bqrbiBraMO0bmcgbeG7nyDEkcaw4bujYyBhcHAgVGlrVG9rIMSRw7puZyBjw6FjaCwgcGFja2FnZSBoaeG7h24gdOG6oWk6IHtjdXJyZW50X3BhY2thZ2V9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBt4bufIGzhuqFpIGFwcCBUaWtUb2sgdGjDoG5oIGPDtG5nIikKCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBjw7MgdGV4dCAiTmjhuq10IGvDvSBj4bunYSBi4bqhbiIgdsOgICJ0aeG6v3AiIMSR4buDIHRp4bq/cCB04bulYwogICAgICAgIGRpYXJ5X3RleHQgPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KHRleHQ9Ik5o4bqtdCBrw70gY+G7p2EgYuG6oW4iLCB0aW1lb3V0PTUpCiAgICAgICAgY29udGludWVfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PSJUaeG6v3AiLCB0aW1lb3V0PTIpCgogICAgICAgIGlmIG5vdCBkaWFyeV90ZXh0IG9yIG5vdCBjb250aW51ZV9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKCJLaMO0bmcgdMOsbSB0aOG6pXkgJ05o4bqtdCBrw70gY+G7p2EgYuG6oW4nIGhv4bq3YyBuw7p0ICd0aeG6v3AnLCBraMO0bmcgdGjhu4MgdGnhur9wIHThu6VjIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICMgQ2jhu50gUmVjeWNsZXJWaWV3IHh14bqldCBoaeG7h24gdsOgIHRhcCB2w6BvIG7DswogICAgICAgIHJlY3ljbGVyX3ZpZXcgPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KGNsYXNzX25hbWU9ImFuZHJvaWR4LnJlY3ljbGVydmlldy53aWRnZXQuUmVjeWNsZXJWaWV3IiwgdGltZW91dD01KQogICAgICAgIGlmIHJlY3ljbGVyX3ZpZXc6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlTDrG0gdGjhuqV5IFJlY3ljbGVyVmlldywgxJFhbmcgdGFwIHbDoG8uLi4iKQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIocmVjeWNsZXJfdmlldykKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEwKQoKICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoY29udGludWVfYnV0dG9uKQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQoKCiAgICAgICAgIyBLaeG7g20gdHJhIGPDsyB0ZXh0ICJUaMOqbSBtw7QgdOG6oy4uLiIgdsOgIGLhuqVtIHbDoG8gxJHDsyDEkeG7gyB0aMOqbSBoYXNodGFnCiAgICAgICAgYWRkX2Rlc2NyaXB0aW9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IlRow6ptIG3DtCB04bqjLi4uIikKICAgICAgICBpZiBhZGRfZGVzY3JpcHRpb246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlTDrG0gdGjhuqV5ICd0aMOqbSBtw7QgdOG6oy4uLicsIMSRYW5nIGLhuqVtIHbDoG8gxJHhu4MgdGjDqm0gaGFzaHRhZyIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihhZGRfZGVzY3JpcHRpb24pCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSYW5kb20gY2jhu41uIDEgaGFzaHRhZyB04burIGRhbmggc8OhY2gKICAgICAgICAgICAgaGFzaHRhZ3MgPSBbCiAgICAgICAgICAgICAgICAiI3h1aHVvbmciLCAiI3Rpa3Rva3ZuIiwgIiN0cmVuZGluZyIsICIjbGlmZXZuIiwgIiNjdW9jc29uZyIsIAogICAgICAgICAgICAgICAgIiNhbW5oYWMiLCAiI3Rpbmh5ZXUiLCAiI25obyIsICIjdGhhbmh4dWFuIiwgIiNidW9uIiwgIiN2dWkiLCAKICAgICAgICAgICAgICAgICIjaGFuaHBodWMiLCAiI2NhbXh1YyIsICIjbmdheW1vaSIsICIjbXVhaGUiLCAiI3RodWdpYW4iLCAKICAgICAgICAgICAgICAgICIjY2hpbGwiLCAiI21vdG5nYXljdWF0b2kiCiAgICAgICAgICAgIF0KICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGVjdGVkX2hhc2h0YWcgPSByYW5kb20uY2hvaWNlKGhhc2h0YWdzKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTmjhuq1wIGhhc2h0YWc6IHtzZWxlY3RlZF9oYXNodGFnfSIpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLmlucHV0X3RleHQoc2VsZWN0ZWRfaGFzaHRhZykKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2VudGVyKCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiS2jDtG5nIHTDrG0gdGjhuqV5ICd0aMOqbSBtw7QgdOG6oy4uLicsIGLhu48gcXVhIGLGsOG7m2MgdGjDqm0gaGFzaHRhZyIpCgogICAgICAgICMgVMOsbSB2w6AgYuG6pW0gbsO6dCDEkMSDbmcKICAgICAgICBwb3N0X2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfdG9fdGFwX2VsZW1lbnQoY29udGVudF9kZXNjPSLEkMSDbmciLCB0aW1lb3V0PTEwKQogICAgICAgIGlmIG5vdCBwb3N0X2J1dHRvbjoKICAgICAgICAgICAgcG9zdF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X3RvX3RhcF9lbGVtZW50KHRleHQ9IsSQxINuZyIsIHRpbWVvdXQ9NSkKICAgICAgICAgICAgaWYgbm90IHBvc3RfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0ICfEkMSDbmcnIMSR4buDIGhvw6BuIHRow6BuaCDEkcSDbmcgdmlkZW8iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxMCkKICAgICAgICBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkhvw6BuIHRow6BuaCDEkcSDbmcgdmlkZW8gY2hvIFRpa1RvayB0w6BpIGtob+G6o246IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKX0iKQogICAgICAgIHJldHVybiBUcnVlCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgICMgQ0FSRSBBQ1RJT05TIElNUExFTUVOVEFUSU9OIChBQlNUUkFDVCBNRVRIT0RTIEZST00gQkFTRSkKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0KICAgIAogICAgZGVmIHBlcmZvcm1fbmV3c2ZlZWRfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRo4buxYyBoaeG7h24gdnXhu5F0IG5ld3NmZWVkL0ZvciBZb3UgZmVlZCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBtZXRob2QgY8OzIHPhurVuIF9jYXJlX3N3aXBlX2ZlZWQKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhcmVfc3dpcGVfZmVlZChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgcGVyZm9ybV9uZXdzZmVlZF9hY3Rpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcGVyZm9ybV9yZWVsc19hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiB4ZW0gdmlkZW8vcmVlbHMgKFRpa1RvayBt4bq3YyDEkeG7i25oIGzDoCB2aWRlbykiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGPDsyBz4bq1biBfY2FyZV93YXRjaF92aWRlb3MKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhcmVfd2F0Y2hfdmlkZW9zKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtX3JlZWxzX2FjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX25vdGlmaWNhdGlvbl9hY3Rpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiB4ZW0gdGjDtG5nIGLDoW8vaW5ib3giIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGPDsyBz4bq1biBfY2FyZV92aWV3X25vdGlmaWNhdGlvbnMKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhcmVfdmlld19ub3RpZmljYXRpb25zKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtX25vdGlmaWNhdGlvbl9hY3Rpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcGVyZm9ybV9wcm9maWxlX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiJUaOG7sWMgaGnhu4duIHhlbSBwcm9maWxlIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIE5hdmlnYXRlIMSR4bq/biBwcm9maWxlIHRhYgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fbmF2aWdhdGVfdG9fcHJvZmlsZV90YWIoKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSB0aOG7nWkgZ2lhbiB4ZW0gcHJvZmlsZQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oNSwgMTUpKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgcGVyZm9ybV9wcm9maWxlX2FjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX2V4cGxvcmVfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRo4buxYyBoaeG7h24ga2jDoW0gcGjDoSAoRGlzY292ZXIgdGFiKSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBOYXZpZ2F0ZSDEkeG6v24gRGlzY292ZXIgdGFiIChu4bq/dSBjw7MpCiAgICAgICAgICAgIGRpc2NvdmVyX2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoY29udGVudF9kZXNjPSJLaMOhbSBwaMOhIiwgdGltZW91dD01KQogICAgICAgICAgICBpZiBub3QgZGlzY292ZXJfYnV0dG9uOgogICAgICAgICAgICAgICAgZGlzY292ZXJfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PSJLaMOhbSBwaMOhIiwgdGltZW91dD01KQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGlzY292ZXJfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGRpc2NvdmVyX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFNjcm9sbCB0cm9uZyBkaXNjb3ZlciBmZWVkIC0gdGhheSBzd2lwZV9kb3duIGLhurFuZyBzd2lwZV91cAogICAgICAgICAgICAgICAgc2Nyb2xsX2NvdW50ID0gcmFuZG9tLnJhbmRpbnQoNSwgMTUpCiAgICAgICAgICAgICAgICBmb3IgXyBpbiByYW5nZShzY3JvbGxfY291bnQpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oMSwgNSkpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogc2Nyb2xsIEZvciBZb3UgZmVlZAogICAgICAgICAgICAgICAgcmV0dXJuIHNlbGYucGVyZm9ybV9uZXdzZmVlZF9hY3Rpb24oYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIHBlcmZvcm1fZXhwbG9yZV9hY3Rpb246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcGVyZm9ybV9zZWFyY2hfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRo4buxYyBoaeG7h24gdMOsbSBraeG6v20iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSBzZWFyY2ggYnV0dG9uCiAgICAgICAgICAgIHNlYXJjaF9idXR0b24gPSBzZWxmLmhlbHBlci53YWl0X2Zvcl9lbGVtZW50KGNvbnRlbnRfZGVzYz0iVMOsbSBraeG6v20iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIGlmIG5vdCBzZWFyY2hfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VhcmNoX2J1dHRvbiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQodGV4dD0iVMOsbSBraeG6v20iLCB0aW1lb3V0PTUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBzZWFyY2hfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlYXJjaF9idXR0b24pCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBHaeG6oyBs4bqtcCB0w6xtIGtp4bq/bQogICAgICAgICAgICAgICAgc2VhcmNoX3Rlcm1zID0gWyJnYWl4aW5oIiwiZ2FpX3hpbmgiLCJob3RnaXJsIiwiaG90Z2lybHZuIiwidmlldG5hbWdpcmwiLCJwcmV0dHlnaXJsIiwKImN1dGVnaXJsIiwieGluaGdhaSIsIm1vZGVsIiwiaW5mbHVlbmNlciIsInNlbGZpZSIsIm1ha2V1cCIsInNraW5jYXJlIiwib290ZCIsImZhc2hpb24iLAoic3R5bGUiLCJoYWlyIiwiZ2xvd3VwIiwidmlyYWxnaXJsIiwidGlrdG9rZ2lybHMiLCJ0aWt0b2tnaXJsIiwidmlldG5hbWVzZSIsInBvcnRyYWl0IiwKImRhbmNlZ2lybCIsImNvc3BsYXlnaXJsIiwiY29sbGVnZWdpcmwiLCJzdHVkZW50Z2lybCIsImJlYXV0eSIsImJlYXV0aWZ1bCIsImN1dGUiLCJzbWlsZSJdCiAgICAgICAgICAgICAgICBzZWFyY2hfdGVybSA9IHJhbmRvbS5jaG9pY2Uoc2VhcmNoX3Rlcm1zKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gc2VhcmNoIGJveAogICAgICAgICAgICAgICAgc2VhcmNoX2JveCA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuRWRpdFRleHQiLCB0aW1lb3V0PTUpCiAgICAgICAgICAgICAgICBpZiBzZWFyY2hfYm94OgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzZWFyY2hfYm94KQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLmlucHV0X3RleHQoc2VhcmNoX3Rlcm0pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIFR1eFRleHRMYXlvdXRWaWV3IHNhdSBraGkgbmjhuq1wIHRleHQKICAgICAgICAgICAgICAgICAgICB0dXhfdGV4dF9lbGVtZW50cyA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudHMoY2xhc3NfbmFtZT0iY29tLmJ5dGVkYW5jZS50dXguaW5wdXQuVHV4VGV4dExheW91dFZpZXciKQogICAgICAgICAgICAgICAgICAgIGlmIHR1eF90ZXh0X2VsZW1lbnRzOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbih0dXhfdGV4dF9lbGVtZW50cyl9IGvhur90IHF14bqjIGfhu6NpIMO9IikKICAgICAgICAgICAgICAgICAgICAgICAgIyBDbGljayB2w6BvIGVsZW1lbnQgxJHhuqd1IHRpw6puICh0aMaw4budbmcgbMOgIHN1Z2dlc3Rpb24gxJHhuqd1IHRpw6puKQogICAgICAgICAgICAgICAgICAgICAgICAjIENsaWNrIHbDoG8gZWxlbWVudCBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgICAgICAgICAgICAgIHJhbmRvbV9lbGVtZW50ID0gcmFuZG9tLmNob2ljZSh0dXhfdGV4dF9lbGVtZW50cykKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHJhbmRvbV9lbGVtZW50KQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19lbnRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgU2Nyb2xsIGvhur90IHF14bqjIHNlYXJjaCAtIHRoYXkgc3dpcGVfZG93biBi4bqxbmcgc3dpcGVfdXAKICAgICAgICAgICAgICAgICAgICBzY3JvbGxfY291bnQgPSByYW5kb20ucmFuZGludCgxLCA4KQogICAgICAgICAgICAgICAgICAgIGZvciBfIGluIHJhbmdlKHNjcm9sbF9jb3VudCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHJhbmRvbS51bmlmb3JtKDEsIDIpKQogICAgICAgICAgICAgICAgICAgICAgICAjIFJhbmRvbSA1MCUgdGFwIHbDoG8gYW5kcm9pZC53aWRnZXQuR3JpZFZpZXcgdsOgIGThu6tuZyB04burIDEwLTMwcwogICAgICAgICAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZG9tKCkgPCAwLjU6ICAjIDUwJSBwcm9iYWJpbGl0eQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JpZF92aWV3ID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkdyaWRWaWV3IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGdyaWRfdmlldzoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJSYW5kb20gdGFwIHbDoG8gR3JpZFZpZXcuLi4iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihncmlkX3ZpZXcpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2FpdF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMTAsIDMwKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJE4burbmcge3dhaXRfdGltZX1zIHNhdSBraGkgdGFwIEdyaWRWaWV3IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2FpdF90aW1lKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgRmFsbGJhY2sKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgxMCwgMzApKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkzhu5dpIHBlcmZvcm1fc2VhcmNoX2FjdGlvbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBwZXJmb3JtX3Bvc3RfYWN0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRo4buxYyBoaeG7h24gxJHEg25nIGLDoGkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGPDsyBz4bq1biBwb3N0X25ld2ZlZWQKICAgICAgICAgICAgcmV0dXJuIHNlbGYucG9zdF9uZXdmZWVkKGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBwZXJmb3JtX3Bvc3RfYWN0aW9uOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQogICAgIyBBUFAgTUFOQUdFTUVOVCBJTVBMRU1FTlRBVElPTiAoQUJTVFJBQ1QgTUVUSE9EUyBGUk9NIEJBU0UpCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09CiAgICAKICAgIGRlZiBvcGVuX2FwcChzZWxmKSAtPiBib29sOgogICAgICAgICIiIk3hu58gVGlrVG9rIGFwcCIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGFwcCDEkcOjIG3hu58gY2jGsGEKICAgICAgICAgICAgY3VycmVudF9wYWNrYWdlID0gc2VsZi5oZWxwZXIuZ2V0X2N1cnJlbnRfcGFja2FnZSgpCiAgICAgICAgICAgIHJldHVybiBjdXJyZW50X3BhY2thZ2UgPT0gc2VsZi5hcHBfcGFja2FnZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kgb3Blbl9hcHA6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcGVyZm9ybV9saXZlX2FjdGlvbihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBBY3Rpb24gcmnDqm5nIGPhu6dhIFRpa1RvazogWGVtIGxpdmVzdHJlYW0KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIikKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlhlbSBsaXZlc3RyZWFtIFRpa1RvayBjaG8ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDhu58gaG9tZSBzY3JlZW4KICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIGhvbWUgc2NyZWVuIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHbDoCBjbGljayB2w6BvIHRhYiBMSVZFIG7hur91IGPDswogICAgICAgICAgICBsaXZlX3RhYl9mb3VuZCA9IEZhbHNlCiAgICAgICAgICAgIGxpdmVfc2VsZWN0b3JzID0gWwogICAgICAgICAgICAgICAgeyJ0ZXh0IjogIkxJVkUifSwKICAgICAgICAgICAgICAgIHsidGV4dCI6ICJMaXZlIn0sCiAgICAgICAgICAgICAgICB7ImNvbnRlbnRfZGVzYyI6ICJMSVZFIn0sCiAgICAgICAgICAgICAgICB7ImNvbnRlbnRfZGVzYyI6ICJMaXZlIn0KICAgICAgICAgICAgXQogICAgICAgICAgICAKICAgICAgICAgICAgZm9yIHNlbGVjdG9yIGluIGxpdmVfc2VsZWN0b3JzOgogICAgICAgICAgICAgICAgaWYgc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCgqKnNlbGVjdG9yLCB0aW1lb3V0PTMpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsaWNrX2VsZW1lbnQoKipzZWxlY3RvcikKICAgICAgICAgICAgICAgICAgICBsaXZlX3RhYl9mb3VuZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIGNsaWNrIHbDoG8gdGFiIExJVkUiKQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgbGl2ZV90YWJfZm91bmQ6CiAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSB0YWIgTElWRSwgc2Nyb2xsIGRvd24gxJHhu4MgdMOsbSBsaXZlc3RyZWFtIHRyb25nIEZvciBZb3UKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIktow7RuZyB0w6xtIHRo4bqleSB0YWIgTElWRSwgdMOsbSBsaXZlc3RyZWFtIHRyb25nIEZvciBZb3UiKQogICAgICAgICAgICAgICAgc2Nyb2xsX2F0dGVtcHRzID0gMAogICAgICAgICAgICAgICAgbWF4X3Njcm9sbHMgPSA1CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHdoaWxlIHNjcm9sbF9hdHRlbXB0cyA8IG1heF9zY3JvbGxzOgogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIGxpdmUgaW5kaWNhdG9yIGtow7RuZyAoZOG6pXUgaGnhu4d1IGxpdmVzdHJlYW0pCiAgICAgICAgICAgICAgICAgICAgbGl2ZV9pbmRpY2F0b3JzID0gWwogICAgICAgICAgICAgICAgICAgICAgICB7InRleHQiOiAiTElWRSJ9LAogICAgICAgICAgICAgICAgICAgICAgICB7ImNvbnRlbnRfZGVzYyI6ICJMSVZFIn0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsidGV4dCI6ICLEkWFuZyBwaMOhdCB0cuG7sWMgdGnhur9wIn0sCiAgICAgICAgICAgICAgICAgICAgICAgIHsidGV4dCI6ICJ2aWV3ZXJzIn0KICAgICAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm91bmRfbGl2ZSA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgZm9yIGluZGljYXRvciBpbiBsaXZlX2luZGljYXRvcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoKippbmRpY2F0b3IsIHRpbWVvdXQ9MSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3VuZF9saXZlID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgbGl2ZXN0cmVhbSB0cm9uZyBGb3IgWW91IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgZm91bmRfbGl2ZToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFNjcm9sbCBkb3duIMSR4buDIHTDrG0gdmlkZW8gdGnhur9wIHRoZW8KICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV9kb3duKCkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAocmFuZG9tLnVuaWZvcm0oMiwgNCkpCiAgICAgICAgICAgICAgICAgICAgc2Nyb2xsX2F0dGVtcHRzICs9IDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgWGVtIGxpdmVzdHJlYW0gdHJvbmcgbeG7mXQga2hv4bqjbmcgdGjhu51pIGdpYW4gbmfhuqt1IG5oacOqbgogICAgICAgICAgICB3YXRjaF9kdXJhdGlvbiA9IHJhbmRvbS51bmlmb3JtKDEwLCAzMCkgICMgMTAtMzAgZ2nDonkKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlhlbSBsaXZlc3RyZWFtIHRyb25nIHt3YXRjaF9kdXJhdGlvbjouMWZ9IGdpw6J5IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ8OzIHRo4buDIHRo4buxYyBoaeG7h24gbeG7mXQgc+G7kSB0xrDGoW5nIHTDoWMgbmjhurkKICAgICAgICAgICAgaWYgcmFuZG9tLnJhbmRvbSgpIDwgMC4zOiAgIyAzMCUgY8ahIGjhu5lpIHTGsMahbmcgdMOhYwogICAgICAgICAgICAgICAgaW50ZXJhY3Rpb25fYWN0aW9ucyA9IFsKICAgICAgICAgICAgICAgICAgICBsYW1iZGE6IHNlbGYuaGVscGVyLnRhcF9zY3JlZW4ocmFuZG9tLnJhbmRpbnQoMjAwLCA4MDApLCByYW5kb20ucmFuZGludCg0MDAsIDgwMCkpLCAgIyBUYXAgbmfhuqt1IG5oacOqbgogICAgICAgICAgICAgICAgICAgIGxhbWJkYTogTm9uZSAgIyBLaMO0bmcgbMOgbSBnw6wKICAgICAgICAgICAgICAgIF0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgYWN0aW9uID0gcmFuZG9tLmNob2ljZShpbnRlcmFjdGlvbl9hY3Rpb25zKQogICAgICAgICAgICAgICAgYWN0aW9uKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTbGVlcCDEkeG7gyB4ZW0gbGl2ZXN0cmVhbQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2F0Y2hfZHVyYXRpb24pCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIHhlbSBsaXZlc3RyZWFtIFRpa1RvayBjaG8ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgeGVtIGxpdmVzdHJlYW0gVGlrVG9rOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgcmV0dXJuIEZhbHNl').decode('utf-8'))
