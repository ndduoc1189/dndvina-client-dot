import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKZnJvbSBzZXJ2aWNlcy5wcm94eV9zZXJ2aWNlIGltcG9ydCBQcm94eVNlcnZpY2UKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19DT05USU5VT1VTID0gIsSQYW5nIGzDoG0gdmnhu4djIGxpw6puIHThu6VjIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIG5nw6B5IgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgLSBs4bqleSB04burIGRhdGFiYXNlIGhv4bq3YyBjb25maWcKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIHRoZW8gYWNjb3VudF9pZAogICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Agam9iIGZvbGxvdyB0cuG6oyB24buBIHN0YXR1cyA0IChwZW5kaW5nKQogICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBi4buLIHVuZm9sbG93L3VubGlrZSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyBxdXnhur90IMSR4buLbmggbmjhuqMgcHJveHkKICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJHDoyByZXNldCBJUCBwcm94eSDEkeG7gyB0csOhbmggcmVzZXQgbOG6t3AgbOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcCDEkeG7gyB0csOhbmggc3dpdGNoIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyA9IHt9ICAjIHthcHBfbmFtZTogYWNjb3VudF9pZH0KICAgICAgICAKICAgICAgICAjIEZsYWcgxJHhu4MgdHJhY2sgeGVtIMSRw6MgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCBjaMawYSBraGkga2jhu59pIMSR4buZbmcKICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCA9IHt9ICAjIHthcHBfbmFtZTogYm9vbH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgbMOgbSB2aeG7h2MgxJHhu4MgdHLDoW5oIHF1w6l0IGzhuqFpIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgIGRlZiBfdmVyaWZ5X2N1cnJlbnRfYWNjb3VudF9vbl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0ciwgaGFuZGxlcikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyIGPhu6dhIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4gYXBwLCBOb25lIG7hur91IGtow7RuZyBjw7MgaG/hurdjIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihoYW5kbGVyLCAnZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lJyk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkhhbmRsZXIge2FwcF9uYW1lfSBraMO0bmcgaOG7lyB0cuG7oyBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB04burIFVJCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJykgPT0gY3VycmVudF9hY2NvdW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZpZWQ6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50X3VzZXJuYW1lfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBuaMawbmcga2jDtG5nIGPDsyB0cm9uZyBEQiIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBjdXJyZW50IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiB0cm9uZyBEQiB24bubaSB0aOG7sWMgdOG6vyB0csOqbiBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiBhcHAKICAgICAgICAgICAgaGFuZGxlcjogSm9iIGhhbmRsZXIgY+G7p2EgYXBwCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIHZlcmlmeSBhY2NvdW50IChu4bq/dSBj4bqnbikKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5lbnN1cmVfcHJveHlfaWZfbmVlZGVkKGYiVmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSIpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIHZlcmlmeSBhY2NvdW50IHRyw6puIHthcHBfbmFtZX0sIGLhu48gcXVhIHZlcmlmeSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbgogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLl92ZXJpZnlfY3VycmVudF9hY2NvdW50X29uX2FwcChhcHBfbmFtZSwgaGFuZGxlcikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY+G7p2EgYXBwIG7DoHkgduG7gSBsb2dnZWRfaW4gPSBGYWxzZSB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgcmVzZXRfY291bnQgPSAwCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImxvZ2dlZF9pbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsibG9nZ2VkX2luIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgIHJlc2V0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBsb2dnZWRfaW4gPSBGYWxzZSBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc2V0X2NvdW50ID4gMDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQge3Jlc2V0X2NvdW50fSB0w6BpIGtob+G6o24gduG7gSBsb2dnZWRfaW4gPSBGYWxzZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4KICAgICAgICAgICAgaWYgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChjdXJyZW50X2FjY291bnRbImlkIl0sIHsibG9nZ2VkX2luIjogVHJ1ZX0pCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGN1cnJlbnRfYWNjb3VudFsiaWQiXQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTeW5jIHRy4bqhbmcgdGjDoWk6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IMSRYW5nIGxvZ2luIHRo4bqtdCB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBsb2dpbgogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyB0cuG6oW5nIHRow6FpOiBLaMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgc3luYyBsb2dpbiBzdGF0dXMgY2hvIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9mb3JjZV92ZXJpZnlfYWNjb3VudHNfd2l0aF9wcm94eShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBGb3JjZSB2ZXJpZnkgdOG6pXQgY+G6oyBhY2NvdW50IGtoaSDEkcOjIGPDsyBwcm94eSAoZ+G7jWkga2hpIHRo4buxYyBz4buxIGPhuqduIHRoaeG6v3QpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzIGFuZCBhcHBfbmFtZSBub3QgaW4gc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJGb3JjZSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX0gduG7m2kgcHJveHkuLi4iKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50X2xvZ2luX3N0YXR1c193aXRoX3JlYWxpdHkoYXBwX25hbWUsIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmb3JjZSB2ZXJpZnkgdMOgaSBraG/huqNuIHRyw6puIHthcHBfbmFtZX06IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGZvcmNlIHZlcmlmeSBhY2NvdW50czoge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX2lzX2N1cnJlbnRfYWNjb3VudF9zdGlsbF93b3JrYWJsZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgY8OzIGPDsm4gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB24bqrbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MsIEZhbHNlIG7hur91IGPhuqduIHTDrG0gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gbeG7m2kgbmjhuqV0IHThu6sgREIKICAgICAgICAgICAgYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBjdXJyZW50X2FjY291bnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24gSUQge2FjY291bnRfaWR9IGtow7RuZyBjw7JuIHThu5NuIHThuqFpIHRyb25nIERCIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyBjw7JuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAgICAgY2FuX3dvcmsgPSBzZWxmLl9jYW5fcnVuX2pvYihjdXJyZW50X2FjY291bnQpCiAgICAgICAgICAgIGlmIGNhbl93b3JrOgogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIHbhu5tpIGRhdGEgbeG7m2kgbmjhuqV0CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gY3VycmVudF9hY2NvdW50CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBraMO0bmcgdGjhu4MgbMOgbSB2aeG7h2MgbuG7r2EsIGPhuqduIHTDrG0gdMOgaSBraG/huqNuIGtow6FjIikKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaToge2V9IikKICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgc2FmZV9zbGVlcChzZWxmLCBzZWNvbmRzOiBmbG9hdCkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBOZ+G7pyBhbiB0b8OgbiwgY8OzIHRo4buDIGThu6tuZyBs4bqhaSBuZ2F5IGzhuq1wIHThu6ljIGtoaSBmb3JjZV9zdG9wIMSRxrDhu6NjIMSR4bq3dCB0aMOgbmggVHJ1ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHNlY29uZHM6IFPhu5EgZ2nDonkgY+G6p24gbmfhu6cKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuZ+G7pyDEkeG7pyB0aOG7nWkgZ2lhbiwgRmFsc2UgbuG6v3UgYuG7iyBk4burbmcgbOG6oWkKICAgICAgICAiIiIKICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICBjaGVja19pbnRlcnZhbCA9IEpvYlNlcnZpY2VDb25zdGFudHMuREVGQVVMVF9DSEVDS19JTlRFUlZBTCAgIyBLaeG7g20gdHJhIG3hu5dpIDAuNSBnacOieQogICAgICAgIAogICAgICAgIHdoaWxlIHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSA8IHNlY29uZHM6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBjw7MgecOqdSBj4bqndSBk4burbmcKICAgICAgICAgICAgd2l0aCBzZWxmLl9sb2NrOgogICAgICAgICAgICAgICAgaWYgc2VsZi5mb3JjZV9zdG9wIG9yIG5vdCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE5n4bunIG3hu5l0IGtob+G6o25nIG5n4bqvbgogICAgICAgICAgICBzbGVlcF90aW1lID0gbWluKGNoZWNrX2ludGVydmFsLCBzZWNvbmRzIC0gKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkpCiAgICAgICAgICAgIGlmIHNsZWVwX3RpbWUgPiAwOgogICAgICAgICAgICAgICAgdGltZS5zbGVlcChzbGVlcF90aW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgaW5pdGlhbGl6ZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBKb2JTZXJ2aWNlCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBraOG7n2kgdOG6oW8gdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSBIZWxwZXJTZXJ2aWNlCiAgICAgICAgaGVscGVyX3N1Y2Nlc3MsIGhlbHBlcl9kYXRhID0gdXRpbHMuY2hlY2tfaGVscGVyX3NlcnZpY2Uoc2VsZi5oZWxwZXIpCiAgICAgICAgaWYgbm90IGhlbHBlcl9zdWNjZXNzOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBr4bq/dCBu4buRaSDEkeG6v24gSGVscGVyU2VydmljZS4gVnVpIGzDsm5nIGtp4buDbSB0cmEgbOG6oWkuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyBu4bq/dSBjw7MKICAgICAgICBpZiBoZWxwZXJfZGF0YSBhbmQgImRhdGEiIGluIGhlbHBlcl9kYXRhOgogICAgICAgICAgICBzZWxmLmRiLnNhdmVfZGV2aWNlX2luZm8oaGVscGVyX2RhdGEpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBsxrB1IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLOiB7aGVscGVyX2RhdGFbJ2RhdGEnXS5nZXQoJ2RldmljZV9tb2RlbCcsICdVbmtub3duJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICMgMy4gTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MKICAgICAgICBzZWxmLl9zYXZlX2RlZmF1bHRfY29uZmlncygpCiAgICAgICAgICAgIAogICAgICAgIAogICAgICAgIAogICAgICAgICMgNS4gS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIKICAgICAgICBzZWxmLl9pbml0X2pvYl9oYW5kbGVycygpCiAgICAgICAgCiAgICAgICAgIyA2LiBLaOG7n2kgdOG6oW8gbmfDoHkgY3Xhu5FpIGPDuW5nIMSRw6MgcmVzZXQgbuG6v3UgY2jGsGEgY8OzIHRyb25nIGRhdGFiYXNlCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICByZXNldF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUuY29tYmluZSh0b2RheSwgZGF0ZXRpbWUudGltZShob3VyPWpvYl9ob3VyLCBtaW51dGU9MCkpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmcgdOG7qyBkYXRhYmFzZQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZV9zdHIgPSBzZWxmLmRiLmdldCgibGFzdF9yZXNldF9kYXRlIikKICAgICAgICAKICAgICAgICBpZiBub3QgbGFzdF9yZXNldF9kYXRlX3N0cjoKICAgICAgICAgICAgIyBO4bq/dSBoaeG7h24gdOG6oWkgxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXksIMSRw6FuaCBk4bqldSDEkcOjIHJlc2V0CiAgICAgICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lOgogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gdG9kYXkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTuG6v3UgY2jGsGEgxJHhur9uIGdp4budIHJlc2V0LCDEkcOhbmggZOG6pXUgbMOgIMSRw6MgcmVzZXQgbmfDoHkgaMO0bSBxdWEKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5IC0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgbGFzdF9yZXNldF9kYXRlLmlzb2Zvcm1hdCgpKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkto4bufaSB04bqhbyBuZ8OgeSByZXNldDoge2xhc3RfcmVzZXRfZGF0ZX0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyB0w6xtIHRo4bqleSBuZ8OgeSByZXNldCBjdeG7kWkgY8O5bmc6IHtsYXN0X3Jlc2V0X2RhdGVfc3RyfSIpCiAgICAgICAgCiAgICAgICAgc2VsZi5pc19pbml0aWFsaXplZCA9IFRydWUKICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIHThuqFvIEpvYlNlcnZpY2UgdGjDoG5oIGPDtG5nLiIpCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9zeW5jX3N0YXR1cyhzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6p24gxJHhu5NuZyBi4buZIGzhuqFpLCBGYWxzZSBu4bq/dSBraMO0bmcgY+G6p24KICAgICAgICAiIiIKICAgICAgICAjIEzhuqV5IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgZGF0YWJhc2UKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgc3luY19zdGF0dXMgPSBzZWxmLmRiLmdldChzeW5jX3N0YXR1c19rZXksIEZhbHNlKSAgIyBN4bq3YyDEkeG7i25oIGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICAjIE7hur91IGNoxrBhIMSR4buTbmcgYuG7mSB0aMOsIGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaQogICAgICAgIHJldHVybiBub3Qgc3luY19zdGF0dXMKICAgICAgICAKICAgIGRlZiBfdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0ciwgc3RhdHVzOiBib29sID0gVHJ1ZSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgc3RhdHVzOiBUcnVlIG7hur91IMSRw6MgxJHhu5NuZyBi4buZLCBGYWxzZSBu4bq/dSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAiIiIKICAgICAgICBzeW5jX3N0YXR1c19rZXkgPSBmInthcHBfbmFtZX1fc3luY19zdGF0dXMiCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICBzZWxmLmRiLnNldChzeW5jX3N0YXR1c19rZXksIHN0YXR1cykKICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB7YXBwX25hbWV9OiB7c3RhdHVzfSIpCiAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudHNfZm9yX2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdsOgIG1hcCB0w6BpIGtob+G6o24gR29MaWtlIGNobyBt4buZdCBhcHAgY+G7pSB0aOG7gwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyBj4bqnbiDEkeG7k25nIGLhu5kKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkeG7k25nIGLhu5kgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgIAogICAgICAgIHRyeToKCiAgICAgICAgICAgICMgMS4gxJDhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGFjY291bnRzID0gaGFuZGxlci5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSR4buTbmcgYuG7mSB7bGVuKGFjY291bnRzKX0gdMOgaSBraG/huqNuIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBUcnVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIEZhbHNlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MiIiIKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gdGjhu51pIGdpYW4gbMOgbSBqb2IKICAgICAgICAgICAgImpvYl9ob3VyIjogY29uZmlnLkpPQl9IT1VSLAogICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIFRo4budaSBnaWFuIGNo4budIChwaMO6dCkga2hpIGtow7RuZyB0w6xtIHRo4bqleSBqb2IgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaGnhur90IGzhuq1wIGNobyBwaMOpcCBjaMSDbSBzw7NjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAiY2FyZV9pbl93b3JraW5nX2pvYiI6IEZhbHNlLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCBnacOhIHThu5FpIHRoaeG7g3UgY2hvIGpvYiBmb2xsb3cKICAgICAgICAgICAgIm1pbl9mb2xsb3dfcHJpY2UiOiAyMCwKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggeOG7rSBsw70gdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICJtYXhfdW5mb2xsb3dfYXR0ZW1wdHMiOiBjb25maWcuTUFYX1VORk9MTE9XX0FUVEVNUFRTLAogICAgICAgICAgICAidW5mb2xsb3dfcGVuYWx0eV9taW51dGVzIjogNzIwLCAgIyBN4bq3YyDEkeG7i25oIDEyIGdp4budLCBjw7MgdGjhu4MgxJFp4buBdSBjaOG7iW5oIHThu6sgc2VydmVyCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIHByb3h5CiAgICAgICAgICAgICJ1c2VfcHJveHkiOiBGYWxzZSwgICMgQ8OzIHPhu60gZOG7pW5nIHByb3h5IGtow7RuZwogICAgICAgICAgICAicHJveHlfc2VydmVyIjogImh0dHA6Ly8xMC4wLjAuNTo5MDMyIiwgICMgU2VydmVyIHByb3h5IG3hurdjIMSR4buLbmgKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGVmYXVsdF9jb25maWdzLml0ZW1zKCk6CiAgICAgICAgICAgICMgQ2jhu4kgbMawdSBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoa2V5KSBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6MgbMawdSBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oOiB7a2V5fT17dmFsdWV9IikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkPhuqV1IGjDrG5oIHtrZXl9IMSRw6MgdOG7k24gdOG6oWk6IHtzZWxmLmRiLmdldChrZXkpfSIpCiAgICAgICAgCiAgICBkZWYgX2luaXRfam9iX2hhbmRsZXJzKHNlbGYpOgogICAgICAgICIiIkto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyIiIiCiAgICAgICAgIyBpbml0IHRow6wgc+G6vSBpbml0IGhhbmRsZXJzIGNobyB04bqldCBj4bqjIGPDoWMgYXBwLCBsw6BtIGFwcCBuw6BvIHRow6wgc+G6vSB0aGVvIGPhuqV1IGjDrG5oIGzhuqV5IHThu6sgZGF0YWJhc2UKICAgICAgICBmb3IgYXBwX25hbWUgaW4gY29uZmlnLkVOQUJMRURfQVBQUzoKICAgICAgICAgICAgaWYgYXBwX25hbWUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0gPSBUaWt0b2tKb2Ioc2VsZi5kYiwgc2VsZi5oZWxwZXIsIHNlbGYuZ29saWtlX3NlcnZpY2UpCiAgICAgICAgICAgICAgICAjIFRydXnhu4FuIHBoxrDGoW5nIHRo4bupYyBzYWZlX3NsZWVwIHbDoCBwcm94eV9zZXJ2aWNlIHbDoG8gam9iIGhhbmRsZXIKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfc2xlZXBfZnVuY3Rpb24oc2VsZi5zYWZlX3NsZWVwKQogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9wcm94eV9zZXJ2aWNlKHNlbGYucHJveHlfc2VydmljZSkKICAgICAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAiaW5zdGFncmFtIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IEluc3RhZ3JhbUpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgIHByb3h5X3NlcnZpY2UgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGto4bufaSB04bqhbyB7bGVuKHNlbGYuam9iX2hhbmRsZXJzKX0gam9iIGhhbmRsZXI6IHsnLCAnLmpvaW4oc2VsZi5qb2JfaGFuZGxlcnMua2V5cygpKX0iKQogICAgICAgIAogICAgZGVmIF9yZXNldF9kYWlseV9jb3VudGVycyhzZWxmKToKICAgICAgICAiIiJSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSB2w6BvIGdp4budIMSRxrDhu6NjIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICB0b2RheSA9IG5vdy5kYXRlKCkKICAgICAgICAKICAgICAgICAjIEzhuqV5IGdp4budIHJlc2V0IHThu6sgY+G6pXUgaMOsbmggaG/hurdjIHThu6sgZGF0YWJhc2UgbuG6v3UgY8OzCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgCiAgICAgICAgIyBUw61uaCB0aOG7nWkgxJFp4buDbSByZXNldCBj4bunYSBuZ8OgeSBow7RtIG5heQogICAgICAgIHJlc2V0X3RpbWUgPSBkYXRldGltZS5kYXRldGltZS5jb21iaW5lKHRvZGF5LCBkYXRldGltZS50aW1lKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wKSkKICAgICAgICAKICAgICAgICAjIEzhuqV5IG5nw6B5IHJlc2V0IGN14buRaSBjw7luZyB04burIGRhdGFiYXNlCiAgICAgICAgbGFzdF9yZXNldF9kYXRlX3N0ciA9IHNlbGYuZGIuZ2V0KCJsYXN0X3Jlc2V0X2RhdGUiKQogICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICBpZiBsYXN0X3Jlc2V0X2RhdGVfc3RyOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSBkYXRldGltZS5kYXRlLmZyb21pc29mb3JtYXQobGFzdF9yZXNldF9kYXRlX3N0cikKICAgICAgICAgICAgZXhjZXB0IFZhbHVlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiLEkOG7i25oIGThuqFuZyBuZ8OgeSByZXNldCBraMO0bmcgaOG7o3AgbOG7hzoge2xhc3RfcmVzZXRfZGF0ZV9zdHJ9IikKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IE5vbmUKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5IGNoxrBhIHbDoCBjaMawYSByZXNldCB0cm9uZyBuZ8OgeSBow7RtIG5heQogICAgICAgIGlmIG5vdyA+PSByZXNldF90aW1lIGFuZCAobGFzdF9yZXNldF9kYXRlIGlzIE5vbmUgb3IgbGFzdF9yZXNldF9kYXRlIDwgdG9kYXkpOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gcmVzZXQgYuG7mSDEkeG6v20gaMOgbmcgbmfDoHkgKGdp4budIHJlc2V0OiB7am9iX2hvdXJ9OjAwKSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgYuG7mSDEkeG6v20gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHPhu5Egam9iIGjDtG0gbmF5IHbDoCBzZXNzaW9uIGNvdW50ZXJzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImxhc3Rfdmlld19zdG9yaWVzIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaMO0bmcgcmVzZXQgdHLhuqFuZyB0aMOhaSBmb2xsb3cgLSBjaOG7iSByZXNldCBraGkgaOG6v3QgdGjhu51pIGdpYW4KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB2w6wgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSwKICAgICAgICAgICAgICAgICAgICAjIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIHRow6BuaCBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgic3RhdHVzIikgPT0gImluYWN0aXZlIiBhbmQgYWNjb3VudC5nZXQoImluYWN0aXZlX3JlYXNvbiIpID09ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgYWN0aXZlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gc2F1IGtoaSByZXNldCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyByZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gdsOgbyB7bm93LnN0cmZ0aW1lKCclWS0lbS0lZCAlSDolTTolUycpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBuZ8OgeSDEkcOjIHJlc2V0IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIHRvZGF5Lmlzb2Zvcm1hdCgpKQogICAgICAgIAogICAgZGVmIF9jYW5fcnVuX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdGjhu4MgY2jhuqF5IGpvYiBjaG8gdMOgaSBraG/huqNuIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIGNo4bqheSBqb2IsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIDEuIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24KICAgICAgICBpZiBub3Qgc2VsZi5fY2hlY2tfYmFzaWNfYWNjb3VudF9zdGF0dXMoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDIuIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gY+G6p24gdGhp4bq/dAogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoYWNjb3VudCk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDMuIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiDEkcaw4bujYyB0aGnhur90IGzhuq1wCiAgICAgICAgYWNjb3VudCA9IHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIDQuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeQogICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfYXRfZGFpbHlfbGltaXQoYWNjb3VudCk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyA1LiBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgc2Vzc2lvbgogICAgICAgIGlmIHNlbGYuX2lzX2FjY291bnRfYXRfc2Vzc2lvbl9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICMgLi4uS0jDlE5HIGtp4buDbSB0cmEgZm9sbG93IOG7nyDEkcOieSwgY2jhu4kga2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiBjaHVuZy4uLgogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2Jhc2ljX2FjY291bnRfc3RhdHVzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIktp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBjxqEgYuG6o24gY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgYWNjb3VudF9zdGF0dXMgPSBhY2NvdW50LmdldCgic3RhdHVzIiwgImFjdGl2ZSIpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gYuG7iyBkaXNhYmxlZCwga2jDtG5nIGNobyBjaOG6oXkgam9iCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImRpc2FibGVkIjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRw6MgbG9nb3V0LCBraMO0bmcgY2hvIGNo4bqheSBqb2IKICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAibG9nb3V0IjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIGluYWN0aXZlLCBraeG7g20gdHJhIHRo4budaSBnaWFuIGNvb2xkb3duCiAgICAgICAgaWYgYWNjb3VudF9zdGF0dXMgPT0gImluYWN0aXZlIjoKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2hhbmRsZV9pbmFjdGl2ZV9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2hhbmRsZV9pbmFjdGl2ZV9hY2NvdW50KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIljhu60gbMO9IHTDoGkga2hv4bqjbiDEkWFuZyDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSIiIgogICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSDEkcOjIGjhur90IHRo4budaSBnaWFuIGNvb2xkb3duLCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSB24buBIGFjdGl2ZQogICAgICAgIGlmIGpvYl9kaXNhYmxlX3VudGlsIDw9IHRpbWUudGltZSgpOgogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHbhu4EgYWN0aXZlCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgImxhc3RfY2FyZV90aW1lIjogMAogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtow7RuZyB04buxIMSR4buZbmcgZW5hYmxlIGZvbGxvdyAtIGNo4buJIGVuYWJsZSBraGkgaOG6v3QgdGjhu51pIGdpYW4gZGlzYWJsZV9mb2xsb3cKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIENoxrBhIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIGNvb2xkb3duX3JlbWFpbiA9IGludCgoam9iX2Rpc2FibGVfdW50aWwgLSB0aW1lLnRpbWUoKSkgLyA2MCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBjaOG7nSAoY8OybiB7Y29vbGRvd25fcmVtYWlufSBwaMO6dCkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGFjY291bnRfaWQ6IGludCwgaXNfbG9nZ2VkX2luOiBib29sKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBhY2NvdW50X2lkOiBJRCB0w6BpIGtob+G6o24gCiAgICAgICAgICAgIGlzX2xvZ2dlZF9pbjogVHJ1ZSBu4bq/dSDEkcOjIMSRxINuZyBuaOG6rXAsIEZhbHNlIG7hur91IGxvZ291dAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAibG9nZ2VkX2luIjogaXNfbG9nZ2VkX2luLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcgdHJvbmcgbWVtb3J5CiAgICAgICAgICAgIGlmIGlzX2xvZ2dlZF9pbjoKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBraMOhYyBj4bunYSBjw7luZyBhcHAgbMOgIGxvZ291dAogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBvbGRfYWNjb3VudF9pZCA9IHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgaWYgb2xkX2FjY291bnRfaWQgIT0gYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChvbGRfYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGPFqSB7b2xkX2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBsb2dvdXQiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzGsHUgdMOgaSBraG/huqNuIG3hu5tpCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRfaWQKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSDEkcOjIMSRxINuZyBuaOG6rXAiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBYw7NhIGto4buPaSB0cmFja2luZyBu4bq/dSBsb2dvdXQKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMgYW5kIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdID09IGFjY291bnRfaWQ6CiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiWMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraOG7j2kgdHJhY2tpbmciKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXA6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYQogICAgICAgIGlmIG5vdCBhY2NvdW50LmdldCgiaXNfZ29saWtlX2xpbmtlZCIsIEZhbHNlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiBj4bunYSB0w6BpIGtob+G6o24gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcCB24bubaSBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQKICAgICAgICAiIiIKICAgICAgICB1cGRhdGVfZGF0YSA9IHt9CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIGpvYl9tYXhfZGF5CiAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9tYXhfZGF5IiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImpvYl9tYXhfZGF5Il0gPSBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRoaeG6v3QgbOG6rXAgbWF4X2pvYnNfcGVyX3Nlc3Npb24KICAgICAgICBpZiBhY2NvdW50LmdldCgibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAwKSA8PSAwOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsibWF4X2pvYnNfcGVyX3Nlc3Npb24iXSA9IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIGRhdGFiYXNlIG7hur91IGPDsyB0aGF5IMSR4buVaQogICAgICAgIGlmIHVwZGF0ZV9kYXRhOgogICAgICAgICAgICB1cGRhdGVfZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB1cGRhdGVfZGF0YSkKICAgICAgICAgICAgYWNjb3VudC51cGRhdGUodXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICBkZWYgX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTm9uZToKICAgICAgICAiIiIKICAgICAgICDEkMOzbmcgYXBwIHTGsMahbmcg4bupbmcgduG7m2kgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBjb25maWcuQVBQX1BBQ0tBR0VTOgogICAgICAgICAgICBzZWxmLmhlbHBlci5jbG9zZV9hcHAoY29uZmlnLkFQUF9QQUNLQUdFU1thcHBfbmFtZV0pCiAgICAgICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X2RhaWx5X2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4KICAgICAgICAiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgcmV0dXJuIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheQogICAgICAgIAogICAgZGVmIF9pc19hY2NvdW50X2F0X3Nlc3Npb25fbGltaXQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBzZXNzaW9uIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIHNlc3Npb24KICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgam9ic19kb25lX2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiam9ic19kb25lX2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9qb2JzX3Blcl9zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgb3IgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OCiAgICAgICAgCiAgICAgICAgaWYgam9ic19kb25lX2luX3Nlc3Npb24gPj0gbWF4X2pvYnNfcGVyX3Nlc3Npb246CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBzZXNzaW9uICh7am9ic19kb25lX2luX3Nlc3Npb259L3ttYXhfam9ic19wZXJfc2Vzc2lvbn0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2hvIHTDoGkga2hv4bqjbiBuZ2jhu4kgdGhlbyB0aOG7nWkgZ2lhbiBqb2JfY29vbGRvd25fbWludXRlcwogICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5kYi5nZXQoImpvYl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJDaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gbmdo4buJIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCBzYXUga2hpIGhvw6BuIHRow6BuaCBzZXNzaW9uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU+G7rSBk4bulbmcgbWV0aG9kIGPDsyBz4bq1biB0cm9uZyBkYl9zZXJ2aWNlIMSR4buDIMSR4bq3dCB0w6BpIGtob+G6o24gaW5hY3RpdmUKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgIGFjY291bnRfaWQ9YWNjb3VudFsiaWQiXSwKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9Y29vbGRvd25fbWludXRlcywKICAgICAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbj1mIkhvw6BuIHRow6BuaCBzZXNzaW9uICh7am9ic19kb25lX2luX3Nlc3Npb259IGpvYnMpLCBuZ2jhu4kge2Nvb2xkb3duX21pbnV0ZXN9IHBow7p0IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHNlc3Npb24gY291bnRlciBzYXUga2hpIMSR4bq3dCBpbmFjdGl2ZQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9qb2Jfc3RhdHMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIHN1Y2Nlc3M6IGJvb2wgPSBUcnVlLCBqb2JfdHlwZTogc3RyID0gTm9uZSwgam9iX3Jlc3VsdDogZGljdCA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0aOG7kW5nIGvDqiBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBzdWNjZXNzOiBUcnVlIG7hur91IGpvYiB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICAgICBqb2JfdHlwZTogTG/huqFpIGpvYiAoZm9sbG93LCBsaWtlLCBldGMuKQogICAgICAgICAgICBqb2JfcmVzdWx0OiBL4bq/dCBxdeG6oyBqb2IgKGTDuW5nIMSR4buDIHjhu60gbMO9IHVuZm9sbG93KQogICAgICAgICIiIgogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIGpvYiBjxqEgYuG6o24gKGJhbyBn4buTbSBj4bqjIGZvbGxvdyBzdGF0cyBu4bq/dSBsw6AgZm9sbG93IGpvYikKICAgICAgICBzZWxmLl91cGRhdGVfYmFzaWNfam9iX3N0YXRzKGFjY291bnQsIHN1Y2Nlc3MsIGpvYl90eXBlKQogICAgICAgIAogICAgICAgICMgUmVzZXQgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIG7hur91IGpvYiB0aMOgbmggY8O0bmcKICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICBzZWxmLmZhaWxlZF9qb2JfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIGpvYiB0aMOgbmggY8O0bmcgKGtow7RuZyBwaOG6o2kgYuG7iyB1bmZvbGxvdykKICAgICAgICAgICAgaWYgbm90IChqb2JfcmVzdWx0IGFuZCBqb2JfcmVzdWx0LmdldCgidW5mb2xsb3ciLCBGYWxzZSkpOgogICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAKICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw6FjIGdp4bubaSBo4bqhbiDEkcaw4bujYyB0aGnhur90IGzhuq1wCiAgICAgICAgYWNjb3VudCA9IHNlbGYuX2Vuc3VyZV9hY2NvdW50X2xpbWl0c19zZXQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIELhu48gcXVhIGtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIHNlc3Npb24gdsOsIMSRw6MgY2h1eeG7g24gc2FuZyBjb250aW51b3VzIHByb2Nlc3NpbmcKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGdp4bubaSBo4bqhbiBow6BuZyBuZ8OgeQogICAgICAgIHNlbGYuX2NoZWNrX2RhaWx5X2xpbWl0X2FmdGVyX2pvYihhY2NvdW50KQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gdW5mb2xsb3cgY2hvIGpvYiBmb2xsb3cKICAgICAgICBpZiBqb2JfdHlwZSBhbmQgam9iX3R5cGUubG93ZXIoKSA9PSAiZm9sbG93IjoKICAgICAgICAgICAgIyBO4bq/dSBi4buLIHVuZm9sbG93IChqb2JfcmVzdWx0IGPDsyBrZXkgJ3VuZm9sbG93JyBob+G6t2Mgc3RhdHVzIMSR4bq3YyBiaeG7h3QpCiAgICAgICAgICAgIGlmIGpvYl9yZXN1bHQgYW5kIGpvYl9yZXN1bHQuZ2V0KCJ1bmZvbGxvdyIsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgVMSDbmcgc+G7kSBs4bqnbiBi4buLIHVuZm9sbG93IGNobyB0w6BpIGtob+G6o24gbsOgeQogICAgICAgICAgICAgICAgdW5mb2xsb3dfY291bnQgPSBzZWxmLnVuZm9sbG93X2F0dGVtcHRzLmdldChhY2NvdW50WyJpZCJdLCAwKSArIDEKICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSB1bmZvbGxvd19jb3VudAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtYXhfdW5mb2xsb3dfYXR0ZW1wdHMgPSBzZWxmLmRiLmdldCgibWF4X3VuZm9sbG93X2F0dGVtcHRzIiwgY29uZmlnLk1BWF9VTkZPTExPV19BVFRFTVBUUykKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gYuG7iyB1bmZvbGxvdyBs4bqnbiB7dW5mb2xsb3dfY291bnR9L3ttYXhfdW5mb2xsb3dfYXR0ZW1wdHN9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaOG7iSBraMOzYSB0w6BpIGtob+G6o24ga2hpIMSR4bqhdCBnaeG7m2kgaOG6oW4gc+G7kSBs4bqnbiB1bmZvbGxvdwogICAgICAgICAgICAgICAgaWYgdW5mb2xsb3dfY291bnQgPj0gbWF4X3VuZm9sbG93X2F0dGVtcHRzOgogICAgICAgICAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50gPSA3MjAgcGjDunQKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgYuG7iyB1bmZvbGxvdyB7dW5mb2xsb3dfY291bnR9IGzhuqduLCBraMOzYSBmb2xsb3cge3BlbmFsdHlfbWludXRlc30gcGjDunQiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZGlzYWJsZV9hY2NvdW50X2ZvbGxvdygKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9cGVuYWx0eV9taW51dGVzLAogICAgICAgICAgICAgICAgICAgICAgICByZWFzb249ZiJC4buLIHVuZm9sbG93IHt1bmZvbGxvd19jb3VudH0gbOG6p24iCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgY291bnRlciBzYXUga2hpIGtow7NhCiAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGzDoCB0aWt0b2sgdGjDrCBk4burbmcgdMOgaSBraG/huqNuIGx1w7RuIHbhu5tpIHRo4budaSBnaWFuIHBlbmFsdHkgdMawxqFuZyDhu6luZwogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJhcHAiKSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRbImlkIl0sIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcz1wZW5hbHR5X21pbnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJC4buLIHVuZm9sbG93IHt1bmZvbGxvd19jb3VudH0gbOG6p24gKFRpa1RvaykiCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gYuG7iyB1bmZvbGxvdyBuaMawbmcgY2jGsGEgxJHhuqF0IGdp4bubaSBo4bqhbiAoe3VuZm9sbG93X2NvdW50fS97bWF4X3VuZm9sbG93X2F0dGVtcHRzfSkiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBKb2IgdGjDoG5oIGPDtG5nIHbDoCBraMO0bmcgYuG7iyB1bmZvbGxvdywgcmVzZXQgY291bnRlcgogICAgICAgICAgICAgICAgaWYgc3VjY2VzcyBhbmQgYWNjb3VudFsiaWQiXSBpbiBzZWxmLnVuZm9sbG93X2F0dGVtcHRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfYmFzaWNfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sLCBqb2JfdHlwZTogc3RyID0gTm9uZSk6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYiBjxqEgYuG6o24gLSBn4buZcCBj4bqjIGZvbGxvdyBzdGF0cyDEkeG7gyB0csOhbmggY+G6rXAgbmjhuq10IHRyw7luZyBs4bq3cCIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIENo4buJIHTEg25nIGNvdW50ZXJzIGtoaSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgdXBkYXRlX2RhdGEudXBkYXRlKHsKICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiBqb2JfdG9kYXkgKyAxLAogICAgICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBhY2NvdW50LmdldCgidG90YWxfam9icyIsIDApICsgMSwKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBsw6AgZm9sbG93IGpvYiwgY+G6rXAgbmjhuq10IGx1w7RuIGZvbGxvdyBzdGF0cyDEkeG7gyB0csOhbmggMiBs4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgaWYgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICBmb2xsb3dfdG9kYXkgPSBhY2NvdW50LmdldCgiZm9sbG93X3RvZGF5IiwgMCkgKyAxCiAgICAgICAgICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApICsgMQogICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogZm9sbG93X3RvZGF5LAogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGZvbGxvd19pbl9zZXNzaW9uLAogICAgICAgICAgICAgICAgICAgICJsYXN0X2ZvbGxvd190aW1lIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyB0aOG7sWMgaGnhu4duIGZvbGxvdyB0aMOgbmggY8O0bmcgLSBTZXNzaW9uOiB7Zm9sbG93X2luX3Nlc3Npb259LCBIw7RtIG5heToge2ZvbGxvd190b2RheX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb2cgdGjDtG5nIHRpbiB04buVbmcgcXVhbiB24buBIGpvYnMKICAgICAgICAgICAgam9ic19kb25lX3Nlc3Npb24gPSBqb2JzX2RvbmVfaW5fc2Vzc2lvbiArIDEKICAgICAgICAgICAgam9ic190b2RheSA9IGpvYl90b2RheSArIDEKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBob8OgbiB0aMOgbmggam9iIC0gU2Vzc2lvbjoge2pvYnNfZG9uZV9zZXNzaW9ufS97YWNjb3VudC5nZXQoJ21heF9qb2JzX3Blcl9zZXNzaW9uJywgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OKX0sIEjDtG0gbmF5OiB7am9ic190b2RheX0ve2FjY291bnQuZ2V0KCdqb2JfbWF4X2RheScsIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZKX0iKQogICAgICAgICAgICAKICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKSAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgZGF0YQogICAgICAgIAogICAgZGVmIF9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5IHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5ICh7am9iX3RvZGF5fS97am9iX21heF9kYXl9KSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfc2V0X2FjY291bnRfbG9nb3V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgdXNlcm5hbWU6IHN0ciA9IE5vbmUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICB1c2VybmFtZTogVXNlcm5hbWUgxJHhu4MgbG9nIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVOG6oW8gbWVzc2FnZSB24bubaSBuZ8OgeSBnaeG7nSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICAgICAgbG9nb3V0X21lc3NhZ2UgPSBmIlBow6F0IGhp4buHbiBsb2dvdXQ6IHtjdXJyZW50X3RpbWV9IgogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogbG9nb3V0X21lc3NhZ2UsCiAgICAgICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24ge3VzZXJuYW1lIG9yIGFjY291bnRfaWR9IGzDoCBsb2dvdXQiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ291dCBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZSBvciBhY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgdMOgaSBraG/huqNuIGxvZ291dDoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgCiAgICBkZWYgcmVzZXRfaW5hY3RpdmVfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZQogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJpbmFjdGl2ZSIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGluYWN0aXZlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB1bmZvbGxvdyBhdHRlbXB0cyBraGkgdMOgaSBraG/huqNuIGFjdGl2ZSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIHbhuqtuIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgdMOgaSBraG/huqNuIGluYWN0aXZlIikKICAgICAgICAKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBKb2JTZXJ2aWNlIHRyb25nIHRocmVhZCByacOqbmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICB0aHJlYWRpbmcuVGhyZWFkOiBUaHJlYWQgxJFhbmcgY2jhuqF5IEpvYlNlcnZpY2UgaG/hurdjIE5vbmUgbuG6v3UgbOG7l2kKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IHRy4bqhbmcgdGjDoWkgcnVubmluZwogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFyIHRyYWNraW5nIMSR4buDIHZlcmlmeSBs4bqhaSB04burIMSR4bqndQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICBsb2dnZXIuaW5mbygiQ2xlYXIgYWNjb3VudCB0cmFja2luZyDEkeG7gyB2ZXJpZnkgbOG6oWkgdOG7qyDEkeG6p3Uga2hpIGto4bufaSDEkeG7mW5nIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgbGFzdF9jYXJlX3RpbWUgdsOgIHNlc3Npb24gY291bnRlcnMgY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIMSR4buDIGLhuq90IMSR4bqndSBwaGnDqm4gbeG7m2kKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIlJlc2V0IGxhc3RfY2FyZV90aW1lIHbDoCBzZXNzaW9uIGNvdW50ZXJzIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDEkeG7gyBi4bqvdCDEkeG6p3UgcGhpw6puIG3hu5tpIikKICAgICAgICAgICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7fQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgibGFzdF9jYXJlX3RpbWUiLCAwKSA+IDA6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YVsibGFzdF9jYXJlX3RpbWUiXSA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBzZXNzaW9uIGNvdW50ZXJzIGtoaSBi4bqvdCDEkeG6p3UgcGhpw6puIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhLnVwZGF0ZSh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSByZXNldCBsYXN0X2NhcmVfdGltZSB2w6Agc2Vzc2lvbiBjb3VudGVyczoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gdGhyZWFkCiAgICAgICAgICAgIHRocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYucnVuKQogICAgICAgICAgICB0aHJlYWQuZGFlbW9uID0gVHJ1ZQogICAgICAgICAgICB0aHJlYWQuc3RhcnQoKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHRocmVhZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UiKQogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAKICAgIGRlZiByZXNldF9sb2dvdXRfYWNjb3VudHMoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgcmVzZXQgY8OhYyB0w6BpIGtob+G6o24gbG9nb3V0IHbhu4EgYWN0aXZlIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgQ2jhu4kgbsOqbiBn4buNaSBtZXRob2QgbsOgeSBraGkgY8OzIHnDqnUgY+G6p3UgxJHhurdjIGJp4buHdCB04burIGFkbWluCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdOG6pXQgY+G6oyB0w6BpIGtob+G6o24g4bufIHRy4bqhbmcgdGjDoWkgbG9nb3V0CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBzZWxmLmVuYWJsZWRfYXBwczoKICAgICAgICAgICAgICAgIGxvZ291dF9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJsb2dvdXQiKSBvciBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBsb2dvdXRfYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCB0w6BpIGtob+G6o24gbG9nb3V0IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdW5mb2xsb3cgYXR0ZW1wdHMga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiIiwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgcmVzZXQgdMOgaSBraG/huqNuIGxvZ291dCIpCiAgICAKICAgIGRlZiBpc19hY2NvdW50X2Nhbl9ydW5fam9iKHNlbGYsIGFwcF9uYW1lOnN0ciApIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBjaOG6oXkgam9iIGtow7RuZwogICAgICAgICIiIgogICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICBpZihzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KSk6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIENo4bqheSBKb2JTZXJ2aWNlIHRyb25nIHbDsm5nIGzhurdwIMSRxqFuIGdp4bqjbiAtIGzhuqV5IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbgogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmlzX2luaXRpYWxpemVkOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5pbml0aWFsaXplKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBraOG7n2kgdOG6oW8gSm9iU2VydmljZS4gS2jDtG5nIHRo4buDIGNo4bqheS4iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBjaOG6oXkgSm9iU2VydmljZSB24bubaSBsb2dpYyBsw6BtIHZp4buHYyB04buxIMSR4buZbmcuLi4iKQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSBkZXZpY2VfaWQKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyB4w6FjIMSR4buLbmggZGV2aWNlX2lkIGhp4buHbiB04bqhaSwgSm9iU2VydmljZSBraMO0bmcgdGjhu4MgY2jhuqF5IikKICAgICAgICAgICAgcmV0dXJuCiAKICAgICAgICB3aGlsZSBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgICMgUmVzZXQgYmnhur9uIGZvcmNlX3N0b3AgbuG6v3UgY8OzCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgc2VsZi5kYi5nZXQoInBhdXNlX2pvYiIsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDw7MgecOqdSBj4bqndSB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIsIHThuqFtIGThu6tuZyB44butIGzDvSBqb2IiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5o4bqjIHByb3h5IG5nYXkga2hpIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICAgICB1c2VfcHJveHkgPSBzZWxmLmRiLmdldCgidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTmjhuqMgcHJveHkgZG8gYuG7iyB04bqhbSBk4burbmcgdOG7qyBzZXJ2ZXIiKQogICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHRyYWNraW5nIHZhcmlhYmxlIGtoaSB1bnJlZ2lzdGVyIHByb3h5CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgSm9iU2VydmljZUNvbnN0YW50cy5NU0dfREVWSUNFX1BBVVNFRF9TRVJWRVIpCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldCgiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IG7hur91IGPhuqduCiAgICAgICAgICAgIHNlbGYuX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB2w6Aga2jDtGkgcGjhu6VjIGPDoWMgdMOgaSBraG/huqNuIGluYWN0aXZlIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgc2VsZi5yZXNldF9pbmFjdGl2ZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gxJHEg25nIGvDvSBwcm94eSBraMO0bmcKICAgICAgICAgICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0KCJ1c2VfcHJveHkiLCBGYWxzZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgdHLGsOG7m2MsIGNo4buJIHF1w6l0IGzhuqFpIGtoaSBj4bqnbiB0aGnhur90CiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5faXNfY3VycmVudF9hY2NvdW50X3N0aWxsX3dvcmthYmxlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJD4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBt4bubaSDEkeG7gyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF90b193b3JrID0gc2VsZi5fZ2V0X25leHRfd29ya2FibGVfYWNjb3VudCgpCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gYWNjb3VudF90b193b3JrCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24gbeG7m2k6IHthY2NvdW50X3RvX3dvcmsuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBhY2NvdW50X3RvX3dvcmsgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVGnhur9wIHThu6VjIHbhu5tpIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWk6IHthY2NvdW50X3RvX3dvcmsuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIGpvYgogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MgKGzhuqduIHtzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudH0pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFVucmVnaXN0ZXIgcHJveHkgbmdheSBraGkga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MgxJHhu4MgdGnhur90IGtp4buHbQogICAgICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiVW5yZWdpc3RlciBwcm94eSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB0cmFja2luZyB2YXJpYWJsZSBraGkgdW5yZWdpc3RlciBwcm94eQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcCBzYXUgMyBs4bqnbiBsacOqbiB0aeG6v3Aga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA+PSAzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDs25nIHThuqV0IGPhuqMgYXBwIGRvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djIHRyb25nIHRo4budaSBnaWFuIGTDoGkiKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAge2FwcF9uYW1lfSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSDEkcOzbmcgYXBwOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9OT19BQ0NPVU5UUykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBraG/huqNuZyBuZ+G6r24gdHLGsOG7m2Mga2hpIGtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIga2hpIGPDsyB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEZldGNoIEdvTGlrZSBoZWFkZXJzIC0gxJHhuqNtIGLhuqNvIGPDsyBwcm94eSBu4bq/dSBj4bqnbiBmZXRjaCBoZWFkZXJzIG3hu5tpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gbMOgbSBt4bubaSBHb0xpa2UgaGVhZGVycyBraMO0bmcKICAgICAgICAgICAgICAgICAgICBuZWVkc19oZWFkZXJzX3JlZnJlc2ggPSBzZWxmLmdvbGlrZV9zZXJ2aWNlLm5lZWRzX2hlYWRlcnNfcmVmcmVzaCgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gY8OzIHByb3h5IG7hur91IGPhuqduIGZldGNoIGhlYWRlcnMgbeG7m2kKICAgICAgICAgICAgICAgICAgICBpZiBuZWVkc19oZWFkZXJzX3JlZnJlc2g6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiRmV0Y2ggR29MaWtlIGhlYWRlcnMiKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIMSR4bqjbSBi4bqjbyBwcm94eSDEkeG7gyBmZXRjaCBHb0xpa2UgaGVhZGVycywgbmdo4buJIDEwcyB0csaw4bubYyBraGkgdGjhu60gbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxpZiBub3QgbmVlZHNfaGVhZGVyc19yZWZyZXNoOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkdvTGlrZSBoZWFkZXJzIGPDsm4gaOG7o3AgbOG7hywga2jDtG5nIGPhuqduIMSRxINuZyBrw70gcHJveHkgxJHhu4MgZmV0Y2giKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBpbnRlcm5ldCBzYXUga2hpIHjhu60gbMO9IHByb3h5ICh2w6wgcHJveHkgY8OzIHRo4buDIOG6o25oIGjGsOG7n25nIMSR4bq/biBr4bq/dCBu4buRaSkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuY2hlY2tfaW50ZXJuZXQoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIktow7RuZyBjw7Mga+G6v3QgbuG7kWkgaW50ZXJuZXQsIG5naOG7iSAyMHMgdsOgIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgyMCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGdvbGlrZV9oZWFkZXJzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICAgICBpZiBub3QgZ29saWtlX2hlYWRlcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJHb0xpa2UgaGVhZGVycyBraMO0bmcgaOG7o3AgbOG7hywgbmdo4buJIDVzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmZXRjaCBHb0xpa2UgaGVhZGVyczoge2V9LCBuZ2jhu4kgNXMgdsOgIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDUpOgogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgRm9yY2UgdmVyaWZ5IGFjY291bnQgbuG6v3UgY2jGsGEgxJHGsOG7o2MgdmVyaWZ5IHbDoCBjw7MgcHJveHkgbuG6v3UgY+G6p24KICAgICAgICAgICAgICAgIHNlbGYuX2ZvcmNlX3ZlcmlmeV9hY2NvdW50c193aXRoX3Byb3h5KCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHbDoCDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIG7hur91IGPhuqduIHRyxrDhu5tjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzIGFuZCBzZWxmLl9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3luY19hY2NvdW50c19mb3JfYXBwKGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICAjIFNhdSBraGkgxJHhu5NuZyBi4buZLCBjbGVhciBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCDEkeG7gyBxdcOpdCBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50IGFuZCBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiYXBwIikgPT0gYXBwX25hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNsZWFyIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgc2F1IGtoaSDEkeG7k25nIGLhu5kge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgVHJ1ZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nIHRyxrDhu5tjIGtoaSBsw6BtIGpvYgogICAgICAgICAgICAgICAgYWNjb3VudF90b193b3JrID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X3RvX3dvcmtbImlkIl0pCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrIG9yIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50X3RvX3dvcmspOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIGtow7RuZyB0aOG7gyBsw6BtIHZp4buHYyBu4buvYSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgdsOsIGtow7RuZyB0aOG7gyBsw6BtIHZp4buHYyBu4buvYQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgbsOqbiDEkcOzbmcgYXBwIGtow7RuZwogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FuZF9jbG9zZV9hcHBfaWZfbmVlZGVkKGFjY291bnRfdG9fd29yay5nZXQoImFwcCIpIGlmIGFjY291bnRfdG9fd29yayBlbHNlIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgY3VycmVudCB3b3JraW5nIGFjY291bnQgduG7m2kgdGjDtG5nIHRpbiBt4bubaSBuaOG6pXQKICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBhY2NvdW50X3RvX3dvcmsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gY8OzIHByb3h5IHRyxrDhu5tjIGtoaSBsw6BtIGpvYiAobuG6v3UgY+G6p24pCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIkzDoG0gam9iIik6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHByb3h5IMSR4buDIGzDoG0gam9iLCBuZ2jhu4kgMTBzIHRyxrDhu5tjIGtoaSB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCgxMCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMw6BtIHZp4buHYyB24bubaSB0w6BpIGtob+G6o24gbsOgeQogICAgICAgICAgICAgICAgam9iX3Jlc3VsdCA9IHNlbGYuX3dvcmtfd2l0aF9zaW5nbGVfYWNjb3VudChhY2NvdW50X3RvX3dvcmspCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIG7Dqm4gxJHDs25nIGFwcCBzYXUga2hpIGzDoG0gdmnhu4djIGtow7RuZwogICAgICAgICAgICAgICAgaWYgbm90IGpvYl9yZXN1bHQ6CiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBjw7MgbOG7l2ksIGNsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSR4buDIHF1w6l0IGzhuqFpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAjIEPDsyB0aOG7gyBj4bqnbiDEkcOzbmcgYXBwCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2hlY2tfYW5kX2Nsb3NlX2FwcF9pZl9uZWVkZWQoYWNjb3VudF90b193b3JrLmdldCgiYXBwIikpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqvbiBnaeG7r2EgY8OhYyBs4bqnbiBsw6BtIHZp4buHYwogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKGpvYl9jaGVja19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSB0cm9uZyB2w7JuZyBs4bq3cCBjaMOtbmgiKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbeG7mXQgY2jDunQgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAjIE5o4bqjIHByb3h5IGtoaSB0aG/DoXQKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6oyBwcm94eSBraGkgSm9iU2VydmljZSBk4burbmciKQogICAgICAgICAgICAgICAgc2VsZi5wcm94eV9zZXJ2aWNlLnVucmVnaXN0ZXJfcHJveHkoKQogICAgICAgICAgICAgICAgIyBSZXNldCB0cmFja2luZyB2YXJpYWJsZSBraGkgdW5yZWdpc3RlciBwcm94eQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3Byb3h5X2FjY291bnRfaWQgPSBOb25lCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBuaOG6oyBwcm94eToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgIyDEkMOzbmcgdOG6pXQgY+G6oyBhcHAga2hpIHRob8OhdCBKb2JTZXJ2aWNlCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IGtoaSBKb2JTZXJ2aWNlIGThu6tuZyIpCiAgICAgICAgICAgICAgICBzZWxmLl9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoaGFuZGxlciwgYXBwX25hbWUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSDEkcOzbmcgYXBwOiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbygiSm9iU2VydmljZSDEkcOjIGThu6tuZyIpCiAgICAgICAgICAgIAogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgIiIiROG7q25nIEpvYlNlcnZpY2UiIiIKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGThu6tuZyBKb2JTZXJ2aWNlLi4uIikKICAgICAgICAKICAgIGRlZiBmb3JjZV9zdG9wX2FsbChzZWxmKToKICAgICAgICAiIiJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmciIiIKICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IFRydWUKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygiROG7q25nIG5nYXkgbOG6rXAgdOG7qWMgdOG6pXQgY+G6oyBjw6FjIGhv4bqhdCDEkeG7mW5nLi4uIikKCiAgICBkZWYgaGFuZGxlX21xdHRfYWNjb3VudF91cGRhdGUoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gY+G6rXAgbmjhuq10IGFjY291bnQgdOG7qyBNUVRUIHNlcnZlcgogICAgICAgIEFjY291bnQgc+G6vSDEkcaw4bujYyByZWxvYWQgc2F1IG3hu5dpIGpvYiB0cm9uZyBjb250aW51b3VzIHByb2Nlc3NpbmcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHRow7RuZyBiw6FvIGPhuq1wIG5o4bqtdCBhY2NvdW50IHThu6sgc2VydmVyIHF1YSBNUVRUIikKICAgIAogICAgZGVmIGhhbmRsZV9tcXR0X2ZvcmNlX3N0YXJ0X3Nlc3Npb24oc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gecOqdSBj4bqndSBi4bqvdCDEkeG6p3UgbMOgbSB2aeG7h2MgbmdheSBs4bqtcCB04bupYyB04burIE1RVFQgc2VydmVyCiAgICAgICAgTG9naWMgbeG7m2kga2jDtG5nIGPDsyBzZXNzaW9uIGNvb2xkb3duIG7Dqm4ga2jDtG5nIGPhuqduIHjhu60gbMO9IGfDrCDEkeG6t2MgYmnhu4d0CiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqtbiDEkcaw4bujYyB5w6p1IGPhuqd1IGLhuq90IMSR4bqndSBsw6BtIHZp4buHYyBuZ2F5IGzhuq1wIHThu6ljIHThu6sgc2VydmVyIHF1YSBNUVRUIikKICAgICAgICAjIFRyb25nIGxvZ2ljIG3hu5tpLCBKb2JTZXJ2aWNlIHPhur0gdOG7sSDEkeG7mW5nIGzhuqV5IGpvYiBsacOqbiB04bulYyBuw6puIGtow7RuZyBj4bqnbiB44butIGzDvSBnw6wgdGjDqm0KICAgICAgICAgICAgCiAgICBkZWYgaGFuZGxlX21xdHRfY29uZmlnX3VwZGF0ZShzZWxmLCBjb25maWdfY2hhbmdlczogRGljdFtzdHIsIEFueV0gPSBOb25lKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBj4bqtcCBuaOG6rXQgY29uZmlnIHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBMb2dpYyBt4bubaSBraMO0bmcgY+G6p24gcmVzdGFydCBzZXNzaW9uLCBjb25maWcgc+G6vSDEkcaw4bujYyDDoXAgZOG7pW5nIG5nYXkgbOG6rXAgdOG7qWMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfY2hhbmdlczogRGljdGlvbmFyeSBjaOG7qWEgY8OhYyB0aGF5IMSR4buVaSBjb25maWcKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHRow7RuZyBiw6FvIGPhuq1wIG5o4bqtdCBjb25maWcgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgICAgICMgTG9naWMgbeG7m2kga2jDtG5nIGPhuqduIHjhu60gbMO9IMSR4bq3YyBiaeG7h3QsIGNvbmZpZyBz4bq9IMSRxrDhu6NjIMSR4buNYyBs4bqhaSB04burIERCIG3hu5dpIGzhuqduIGzhurdwCgogICAgZGVmIHNodXRkb3duKHNlbGYpOgogICAgICAgICIiIsSQw7NuZyBk4buLY2ggduG7pSwgZOG7q25nIHThuqV0IGPhuqMgd29ya2VyIHRocmVhZHMiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgZOG7q25nCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYuZm9yY2Vfc3RvcCA9IFRydWUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgU2h1dGRvd24gUHJveHlTZXJ2aWNlIChz4bq9IHThu7EgxJHhu5luZyB1bnJlZ2lzdGVyIHByb3h5IHbDoCBk4burbmcgdXBkYXRlIHRocmVhZCkKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAncHJveHlfc2VydmljZScpIGFuZCBzZWxmLnByb3h5X3NlcnZpY2U6CiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2Uuc2h1dGRvd24oKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2UgxJHhu4MgdHLDoW5oIGzhu5dpIHRocmVhZAogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdkYicpIGFuZCBzZWxmLmRiOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuY2xvc2UoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSDEkcOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2U6IHtzdHIoZSl9IikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgc2h1dGRvd24gSm9iU2VydmljZSIpCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT0gUFJPWFkgQ09OVkVOSUVOQ0UgTUVUSE9EUyA9PT09PT09PT09PT09PT09PT09PQogICAgZGVmIHJlc2V0X2N1cnJlbnRfcHJveHlfaXAoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBSZXNldCBJUCBjaG8gcHJveHkgaGnhu4duIHThuqFpIChjw7MgdGjhu4MgZ+G7jWkgdHJvbmcgcXXDoSB0csOsbmggbMOgbSB2aeG7h2MpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSByZXNldCB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZm9yY2VfcmVzZXRfY3VycmVudF9pcCgpCiAgICAKICAgIGRlZiBnZXRfcHJveHlfc3RhdHVzKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0cuG6oW5nIHRow6FpIHByb3h5IGhp4buHbiB04bqhaQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVHLhuqFuZyB0aMOhaSBwcm94eQogICAgICAgICIiIgogICAgICAgIHJldHVybiBzZWxmLnByb3h5X3NlcnZpY2UuZ2V0X3Byb3h5X3N0YXR1cygpCiAgICAKICAgIGRlZiBnZXRfcHJveHlfaW5mbyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIHByb3h5IGhp4buHbiB04bqhaQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBUaMO0bmcgdGluIHByb3h5CiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5nZXRfcHJveHlfaW5mbygpCiAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT0gRU5EIFBST1hZIENPTlZFTklFTkNFIE1FVEhPRFMgPT09PT09PT09PT09PT09PT09PT0KICAgICAgICAgICAgCiAgICAjIERFUFJFQ0FURUQ6IEtow7RuZyBkw7luZyBu4buvYSwgdGhheSBi4bqxbmcgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoKQogICAgIyBkZWYgX2hhc19hY2NvdW50c19yZWFkeV9mb3Jfd29yayhzZWxmKSAtPiBib29sOgogICAgIyAgICAgIiIiCiAgICAjICAgICBLaeG7g20gdHJhIHhlbSBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAjICAgICAKICAgICMgICAgIFJldHVybnM6CiAgICAjICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgIyAgICAgIiIiCiAgICAjICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICMgICAgIAogICAgIyAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICMgICAgICAgICBpZiBzZWxmLmlzX2FjY291bnRfY2FuX3J1bl9qb2IoYXBwX25hbWUpOgogICAgIyAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgIyAgICAgICAgICAgICAKICAgICMgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIF9nZXRfYWxsX3dvcmthYmxlX2FjY291bnRzKHNlbGYpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB04burIHThuqV0IGPhuqMgYXBwIHbDoCBz4bqvcCB44bq/cCB0aGVvIGFwcCwgbmfDoHkgdOG6oW8KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyDEkcaw4bujYyBz4bqvcCB44bq/cAogICAgICAgICIiIgogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cyA9IFtdCiAgICAgICAgCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQ4bq/bSBz4buRIGzGsOG7o25nIHTDoGkga2hv4bqjbiB0aGVvIHRy4bqhbmcgdGjDoWkKICAgICAgICAgICAgc3RhdHVzX2NvdW50cyA9IHt9CiAgICAgICAgICAgIGZvciBhY2MgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBzdGF0dXMgPSBhY2MuZ2V0KCdzdGF0dXMnLCAnYWN0aXZlJykKICAgICAgICAgICAgICAgIHN0YXR1c19jb3VudHNbc3RhdHVzXSA9IHN0YXR1c19jb3VudHMuZ2V0KHN0YXR1cywgMCkgKyAxCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExvZyB0aOG7kW5nIGvDqiB0cuG6oW5nIHRow6FpCiAgICAgICAgICAgIHN0YXR1c19pbmZvID0gIiwgIi5qb2luKFtmIntzdGF0dXN9OiB7Y291bnR9IiBmb3Igc3RhdHVzLCBjb3VudCBpbiBzdGF0dXNfY291bnRzLml0ZW1zKCldKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YXBwX25hbWV9IC0ge3N0YXR1c19pbmZvfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhu41jIGPDoWMgdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHtsZW4od29ya2FibGVfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIGFsbF93b3JrYWJsZV9hY2NvdW50cy5leHRlbmQod29ya2FibGVfYWNjb3VudHMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyB7YXBwX25hbWV9IikKICAgICAgICAKICAgICAgICAjIFPhuq9wIHjhur9wIHRoZW86CiAgICAgICAgIyAxLiBBcHAgbmFtZSAoxJHhu4MgbmjDs20gY8O5bmcgYXBwIGzhuqFpIHbhu5tpIG5oYXUpCiAgICAgICAgIyAyLiBOZ8OgeSB04bqhbyB0w6BpIGtob+G6o24gKGNyZWF0ZWRfYXQpIC0gY8WpIG5o4bqldCB0csaw4bubYwogICAgICAgICMgMy4gU+G7kSBqb2IgxJHDoyBsw6BtIGjDtG0gbmF5ICjDrXQgbmjhuqV0IHRyxrDhu5tjKSAtIHRoYXkgY2hvIGpvYnNfZG9uZV9pbl9zZXNzaW9uCiAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLnNvcnQoa2V5PWxhbWJkYSB4OiAoCiAgICAgICAgICAgIHguZ2V0KCJhcHAiLCAiIiksCiAgICAgICAgICAgIHguZ2V0KCJjcmVhdGVkX2F0IiwgMCksCiAgICAgICAgICAgIHguZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgICkpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGFsbF93b3JrYWJsZV9hY2NvdW50cwogICAgICAgIAogICAgZGVmIF9nZXRfbmV4dF93b3JrYWJsZV9hY2NvdW50KHNlbGYpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0w6BpIGtob+G6o24gdGnhur9wIHRoZW8gY8OzIHRo4buDIGzDoG0gdmnhu4djIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm46CiAgICAgICAgMS4gVMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgKGxvZ2dlZF9pbiA9IFRydWUpCiAgICAgICAgMi4gVMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyB0aGVvIHRo4bupIHThu7EgYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgaG/hurdjIE5vbmU6IEFjY291bnQgZGF0YSBu4bq/dSB0w6xtIHRo4bqleSwgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDE6IFTDrG0gdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdHLGsOG7m2MgKGTDuW5nIHRyYWNraW5nIGhp4buHbiB04bqhaSkKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAjIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8ga2hpIGzhuqduIMSR4bqndSBsw6BtIHZp4buHYyB24bubaSBhcHAgbsOgeSAoY2jhu4kga2hpIGPhuqduKQogICAgICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWQgYW5kIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgIyBDaOG7iSB2ZXJpZnkga2hpIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gdHJvbmcgdHJhY2tpbmcgaG/hurdjIGtoaSB0cmFja2luZyBraMO0bmcgaOG7o3AgbOG7hwogICAgICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luIHRyw6puIHthcHBfbmFtZX0gbOG6p24gxJHhuqd1Li4uIikKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IMSRw6MgdGjhu60gdmVyaWZ5IMSR4buDIGtow7RuZyB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRyYWNraW5nIHLhu5NpLCBraMO0bmcgY+G6p24gdmVyaWZ5IG5nYXkKICAgICAgICAgICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZFthcHBfbmFtZV0gPSBUcnVlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyB0cmFja2luZwogICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgbG9nZ2VkX2luX2FjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQpCiAgICAgICAgICAgICAgICBpZiBhY2NvdW50IGFuZCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50KToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIGPDsyB0aOG7gyBsw6BtIHZp4buHYzoge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIFTDoGkga2hv4bqjbiBraMO0bmcgY8OybiBo4bujcCBs4buHLCB4w7NhIGto4buPaSB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQobG9nZ2VkX2luX2FjY291bnRfaWQsIHsibG9nZ2VkX2luIjogRmFsc2UsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHtsb2dnZWRfaW5fYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDI6IFTDrG0gdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXAgdOG7qyBkYXRhYmFzZSAoZmFsbGJhY2spCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgIyDGr3UgdGnDqm4gdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyBEQgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImxvZ2dlZF9pbiIsIEZhbHNlKSBhbmQgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRbImlkIl0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiDEkcSDbmcgbmjhuq1wIHRyb25nIERCOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDM6IE7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAsIGzhuqV5IHTDoGkga2hv4bqjbiB0aGVvIHRo4bupIHThu7EKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuZXh0ZW5kKHdvcmthYmxlX2FjY291bnRzKQogICAgICAgIAogICAgICAgIGlmIG5vdCBhbGxfd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjogYXBwLCBuZ8OgeSB04bqhbywgc+G7kSBqb2IgaMO0bSBuYXkKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgeC5nZXQoImNyZWF0ZWRfYXQiLCAwKSwKICAgICAgICAgICAgeC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgKSkKICAgICAgICAKICAgICAgICBhY2NvdW50ID0gYWxsX3dvcmthYmxlX2FjY291bnRzWzBdCiAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FjY291bnQuZ2V0KCdhcHAnKX0pIikKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgIAogICAgZGVmIF93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgdMOgaSBraG/huqNuIC0gdGjhu7FjIGhp4buHbiBt4buZdCBqb2IgZHV5IG5o4bqldAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAKICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUHJveHkgxJHDoyDEkcaw4bujYyB44butIGzDvSDhu58gbmdvw6BpLCBraMO0bmcgY+G6p24ga2nhu4NtIHRyYSBs4bqhaSDhu58gxJHDonkKICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gY2h1eeG7g24gdMOgaSBraG/huqNuIGtow7RuZwogICAgICAgICAgICBuZWVkc19hY2NvdW50X3N3aXRjaCA9IG5vdCBhY2NvdW50LmdldCgibG9nZ2VkX2luIiwgRmFsc2UpCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF9pZCA9IGFjY291bnQuZ2V0KCJpZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IElQIHByb3h5IGNo4buJIGtoaSBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgICMgQ2jhu4kgcmVzZXQgSVAga2hpIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIGtow6FjIGhv4bq3YyBs4bqnbiDEkeG6p3UgdGnDqm4KICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkICE9IGN1cnJlbnRfYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IElQIHByb3h5IGNobyB0w6BpIGtob+G6o24gbeG7m2k6IHt1c2VybmFtZX0gKElEOiB7Y3VycmVudF9hY2NvdW50X2lkfSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgSVAgxJHhu4MgY8OzIElQIG3hu5tpIGNobyB0w6BpIGtob+G6o24gbeG7m2kgIAogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2VydmljZS5mb3JjZV9yZXNldF9jdXJyZW50X2lwKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgSVAgdGjDoG5oIGPDtG5nIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgYWNjb3VudF9pZCDEkcOjIHJlc2V0IMSR4buDIHRyw6FuaCByZXNldCBs4bq3cCBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IGN1cnJlbnRfYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVzZXQgSVAgdGjhuqV0IGLhuqFpIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSwgdGnhur9wIHThu6VjIHbhu5tpIElQIGhp4buHbiB04bqhaSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHGsOG7o2MgcmVzZXQgSVAgdHLGsOG7m2MgxJHDsywgYuG7jyBxdWEgcmVzZXQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7iSBjaHV54buDbiB0w6BpIGtob+G6o24ga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgaWYgbmVlZHNfYWNjb3VudF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIktow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICBzZWxmLl9tYXJrX2FjY291bnRfbG9nb3V0KGFjY291bnQsICJLaMO0bmcgdGjhu4MgY2h1eeG7g24gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgVHLhuqMgduG7gSBGYWxzZSDEkeG7gyBiw6FvIGhp4buHdSBs4buXaSBjaHV54buDbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIHNhdSBraGkgY2h1eeG7g24gdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2xvZ2dlZF9pbl9zdGF0dXMoYXBwX25hbWUsIGN1cnJlbnRfYWNjb3VudF9pZCwgVHJ1ZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyDEkcSDbmcgbmjhuq1wLCBi4buPIHF1YSBjaHV54buDbiB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBqb2IgKGLhu48gcXVhIGtp4buDbSB0cmEgbOG6oWkgdMOgaSBraG/huqNuIHbDrCDEkcOjIGtp4buDbSB0cmEg4bufIG5nb8OgaSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJM4bqleSBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgam9iID0gaGFuZGxlci5mZXRjaF9qb2IoYWNjb3VudCkKICAgICAgICAgICAgaWYgbm90IGpvYjoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBjw7Mgam9iIGtow7RuZyBwaOG6o2kgbOG7l2ksIGtow7RuZyDEkcOzbmcgYXBwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2UgbWVzc2FnZQogICAgICAgICAgICBzZWxmLl91cGRhdGVfZGV2aWNlX21lc3NhZ2VfZm9yX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgam9iIGZvbGxvdyB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fdmFsaWRhdGVfZm9sbG93X2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYiwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaSwga2jDtG5nIMSRw7NuZyBhcHAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgam9iIGLhurFuZyBoYW5kbGVyCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl92YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKGFjY291bnQsIGpvYiwgaGFuZGxlcik6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBTa2lwIGpvYiBraMO0bmcgcGjhuqNpIGzhu5dpLCBraMO0bmcgxJHDs25nIGFwcAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGpvYgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge2pvYi5nZXQoJ3R5cGUnLCAndW5rbm93bicpfSIpCiAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGVfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70ga+G6v3QgcXXhuqMgam9iIChiYW8gZ+G7k20gYsOhbyBjw6FvIHbDoCBj4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6opCiAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzDoG0gY2jEg20gc8OzYyBzYXUga2hpIGjhur90IGpvYiAobuG6v3UgxJHGsOG7o2MgYuG6rXQgdsOgIGNoxrBhIGzDoG0gdHJvbmcgcGhpw6puIG7DoHkpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGNhcmVfaW5fd29ya2luZ19qb2IgPSBzZWxmLmRiLmdldCgiY2FyZV9pbl93b3JraW5nX2pvYiIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgY2FyZV9pbl93b3JraW5nX2pvYiBhbmQgaGFzYXR0cihoYW5kbGVyLCAicGVyZm9ybV9jYXJlIikgYW5kIGNhbGxhYmxlKGhhbmRsZXIucGVyZm9ybV9jYXJlKToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgbMOgbSBjaMSDbSBzw7NjIHRyb25nIHBoacOqbiBuw6B5IGNoxrBhCiAgICAgICAgICAgICAgICAgICAgbGFzdF9jYXJlX3RpbWUgPSBhY2NvdW50LmdldCgibGFzdF9jYXJlX3RpbWUiLCAwKQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBjaMawYSBsw6BtIGNoxINtIHPDs2MgdHJvbmcgcGhpw6puIG7DoHkgKGxhc3RfY2FyZV90aW1lID0gMCBob+G6t2Mga2jDoWMgc2Vzc2lvbiBoaeG7h24gdOG6oWkpCiAgICAgICAgICAgICAgICAgICAgaWYgbGFzdF9jYXJlX3RpbWUgPT0gMDoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIGNoxINtIHPDs2MgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChs4bqnbiDEkeG6p3UgdHJvbmcgcGhpw6puKSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucGVyZm9ybV9jYXJlKGFjY291bnQpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aOG7nWkgZ2lhbiBsw6BtIGNoxINtIHPDs2MKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiBpbnQoY3VycmVudF90aW1lKQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgbMOgbSBjaMSDbSBzw7NjIHRyb25nIHBoacOqbiBuw6B5LCBi4buPIHF1YSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIGNoxINtIHPDs2MgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtIw5RORyDEkcOzbmcgYXBwIHNhdSBt4buXaSBqb2IgLSBjaOG7iSDEkcOzbmcga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggam9iIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY8OzIGzhu5dpCiAgICAgICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoc2VsZiwgaGFuZGxlciwgYXBwX25hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyCiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiBj4bunYSB0w6BpIGtob+G6o24gdHJvbmcgYXBwIG7DoHkKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGNobyB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraGkgxJHDs25nIGFwcCIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWk6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChzZWxmLCBhcHBfbmFtZTogc3RyKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCDEkcOzbmcgYXBwIG7hur91IGtow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IGFwcF9uYW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyBhcHAgbsOgeSBraMO0bmcKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgxJHDs25nIGFwcCIpCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgZ2nhu68gYXBwIG3hu58iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIMSRw7NuZyBhcHAge2FwcF9uYW1lfToge2V9IikKICAgICAgICAKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIgPSAiUGjDoXQgaGnhu4duIGxvZ291dCIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0IHbDoCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYie3JlYXNvbn06IHtjdXJyZW50X3RpbWV9IgogICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyB0cm9uZyBtZW1vcnkKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50WyJpZCJdOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudFsnaWQnXX0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBsb2dvdXQiKQogICAgICAgIAogICAgZGVmIF91cGRhdGVfZGV2aWNlX21lc3NhZ2VfZm9yX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlIGNobyBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgIiIiCiAgICAgICAgbGluayA9IGpvYi5nZXQoJ2xpbmsnLCAnJykKICAgICAgICBpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJywgJycpCiAgICAgICAgCiAgICAgICAgbWVzc2FnZSA9IGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgbWVzc2FnZSkKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIGPhu6dhIGpvYiBzYXUga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgam9iX3N1Y2Nlc3MgPSBqb2JfcmVzdWx0WyJzdWNjZXNzIl0KICAgICAgICBqb2JfbWVzc2FnZSA9IGpvYl9yZXN1bHRbIm1lc3NhZ2UiXQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gZm9sbG93IGpvYiDEkeG6t2MgYmnhu4d0CiAgICAgICAgaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5faGFuZGxlX2ZvbGxvd19qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgROG7q25nIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5IG5oxrBuZyB0aeG6v3AgdOG7pWMgbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICAjIELDoW8gY8OhbyBr4bq/dCBxdeG6owogICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6oKICAgICAgICBzZWxmLl91cGRhdGVfam9iX3N0YXRzKGFjY291bnQsIGpvYl9zdWNjZXNzLCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLCBqb2JfcmVzdWx0KQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIFRow6BuaCBjw7RuZwogICAgICAgIAogICAgZGVmIF9oYW5kbGVfZm9sbG93X2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIMSR4bq3YyBiaeG7h3QgY2hvIGZvbGxvdyBqb2IKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRp4bq/cCB04bulYyB24bubaSB0w6BpIGtob+G6o24gbsOgeSwgRmFsc2UgbuG6v3UgY+G6p24gZOG7q25nCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZyAoc3RhdHVzIDQpIHbDoCBn4butaSB5w6p1IGPhuqd1IGNo4budIGR1eeG7h3QgKHN0YXR1cyA1KQogICAgICAgIGlmIGpvYl9zdGF0dXMgaW4gWzQsIDVdOgogICAgICAgICAgICBjbnQgPSBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgIGlmIGNudCA+PSA1OgogICAgICAgICAgICAgICAgc3RhdHVzX21zZyA9ICJmb2xsb3cgcGVuZGluZyIgaWYgam9iX3N0YXR1cyA9PSA0IGVsc2UgImfhu61pIHnDqnUgY+G6p3UgY2jhu50gZHV54buHdCIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCB7c3RhdHVzX21zZ30sIHThuqFtIGThu6tuZyB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249ZiJMacOqbiB0aeG6v3AgbOG7l2kge3N0YXR1c19tc2d9IikKICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEThu6tuZyB24bubaSB0w6BpIGtob+G6o24gbsOgeQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgIHNlbGYuX2NoZWNrX2FuZF9kaXNhYmxlX2ZvbGxvd19hZnRlcl9qb2IoYWNjb3VudCwgdXNlcm5hbWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYW5kX2Rpc2FibGVfZm9sbG93X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgdXNlcm5hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbiBzYXUga2hpIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKQogICAgICAgIG1heF9mb2xsb3dfZGF5ID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfZGF5IiwgMjApCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSDEkeG6oXQgZ2nhu5tpIGjhuqFuIHBoacOqbiBob+G6t2MgbmfDoHkgdGjDrCBkaXNhYmxlIGZvbGxvdwogICAgICAgIGlmIGZvbGxvd19pbl9zZXNzaW9uID49IG1heF9mb2xsb3dfc2Vzc2lvbiBvciBmb2xsb3dfdG9kYXkgPj0gbWF4X2ZvbGxvd19kYXk6CiAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiLCA3MjApICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50gPSA3MjAgcGjDunQKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyAtIHBlbmFsdHlfbWludXRlcyB04burIERCOiB7cGVuYWx0eV9taW51dGVzfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gdOG7qyBkYl9zZXJ2aWNlIHRoYXkgdsOsIHVwZGF0ZV9hY2NvdW50IHRy4buxYyB0aeG6v3AKICAgICAgICAgICAgc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyIKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3csIGtow7NhIGZvbGxvdyDEkeG6v24ge3BlbmFsdHlfbWludXRlc30gcGjDunQiKQogICAgICAgICAgICAKICAgIGRlZiBfdmFsaWRhdGVfam9iX3dpdGhfaGFuZGxlcihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSwgaGFuZGxlcikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBWYWxpZGF0ZSBqb2IgYuG6sW5nIGhhbmRsZXIKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGpvYiBo4bujcCBs4buHLCBGYWxzZSBu4bq/dSBj4bqnbiBza2lwIGhv4bq3YyBjb250aW51ZQogICAgICAgICIiIgogICAgICAgIHZhbGlkYXRpb25fcmVzdWx0ID0gaGFuZGxlci52YWxpZGF0ZV9qb2JfYmVmb3JlX2V4ZWN1dGlvbihhY2NvdW50LCBqb2IpCiAgICAgICAgaWYgbm90IHZhbGlkYXRpb25fcmVzdWx0LmdldCgidmFsaWQiLCBUcnVlKToKICAgICAgICAgICAgaWYgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJzaG91bGRfc2tpcCIsIEZhbHNlKToKICAgICAgICAgICAgICAgICMgU2tpcCBqb2IKICAgICAgICAgICAgICAgIHNraXBfbWVzc2FnZSA9IHZhbGlkYXRpb25fcmVzdWx0LmdldCgibWVzc2FnZSIsICJKb2Iga2jDtG5nIGjhu6NwIGzhu4ciKQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTa2lwIGpvYjoge3NraXBfbWVzc2FnZX0iKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwgCiAgICAgICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsIAogICAgICAgICAgICAgICAgICAgICAgICAibWVzc2FnZSI6IHNraXBfbWVzc2FnZQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5za2lwX2pvYihhY2NvdW50LCBqb2IpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTa2lwIGpvYiBs4buXaToge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBza2lwIGpvYiDEkeG7gyB0csOhbmggc3BhbSIpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkpvYiBraMO0bmcgaOG7o3AgbOG7hzoge3ZhbGlkYXRpb25fcmVzdWx0LmdldCgnbWVzc2FnZScsICdVbmtub3duIGVycm9yJyl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfdmFsaWRhdGVfZm9sbG93X2pvYl9iZWZvcmVfZXhlY3V0aW9uKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIGZvbGxvdyBqb2IgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0aOG7gyB0aOG7sWMgaGnhu4duLCBGYWxzZSBu4bq/dSBj4bqnbiBza2lwCiAgICAgICAgIiIiCiAgICAgICAgIyBDaOG7iSB2YWxpZGF0ZSBjaG8gam9iIGZvbGxvdwogICAgICAgIGlmIGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKSAhPSAiZm9sbG93IjoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIGRpc2FibGVfZm9sbG93ID0gYWNjb3VudC5nZXQoImRpc2FibGVfZm9sbG93IiwgRmFsc2UpCiAgICAgICAgZm9sbG93X2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiZm9sbG93X2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgIG5vdyA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyDEkWFuZyBi4buLIGtow7NhIGZvbGxvdyBraMO0bmcKICAgICAgICBpZiBkaXNhYmxlX2ZvbGxvdzoKICAgICAgICAgICAgaWYgZm9sbG93X2Rpc2FibGVfdW50aWwgPiAwIGFuZCBmb2xsb3dfZGlzYWJsZV91bnRpbCA8PSBub3c6CiAgICAgICAgICAgICAgICAjIEjhur90IHRo4budaSBnaWFuIGtow7NhLCBlbmFibGUgbOG6oWkgZm9sbG93CiAgICAgICAgICAgICAgICBzZWxmLmRiLmVuYWJsZV9hY2NvdW50X2ZvbGxvdyhhY2NvdW50WyJpZCJdKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBW4bqrbiDEkWFuZyBi4buLIGtow7NhIGZvbGxvdwogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyBi4buLIGtow7NhIGZvbGxvdywgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHJlc3VsdF9za2lwID0gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLAogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiVMOgaSBraG/huqNuIMSRYW5nIGLhu4sga2jDs2EgZm9sbG93IgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIyByZXBvcnRfam9iIHPhur0gdOG7sSDEkeG7mW5nIHNraXAgam9iIGtoaSBzdGF0dXMgPSAyCiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCByZXN1bHRfc2tpcCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puCiAgICAgICAgaWYgZm9sbG93X2luX3Nlc3Npb24gPj0gbWF4X2ZvbGxvd19zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puICh7Zm9sbG93X2luX3Nlc3Npb259L3ttYXhfZm9sbG93X3Nlc3Npb259KSwgaOG7p3kgam9iIikKICAgICAgICAgICAgcmVzdWx0X3NraXAgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogMiwKICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAibWVzc2FnZSI6ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHRyb25nIHBoacOqbiIKICAgICAgICAgICAgfQogICAgICAgICAgICAjIHJlcG9ydF9qb2Igc+G6vSB04buxIMSR4buZbmcgc2tpcCBqb2Iga2hpIHN0YXR1cyA9IDIKICAgICAgICAgICAgaGFuZGxlci5yZXBvcnRfam9iKGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGhhbmRsZXIucmVjb3JkX2pvYl9oaXN0b3J5KGFjY291bnQsIGpvYiwgcmVzdWx0X3NraXApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgc2tpcF9zbGVlcF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKHNraXBfc2xlZXBfdGltZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBUcnVl').decode('utf-8'))
