import base64
exec(base64.b64decode('aW1wb3J0IHNxbGl0ZTMKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHV1aWQKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwsIFVuaW9uCmltcG9ydCBjb25maWcKCmNsYXNzIERhdGFiYXNlU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9wYXRoOiBzdHIgPSAiZGF0YS5kYiIsIGRlZmF1bHRfY29uZmlnX3BhdGg6IHN0ciA9ICJkZWZhdWx0Q29uZmlnLmpzb24iKToKICAgICAgICBzZWxmLmRiX3BhdGggPSBkYl9wYXRoCiAgICAgICAgc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoID0gZGVmYXVsdF9jb25maWdfcGF0aAogICAgICAgIHNlbGYubG9jYWwgPSB0aHJlYWRpbmcubG9jYWwoKSAgIyBMxrB1IHRy4buvIHJpw6puZyBjaG8gbeG7l2kgdGhyZWFkCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBzZWxmLl9pbml0X2RiKCkKICAgICAgICAKICAgIGRlZiBfZ2V0X2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIiIiTOG6pXkga+G6v3QgbuG7kWkgU1FMaXRlIGNobyB0aHJlYWQgaGnhu4duIHThuqFpIiIiCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZi5sb2NhbCwgJ2Nvbm4nKSBvciBzZWxmLmxvY2FsLmNvbm4gaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5sb2NhbC5jb25uID0gc3FsaXRlMy5jb25uZWN0KHNlbGYuZGJfcGF0aCkKICAgICAgICByZXR1cm4gc2VsZi5sb2NhbC5jb25uCiAgICAgICAgCiAgICBkZWYgX2luaXRfZGIoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPhuqV1IHRyw7pjIGRhdGFiYXNlIG7hur91IGNoxrBhIHThu5NuIHThuqFpIiIiCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLmRiX3BhdGgpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIGNvbmZpZwogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGNvbmZpZyAoCiAgICAgICAgICAgIGtleSBURVhUIFBSSU1BUlkgS0VZLAogICAgICAgICAgICB2YWx1ZSBURVhUCiAgICAgICAgKQogICAgICAgICcnJykKICAgICAgICAKICAgICAgICAjIFThuqFvIGLhuqNuZyBhY2NvdW50IHbhu5tpIHV1aWQKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnJycKICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBhY2NvdW50cyAoCiAgICAgICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVksCiAgICAgICAgICAgIGFjY291bnRfdXVpZCBURVhUIFVOSVFVRSwKICAgICAgICAgICAgYXBwIFRFWFQsCiAgICAgICAgICAgIG5pY2tuYW1lIFRFWFQsCiAgICAgICAgICAgIHVuaXF1ZV9pZCBURVhULAogICAgICAgICAgICB1bmlxdWVfdXNlcm5hbWUgVEVYVCwKICAgICAgICAgICAgc3RhdHVzIFRFWFQsCiAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbiBURVhULAogICAgICAgICAgICBpc19sb2dpbiBJTlRFR0VSLAogICAgICAgICAgICBhdmF0YXJfdGh1bWIgVEVYVCwKICAgICAgICAgICAgdG90YWxfam9icyBJTlRFR0VSLAogICAgICAgICAgICBqb2JfZW5hYmxlIElOVEVHRVIsCiAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsIElOVEVHRVIsCiAgICAgICAgICAgIGpvYl90b2RheSBJTlRFR0VSLAogICAgICAgICAgICBqb2JfbWF4X2RheSBJTlRFR0VSLAogICAgICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiBJTlRFR0VSLAogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiBJTlRFR0VSLAogICAgICAgICAgICBsYXN0X2pvYl90aW1lIElOVEVHRVIsCiAgICAgICAgICAgIGxhc3RfdXBkYXRlIElOVEVHRVIsCiAgICAgICAgICAgIGNhcmVfdG9kYXkgSU5URUdFUiwKICAgICAgICAgICAgaXNfZ29saWtlX2xpbmtlZCBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZ29saWtlX2lkIFRFWFQsCiAgICAgICAgICAgIGRldmljZV9pZCBURVhULAogICAgICAgICAgICBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBkYXRhIFRFWFQKICAgICAgICApCiAgICAgICAgJycnKQogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIGpvYnNfaGlzdG9yeSDEkeG7gyBsxrB1IGzhu4tjaCBz4butIGpvYgogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGpvYnNfaGlzdG9yeSAoCiAgICAgICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVksCiAgICAgICAgICAgIGpvYl91dWlkIFRFWFQgVU5JUVVFLAogICAgICAgICAgICBhY2NvdW50X3V1aWQgVEVYVCwKICAgICAgICAgICAgZGV2aWNlX2lkIFRFWFQsCiAgICAgICAgICAgIGFwcCBURVhULAogICAgICAgICAgICBqb2JfaWQgVEVYVCwKICAgICAgICAgICAgam9iX3R5cGUgVEVYVCwKICAgICAgICAgICAgb2JqZWN0X2lkIFRFWFQsCiAgICAgICAgICAgIGxpbmsgVEVYVCwKICAgICAgICAgICAgc3RhdHVzIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBzdWNjZXNzIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBwcmljZSBSRUFMIERFRkFVTFQgMCwKICAgICAgICAgICAgZXJyb3JfbWVzc2FnZSBURVhULAogICAgICAgICAgICBjcmVhdGVkX2F0IElOVEVHRVIsCiAgICAgICAgICAgIGxhc3RfdXBkYXRlIElOVEVHRVIsCiAgICAgICAgICAgIGlzX3N5bmMgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGRhdGEgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBhY2NvdW50X3V1aWQgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiUFJBR01BIHRhYmxlX2luZm8oYWNjb3VudHMpIikKICAgICAgICBjb2x1bW5zID0gW3Jvd1sxXSBmb3Igcm93IGluIGN1cnNvci5mZXRjaGFsbCgpXQogICAgICAgIGlmICJhY2NvdW50X3V1aWQiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBhY2NvdW50X3V1aWQgVEVYVCBVTklRVUUiKQogICAgICAgICAgICAjIFThuqFvIFVVSUQgY2hvIGPDoWMgdMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWkKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCBpZCBGUk9NIGFjY291bnRzIikKICAgICAgICAgICAgYWNjb3VudHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WzBdCiAgICAgICAgICAgICAgICBhY2NvdW50X3V1aWQgPSBzdHIodXVpZC51dWlkNCgpKQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlVQREFURSBhY2NvdW50cyBTRVQgYWNjb3VudF91dWlkID0gPyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF91dWlkLCBhY2NvdW50X2lkKSkKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgYWNjb3VudF91dWlkIHbDoG8gYuG6o25nIGFjY291bnRzIHbDoCB04bqhbyBVVUlEIGNobyBjw6FjIHTDoGkga2hv4bqjbiBoaeG7h24gY8OzIikKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aMOqbSBj4buZdCBpc19zeW5jIG7hur91IGNoxrBhIHThu5NuIHThuqFpCiAgICAgICAgaWYgImlzX3N5bmMiIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgaXNfc3luYyB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBjb25maWcucHkKICAgICAgICBzZWxmLmluaXRfZGVmYXVsdF9jb25maWcoKQogICAgICAgIAogICAgZGVmIGxvYWRfZGVmYXVsdF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIixJDhu41jIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBmaWxlIiIiCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCwgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZChmKQogICAgICAgIHJldHVybiB7fQogICAgICAgIAogICAgZGVmIGdldChzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBBbnk6CiAgICAgICAgIiIiTOG6pXkgZ2nDoSB0cuG7iyBj4bqldSBow6xuaCB04burIERCLCBu4bq/dSBraMO0bmcgY8OzIHRow6wgbOG6pXkgdOG7qyBkZWZhdWx0IGNvbmZpZyIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgdmFsdWUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIHJlc3VsdDoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgduG7gSBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgICAgICB2YWx1ZSA9IHJlc3VsdFswXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBM4bqleSB04burIGRlZmF1bHQgY29uZmlnCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gc2VsZi5sb2FkX2RlZmF1bHRfY29uZmlnKCkKICAgICAgICAgICAgaWYga2V5IGluIGRlZmF1bHRfY29uZmlnOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRfY29uZmlnW2tleV0KICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHQKICAgIAogICAgZGVmIHNldChzZWxmLCBrZXk6IHN0ciwgdmFsdWU6IEFueSkgLT4gYm9vbDoKICAgICAgICAiIiJMxrB1IGdpw6EgdHLhu4sgY+G6pXUgaMOsbmggdsOgbyBEQiIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGThu68gbGnhu4d1IHBo4bupYyB04bqhcCB0aMOgbmggSlNPTgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChkaWN0LCBsaXN0KSk6CiAgICAgICAgICAgIHZhbHVlID0ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGNvbmZpZyAoa2V5LCB2YWx1ZSkgVkFMVUVTICg/LCA/KSIsCiAgICAgICAgICAgICAgICAoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBsxrB1IGPhuqV1IGjDrG5oOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGRlbGV0ZShzZWxmLCBrZXk6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIG3hu5l0IGPhuqV1IGjDrG5oIGto4buPaSBkYXRhYmFzZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogS2jDs2EgY+G6pXUgaMOsbmggY+G6p24geMOzYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gY29uZmlnIFdIRVJFIGtleSA9ID8iLCAoa2V5LCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgY+G6pXUgaMOsbmgge2tleX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgc2F2ZV9kZXZpY2VfaW5mbyhzZWxmLCBkZXZpY2VfaW5mbzogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KCJkZXZpY2VfaW5mbyIsIGRldmljZV9pbmZvKQogICAgCiAgICBkZWYgZ2V0X2RldmljZV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIMSRw6MgbMawdSIiIgogICAgICAgIGRldmljZV9pbmZvID0gc2VsZi5nZXQoImRldmljZV9pbmZvIiwge30pCiAgICAgICAgcmV0dXJuIGRldmljZV9pbmZvCiAgICAKICAgIGRlZiBhZGRfYWNjb3VudChzZWxmLCBhY2NvdW50X2RhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB2w6BvIGRhdGFiYXNlIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIG1vZHVsZQogICAgICAgIGltcG9ydCBjb25maWcgYXMgY29uZmlnX21vZHVsZQogICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBkZXZpY2VfaWQsIHPhu60gZOG7pW5nIGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICBkZXZpY2VfaWQgPSBhY2NvdW50X2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIAogICAgICAgICMgVMOhY2ggZOG7ryBsaeG7h3UgY2jDrW5oIHbDoCBk4buvIGxp4buHdSBwaOG7pQogICAgICAgIG1haW5fZGF0YSA9IHsKICAgICAgICAgICAgImFwcCI6IGFjY291bnRfZGF0YS5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgIm5pY2tuYW1lIjogYWNjb3VudF9kYXRhLmdldCgibmlja25hbWUiLCAiIiksCiAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBhY2NvdW50X2RhdGEuZ2V0KCJ1bmlxdWVfaWQiLCAiIiksCiAgICAgICAgICAgICJ1bmlxdWVfdXNlcm5hbWUiOiBhY2NvdW50X2RhdGEuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIiksCiAgICAgICAgICAgICJzdGF0dXMiOiBhY2NvdW50X2RhdGEuZ2V0KCJzdGF0dXMiLCAiaW5hY3RpdmUiKSwKICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGFjY291bnRfZGF0YS5nZXQoImluYWN0aXZlX3JlYXNvbiIsICIiKSwKICAgICAgICAgICAgImlzX2xvZ2luIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBhY2NvdW50X2RhdGEuZ2V0KCJhdmF0YXJfdGh1bWIiLCAiIiksCiAgICAgICAgICAgICJ0b3RhbF9qb2JzIjogYWNjb3VudF9kYXRhLmdldCgidG90YWxfam9icyIsIDApLAogICAgICAgICAgICAiam9iX2VuYWJsZSI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGFjY291bnRfZGF0YS5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCksCiAgICAgICAgICAgICJqb2JfdG9kYXkiOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JfdG9kYXkiLCAwKSwKICAgICAgICAgICAgImpvYl9tYXhfZGF5IjogYWNjb3VudF9kYXRhLmdldCgiam9iX21heF9kYXkiLCBjb25maWdfbW9kdWxlLk1BWF9KT0JTX1BFUl9EQVkpLAogICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApLAogICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX1NFU1NJT04pLAogICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGFjY291bnRfZGF0YS5nZXQoImxhc3Rfam9iX3RpbWUiLCAwKSwKICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImNhcmVfdG9kYXkiOiBhY2NvdW50X2RhdGEuZ2V0KCJjYXJlX3RvZGF5IiwgMCksCiAgICAgICAgICAgICJpc19nb2xpa2VfbGlua2VkIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgImdvbGlrZV9pZCI6IGFjY291bnRfZGF0YS5nZXQoImdvbGlrZV9pZCIsICIiKSwKICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgImlzX3N5bmMiOiAwLCAgIyBN4bq3YyDEkeG7i25oIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICAiYWNjb3VudF91dWlkIjogYWNjb3VudF9kYXRhLmdldCgiYWNjb3VudF91dWlkIiwgc3RyKHV1aWQudXVpZDQoKSkpLCAgIyBU4bqhbyBVVUlEIG7hur91IGNoxrBhIGPDswogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIEzGsHUgSUQgdOG7qyBk4buvIGxp4buHdSDEkeG6p3UgdsOgbyBu4bq/dSBjw7MKICAgICAgICBpZiAiaWQiIGluIGFjY291bnRfZGF0YToKICAgICAgICAgICAgbWFpbl9kYXRhWyJpZCJdID0gYWNjb3VudF9kYXRhWyJpZCJdCiAgICAgICAgCiAgICAgICAgIyBMxrB1IGThu68gbGnhu4d1IHBo4bulIGTGsOG7m2kgZOG6oW5nIEpTT04KICAgICAgICBleHRyYV9kYXRhID0ge2s6IHYgZm9yIGssIHYgaW4gYWNjb3VudF9kYXRhLml0ZW1zKCkgaWYgayBub3QgaW4gbWFpbl9kYXRhfQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY29sdW1ucyA9ICIsICIuam9pbihtYWluX2RhdGEua2V5cygpKQogICAgICAgICAgICBwbGFjZWhvbGRlcnMgPSAiLCAiLmpvaW4oWyI/Il0gKiBsZW4obWFpbl9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhbHVlcyA9IGxpc3QobWFpbl9kYXRhLnZhbHVlcygpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB2w6BvIGN14buRaQogICAgICAgICAgICBjb2x1bW5zICs9ICIsIGRhdGEiCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyArPSAiLCA/IgogICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKGpzb24uZHVtcHMoZXh0cmFfZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBxdWVyeSA9IGYiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBhY2NvdW50cyAoe2NvbHVtbnN9KSBWQUxVRVMgKHtwbGFjZWhvbGRlcnN9KSIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHZhbHVlcykKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgdGjDqm0gdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiB1cGRhdGVfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGRhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiIiIgogICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaQogICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IGThu68gbGnhu4d1CiAgICAgICAgYWNjb3VudC51cGRhdGUoZGF0YSkKICAgICAgICBhY2NvdW50WyJsYXN0X3VwZGF0ZSJdID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgTMawdSBs4bqhaQogICAgICAgIHJldHVybiBzZWxmLmFkZF9hY2NvdW50KGFjY291bnQpCiAgICAKICAgIGRlZiBnZXRfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiJM4bqleSB0aMO0bmcgdGluIGPhu6dhIG3hu5l0IHTDoGkga2hv4bqjbiB0aGVvIElEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IiwgKGFjY291bnRfaWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9ieV91dWlkKHNlbGYsIGFjY291bnRfdXVpZDogc3RyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgdGjDtG5nIHRpbiBj4bunYSBt4buZdCB0w6BpIGtob+G6o24gdGhlbyBVVUlEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgYWNjb3VudF91dWlkID0gPyIsIChhY2NvdW50X3V1aWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudHMoc2VsZiwgYXBwOiBzdHIgPSBOb25lLCBzdGF0dXM6IHN0ciA9IE5vbmUsIGpvYl9lbmFibGU6IGJvb2wgPSBOb25lLCBkZXZpY2VfaWQ6IEFueSA9IFRydWUpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIHRoZW8gxJFp4buBdSBraeG7h24gbOG7jWMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHA6IFTDqm4g4bupbmcgZOG7pW5nIMSR4buDIGzhu41jCiAgICAgICAgICAgIHN0YXR1czogVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24gxJHhu4MgbOG7jWMKICAgICAgICAgICAgam9iX2VuYWJsZTogTOG7jWMgdGhlbyB0cuG6oW5nIHRow6FpIGLhuq10L3Thuq90IGpvYgogICAgICAgICAgICBkZXZpY2VfaWQ6IEzhu41jIHRoZW8gZGV2aWNlX2lkLCBjw7MgdGjhu4MgbMOgOgogICAgICAgICAgICAgICAgLSBUcnVlOiBM4buNYyB0aGVvIGRldmljZV9pZCBj4bunYSB0aGnhur90IGLhu4sgaGnhu4duIHThuqFpICht4bq3YyDEkeG7i25oKQogICAgICAgICAgICAgICAgLSBGYWxzZS9Ob25lOiBLaMO0bmcgbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIC0gQ2h14buXaTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7pSB0aOG7gyDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgcXVlcnkgPSAiU0VMRUNUICogRlJPTSBhY2NvdW50cyIKICAgICAgICBwYXJhbXMgPSBbXQogICAgICAgIAogICAgICAgICMgVGjDqm0gxJFp4buBdSBraeG7h24gbOG7jWMKICAgICAgICBjb25kaXRpb25zID0gW10KICAgICAgICBpZiBhcHA6CiAgICAgICAgICAgIGNvbmRpdGlvbnMuYXBwZW5kKCJhcHAgPSA/IikKICAgICAgICAgICAgcGFyYW1zLmFwcGVuZChhcHApCiAgICAgICAgaWYgc3RhdHVzOgogICAgICAgICAgICBjb25kaXRpb25zLmFwcGVuZCgic3RhdHVzID0gPyIpCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoc3RhdHVzKQogICAgICAgIGlmIGpvYl9lbmFibGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGNvbmRpdGlvbnMuYXBwZW5kKCJqb2JfZW5hYmxlID0gPyIpCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoMSBpZiBqb2JfZW5hYmxlIGVsc2UgMCkKICAgICAgICAgICAgCiAgICAgICAgaWYgY29uZGl0aW9uczoKICAgICAgICAgICAgcXVlcnkgKz0gIiBXSEVSRSAiICsgIiBBTkQgIi5qb2luKGNvbmRpdGlvbnMpCiAgICAgICAgICAgIAogICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCBwYXJhbXMpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgICAgIGFjY291bnRbImpvYl9lbmFibGUiXSA9IGJvb2woYWNjb3VudFsiam9iX2VuYWJsZSJdKQogICAgICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2FkcyhhY2NvdW50WyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBM4buNYyB0aGVvIGRldmljZV9pZCBu4bq/dSBj4bqnbgogICAgICAgIGlmIGRldmljZV9pZCBpcyBUcnVlOgogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZCBj4bunYSB0aGnhur90IGLhu4sgaGnhu4duIHThuqFpCiAgICAgICAgICAgIGN1cnJlbnRfZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgY3VycmVudF9kZXZpY2VfaWQ6CiAgICAgICAgICAgICAgICAjIEzhu41jIHTDoGkga2hv4bqjbiB0aGVvIGRldmljZV9pZCBj4bunYSB0aGnhur90IGLhu4sgaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICBhY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBhY2MuZ2V0KCJkZXZpY2VfaWQiKSA9PSBjdXJyZW50X2RldmljZV9pZF0KICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGV2aWNlX2lkLCBzdHIpIGFuZCBkZXZpY2VfaWQ6CiAgICAgICAgICAgICMgTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7pSB0aOG7gyDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgICAgIGFjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIGFjYy5nZXQoImRldmljZV9pZCIpID09IGRldmljZV9pZF0KICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAKICAgIGRlZiBkZWxldGVfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiWMOzYSB0w6BpIGtob+G6o24ga2jhu49pIGRhdGFiYXNlIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IiwgKGFjY291bnRfaWQsKSkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gY3Vyc29yLnJvd2NvdW50ID4gMAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgeMOzYSB0w6BpIGtob+G6o246IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgY2xvc2Uoc2VsZik6CiAgICAgICAgIiIixJDDs25nIGvhur90IG7hu5FpIGRhdGFiYXNlIGPhu6dhIHRocmVhZCBoaeG7h24gdOG6oWkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5sb2NhbCwgJ2Nvbm4nKSBhbmQgc2VsZi5sb2NhbC5jb25uOgogICAgICAgICAgICAgICAgc2VsZi5sb2NhbC5jb25uLmNsb3NlKCkKICAgICAgICAgICAgICAgIHNlbGYubG9jYWwuY29ubiA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgY8OhYyB0aGFtIGNoaeG6v3UgdGhyZWFkIMSR4buDIHRyw6FuaCBs4buXaQogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdsb2NhbCcpOgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLmxvY2FsLCAnX2xvY2FsX19pbXBsJyk6CiAgICAgICAgICAgICAgICAgICAgIyBYw7NhIHRoYW0gY2hp4bq/dSB0cm9uZyBUaHJlYWRMb2NhbAogICAgICAgICAgICAgICAgICAgIGRlbGF0dHIoc2VsZi5sb2NhbCwgJ19sb2NhbF9faW1wbCcpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSDEkcOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2U6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9fZGVsX18oc2VsZik6CiAgICAgICAgIiIiSOG7p3kgxJHhu5FpIHTGsOG7o25nIiIiCiAgICAgICAgc2VsZi5jbG9zZSgpCiAgICAKICAgIGRlZiB1cGRhdGVfb3JfaW5zZXJ0X2FjY291bnQoc2VsZiwgYXBwX25hbWU6IHN0ciwgdW5pcXVlX2lkOiBzdHIsIGRhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCBob+G6t2MgdGjDqm0gbeG7m2kgbeG7mXQgdMOgaSBraG/huqNuIHbDoG8gZGF0YWJhc2UKICAgICAgICAiIiIKICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjb25uZWN0aW9uIGzDoCBj4bunYSB0aHJlYWQgaGnhu4duIHThuqFpCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gdMOgaSBraG/huqNuIMSRw6MgdOG7k24gdOG6oWkgY2jGsGEKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiIiJTRUxFQ1QgaWQgRlJPTSBhY2NvdW50cyBXSEVSRSBhcHBfbmFtZSA9ID8gQU5EIHVuaXF1ZV9pZCA9ID8iIiIsIAogICAgICAgICAgICAgICAgKGFwcF9uYW1lLCB1bmlxdWVfaWQpCiAgICAgICAgICAgICkKICAgICAgICAgICAgYWNjb3VudCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBhY2NvdW50OgogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIGhp4buHbiBjw7MKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WzBdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTOG6pXkgZOG7ryBsaeG7h3UgaGnhu4duIHThuqFpCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiIiJTRUxFQ1QgZGF0YSBGUk9NIGFjY291bnRzIFdIRVJFIGlkID0gPyIiIiwKICAgICAgICAgICAgICAgICAgICAoYWNjb3VudF9pZCwpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBjdXJyZW50X2RhdGFfcm93ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAgICAgICAgIGN1cnJlbnRfZGF0YSA9IGpzb24ubG9hZHMoY3VycmVudF9kYXRhX3Jvd1swXSkgaWYgY3VycmVudF9kYXRhX3JvdyBlbHNlIHt9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgSOG7o3AgbmjhuqV0IGThu68gbGnhu4d1IGPFqSB2w6AgbeG7m2kKICAgICAgICAgICAgICAgIG1lcmdlZF9kYXRhID0geyoqY3VycmVudF9kYXRhLCAqKmRhdGF9CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiIiJVUERBVEUgYWNjb3VudHMgU0VUIAogICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIG5pY2tuYW1lID0gPywKICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXMgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIGlzX2xvZ2luID0gPywKICAgICAgICAgICAgICAgICAgICAgICBqb2JfZW5hYmxlID0gPywKICAgICAgICAgICAgICAgICAgICAgICBqb2JfbWF4X2RheSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgbGFzdF91cGRhdGUgPSA/CiAgICAgICAgICAgICAgICAgICAgICAgV0hFUkUgaWQgPSA/IiIiLAogICAgICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICAgICAganNvbi5kdW1wcyhtZXJnZWRfZGF0YSksCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJuaWNrbmFtZSIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoInN0YXR1cyIsICJhY3RpdmUiKSwKICAgICAgICAgICAgICAgICAgICAgICAgMSBpZiBkYXRhLmdldCgiaXNfbG9naW4iLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJqb2JfZW5hYmxlIiwgVHJ1ZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgiam9iX21heF9kYXkiLCBjb25maWcuTUFYX0pPQlNfUEVSX0RBWSksCiAgICAgICAgICAgICAgICAgICAgICAgIGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFRow6ptIHTDoGkga2hv4bqjbiBt4bubaQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiSU5TRVJUIElOVE8gYWNjb3VudHMgKAogICAgICAgICAgICAgICAgICAgICAgIGFwcF9uYW1lLCB1bmlxdWVfaWQsIG5pY2tuYW1lLCBkYXRhLCBzdGF0dXMsIGlzX2xvZ2luLCBqb2JfZW5hYmxlLCBqb2JfbWF4X2RheSwgaXNfZ29saWtlX2xpbmtlZCwgZ29saWtlX2lkLCBsYXN0X3VwZGF0ZQogICAgICAgICAgICAgICAgICAgICkgVkFMVUVTICg/LCA/LCA/LCA/LCA/LCA/LCA/LCA/LCA/LCA/LCA/KSIiIiwKICAgICAgICAgICAgICAgICAgICAoCiAgICAgICAgICAgICAgICAgICAgICAgIGFwcF9uYW1lLAogICAgICAgICAgICAgICAgICAgICAgICB1bmlxdWVfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJuaWNrbmFtZSIsICIiKSwKICAgICAgICAgICAgICAgICAgICAgICAganNvbi5kdW1wcyhkYXRhKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoInN0YXR1cyIsICJhY3RpdmUiKSwKICAgICAgICAgICAgICAgICAgICAgICAgMSBpZiBkYXRhLmdldCgiaXNfbG9naW4iLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJqb2JfZW5hYmxlIiwgVHJ1ZSkgZWxzZSAwLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgiam9iX21heF9kYXkiLCBjb25maWcuTUFYX0pPQlNfUEVSX0RBWSksCiAgICAgICAgICAgICAgICAgICAgICAgIDAsICAjIGlzX2dvbGlrZV9saW5rZWQKICAgICAgICAgICAgICAgICAgICAgICAgIiIsICMgZ29saWtlX2lkCiAgICAgICAgICAgICAgICAgICAgICAgIGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgY+G6rXAgbmjhuq10L3Row6ptIHTDoGkga2hv4bqjbjoge2V9IikKICAgICAgICAgICAgY29ubi5yb2xsYmFjaygpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgcmVzZXRfbG9naW5fc3RhdHVzX2J5X2FwcChzZWxmLCBhcHBfbmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIGxvZ2luIGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCDhu6luZyBk4bulbmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgKGFwcCwga2jDtG5nIHBo4bqjaSBhcHBfbmFtZSkKICAgICAgICAiIiIKICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjb25uZWN0aW9uIGzDoCBj4bunYSB0aHJlYWQgaGnhu4duIHThuqFpCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIHbDoCDEkcOhbmggZOG6pXUgY+G6p24gxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgIiIiVVBEQVRFIGFjY291bnRzIFNFVCBpc19sb2dpbiA9IDAsIGlzX3N5bmMgPSAwIFdIRVJFIGFwcCA9ID8iIiIsCiAgICAgICAgICAgICAgICAoYXBwX25hbWUsKQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPFqW5nIGPhuq1wIG5o4bqtdCB0csaw4budbmcgaXNfbG9naW4gdHJvbmcgZGF0YSBKU09OCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgIiIiU0VMRUNUIGlkLCBkYXRhIEZST00gYWNjb3VudHMgV0hFUkUgYXBwID0gPyIiIiwKICAgICAgICAgICAgICAgIChhcHBfbmFtZSwpCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBhY2NvdW50X2lkID0gYWNjb3VudFswXQogICAgICAgICAgICAgICAgZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsxXSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSBsb2dpbiB0cm9uZyBkYXRhCiAgICAgICAgICAgICAgICBkYXRhWyJpc19sb2dpbiJdID0gRmFsc2UKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICAgICAgZGF0YVsiaXNfc3luYyJdID0gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IGzhuqFpIGRhdGEKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIlVQREFURSBhY2NvdW50cyBTRVQgZGF0YSA9ID8gV0hFUkUgaWQgPSA/IiIiLAogICAgICAgICAgICAgICAgICAgIChqc29uLmR1bXBzKGRhdGEpLCBhY2NvdW50X2lkKQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIMSR4bq3dCBs4bqhaSB0cuG6oW5nIHRow6FpIGxvZ2luOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlIAoKICAgIGRlZiBhZGRfam9iX2hpc3Rvcnkoc2VsZiwgam9iX2RhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgVGjDqm0gbeG7mXQgYuG6o24gZ2hpIGzhu4tjaCBz4butIGpvYiBt4bubaQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9kYXRhOiBE4buvIGxp4buHdSBqb2IgY+G6p24gbMawdQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IFVVSUQgY+G7p2Egam9iIMSRw6MgdGjDqm0KICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgam9iX3V1aWQgPSBqb2JfZGF0YS5nZXQoImpvYl91dWlkIiwgc3RyKHV1aWQudXVpZDQoKSkpCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBraMO0bmcgY8OzIGRldmljZV9pZCwgc+G7rSBk4bulbmcgZGV2aWNlX2lkIGhp4buHbiB04bqhaQogICAgICAgIGRldmljZV9pZCA9IGpvYl9kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICBpZiBub3QgZGV2aWNlX2lkOgogICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAKICAgICAgICAjIFTDoWNoIGThu68gbGnhu4d1IGNow61uaCB2w6AgZOG7ryBsaeG7h3UgcGjhu6UKICAgICAgICBtYWluX2RhdGEgPSB7CiAgICAgICAgICAgICJqb2JfdXVpZCI6IGpvYl91dWlkLAogICAgICAgICAgICAiYWNjb3VudF91dWlkIjogam9iX2RhdGEuZ2V0KCJhY2NvdW50X3V1aWQiLCAiIiksCiAgICAgICAgICAgICJkZXZpY2VfaWQiOiBkZXZpY2VfaWQsCiAgICAgICAgICAgICJhcHAiOiBqb2JfZGF0YS5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgImpvYl9pZCI6IGpvYl9kYXRhLmdldCgiam9iX2lkIiwgIiIpLAogICAgICAgICAgICAiam9iX3R5cGUiOiBqb2JfZGF0YS5nZXQoImpvYl90eXBlIiwgIiIpLAogICAgICAgICAgICAib2JqZWN0X2lkIjogam9iX2RhdGEuZ2V0KCJvYmplY3RfaWQiLCAiIiksCiAgICAgICAgICAgICJsaW5rIjogam9iX2RhdGEuZ2V0KCJsaW5rIiwgIiIpLAogICAgICAgICAgICAic3RhdHVzIjogam9iX2RhdGEuZ2V0KCJzdGF0dXMiLCAwKSwKICAgICAgICAgICAgInN1Y2Nlc3MiOiAxIGlmIGpvYl9kYXRhLmdldCgic3VjY2VzcyIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJwcmljZSI6IGpvYl9kYXRhLmdldCgicHJpY2UiLCAwLjApLAogICAgICAgICAgICAiZXJyb3JfbWVzc2FnZSI6IGpvYl9kYXRhLmdldCgiZXJyb3JfbWVzc2FnZSIsICIiKSwKICAgICAgICAgICAgImNyZWF0ZWRfYXQiOiBqb2JfZGF0YS5nZXQoImNyZWF0ZWRfYXQiLCBjdXJyZW50X3RpbWUpLAogICAgICAgICAgICAibGFzdF91cGRhdGUiOiBjdXJyZW50X3RpbWUsCiAgICAgICAgICAgICJpc19zeW5jIjogMCAgIyBN4bq3YyDEkeG7i25oIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIEzGsHUgSUQgdOG7qyBk4buvIGxp4buHdSDEkeG6p3UgdsOgbyBu4bq/dSBjw7MKICAgICAgICBpZiAiaWQiIGluIGpvYl9kYXRhOgogICAgICAgICAgICBtYWluX2RhdGFbImlkIl0gPSBqb2JfZGF0YVsiaWQiXQogICAgICAgIAogICAgICAgICMgTMawdSBk4buvIGxp4buHdSBwaOG7pSBkxrDhu5tpIGThuqFuZyBKU09OCiAgICAgICAgZXh0cmFfZGF0YSA9IHtrOiB2IGZvciBrLCB2IGluIGpvYl9kYXRhLml0ZW1zKCkgaWYgayBub3QgaW4gbWFpbl9kYXRhIGFuZCBrICE9ICJkYXRhIn0KICAgICAgICBpZiAiZGF0YSIgaW4gam9iX2RhdGEgYW5kIGlzaW5zdGFuY2Uoam9iX2RhdGFbImRhdGEiXSwgZGljdCk6CiAgICAgICAgICAgIGV4dHJhX2RhdGEudXBkYXRlKGpvYl9kYXRhWyJkYXRhIl0pCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjb2x1bW5zID0gIiwgIi5qb2luKG1haW5fZGF0YS5rZXlzKCkpCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyA9ICIsICIuam9pbihbIj8iXSAqIGxlbihtYWluX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgdmFsdWVzID0gbGlzdChtYWluX2RhdGEudmFsdWVzKCkpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHbDoG8gY3Xhu5FpCiAgICAgICAgICAgIGNvbHVtbnMgKz0gIiwgZGF0YSIKICAgICAgICAgICAgcGxhY2Vob2xkZXJzICs9ICIsID8iCiAgICAgICAgICAgIHZhbHVlcy5hcHBlbmQoanNvbi5kdW1wcyhleHRyYV9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGpvYnNfaGlzdG9yeSAoe2NvbHVtbnN9KSBWQUxVRVMgKHtwbGFjZWhvbGRlcnN9KSIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHZhbHVlcykKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gam9iX3V1aWQKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHRow6ptIGzhu4tjaCBz4butIGpvYjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAKICAgIGRlZiB1cGRhdGVfam9iX2hpc3Rvcnkoc2VsZiwgam9iX3V1aWQ6IHN0ciwgZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gbOG7i2NoIHPhu60gam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgam9iX3V1aWQ6IFVVSUQgY+G7p2Egam9iIGPhuqduIGPhuq1wIG5o4bqtdAogICAgICAgICAgICBkYXRhOiBE4buvIGxp4buHdSBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBj4bqtcCBuaOG6rXQgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICAjIEzhuqV5IGpvYiBoaeG7h24gdOG6oWkKICAgICAgICBqb2IgPSBzZWxmLmdldF9qb2JfaGlzdG9yeShqb2JfdXVpZCkKICAgICAgICBpZiBub3Qgam9iOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCBk4buvIGxp4buHdQogICAgICAgIGpvYi51cGRhdGUoZGF0YSkKICAgICAgICBqb2JbImxhc3RfdXBkYXRlIl0gPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgCiAgICAgICAgIyBMxrB1IGzhuqFpCiAgICAgICAgcmV0dXJuIGJvb2woc2VsZi5hZGRfam9iX2hpc3Rvcnkoam9iKSkKICAgIAogICAgZGVmIGdldF9qb2JfaGlzdG9yeShzZWxmLCBqb2JfdXVpZDogc3RyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdGjDtG5nIHRpbiBs4buLY2ggc+G7rSBqb2IgdGhlbyBVVUlECiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgam9iX3V1aWQ6IFVVSUQgY+G7p2Egam9iIGPhuqduIGzhuqV5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgaG/hurdjIE5vbmU6IFRow7RuZyB0aW4gam9iIG7hur91IHTDrG0gdGjhuqV5LCBOb25lIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgKiBGUk9NIGpvYnNfaGlzdG9yeSBXSEVSRSBqb2JfdXVpZCA9ID8iLCAoam9iX3V1aWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgam9iID0ge2NvbHVtbl9uYW1lc1tpXTogcmVzdWx0W2ldIGZvciBpIGluIHJhbmdlKGxlbihjb2x1bW5fbmFtZXMpKX0KICAgICAgICAKICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgam9iWyJzdWNjZXNzIl0gPSBib29sKGpvYlsic3VjY2VzcyJdKQogICAgICAgIGpvYlsiaXNfc3luYyJdID0gYm9vbChqb2JbImlzX3N5bmMiXSkKICAgICAgICAKICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICBpZiAiZGF0YSIgaW4gam9iIGFuZCBqb2JbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoam9iWyJkYXRhIl0pCiAgICAgICAgICAgICAgICBqb2IudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgCiAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICBpZiAiZGF0YSIgaW4gam9iOgogICAgICAgICAgICBkZWwgam9iWyJkYXRhIl0KICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGpvYgogICAgCiAgICBkZWYgZ2V0X2pvYl9oaXN0b3J5X2J5X2FjY291bnQoc2VsZiwgYWNjb3VudF91dWlkOiBzdHIsIGxpbWl0OiBpbnQgPSA1MCkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgbOG7i2NoIHPhu60gam9iIGPhu6dhIG3hu5l0IHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfdXVpZDogVVVJRCBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgbGltaXQ6IFPhu5EgbMaw4bujbmcgYuG6o24gZ2hpIHThu5FpIMSRYSB0cuG6oyB24buBCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIGzhu4tjaCBz4butIGpvYgogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAiU0VMRUNUICogRlJPTSBqb2JzX2hpc3RvcnkgV0hFUkUgYWNjb3VudF91dWlkID0gPyBPUkRFUiBCWSBjcmVhdGVkX2F0IERFU0MgTElNSVQgPyIsIAogICAgICAgICAgICAoYWNjb3VudF91dWlkLCBsaW1pdCkKICAgICAgICApCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgam9icyA9IFtdCiAgICAgICAgZm9yIHJlc3VsdCBpbiByZXN1bHRzOgogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBr4bq/dCBxdeG6oyB0aMOgbmggZGljdAogICAgICAgICAgICBqb2IgPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgICAgICBqb2JbInN1Y2Nlc3MiXSA9IGJvb2woam9iWyJzdWNjZXNzIl0pCiAgICAgICAgICAgIGpvYlsiaXNfc3luYyJdID0gYm9vbChqb2JbImlzX3N5bmMiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgICAgICBpZiAiZGF0YSIgaW4gam9iIGFuZCBqb2JbImRhdGEiXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2Fkcyhqb2JbImRhdGEiXSkKICAgICAgICAgICAgICAgICAgICBqb2IudXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBqb2I6CiAgICAgICAgICAgICAgICBkZWwgam9iWyJkYXRhIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBqb2JzLmFwcGVuZChqb2IpCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBqb2JzCiAgICAKICAgIGRlZiBnZXRfcGVuZGluZ19zeW5jX2l0ZW1zKHNlbGYsIHRhYmxlOiBzdHIsIGxpbWl0OiBpbnQgPSAxMDAsIGRldmljZV9pZDogQW55ID0gVHJ1ZSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGFuaCBzw6FjaCBjw6FjIGLhuqNuIGdoaSBjaMawYSDEkcaw4bujYyDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YWJsZTogVMOqbiBi4bqjbmcgKCdhY2NvdW50cycgaG/hurdjICdqb2JzX2hpc3RvcnknKQogICAgICAgICAgICBsaW1pdDogU+G7kSBsxrDhu6NuZyBi4bqjbiBnaGkgdOG7kWkgxJFhIHRy4bqjIHbhu4EKICAgICAgICAgICAgZGV2aWNlX2lkOiBUaGnhur90IGLhu4sgSUQgxJHhu4MgbOG7jWM6CiAgICAgICAgICAgICAgICAtIFRydWU6IEzhu41jIHRoZW8gZGV2aWNlX2lkIGhp4buHbiB04bqhaSAobeG6t2MgxJHhu4tuaCkKICAgICAgICAgICAgICAgIC0gRmFsc2UvTm9uZTogS2jDtG5nIGzhu41jIHRoZW8gZGV2aWNlX2lkCiAgICAgICAgICAgICAgICAtIENodeG7l2k6IEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6UgdGjhu4MgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCBi4bqjbiBnaGkgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgIiIiCiAgICAgICAgaWYgdGFibGUgbm90IGluIFsnYWNjb3VudHMnLCAnam9ic19oaXN0b3J5J106CiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICB1dWlkX2ZpZWxkID0gImFjY291bnRfdXVpZCIgaWYgdGFibGUgPT0gImFjY291bnRzIiBlbHNlICJqb2JfdXVpZCIKICAgICAgICAKICAgICAgICAjIFRow6ptIMSRaeG7gXUga2nhu4duIGzhu41jIHRoZW8gZGV2aWNlX2lkCiAgICAgICAgaWYgZGV2aWNlX2lkIGlzIFRydWU6CiAgICAgICAgICAgICMgTOG6pXkgZGV2aWNlX2lkIGhp4buHbiB04bqhaQogICAgICAgICAgICBjdXJyZW50X2RldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgICAgICBxdWVyeSA9IGYiU0VMRUNUICogRlJPTSB7dGFibGV9IFdIRVJFIGlzX3N5bmMgPSAwIEFORCBkZXZpY2VfaWQgPSA/IExJTUlUID8iCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCAoY3VycmVudF9kZXZpY2VfaWQsIGxpbWl0KSkKICAgICAgICBlbGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBT4butIGThu6VuZyBkZXZpY2VfaWQgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbwogICAgICAgICAgICBxdWVyeSA9IGYiU0VMRUNUICogRlJPTSB7dGFibGV9IFdIRVJFIGlzX3N5bmMgPSAwIEFORCBkZXZpY2VfaWQgPSA/IExJTUlUID8iCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCAoZGV2aWNlX2lkLCBsaW1pdCkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBLaMO0bmcgbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICAgICAgcXVlcnkgPSBmIlNFTEVDVCAqIEZST00ge3RhYmxlfSBXSEVSRSBpc19zeW5jID0gMCBMSU1JVCA/IgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgKGxpbWl0LCkpCiAgICAgICAgICAgIAogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgIGl0ZW1zID0gW10KICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgICAgIGl0ZW0gPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBpdGVtIGFuZCBpdGVtWyJkYXRhIl06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoaXRlbVsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGl0ZW0udXBkYXRlKGV4dHJhX2RhdGEpCiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSB0csaw4budbmcgZGF0YSDEkeG7gyB0csOhbmggdHLDuW5nIGzhurdwCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBpdGVtOgogICAgICAgICAgICAgICAgZGVsIGl0ZW1bImRhdGEiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGl0ZW1zLmFwcGVuZChpdGVtKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gaXRlbXMKICAgIAogICAgZGVmIG1hcmtfYXNfc3luY2VkKHNlbGYsIHRhYmxlOiBzdHIsIHV1aWRfdmFsdWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkMOhbmggZOG6pXUgYuG6o24gZ2hpIMSRw6MgxJHGsOG7o2MgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFibGU6IFTDqm4gYuG6o25nICgnYWNjb3VudHMnIGhv4bq3YyAnam9ic19oaXN0b3J5JykKICAgICAgICAgICAgdXVpZF92YWx1ZTogR2nDoSB0cuG7iyBVVUlEIGPhu6dhIGLhuqNuIGdoaQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuq1wIG5o4bqtdCB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIGlmIHRhYmxlIG5vdCBpbiBbJ2FjY291bnRzJywgJ2pvYnNfaGlzdG9yeSddOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdXVpZF9maWVsZCA9ICJhY2NvdW50X3V1aWQiIGlmIHRhYmxlID09ICJhY2NvdW50cyIgZWxzZSAiam9iX3V1aWQiCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgIGYiVVBEQVRFIHt0YWJsZX0gU0VUIGlzX3N5bmMgPSAxIFdIRVJFIHt1dWlkX2ZpZWxkfSA9ID8iLAogICAgICAgICAgICAgICAgKHV1aWRfdmFsdWUsKQogICAgICAgICAgICApCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIGN1cnNvci5yb3djb3VudCA+IDAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSDEkcOjIMSR4buTbmcgYuG7mToge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlIAoKICAgIGRlZiBnZXRfZGV2aWNlX2NvbmZpZyhzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBBbnk6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAga2V5OiBLaMOzYSBj4bqldSBow6xuaAogICAgICAgICAgICBkZWZhdWx0OiBHacOhIHRy4buLIG3hurdjIMSR4buLbmggbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIEFueTogR2nDoSB0cuG7iyBj4bqldSBow6xuaCBob+G6t2MgZ2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSBj4bqldSBow6xuaCB04burIGRhdGFiYXNlCiAgICAgICAgcmV0dXJuIHNlbGYuZ2V0KGtleSwgZGVmYXVsdCkKCiAgICBkZWYgc2V0X2RldmljZV9jb25maWcoc2VsZiwga2V5OiBzdHIsIHZhbHVlOiBBbnkpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgU2V0IGEgZGV2aWNlIGNvbmZpZ3VyYXRpb24gdmFsdWUgaW4gdGhlIGNvbmZpZyB0YWJsZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogVGhlIGNvbmZpZ3VyYXRpb24ga2V5CiAgICAgICAgICAgIHZhbHVlOiBUaGUgdmFsdWUgdG8gc2V0CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgaWYgc3VjY2Vzc2Z1bCwgRmFsc2Ugb3RoZXJ3aXNlCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KGtleSwgdmFsdWUpCgogICAgZGVmIGdldF9hbGxfZGV2aWNlX2NvbmZpZyhzZWxmKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBHZXQgYWxsIGRldmljZSBjb25maWd1cmF0aW9uIHNldHRpbmdzCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IERpY3Rpb25hcnkgb2YgYWxsIGRldmljZSBjb25maWd1cmF0aW9uIHNldHRpbmdzCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgIyBHZXQgYWxsIGtleXMgc3RhcnRpbmcgd2l0aCAiZGV2aWNlXyIgYnV0IGV4Y2x1ZGUgZGV2aWNlX2luZm8KICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGtleSwgdmFsdWUgRlJPTSBjb25maWcgV0hFUkUga2V5ICE9ICdkZXZpY2VfaW5mbyciKQogICAgICAgIHJlc3VsdHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgIAogICAgICAgICMgQnVpbGQgY29uZmlnIGRpY3Rpb25hcnksIHJlbW92aW5nICJkZXZpY2VfIiBwcmVmaXggZnJvbSBrZXlzCiAgICAgICAgZGV2aWNlX2NvbmZpZyA9IHt9CiAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBSZW1vdmUgImRldmljZV8iIHByZWZpeAogICAgICAgICAgICBjbGVhbl9rZXkgPSBrZXlbNzpdIGlmIGtleS5zdGFydHN3aXRoKCJkZXZpY2VfIikgZWxzZSBrZXkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZ1tjbGVhbl9rZXldID0ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZ1tjbGVhbl9rZXldID0gdmFsdWUKICAgICAgICAKICAgICAgICAjIEltcG9ydCBjb25maWcgbW9kdWxlCiAgICAgICAgaW1wb3J0IGNvbmZpZyBhcyBjb25maWdfbW9kdWxlCiAgICAgICAgCiAgICAgICAgIyBBZGQgZGVmYXVsdCB2YWx1ZXMgZm9yIG1pc3NpbmcgY29uZmlnIGl0ZW1zCiAgICAgICAgZGVmYXVsdF9jb25maWdzID0gewogICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX0RBWSwKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogY29uZmlnX21vZHVsZS5NQVhfSk9CU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgImpvYl9pbnRlcnZhbF9zZWNvbmRzIjogY29uZmlnX21vZHVsZS5KT0JfQ0hFQ0tfSU5URVJWQUwsCiAgICAgICAgICAgICJyZXBvcnRfaW50ZXJ2YWwiOiBjb25maWdfbW9kdWxlLk1RVFRfUkVQT1JUX0lOVEVSVkFMCiAgICAgICAgfQogICAgICAgIAogICAgICAgIGZvciBrZXksIGRlZmF1bHRfdmFsdWUgaW4gZGVmYXVsdF9jb25maWdzLml0ZW1zKCk6CiAgICAgICAgICAgIGlmIGtleSBub3QgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWdba2V5XSA9IGRlZmF1bHRfdmFsdWUKICAgICAgICAKICAgICAgICAjIExv4bqhaSBi4buPIGPDoWMgdHLGsOG7nW5nIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAga2V5c190b19yZW1vdmUgPSBbImlkIiwgImdvbGlrZV9hcGlfYmFzZSJdCiAgICAgICAgZm9yIGtleSBpbiBrZXlzX3RvX3JlbW92ZToKICAgICAgICAgICAgaWYga2V5IGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBkZWwgZGV2aWNlX2NvbmZpZ1trZXldCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGRldmljZV9jb25maWcKCiAgICBkZWYgc2F2ZV9kZXZpY2VfY29uZmlnKHNlbGYsIGNvbmZpZ19kaWN0OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBMxrB1IG5oaeG7gXUgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIGPDuW5nIGzDumMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb25maWdfZGljdDogRGljdGlvbmFyeSBjaOG7qWEgY8OhYyBj4bq3cCBrZXktdmFsdWUgY+G6pXUgaMOsbmgKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gY29uZmlnX2RpY3QuaXRlbXMoKToKICAgICAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGzGsHUgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGluaXRfZGVmYXVsdF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgS2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggY2hvIHRoaeG6v3QgYuG7iwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBD4bqldSBow6xuaCDEkcOjIGto4bufaSB04bqhbwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBU4bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gewogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBjaHVuZwogICAgICAgICAgICAgICAgInN5bmNfaW50ZXJ2YWwiOiBjb25maWcuU1lOQ19JTlRFUlZBTCwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqldSBow6xuaCBjaG8gam9iCiAgICAgICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgICAgICJqb2JfaG91ciI6IGNvbmZpZy5KT0JfSE9VUiwKICAgICAgICAgICAgICAgICJqb2JfY29vbGRvd25fbWludXRlcyI6IGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMsCiAgICAgICAgICAgICAgICAibWF4X2pvYnNfcGVyX2RheSI6IGNvbmZpZy5NQVhfSk9CU19QRVJfREFZLAogICAgICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9zZXNzaW9uIjogY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OLAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICAgICAiZW5hYmxlZF9hcHBzIjogY29uZmlnLkVOQUJMRURfQVBQUywKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZy5pdGVtcygpOgogICAgICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgc2VsZi5nZXRfZGV2aWNlX2NvbmZpZyhrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZyhrZXksIHZhbHVlKQogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoIsSQw6Mga2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggY2hvIHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0X2NvbmZpZwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkga2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgIGRlZiBnZXRfb3JfY3JlYXRlX2RldmljZV9pZChzZWxmKSAtPiBzdHI6CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgaG/hurdjIHThuqFvIGRldmljZV9pZAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkCiAgICAgICAgIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgZGV2aWNlX2lkIHRyb25nIGRhdGFiYXNlIGtow7RuZwogICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsICIiKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIFRo4butIGzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZwogICAgICAgIGRldmljZV9pZCA9IHNlbGYuX2dldF9kZXZpY2VfaWRfZnJvbV9zeXN0ZW0oKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmggdsOgIHRy4bqjIHbhu4EKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZzoge2RldmljZV9pZH0iKQogICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKCJkZXZpY2VfaWQiLCBkZXZpY2VfaWQpCiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAgICAgCiAgICAgICAgIyBUaOG7rSBs4bqleSBkZXZpY2VfaWQgdOG7qyBoZWxwZXIgc2VydmljZQogICAgICAgIGRldmljZV9pZCA9IHNlbGYuX2dldF9kZXZpY2VfaWRfZnJvbV9oZWxwZXIoKQogICAgICAgIGlmIGRldmljZV9pZDoKICAgICAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmggdsOgIHRy4bqjIHbhu4EKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlOiB7ZGV2aWNlX2lkfSIpCiAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICAKICAgICAgICAjIE7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYywgdOG6oW8gbeG7m2kKICAgICAgICBpbXBvcnQgcmFuZG9tCiAgICAgICAgaW1wb3J0IHN0cmluZwogICAgICAgIHJhbmRvbV9pZCA9ICcnLmpvaW4ocmFuZG9tLmNob2ljZXMoc3RyaW5nLmFzY2lpX2xvd2VyY2FzZSArIHN0cmluZy5kaWdpdHMsIGs9MTApKQogICAgICAgIGRldmljZV9pZCA9IGYicmFuZG9tX3tyYW5kb21faWR9IgogICAgICAgIHByaW50KGYiS2jDtG5nIGzhuqV5IMSRxrDhu6NjIGRldmljZV9pZCBi4bqxbmcgY8OhYyBjw6FjaCB0csOqbiwgdOG6oW8gbeG7m2k6IHtkZXZpY2VfaWR9IikKICAgICAgICAKICAgICAgICAjIEzGsHUgdsOgbyBj4bqldSBow6xuaAogICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoImRldmljZV9pZCIsIGRldmljZV9pZCkKICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgCiAgICBkZWYgX2dldF9kZXZpY2VfaWRfZnJvbV9zeXN0ZW0oc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZyAoc+G7rSBk4bulbmcgbOG7h25oIGdldHByb3ApCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBkZXZpY2VfaWQgaG/hurdjIGNodeG7l2kgcuG7l25nIG7hur91IGtow7RuZyBs4bqleSDEkcaw4bujYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHN1YnByb2Nlc3MKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oWyJnZXRwcm9wIiwgInJvLnNlcmlhbG5vIl0sIGNhcHR1cmVfb3V0cHV0PVRydWUsIHRleHQ9VHJ1ZSkKICAgICAgICAgICAgZGV2aWNlX2lkID0gcmVzdWx0LnN0ZG91dC5zdHJpcCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkZXZpY2VfaWQgYW5kIGRldmljZV9pZCAhPSAidW5rbm93biI6CiAgICAgICAgICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgbOG6pXkgZGV2aWNlX2lkIHThu6sgaOG7hyB0aOG7kW5nOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICAgICAgCiAgICBkZWYgX2dldF9kZXZpY2VfaWRfZnJvbV9oZWxwZXIoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGRldmljZV9pZCB04burIGhlbHBlciBzZXJ2aWNlIChhbmRyb2lkX2lkKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkIGhv4bq3YyBjaHXhu5dpIHLhu5duZyBu4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ+G6p24gaW1wb3J0IEhlbHBlclNlcnZpY2UgdOG6oWkgxJHDonkgxJHhu4MgdHLDoW5oIGltcG9ydCB2w7JuZwogICAgICAgICAgICBmcm9tIHNlcnZpY2VzLmhlbHBlcl9zZXJ2aWNlIGltcG9ydCBIZWxwZXJTZXJ2aWNlCiAgICAgICAgICAgIGltcG9ydCBjb25maWcKICAgICAgICAgICAgCiAgICAgICAgICAgIGhlbHBlciA9IEhlbHBlclNlcnZpY2UoYmFzZV91cmw9Y29uZmlnLkhFTFBFUl9TRVJWSUNFX1VSTCkKICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBoZWxwZXIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGRldmljZV9pbmZvIGFuZCAic3RhdHVzIiBpbiBkZXZpY2VfaW5mbyBhbmQgZGV2aWNlX2luZm9bInN0YXR1cyJdID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgIGRhdGEgPSBkZXZpY2VfaW5mby5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgICAgIGFuZHJvaWRfaWQgPSBkYXRhLmdldCgiYW5kcm9pZF9pZCIsICIiKQogICAgICAgICAgICAgICAgaWYgYW5kcm9pZF9pZDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gYW5kcm9pZF9pZAogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGzhuqV5IGRldmljZV9pZCB04burIGhlbHBlcjoge2V9IikKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgIAogICAgZGVmIG1pZ3JhdGVfZ29saWtlX2NvbmZpZyhzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjDs2EgY8OhYyBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwIGtow7RuZyBjw7JuIGPhuqduIHRoaeG6v3QKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBwcmludCgixJBhbmcgeMOzYSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyBr4bq/dCBu4buRaSBEQgogICAgICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBrZXkgY+G6p24geMOzYQogICAgICAgICAgICBrZXlzX3RvX2RlbGV0ZSA9IFsKICAgICAgICAgICAgICAgICJnb2xpa2VfaGVhZGVycyIsIAogICAgICAgICAgICAgICAgImdvbGlrZV9oZWFkZXJzX3VwZGF0ZWQiLAogICAgICAgICAgICAgICAgImdvbGlrZV9hcGlfYmFzZSIKICAgICAgICAgICAgXQogICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIGPDoWMga2V5IHRyw7luZyBs4bq3cCBjxakKICAgICAgICAgICAgZGVsZXRlZF9jb3VudCA9IDAKICAgICAgICAgICAgZm9yIGtleSBpbiBrZXlzX3RvX2RlbGV0ZToKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJERUxFVEUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICAgICAgICAgIGRlbGV0ZWRfY291bnQgKz0gY3Vyc29yLnJvd2NvdW50CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENvbW1pdCB0aGF5IMSR4buVaQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBwcmludChmIsSQw6MgeMOzYSB7ZGVsZXRlZF9jb3VudH0gY+G6pXUgaMOsbmggR29MaWtlIHRyw7luZyBs4bq3cCIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgeMOzYSBj4bqldSBow6xuaCBHb0xpa2UgdHLDuW5nIGzhurdwOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQoc2VsZiwgYWNjb3VudF9pZDogaW50LCBpbmFjdGl2ZV9yZWFzb246IHN0ciA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikgLT4gYm9vbDoKICAgICAgICAiIiLEkOG6t3QgdMOgaSBraG/huqNuIHbDoG8gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSDEkeG6v24gZ2nhu50gcmVzZXQgdGnhur9wIHRoZW8iIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBkYXRldGltZSwgY29uZmlnLCB0aW1lCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiBjw7MgSUQge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAjIEdp4budIHJlc2V0CiAgICAgICAgICAgIGpvYl9ob3VyID0gc2VsZi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbm93LnJlcGxhY2UoaG91cj1qb2JfaG91ciwgbWludXRlPTAsIHNlY29uZD0wLCBtaWNyb3NlY29uZD0wKQogICAgICAgICAgICBpZiBub3cgPj0gbmV4dF9yZXNldDoKICAgICAgICAgICAgICAgIG5leHRfcmVzZXQgPSBuZXh0X3Jlc2V0ICsgZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBpbnQobmV4dF9yZXNldC50aW1lc3RhbXAoKSkKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGpvYl9kaXNhYmxlX3VudGlsLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBpbmFjdGl2ZV9yZWFzb24KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlX3VudGlsX25leHRfcmVzZXQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZXRfYWNjb3VudF9pbmFjdGl2ZShzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGNvb2xkb3duX21pbnV0ZXM6IGludCA9IE5vbmUsIGluYWN0aXZlX3JlYXNvbjogc3RyID0gIsSQw6MgaG/DoG4gdGjDoG5oIHPhu5Egam9iIHRyb25nIHBoacOqbiIpIC0+IGJvb2w6CiAgICAgICAgIiIixJDhurd0IHTDoGkga2hv4bqjbiB2w6BvIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUgdHJvbmcga2hv4bqjbmcgdGjhu51pIGdpYW4gKHBow7p0KSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHRpbWUsIGNvbmZpZwogICAgICAgICAgICBhY2NvdW50ID0gc2VsZi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjb3VudDoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIGPDsyBJRCB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGlmIGNvb2xkb3duX21pbnV0ZXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmdldCgiam9iX2Nvb2xkb3duX21pbnV0ZXMiLCBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTKQogICAgICAgICAgICBqb2JfZGlzYWJsZV91bnRpbCA9IGludCh0aW1lLnRpbWUoKSArIGNvb2xkb3duX21pbnV0ZXMgKiA2MCkKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGpvYl9kaXNhYmxlX3VudGlsLAogICAgICAgICAgICAgICAgImpvYnNfZG9uZV9pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBpbmFjdGl2ZV9yZWFzb24KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvd191bnRpbF9uZXh0X3Jlc2V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgcmVhc29uOiBzdHIgPSAiRm9sbG93IHBlbmRpbmcvbGltaXQiKSAtPiBib29sOgogICAgICAgICIiIkNo4buJIGtow7NhIGNo4bupYyBuxINuZyBGT0xMT1cgY+G7p2EgdMOgaSBraG/huqNuIHThu5tpIGdp4budIHJlc2V0IHRp4bq/cCB0aGVvIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUsIGNvbmZpZywgdGltZQogICAgICAgICAgICBhY2MgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2M6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGpvYl9ob3VyID0gc2VsZi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbm93LnJlcGxhY2UoaG91cj1qb2JfaG91ciwgbWludXRlPTAsIHNlY29uZD0wLCBtaWNyb3NlY29uZD0wKQogICAgICAgICAgICBpZiBub3cgPj0gbmV4dF9yZXNldDoKICAgICAgICAgICAgICAgIG5leHRfcmVzZXQgKz0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlX2ZvbGxvdyIsCiAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBpbnQobmV4dF9yZXNldC50aW1lc3RhbXAoKSksCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogcmVhc29uCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltEQl0gTOG7l2kgc2V0X2FjY291bnRfaW5hY3RpdmVfZm9sbG93X3VudGlsX25leHRfcmVzZXQ6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZXRfYWNjb3VudF9pbmFjdGl2ZV9mb2xsb3coc2VsZiwgYWNjb3VudF9pZDogaW50LCBjb29sZG93bl9taW51dGVzOiBpbnQgPSBOb25lLCByZWFzb246IHN0ciA9ICJGb2xsb3cgcGVuZGluZy9saW1pdCIpIC0+IGJvb2w6CiAgICAgICAgIiIiS2jDs2EgRk9MTE9XIHRyb25nIG3hu5l0IGtob+G6o25nIHRo4budaSBnaWFuIChwaMO6dCkiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCB0aW1lLCBjb25maWcKICAgICAgICAgICAgYWNjID0gc2VsZi5nZXRfYWNjb3VudChhY2NvdW50X2lkKQogICAgICAgICAgICBpZiBub3QgYWNjOgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBpZiBjb29sZG93bl9taW51dGVzIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5nZXQoImpvYl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlX2ZvbGxvdyIsCiAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBpbnQodGltZS50aW1lKCkgKyBjb29sZG93bl9taW51dGVzICogNjApLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IHJlYXNvbgogICAgICAgICAgICB9KQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvdzoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlIA==').decode('utf-8'))
