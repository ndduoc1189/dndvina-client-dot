import base64
exec(base64.b64decode('aW1wb3J0IHRpbWUKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgZGF0ZXRpbWUKaW1wb3J0IHJhbmRvbQppbXBvcnQganNvbgpmcm9tIHR5cGluZyBpbXBvcnQgRGljdCwgQW55LCBMaXN0LCBPcHRpb25hbAppbXBvcnQgY29uZmlnCmltcG9ydCB1dGlscwpmcm9tIHV0aWxzIGltcG9ydCBMb2dMZXZlbCwgTG9nZ2VyCmZyb20gam9icyBpbXBvcnQgVGlrdG9rSm9iLCBJbnN0YWdyYW1Kb2IKZnJvbSBzZXJ2aWNlcy5wcm94eV9zZXJ2aWNlIGltcG9ydCBQcm94eVNlcnZpY2UKCiMgVOG6oW8gbG9nZ2VyIGNobyBKb2JTZXJ2aWNlCmxvZ2dlciA9IHV0aWxzLmdldF9sb2dnZXIoIkpvYlNlcnZpY2UiKQoKIyBDb25zdGFudHMgZm9yIGJldHRlciBjb2RlIHJlYWRhYmlsaXR5CmNsYXNzIEpvYlNlcnZpY2VDb25zdGFudHM6CiAgICAiIiJDb25zdGFudHMgdXNlZCBpbiBKb2JTZXJ2aWNlIiIiCiAgICBERUZBVUxUX0NIRUNLX0lOVEVSVkFMID0gMC41ICAjIFNsZWVwIGNoZWNrIGludGVydmFsIGluIHNlY29uZHMKICAgIE1BWF9XQVJOSU5HX0xPR1MgPSAyMAogICAgCiAgICAjIFN0YXR1cyBtZXNzYWdlcwogICAgTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSID0gIlThuqFtIGThu6tuZyAoU2V2ZXIgecOqdSBj4bqndSkiCiAgICBNU0dfREVWSUNFX05PX0FDQ09VTlRTID0gIlThuqFtIG5naOG7iSAoS2jDtG5nIGPDsyB0w6BpIGtob+G6o24pIgogICAgTVNHX1dBSVRJTkdfUFJPWFkgPSAixJBhbmcgY2jhu50gcHJveHkiCiAgICBNU0dfV09SS0lOR19DT05USU5VT1VTID0gIsSQYW5nIGzDoG0gdmnhu4djIGxpw6puIHThu6VjIgogICAgCiAgICAjIEFjY291bnQgc3RhdHVzIHJlYXNvbnMKICAgIFJFQVNPTl9EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IgogICAgUkVBU09OX0ZPTExPV19EQUlMWV9MSU1JVCA9ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGZvbG93IHRyb25nIG5nw6B5IgoKY2xhc3MgSm9iU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSwgZ29saWtlX3NlcnZpY2UsIG1xdHRfc2VydmljZT1Ob25lKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRiX3NlcnZpY2U6IERhdGFiYXNlU2VydmljZSDEkeG7gyBsxrB1IHRy4buvIGThu68gbGnhu4d1CiAgICAgICAgICAgIGhlbHBlcl9zZXJ2aWNlOiBIZWxwZXJTZXJ2aWNlIMSR4buDIHTGsMahbmcgdMOhYyB24bubaSB0aGnhur90IGLhu4sKICAgICAgICAgICAgZ29saWtlX3NlcnZpY2U6IEdvTGlrZVNlcnZpY2UgxJHhu4MgZ+G7jWkgQVBJIEdvTGlrZQogICAgICAgICAgICBtcXR0X3NlcnZpY2U6IE1RVFRTZXJ2aWNlIMSR4buDIGfhu61pIHRow7RuZyBiw6FvIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICBzZWxmLmRiID0gZGJfc2VydmljZQogICAgICAgIHNlbGYuaGVscGVyID0gaGVscGVyX3NlcnZpY2UKICAgICAgICBzZWxmLmdvbGlrZV9zZXJ2aWNlID0gZ29saWtlX3NlcnZpY2UKICAgICAgICBzZWxmLm1xdHRfc2VydmljZSA9IG1xdHRfc2VydmljZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIFByb3h5U2VydmljZQogICAgICAgIHNlbGYucHJveHlfc2VydmljZSA9IFByb3h5U2VydmljZShkYl9zZXJ2aWNlLCBoZWxwZXJfc2VydmljZSkKICAgICAgICAKICAgICAgICAjIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnMgPSB7fQogICAgICAgIAogICAgICAgICMgRmxhZyDEkWnhu4F1IGtoaeG7g24KICAgICAgICBzZWxmLmlzX2luaXRpYWxpemVkID0gRmFsc2UKICAgICAgICAKICAgICAgICAjIFRow7RuZyB0aW4gduG7gSBjw6FjIGFwcCDEkcaw4bujYyBrw61jaCBob+G6oXQgLSBs4bqleSB04burIGRhdGFiYXNlIGhv4bq3YyBjb25maWcKICAgICAgICBzZWxmLmVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgTG9jayDEkeG7gyDEkeG7k25nIGLhu5kgdHLhuqFuZyB0aMOhaQogICAgICAgIHNlbGYuX2xvY2sgPSB0aHJlYWRpbmcuTG9jaygpCiAgICAgICAgCiAgICAgICAgIyBEaWN0aW9uYXJ5IMSR4buDIGzGsHUgc+G7kSBs4bqnbiB0aOG7rSBqb2IgdGjhuqV0IGLhuqFpIHRoZW8gYWNjb3VudF9pZAogICAgICAgIHNlbGYuZmFpbGVkX2pvYl9hdHRlbXB0cyA9IHt9CiAgICAgICAgCiAgICAgICAgIyDEkOG6v20gc+G7kSBs4bqnbiBsacOqbiB0aeG6v3Agam9iIGZvbGxvdyB0cuG6oyB24buBIHN0YXR1cyA0IChwZW5kaW5nKQogICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBi4buLIHVuZm9sbG93L3VubGlrZSB0aGVvIGFjY291bnRfaWQKICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBs4buXaSBmZXRjaCBqb2IgdGhlbyBhY2NvdW50X2lkCiAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzID0ge30KICAgICAgICAKICAgICAgICAjIMSQ4bq/bSBz4buRIGzhuqduIGxpw6puIHRp4bq/cCBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyDEkeG7gyBxdXnhur90IMSR4buLbmggbmjhuqMgcHJveHkKICAgICAgICBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA9IDAKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJHDoyByZXNldCBJUCBwcm94eSDEkeG7gyB0csOhbmggcmVzZXQgbOG6t3AgbOG6oWkKICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgxJHEg25nIG5o4bqtcCB0aGVvIGFwcCDEkeG7gyB0csOhbmggc3dpdGNoIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cyA9IHt9ICAjIHthcHBfbmFtZTogYWNjb3VudF9pZH0KICAgICAgICAKICAgICAgICAjIEZsYWcgxJHhu4MgdHJhY2sgeGVtIMSRw6MgdmVyaWZ5IGN1cnJlbnQgYWNjb3VudCBjaMawYSBraGkga2jhu59pIMSR4buZbmcKICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZCA9IHt9ICAjIHthcHBfbmFtZTogYm9vbH0KICAgICAgICAKICAgICAgICAjIFRyYWNrIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgxJFhbmcgbMOgbSB2aeG7h2MgxJHhu4MgdHLDoW5oIHF1w6l0IGzhuqFpIGtow7RuZyBj4bqnbiB0aGnhur90CiAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IE5vbmUKICAgICAgICAKICAgIGRlZiBfdmVyaWZ5X2N1cnJlbnRfYWNjb3VudF9vbl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0ciwgaGFuZGxlcikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIFZlcmlmeSB0w6BpIGtob+G6o24gdGjhu7FjIHThur8gxJFhbmcgbG9naW4gdHLDqm4gYXBwCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyIGPhu6dhIGFwcAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4gYXBwLCBOb25lIG7hur91IGtow7RuZyBjw7MgaG/hurdjIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihoYW5kbGVyLCAnZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lJyk6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkhhbmRsZXIge2FwcF9uYW1lfSBraMO0bmcgaOG7lyB0cuG7oyBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB04burIFVJCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudF91c2VybmFtZSA9IGhhbmRsZXIuZ2V0X2N1cnJlbnRfbG9nZ2VkX2luX3VzZXJuYW1lKCkKICAgICAgICAgICAgaWYgbm90IGN1cnJlbnRfYWNjb3VudF91c2VybmFtZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgZm9yIGFjY291bnQgaW4gYWNjb3VudHM6CiAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJykgPT0gY3VycmVudF9hY2NvdW50X3VzZXJuYW1lOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZpZWQ6IFTDoGkga2hv4bqjbiB7Y3VycmVudF9hY2NvdW50X3VzZXJuYW1lfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudF91c2VybmFtZX0gxJFhbmcgbG9naW4gdHLDqm4ge2FwcF9uYW1lfSBuaMawbmcga2jDtG5nIGPDsyB0cm9uZyBEQiIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSBjdXJyZW50IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICBkZWYgX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KHNlbGYsIGFwcF9uYW1lOiBzdHIsIGhhbmRsZXIpOgogICAgICAgICIiIgogICAgICAgIMSQ4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGlzX2xvZ2luIHRyb25nIERCIHbhu5tpIHRo4buxYyB04bq/IHRyw6puIGFwcAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICAgICBoYW5kbGVyOiBKb2IgaGFuZGxlciBj4bunYSBhcHAKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSB0csaw4bubYyBraGkgdmVyaWZ5IGFjY291bnQgKG7hur91IGPhuqduKQogICAgICAgICAgICBpZiBub3Qgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoZiJWZXJpZnkgYWNjb3VudCB0csOqbiB7YXBwX25hbWV9Iik6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgdmVyaWZ5IGFjY291bnQgdHLDqm4ge2FwcF9uYW1lfSwgYuG7jyBxdWEgdmVyaWZ5IikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luCiAgICAgICAgICAgIGN1cnJlbnRfYWNjb3VudCA9IHNlbGYuX3ZlcmlmeV9jdXJyZW50X2FjY291bnRfb25fYXBwKGFwcF9uYW1lLCBoYW5kbGVyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiBj4bunYSBhcHAgbsOgeSB24buBIGlzX2xvZ2luID0gRmFsc2UgdHJvbmcgREIKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHJlc2V0X2NvdW50ID0gMAogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIHJlc2V0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSZXNldCBpc19sb2dpbiA9IEZhbHNlIGNobyB0w6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzZXRfY291bnQgPiAwOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJSZXNldCB7cmVzZXRfY291bnR9IHTDoGkga2hv4bqjbiB24buBIGlzX2xvZ2luID0gRmFsc2UgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IMSRYW5nIGxvZ2luCiAgICAgICAgICAgIGlmIGN1cnJlbnRfYWNjb3VudDoKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoY3VycmVudF9hY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogVHJ1ZSwKICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBjdXJyZW50X2FjY291bnRbImlkIl0KICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU3luYyB0cuG6oW5nIHRow6FpOiBUw6BpIGtob+G6o24ge2N1cnJlbnRfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSDEkWFuZyBsb2dpbiB0aOG6rXQgdHLDqm4ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIEtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gbG9naW4KICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHM6CiAgICAgICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlN5bmMgdHLhuqFuZyB0aMOhaTogS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHN5bmMgbG9naW4gc3RhdHVzIGNobyB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfZm9yY2VfdmVyaWZ5X2FjY291bnRzX3dpdGhfcHJveHkoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgRm9yY2UgdmVyaWZ5IHThuqV0IGPhuqMgYWNjb3VudCBraGkgxJHDoyBjw7MgcHJveHkgKGfhu41pIGtoaSB0aOG7sWMgc+G7sSBj4bqnbiB0aGnhur90KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVycyBhbmQgYXBwX25hbWUgbm90IGluIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiRm9yY2UgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9IHbhu5tpIHByb3h5Li4uIikKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N5bmNfYWNjb3VudF9sb2dpbl9zdGF0dXNfd2l0aF9yZWFsaXR5KGFwcF9uYW1lLCBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZm9yY2UgdmVyaWZ5IHTDoGkga2hv4bqjbiB0csOqbiB7YXBwX25hbWV9OiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIGZpbmFsbHk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkW2FwcF9uYW1lXSA9IFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBmb3JjZSB2ZXJpZnkgYWNjb3VudHM6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9pc19jdXJyZW50X2FjY291bnRfc3RpbGxfd29ya2FibGUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gaGnhu4duIHThuqFpIGPDsyBjw7JuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBraMO0bmcKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWkgduG6q24gY8OzIHRo4buDIGzDoG0gdmnhu4djLCBGYWxzZSBu4bq/dSBj4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50OgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIG3hu5tpIG5o4bqldCB04burIERCCiAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICBjdXJyZW50X2FjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgY3VycmVudF9hY2NvdW50OgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiVMOgaSBraG/huqNuIElEIHthY2NvdW50X2lkfSBraMO0bmcgY8OybiB04buTbiB04bqhaSB0cm9uZyBEQiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgY8OybiBjw7MgdGjhu4MgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgIGNhbl93b3JrID0gc2VsZi5fY2FuX3J1bl9qb2IoY3VycmVudF9hY2NvdW50KQogICAgICAgICAgICBpZiBjYW5fd29yazoKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB24bubaSBkYXRhIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGN1cnJlbnRfYWNjb3VudAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHtjdXJyZW50X2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0ga2jDtG5nIHRo4buDIGzDoG0gdmnhu4djIG7hu69hLCBj4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBraMOhYyIpCiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBraeG7g20gdHJhIHTDoGkga2hv4bqjbiBoaeG7h24gdOG6oWk6IHtlfSIpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIHNhZmVfc2xlZXAoc2VsZiwgc2Vjb25kczogZmxvYXQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTmfhu6cgYW4gdG/DoG4sIGPDsyB0aOG7gyBk4burbmcgbOG6oWkgbmdheSBs4bqtcCB04bupYyBraGkgZm9yY2Vfc3RvcCDEkcaw4bujYyDEkeG6t3QgdGjDoG5oIFRydWUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBzZWNvbmRzOiBT4buRIGdpw6J5IGPhuqduIG5n4bunCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugbmfhu6cgxJHhu6cgdGjhu51pIGdpYW4sIEZhbHNlIG7hur91IGLhu4sgZOG7q25nIGzhuqFpCiAgICAgICAgIiIiCiAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgY2hlY2tfaW50ZXJ2YWwgPSBKb2JTZXJ2aWNlQ29uc3RhbnRzLkRFRkFVTFRfQ0hFQ0tfSU5URVJWQUwgICMgS2nhu4NtIHRyYSBt4buXaSAwLjUgZ2nDonkKICAgICAgICAKICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUgPCBzZWNvbmRzOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgY8OzIHnDqnUgY+G6p3UgZOG7q25nCiAgICAgICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgICAgIGlmIHNlbGYuZm9yY2Vfc3RvcCBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBOZ+G7pyBt4buZdCBraG/huqNuZyBuZ+G6r24KICAgICAgICAgICAgc2xlZXBfdGltZSA9IG1pbihjaGVja19pbnRlcnZhbCwgc2Vjb25kcyAtICh0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUpKQogICAgICAgICAgICBpZiBzbGVlcF90aW1lID4gMDoKICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoc2xlZXBfdGltZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIGluaXRpYWxpemUoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgdOG6oW8gSm9iU2VydmljZQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Uga2jhu59pIHThuqFvIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGto4bufaSB04bqhbyBKb2JTZXJ2aWNlLi4uIikKICAgICAgICAKICAgICAgICAjIDEuIEtp4buDbSB0cmEgSGVscGVyU2VydmljZQogICAgICAgIGhlbHBlcl9zdWNjZXNzLCBoZWxwZXJfZGF0YSA9IHV0aWxzLmNoZWNrX2hlbHBlcl9zZXJ2aWNlKHNlbGYuaGVscGVyKQogICAgICAgIGlmIG5vdCBoZWxwZXJfc3VjY2VzczoKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga+G6v3QgbuG7kWkgxJHhur9uIEhlbHBlclNlcnZpY2UuIFZ1aSBsw7JuZyBraeG7g20gdHJhIGzhuqFpLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEzGsHUgdGjDtG5nIHRpbiB0aGnhur90IGLhu4sgbuG6v3UgY8OzCiAgICAgICAgaWYgaGVscGVyX2RhdGEgYW5kICJkYXRhIiBpbiBoZWxwZXJfZGF0YToKICAgICAgICAgICAgc2VsZi5kYi5zYXZlX2RldmljZV9pbmZvKGhlbHBlcl9kYXRhKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgbMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7izoge2hlbHBlcl9kYXRhWydkYXRhJ10uZ2V0KCdkZXZpY2VfbW9kZWwnLCAnVW5rbm93bicpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAjIDMuIEzGsHUgY8OhYyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgc2VsZi5fc2F2ZV9kZWZhdWx0X2NvbmZpZ3MoKQogICAgICAgICAgICAKICAgICAgICAKICAgICAgICAKICAgICAgICAjIDUuIEto4bufaSB04bqhbyBjw6FjIGpvYiBoYW5kbGVyCiAgICAgICAgc2VsZi5faW5pdF9qb2JfaGFuZGxlcnMoKQogICAgICAgIAogICAgICAgICMgNi4gS2jhu59pIHThuqFvIG5nw6B5IGN14buRaSBjw7luZyDEkcOjIHJlc2V0IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgdG9kYXkgPSBub3cuZGF0ZSgpCiAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgCiAgICAgICAgaWYgbm90IGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgICMgTuG6v3UgaGnhu4duIHThuqFpIMSRw6MgcXVhIGdp4budIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5LCDEkcOhbmggZOG6pXUgxJHDoyByZXNldAogICAgICAgICAgICBpZiBub3cgPj0gcmVzZXRfdGltZToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IHRvZGF5CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIE7hur91IGNoxrBhIMSR4bq/biBnaeG7nSByZXNldCwgxJHDoW5oIGThuqV1IGzDoCDEkcOjIHJlc2V0IG5nw6B5IGjDtG0gcXVhCiAgICAgICAgICAgICAgICBsYXN0X3Jlc2V0X2RhdGUgPSB0b2RheSAtIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgc2VsZi5kYi5zZXQoImxhc3RfcmVzZXRfZGF0ZSIsIGxhc3RfcmVzZXRfZGF0ZS5pc29mb3JtYXQoKSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJLaOG7n2kgdOG6oW8gbmfDoHkgcmVzZXQ6IHtsYXN0X3Jlc2V0X2RhdGV9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgIAogICAgICAgIHNlbGYuaXNfaW5pdGlhbGl6ZWQgPSBUcnVlCiAgICAgICAgbG9nZ2VyLmluZm8oIkto4bufaSB04bqhbyBKb2JTZXJ2aWNlIHRow6BuaCBjw7RuZy4iKQogICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgCiAgICBkZWYgX2NoZWNrX2FjY291bnRfc3luY19zdGF0dXMoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24ga2nhu4NtIHRyYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuqduIMSR4buTbmcgYuG7mSBs4bqhaSwgRmFsc2UgbuG6v3Uga2jDtG5nIGPhuqduCiAgICAgICAgIiIiCiAgICAgICAgIyBM4bqleSB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB04burIGRhdGFiYXNlCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIHN5bmNfc3RhdHVzID0gc2VsZi5kYi5nZXQoc3luY19zdGF0dXNfa2V5LCBGYWxzZSkgICMgTeG6t2MgxJHhu4tuaCBsw6AgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgCiAgICAgICAgIyBO4bq/dSBjaMawYSDEkeG7k25nIGLhu5kgdGjDrCBj4bqnbiDEkeG7k25nIGLhu5kgbOG6oWkKICAgICAgICByZXR1cm4gbm90IHN5bmNfc3RhdHVzCiAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIHN0YXR1czogYm9vbCA9IFRydWUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBj4bunYSBt4buZdCBhcHAKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIHN0YXR1czogVHJ1ZSBu4bq/dSDEkcOjIMSR4buTbmcgYuG7mSwgRmFsc2UgbuG6v3UgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgIiIiCiAgICAgICAgc3luY19zdGF0dXNfa2V5ID0gZiJ7YXBwX25hbWV9X3N5bmNfc3RhdHVzIgogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgc2VsZi5kYi5zZXQoc3luY19zdGF0dXNfa2V5LCBzdGF0dXMpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfToge3N0YXR1c30iKQogICAgICAgIAogICAgZGVmIF9zeW5jX2FjY291bnRzX2Zvcl9hcHAoc2VsZiwgYXBwX25hbWU6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHbDoCBtYXAgdMOgaSBraG/huqNuIEdvTGlrZSBjaG8gbeG7mXQgYXBwIGPhu6UgdGjhu4MKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHBfbmFtZTogVMOqbiDhu6luZyBk4bulbmcgY+G6p24gxJHhu5NuZyBi4buZCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0w6xtIHRo4bqleSBqb2IgaGFuZGxlciBjaG8ge2FwcF9uYW1lfSwgYuG7jyBxdWEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CgogICAgICAgICAgICAjIDEuIMSQ4buTbmcgYuG7mSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyDEkeG7k25nIGLhu5kgdMOgaSBraG/huqNuIHthcHBfbmFtZX0uLi4iKQogICAgICAgICAgICBhY2NvdW50cyA9IGhhbmRsZXIuc3luY19hY2NvdW50c190b19kYigpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG7k25nIGLhu5kge2xlbihhY2NvdW50cyl9IHTDoGkga2hv4bqjbiB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiB0aMOsIGtow7RuZyBsw6BtIGfDrAogICAgICAgICAgICBpZiBub3QgYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gxJHGsOG7o2MgxJHhu5NuZyBi4buZIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSBtYXBwaW5nIEdvTGlrZSIpCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSR4buTbmcgYuG7mQogICAgICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIFRydWUpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyAyLiBNYXAgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQYW5nIGzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIEdvTGlrZSBjaG8ge2FwcF9uYW1lfS4uLiIpCiAgICAgICAgICAgIGdvbGlrZV9hY2NvdW50cyA9IGhhbmRsZXIuZ2V0X2dvbGlrZV9hY2NvdW50cygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBnb2xpa2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkge2xlbihnb2xpa2VfYWNjb3VudHMpfSB0w6BpIGtob+G6o24gR29MaWtlIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgIGRldmljZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDDgW5oIHjhuqEgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBoYW5kbGVyLm1hcF9nb2xpa2VfYWNjb3VudHMoZ29saWtlX2FjY291bnRzLCBkZXZpY2VfYWNjb3VudHMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDDoW5oIHjhuqEge2xlbihtYXBwZWRfYWNjb3VudHMpfSB0w6BpIGtob+G6o24ge2FwcF9uYW1lfSB24bubaSBHb0xpa2UiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIEdvTGlrZSBuw6BvIGNobyB7YXBwX25hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lLCBUcnVlKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgZiJM4buXaSBraGkgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiB2w6AgbWFwIEdvTGlrZSBjaG8ge2FwcF9uYW1lfSIpCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2FjY291bnRfc3luY19zdGF0dXMoYXBwX25hbWUsIEZhbHNlKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAKICAgIGRlZiBfc2F2ZV9kZWZhdWx0X2NvbmZpZ3Moc2VsZik6CiAgICAgICAgIiIiTMawdSBjw6FjIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdsOgbyBkYXRhYmFzZSBu4bq/dSBjaMawYSBjw7MiIiIKICAgICAgICBkZWZhdWx0X2NvbmZpZ3MgPSB7CiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggbGnDqm4gcXVhbiDEkeG6v24gdGjhu51pIGdpYW4gbMOgbSBqb2IKICAgICAgICAgICAgImpvYl9ob3VyIjogY29uZmlnLkpPQl9IT1VSLAogICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAiam9iX2NoZWNrX2ludGVydmFsIjogY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCwKICAgICAgICAgICAgImNvb2xkb3duX2dldF9qb2JfZ29saWtlIjogMzAsICAjIFRo4budaSBnaWFuIGNo4budIChwaMO6dCkga2hpIGtow7RuZyB0w6xtIHRo4bqleSBqb2IgR29MaWtlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIHPhu5EgbMaw4bujbmcgam9iCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfZGF5IjogY29uZmlnLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRy4bqhbmcgdGjDoWkgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgICJwYXVzZV9qb2IiOiBGYWxzZSwKICAgICAgICAgICAgIyBUcuG6oW5nIHRow6FpIHRoaeG6v3QgYuG7iyDEkWFuZyBsw6BtIHZp4buHYwogICAgICAgICAgICAiZGV2aWNlX2lzX3dvcmtpbmciOiBGYWxzZSwKICAgICAgICAgICAgImRldmljZV9tZXNzYWdlIjogIiIsCiAgICAgICAgICAgIAogICAgICAgICAgICAjIERhbmggc8OhY2ggY8OhYyBhcHAgxJHGsOG7o2Mga8OtY2ggaG/huqF0CiAgICAgICAgICAgICJlbmFibGVkX2FwcHMiOiBjb25maWcuRU5BQkxFRF9BUFBTLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBTbWFydCBjYXJlIHN5c3RlbSAtIGNvbmZpZyB04buRaSBnaeG6o24gKHRoYXkgdGjhur8gY2FyZV9pbl93b3JraW5nX2pvYiBjxakpCiAgICAgICAgICAgICJlbmFibGVfY2FyZSI6IFRydWUsICAgICAgICAgICAgICAgICAgICAjIELhuq10L3Thuq90IHRvw6BuIGLhu5kgaOG7hyB0aOG7kW5nIGNhcmUKICAgICAgICAgICAgImNhcmVfaW50ZXJ2YWxfaG91cnMiOiBjb25maWcuU01BUlRfQ0FSRV9JTlRFUlZBTF9IT1VSUywgICMgS2hv4bqjbmcgY8OhY2ggZ2nhu69hIGPDoWMgbOG6p24gY2FyZSB04burIGNvbmZpZwogICAgICAgICAgICAiY2FyZV9jaGFuY2VfcGVyY2VudCI6IGNvbmZpZy5TTUFSVF9DQVJFX0NIQU5DRV9QRVJDRU5ULCAgIyBU4bu3IGzhu4cgY2FyZSBuZ+G6q3Ugbmhpw6puIHThu6sgY29uZmlnCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhuqV1IGjDrG5oIGdpw6EgdOG7kWkgdGhp4buDdSBjaG8gam9iIGZvbGxvdwogICAgICAgICAgICAibWluX2ZvbGxvd19wcmljZSI6IDIwLAogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqldSBow6xuaCB44butIGzDvSB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgIm1heF91bmZvbGxvd19hdHRlbXB0cyI6IGNvbmZpZy5NQVhfVU5GT0xMT1dfQVRURU1QVFMsCiAgICAgICAgICAgICJ1bmZvbGxvd19wZW5hbHR5X21pbnV0ZXMiOiA3MjAsICAjIE3hurdjIMSR4buLbmggMTIgZ2nhu50sIGPDsyB0aOG7gyDEkWnhu4F1IGNo4buJbmggdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggcHJveHkKICAgICAgICAgICAgInVzZV9wcm94eSI6IEZhbHNlLCAgIyBDw7Mgc+G7rSBk4bulbmcgcHJveHkga2jDtG5nCiAgICAgICAgICAgICJwcm94eV9zZXJ2ZXIiOiAiaHR0cDovLzEwLjAuMC41OjkwMzIiLCAgIyBTZXJ2ZXIgcHJveHkgbeG6t2MgxJHhu4tuaAogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3Iga2V5LCB2YWx1ZSBpbiBkZWZhdWx0X2NvbmZpZ3MuaXRlbXMoKToKICAgICAgICAgICAgIyBDaOG7iSBsxrB1IG7hur91IGNoxrBhIGPDsyB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBpZiBzZWxmLmRiLmdldChrZXkpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldChrZXksIHZhbHVlKQogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoyBsxrB1IGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmg6IHtrZXl9PXt2YWx1ZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ+G6pXUgaMOsbmgge2tleX0gxJHDoyB04buTbiB04bqhaToge3NlbGYuZGIuZ2V0KGtleSl9IikKICAgICAgICAKICAgIGRlZiBfaW5pdF9qb2JfaGFuZGxlcnMoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPDoWMgam9iIGhhbmRsZXIiIiIKICAgICAgICAjIGluaXQgdGjDrCBz4bq9IGluaXQgaGFuZGxlcnMgY2hvIHThuqV0IGPhuqMgY8OhYyBhcHAsIGzDoG0gYXBwIG7DoG8gdGjDrCBz4bq9IHRoZW8gY+G6pXUgaMOsbmggbOG6pXkgdOG7qyBkYXRhYmFzZQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBjb25maWcuRU5BQkxFRF9BUFBTOgogICAgICAgICAgICBpZiBhcHBfbmFtZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXSA9IFRpa3Rva0pvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgIHByb3h5X3NlcnZpY2UgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJ0aWt0b2syIjoKICAgICAgICAgICAgICAgIGZyb20gam9icy50aWt0b2syX2pvYiBpbXBvcnQgVGlrdG9rMkpvYgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gVGlrdG9rMkpvYihzZWxmLmRiLCBzZWxmLmhlbHBlciwgc2VsZi5nb2xpa2Vfc2VydmljZSkKICAgICAgICAgICAgICAgICMgVHJ1eeG7gW4gcGjGsMahbmcgdGjhu6ljIHNhZmVfc2xlZXAgdsOgIHByb3h5X3NlcnZpY2UgdsOgbyBqb2IgaGFuZGxlcgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdLnNldF9zbGVlcF9mdW5jdGlvbihzZWxmLnNhZmVfc2xlZXApCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3Byb3h5X3NlcnZpY2Uoc2VsZi5wcm94eV9zZXJ2aWNlKQogICAgICAgICAgICBlbGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICAgICAgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdID0gSW5zdGFncmFtSm9iKHNlbGYuZGIsIHNlbGYuaGVscGVyLCBzZWxmLmdvbGlrZV9zZXJ2aWNlKQogICAgICAgICAgICAgICAgIyBUcnV54buBbiBwaMawxqFuZyB0aOG7qWMgc2FmZV9zbGVlcCB2w6AgcHJveHlfc2VydmljZSB2w6BvIGpvYiBoYW5kbGVyCiAgICAgICAgICAgICAgICBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0uc2V0X3NsZWVwX2Z1bmN0aW9uKHNlbGYuc2FmZV9zbGVlcCkKICAgICAgICAgICAgICAgIHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXS5zZXRfcHJveHlfc2VydmljZShzZWxmLnByb3h5X3NlcnZpY2UpCiAgICAgICAgICAgICAgICAKICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mga2jhu59pIHThuqFvIHtsZW4oc2VsZi5qb2JfaGFuZGxlcnMpfSBqb2IgaGFuZGxlcjogeycsICcuam9pbihzZWxmLmpvYl9oYW5kbGVycy5rZXlzKCkpfSIpCiAgICAgICAgCiAgICBkZWYgX3Jlc2V0X2RhaWx5X2NvdW50ZXJzKHNlbGYpOgogICAgICAgICIiIlJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IHbDoG8gZ2nhu50gxJHGsOG7o2MgY+G6pXUgaMOsbmgiIiIKICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgIHRvZGF5ID0gbm93LmRhdGUoKQogICAgICAgIAogICAgICAgICMgTOG6pXkgZ2nhu50gcmVzZXQgdOG7qyBj4bqldSBow6xuaCBob+G6t2MgdOG7qyBkYXRhYmFzZSBu4bq/dSBjw7MKICAgICAgICBqb2JfaG91ciA9IHNlbGYuZGIuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICAKICAgICAgICAjIFTDrW5oIHRo4budaSDEkWnhu4NtIHJlc2V0IGPhu6dhIG5nw6B5IGjDtG0gbmF5CiAgICAgICAgcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9kYXksIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgIAogICAgICAgICMgTOG6pXkgbmfDoHkgcmVzZXQgY3Xhu5FpIGPDuW5nIHThu6sgZGF0YWJhc2UKICAgICAgICBsYXN0X3Jlc2V0X2RhdGVfc3RyID0gc2VsZi5kYi5nZXQoImxhc3RfcmVzZXRfZGF0ZSIpCiAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gTm9uZQogICAgICAgIAogICAgICAgIGlmIGxhc3RfcmVzZXRfZGF0ZV9zdHI6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxhc3RfcmVzZXRfZGF0ZSA9IGRhdGV0aW1lLmRhdGUuZnJvbWlzb2Zvcm1hdChsYXN0X3Jlc2V0X2RhdGVfc3RyKQogICAgICAgICAgICBleGNlcHQgVmFsdWVFcnJvcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIsSQ4buLbmggZOG6oW5nIG5nw6B5IHJlc2V0IGtow7RuZyBo4bujcCBs4buHOiB7bGFzdF9yZXNldF9kYXRlX3N0cn0iKQogICAgICAgICAgICAgICAgbGFzdF9yZXNldF9kYXRlID0gTm9uZQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyBxdWEgZ2nhu50gcmVzZXQgY+G7p2EgbmfDoHkgaMO0bSBuYXkgY2jGsGEgdsOgIGNoxrBhIHJlc2V0IHRyb25nIG5nw6B5IGjDtG0gbmF5CiAgICAgICAgaWYgbm93ID49IHJlc2V0X3RpbWUgYW5kIChsYXN0X3Jlc2V0X2RhdGUgaXMgTm9uZSBvciBsYXN0X3Jlc2V0X2RhdGUgPCB0b2RheSk6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu7FjIGhp4buHbiByZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSAoZ2nhu50gcmVzZXQ6IHtqb2JfaG91cn06MDApIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgY8OhYyBi4buZIMSR4bq/bSBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24KICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgc+G7kSBqb2IgaMO0bSBuYXkgdsOgIHNlc3Npb24gY291bnRlcnMKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgImpvYl90b2RheSI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICJmb2xsb3dfdG9kYXkiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF92aWV3X3N0b3JpZXMiOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IHRy4bqhbmcgdGjDoWkgZm9sbG93IGtoaSBjaHV54buDbiBuZ8OgeSBt4bubaQogICAgICAgICAgICAgICAgICAgICMgRW5hYmxlIGzhuqFpIGZvbGxvdyBu4bq/dSBi4buLIGRpc2FibGUgdsOsIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IG5nw6B5IGhv4bq3YyBwaGnDqm4KICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbiA9IGFjY291bnQuZ2V0KCJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIiwgIiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlYXNvbiBpbiBbIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgbmfDoHkiLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBwaGnDqm4iLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyIsICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHNlc3Npb24iXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5hYmxlX2FjY291bnRfZm9sbG93KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgZW5hYmxlIGzhuqFpIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHNhdSBraGkgcmVzZXQgbmfDoHkgKGzDvSBkbyBjxak6IHtyZWFzb259KSIpCiAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSB24bqrbiBkaXNhYmxlIGZvbGxvdyAobMO9IGRvOiB7cmVhc29ufSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIHbDrCDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5LAogICAgICAgICAgICAgICAgICAgICMgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgdGjDoG5oIGFjdGl2ZQogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnQuZ2V0KCJzdGF0dXMiKSA9PSAiaW5hY3RpdmUiIGFuZCBhY2NvdW50LmdldCgiaW5hY3RpdmVfcmVhc29uIikgPT0gIsSQw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgaMOgbmcgbmfDoHkiOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyDEkeG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBhY3RpdmUgY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBzYXUga2hpIHJlc2V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHJlc2V0IGLhu5kgxJHhur9tIGjDoG5nIG5nw6B5IGNobyB04bqldCBj4bqjIHTDoGkga2hv4bqjbiB2w6BvIHtub3cuc3RyZnRpbWUoJyVZLSVtLSVkICVIOiVNOiVTJyl9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IG5nw6B5IMSRw6MgcmVzZXQgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICBzZWxmLmRiLnNldCgibGFzdF9yZXNldF9kYXRlIiwgdG9kYXkuaXNvZm9ybWF0KCkpCiAgICAgICAgCiAgICBkZWYgX2Nhbl9ydW5fam9iKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0aOG7gyBjaOG6oXkgam9iIGNobyB0w6BpIGtob+G6o24ga2jDtG5nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgdGjhu4MgY2jhuqF5IGpvYiwgRmFsc2UgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgICMgMS4gS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbgogICAgICAgIGlmIG5vdCBzZWxmLl9jaGVja19iYXNpY19hY2NvdW50X3N0YXR1cyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMi4gS2nhu4NtIHRyYSDEkWnhu4F1IGtp4buHbiBj4bqnbiB0aGnhur90CiAgICAgICAgaWYgbm90IHNlbGYuX2NoZWNrX2FjY291bnRfcHJlcmVxdWlzaXRlcyhhY2NvdW50KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICMgMy4gxJDhuqNtIGLhuqNvIGPDoWMgZ2nhu5tpIGjhuqFuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAKICAgICAgICBhY2NvdW50ID0gc2VsZi5fZW5zdXJlX2FjY291bnRfbGltaXRzX3NldChhY2NvdW50KQogICAgICAgIAogICAgICAgICMgNC4gS2nhu4NtIHRyYSBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5CiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChhY2NvdW50KToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KGFjY291bnRbImlkIl0sICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IikKICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2Zvcl9hY2NvdW50KGFjY291bnQpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIDUuIEtp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGpvYiB0cm9uZyBzZXNzaW9uCiAgICAgICAgaWYgc2VsZi5faXNfYWNjb3VudF9hdF9zZXNzaW9uX2xpbWl0KGFjY291bnQpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgIyAuLi5LSMOUTkcga2nhu4NtIHRyYSBmb2xsb3cg4bufIMSRw6J5LCBjaOG7iSBraeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIGNodW5nLi4uCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYmFzaWNfYWNjb3VudF9zdGF0dXMoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIGPGoSBi4bqjbiBj4bunYSB0w6BpIGtob+G6o24iIiIKICAgICAgICBhY2NvdW50X3N0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiYWN0aXZlIikKICAgICAgICAKICAgICAgICAjIE7hur91IHTDoGkga2hv4bqjbiBi4buLIGRpc2FibGVkLCBraMO0bmcgY2hvIGNo4bqheSBqb2IKICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiZGlzYWJsZWQiOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJHDoyBsb2dvdXQsIGtow7RuZyBjaG8gY2jhuqF5IGpvYgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzID09ICJsb2dvdXQiOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSB0w6BpIGtob+G6o24gxJFhbmcgaW5hY3RpdmUsIGtp4buDbSB0cmEgdGjhu51pIGdpYW4gY29vbGRvd24KICAgICAgICBpZiBhY2NvdW50X3N0YXR1cyA9PSAiaW5hY3RpdmUiOgogICAgICAgICAgICByZXR1cm4gc2VsZi5faGFuZGxlX2luYWN0aXZlX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2luYWN0aXZlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiWOG7rSBsw70gdMOgaSBraG/huqNuIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGluYWN0aXZlIiIiCiAgICAgICAgam9iX2Rpc2FibGVfdW50aWwgPSBhY2NvdW50LmdldCgiam9iX2Rpc2FibGVfdW50aWwiLCAwKQogICAgICAgIHVzZXJuYW1lID0gYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICdVbmtub3duJykKICAgICAgICAKICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY29vbGRvd24sIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIHbhu4EgYWN0aXZlCiAgICAgICAgaWYgam9iX2Rpc2FibGVfdW50aWwgPD0gdGltZS50aW1lKCk6CiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgduG7gSBhY3RpdmUKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsCiAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiAwLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHTDoGkga2hv4bqjbiBhY3RpdmUgbOG6oWkKICAgICAgICAgICAgaWYgYWNjb3VudFsiaWQiXSBpbiBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHM6CiAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgRW5hYmxlIGzhuqFpIGZvbGxvdyBu4bq/dSBi4buLIGRpc2FibGUgdsOsIGdp4bubaSBo4bqhbiBwaGnDqm4gKGtow7RuZyBwaOG6o2kgdsOsIGdp4bubaSBo4bqhbiBuZ8OgeSkKICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImRpc2FibGVfZm9sbG93IiwgRmFsc2UpOgogICAgICAgICAgICAgICAgcmVhc29uID0gYWNjb3VudC5nZXQoImluYWN0aXZlX2ZvbGxvd19yZWFzb24iLCAiIikKICAgICAgICAgICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKQogICAgICAgICAgICAgICAgbWF4X2ZvbGxvd19kYXkgPSBhY2NvdW50LmdldCgibWF4X2ZvbGxvd19kYXkiLCAyMCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgcmVhc29uID09ICLEkMOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IHBoacOqbiI6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBuZ8OgeSBjaMawYQogICAgICAgICAgICAgICAgICAgIGlmIGZvbGxvd190b2RheSA8IG1heF9mb2xsb3dfZGF5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmVuYWJsZV9hY2NvdW50X2ZvbGxvdyhhY2NvdW50WyJpZCJdKQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgZW5hYmxlIGzhuqFpIGZvbGxvdyBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0ga2hpIGLhuq90IMSR4bqndSBzZXNzaW9uIG3hu5tpIChmb2xsb3dfdG9kYXk6IHtmb2xsb3dfdG9kYXl9L3ttYXhfZm9sbG93X2RheX0pIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgbmfDoHkgKHtmb2xsb3dfdG9kYXl9L3ttYXhfZm9sbG93X2RheX0pLCBraMO0bmcgZW5hYmxlIGZvbGxvdyIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gduG6q24gZGlzYWJsZSBmb2xsb3cgKGzDvSBkbzoge3JlYXNvbn0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSwgxJHDoyBjaHV54buDbiB24buBIHRy4bqhbmcgdGjDoWkgYWN0aXZlIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIENoxrBhIGjhur90IHRo4budaSBnaWFuIGNo4budCiAgICAgICAgICAgIGNvb2xkb3duX3JlbWFpbiA9IGludCgoam9iX2Rpc2FibGVfdW50aWwgLSB0aW1lLnRpbWUoKSkgLyA2MCkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyB0cm9uZyB0aOG7nWkgZ2lhbiBjaOG7nSAoY8OybiB7Y29vbGRvd25fcmVtYWlufSBwaMO6dCkiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKHNlbGYsIGFwcF9uYW1lOiBzdHIsIGFjY291bnRfaWQ6IGludCwgaXNfbG9naW46IGJvb2wpOgogICAgICAgICIiIgogICAgICAgIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIMSRxINuZyBuaOG6rXAgY+G7p2EgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwCiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIHTDoGkga2hv4bqjbiAKICAgICAgICAgICAgaXNfbG9naW46IFRydWUgbuG6v3UgxJHDoyDEkcSDbmcgbmjhuq1wLCBGYWxzZSBu4bq/dSBsb2dvdXQKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRhdGFiYXNlIC0gc+G7rSBk4bulbmcgZmllbGQgaXNfbG9naW4gxJHhu4MgbmjhuqV0IHF1w6FuIHbhu5tpIERCIHNjaGVtYQogICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHsKICAgICAgICAgICAgICAgICJpc19sb2dpbiI6IGlzX2xvZ2luLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcgdHJvbmcgbWVtb3J5CiAgICAgICAgICAgIGlmIGlzX2xvZ2luOgogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdMOgaSBraG/huqNuIGtow6FjIGPhu6dhIGPDuW5nIGFwcCBsw6AgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIG9sZF9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBpZiBvbGRfYWNjb3VudF9pZCAhPSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KG9sZF9hY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBjxakge29sZF9hY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkgbG9nb3V0IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMxrB1IHTDoGkga2hv4bqjbiBt4bubaQogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0gPSBhY2NvdW50X2lkCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgWMOzYSBraOG7j2kgdHJhY2tpbmcgbuG6v3UgbG9nb3V0CiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzIGFuZCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgIGRlbCBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSAoe2FwcF9uYW1lfSkga2jhu49pIHRyYWNraW5nIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wOiB7ZX0iKQogICAgICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9wcmVyZXF1aXNpdGVzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIktp4buDbSB0cmEgY8OhYyDEkWnhu4F1IGtp4buHbiB0acOqbiBxdXnhur90IGPhu6dhIHTDoGkga2hv4bqjbiBjaG8gSk9CUyAoa2jDtG5nIMOhcCBk4bulbmcgY2hvIHNtYXJ0IGNhcmUpIiIiCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRxrDhu6NjIGLhuq10IGpvYiBraMO0bmcKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIGxpw6puIGvhur90IHbhu5tpIEdvTGlrZSBjaMawYSAoY2jhu4kgY2hvIEpPQlMsIGtow7RuZyBjaG8gc21hcnQgY2FyZSkKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImlzX2dvbGlrZV9saW5rZWQiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9jaGVja19hY2NvdW50X3ByZXJlcXVpc2l0ZXNfZm9yX2NhcmUoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiS2nhu4NtIHRyYSBjw6FjIMSRaeG7gXUga2nhu4duIHRpw6puIHF1eeG6v3QgY+G7p2EgdMOgaSBraG/huqNuIGNobyBTTUFSVCBDQVJFICjDrXQgaOG6oW4gY2jhur8gaMahbikiIiIKICAgICAgICAjIENo4buJIGtp4buDbSB0cmEgam9iX2VuYWJsZSwga2jDtG5nIGPhuqduIGlzX2dvbGlrZV9saW5rZWQgY2hvIHNtYXJ0IGNhcmUKICAgICAgICBpZiBub3QgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gY+G7p2EgdMOgaSBraG/huqNuIMSRxrDhu6NjIHRoaeG6v3QgbOG6rXAgduG7m2kgZ2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRow7RuZyB0aW4gdMOgaSBraG/huqNuIMSRw6MgxJHGsOG7o2MgY+G6rXAgbmjhuq10CiAgICAgICAgIiIiCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7fQogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgdGhp4bq/dCBs4bqtcCBqb2JfbWF4X2RheQogICAgICAgIGlmIGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIDw9IDA6CiAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJqb2JfbWF4X2RheSJdID0gY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB0aGnhur90IGzhuq1wIG1heF9qb2JzX3Blcl9zZXNzaW9uCiAgICAgICAgaWYgYWNjb3VudC5nZXQoIm1heF9qb2JzX3Blcl9zZXNzaW9uIiwgMCkgPD0gMDoKICAgICAgICAgICAgdXBkYXRlX2RhdGFbIm1heF9qb2JzX3Blcl9zZXNzaW9uIl0gPSBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04KICAgICAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdsOgbyBkYXRhYmFzZSBu4bq/dSBjw7MgdGhheSDEkeG7lWkKICAgICAgICBpZiB1cGRhdGVfZGF0YToKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfZm9yX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB0xrDGoW5nIOG7qW5nIHbhu5tpIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgIiIiCiAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICBpZiBhcHBfbmFtZSBhbmQgYXBwX25hbWUgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgaWYgaGFzYXR0cihoYW5kbGVyLCAnYXBwX3BhY2thZ2UnKToKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLmNsb3NlX2FwcChoYW5kbGVyLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9hdF9kYWlseV9saW1pdChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIGjDoG5nIG5nw6B5IGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJHDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuCiAgICAgICAgIiIiCiAgICAgICAgam9iX3RvZGF5ID0gYWNjb3VudC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgam9iX21heF9kYXkgPSBhY2NvdW50LmdldCgiam9iX21heF9kYXkiLCAwKSBvciBjb25maWcuTUFYX0pPQlNfUEVSX0RBWQogICAgICAgIHJldHVybiBqb2JfdG9kYXkgPj0gam9iX21heF9kYXkKICAgICAgICAKICAgIGRlZiBfaXNfYWNjb3VudF9hdF9zZXNzaW9uX2xpbWl0KHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgc2Vzc2lvbiBraMO0bmcKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBzZXNzaW9uCiAgICAgICAgIiIiCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTgogICAgICAgIAogICAgICAgIGlmIGpvYnNfZG9uZV9pbl9zZXNzaW9uID49IG1heF9qb2JzX3Blcl9zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBqb2IgdHJvbmcgc2Vzc2lvbiAoe2pvYnNfZG9uZV9pbl9zZXNzaW9ufS97bWF4X2pvYnNfcGVyX3Nlc3Npb259KSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENobyB0w6BpIGtob+G6o24gbmdo4buJIHRoZW8gdGjhu51pIGdpYW4gam9iX2Nvb2xkb3duX21pbnV0ZXMKICAgICAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZGIuZ2V0KCJqb2JfY29vbGRvd25fbWludXRlcyIsIGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMpCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IG5naOG7iSB7Y29vbGRvd25fbWludXRlc30gcGjDunQgc2F1IGtoaSBob8OgbiB0aMOgbmggc2Vzc2lvbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIG1ldGhvZCBjw7Mgc+G6tW4gdHJvbmcgZGJfc2VydmljZSDEkeG7gyDEkeG6t3QgdMOgaSBraG/huqNuIGluYWN0aXZlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRbImlkIl0sCiAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPWNvb2xkb3duX21pbnV0ZXMsCiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJIb8OgbiB0aMOgbmggc2Vzc2lvbiAoe2pvYnNfZG9uZV9pbl9zZXNzaW9ufSBqb2JzKSwgbmdo4buJIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBzZXNzaW9uIGNvdW50ZXIgc2F1IGtoaSDEkeG6t3QgaW5hY3RpdmUKICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgZGVmIF91cGRhdGVfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sID0gVHJ1ZSwgam9iX3R5cGU6IHN0ciA9IE5vbmUsIGpvYl9yZXN1bHQ6IGRpY3QgPSBOb25lKToKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6ogam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgc3VjY2VzczogVHJ1ZSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgam9iX3R5cGU6IExv4bqhaSBqb2IgKGZvbGxvdywgbGlrZSwgZXRjLikKICAgICAgICAgICAgam9iX3Jlc3VsdDogS+G6v3QgcXXhuqMgam9iIChkw7luZyDEkeG7gyB44butIGzDvSB1bmZvbGxvdykKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBqb2IgY8ahIGLhuqNuIChiYW8gZ+G7k20gY+G6oyBmb2xsb3cgc3RhdHMgbuG6v3UgbMOgIGZvbGxvdyBqb2IpCiAgICAgICAgc2VsZi5fdXBkYXRlX2Jhc2ljX2pvYl9zdGF0cyhhY2NvdW50LCBzdWNjZXNzLCBqb2JfdHlwZSkKICAgICAgICAKICAgICAgICAjIFJlc2V0IHPhu5EgbOG6p24gdGjhu60gam9iIHRo4bqldCBi4bqhaSBu4bq/dSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgc2VsZi5mYWlsZWRfam9iX2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAjIFJlc2V0IHVuZm9sbG93IGF0dGVtcHRzIGtoaSBqb2IgdGjDoG5oIGPDtG5nIChraMO0bmcgcGjhuqNpIGLhu4sgdW5mb2xsb3cpCiAgICAgICAgICAgIGlmIG5vdCAoam9iX3Jlc3VsdCBhbmQgam9iX3Jlc3VsdC5nZXQoInVuZm9sbG93IiwgRmFsc2UpKToKICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgCiAgICAgICAgIyDEkOG6o20gYuG6o28gY8OhYyBnaeG7m2kgaOG6oW4gxJHGsOG7o2MgdGhp4bq/dCBs4bqtcAogICAgICAgIGFjY291bnQgPSBzZWxmLl9lbnN1cmVfYWNjb3VudF9saW1pdHNfc2V0KGFjY291bnQpCiAgICAgICAgCiAgICAgICAgIyBC4buPIHF1YSBraeG7g20gdHJhIGdp4bubaSBo4bqhbiBzZXNzaW9uIHbDrCDEkcOjIGNodXnhu4NuIHNhbmcgY29udGludW91cyBwcm9jZXNzaW5nCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHbDoCB44butIGzDvSBnaeG7m2kgaOG6oW4gaMOgbmcgbmfDoHkKICAgICAgICBzZWxmLl9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2IoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIFjhu60gbMO9IHVuZm9sbG93IGNobyBqb2IgZm9sbG93CiAgICAgICAgaWYgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICMgTuG6v3UgYuG7iyB1bmZvbGxvdyAoam9iX3Jlc3VsdCBjw7Mga2V5ICd1bmZvbGxvdycgaG/hurdjIHN0YXR1cyDEkeG6t2MgYmnhu4d0KQogICAgICAgICAgICBpZiBqb2JfcmVzdWx0IGFuZCBqb2JfcmVzdWx0LmdldCgidW5mb2xsb3ciLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAjIFTEg25nIHPhu5EgbOG6p24gYuG7iyB1bmZvbGxvdyBjaG8gdMOgaSBraG/huqNuIG7DoHkKICAgICAgICAgICAgICAgIHVuZm9sbG93X2NvdW50ID0gc2VsZi51bmZvbGxvd19hdHRlbXB0cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gdW5mb2xsb3dfY291bnQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbWF4X3VuZm9sbG93X2F0dGVtcHRzID0gc2VsZi5kYi5nZXQoIm1heF91bmZvbGxvd19hdHRlbXB0cyIsIGNvbmZpZy5NQVhfVU5GT0xMT1dfQVRURU1QVFMpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IGLhu4sgdW5mb2xsb3cgbOG6p24ge3VuZm9sbG93X2NvdW50fS97bWF4X3VuZm9sbG93X2F0dGVtcHRzfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ2jhu4kga2jDs2EgdMOgaSBraG/huqNuIGtoaSDEkeG6oXQgZ2nhu5tpIGjhuqFuIHPhu5EgbOG6p24gdW5mb2xsb3cKICAgICAgICAgICAgICAgIGlmIHVuZm9sbG93X2NvdW50ID49IG1heF91bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXMgPSBzZWxmLmRiLmdldCgidW5mb2xsb3dfcGVuYWx0eV9taW51dGVzIiwgNzIwKSAgIyBN4bq3YyDEkeG7i25oIDEyIGdp4budID0gNzIwIHBow7p0CiAgICAgICAgICAgICAgICAgICAgYXBwX3R5cGUgPSBhY2NvdW50LmdldCgiYXBwIiwgIiIpLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIgc2F1IGtoaSBraMOzYQogICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgYXBwX3R5cGUgPT0gInRpa3RvayI6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVGlrVG9rOiBEaXNhYmxlIHRvw6BuIGLhu5kgdMOgaSBraG/huqNuIChraMO0bmcgY2jhu4kgZm9sbG93KQogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiBUaWtUb2sge3VzZXJuYW1lfSDEkcOjIGLhu4sgdW5mb2xsb3cge3VuZm9sbG93X2NvdW50fSBs4bqnbiwgZGlzYWJsZSB0b8OgbiBi4buZIHTDoGkga2hv4bqjbiB7cGVuYWx0eV9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmUoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50WyJpZCJdLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9cGVuYWx0eV9taW51dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiQuG7iyB1bmZvbGxvdyB7dW5mb2xsb3dfY291bnR9IGzhuqduIChUaWtUb2spIgogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgSW5zdGFncmFtOiBDaOG7iSBkaXNhYmxlIGZvbGxvdywgdMOgaSBraG/huqNuIHbhuqtuIGPDsyB0aOG7gyBsw6BtIGpvYiBraMOhYwogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlTDoGkga2hv4bqjbiBJbnN0YWdyYW0ge3VzZXJuYW1lfSDEkcOjIGLhu4sgdW5mb2xsb3cge3VuZm9sbG93X2NvdW50fSBs4bqnbiwgZGlzYWJsZSBmb2xsb3cge3BlbmFsdHlfbWludXRlc30gcGjDunQiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLmRpc2FibGVfYWNjb3VudF9mb2xsb3coCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRbImlkIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9cGVuYWx0eV9taW51dGVzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhc29uPWYiQuG7iyB1bmZvbGxvdyB7dW5mb2xsb3dfY291bnR9IGzhuqduIgogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gYuG7iyB1bmZvbGxvdyBuaMawbmcgY2jGsGEgxJHhuqF0IGdp4bubaSBo4bqhbiAoe3VuZm9sbG93X2NvdW50fS97bWF4X3VuZm9sbG93X2F0dGVtcHRzfSkiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBKb2IgdGjDoG5oIGPDtG5nIHbDoCBraMO0bmcgYuG7iyB1bmZvbGxvdywgcmVzZXQgY291bnRlcgogICAgICAgICAgICAgICAgaWYgc3VjY2VzcyBhbmQgYWNjb3VudFsiaWQiXSBpbiBzZWxmLnVuZm9sbG93X2F0dGVtcHRzOgogICAgICAgICAgICAgICAgICAgIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHNbYWNjb3VudFsiaWQiXV0gPSAwCiAgICAgICAgICAgIAogICAgZGVmIF91cGRhdGVfYmFzaWNfam9iX3N0YXRzKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBzdWNjZXNzOiBib29sLCBqb2JfdHlwZTogc3RyID0gTm9uZSk6CiAgICAgICAgIiIiQ+G6rXAgbmjhuq10IHRo4buRbmcga8OqIGpvYiBjxqEgYuG6o24gLSBn4buZcCBj4bqjIGZvbGxvdyBzdGF0cyDEkeG7gyB0csOhbmggY+G6rXAgbmjhuq10IHRyw7luZyBs4bq3cCIiIgogICAgICAgIGpvYl90b2RheSA9IGFjY291bnQuZ2V0KCJqb2JfdG9kYXkiLCAwKQogICAgICAgIGpvYnNfZG9uZV9pbl9zZXNzaW9uID0gYWNjb3VudC5nZXQoImpvYnNfZG9uZV9pbl9zZXNzaW9uIiwgMCkKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgCiAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICJsYXN0X2pvYl90aW1lIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIENo4buJIHTEg25nIGNvdW50ZXJzIGtoaSBqb2IgdGjDoG5oIGPDtG5nCiAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgdXBkYXRlX2RhdGEudXBkYXRlKHsKICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiBqb2JfdG9kYXkgKyAxLAogICAgICAgICAgICAgICAgInRvdGFsX2pvYnMiOiBhY2NvdW50LmdldCgidG90YWxfam9icyIsIDApICsgMSwKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMQogICAgICAgICAgICB9KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBsw6AgZm9sbG93IGpvYiwgY+G6rXAgbmjhuq10IGx1w7RuIGZvbGxvdyBzdGF0cyDEkeG7gyB0csOhbmggMiBs4bqnbiBj4bqtcCBuaOG6rXQKICAgICAgICAgICAgaWYgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICBmb2xsb3dfdG9kYXkgPSBhY2NvdW50LmdldCgiZm9sbG93X3RvZGF5IiwgMCkgKyAxCiAgICAgICAgICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApICsgMQogICAgICAgICAgICAgICAgdXBkYXRlX2RhdGEudXBkYXRlKHsKICAgICAgICAgICAgICAgICAgICAiZm9sbG93X3RvZGF5IjogZm9sbG93X3RvZGF5LAogICAgICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IGZvbGxvd19pbl9zZXNzaW9uLAogICAgICAgICAgICAgICAgICAgICJsYXN0X2ZvbGxvd190aW1lIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG9nIHRow7RuZyB0aW4gdOG7lW5nIHF1YW4gduG7gSBqb2JzIChiYW8gZ+G7k20gY+G6oyBmb2xsb3cgbuG6v3UgY8OzKQogICAgICAgICAgICBqb2JzX2RvbmVfc2Vzc2lvbiA9IGpvYnNfZG9uZV9pbl9zZXNzaW9uICsgMQogICAgICAgICAgICBqb2JzX3RvZGF5ID0gam9iX3RvZGF5ICsgMQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgam9iX3R5cGUgYW5kIGpvYl90eXBlLmxvd2VyKCkgPT0gImZvbGxvdyI6CiAgICAgICAgICAgICAgICBmb2xsb3dfdG9kYXkgPSBhY2NvdW50LmdldCgiZm9sbG93X3RvZGF5IiwgMCkgKyAxCiAgICAgICAgICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApICsgMQogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBob8OgbiB0aMOgbmggam9iIHtqb2JfdHlwZX0gLSBTZXNzaW9uOiB7am9ic19kb25lX3Nlc3Npb259L3thY2NvdW50LmdldCgnbWF4X2pvYnNfcGVyX3Nlc3Npb24nLCBjb25maWcuTUFYX0pPQlNfUEVSX1NFU1NJT04pfSAoRm9sbG93OiB7Zm9sbG93X2luX3Nlc3Npb259KSwgSMO0bSBuYXk6IHtqb2JzX3RvZGF5fS97YWNjb3VudC5nZXQoJ2pvYl9tYXhfZGF5JywgY29uZmlnLk1BWF9KT0JTX1BFUl9EQVkpfSAoRm9sbG93OiB7Zm9sbG93X3RvZGF5fSkiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSBob8OgbiB0aMOgbmggam9iIC0gU2Vzc2lvbjoge2pvYnNfZG9uZV9zZXNzaW9ufS97YWNjb3VudC5nZXQoJ21heF9qb2JzX3Blcl9zZXNzaW9uJywgY29uZmlnLk1BWF9KT0JTX1BFUl9TRVNTSU9OKX0sIEjDtG0gbmF5OiB7am9ic190b2RheX0ve2FjY291bnQuZ2V0KCdqb2JfbWF4X2RheScsIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZKX0iKQogICAgICAgICAgICAKICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgIGFjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKSAgIyBD4bqtcCBuaOG6rXQgbG9jYWwgZGF0YQogICAgICAgIAogICAgZGVmIF9jaGVja19kYWlseV9saW1pdF9hZnRlcl9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIktp4buDbSB0cmEgZ2nhu5tpIGjhuqFuIGjDoG5nIG5nw6B5IHNhdSBraGkgbMOgbSBqb2IiIiIKICAgICAgICBqb2JfdG9kYXkgPSBhY2NvdW50LmdldCgiam9iX3RvZGF5IiwgMCkKICAgICAgICBqb2JfbWF4X2RheSA9IGFjY291bnQuZ2V0KCJqb2JfbWF4X2RheSIsIDApIG9yIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZCiAgICAgICAgdXNlcm5hbWUgPSBhY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJ1Vua25vd24nKQogICAgICAgIAogICAgICAgIGlmIGpvYl90b2RheSA+PSBqb2JfbWF4X2RheToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSR4bqhdCBnaeG7m2kgaOG6oW4gam9iIHRyb25nIG5nw6B5ICh7am9iX3RvZGF5fS97am9iX21heF9kYXl9KSIpCiAgICAgICAgICAgIHNlbGYuZGIuc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldChhY2NvdW50WyJpZCJdLCAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpCiAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9mb3JfYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgIGRlZiBfc2V0X2FjY291bnRfbG9nb3V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgdXNlcm5hbWU6IHN0ciA9IE5vbmUpIC0+IE5vbmU6CiAgICAgICAgIiIiCiAgICAgICAgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIGxvZ291dAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnRfaWQ6IElEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICB1c2VybmFtZTogVXNlcm5hbWUgxJHhu4MgbG9nIChvcHRpb25hbCkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVOG6oW8gbWVzc2FnZSB24bubaSBuZ8OgeSBnaeG7nSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICAgICAgbG9nb3V0X21lc3NhZ2UgPSBmIlBow6F0IGhp4buHbiBsb2dvdXQ6IHtjdXJyZW50X3RpbWV9IgogICAgICAgICAgICAKICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogbG9nb3V0X21lc3NhZ2UsCiAgICAgICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGludCh0aW1lLnRpbWUoKSksCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICBpZiBzdWNjZXNzOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24ge3VzZXJuYW1lIG9yIGFjY291bnRfaWR9IGzDoCBsb2dvdXQiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ291dCBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZSBvciBhY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSDEkcOhbmggZOG6pXUgdMOgaSBraG/huqNuIGxvZ291dDoge2V9IikKICAgICAgICAgICAgCiAgICAgICAgCiAgICBkZWYgcmVzZXRfZXhwaXJlZF9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCBraMO0aSBwaOG7pWMgY8OhYyB0w6BpIGtob+G6o24gaW5hY3RpdmUgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBjaOG7nSB2w6AgZGlzYWJsZV9mb2xsb3cgxJHDoyBo4bq/dCBo4bqhbgogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgY3VycmVudF90aW1lID0gaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyAxLiBSZXNldCBpbmFjdGl2ZSBhY2NvdW50cwogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBpbmFjdGl2ZV9hY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSwgc3RhdHVzPSJpbmFjdGl2ZSIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGluYWN0aXZlX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIGNodXnhu4NuIHbhu4EgdHLhuqFuZyB0aMOhaSBhY3RpdmUKICAgICAgICAgICAgICAgICAgICBpZiBqb2JfZGlzYWJsZV91bnRpbCA8PSBjdXJyZW50X3RpbWU6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJhY3RpdmUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB1bmZvbGxvdyBhdHRlbXB0cyBraGkgdMOgaSBraG/huqNuIGFjdGl2ZSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYudW5mb2xsb3dfYXR0ZW1wdHM6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnVuZm9sbG93X2F0dGVtcHRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBmZXRjaCBqb2IgZXJyb3IgY291bnRzIGtoaSB0w6BpIGtob+G6o24gYWN0aXZlIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50sIMSRw6MgY2h1eeG7g24gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gKElEOiB7YWNjb3VudFsnaWQnXX0pIHbhuqtuIMSRYW5nIHRyb25nIHRo4budaSBnaWFuIGNo4budIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMi4gUmVzZXQgZGlzYWJsZV9mb2xsb3cgYWNjb3VudHMgxJHDoyBo4bq/dCBo4bqhbgogICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gc2VsZi5lbmFibGVkX2FwcHM6CiAgICAgICAgICAgICAgICBhbGxfYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFsbF9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50LmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvbGxvd19kaXNhYmxlX3VudGlsID0gYWNjb3VudC5nZXQoImZvbGxvd19kaXNhYmxlX3VudGlsIiwgMCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBo4bq/dCB0aOG7nWkgZ2lhbiBkaXNhYmxlIGZvbGxvdwogICAgICAgICAgICAgICAgICAgICAgICBpZiBmb2xsb3dfZGlzYWJsZV91bnRpbCA+IDAgYW5kIGZvbGxvd19kaXNhYmxlX3VudGlsIDw9IGN1cnJlbnRfdGltZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IChJRDoge2FjY291bnRbJ2lkJ119KSDEkcOjIGjhur90IHRo4budaSBnaWFuIGRpc2FibGUgZm9sbG93LCBlbmFibGUgbOG6oWkiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5lbmFibGVfYWNjb3VudF9mb2xsb3coYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyB0w6BpIGtob+G6o24gaW5hY3RpdmUvZGlzYWJsZV9mb2xsb3ciKQogICAgCiAgICAjID09PT09PT09PT09PT09PT09PT09PT09PT0gU01BUlQgQ0FSRSBTWVNURU0gPT09PT09PT09PT09PT09PT09PT09PT09PQogICAgCiAgICBkZWYgX3Nob3VsZF9wZXJmb3JtX2NhcmVfc21hcnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGNvbnRleHQ6IHN0ciA9ICJpZGxlIikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHRow7RuZyBtaW5oIHhlbSBjw7MgbsOqbiBjYXJlIGtow7RuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGNvbnRleHQ6ICJpZGxlIiAoa2jDtG5nIGPDsyBqb2IpIGhv4bq3YyAiYWZ0ZXJfam9iIiAoc2F1IGtoaSBsw6BtIGpvYikKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBuw6puIGNhcmUsIEZhbHNlIG7hur91IGtow7RuZwogICAgICAgICIiIgogICAgICAgIGlmIG5vdCBzZWxmLmRiLmdldCgiZW5hYmxlX2NhcmUiLCBUcnVlKToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBSYW5kb20gY2hhbmNlIGPGoSBi4bqjbgogICAgICAgIGJhc2VfY2hhbmNlID0gc2VsZi5kYi5nZXQoImNhcmVfY2hhbmNlX3BlcmNlbnQiLCBjb25maWcuU01BUlRfQ0FSRV9DSEFOQ0VfUEVSQ0VOVCkKICAgICAgICAKICAgICAgICAjIMSQaeG7gXUgY2jhu4luaCBjaGFuY2UgZOG7sWEgdHLDqm4gY29udGV4dAogICAgICAgIGlmIGNvbnRleHQgPT0gImFmdGVyX2pvYiI6CiAgICAgICAgICAgIGNoYW5jZSA9IGJhc2VfY2hhbmNlIC8vIDIgICMgMTUlIHNhdSBqb2IgKMOtdCBoxqFuKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGNoYW5jZSA9IGJhc2VfY2hhbmNlICAgICAgICMgMzAlIGtoaSBpZGxlCiAgICAgICAgCiAgICAgICAgaWYgcmFuZG9tLnJhbmRpbnQoMSwgMTAwKSA+IGNoYW5jZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGludGVydmFsIHThu6sgY2FyZV9kYXRhCiAgICAgICAgY2FyZV9kYXRhID0gc2VsZi5kYi5nZXRfYWNjb3VudF9jYXJlX2RhdGEoYWNjb3VudFsiaWQiXSkKICAgICAgICBsYXN0X2NhcmVfdGltZSA9IGNhcmVfZGF0YS5nZXQoImxhc3RfY2FyZV90aW1lIiwgMCkKICAgICAgICBjYXJlX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImNhcmVfaW50ZXJ2YWxfaG91cnMiLCBjb25maWcuU01BUlRfQ0FSRV9JTlRFUlZBTF9IT1VSUykgKiAzNjAwCiAgICAgICAgY3VycmVudF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICBpZiAoY3VycmVudF90aW1lIC0gbGFzdF9jYXJlX3RpbWUpIDwgY2FyZV9pbnRlcnZhbDoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHByb3h5IG7hur91IGLhuq90IGJ14buZYyBz4butIGThu6VuZwogICAgICAgIHVzZV9wcm94eSA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgIGlmIHVzZV9wcm94eToKICAgICAgICAgICAgcHJveHlfc2VydmVyID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygicHJveHlfc2VydmVyIiwgIiIpCiAgICAgICAgICAgIGlmIG5vdCBwcm94eV9zZXJ2ZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgS2jDtG5nIGNhcmUgbuG6v3UgYuG6r3QgYnXhu5ljIHByb3h5IG5oxrBuZyBjaMawYSBj4bqldSBow6xuaAogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAgICAgaWYgbm90IHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBLaMO0bmcgY2FyZSBu4bq/dSBwcm94eSBraMO0bmcgaG/huqF0IMSR4buZbmcKICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQogICAgCiAgICBkZWYgX2dldF9zbWFydF9jYXJlX3R5cGUoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGNvbnRleHQ6IHN0ciA9ICJpZGxlIikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIFThu7EgxJHhu5luZyBjaOG7jW4gbG/huqFpIGNhcmUgcGjDuSBo4bujcCBk4buxYSB0csOqbiB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGNvbnRleHQ6ICJpZGxlIiBob+G6t2MgImFmdGVyX2pvYiIKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBMb+G6oWkgY2FyZSBwaMO5IGjhu6NwCiAgICAgICAgIiIiCiAgICAgICAgIyBQaMOibiB0w61jaCB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiDEkeG7gyBjaOG7jW4gY2FyZSB0eXBlIHBow7kgaOG7o3AKICAgICAgICB0b3RhbF9qb2JzID0gYWNjb3VudC5nZXQoInRvdGFsX2pvYnMiLCAwKQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKQogICAgICAgIAogICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiBwb3N0IHThu6sgY2FyZV9kYXRhCiAgICAgICAgY2FyZV9kYXRhID0gc2VsZi5kYi5nZXRfYWNjb3VudF9jYXJlX2RhdGEoYWNjb3VudFsiaWQiXSkKICAgICAgICBsYXN0X3Bvc3RfdGltZSA9IGNhcmVfZGF0YS5nZXQoImxhc3RfcG9zdF9uZXdmZWVkIiwgMCkKICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgCiAgICAgICAgIyBMb2dpYyB0aMO0bmcgbWluaDoKICAgICAgICAjIDEuIFTDoGkga2hv4bqjbiBt4bubaSAow610IGpvYikgLT4gYW4gdG/DoG4gbmjhuqV0CiAgICAgICAgaWYgdG90YWxfam9icyA8IDEwOgogICAgICAgICAgICByZXR1cm4gInN3aXBlX2ZlZWQiCiAgICAgICAgCiAgICAgICAgIyAyLiBUw6BpIGtob+G6o24gxJHDoyBmb2xsb3cgbmhp4buBdSBow7RtIG5heSAtPiB0csOhbmggZm9sbG93LXJlbGF0ZWQgYWN0aW9ucwogICAgICAgIGVsaWYgZm9sbG93X3RvZGF5ID4gMTA6CiAgICAgICAgICAgIHJldHVybiAid2F0Y2hfY29udGVudCIgICMgd2F0Y2hfcmVlbHMgY2hvIEluc3RhZ3JhbSwgd2F0Y2hfdmlkZW9zIGNobyBUaWtUb2sKICAgICAgICAKICAgICAgICAjIDMuIENvbnRleHQgc2F1IGpvYiAtPiB0aMawIGdpw6NuLCBjw7MgdGjhu4MgxJHEg25nIGLDoGkKICAgICAgICBlbGlmIGNvbnRleHQgPT0gImFmdGVyX2pvYiI6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBu4bq/dSDEkeG7pyDEkWnhu4F1IGtp4buHbiDEkcSDbmcgYsOgaSAoMiBuZ8OgeSkKICAgICAgICAgICAgdHdvX2RheXNfc2Vjb25kcyA9IDIgKiAyNCAqIDYwICogNjAKICAgICAgICAgICAgaWYgbGFzdF9wb3N0X3RpbWUgPT0gMCBvciAoY3VycmVudF90aW1lIC0gbGFzdF9wb3N0X3RpbWUpID49IHR3b19kYXlzX3NlY29uZHM6CiAgICAgICAgICAgICAgICAjIDMwJSBjaGFuY2UgxJHEg25nIGLDoGkga2hpIMSR4bunIMSRaeG7gXUga2nhu4duCiAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZGludCgxLCAxMDApIDw9IDMwOgogICAgICAgICAgICAgICAgICAgIHJldHVybiAicG9zdF9jb250ZW50IgogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIHJhbmRvbS5jaG9pY2UoWyJ3YXRjaF9jb250ZW50IiwgInZpZXdfbm90aWZpY2F0aW9ucyJdKQogICAgICAgIAogICAgICAgICMgNC4gRGVmYXVsdCAtIHJhbmRvbSBnaeG7r2EgY8OhYyBhY3Rpb24gYW4gdG/DoG4KICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEtp4buDbSB0cmEgxJFp4buBdSBraeG7h24gxJHEg25nIGLDoGkgY2hvIGlkbGUgY29udGV4dAogICAgICAgICAgICB0d29fZGF5c19zZWNvbmRzID0gMiAqIDI0ICogNjAgKiA2MAogICAgICAgICAgICBpZiBsYXN0X3Bvc3RfdGltZSA9PSAwIG9yIChjdXJyZW50X3RpbWUgLSBsYXN0X3Bvc3RfdGltZSkgPj0gdHdvX2RheXNfc2Vjb25kczoKICAgICAgICAgICAgICAgICMgMTUlIGNoYW5jZSDEkcSDbmcgYsOgaSBraGkgaWRsZSB2w6AgxJHhu6cgxJFp4buBdSBraeG7h24KICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kaW50KDEsIDEwMCkgPD0gMTU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICJwb3N0X2NvbnRlbnQiCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gcmFuZG9tLmNob2ljZShbInN3aXBlX2ZlZWQiLCAid2F0Y2hfY29udGVudCJdKQogICAgCiAgICBkZWYgX3BlcmZvcm1fc21hcnRfY2FyZShzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgY29udGV4dDogc3RyID0gImlkbGUiKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gY2FyZSB0aMO0bmcgbWluaCAtIHThu7EgxJHhu5luZyBjaOG7jW4gbG/huqFpIGNhcmUgdsOgIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICBjb250ZXh0OiAiaWRsZSIgaG/hurdjICJhZnRlcl9qb2IiCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFwcF9uYW1lID0gYWNjb3VudC5nZXQoImFwcCIsICIiKQogICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgaGFuZGxlciA9IHNlbGYuam9iX2hhbmRsZXJzW2FwcF9uYW1lXQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gxJFhbmcg4bufIMSRw7puZyB0w6BpIGtob+G6o24gdHLGsOG7m2Mga2hpIGNhcmUKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG6o20gYuG6o28gY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAoe2FwcF9uYW1lfSkgdHLGsOG7m2Mga2hpIFNtYXJ0IGNhcmUiKQogICAgICAgICAgICBzd2l0Y2hfcmVzdWx0ID0gaGFuZGxlci5zd2l0Y2hfdG9fYWNjb3VudChhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHN3aXRjaF9yZXN1bHQuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTbWFydCBjYXJlIGLhu4sgaOG7p3kgLSBraMO0bmcgdGjhu4MgY2h1eeG7g24gc2FuZyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge3N3aXRjaF9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY2h1eeG7g24gdGjDoG5oIGPDtG5nIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHhu4MgdGjhu7FjIGhp4buHbiBTbWFydCBjYXJlIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBwcm94eSBu4bq/dSBi4bqvdCBideG7mWMgc+G7rSBk4bulbmcKICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygidXNlX3Byb3h5IiwgRmFsc2UpCiAgICAgICAgICAgIGlmIHVzZV9wcm94eToKICAgICAgICAgICAgICAgIHByb3h5X3NlcnZlciA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoInByb3h5X3NlcnZlciIsICIiKQogICAgICAgICAgICAgICAgaWYgbm90IHByb3h5X3NlcnZlcjoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNtYXJ0IGNhcmUgYuG7iyBo4buneSAtIGLhuq90IGJ14buZYyBkw7luZyBwcm94eSBuaMawbmcgY2jGsGEgY+G6pXUgaMOsbmggcHJveHlfc2VydmVyIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgcHJveHkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTbWFydCBjYXJlIGLhu4sgaOG7p3kgLSBwcm94eSBraMO0bmcgaG/huqF0IMSR4buZbmcgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNtYXJ0IGNhcmUgc+G7rSBk4bulbmcgcHJveHk6IHtwcm94eV9zZXJ2ZXJ9IGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG7sSDEkeG7mW5nIGNo4buNbiBjYXJlIHR5cGUKICAgICAgICAgICAgY2FyZV90eXBlID0gc2VsZi5fZ2V0X3NtYXJ0X2NhcmVfdHlwZShhY2NvdW50LCBjb250ZXh0KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBNYXBwaW5nIG1ldGhvZCB24bubaSB0w6puIMSR4buTbmcgbmjhuqV0IGdp4buvYSBJbnN0YWdyYW0gdsOgIFRpa1RvawogICAgICAgICAgICBjYXJlX21ldGhvZHMgPSB7CiAgICAgICAgICAgICAgICAic3dpcGVfZmVlZCI6ICJfY2FyZV9zd2lwZV9mZWVkIiwgICAgICAgICAgICMgxJDhu5NuZyBuaOG6pXQ6IGzGsOG7m3QgZmVlZAogICAgICAgICAgICAgICAgIndhdGNoX2NvbnRlbnQiOiBzZWxmLl9nZXRfd2F0Y2hfbWV0aG9kKGFwcF9uYW1lKSwgICMgVGjDtG5nIG1pbmg6IHJlZWxzIHZzIHZpZGVvcwogICAgICAgICAgICAgICAgInZpZXdfbm90aWZpY2F0aW9ucyI6ICJfY2FyZV92aWV3X25vdGlmaWNhdGlvbnMiLCAgICMgxJDhu5NuZyBuaOG6pXQ6IHhlbSB0aMO0bmcgYsOhbwogICAgICAgICAgICAgICAgInBvc3RfY29udGVudCI6ICJwb3N0X25ld2ZlZWQiICAgICAgICAgICAgICAjIMSQ4buTbmcgbmjhuqV0OiDEkcSDbmcgYsOgaQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICBtZXRob2RfbmFtZSA9IGNhcmVfbWV0aG9kcy5nZXQoY2FyZV90eXBlLCAiX2NhcmVfc3dpcGVfZmVlZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihoYW5kbGVyLCBtZXRob2RfbmFtZSk6CiAgICAgICAgICAgICAgICBtZXRob2RfbmFtZSA9ICJfY2FyZV9zd2lwZV9mZWVkIiAgIyBGYWxsYmFjayBhbiB0b8OgbiBuaOG6pXQKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBjYXJlCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU21hcnQgY2FyZToge3VzZXJuYW1lfSAoe2FwcF9uYW1lfSkgLT4ge2NhcmVfdHlwZX0gW3ttZXRob2RfbmFtZX1dIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGRldmljZV9tZXNzYWdlIHbhu5tpIGNoaSB0aeG6v3QgY2FyZSB0eXBlCiAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYiQ2FyZToge3VzZXJuYW1lfSAoe2NhcmVfdHlwZX0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIG1ldGhvZCA9IGdldGF0dHIoaGFuZGxlciwgbWV0aG9kX25hbWUpCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBtZXRob2QoYWNjb3VudCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDs25nIGFwcCBzYXUga2hpIGNhcmUgeG9uZyAocXVhbiB0cuG7jW5nIMSR4buDIHRyw6FuaCBhcHAgY2jhuqF5IGJhY2tncm91bmQpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDs25nIGFwcCB7YXBwX25hbWV9IHNhdSBraGkgU21hcnQgY2FyZSBjaG8ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBoYW5kbGVyLmNsb3NlX2FwcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgaGFuZGxlci5zYWZlX3NsZWVwKDIpOiAgIyBDaOG7nSBhcHAgxJHDs25nIGhvw6BuIHRvw6BuCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJTYWZlIHNsZWVwIGLhu4sgaW50ZXJydXB0IGtoaSDEkcOzbmcgYXBwIHNhdSBTbWFydCBjYXJlIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDs25nIGFwcCBzYXUgU21hcnQgY2FyZToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjYXJlX2RhdGEgduG7m2kgdGjDtG5nIHRpbiBjaGkgdGnhur90CiAgICAgICAgICAgICAgICBjdXJyZW50X3RpbWUgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgICAgICBjYXJlX3VwZGF0ZSA9IHsKICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiBjdXJyZW50X3RpbWUsCiAgICAgICAgICAgICAgICAgICAgImxhc3RfY2FyZV90eXBlIjogY2FyZV90eXBlLAogICAgICAgICAgICAgICAgICAgICJsYXN0X2NhcmVfbWV0aG9kIjogbWV0aG9kX25hbWUsCiAgICAgICAgICAgICAgICAgICAgImxhc3RfY2FyZV9jb250ZXh0IjogY29udGV4dCwKICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3Jlc3VsdCI6ICJzdWNjZXNzIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE7hur91IGzDoCBwb3N0X2NvbnRlbnQgdsOgIHRow6BuaCBjw7RuZywgY+G6rXAgbmjhuq10IHRow6ptIGxhc3RfcG9zdF9uZXdmZWVkCiAgICAgICAgICAgICAgICBpZiBjYXJlX3R5cGUgPT0gInBvc3RfY29udGVudCI6CiAgICAgICAgICAgICAgICAgICAgY2FyZV91cGRhdGVbImxhc3RfcG9zdF9uZXdmZWVkIl0gPSBjdXJyZW50X3RpbWUKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNtYXJ0IGNhcmUgLSDEkcSDbmcgYsOgaSB0aMOgbmggY8O0bmc6IHt1c2VybmFtZX0sIGPhuq1wIG5o4bqtdCBsYXN0X3Bvc3RfbmV3ZmVlZCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTWVyZ2UgdsOgbyBjYXJlX2RhdGEgaGnhu4duIGPDswogICAgICAgICAgICAgICAgc2VsZi5kYi5tZXJnZV9hY2NvdW50X2NhcmVfZGF0YShhY2NvdW50WyJpZCJdLCBjYXJlX3VwZGF0ZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBW4bqrbiBj4bqtcCBuaOG6rXQgbGFzdF9jYXJlX3RpbWUgdHJvbmcgYuG6o25nIGNow61uaCDEkeG7gyB0xrDGoW5nIHRow61jaCB24bubaSBjb2RlIGPFqQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50WyJpZCJdLCB7CiAgICAgICAgICAgICAgICAgICAgImxhc3RfY2FyZV90aW1lIjogY3VycmVudF90aW1lLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU21hcnQgY2FyZSB0aMOgbmggY8O0bmc6IHt1c2VybmFtZX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBMxrB1IHRow7RuZyB0aW4gY2FyZSB0aOG6pXQgYuG6oWkgdsOgbyBjYXJlX2RhdGEKICAgICAgICAgICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgICAgIGNhcmVfdXBkYXRlID0gewogICAgICAgICAgICAgICAgICAgICJsYXN0X2NhcmVfYXR0ZW1wdCI6IGN1cnJlbnRfdGltZSwKICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX3R5cGUiOiBjYXJlX3R5cGUsCiAgICAgICAgICAgICAgICAgICAgImxhc3RfY2FyZV9tZXRob2QiOiBtZXRob2RfbmFtZSwKICAgICAgICAgICAgICAgICAgICAibGFzdF9jYXJlX2NvbnRleHQiOiBjb250ZXh0LAogICAgICAgICAgICAgICAgICAgICJsYXN0X2NhcmVfcmVzdWx0IjogImZhaWxlZCIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHNlbGYuZGIubWVyZ2VfYWNjb3VudF9jYXJlX2RhdGEoYWNjb3VudFsiaWQiXSwgY2FyZV91cGRhdGUpCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNtYXJ0IGNhcmUgdGjhuqV0IGLhuqFpOiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBzdWNjZXNzCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgc21hcnQgY2FyZSBjaG8ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnJyl9OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gxJHDs25nIGFwcCBuZ2F5IGPhuqMga2hpIGPDsyBs4buXaQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiLCAiIikKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAge2FwcF9uYW1lfSBzYXUgbOG7l2kgU21hcnQgY2FyZSIpCiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGNsb3NlX2Vycm9yOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgxJHDs25nIGFwcCBzYXUgbOG7l2kgU21hcnQgY2FyZToge2Nsb3NlX2Vycm9yfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9nZXRfd2F0Y2hfbWV0aG9kKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBUcuG6oyB24buBIG1ldGhvZCBuYW1lIHBow7kgaOG7o3AgY2hvIHZp4buHYyB4ZW0gY29udGVudCB0aGVvIHBsYXRmb3JtCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYXBwX25hbWU6IFTDqm4gYXBwICgiaW5zdGFncmFtIiBob+G6t2MgInRpa3RvayIpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVMOqbiBtZXRob2QgcGjDuSBo4bujcAogICAgICAgICIiIgogICAgICAgIGlmIGFwcF9uYW1lID09ICJpbnN0YWdyYW0iOgogICAgICAgICAgICByZXR1cm4gIl9jYXJlX3dhdGNoX3JlZWxzIiAgICAjIEluc3RhZ3JhbTogeGVtIHJlZWxzCiAgICAgICAgZWxpZiBhcHBfbmFtZSA9PSAidGlrdG9rIjoKICAgICAgICAgICAgcmV0dXJuICJfY2FyZV93YXRjaF92aWRlb3MiICAgIyBUaWtUb2s6IHhlbSB2aWRlb3MKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gIl9jYXJlX3N3aXBlX2ZlZWQiICAgICAjIERlZmF1bHQgZmFsbGJhY2sKICAgIAogICAgZGVmIF9nZXRfcmFuZG9tX2FjY291bnRfZm9yX2NhcmUoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHJhbmRvbSAxIHTDoGkga2hv4bqjbiBj4bqnbiBjYXJlICh0w6BpIGtob+G6o24gY8OzIHRy4bqhbmcgdGjDoWkgYWN0aXZlIGhv4bq3YyB3YWl0aW5nKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXTogVMOgaSBraG/huqNuIGPhuqduIGNhcmUgaG/hurdjIE5vbmUKICAgICAgICAiIiIKICAgICAgICBlbmFibGVkX2FwcHMgPSBzZWxmLmRiLmdldCgiZW5hYmxlZF9hcHBzIiwgY29uZmlnLkVOQUJMRURfQVBQUykKICAgICAgICBjYXJlX2NhbmRpZGF0ZXMgPSBbXQogICAgICAgIAogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIHN0YXR1cyA9IGFjY291bnQuZ2V0KCJzdGF0dXMiLCAiIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBDaOG7iSBjYXJlIHTDoGkga2hv4bqjbiBjw7MgdHLhuqFuZyB0aMOhaSBob+G6oXQgxJHhu5luZyBob+G6t2MgdOG6oW0gZOG7q25nCiAgICAgICAgICAgICAgICBpZiBzdGF0dXMgaW4gWyJhY3RpdmUiLCAiaW5hY3RpdmUiXToKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgam9iX2VuYWJsZSDEkeG7gyDEkeG6o20gYuG6o28gdMOgaSBraG/huqNuIMSRxrDhu6NjIHBow6lwIGhv4bqhdCDEkeG7mW5nCiAgICAgICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImpvYl9lbmFibGUiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGNhcmVfY2FuZGlkYXRlcy5hcHBlbmQoYWNjb3VudCkKICAgICAgICAKICAgICAgICByZXR1cm4gcmFuZG9tLmNob2ljZShjYXJlX2NhbmRpZGF0ZXMpIGlmIGNhcmVfY2FuZGlkYXRlcyBlbHNlIE5vbmUKICAgICAgICAKICAgICMgPT09PT09PT09PT09PT09PT09PT09PT09PSBFTkQgU01BUlQgQ0FSRSBTWVNURU0gPT09PT09PT09PT09PT09PT09PT09PT09PQogICAgICAgIAogICAgZGVmIHN0YXJ0KHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEto4bufaSDEkeG7mW5nIEpvYlNlcnZpY2UgdHJvbmcgdGhyZWFkIHJpw6puZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHRocmVhZGluZy5UaHJlYWQ6IFRocmVhZCDEkWFuZyBjaOG6oXkgSm9iU2VydmljZSBob+G6t2MgTm9uZSBu4bq/dSBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyDEkOG6t3QgdHLhuqFuZyB0aMOhaSBydW5uaW5nCiAgICAgICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2xlYXIgdHJhY2tpbmcgxJHhu4MgdmVyaWZ5IGzhuqFpIHThu6sgxJHhuqd1CiAgICAgICAgICAgIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHMuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmluaXRpYWxfYWNjb3VudF92ZXJpZmllZC5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IGPDoWMgY291bnRlcnMga2hpIGLhuq90IMSR4bqndSBwaGnDqm4gbeG7m2kKICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0cy5jbGVhcigpCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzLmNsZWFyKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCJDbGVhciBhY2NvdW50IHRyYWNraW5nIHbDoCByZXNldCBlcnJvciBjb3VudGVycyDEkeG7gyB2ZXJpZnkgbOG6oWkgdOG7qyDEkeG6p3Uga2hpIGto4bufaSDEkeG7mW5nIikKICAgICAgICAgICAgCgogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aHJlYWQKICAgICAgICAgICAgdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5ydW4pCiAgICAgICAgICAgIHRocmVhZC5kYWVtb24gPSBUcnVlCiAgICAgICAgICAgIHRocmVhZC5zdGFydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gdGhyZWFkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2jhu59pIMSR4buZbmcgSm9iU2VydmljZSIpCiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgZGVmIHJlc2V0X2xvZ291dF9hY2NvdW50cyhzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCByZXNldCBjw6FjIHTDoGkga2hv4bqjbiBsb2dvdXQgduG7gSBhY3RpdmUga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICBDaOG7iSBuw6puIGfhu41pIG1ldGhvZCBuw6B5IGtoaSBjw7MgecOqdSBj4bqndSDEkeG6t2MgYmnhu4d0IHThu6sgYWRtaW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB04bqldCBj4bqjIHTDoGkga2hv4bqjbiDhu58gdHLhuqFuZyB0aMOhaSBsb2dvdXQKICAgICAgICAgICAgZm9yIGFwcF9uYW1lIGluIHNlbGYuZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgbG9nb3V0X2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lLCBzdGF0dXM9ImxvZ291dCIpIG9yIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGxvZ291dF9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gduG7gSB0cuG6oW5nIHRow6FpIGFjdGl2ZSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB1bmZvbGxvdyBhdHRlbXB0cyBraGkgcmVzZXQgdMOgaSBraG/huqNuIGxvZ291dAogICAgICAgICAgICAgICAgICAgIGlmIGFjY291bnRbImlkIl0gaW4gc2VsZi51bmZvbGxvd19hdHRlbXB0czoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi51bmZvbGxvd19hdHRlbXB0c1thY2NvdW50WyJpZCJdXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGZldGNoIGpvYiBlcnJvciBjb3VudHMga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50WyJpZCJdIGluIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImFjdGl2ZSIsIAogICAgICAgICAgICAgICAgICAgICAgICAiaW5hY3RpdmVfcmVhc29uIjogIiIsCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHJlc2V0IHTDoGkga2hv4bqjbiBsb2dvdXQiKQogICAgCiAgICBkZWYgaXNfYWNjb3VudF9jYW5fcnVuX2pvYihzZWxmLCBhcHBfbmFtZTpzdHIgKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIEtp4buDbSB0cmEgeGVtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgY2jhuqF5IGpvYiBraMO0bmcKICAgICAgICAiIiIKICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgaWYoc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCkpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIHJ1bihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBDaOG6oXkgSm9iU2VydmljZSB0cm9uZyB2w7JuZyBs4bq3cCDEkcahbiBnaeG6o24gLSBs4bqleSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHRoZW8gdGjhu6kgdOG7sSDGsHUgdGnDqm4KICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5pc19pbml0aWFsaXplZDoKICAgICAgICAgICAgaWYgbm90IHNlbGYuaW5pdGlhbGl6ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKCJLaMO0bmcgdGjhu4Mga2jhu59pIHThuqFvIEpvYlNlcnZpY2UuIEtow7RuZyB0aOG7gyBjaOG6oXkuIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJC4bqvdCDEkeG6p3UgY2jhuqF5IEpvYlNlcnZpY2UgduG7m2kgbG9naWMgbMOgbSB2aeG7h2MgdOG7sSDEkeG7mW5nLi4uIikKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgZGV2aWNlX2lkCiAgICAgICAgZGV2aWNlX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgeMOhYyDEkeG7i25oIGRldmljZV9pZCBoaeG7h24gdOG6oWksIEpvYlNlcnZpY2Uga2jDtG5nIHRo4buDIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogCiAgICAgICAgd2hpbGUgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAjIFJlc2V0IGJp4bq/biBmb3JjZV9zdG9wIG7hur91IGPDswogICAgICAgICAgICB3aXRoIHNlbGYuX2xvY2s6CiAgICAgICAgICAgICAgICBzZWxmLmZvcmNlX3N0b3AgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyCiAgICAgICAgICAgIGlmIHNlbGYuZGIuZ2V0KCJwYXVzZV9qb2IiLCBGYWxzZSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ8OzIHnDqnUgY+G6p3UgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyLCB04bqhbSBk4burbmcgeOG7rSBsw70gam9iIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOaOG6oyBwcm94eSBuZ2F5IGtoaSBi4buLIHThuqFtIGThu6tuZyB04burIHNlcnZlcgogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgaWYgdXNlX3Byb3h5IGFuZCBzZWxmLnByb3h5X3NlcnZpY2UuaXNfcHJveHlfYWN0aXZlKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGRvIGLhu4sgdOG6oW0gZOG7q25nIHThu6sgc2VydmVyIikKICAgICAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB0cmFja2luZyB2YXJpYWJsZSBraGkgdW5yZWdpc3RlciBwcm94eQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9QQVVTRURfU0VSVkVSKQogICAgICAgICAgICAgICAgam9iX2NoZWNrX2ludGVydmFsID0gc2VsZi5kYi5nZXQoImpvYl9jaGVja19pbnRlcnZhbCIsIGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwpCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKGpvYl9jaGVja19pbnRlcnZhbCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCBi4buZIMSR4bq/bSBow6BuZyBuZ8OgeSBu4bq/dSBj4bqnbgogICAgICAgICAgICBzZWxmLl9yZXNldF9kYWlseV9jb3VudGVycygpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIGtow7RpIHBo4bulYyBjw6FjIHTDoGkga2hv4bqjbiBleHBpcmVkIMSRw6MgaOG6v3QgdGjhu51pIGdpYW4gY2jhu50KICAgICAgICAgICAgc2VsZi5yZXNldF9leHBpcmVkX2FjY291bnRzKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBj4bqnbiDEkcSDbmcga8O9IHByb3h5IGtow7RuZwogICAgICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEZldGNoIEdvTGlrZSBoZWFkZXJzIHRyxrDhu5tjIGtoaSBsw6BtIGLhuqV0IGvhu7Mgdmnhu4djIGfDrCBj4bqnbiBBUEkgKG7hur91IGPDsyBjb25maWcgY2hvIHBow6lwKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlzX2F1dG9fZ2V0X2hlYWRlciA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoImlzX2F1dG9fZ2V0X2dvbGlrZV9oZWFkZXIiLCBGYWxzZSkKICAgICAgICAgICAgICAgICAgICBpZiBpc19hdXRvX2dldF9oZWFkZXI6CiAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIGPhuqduIGzDoG0gbeG7m2kgR29MaWtlIGhlYWRlcnMga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIG5lZWRzX2hlYWRlcnNfcmVmcmVzaCA9IHNlbGYuZ29saWtlX3NlcnZpY2UubmVlZHNfaGVhZGVyc19yZWZyZXNoKCkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIGPDsyBwcm94eSBu4bq/dSBj4bqnbiBmZXRjaCBoZWFkZXJzIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5lZWRzX2hlYWRlcnNfcmVmcmVzaDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiRmV0Y2ggR29MaWtlIGhlYWRlcnMiKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgZmV0Y2ggR29MaWtlIGhlYWRlcnMsIG5naOG7iSAxMHMgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICBlbGlmIG5vdCBuZWVkc19oZWFkZXJzX3JlZnJlc2g6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIkdvTGlrZSBoZWFkZXJzIGPDsm4gaOG7o3AgbOG7hywga2jDtG5nIGPhuqduIMSRxINuZyBrw70gcHJveHkgxJHhu4MgZmV0Y2giKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGludGVybmV0IHNhdSBraGkgeOG7rSBsw70gcHJveHkgKHbDrCBwcm94eSBjw7MgdGjhu4Mg4bqjbmggaMaw4bufbmcgxJHhur9uIGvhur90IG7hu5FpKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXIuY2hlY2tfaW50ZXJuZXQoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIGvhur90IG7hu5FpIGludGVybmV0LCBuZ2jhu4kgMjBzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDIwKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGdvbGlrZV9oZWFkZXJzID0gc2VsZi5nb2xpa2Vfc2VydmljZS5mZXRjaF9nb2xpa2VfaGVhZGVyc193aXRoX3JldHJ5KCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGdvbGlrZV9oZWFkZXJzOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkdvTGlrZSBoZWFkZXJzIGtow7RuZyBo4bujcCBs4buHLCBuZ2jhu4kgNXMgdsOgIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoNSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKCJDb25maWcgaXNfYXV0b19nZXRfZ29saWtlX2hlYWRlciA9IGZhbHNlLCBi4buPIHF1YSB2aeG7h2MgdOG7sSDEkeG7mW5nIGzhuqV5IGhlYWRlcnMiKQogICAgICAgICAgICAgICAgICAgICAgICAjIENo4buJIGtp4buDbSB0cmEgY8OzIGhlYWRlcnMgdOG7qyBzZXJ2ZXIga2jDtG5nLCBuaMawbmcga2jDtG5nIGLhuq90IGJ14buZYyDEkeG7gyBqb2IgdGnhur9wIHThu6VjCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmdvbGlrZV9zZXJ2aWNlLmlzX2dvbGlrZV9hdXRoZW50aWNhdGVkKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiQ2jGsGEgY8OzIEdvTGlrZSBoZWFkZXJzIHThu6sgc2VydmVyLCB24bqrbiB0aeG6v3AgdOG7pWMgam9iIHbhu5tpIGhlYWRlcnMgcuG7l25nIikKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiQ8OzIEdvTGlrZSBoZWFkZXJzIHThu6sgc2VydmVyLCB0aeG6v3AgdOG7pWMgam9iIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZmV0Y2ggR29MaWtlIGhlYWRlcnM6IHtlfSwgbmdo4buJIDVzIHbDoCB0aOG7rSBs4bqhaSIpCiAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcCg1KToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIELGsOG7m2MgMTogS2nhu4NtIHRyYSB2w6AgxJHhu5NuZyBi4buZIHTDoGkga2hv4bqjbiBu4bq/dSBjw7MgecOqdSBj4bqndQogICAgICAgICAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIGluIHNlbGYuam9iX2hhbmRsZXJzIGFuZCBzZWxmLl9jaGVja19hY2NvdW50X3N5bmNfc3RhdHVzKGFwcF9uYW1lKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIGNobyB7YXBwX25hbWV9Li4uIikKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUHJveHkgdsOgIEdvTGlrZSBoZWFkZXJzIMSRw6MgxJHGsOG7o2MgxJHhuqNtIGLhuqNvIOG7nyB0csOqbgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRzX2Zvcl9hcHAoYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICMgU2F1IGtoaSDEkeG7k25nIGLhu5ksIGNsZWFyIGN1cnJlbnQgd29ya2luZyBhY2NvdW50IMSR4buDIHF1w6l0IGzhuqFpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgYW5kIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQuZ2V0KCJhcHAiKSA9PSBhcHBfbmFtZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ2xlYXIgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSBzYXUga2hpIMSR4buTbmcgYuG7mSB7YXBwX25hbWV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAyOiBUw6xtIHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIGFjY291bnRfdG9fd29yayA9IHNlbGYuX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoKQogICAgICAgICAgICAgICAgaWYgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBhY2NvdW50X3RvX3dvcmsKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiDEkcaw4bujYyBjaOG7jW4gxJHhu4MgbMOgbSB2aeG7h2M6IHthY2NvdW50X3RvX3dvcmsuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIGpvYgogICAgICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gc+G6tW4gc8OgbmcgbMOgbSB2aeG7h2MgKGzhuqduIHtzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudH0pIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFVucmVnaXN0ZXIgcHJveHkgbmdheSBraGkga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MgxJHhu4MgdGnhur90IGtp4buHbQogICAgICAgICAgICAgICAgICAgIGlmIHVzZV9wcm94eSBhbmQgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiVW5yZWdpc3RlciBwcm94eSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS51bnJlZ2lzdGVyX3Byb3h5KCkKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCB0cmFja2luZyB2YXJpYWJsZSBraGkgdW5yZWdpc3RlciBwcm94eQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcCBzYXUgMyBs4bqnbiBsacOqbiB0aeG6v3Aga2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLm5vX2pvYl9jb25zZWN1dGl2ZV9jb3VudCA+PSAzOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDs25nIHThuqV0IGPhuqMgYXBwIGRvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIGzDoG0gdmnhu4djIHRyb25nIHRo4budaSBnaWFuIGTDoGkiKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgYXBwX25hbWUsIGhhbmRsZXIgaW4gc2VsZi5qb2JfaGFuZGxlcnMuaXRlbXMoKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw7NuZyBhcHAge2FwcF9uYW1lfSBkbyBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBsw6BtIHZp4buHYyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSDEkcOzbmcgYXBwOiB7ZX0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfaXNfd29ya2luZyIsIEZhbHNlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIEpvYlNlcnZpY2VDb25zdGFudHMuTVNHX0RFVklDRV9OT19BQ0NPVU5UUykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFRo4butIHNtYXJ0IGNhcmUgY2hvIHTDoGkga2hv4bqjbiBpZGxlIHRyxrDhu5tjIGtoaSBuZ2jhu4kKICAgICAgICAgICAgICAgICAgICBjYXJlX2FjY291bnQgPSBzZWxmLl9nZXRfcmFuZG9tX2FjY291bnRfZm9yX2NhcmUoKQogICAgICAgICAgICAgICAgICAgIGlmIGNhcmVfYWNjb3VudCBhbmQgc2VsZi5fc2hvdWxkX3BlcmZvcm1fY2FyZV9zbWFydChjYXJlX2FjY291bnQsICJpZGxlIik6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU21hcnQgY2FyZSBjaG8gdMOgaSBraG/huqNuIGlkbGU6IHtjYXJlX2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmVuc3VyZV9wcm94eV9pZl9uZWVkZWQoIlNtYXJ0IGNhcmUgaWRsZSIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9pc193b3JraW5nIiwgVHJ1ZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuc2V0KCJkZXZpY2VfbWVzc2FnZSIsIGYiQ2FyZToge2NhcmVfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhcmVfc3VjY2VzcyA9IHNlbGYuX3BlcmZvcm1fc21hcnRfY2FyZShjYXJlX2FjY291bnQsICJpZGxlIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNhcmVfc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNtYXJ0IGNhcmUgaWRsZSB0aMOgbmggY8O0bmcgY2hvIHtjYXJlX2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0iKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSBzYXUgY2FyZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChyYW5kb20ucmFuZGludCgzMCwgNjApKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBraG/huqNuZyBuZ+G6r24gdHLGsOG7m2Mga2hpIGtp4buDbSB0cmEgbOG6oWkKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDMwKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJlc2V0IGNvdW50ZXIga2hpIGPDsyB0w6BpIGtob+G6o24gxJHhu4MgbMOgbSB2aeG7h2MKICAgICAgICAgICAgICAgIHNlbGYubm9fam9iX2NvbnNlY3V0aXZlX2NvdW50ID0gMAogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEZvcmNlIHZlcmlmeSBhY2NvdW50IG7hur91IGNoxrBhIMSRxrDhu6NjIHZlcmlmeSB2w6AgY8OzIHByb3h5IG7hur91IGPhuqduCiAgICAgICAgICAgICAgICBzZWxmLl9mb3JjZV92ZXJpZnlfYWNjb3VudHNfd2l0aF9wcm94eSgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQsaw4bubYyAzOiBYw6FjIG5o4bqtbiBs4bqhaSB0cuG6oW5nIHRow6FpIGxvZ2luIMSR4buDIHRyw6FuaCBsw6BtIHNhaSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBs4bqhaSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIGtow7RuZyBzYXUga2hpIHZlcmlmeQogICAgICAgICAgICAgICAgYWNjb3VudF90b193b3JrID0gc2VsZi5kYi5nZXRfYWNjb3VudChhY2NvdW50X3RvX3dvcmtbImlkIl0pCiAgICAgICAgICAgICAgICBpZiBub3QgYWNjb3VudF90b193b3JrIG9yIG5vdCBzZWxmLl9jYW5fcnVuX2pvYihhY2NvdW50X3RvX3dvcmspOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIGtow7RuZyB0aOG7gyBsw6BtIHZp4buHYyBu4buvYSBzYXUga2hpIHZlcmlmeSwgYuG7jyBxdWEiKQogICAgICAgICAgICAgICAgICAgICMgQ2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgdsOsIGtow7RuZyB0aOG7gyBsw6BtIHZp4buHYyBu4buvYQogICAgICAgICAgICAgICAgICAgIHNlbGYuY3VycmVudF93b3JraW5nX2FjY291bnQgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgbsOqbiDEkcOzbmcgYXBwIGtow7RuZwogICAgICAgICAgICAgICAgICAgIHNlbGYuX2NoZWNrX2FuZF9jbG9zZV9hcHBfaWZfbmVlZGVkKGFjY291bnRfdG9fd29yay5nZXQoImFwcCIpIGlmIGFjY291bnRfdG9fd29yayBlbHNlIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgxJFhbmcgbMOgbSB2aeG7h2Mgc2F1IGtoaSDEkcOjIHjDoWMgbmjhuq1uIHTDoGkga2hv4bqjbiBo4bujcCBs4buHCiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX2lzX3dvcmtpbmciLCBUcnVlKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBjdXJyZW50IHdvcmtpbmcgYWNjb3VudCB24bubaSB0aMO0bmcgdGluIG3hu5tpIG5o4bqldAogICAgICAgICAgICAgICAgc2VsZi5jdXJyZW50X3dvcmtpbmdfYWNjb3VudCA9IGFjY291bnRfdG9fd29yawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyBjw7MgcHJveHkgdHLGsOG7m2Mga2hpIGzDoG0gam9iIChu4bq/dSBj4bqnbikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnByb3h5X3NlcnZpY2UuZW5zdXJlX3Byb3h5X2lmX25lZWRlZCgiTMOgbSBqb2IiKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyDEkeG6o20gYuG6o28gcHJveHkgxJHhu4MgbMOgbSBqb2IsIG5naOG7iSAxMHMgdHLGsOG7m2Mga2hpIHRo4butIGzhuqFpIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDEwKToKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5CiAgICAgICAgICAgICAgICBqb2JfcmVzdWx0ID0gc2VsZi5fd29ya193aXRoX3NpbmdsZV9hY2NvdW50KGFjY291bnRfdG9fd29yaykKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgbsOqbiDEkcOzbmcgYXBwIHNhdSBraGkgbMOgbSB2aeG7h2Mga2jDtG5nCiAgICAgICAgICAgICAgICBpZiBub3Qgam9iX3Jlc3VsdDoKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGPDsyBs4buXaSwgY2xlYXIgY3VycmVudCB3b3JraW5nIGFjY291bnQgxJHhu4MgcXXDqXQgbOG6oWkKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfd29ya2luZ19hY2NvdW50ID0gTm9uZQogICAgICAgICAgICAgICAgICAgICMgQ8OzIHRo4buDIGPhuqduIMSRw7NuZyBhcHAKICAgICAgICAgICAgICAgICAgICBzZWxmLl9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChhY2NvdW50X3RvX3dvcmsuZ2V0KCJhcHAiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBOZ2jhu4kgbmfhuq9uIGdp4buvYSBjw6FjIGzhuqduIGzDoG0gdmnhu4djCiAgICAgICAgICAgICAgICBqb2JfY2hlY2tfaW50ZXJ2YWwgPSBzZWxmLmRiLmdldCgiam9iX2NoZWNrX2ludGVydmFsIiwgY29uZmlnLkpPQl9DSEVDS19JTlRFUlZBTCkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoam9iX2NoZWNrX2ludGVydmFsKToKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIHRyb25nIHbDsm5nIGzhurdwIGNow61uaCIpCiAgICAgICAgICAgICAgICAjIE5naOG7iSBt4buZdCBjaMO6dCB0csaw4bubYyBraGkgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoMzApOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICMgTmjhuqMgcHJveHkga2hpIHRob8OhdAogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgc2VsZi5wcm94eV9zZXJ2aWNlLmlzX3Byb3h5X2FjdGl2ZSgpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIk5o4bqjIHByb3h5IGtoaSBKb2JTZXJ2aWNlIGThu6tuZyIpCiAgICAgICAgICAgICAgICBzZWxmLnByb3h5X3NlcnZpY2UudW5yZWdpc3Rlcl9wcm94eSgpCiAgICAgICAgICAgICAgICAjIFJlc2V0IHRyYWNraW5nIHZhcmlhYmxlIGtoaSB1bnJlZ2lzdGVyIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IE5vbmUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIG5o4bqjIHByb3h5OiB7ZX0iKQogICAgICAgICAgICAKICAgICAgICAjIMSQw7NuZyB04bqldCBj4bqjIGFwcCBraGkgdGhvw6F0IEpvYlNlcnZpY2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBhcHBfbmFtZSwgaGFuZGxlciBpbiBzZWxmLmpvYl9oYW5kbGVycy5pdGVtcygpOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOzbmcgYXBwIHthcHBfbmFtZX0ga2hpIEpvYlNlcnZpY2UgZOG7q25nIikKICAgICAgICAgICAgICAgIHNlbGYuX2Nsb3NlX2FwcF9hbmRfdXBkYXRlX3N0YXR1cyhoYW5kbGVyLCBhcHBfbmFtZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIMSRw7NuZyBhcHA6IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgIGxvZ2dlci5pbmZvKCJKb2JTZXJ2aWNlIMSRw6MgZOG7q25nIikKICAgICAgICAgICAgCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICAiIiJE4burbmcgSm9iU2VydmljZSIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICBsb2dnZXIuaW5mbygixJBhbmcgZOG7q25nIEpvYlNlcnZpY2UuLi4iKQogICAgICAgIAogICAgZGVmIGZvcmNlX3N0b3BfYWxsKHNlbGYpOgogICAgICAgICIiIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZyIiIgogICAgICAgIHdpdGggc2VsZi5fbG9jazoKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIGxvZ2dlci5pbmZvKCJE4burbmcgbmdheSBs4bqtcCB04bupYyB04bqldCBj4bqjIGPDoWMgaG/huqF0IMSR4buZbmcuLi4iKQoKICAgIGRlZiBoYW5kbGVfbXF0dF9hY2NvdW50X3VwZGF0ZShzZWxmKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSBj4bqtcCBuaOG6rXQgYWNjb3VudCB04burIE1RVFQgc2VydmVyCiAgICAgICAgQWNjb3VudCBz4bq9IMSRxrDhu6NjIHJlbG9hZCBzYXUgbeG7l2kgam9iIHRyb25nIGNvbnRpbnVvdXMgcHJvY2Vzc2luZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgdGjDtG5nIGLDoW8gY+G6rXAgbmjhuq10IGFjY291bnQgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgCiAgICBkZWYgaGFuZGxlX21xdHRfZm9yY2Vfc3RhcnRfc2Vzc2lvbihzZWxmKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB5w6p1IGPhuqd1IGLhuq90IMSR4bqndSBsw6BtIHZp4buHYyBuZ2F5IGzhuq1wIHThu6ljIHThu6sgTVFUVCBzZXJ2ZXIKICAgICAgICBMb2dpYyBt4bubaSBraMO0bmcgY8OzIHNlc3Npb24gY29vbGRvd24gbsOqbiBraMO0bmcgY+G6p24geOG7rSBsw70gZ8OsIMSR4bq3YyBiaeG7h3QKICAgICAgICAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiTmjhuq1uIMSRxrDhu6NjIHnDqnUgY+G6p3UgYuG6r3QgxJHhuqd1IGzDoG0gdmnhu4djIG5nYXkgbOG6rXAgdOG7qWMgdOG7qyBzZXJ2ZXIgcXVhIE1RVFQiKQogICAgICAgICMgVHJvbmcgbG9naWMgbeG7m2ksIEpvYlNlcnZpY2Ugc+G6vSB04buxIMSR4buZbmcgbOG6pXkgam9iIGxpw6puIHThu6VjIG7Dqm4ga2jDtG5nIGPhuqduIHjhu60gbMO9IGfDrCB0aMOqbQogICAgICAgICAgICAKICAgIGRlZiBoYW5kbGVfbXF0dF9jb25maWdfdXBkYXRlKHNlbGYsIGNvbmZpZ19jaGFuZ2VzOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGPhuq1wIG5o4bqtdCBjb25maWcgdOG7qyBNUVRUIHNlcnZlcgogICAgICAgIExvZ2ljIG3hu5tpIGtow7RuZyBj4bqnbiByZXN0YXJ0IHNlc3Npb24sIGNvbmZpZyBz4bq9IMSRxrDhu6NjIMOhcCBk4bulbmcgbmdheSBs4bqtcCB04bupYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGNvbmZpZ19jaGFuZ2VzOiBEaWN0aW9uYXJ5IGNo4bupYSBjw6FjIHRoYXkgxJHhu5VpIGNvbmZpZwogICAgICAgICIiIgogICAgICAgIGxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgdGjDtG5nIGLDoW8gY+G6rXAgbmjhuq10IGNvbmZpZyB04burIHNlcnZlciBxdWEgTVFUVCIpCiAgICAgICAgIyBMb2dpYyBt4bubaSBraMO0bmcgY+G6p24geOG7rSBsw70gxJHhurdjIGJp4buHdCwgY29uZmlnIHPhur0gxJHGsOG7o2MgxJHhu41jIGzhuqFpIHThu6sgREIgbeG7l2kgbOG6p24gbOG6t3AKCiAgICBkZWYgc2h1dGRvd24oc2VsZik6CiAgICAgICAgIiIixJDDs25nIGThu4tjaCB24bulLCBk4burbmcgdOG6pXQgY+G6oyB3b3JrZXIgdGhyZWFkcyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkThu6tuZyBuZ2F5IGzhuq1wIHThu6ljIHThuqV0IGPhuqMgY8OhYyBob+G6oXQgxJHhu5luZy4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw6FuaCBk4bqldSBk4burbmcKICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5mb3JjZV9zdG9wID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTaHV0ZG93biBQcm94eVNlcnZpY2UgKHPhur0gdOG7sSDEkeG7mW5nIHVucmVnaXN0ZXIgcHJveHkgdsOgIGThu6tuZyB1cGRhdGUgdGhyZWFkKQogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdwcm94eV9zZXJ2aWNlJykgYW5kIHNlbGYucHJveHlfc2VydmljZToKICAgICAgICAgICAgICAgIHNlbGYucHJveHlfc2VydmljZS5zaHV0ZG93bigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIMSQw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZSDEkeG7gyB0csOhbmggbOG7l2kgdGhyZWFkCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2RiJykgYW5kIHNlbGYuZGI6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5jbG9zZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge3N0cihlKX0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBzaHV0ZG93biBKb2JTZXJ2aWNlIikKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PSBQUk9YWSBDT05WRU5JRU5DRSBNRVRIT0RTID09PT09PT09PT09PT09PT09PT09CiAgICBkZWYgcmVzZXRfY3VycmVudF9wcm94eV9pcChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFJlc2V0IElQIGNobyBwcm94eSBoaeG7h24gdOG6oWkgKGPDsyB0aOG7gyBn4buNaSB0cm9uZyBxdcOhIHRyw6xuaCBsw6BtIHZp4buHYykKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHJlc2V0IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5mb3JjZV9yZXNldF9jdXJyZW50X2lwKCkKICAgIAogICAgZGVmIGdldF9wcm94eV9zdGF0dXMoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRy4bqhbmcgdGjDoWkgcHJveHkgaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgc3RyOiBUcuG6oW5nIHRow6FpIHByb3h5CiAgICAgICAgIiIiCiAgICAgICAgcmV0dXJuIHNlbGYucHJveHlfc2VydmljZS5nZXRfcHJveHlfc3RhdHVzKCkKICAgIAogICAgZGVmIGdldF9wcm94eV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHRow7RuZyB0aW4gcHJveHkgaGnhu4duIHThuqFpCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRow7RuZyB0aW4gcHJveHkKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5wcm94eV9zZXJ2aWNlLmdldF9wcm94eV9pbmZvKCkKICAgIAogICAgIyA9PT09PT09PT09PT09PT09PT09PSBFTkQgUFJPWFkgQ09OVkVOSUVOQ0UgTUVUSE9EUyA9PT09PT09PT09PT09PT09PT09PQogICAgICAgICAgICAKICAgICMgREVQUkVDQVRFRDogS2jDtG5nIGTDuW5nIG7hu69hLCB0aGF5IGLhurFuZyBfZ2V0X2FsbF93b3JrYWJsZV9hY2NvdW50cygpCiAgICAjIGRlZiBfaGFzX2FjY291bnRzX3JlYWR5X2Zvcl93b3JrKHNlbGYpIC0+IGJvb2w6CiAgICAjICAgICAiIiIKICAgICMgICAgIEtp4buDbSB0cmEgeGVtIGPDsyB0w6BpIGtob+G6o24gbsOgbyBz4bq1biBzw6BuZyBsw6BtIHZp4buHYyBraMO0bmcKICAgICMgICAgIAogICAgIyAgICAgUmV0dXJuczoKICAgICMgICAgICAgICBib29sOiBUcnVlIG7hur91IGPDsyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAjICAgICAiIiIKICAgICMgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgIyAgICAgCiAgICAjICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgIyAgICAgICAgIGlmIHNlbGYuaXNfYWNjb3VudF9jYW5fcnVuX2pvYihhcHBfbmFtZSk6CiAgICAjICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAjICAgICAgICAgICAgIAogICAgIyAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICBkZWYgX2dldF9hbGxfd29ya2FibGVfYWNjb3VudHMoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djIHThu6sgdOG6pXQgY+G6oyBhcHAgdsOgIHPhuq9wIHjhur9wIHRoZW8gYXBwLCBuZ8OgeSB04bqhbwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIHTDoGkga2hv4bqjbiDEkcOjIMSRxrDhu6NjIHPhuq9wIHjhur9wCiAgICAgICAgIiIiCiAgICAgICAgZW5hYmxlZF9hcHBzID0gc2VsZi5kYi5nZXQoImVuYWJsZWRfYXBwcyIsIGNvbmZpZy5FTkFCTEVEX0FQUFMpCiAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzID0gW10KICAgICAgICAKICAgICAgICBmb3IgYXBwX25hbWUgaW4gZW5hYmxlZF9hcHBzOgogICAgICAgICAgICBhY2NvdW50cyA9IHNlbGYuZGIuZ2V0X2FjY291bnRzKGFwcD1hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhur9tIHPhu5EgbMaw4bujbmcgdMOgaSBraG/huqNuIHRoZW8gdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzdGF0dXNfY291bnRzID0ge30KICAgICAgICAgICAgZm9yIGFjYyBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIHN0YXR1cyA9IGFjYy5nZXQoJ3N0YXR1cycsICdhY3RpdmUnKQogICAgICAgICAgICAgICAgc3RhdHVzX2NvdW50c1tzdGF0dXNdID0gc3RhdHVzX2NvdW50cy5nZXQoc3RhdHVzLCAwKSArIDEKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTG9nIHRo4buRbmcga8OqIHRy4bqhbmcgdGjDoWkKICAgICAgICAgICAgc3RhdHVzX2luZm8gPSAiLCAiLmpvaW4oW2Yie3N0YXR1c306IHtjb3VudH0iIGZvciBzdGF0dXMsIGNvdW50IGluIHN0YXR1c19jb3VudHMuaXRlbXMoKV0pCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOgaSBraG/huqNuIHthcHBfbmFtZX0gLSB7c3RhdHVzX2luZm99IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG7jWMgY8OhYyB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiB3b3JrYWJsZV9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVMOsbSB0aOG6pXkge2xlbih3b3JrYWJsZV9hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgICAgICAgICAgYWxsX3dvcmthYmxlX2FjY291bnRzLmV4dGVuZCh3b3JrYWJsZV9hY2NvdW50cykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyB0w6BpIGtob+G6o24gbsOgbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgY2hvIHthcHBfbmFtZX0iKQogICAgICAgIAogICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbzoKICAgICAgICAjIDEuIEFwcCBuYW1lICjEkeG7gyBuaMOzbSBjw7luZyBhcHAgbOG6oWkgduG7m2kgbmhhdSkKICAgICAgICAjIDIuIE5nw6B5IHThuqFvIHTDoGkga2hv4bqjbiAoY3JlYXRlZF9hdCkgLSBjxakgbmjhuqV0IHRyxrDhu5tjCiAgICAgICAgIyAzLiBT4buRIGpvYiDEkcOjIGzDoG0gaMO0bSBuYXkgKMOtdCBuaOG6pXQgdHLGsOG7m2MpIC0gdGhheSBjaG8gam9ic19kb25lX2luX3Nlc3Npb24KICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgeC5nZXQoImNyZWF0ZWRfYXQiLCAwKSwKICAgICAgICAgICAgeC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgKSkKICAgICAgICAKICAgICAgICByZXR1cm4gYWxsX3dvcmthYmxlX2FjY291bnRzCiAgICAgICAgCiAgICBkZWYgX2dldF9uZXh0X3dvcmthYmxlX2FjY291bnQoc2VsZikgLT4gT3B0aW9uYWxbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IHTDoGkga2hv4bqjbiB0aeG6v3AgdGhlbyBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjoKICAgICAgICAxLiBUw6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCAoaXNfbG9naW4gPSBUcnVlKQogICAgICAgIDIuIFTDoGkga2hv4bqjbiBjw7MgdGjhu4MgbMOgbSB2aeG7h2MgdGhlbyB0aOG7qSB04buxIGFwcCwgbmfDoHkgdOG6oW8KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0IGhv4bq3YyBOb25lOiBBY2NvdW50IGRhdGEgbuG6v3UgdMOsbSB0aOG6pXksIE5vbmUgbuG6v3Uga2jDtG5nIGPDswogICAgICAgICIiIgogICAgICAgIGVuYWJsZWRfYXBwcyA9IHNlbGYuZGIuZ2V0KCJlbmFibGVkX2FwcHMiLCBjb25maWcuRU5BQkxFRF9BUFBTKQogICAgICAgIAogICAgICAgICMgQsaw4bubYyAxOiBUw6xtIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIHRyxrDhu5tjIChkw7luZyB0cmFja2luZyBoaeG7h24gdOG6oWkpCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgIyBWZXJpZnkgdMOgaSBraG/huqNuIHRo4buxYyB04bq/IGtoaSBs4bqnbiDEkeG6p3UgbMOgbSB2aeG7h2MgduG7m2kgYXBwIG7DoHkgKGNo4buJIGtoaSBj4bqnbikKICAgICAgICAgICAgaWYgYXBwX25hbWUgbm90IGluIHNlbGYuaW5pdGlhbF9hY2NvdW50X3ZlcmlmaWVkIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICMgQ2jhu4kgdmVyaWZ5IGtoaSBraMO0bmcgY8OzIHTDoGkga2hv4bqjbiBuw6BvIHRyb25nIHRyYWNraW5nIGhv4bq3YyBraGkgdHJhY2tpbmcga2jDtG5nIGjhu6NwIGzhu4cKICAgICAgICAgICAgICAgIGlmIGFwcF9uYW1lIG5vdCBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVmVyaWZ5IHTDoGkga2hv4bqjbiB0aOG7sWMgdOG6vyDEkWFuZyBsb2dpbiB0csOqbiB7YXBwX25hbWV9IGzhuqduIMSR4bqndS4uLiIpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zeW5jX2FjY291bnRfbG9naW5fc3RhdHVzX3dpdGhfcmVhbGl0eShhcHBfbmFtZSwgc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZlcmlmeSB0w6BpIGtob+G6o24gdHLDqm4ge2FwcF9uYW1lfToge2V9IikKICAgICAgICAgICAgICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAgICAgICAgICAgICAjIMSQw6FuaCBk4bqldSDEkcOjIHRo4butIHZlcmlmeSDEkeG7gyBraMO0bmcgdGjhu60gbOG6oWkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEPDsyB0cmFja2luZyBy4buTaSwga2jDtG5nIGPhuqduIHZlcmlmeSBuZ2F5CiAgICAgICAgICAgICAgICAgICAgc2VsZi5pbml0aWFsX2FjY291bnRfdmVyaWZpZWRbYXBwX25hbWVdID0gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIHThu6sgdHJhY2tpbmcKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGxvZ2dlZF9pbl9hY2NvdW50X2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50KGxvZ2dlZF9pbl9hY2NvdW50X2lkKQogICAgICAgICAgICAgICAgaWYgYWNjb3VudCBhbmQgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB0w6BpIGtob+G6o24gxJFhbmcgxJHEg25nIG5o4bqtcCBjw7MgdGjhu4MgbMOgbSB2aeG7h2M6IHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9ICh7YXBwX25hbWV9KSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFjY291bnQKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24ga2jDtG5nIGPDsm4gaOG7o3AgbOG7hywgeMOzYSBraOG7j2kgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGxvZ2dlZF9pbl9hY2NvdW50X2lkLCB7ImlzX2xvZ2luIjogRmFsc2UsICJpc19zeW5jIjogRmFsc2V9KQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIljDs2EgdMOgaSBraG/huqNuIHtsb2dnZWRfaW5fYWNjb3VudF9pZH0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDI6IFTDrG0gdMOgaSBraG/huqNuIMSRxINuZyBuaOG6rXAgdOG7qyBkYXRhYmFzZSAoZmFsbGJhY2spCiAgICAgICAgZm9yIGFwcF9uYW1lIGluIGVuYWJsZWRfYXBwczoKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgIyDGr3UgdGnDqm4gdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAgdOG7qyBEQgogICAgICAgICAgICAgICAgaWYgYWNjb3VudC5nZXQoImxvZ2dlZF9pbiIsIEZhbHNlKSBhbmQgc2VsZi5fY2FuX3J1bl9qb2IoYWNjb3VudCk6CiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHJhY2tpbmcKICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9IGFjY291bnRbImlkIl0KICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiDEkcSDbmcgbmjhuq1wIHRyb25nIERCOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FwcF9uYW1lfSkiKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBhY2NvdW50CiAgICAgICAgCiAgICAgICAgIyBCxrDhu5tjIDM6IE7hur91IGtow7RuZyBjw7MgdMOgaSBraG/huqNuIMSRYW5nIMSRxINuZyBuaOG6rXAsIGzhuqV5IHTDoGkga2hv4bqjbiB0aGVvIHRo4bupIHThu7EKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMgPSBbXQogICAgICAgIGZvciBhcHBfbmFtZSBpbiBlbmFibGVkX2FwcHM6CiAgICAgICAgICAgIGFjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPWFwcF9uYW1lKQogICAgICAgICAgICB3b3JrYWJsZV9hY2NvdW50cyA9IFthY2MgZm9yIGFjYyBpbiBhY2NvdW50cyBpZiBzZWxmLl9jYW5fcnVuX2pvYihhY2MpXQogICAgICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuZXh0ZW5kKHdvcmthYmxlX2FjY291bnRzKQogICAgICAgIAogICAgICAgIGlmIG5vdCBhbGxfd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgU+G6r3AgeOG6v3AgdGhlbyB0aOG7qSB04buxIMawdSB0acOqbjogYXBwLCBuZ8OgeSB04bqhbywgc+G7kSBqb2IgaMO0bSBuYXkKICAgICAgICBhbGxfd29ya2FibGVfYWNjb3VudHMuc29ydChrZXk9bGFtYmRhIHg6ICgKICAgICAgICAgICAgeC5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgeC5nZXQoImNyZWF0ZWRfYXQiLCAwKSwKICAgICAgICAgICAgeC5nZXQoImpvYl90b2RheSIsIDApCiAgICAgICAgKSkKICAgICAgICAKICAgICAgICBhY2NvdW50ID0gYWxsX3dvcmthYmxlX2FjY291bnRzWzBdCiAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIHRo4buDIGzDoG0gdmnhu4djOiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSAoe2FjY291bnQuZ2V0KCdhcHAnKX0pIikKICAgICAgICByZXR1cm4gYWNjb3VudAogICAgICAgIAogICAgZGVmIF93b3JrX3dpdGhfc2luZ2xlX2FjY291bnQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMOgbSB2aeG7h2MgduG7m2kgbeG7mXQgdMOgaSBraG/huqNuIC0gdGjhu7FjIGhp4buHbiBt4buZdCBqb2IgZHV5IG5o4bqldAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnLCAnVW5rbm93bicpCiAgICAgICAgYXBwX25hbWUgPSBhY2NvdW50LmdldCgiYXBwIikKICAgICAgICAKICAgICAgICBpZiBhcHBfbmFtZSBub3QgaW4gc2VsZi5qb2JfaGFuZGxlcnM6CiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGpvYiBoYW5kbGVyIGNobyB7YXBwX25hbWV9LCBi4buPIHF1YSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgIGhhbmRsZXIgPSBzZWxmLmpvYl9oYW5kbGVyc1thcHBfbmFtZV0KICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUHJveHkgxJHDoyDEkcaw4bujYyB44butIGzDvSDhu58gbmdvw6BpLCBraMO0bmcgY+G6p24ga2nhu4NtIHRyYSBs4bqhaSDhu58gxJHDonkKICAgICAgICAgICAgdXNlX3Byb3h5ID0gc2VsZi5kYi5nZXQoInVzZV9wcm94eSIsIEZhbHNlKQogICAgICAgICAgICBjdXJyZW50X2FjY291bnRfaWQgPSBhY2NvdW50LmdldCgiaWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgY+G6p24gY2h1eeG7g24gdMOgaSBraG/huqNuIGtow7RuZwogICAgICAgICAgICAjIFPhu60gZOG7pW5nIHRyYWNraW5nIGluLW1lbW9yeSB0aGF5IHbDrCBmaWVsZCBpc19sb2dpbiDEkeG7gyBjaMOtbmggeMOhYyBoxqFuCiAgICAgICAgICAgIGN1cnJlbnRfbG9nZ2VkX2luX2lkID0gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50cy5nZXQoYXBwX25hbWUpCiAgICAgICAgICAgIG5lZWRzX2FjY291bnRfc3dpdGNoID0gY3VycmVudF9sb2dnZWRfaW5faWQgIT0gY3VycmVudF9hY2NvdW50X2lkCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBuZWVkc19hY2NvdW50X3N3aXRjaDoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiQ+G6p24gY2h1eeG7g24gdMOgaSBraG/huqNuOiBoaeG7h24gdOG6oWkgSUQ9e2N1cnJlbnRfbG9nZ2VkX2luX2lkfSwgY+G6p24gY2h1eeG7g24gc2FuZyBJRD17Y3VycmVudF9hY2NvdW50X2lkfSIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSAoSUQ6IHtjdXJyZW50X2FjY291bnRfaWR9KSDEkcOjIMSRxINuZyBuaOG6rXAsIGtow7RuZyBj4bqnbiBjaHV54buDbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IElQIHByb3h5IGNo4buJIGtoaSBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICAgICBpZiB1c2VfcHJveHkgYW5kIHNlbGYucHJveHlfc2VydmljZS5pc19wcm94eV9hY3RpdmUoKToKICAgICAgICAgICAgICAgICMgQ2jhu4kgcmVzZXQgSVAga2hpIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIGtow6FjIGhv4bq3YyBs4bqnbiDEkeG6p3UgdGnDqm4KICAgICAgICAgICAgICAgIGlmIHNlbGYuY3VycmVudF9wcm94eV9hY2NvdW50X2lkICE9IGN1cnJlbnRfYWNjb3VudF9pZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlJlc2V0IElQIHByb3h5IGNobyB0w6BpIGtob+G6o24gbeG7m2k6IHt1c2VybmFtZX0gKElEOiB7Y3VycmVudF9hY2NvdW50X2lkfSkiKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgSVAgxJHhu4MgY8OzIElQIG3hu5tpIGNobyB0w6BpIGtob+G6o24gbeG7m2kgIAogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYucHJveHlfc2VydmljZS5mb3JjZV9yZXNldF9jdXJyZW50X2lwKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiUmVzZXQgSVAgdGjDoG5oIGPDtG5nIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgzKQogICAgICAgICAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgYWNjb3VudF9pZCDEkcOjIHJlc2V0IMSR4buDIHRyw6FuaCByZXNldCBs4bq3cCBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmN1cnJlbnRfcHJveHlfYWNjb3VudF9pZCA9IGN1cnJlbnRfYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVzZXQgSVAgdGjhuqV0IGLhuqFpIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSwgdGnhur9wIHThu6VjIHbhu5tpIElQIGhp4buHbiB04bqhaSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHGsOG7o2MgcmVzZXQgSVAgdHLGsOG7m2MgxJHDsywgYuG7jyBxdWEgcmVzZXQiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7iSBjaHV54buDbiB0w6BpIGtob+G6o24ga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgaWYgbmVlZHNfYWNjb3VudF9zd2l0Y2g6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgc3dpdGNoX3Jlc3VsdCA9IGhhbmRsZXIuc3dpdGNoX3RvX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGvhur90IHF14bqjIGNodXnhu4NuIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzd2l0Y2hfcmVzdWx0LCBkaWN0KToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc3dpdGNoX3Jlc3VsdC5nZXQoJ3N1Y2Nlc3MnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgICAgIHJlYXNvbiA9IHN3aXRjaF9yZXN1bHQuZ2V0KCdyZWFzb24nLCAndW5rbm93bicpCiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UgPSBzd2l0Y2hfcmVzdWx0LmdldCgnbWVzc2FnZScsICdM4buXaSBraMO0bmcgeMOhYyDEkeG7i25oJykKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJlYXNvbiA9PSAnYWNjb3VudF9ub3RfZm91bmQnOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBDaOG7iSDEkcOhbmggZOG6pXUgbG9nb3V0IGtoaSBjaOG6r2MgY2jhuq9uIGtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gdHJvbmcgZGFuaCBzw6FjaAogICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IHRyb25nIGRhbmggc8OhY2gsIMSRw6FuaCBk4bqldSBsb2dvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fbWFya19hY2NvdW50X2xvZ291dChhY2NvdW50LCAiS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB0cm9uZyBkYW5oIHPDoWNoIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBM4buXaSBraMOhYyBraGkgY2h1eeG7g24gdMOgaSBraG/huqNuIC0ga2jDtG5nIMSRw6FuaCBk4bqldSBsb2dvdXQsIGNo4buJIGLDoW8gbOG7l2kKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIGNodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHttZXNzYWdlfSwgc+G6vSB0aOG7rSBs4bqhaSBzYXUiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgdGjhu60gdMOgaSBraG/huqNuIGtow6FjCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wIHNhdSBraGkgY2h1eeG7g24gdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3VwZGF0ZV9sb2dnZWRfaW5fc3RhdHVzKGFwcF9uYW1lLCBjdXJyZW50X2FjY291bnRfaWQsIFRydWUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVMawxqFuZyB0aMOtY2ggduG7m2kgaW1wbGVtZW50YXRpb24gY8WpIHRy4bqjIHbhu4EgYm9vbGVhbgogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzd2l0Y2hfcmVzdWx0OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIktow7RuZyB0aOG7gyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCBz4bq9IHRo4butIGzhuqFpIHNhdSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBUcuG6oyB24buBIEZhbHNlIMSR4buDIHRo4butIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBzYXUga2hpIGNodXnhu4NuIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl91cGRhdGVfbG9nZ2VkX2luX3N0YXR1cyhhcHBfbmFtZSwgY3VycmVudF9hY2NvdW50X2lkLCBUcnVlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkcOjIMSRxINuZyBuaOG6rXAsIGLhu48gcXVhIGNodXnhu4NuIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGpvYiB24bubaSBlcnJvciBoYW5kbGluZwogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkzhuqV5IGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0iKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBqb2IgPSBoYW5kbGVyLmZldGNoX2pvYihhY2NvdW50KQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBub3Qgam9iOgogICAgICAgICAgICAgICAgICAgICMgVMSDbmcgY291bnRlciBraMO0bmcgY8OzIGpvYgogICAgICAgICAgICAgICAgICAgIG5vX2pvYl9jb3VudCA9IHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50cy5nZXQoY3VycmVudF9hY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbY3VycmVudF9hY2NvdW50X2lkXSA9IG5vX2pvYl9jb3VudAogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiS2jDtG5nIGPDsyBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IChs4bqnbiB7bm9fam9iX2NvdW50fS81KSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSBraMO0bmcgY8OzIGpvYiA1IGzhuqduIGxpw6puIHRp4bq/cCwgY2hvIHTDoGkga2hv4bqjbiBuZ2jhu4kgdGhlbyBjb25maWcKICAgICAgICAgICAgICAgICAgICBpZiBub19qb2JfY291bnQgPj0gNToKICAgICAgICAgICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZGIuZ2V0X2RldmljZV9jb25maWcoImNvb2xkb3duX2dldF9qb2JfZ29saWtlIiwgMzApCiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0ga2jDtG5nIGPDsyBqb2Ige25vX2pvYl9jb3VudH0gbOG6p24gbGnDqm4gdGnhur9wLCBjaG8gbmdo4buJIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldF9hY2NvdW50X2luYWN0aXZlKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZD1jdXJyZW50X2FjY291bnRfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb29sZG93bl9taW51dGVzPWNvb2xkb3duX21pbnV0ZXMsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmFjdGl2ZV9yZWFzb249ZiJLaMO0bmcgY8OzIGpvYiB7bm9fam9iX2NvdW50fSBs4bqnbiBsacOqbiB0aeG6v3AiCiAgICAgICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgZXJyb3IgY291bnQgc2F1IGtoaSDEkeG6t3QgaW5hY3RpdmUKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2N1cnJlbnRfYWNjb3VudF9pZF0gPSAwCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UgICMgVHLhuqMgduG7gSBGYWxzZSDEkeG7gyBiw6FvIGhp4buHdSBj4bqnbiB0w6xtIHTDoGkga2hv4bqjbiBraMOhYwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlICAjIEtow7RuZyBjw7Mgam9iIG5oxrBuZyBjaMawYSDEkeG6v24gZ2nhu5tpIGjhuqFuLCB0aOG7rSBs4bqhaSBzYXUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBlcnJvciBjb3VudCBraGkgY8OzIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICBpZiBjdXJyZW50X2FjY291bnRfaWQgaW4gc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmZldGNoX2pvYl9lcnJvcl9jb3VudHNbY3VycmVudF9hY2NvdW50X2lkXSA9IDAKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgIyBUxINuZyBlcnJvciBjb3VudCBraGkgZmV0Y2ggam9iIGzhu5dpCiAgICAgICAgICAgICAgICBlcnJvcl9jb3VudCA9IHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50cy5nZXQoY3VycmVudF9hY2NvdW50X2lkLCAwKSArIDEKICAgICAgICAgICAgICAgIHNlbGYuZmV0Y2hfam9iX2Vycm9yX2NvdW50c1tjdXJyZW50X2FjY291bnRfaWRdID0gZXJyb3JfY291bnQKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGzhuqV5IGpvYiBjaG8gdMOgaSBraG/huqNuIHt1c2VybmFtZX0gKGzhuqduIHtlcnJvcl9jb3VudH0vNSk6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTuG6v3UgbOG7l2kgNSBs4bqnbiBsacOqbiB0aeG6v3AsIGNobyB0w6BpIGtob+G6o24gbmdo4buJIHRoZW8gY29uZmlnCiAgICAgICAgICAgICAgICBpZiBlcnJvcl9jb3VudCA+PSA1OgogICAgICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXMgPSBzZWxmLmRiLmdldF9kZXZpY2VfY29uZmlnKCJjb29sZG93bl9nZXRfam9iX2dvbGlrZSIsIDMwKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gbOG7l2kgZmV0Y2ggam9iIHtlcnJvcl9jb3VudH0gbOG6p24gbGnDqm4gdGnhur9wLCBjaG8gbmdo4buJIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZSgKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZD1jdXJyZW50X2FjY291bnRfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgIGNvb2xkb3duX21pbnV0ZXM9Y29vbGRvd25fbWludXRlcywKICAgICAgICAgICAgICAgICAgICAgICAgaW5hY3RpdmVfcmVhc29uPWYiTOG7l2kgZmV0Y2ggam9iIHtlcnJvcl9jb3VudH0gbOG6p24gbGnDqm4gdGnhur9wIgogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGVycm9yIGNvdW50IHNhdSBraGkgxJHhurd0IGluYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5mZXRjaF9qb2JfZXJyb3JfY291bnRzW2N1cnJlbnRfYWNjb3VudF9pZF0gPSAwCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY+G6p24gdMOsbSB0w6BpIGtob+G6o24ga2jDoWMKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgTOG7l2kgbmjGsG5nIGNoxrBhIMSR4bq/biBnaeG7m2kgaOG6oW4sIHRo4butIGzhuqFpIHNhdQogICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgZGV2aWNlIG1lc3NhZ2UKICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2RldmljZV9tZXNzYWdlX2Zvcl9qb2IoYWNjb3VudCwgam9iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIGpvYiBmb2xsb3cgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAgICAgIyBSZWZyZXNoIGFjY291bnQgZGF0YSB04burIERCIMSR4buDIMSR4bqjbSBi4bqjbyBjw7MgdGjDtG5nIHRpbiBt4bubaSBuaOG6pXQKICAgICAgICAgICAgYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHbhu5tpIElEIHthY2NvdW50WydpZCddfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgc2VsZi5fdmFsaWRhdGVfZm9sbG93X2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYiwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgU2tpcCBqb2Iga2jDtG5nIHBo4bqjaSBs4buXaSwga2jDtG5nIMSRw7NuZyBhcHAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVmFsaWRhdGUgam9iIGLhurFuZyBoYW5kbGVyCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl92YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKGFjY291bnQsIGpvYiwgaGFuZGxlcik6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZSAgIyBTa2lwIGpvYiBraMO0bmcgcGjhuqNpIGzhu5dpLCBraMO0bmcgxJHDs25nIGFwcAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIGpvYgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlRo4buxYyBoaeG7h24gam9iIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfToge2pvYi5nZXQoJ3R5cGUnLCAndW5rbm93bicpfSIpCiAgICAgICAgICAgIGpvYl9yZXN1bHQgPSBoYW5kbGVyLmV4ZWN1dGVfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgWOG7rSBsw70ga+G6v3QgcXXhuqMgam9iIChiYW8gZ+G7k20gYsOhbyBjw6FvIHbDoCBj4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6opCiAgICAgICAgICAgIHNlbGYuX2hhbmRsZV9qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNtYXJ0IGNhcmUgc2F1IGtoaSBo4bq/dCBqb2IKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgc2VsZi5fc2hvdWxkX3BlcmZvcm1fY2FyZV9zbWFydChhY2NvdW50LCAiYWZ0ZXJfam9iIik6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTbWFydCBjYXJlIHNhdSBqb2IgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCBkZXZpY2VfbWVzc2FnZSBjaG8gU21hcnQgY2FyZSBhZnRlcl9qb2IKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgiZGV2aWNlX21lc3NhZ2UiLCBmIkNhcmUgc2F1IGpvYjoge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgY2FyZV9zdWNjZXNzID0gc2VsZi5fcGVyZm9ybV9zbWFydF9jYXJlKGFjY291bnQsICJhZnRlcl9qb2IiKQogICAgICAgICAgICAgICAgICAgIGlmIGNhcmVfc3VjY2VzczoKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJTbWFydCBjYXJlIHNhdSBqb2IgdGjDoG5oIGPDtG5nIGNobyB7dXNlcm5hbWV9IikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNtYXJ0IGNhcmUgc2F1IGpvYiB0aOG6pXQgYuG6oWkgY2hvIHt1c2VybmFtZX0iKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJC4buPIHF1YSBzbWFydCBjYXJlIGNobyB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSAoa2jDtG5nIMSR4bunIMSRaeG7gXUga2nhu4duKSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIHNtYXJ0IGNhcmUgdMOgaSBraG/huqNuIHt1c2VybmFtZX06IHtlfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtIw5RORyDEkcOzbmcgYXBwIHNhdSBt4buXaSBqb2IgLSBjaOG7iSDEkcOzbmcga2hpIGPhuqduIHRoaeG6v3QKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJIb8OgbiB0aMOgbmggam9iIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIGzDoG0gdmnhu4djIHbhu5tpIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIFRy4bqjIHbhu4EgRmFsc2UgxJHhu4MgYsOhbyBoaeG7h3UgY8OzIGzhu5dpCiAgICAgICAgICAgIAogICAgZGVmIF9jbG9zZV9hcHBfYW5kX3VwZGF0ZV9zdGF0dXMoc2VsZiwgaGFuZGxlciwgYXBwX25hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgxJDDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGhhbmRsZXI6IEpvYiBoYW5kbGVyCiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcAogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaGFuZGxlci5jbG9zZV9hcHAoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIGxvZ2dlZF9pbiBj4bunYSB0w6BpIGtob+G6o24gdHJvbmcgYXBwIG7DoHkKICAgICAgICAgICAgaWYgYXBwX25hbWUgaW4gc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXQogICAgICAgICAgICAgICAgc2VsZi5kYi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICBkZWwgc2VsZi5jdXJyZW50X2xvZ2dlZF9pbl9hY2NvdW50c1thcHBfbmFtZV0KICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlJlc2V0IHRy4bqhbmcgdGjDoWkgbG9nZ2VkX2luIGNobyB0w6BpIGtob+G6o24ge2FjY291bnRfaWR9ICh7YXBwX25hbWV9KSBraGkgxJHDs25nIGFwcCIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgxJHDs25nIGFwcCB2w6AgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWk6IHtlfSIpCiAgICAgICAgICAgIAogICAgZGVmIF9jaGVja19hbmRfY2xvc2VfYXBwX2lmX25lZWRlZChzZWxmLCBhcHBfbmFtZTogc3RyKToKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHbDoCDEkcOzbmcgYXBwIG7hur91IGtow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIGFwcCBj4bqnbiBraeG7g20gdHJhCiAgICAgICAgIiIiCiAgICAgICAgaWYgbm90IGFwcF9uYW1lOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsm4gdMOgaSBraG/huqNuIG7DoG8gY8OzIHRo4buDIGzDoG0gdmnhu4djIGNobyBhcHAgbsOgeSBraMO0bmcKICAgICAgICAgICAgYWNjb3VudHMgPSBzZWxmLmRiLmdldF9hY2NvdW50cyhhcHA9YXBwX25hbWUpCiAgICAgICAgICAgIHdvcmthYmxlX2FjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIHNlbGYuX2Nhbl9ydW5fam9iKGFjYyldCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3Qgd29ya2FibGVfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIktow7RuZyBjw7JuIHTDoGkga2hv4bqjbiBuw6BvIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgxJHDs25nIGFwcCIpCiAgICAgICAgICAgICAgICBpZiBhcHBfbmFtZSBpbiBzZWxmLmpvYl9oYW5kbGVyczoKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyID0gc2VsZi5qb2JfaGFuZGxlcnNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fY2xvc2VfYXBwX2FuZF91cGRhdGVfc3RhdHVzKGhhbmRsZXIsIGFwcF9uYW1lKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiQ8OybiB7bGVuKHdvcmthYmxlX2FjY291bnRzKX0gdMOgaSBraG/huqNuIGPDsyB0aOG7gyBsw6BtIHZp4buHYyBjaG8ge2FwcF9uYW1lfSwgZ2nhu68gYXBwIG3hu58iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGtp4buDbSB0cmEgdsOgIMSRw7NuZyBhcHAge2FwcF9uYW1lfToge2V9IikKICAgICAgICAKICAgIGRlZiBfbWFya19hY2NvdW50X2xvZ291dChzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgcmVhc29uOiBzdHIgPSAiUGjDoXQgaGnhu4duIGxvZ291dCIpOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSB0w6BpIGtob+G6o24gbG9nb3V0IHbDoCBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkcSDbmcgbmjhuq1wCiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IGRhdGV0aW1lCiAgICAgICAgY3VycmVudF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVkLyVtLyVZICVIOiVNOiVTIikKICAgICAgICBsb2dvdXRfbWVzc2FnZSA9IGYie3JlYXNvbn06IHtjdXJyZW50X3RpbWV9IgogICAgICAgIAogICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSwgewogICAgICAgICAgICAic3RhdHVzIjogImxvZ291dCIsCiAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBsb2dvdXRfbWVzc2FnZSwKICAgICAgICAgICAgImxvZ2dlZF9pbiI6IEZhbHNlLAogICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgfSkKICAgICAgICAKICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cmFja2luZyB0cm9uZyBtZW1vcnkKICAgICAgICBhcHBfbmFtZSA9IGFjY291bnQuZ2V0KCJhcHAiKQogICAgICAgIGlmIGFwcF9uYW1lIGFuZCBhcHBfbmFtZSBpbiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzOgogICAgICAgICAgICBpZiBzZWxmLmN1cnJlbnRfbG9nZ2VkX2luX2FjY291bnRzW2FwcF9uYW1lXSA9PSBhY2NvdW50WyJpZCJdOgogICAgICAgICAgICAgICAgZGVsIHNlbGYuY3VycmVudF9sb2dnZWRfaW5fYWNjb3VudHNbYXBwX25hbWVdCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJYw7NhIHTDoGkga2hv4bqjbiB7YWNjb3VudFsnaWQnXX0gKHthcHBfbmFtZX0pIGto4buPaSB0cmFja2luZyBkbyBsb2dvdXQiKQogICAgICAgIAogICAgZGVmIF91cGRhdGVfZGV2aWNlX21lc3NhZ2VfZm9yX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgam9iOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGRldmljZSBtZXNzYWdlIGNobyBqb2IgaGnhu4duIHThuqFpCiAgICAgICAgIiIiCiAgICAgICAgbGluayA9IGpvYi5nZXQoJ2xpbmsnLCAnJykKICAgICAgICBpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3Lmluc3RhZ3JhbS5jb20vJywgJycpCiAgICAgICAgZWxpZiBsaW5rLnN0YXJ0c3dpdGgoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJyk6CiAgICAgICAgICAgIGxpbmsgPSBsaW5rLnJlcGxhY2UoJ2h0dHBzOi8vd3d3LnRpa3Rvay5jb20vJywgJycpCiAgICAgICAgCiAgICAgICAgbWVzc2FnZSA9IGYiW3thY2NvdW50LmdldCgnYXBwJyl9XVt7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfV1be2pvYi5nZXQoJ3R5cGUnKX1dW3tsaW5rfV0iCiAgICAgICAgc2VsZi5kYi5zZXQoImRldmljZV9tZXNzYWdlIiwgbWVzc2FnZSkKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIGPhu6dhIGpvYiBzYXUga2hpIHRo4buxYyBoaeG7h24KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgam9iX3N1Y2Nlc3MgPSBqb2JfcmVzdWx0WyJzdWNjZXNzIl0KICAgICAgICBqb2JfbWVzc2FnZSA9IGpvYl9yZXN1bHRbIm1lc3NhZ2UiXQogICAgICAgIAogICAgICAgICMgWOG7rSBsw70gZm9sbG93IGpvYiDEkeG6t2MgYmnhu4d0CiAgICAgICAgaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpID09ICJmb2xsb3ciOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5faGFuZGxlX2ZvbGxvd19qb2JfcmVzdWx0KGFjY291bnQsIGpvYiwgam9iX3Jlc3VsdCwgaGFuZGxlciwgdXNlcm5hbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUgICMgROG7q25nIHbhu5tpIHTDoGkga2hv4bqjbiBuw6B5IG5oxrBuZyB0aeG6v3AgdOG7pWMgbMOgbSB2aeG7h2MKICAgICAgICAKICAgICAgICAjIELDoW8gY8OhbyBr4bq/dCBxdeG6owogICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIGpvYl9yZXN1bHQpCiAgICAgICAgCiAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjhu5FuZyBrw6oKICAgICAgICBzZWxmLl91cGRhdGVfam9iX3N0YXRzKGFjY291bnQsIGpvYl9zdWNjZXNzLCBqb2IuZ2V0KCJ0eXBlIiwgIiIpLCBqb2JfcmVzdWx0KQogICAgICAgIAogICAgICAgIHJldHVybiBUcnVlICAjIFRow6BuaCBjw7RuZwogICAgICAgIAogICAgZGVmIF9oYW5kbGVfZm9sbG93X2pvYl9yZXN1bHQoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGpvYl9yZXN1bHQ6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IGvhur90IHF14bqjIMSR4bq3YyBiaeG7h3QgY2hvIGZvbGxvdyBqb2IKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRp4bq/cCB04bulYyB24bubaSB0w6BpIGtob+G6o24gbsOgeSwgRmFsc2UgbuG6v3UgY+G6p24gZOG7q25nCiAgICAgICAgIiIiCiAgICAgICAgam9iX3N0YXR1cyA9IGpvYl9yZXN1bHRbInN0YXR1cyJdCiAgICAgICAgCiAgICAgICAgIyBY4butIGzDvSBs4buXaSBmb2xsb3cgcGVuZGluZyAoc3RhdHVzIDQpIHbDoCBn4butaSB5w6p1IGPhuqd1IGNo4budIGR1eeG7h3QgKHN0YXR1cyA1KQogICAgICAgIGlmIGpvYl9zdGF0dXMgaW4gWzQsIDVdOgogICAgICAgICAgICBjbnQgPSBzZWxmLmZvbGxvd19wZW5kaW5nX2NvdW50cy5nZXQoYWNjb3VudFsiaWQiXSwgMCkgKyAxCiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gY250CiAgICAgICAgICAgIGlmIGNudCA+PSA1OgogICAgICAgICAgICAgICAgc3RhdHVzX21zZyA9ICJmb2xsb3cgcGVuZGluZyIgaWYgam9iX3N0YXR1cyA9PSA0IGVsc2UgImfhu61pIHnDqnUgY+G6p3UgY2jhu50gZHV54buHdCIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHt1c2VybmFtZX0gxJHDoyA1IGzhuqduIGxpw6puIHRp4bq/cCB7c3RhdHVzX21zZ30sIHThuqFtIGThu6tuZyB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAgICAgc2VsZi5kYi5zZXRfYWNjb3VudF9pbmFjdGl2ZShhY2NvdW50WyJpZCJdLCBpbmFjdGl2ZV9yZWFzb249ZiJMacOqbiB0aeG6v3AgbOG7l2kge3N0YXR1c19tc2d9IikKICAgICAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlICAjIEThu6tuZyB24bubaSB0w6BpIGtob+G6o24gbsOgeQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlbGYuZm9sbG93X3BlbmRpbmdfY291bnRzW2FjY291bnRbImlkIl1dID0gMAogICAgICAgIAogICAgICAgICMgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbgogICAgICAgIHNlbGYuX2NoZWNrX2FuZF9kaXNhYmxlX2ZvbGxvd19hZnRlcl9qb2IoYWNjb3VudCwgdXNlcm5hbWUpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAKICAgIGRlZiBfY2hlY2tfYW5kX2Rpc2FibGVfZm9sbG93X2FmdGVyX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSwgdXNlcm5hbWU6IHN0cik6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSB2w6AgZGlzYWJsZSBmb2xsb3cgbuG6v3UgxJHhuqF0IGdp4bubaSBo4bqhbiBzYXUga2hpIGzDoG0gam9iCiAgICAgICAgIiIiCiAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gPSBhY2NvdW50LmdldCgiZm9sbG93X2luX3Nlc3Npb24iLCAwKQogICAgICAgIG1heF9mb2xsb3dfc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJtYXhfZm9sbG93X3Nlc3Npb24iLCA1KQogICAgICAgIGZvbGxvd190b2RheSA9IGFjY291bnQuZ2V0KCJmb2xsb3dfdG9kYXkiLCAwKQogICAgICAgIG1heF9mb2xsb3dfZGF5ID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfZGF5IiwgMjApCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIMSR4bqhdCBnaeG7m2kgaOG6oW4gbmfDoHkgdHLGsOG7m2MKICAgICAgICBpZiBmb2xsb3dfdG9kYXkgPj0gbWF4X2ZvbGxvd19kYXk6CiAgICAgICAgICAgICMgVMOtbmggdGjhu51pIGdpYW4gxJHhur9uIHJlc2V0IG5nw6B5IHRp4bq/cCB0aGVvICh0w61uaCB0aGVvIHBow7p0KQogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUKICAgICAgICAgICAgam9iX2hvdXIgPSBzZWxmLmRiLmdldCgiam9iX2hvdXIiLCBjb25maWcuSk9CX0hPVVIpCiAgICAgICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgICAgIHRvbW9ycm93ID0gbm93LmRhdGUoKSArIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgIG5leHRfcmVzZXRfdGltZSA9IGRhdGV0aW1lLmRhdGV0aW1lLmNvbWJpbmUodG9tb3Jyb3csIGRhdGV0aW1lLnRpbWUoaG91cj1qb2JfaG91ciwgbWludXRlPTApKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw61uaCBz4buRIHBow7p0IHThu6sgYsOieSBnaeG7nSDEkeG6v24gdGjhu51pIMSRaeG7g20gcmVzZXQKICAgICAgICAgICAgdGltZV9kaWZmID0gbmV4dF9yZXNldF90aW1lIC0gbm93CiAgICAgICAgICAgIHBlbmFsdHlfbWludXRlcyA9IGludCh0aW1lX2RpZmYudG90YWxfc2Vjb25kcygpIC8gNjApCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGjDoG0gY8OzIHPhurVuIHRyb25nIGRiX3NlcnZpY2UKICAgICAgICAgICAgc2VsZi5kYi5kaXNhYmxlX2FjY291bnRfZm9sbG93KAogICAgICAgICAgICAgICAgYWNjb3VudF9pZD1hY2NvdW50WyJpZCJdLAogICAgICAgICAgICAgICAgcGVuYWx0eV9taW51dGVzPXBlbmFsdHlfbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBuZ8OgeSIKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSR4bqhdCBnaeG7m2kgaOG6oW4gZm9sbG93IG5nw6B5ICh7Zm9sbG93X3RvZGF5fS97bWF4X2ZvbGxvd19kYXl9KSwgZGlzYWJsZSDEkeG6v24ge25leHRfcmVzZXRfdGltZS5zdHJmdGltZSgnJVktJW0tJWQgJUg6JU06JVMnKX0iKQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgxJHhuqF0IGdp4bubaSBo4bqhbiBzZXNzaW9uCiAgICAgICAgZWxpZiBmb2xsb3dfaW5fc2Vzc2lvbiA+PSBtYXhfZm9sbG93X3Nlc3Npb246CiAgICAgICAgICAgICMgVMOtbmggdGjhu51pIGdpYW4gxJHhur9uIGtoaSBr4bq/dCB0aMO6YyBzZXNzaW9uIGhp4buHbiB04bqhaQogICAgICAgICAgICBjb29sZG93bl9taW51dGVzID0gc2VsZi5kYi5nZXQoImpvYl9jb29sZG93bl9taW51dGVzIiwgY29uZmlnLkRFRkFVTFRfQ09PTERPV05fTUlOVVRFUykKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBzZXNzaW9uIC0gZGlzYWJsZSB7Y29vbGRvd25fbWludXRlc30gcGjDunQgKMSR4bq/biBraGkga+G6v3QgdGjDumMgc2Vzc2lvbikiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBT4butIGThu6VuZyBow6BtIHThu6sgZGJfc2VydmljZSB24bubaSB0aOG7nWkgZ2lhbiBuZ2jhu4kgc2Vzc2lvbgogICAgICAgICAgICBzZWxmLmRiLmRpc2FibGVfYWNjb3VudF9mb2xsb3coCiAgICAgICAgICAgICAgICBhY2NvdW50X2lkPWFjY291bnRbImlkIl0sCiAgICAgICAgICAgICAgICBwZW5hbHR5X21pbnV0ZXM9Y29vbGRvd25fbWludXRlcywKICAgICAgICAgICAgICAgIHJlYXNvbj0ixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBwaGnDqm4iCiAgICAgICAgICAgICkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyBwaGnDqm4gKHtmb2xsb3dfaW5fc2Vzc2lvbn0ve21heF9mb2xsb3dfc2Vzc2lvbn0pLCBkaXNhYmxlIHtjb29sZG93bl9taW51dGVzfSBwaMO6dCIpCiAgICAgICAgICAgIAogICAgZGVmIF92YWxpZGF0ZV9qb2Jfd2l0aF9oYW5kbGVyKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldLCBqb2I6IERpY3Rbc3RyLCBBbnldLCBoYW5kbGVyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFZhbGlkYXRlIGpvYiBi4bqxbmcgaGFuZGxlcgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3Ugam9iIGjhu6NwIGzhu4csIEZhbHNlIG7hur91IGPhuqduIHNraXAgaG/hurdjIGNvbnRpbnVlCiAgICAgICAgIiIiCiAgICAgICAgdmFsaWRhdGlvbl9yZXN1bHQgPSBoYW5kbGVyLnZhbGlkYXRlX2pvYl9iZWZvcmVfZXhlY3V0aW9uKGFjY291bnQsIGpvYikKICAgICAgICBpZiBub3QgdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJ2YWxpZCIsIFRydWUpOgogICAgICAgICAgICBpZiB2YWxpZGF0aW9uX3Jlc3VsdC5nZXQoInNob3VsZF9za2lwIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgIyBTa2lwIGpvYgogICAgICAgICAgICAgICAgc2tpcF9tZXNzYWdlID0gdmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIkpvYiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNraXAgam9iOiB7c2tpcF9tZXNzYWdlfSIpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaGFuZGxlci5yZWNvcmRfam9iX2hpc3RvcnkoYWNjb3VudCwgam9iLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLCAKICAgICAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBGYWxzZSwgCiAgICAgICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogc2tpcF9tZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnNraXBfam9iKGFjY291bnQsIGpvYikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNraXAgam9iIGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCgzLCAxMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIHNraXAgam9iIMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnNhZmVfc2xlZXAoc2tpcF9zbGVlcF90aW1lKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiSm9iIGtow7RuZyBo4bujcCBs4buHOiB7dmFsaWRhdGlvbl9yZXN1bHQuZ2V0KCdtZXNzYWdlJywgJ1Vua25vd24gZXJyb3InKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIAogICAgZGVmIF92YWxpZGF0ZV9mb2xsb3dfam9iX2JlZm9yZV9leGVjdXRpb24oc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0sIGhhbmRsZXIsIHVzZXJuYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgVmFsaWRhdGUgZm9sbG93IGpvYiB0csaw4bubYyBraGkgdGjhu7FjIGhp4buHbgogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY8OzIHRo4buDIHRo4buxYyBoaeG7h24sIEZhbHNlIG7hur91IGPhuqduIHNraXAKICAgICAgICAiIiIKICAgICAgICAjIENo4buJIHZhbGlkYXRlIGNobyBqb2IgZm9sbG93CiAgICAgICAgaWYgam9iLmdldCgidHlwZSIsICIiKS5sb3dlcigpICE9ICJmb2xsb3ciOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBmb2xsb3dfaW5fc2Vzc2lvbiA9IGFjY291bnQuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApCiAgICAgICAgbWF4X2ZvbGxvd19zZXNzaW9uID0gYWNjb3VudC5nZXQoIm1heF9mb2xsb3dfc2Vzc2lvbiIsIDUpCiAgICAgICAgZGlzYWJsZV9mb2xsb3cgPSBhY2NvdW50LmdldCgiZGlzYWJsZV9mb2xsb3ciLCBGYWxzZSkKICAgICAgICBmb2xsb3dfZGlzYWJsZV91bnRpbCA9IGFjY291bnQuZ2V0KCJmb2xsb3dfZGlzYWJsZV91bnRpbCIsIDApCiAgICAgICAgbm93ID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgRGVidWcgbG9nIMSR4buDIGtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaQogICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlZhbGlkYXRlIGZvbGxvdyBqb2IgY2hvIHt1c2VybmFtZX06IGRpc2FibGVfZm9sbG93PXtkaXNhYmxlX2ZvbGxvd30sIGZvbGxvd19kaXNhYmxlX3VudGlsPXtmb2xsb3dfZGlzYWJsZV91bnRpbH0sIG5vdz17bm93fSIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgYuG7iyBraMOzYSBmb2xsb3cga2jDtG5nCiAgICAgICAgaWYgZGlzYWJsZV9mb2xsb3c6CiAgICAgICAgICAgIGlmIGZvbGxvd19kaXNhYmxlX3VudGlsID4gMCBhbmQgZm9sbG93X2Rpc2FibGVfdW50aWwgPD0gbm93OgogICAgICAgICAgICAgICAgIyBI4bq/dCB0aOG7nWkgZ2lhbiBraMOzYSwgZW5hYmxlIGzhuqFpIGZvbGxvdwogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJI4bq/dCB0aOG7nWkgZ2lhbiBraMOzYSBmb2xsb3cgY2hvIHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCBlbmFibGUgbOG6oWkgZm9sbG93IikKICAgICAgICAgICAgICAgIHNlbGYuZGIuZW5hYmxlX2FjY291bnRfZm9sbG93KGFjY291bnRbImlkIl0pCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFbhuqtuIMSRYW5nIGLhu4sga2jDs2EgZm9sbG93CiAgICAgICAgICAgICAgICByZW1haW5pbmdfbWludXRlcyA9IGludCgoZm9sbG93X2Rpc2FibGVfdW50aWwgLSBub3cpIC8gNjApIGlmIGZvbGxvd19kaXNhYmxlX3VudGlsID4gbm93IGVsc2UgMAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge3VzZXJuYW1lfSDEkWFuZyBi4buLIGtow7NhIGZvbGxvdyAoY8OybiB7cmVtYWluaW5nX21pbnV0ZXN9IHBow7p0KSwgaOG7p3kgam9iIikKICAgICAgICAgICAgICAgIHJlc3VsdF9za2lwID0gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiA2LCAgIyBTdGF0dXMgY29kZSByacOqbmcgY2hvIMSR4bqhdCBnaeG7m2kgaOG6oW4vYuG7iyBraMOzYQogICAgICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiVMOgaSBraG/huqNuIMSRYW5nIGLhu4sga2jDs2EgZm9sbG93IgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIyByZXBvcnRfam9iIHPhur0gdOG7sSDEkeG7mW5nIHNraXAgam9iIGtoaSBzdGF0dXMgPSA2CiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlcG9ydF9qb2IoYWNjb3VudCwgam9iLCByZXN1bHRfc2tpcCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiUmVjb3JkIGpvYiBoaXN0b3J5IGzhu5dpOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBza2lwX3NsZWVwX3RpbWUgPSByYW5kb20ucmFuZGludCg1LCAyNSkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmdo4buJIHtza2lwX3NsZWVwX3RpbWV9cyBzYXUga2hpIGjhu6d5IGpvYiBmb2xsb3cgxJHhu4MgdHLDoW5oIHNwYW0iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puCiAgICAgICAgaWYgZm9sbG93X2luX3Nlc3Npb24gPj0gbWF4X2ZvbGxvd19zZXNzaW9uOgogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlTDoGkga2hv4bqjbiB7dXNlcm5hbWV9IMSRw6MgxJHhuqF0IGdp4bubaSBo4bqhbiBmb2xsb3cgdHJvbmcgcGhpw6puICh7Zm9sbG93X2luX3Nlc3Npb259L3ttYXhfZm9sbG93X3Nlc3Npb259KSwgaOG7p3kgam9iIikKICAgICAgICAgICAgcmVzdWx0X3NraXAgPSB7CiAgICAgICAgICAgICAgICAic3RhdHVzIjogNiwgICMgU3RhdHVzIGNvZGUgcmnDqm5nIGNobyDEkeG6oXQgZ2nhu5tpIGjhuqFuCiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGZvbGxvdyB0cm9uZyBwaGnDqm4iCiAgICAgICAgICAgIH0KICAgICAgICAgICAgIyByZXBvcnRfam9iIHPhur0gdOG7sSDEkeG7mW5nIHNraXAgam9iIGtoaSBzdGF0dXMgPSA2CiAgICAgICAgICAgIGhhbmRsZXIucmVwb3J0X2pvYihhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBoYW5kbGVyLnJlY29yZF9qb2JfaGlzdG9yeShhY2NvdW50LCBqb2IsIHJlc3VsdF9za2lwKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlJlY29yZCBqb2IgaGlzdG9yeSBs4buXaToge2V9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIHNraXBfc2xlZXBfdGltZSA9IHJhbmRvbS5yYW5kaW50KDMsIDEwKQogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5naOG7iSB7c2tpcF9zbGVlcF90aW1lfXMgc2F1IGtoaSBo4buneSBqb2IgZm9sbG93IMSR4buDIHRyw6FuaCBzcGFtIikKICAgICAgICAgICAgaWYgbm90IHNlbGYuc2FmZV9zbGVlcChza2lwX3NsZWVwX3RpbWUpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZQ==').decode('utf-8'))
