import base64
exec(base64.b64decode('aW1wb3J0IGRhdGV0aW1lCmltcG9ydCB0aW1lCmltcG9ydCByYW5kb20KaW1wb3J0IHJlCmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsCmZyb20gam9icy5qb2JfYmFzZSBpbXBvcnQgQmFzZUpvYgoKY2xhc3MgVGlrdG9rSm9iKEJhc2VKb2IpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZT1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKGRiX3NlcnZpY2UsIGhlbHBlcl9zZXJ2aWNlLCBnb2xpa2Vfc2VydmljZSkKICAgICAgICBzZWxmLmFwcF9wYWNrYWdlID0gImNvbS5zcy5hbmRyb2lkLnVnYy50cmlsbCIKICAgICAgICBzZWxmLmFwcF9uYW1lID0gInRpa3RvayIKICAgICAgICAKICAgIGRlZiBnZXRfYWNjb3VudHNfZnJvbV9kZXZpY2Uoc2VsZikgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gVGlrdG9rIHThu6sgdGhp4bq/dCBi4buLIiIiCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBN4bufIOG7qW5nIGThu6VuZyBUaWtUb2sKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu50gbcOgbiBow6xuaCBjaMOtbmggdOG6o2kgLSBraeG7g20gdHJhIGNobyDEkeG6v24ga2hpIGPDsyAiVHJhbmcgY2jhu6ciIGhv4bq3YyB04buRaSDEkWEgMjBzCiAgICAgICAgICAgIGhvbWVfYnV0dG9uID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIiwgdGltZW91dD0yMCkKICAgICAgICAgICAgaWYgbm90IGhvbWVfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyB04bqjaSBtw6BuIGjDrG5oIGNow61uaCBUaWtUb2sgc2F1IDIwIGdpw6J5IikKICAgICAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBuw7p0ICJI4buTIHPGoSIgdsOgIG5o4bqlcCB2w6BvCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9uYXZpZ2F0ZV90b19wcm9maWxlX3RhYigpOgogICAgICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIG1lbnUgaOG7kyBzxqEgxJHhu4MgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAgICAgaWYgbm90IHNlbGYuX29wZW5fcHJvZmlsZV9tZW51KCk6CiAgICAgICAgICAgICAgICByZXR1cm4gW10KICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgWE1MIG3DoG4gaMOsbmggc2F1IGtoaSBt4bufIG1lbnUKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCAiVGjDqm0gdMOgaSBraG/huqNuIgogICAgICAgICAgICBhZGRfYWNjb3VudF9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iVGjDqm0gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFkZF9hY2NvdW50X2J1dHRvbjoKICAgICAgICAgICAgICAgICMgVMOsbSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiAoUmVjeWNsZXJWaWV3KSAtIGzDoCBjaGEgY+G7p2EgbsO6dCAiVGjDqm0gdMOgaSBraG/huqNuIgogICAgICAgICAgICAgICAgcmVjeWNsZXJfdmlldyA9IE5vbmUKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIHThuqV0IGPhuqMgUmVjeWNsZXJWaWV3CiAgICAgICAgICAgICAgICBhbGxfcmVjeWNsZXJfdmlld3MgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwgCiAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZHgucmVjeWNsZXJ2aWV3LndpZGdldC5SZWN5Y2xlclZpZXciCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBSZWN5Y2xlclZpZXcgY2jhu6lhIGPDoWMgdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBmb3IgcnYgaW4gYWxsX3JlY3ljbGVyX3ZpZXdzOgogICAgICAgICAgICAgICAgICAgIHJ2X2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhydikKICAgICAgICAgICAgICAgICAgICBhZGRfYWNjb3VudF9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHMoYWRkX2FjY291bnRfYnV0dG9uKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gYWRkX2FjY291bnRfYnV0dG9uIGPDsyBu4bqxbSB0cm9uZyByZWN5Y2xlcl92aWV3IGtow7RuZwogICAgICAgICAgICAgICAgICAgIGlmIChydl9ib3VuZHNbMF0gPD0gYWRkX2FjY291bnRfYm91bmRzWzBdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICBydl9ib3VuZHNbMV0gPD0gYWRkX2FjY291bnRfYm91bmRzWzFdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICBydl9ib3VuZHNbMl0gPj0gYWRkX2FjY291bnRfYm91bmRzWzJdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICBydl9ib3VuZHNbM10gPj0gYWRkX2FjY291bnRfYm91bmRzWzNdKToKICAgICAgICAgICAgICAgICAgICAgICAgcmVjeWNsZXJfdmlldyA9IHJ2CiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHJlY3ljbGVyX3ZpZXc6CiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIHThuqV0IGPhuqMgbsO6dCAoQnV0dG9uKSB0cm9uZyBSZWN5Y2xlclZpZXcgYuG6sW5nIGNsYXNzIHRoYXkgdsOsIHJlc291cmNlLWlkCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9idXR0b25zID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5CdXR0b24iCiAgICAgICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGZvciBidXR0b24gaW4gYWNjb3VudF9idXR0b25zOgogICAgICAgICAgICAgICAgICAgICAgICAjIELhu48gcXVhIG7DunQgIlRow6ptIHTDoGkga2hv4bqjbiIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgYnV0dG9uLmdldCgiY29udGVudC1kZXNjIikgPT0gIlRow6ptIHTDoGkga2hv4bqjbiI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBM4bqleSB0w6puIHTDoGkga2hv4bqjbiB04burIGNvbnRlbnQtZGVzYwogICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGJ1dHRvbi5nZXQoImNvbnRlbnQtZGVzYyIsICIiKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFTDrG0gVGV4dFZpZXcgdHJvbmcgYnV0dG9uIGLhurFuZyBjbGFzcyB0aGF5IHbDrCByZXNvdXJjZS1pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dHZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuVGV4dFZpZXciCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgTOG7jWMgdGV4dHZpZXcgdGhlbyBib3VuZHMgxJHhu4MgdMOsbSDEkcO6bmcgY8OhaSB0aHXhu5ljIHbhu4EgYnV0dG9uIG7DoHkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1dHRvbl9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHMoYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIHR2IGluIHRleHR2aWV3czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHModHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHR2X2JvdW5kc1swXSA+PSBidXR0b25fYm91bmRzWzBdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHNbMV0gPj0gYnV0dG9uX2JvdW5kc1sxXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzWzJdIDw9IGJ1dHRvbl9ib3VuZHNbMl0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kc1szXSA8PSBidXR0b25fYm91bmRzWzNdKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQodHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSDEkeG7gyBraMO0bmcgbOG6pXkgcGjhuqNpIHRleHQgcuG7l25nIGhv4bq3YyAibnVsbCIKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGV4dCBhbmQgdGV4dCAhPSAibnVsbCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHRleHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIELhu48gcXVhIG7DunQgIsSQw7NuZyIKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlcm5hbWUgPT0gIsSQw7NuZyI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gY8OzIMSRYW5nIMSRxINuZyBuaOG6rXAga2jDtG5nCiAgICAgICAgICAgICAgICAgICAgICAgIGlzX2N1cnJlbnQgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBUw6xtIGThuqV1IGtp4buDbSB0cm9uZyBidXR0b24gYuG6sW5nIGNvbnRlbnQtZGVzYwogICAgICAgICAgICAgICAgICAgICAgICBjaGVja21hcmtzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRlbnRfZGVzYz0iROG6pXUga2nhu4NtIgogICAgICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGThuqV1IGtp4buDbSBjw7MgdGh14buZYyB24buBIGJ1dHRvbiBuw6B5IGtow7RuZwogICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKGJ1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGNoZWNrIGluIGNoZWNrbWFya3M6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGVja19ib3VuZHMgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF9ib3VuZHMoY2hlY2spCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoY2hlY2tfYm91bmRzWzBdID49IGJ1dHRvbl9ib3VuZHNbMF0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfYm91bmRzWzFdID49IGJ1dHRvbl9ib3VuZHNbMV0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfYm91bmRzWzJdIDw9IGJ1dHRvbl9ib3VuZHNbMl0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hlY2tfYm91bmRzWzNdIDw9IGJ1dHRvbl9ib3VuZHNbM10pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX2N1cnJlbnQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgQ8WpbmcgY8OzIHRo4buDIGtp4buDbSB0cmEgdGh14buZYyB0w61uaCBzZWxlY3RlZAogICAgICAgICAgICAgICAgICAgICAgICBpZiBidXR0b24uZ2V0KCJzZWxlY3RlZCIpID09ICJ0cnVlIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlzX2N1cnJlbnQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgdXNlcm5hbWUgaOG7o3AgbOG7hyB0csaw4bubYyBraGkgdGjDqm0gdsOgbyBkYW5oIHPDoWNoCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lIGFuZCB1c2VybmFtZSAhPSAibnVsbCIgYW5kIHVzZXJuYW1lLnN0cmlwKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEzhu41jIHRow6ptIGPDoWMgdMOqbiBraMO0bmcgcGjhuqNpIHTDoGkga2hv4bqjbgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXNlcm5hbWUgbm90IGluIFsiQ8OgaSDEkeG6t3QiLCAiQ8OgaSDEkeG6t3QgdMOgaSBraG/huqNuIiwgIlTDuXkgY2jhu41uIiwgIk1lbnUiXToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY2NvdW50ID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAibmlja25hbWUiOiB1c2VybmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgInVuaXF1ZV91c2VybmFtZSI6IHVzZXJuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAidW5pcXVlX2lkIjogdXNlcm5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogaXNfY3VycmVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImF2YXRhcl90aHVtYiI6ICIiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2VuYWJsZSI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJsZXZlbCI6IDEsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUXVheSBs4bqhaSBtw6BuIGjDrG5oIGNow61uaAogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC41KQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgbOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gVGlrVG9rIikKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnRzCiAgICAKICAgIGRlZiBwZXJmb3JtX2pvYihzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiBjw7RuZyB2aeG7h2MgduG7m2kgdMOgaSBraG/huqNuIFRpa1RvayIiIgogICAgICAgICMgU+G7rSBk4bulbmcgcGjGsMahbmcgdGjhu6ljIGPhu6dhIGzhu5twIGNoYQogICAgICAgIHN1cGVyKCkucGVyZm9ybV9qb2IoYWNjb3VudCkKICAgICAgICAKICAgIGRlZiBwZXJmb3JtX2NhcmUoc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIk51w7RpIHTDoGkga2hv4bqjbiBUaWtUb2siIiIKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJBhbmcgbnXDtGkgdMOgaSBraG/huqNuIFRpa1Rvazoge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgIyBH4buNaSBwaMawxqFuZyB0aOG7qWMgbWluaSBjYXJlCiAgICAgICAgcmV0dXJuIHNlbGYucGVyZm9ybV9taW5pX2NhcmUoYWNjb3VudCkKICAgICAgICAKICAgIGRlZiBwZXJmb3JtX21pbmlfY2FyZShzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgaGnhu4duIG1pbmkgY2FyZSBjaG8gdMOgaSBraG/huqNuIFRpa1RvazoKICAgICAgICAxLiBW4buBIHRyYW5nIGNo4bunLCB4w6FjIG5o4bqtbiB0YWIgxJHhu4EgeHXhuqV0CiAgICAgICAgMi4gTMaw4bubdCDEkeG7gSB4deG6pXQgdHJvbmcgMi0zIHBow7p0CiAgICAgICAgMy4gTmfhuqt1IG5oacOqbiBi4bqlbSB2w6BvIEjhu5lwIHRoxrAsIGThu6tuZyAyLTVzLCB2deG7kXQgbMOqbiwgcXVheSBs4bqhaSB0cmFuZyBjaOG7pwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFjY291bnQ6IFRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbWluaSBjYXJlIGNobyB0w6BpIGtob+G6o24gVGlrVG9rOiB7YWNjb3VudFsndW5pcXVlX3VzZXJuYW1lJ119IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMS4gxJDhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgdsOgIHjDoWMgbmjhuq1uIHRhYiDEkeG7gSB4deG6pXQKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHbhu4EgdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB2w6AgY2xpY2sgdsOgbyB0YWIgIkTDoG5oIGNobyBi4bqhbiIgKHRhYiDEkeG7gSB4deG6pXQpCiAgICAgICAgICAgIGZvcl95b3VfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IkTDoG5oIGNobyBi4bqhbiIpCiAgICAgICAgICAgIGlmIG5vdCBmb3JfeW91X3RhYjoKICAgICAgICAgICAgICAgIGZvcl95b3VfdGFiID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iRMOgbmggY2hvIGLhuqFuIikKICAgICAgICAgICAgaWYgbm90IGZvcl95b3VfdGFiOgogICAgICAgICAgICAgICAgZm9yX3lvdV90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iRm9yIFlvdSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaWYgZm9yX3lvdV90YWI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSB0YWIgxJHhu4EgeHXhuqV0LCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihmb3JfeW91X3RhYikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiDEkeG7gSB4deG6pXQsIGdp4bqjIMSR4buLbmggxJFhbmcg4bufIHRhYiDEkcO6bmciKQoKICAgICAgICAgICAgIyAyLiBMxrDhu5t0IMSR4buBIHh14bqldCB0cm9uZyAxLTMgcGjDunQKICAgICAgICAgICAgc2Nyb2xsX2R1cmF0aW9uID0gcmFuZG9tLnJhbmRpbnQoNjAsIDE4MCkgICMgMS0zIHBow7p0CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJC4bqvdCDEkeG6p3UgbMaw4bubdCDEkeG7gSB4deG6pXQgdHJvbmcge3Njcm9sbF9kdXJhdGlvbn0gZ2nDonkuLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgc3RhcnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHZpZGVvX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgKHRpbWUudGltZSgpIC0gc3RhcnRfdGltZSkgPCBzY3JvbGxfZHVyYXRpb246CiAgICAgICAgICAgICAgICAjIEzGsOG7m3QgbMOqbiDEkeG7gyBjaHV54buDbiB2aWRlbyB0aeG6v3AgdGhlbwogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgdmlkZW9fY291bnQgKz0gMQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSBuZ+G6q3Ugbmhpw6puIDMtOCBnacOieSBnaeG7r2EgY8OhYyB2aWRlbyAobmjGsCBuZ8aw4budaSBkw7luZyB0aOG6rXQpCiAgICAgICAgICAgICAgICB3YXRjaF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgOCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YXRjaF90aW1lKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFJhbmRvbSBjw7MgMTAlIGto4bqjIG7Eg25nIGLhuqVtIGxpa2UgdmlkZW8KICAgICAgICAgICAgICAgIGlmIHJhbmRvbS5yYW5kb20oKSA8IDAuMTogICMgMTAlIGNoYW5jZQogICAgICAgICAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgICAgICAgICAgICAgaWYgbGlrZV9idXR0b24gYW5kIG5vdCBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGxpa2VfYnV0dG9uKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiUmFuZG9tIGxpa2UgdmlkZW8gdHJvbmcga2hpIG1pbmkgY2FyZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihsaWtlX2J1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgUmFuZG9tIGPDsyA1JSBraOG6oyBuxINuZyBi4bqlbSBzaGFyZQogICAgICAgICAgICAgICAgaWYgcmFuZG9tLnJhbmRvbSgpIDwgMC4wNTogICMgNSUgY2hhbmNlCiAgICAgICAgICAgICAgICAgICAgc2hhcmVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0iQ2hpYSBz4bq7IikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2hhcmVfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzaGFyZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJTaGFyZSIpCiAgICAgICAgICAgICAgICAgICAgaWYgc2hhcmVfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJSYW5kb20gY2xpY2sgc2hhcmUgdHJvbmcga2hpIG1pbmkgY2FyZSIpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzaGFyZV9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAjIE5o4bqlbiBiYWNrIMSR4buDIMSRw7NuZyBkaWFsb2cgc2hhcmUKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbMaw4bubdCB7dmlkZW9fY291bnR9IHZpZGVvIHRyb25nIHtzY3JvbGxfZHVyYXRpb259IGdpw6J5IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgMy4gTmfhuqt1IG5oacOqbiBi4bqlbSB2w6BvIEjhu5lwIHRoxrAgKDUwJSBraOG6oyBuxINuZykKICAgICAgICAgICAgaWYgcmFuZG9tLnJhbmRvbSgpIDwgMC41OiAgIyA1MCUgY2hhbmNlCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJSYW5kb20gdHJ1eSBj4bqtcCBI4buZcCB0aMawLi4uIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBUw6xtIHbDoCBjbGljayB2w6BvIEjhu5lwIHRoxrAKICAgICAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9Ikjhu5lwIHRoxrAiKQogICAgICAgICAgICAgICAgaWYgaW5ib3hfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlTDrG0gdGjhuqV5IEjhu5lwIHRoxrAsIMSRYW5nIGNsaWNrIHbDoG8uLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihpbmJveF9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBE4burbmcgbOG6oWkgMi01IGdpw6J5CiAgICAgICAgICAgICAgICAgICAgd2FpdF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMiwgNSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiROG7q25nIGzhuqFpIHt3YWl0X3RpbWV9IGdpw6J5IHRyb25nIEjhu5lwIHRoxrAuLi4iKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YWl0X3RpbWUpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiB0cm9uZyBI4buZcCB0aMawCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVnXhu5F0IGzDqm4gdHJvbmcgSOG7mXAgdGjGsC4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUXVheSBs4bqhaSB0cmFuZyBjaOG7pwogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlF1YXkgbOG6oWkgdHJhbmcgY2jhu6cgdOG7qyBI4buZcCB0aMawLi4uIikKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5iYWNrX3RvX2hvbWUoKToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIHF1YXkgduG7gSB0cmFuZyBjaOG7pyB04burIEjhu5lwIHRoxrAiKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBI4buZcCB0aMawIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlNraXAgdHJ1eSBj4bqtcCBI4buZcCB0aMawIGzhuqduIG7DoHkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6o20gYuG6o28gduG7gSB0cmFuZyBjaOG7pyBjdeG7kWkgY8O5bmcKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdGjhu4MgxJHhuqNtIGLhuqNvIHbhu4EgdHJhbmcgY2jhu6cgc2F1IG1pbmkgY2FyZSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkhvw6BuIHRow6BuaCBtaW5pIGNhcmUgY2hvIHTDoGkga2hv4bqjbiBUaWtUb2s6IHthY2NvdW50Wyd1bmlxdWVfdXNlcm5hbWUnXX0iKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIG1pbmkgY2FyZSBjaG8gdMOgaSBraG/huqNuIFRpa1Rvazoge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEPhu5EgZ+G6r25nIHbhu4EgdHJhbmcgY2jhu6cgbuG6v3UgY8OzIGzhu5dpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgX2Vuc3VyZV9mb3JfeW91X3RhYihzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdGFiIMSR4buBIHh14bqldCAoRm9yIFlvdSkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFTDrG0gdGFiICJEw6BuaCBjaG8gYuG6oW4iIGhv4bq3YyAiRm9yIFlvdSIKICAgICAgICAgICAgZm9yX3lvdV90ZXh0cyA9IFsiRMOgbmggY2hvIGLhuqFuIiwgIkZvciBZb3UiLCAixJDhu4EgeHXhuqV0Il0KICAgICAgICAgICAgZm9yX3lvdV90YWIgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgdGV4dCBpbiBmb3JfeW91X3RleHRzOgogICAgICAgICAgICAgICAgZm9yX3lvdV90YWIgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD10ZXh0KQogICAgICAgICAgICAgICAgaWYgZm9yX3lvdV90YWI6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBmb3JfeW91X3RhYjoKICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSB0aGVvIGNvbnRlbnQtZGVzYwogICAgICAgICAgICAgICAgZm9yIGRlc2MgaW4gZm9yX3lvdV90ZXh0czoKICAgICAgICAgICAgICAgICAgICBmb3JfeW91X3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9ZGVzYykKICAgICAgICAgICAgICAgICAgICBpZiBmb3JfeW91X3RhYjoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGZvcl95b3VfdGFiOgogICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0YWIgY8OzIMSRxrDhu6NjIGNo4buNbiBraMO0bmcKICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGZvcl95b3VfdGFiKToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUYWIgxJHhu4EgeHXhuqV0IGNoxrBhIMSRxrDhu6NjIGNo4buNbiwgxJFhbmcgY2xpY2sgdsOgby4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGZvcl95b3VfdGFiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCLEkMOjIHjDoWMgbmjhuq1uIHRhYiDEkeG7gSB4deG6pXQiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSB0YWIgxJHhu4EgeHXhuqV0IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSB4w6FjIG5o4bqtbiB0YWIgxJHhu4EgeHXhuqV0IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfc2Nyb2xsX2Zvcl95b3VfZmVlZChzZWxmLCBkdXJhdGlvbl9zZWNvbmRzOiBpbnQpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMaw4bubdCBmZWVkIMSR4buBIHh14bqldCB0cm9uZyBraG/huqNuZyB0aOG7nWkgZ2lhbiBuaOG6pXQgxJHhu4tuaAogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGR1cmF0aW9uX3NlY29uZHM6IFRo4budaSBnaWFuIGzGsOG7m3QgKGdpw6J5KQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAgICAgc2Nyb2xsX2NvdW50ID0gMAogICAgICAgICAgICAKICAgICAgICAgICAgd2hpbGUgdGltZS50aW1lKCkgLSBzdGFydF90aW1lIDwgZHVyYXRpb25fc2Vjb25kczoKICAgICAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gxJHhu4MgY2h1eeG7g24gdmlkZW8gdGnhur9wIHRoZW8KICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNjcm9sbF9jb3VudCArPSAxCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmdo4buJIG5n4bqrdSBuaGnDqm4gMi02IGdpw6J5IG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjhuq10IHhlbSB2aWRlbwogICAgICAgICAgICAgICAgd2F0Y2hfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDYpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2F0Y2hfdGltZSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBSYW5kb20gdGjhu4luaCB0aG/huqNuZyBk4burbmcgbMOidSBoxqFuIChuaMawIMSRYW5nIHhlbSB2aWRlbyB0aMO6IHbhu4spCiAgICAgICAgICAgICAgICBpZiByYW5kb20ucmFuZGludCgxLCAxMCkgPT0gMTogICMgMTAlIHjDoWMgc3XhuqV0CiAgICAgICAgICAgICAgICAgICAgbG9uZ193YXRjaF90aW1lID0gcmFuZG9tLnJhbmRpbnQoOCwgMTUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIkThu6tuZyB4ZW0gdmlkZW8gbMOidSBoxqFuOiB7bG9uZ193YXRjaF90aW1lfXMiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChsb25nX3dhdGNoX3RpbWUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTG9nIHRp4bq/biB0csOsbmggbeG7l2kgMzAgZ2nDonkKICAgICAgICAgICAgICAgIGVsYXBzZWQgPSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUKICAgICAgICAgICAgICAgIGlmIGVsYXBzZWQgPiAwIGFuZCBpbnQoZWxhcHNlZCkgJSAzMCA9PSAwIGFuZCBzY3JvbGxfY291bnQgPiAwOgogICAgICAgICAgICAgICAgICAgIHJlbWFpbmluZyA9IGR1cmF0aW9uX3NlY29uZHMgLSBlbGFwc2VkCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbMaw4bubdCB7c2Nyb2xsX2NvdW50fSB2aWRlbywgY8OybiBs4bqhaSB7aW50KHJlbWFpbmluZyl9cyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiSG/DoG4gdGjDoG5oIGzGsOG7m3QgxJHhu4EgeHXhuqV0OiB7c2Nyb2xsX2NvdW50fSB2aWRlbyB0cm9uZyB7ZHVyYXRpb25fc2Vjb25kc31zIikKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBsxrDhu5t0IGZlZWQgxJHhu4EgeHXhuqV0IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfaW50ZXJhY3Rfd2l0aF9pbmJveChzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFTGsMahbmcgdMOhYyB24bubaSBI4buZcCB0aMawOiBi4bqlbSB2w6BvLCBk4burbmcgMi01cywgdnXhu5F0IGzDqm4KICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFTDrG0gbsO6dCBI4buZcCB0aMawCiAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9Ikjhu5lwIHRoxrAiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGluYm94X2J1dHRvbjoKICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSB0aGVvIHRleHQKICAgICAgICAgICAgICAgIGluYm94X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJI4buZcCB0aMawIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBpbmJveF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBI4buZcCB0aMawIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDbGljayB2w6BvIEjhu5lwIHRoxrAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJBhbmcgY2xpY2sgdsOgbyBI4buZcCB0aMawIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGluYm94X2J1dHRvbikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgROG7q25nIGzhuqFpIDItNSBnacOieQogICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCgyLCA1KQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiROG7q25nIHRyb25nIEjhu5lwIHRoxrAge3dhaXRfdGltZX1zIikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfdGltZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gdHJvbmcgSOG7mXAgdGjGsAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJWdeG7kXQgbMOqbiB0cm9uZyBI4buZcCB0aMawIikKICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gdGhhbyB0w6FjIHZ14buRdCBsw6puIHRow6ptIDEtMiBs4bqnbiBu4buvYQogICAgICAgICAgICBhZGRpdGlvbmFsX3N3aXBlcyA9IHJhbmRvbS5yYW5kaW50KDEsIDIpCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKGFkZGl0aW9uYWxfc3dpcGVzKToKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcChyYW5kb20udW5pZm9ybSgwLjUsIDEuNSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJIb8OgbiB0aMOgbmggdMawxqFuZyB0w6FjIHbhu5tpIEjhu5lwIHRoxrAiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIHTGsMahbmcgdMOhYyB24bubaSBI4buZcCB0aMawIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIGdldF9hdmFpbGFibGVfam9icyhzZWxmLCBhY2NvdW50OiBEaWN0W3N0ciwgQW55XSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgTOG6pXkgZGFuaCBzw6FjaCBjw6FjIGpvYiBraOG6oyBk4bulbmcgdOG7qyBHb0xpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCBqb2IgaG/hurdjIGxpc3QgcuG7l25nIG7hur91IGtow7RuZyBjw7MKICAgICAgICAiIiIKICAgICAgICBpZiBub3Qgc2VsZi5nb2xpa2Vfc2VydmljZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0aOG7gyBs4bqleSBqb2I6IEdvTGlrZVNlcnZpY2UgY2jGsGEgxJHGsOG7o2MgY3VuZyBj4bqlcCIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgR+G7jWkgQVBJIGzhuqV5IGpvYgogICAgICAgICAgICBqb2JfdXJsID0gc2VsZi5nZXRfam9ic191cmwoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyB0aGFtIHPhu5EKICAgICAgICAgICAgcGFyYW1zID0gc2VsZi5nZXRfam9iX3BhcmFtcyhhY2NvdW50KQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkKICAgICAgICAgICAgcmVzcG9uc2UgPSBzZWxmLmFwaV9yZXF1ZXN0KGpvYl91cmwsICJHRVQiLCBwYXJhbXMpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXNwb25zZSBhbmQgcmVzcG9uc2UuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpOgogICAgICAgICAgICAgICAgam9iX2RhdGEgPSByZXNwb25zZS5nZXQoImRhdGEiLCBOb25lKQogICAgICAgICAgICAgICAgaWYgam9iX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3Ugam9iCiAgICAgICAgICAgICAgICAgICAgam9iID0gc2VsZi5tYXBfam9iX2RhdGEoam9iX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSB0aOG6pXkgam9iIHtqb2JbJ2lkJ119IGxv4bqhaSB7am9iWyd0eXBlJ119IGNobyB0w6BpIGtob+G6o24ge2FjY291bnRbJ3VuaXF1ZV91c2VybmFtZSddfSIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFtqb2JdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBs4bqleSBkYW5oIHPDoWNoIGpvYiIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgZXhlY3V0ZV9qb2Ioc2VsZiwgYWNjb3VudDogRGljdFtzdHIsIEFueV0sIGpvYjogRGljdFtzdHIsIEFueV0pIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gam9iCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgam9iOiBUaMO0bmcgdGluIGpvYgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogS+G6v3QgcXXhuqMgdGjhu7FjIGhp4buHbiBqb2IsIGJhbyBn4buTbToKICAgICAgICAgICAgICAgIC0gc3RhdHVzIChpbnQpOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IKICAgICAgICAgICAgICAgICAgICAwOiBDaMawYSB0aOG7sWMgaGnhu4duCiAgICAgICAgICAgICAgICAgICAgMTogVGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAgICAgMjogVGjhuqV0IGLhuqFpLCBraMO0bmcgdMOsbSB0aOG6pXkgxJHhu5FpIHTGsOG7o25nCiAgICAgICAgICAgICAgICAgICAgMzogVGjhuqV0IGLhuqFpLCDEkcOjIGLhu4sgdW5mb2xsb3cvdW5saWtlCiAgICAgICAgICAgICAgICAgICAgNDogVGjhuqV0IGLhuqFpLCB5w6p1IGPhuqd1IMSRYW5nIGNo4budCiAgICAgICAgICAgICAgICAtIG1lc3NhZ2UgKHN0cik6IFRow7RuZyBiw6FvIGvhur90IHF14bqjCiAgICAgICAgICAgICAgICAtIHN1Y2Nlc3MgKGJvb2wpOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBqb2JfdHlwZSA9IGpvYi5nZXQoInR5cGUiLCAiIikubG93ZXIoKQogICAgICAgICAgICBqb2JfbGluayA9IGpvYi5nZXQoImxpbmsiLCAiIikKICAgICAgICAgICAgam9iX2lkID0gam9iLmdldCgiaWQiKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIHRo4buxYyBoaeG7h24gam9iIHtqb2JfaWR9IGxv4bqhaSB7am9iX3R5cGV9IHbhu5tpIGxpbmsge2pvYl9saW5rfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbG/huqFpIGpvYiDEkcaw4bujYyBo4buXIHRy4bujCiAgICAgICAgICAgIGlmIGpvYl90eXBlIG5vdCBpbiBbImZvbGxvdyIsICJsaWtlIl06CiAgICAgICAgICAgICAgICBtZXNzYWdlID0gZiJMb+G6oWkgam9iIHtqb2JfdHlwZX0ga2jDtG5nIMSRxrDhu6NjIGjhu5cgdHLhu6MiCiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAyLAogICAgICAgICAgICAgICAgICAgICJtZXNzYWdlIjogbWVzc2FnZSwKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gam9iIHRoZW8gbG/huqFpCiAgICAgICAgICAgIGpvYl9zdGF0dXMgPSAwICAjIE3hurdjIMSR4buLbmggbMOgIGNoxrBhIGzDoG0KICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGpvYl90eXBlID09ICJmb2xsb3ciOgogICAgICAgICAgICAgICAgam9iX3N0YXR1cyA9IHNlbGYuX3BlcmZvcm1fZm9sbG93X2pvYihqb2JfbGluaykKICAgICAgICAgICAgZWxpZiBqb2JfdHlwZSA9PSAibGlrZSI6CiAgICAgICAgICAgICAgICBqb2Jfc3RhdHVzID0gc2VsZi5fcGVyZm9ybV9saWtlX2pvYihqb2JfbGluaykKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVuG7gSB0cmFuZyBjaOG7pyB2w6AgdnXhu5F0IGLhuqNuZyB0aW4gbuG6v3Ugam9iIHRow6BuaCBjw7RuZwogICAgICAgICAgICBpZiBzZWxmLmJhY2tfdG9faG9tZSgpOgogICAgICAgICAgICAgICAgaWYgam9iX3N0YXR1cyA9PSAxOiAgIyBDaOG7iSB2deG7kXQga2hpIGpvYiB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zY3JvbGxfZmVlZF9hZnRlcl9qb2IoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBr4bq/dCBxdeG6oyB0cuG6oyB24buBIGThu7FhIHRyw6puIGpvYl9zdGF0dXMKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0X2Zyb21fc3RhdHVzKGpvYl9zdGF0dXMsIGpvYl90eXBlKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBtZXNzYWdlID0gZiJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBqb2I6IHtzdHIoZSl9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgbWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDIsIG1lc3NhZ2UsIEZhbHNlKQogICAgCiAgICBkZWYgX2NyZWF0ZV9qb2JfcmVzdWx0X2Zyb21fc3RhdHVzKHNlbGYsIGpvYl9zdGF0dXM6IGludCwgam9iX3R5cGU6IHN0cikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIiCiAgICAgICAgVOG6oW8ga+G6v3QgcXXhuqMgam9iIHThu6sgc3RhdHVzIGNvZGUKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2Jfc3RhdHVzOiBNw6MgdHLhuqFuZyB0aMOhaSBqb2IgdOG7qyBfcGVyZm9ybV94eHhfam9iCiAgICAgICAgICAgIGpvYl90eXBlOiBMb+G6oWkgam9iIChmb2xsb3csIGxpa2UpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3Rbc3RyLCBBbnldOiBL4bq/dCBxdeG6oyBqb2IKICAgICAgICAiIiIKICAgICAgICBpZiBqb2Jfc3RhdHVzID09IDE6ICAjIFRow6BuaCBjw7RuZwogICAgICAgICAgICBtZXNzYWdlID0gZiLEkMOjIGhvw6BuIHRow6BuaCBqb2Ige2pvYl90eXBlfSB0aMOgbmggY8O0bmciCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8obWVzc2FnZSkKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NyZWF0ZV9qb2JfcmVzdWx0KDEsIG1lc3NhZ2UsIFRydWUpCiAgICAgICAgZWxpZiBqb2Jfc3RhdHVzID09IDI6ICAjIEtow7RuZyB0w6xtIHRo4bqleSDEkeG7kWkgdMaw4bujbmcKICAgICAgICAgICAgbWVzc2FnZSA9IGYiS2jDtG5nIHRo4buDIHTDrG0gdGjhuqV5IMSR4buRaSB0xrDhu6NuZyDEkeG7gyB0aOG7sWMgaGnhu4duIGpvYiB7am9iX3R5cGV9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKG1lc3NhZ2UpCiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jcmVhdGVfam9iX3Jlc3VsdCgyLCBtZXNzYWdlLCBGYWxzZSkKICAgICAgICBlbGlmIGpvYl9zdGF0dXMgPT0gMzogICMgQuG7iyB1bmZvbGxvdy91bmxpa2UKICAgICAgICAgICAgbWVzc2FnZSA9IGYixJDhu5FpIHTGsOG7o25nIMSRw6MgYuG7iyB1bmZvbGxvdy91bmxpa2UiCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcobWVzc2FnZSkKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgdW5mb2xsb3cgxJHhu4MgSm9iU2VydmljZSB44butIGzDvQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoMywgbWVzc2FnZSwgRmFsc2UsIHVuZm9sbG93PVRydWUpCiAgICAgICAgZWxpZiBqb2Jfc3RhdHVzID09IDQ6ICAjIFnDqnUgY+G6p3UgxJFhbmcgY2jhu50KICAgICAgICAgICAgbWVzc2FnZSA9IGYiWcOqdSBj4bqndSDEkWFuZyBjaOG7nSB0cm9uZyBqb2Ige2pvYl90eXBlfSIKICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZyhtZXNzYWdlKQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoNCwgbWVzc2FnZSwgRmFsc2UpCiAgICAgICAgZWxzZTogICMgVGjhuqV0IGLhuqFpIGhv4bq3YyB0cuG6oW5nIHRow6FpIGtow6FjCiAgICAgICAgICAgIG1lc3NhZ2UgPSBmIlRo4buxYyBoaeG7h24gam9iIHtqb2JfdHlwZX0gdGjhuqV0IGLhuqFpIHbhu5tpIHRy4bqhbmcgdGjDoWkge2pvYl9zdGF0dXN9IgogICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihtZXNzYWdlKQogICAgICAgICAgICByZXR1cm4gc2VsZi5fY3JlYXRlX2pvYl9yZXN1bHQoam9iX3N0YXR1cyBpZiBqb2Jfc3RhdHVzID4gMCBlbHNlIDAsIG1lc3NhZ2UsIEZhbHNlKQogICAgICAgICAgICAKICAgIGRlZiBfY2hlY2tfYWNjb3VudF9zdGF0dXNfZGlhbG9nKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgS2nhu4NtIHRyYSBkaWFsb2cgIlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIiB2w6AgeOG7rSBsw70gbuG6v3UgY8OzCiAgICAgICAgU2F1IGtoaSBi4bqlbSBPSywga2nhu4NtIHRyYSB4ZW0gY8OzIHbhu4EgdHJhbmcgY2jhu6cga2jDtG5nIHbDoCBzeW5jIGFjY291bnRzCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSBjw7MgZGlhbG9nIHbDoCBj4bqnbiBuZ+G7q25nIGhv4bqhdCDEkeG7mW5nIHTDoGkga2hv4bqjbiwgRmFsc2UgbuG6v3Uga2jDtG5nIGPDsyBkaWFsb2cKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ2jhu50gbeG7mXQgY2jDunQgxJHhu4MgZGlhbG9nIGPDsyB0aOG7gyB4deG6pXQgaGnhu4duCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIGRpYWxvZyBjw7MgdGV4dCAiVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iCiAgICAgICAgICAgIHN0YXR1c19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3RhdHVzX2RpYWxvZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIlBow6F0IGhp4buHbiBkaWFsb2cgJ1Ry4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuJyIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVMOsbSBlbGVtZW50IGPDsyByZXNvdXJjZS1pZD0iYW5kcm9pZDppZC9tZXNzYWdlIgogICAgICAgICAgICAgICAgbWVzc2FnZV9lbGVtZW50ID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHJlc291cmNlX2lkPSJhbmRyb2lkOmlkL21lc3NhZ2UiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBtZXNzYWdlX2VsZW1lbnQ6CiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZV90ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dChtZXNzYWdlX2VsZW1lbnQpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJUaMO0bmcgYsOhbyB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbjoge21lc3NhZ2VfdGV4dH0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTMawdSB0aMO0bmcgYsOhbyB2w6BvIGRhdGFiYXNlIGhv4bq3YyBsb2cKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIkNSSVRJQ0FMOiBUw6BpIGtob+G6o24gYuG7iyBo4bqhbiBjaOG6vyAtIHttZXNzYWdlX3RleHR9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIFTDrG0gdsOgIGNsaWNrIG7DunQgT0svxJDDs25nIMSR4buDIMSRw7NuZyBkaWFsb2cKICAgICAgICAgICAgICAgICAgICBva19jbGlja2VkID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBva19idXR0b25zID0gWyJPSyIsICLEkMOzbmciLCAiVMO0aSBoaeG7g3UiLCAixJDhu5NuZyDDvSJdCiAgICAgICAgICAgICAgICAgICAgZm9yIGJ0bl90ZXh0IGluIG9rX2J1dHRvbnM6CiAgICAgICAgICAgICAgICAgICAgICAgIG9rX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PWJ0bl90ZXh0KQogICAgICAgICAgICAgICAgICAgICAgICBpZiBva19idXR0b246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIob2tfYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgYuG6pW0gbsO6dCAne2J0bl90ZXh0fScgxJHhu4MgxJHDs25nIGRpYWxvZyIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBva19jbGlja2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBpZiBva19jbGlja2VkOgogICAgICAgICAgICAgICAgICAgICAgICAjIENo4budIDUgZ2nDonkgdsOgIGtp4buDbSB0cmEgdHJhbmcgY2jhu6cgdHJvbmcgNSBs4bqnbgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJDaOG7nSA1cyB2w6Aga2nhu4NtIHRyYSB0cmFuZyBjaOG7pyB0cm9uZyA1IGzhuqduLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDUpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICBob21lX3NjcmVlbl9kZXRlY3RlZCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBhdHRlbXB0IGluIHJhbmdlKDUpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIktp4buDbSB0cmEgdHJhbmcgY2jhu6cgbOG6p24ge2F0dGVtcHQgKyAxfS81IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gxJHDoyB24buBIHRyYW5nIGNo4bunIC0gY8OzIGto4bqjIG7Eg25nIHTDoGkga2hv4bqjbiBi4buLIGxvZ291dCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaG9tZV9zY3JlZW5fZGV0ZWN0ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaG9tZV9zY3JlZW5fZGV0ZWN0ZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIFRo4buxYyBoaeG7h24gc3luYyBhY2NvdW50cyDEkeG7gyBraeG7g20gdHJhIGFjY291bnQgY8OzIGPDsm4gdHJvbmcgZGFuaCBzw6FjaCBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlRo4buxYyBoaeG7h24gc3luYyBhY2NvdW50cyDEkeG7gyBraeG7g20gdHJhIHRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIGhp4buHbiB04bqhaSB04burIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfZGV2aWNlX2FjY291bnRzID0gc2VsZi5nZXRfYWNjb3VudHNfZnJvbV9kZXZpY2UoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfdXNlcm5hbWVzID0ge2FjYy5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKS5sb3dlcigpIGZvciBhY2MgaW4gY3VycmVudF9kZXZpY2VfYWNjb3VudHN9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiBUaWtUb2sgdOG7qyBEQgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRiX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPXNlbGYuYXBwX25hbWUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGPDoWMgdMOgaSBraG/huqNuIHRyb25nIERCIGPDsyBjw7JuIHThu5NuIHThuqFpIHRyw6puIHRoaeG6v3QgYuG7iyBraMO0bmcKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgZGJfYWNjb3VudCBpbiBkYl9hY2NvdW50czoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGJfdXNlcm5hbWUgPSBkYl9hY2NvdW50LmdldCgidW5pcXVlX3VzZXJuYW1lIiwgIiIpLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgZGJfdXNlcm5hbWUgYW5kIGRiX3VzZXJuYW1lIG5vdCBpbiBjdXJyZW50X3VzZXJuYW1lczoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIHThu5NuIHThuqFpIHRyw6puIHRoaeG6v3QgYuG7iyAtIMSRw6FuaCBk4bqldSBuZ+G7q25nIGhv4bqhdCDEkeG7mW5nCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKGYiVMOgaSBraG/huqNuIHtkYl9hY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IGtow7RuZyBjw7JuIHRyb25nIGRhbmggc8OhY2ggdGhp4bq/dCBi4buLIC0gxJHDoW5oIGThuqV1IG5n4burbmcgaG/huqF0IMSR4buZbmciKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImluYWN0aXZlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiam9iX2VuYWJsZSI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJyZWFzb24iOiAiVMOgaSBraG/huqNuIGLhu4sgbG9nIG91dCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGRiX2FjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IHTDoGkga2hv4bqjbiB7ZGJfYWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScpfSBuZ+G7q25nIGhv4bqhdCDEkeG7mW5nIHbhu5tpIGzDvSBkbzogVMOgaSBraG/huqNuIGLhu4sgbG9nIG91dCIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIyBTeW5jIGzhuqFpIGFjY291bnRzIG3hu5tpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zeW5jX2FjY291bnRzX3RvX2RiKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgc3luY19lcnJvcjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oc3luY19lcnJvciwgIkzhu5dpIGtoaSBzeW5jIGFjY291bnRzIHNhdSBraGkgcGjDoXQgaGnhu4duIGRpYWxvZyB0cuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiVMOsbSB0aOG6pXkgZGlhbG9nICdUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbicgbmjGsG5nIGtow7RuZyB0w6xtIHRo4bqleSBtZXNzYWdlIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkga2nhu4NtIHRyYSBkaWFsb2cgdHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX3BlcmZvcm1fZm9sbG93X2pvYihzZWxmLCBwcm9maWxlX2xpbms6IHN0cikgLT4gaW50OgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gam9iIGZvbGxvdyB0csOqbiBUaWtUb2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwcm9maWxlX2xpbms6IExpbmsgxJHhur9uIHRyYW5nIGPDoSBuaMOibiBj4bqnbiBmb2xsb3cgKGThuqFuZzogaHR0cHM6Ly93d3cudGlrdG9rLmNvbS9AdXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGludDogVHLhuqFuZyB0aMOhaSBqb2IgKDA6IGNoxrBhIGzDoG0sIDE6IGhvw6BuIHRow6BuaCwgMjogbOG7l2ksIDM6IGLhu4sgdW5mb2xsb3csIDQ6IHnDqnUgY+G6p3UgY2jhu50sIDU6IGfhu61pIHnDqnUgY+G6p3UpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVHLDrWNoIHh14bqldCB1c2VybmFtZSB04burIFVSTCBUaWtUb2sgxJHhu4Mgc+G7rSBk4bulbmcgY2hvIGxvZ2dpbmcKICAgICAgICAgICAgdXNlcm5hbWVfbWF0Y2ggPSByZS5zZWFyY2gocid0aWt0b2tcLmNvbS9AKFteLz9dKyknLCBwcm9maWxlX2xpbmspCiAgICAgICAgICAgIGlmIG5vdCB1c2VybmFtZV9tYXRjaDoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIHRyw61jaCB4deG6pXQgdXNlcm5hbWUgdOG7qyBsaW5rOiB7cHJvZmlsZV9saW5rfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHVzZXJuYW1lID0gdXNlcm5hbWVfbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyB0cmFuZyBjw6EgbmjDom4KICAgICAgICAgICAgaWYgbm90IHNlbGYuX29wZW5fcHJvZmlsZV9wYWdlKHByb2ZpbGVfbGluayk6CiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7nSB0aMOqbSBjaG8gdHJhbmcgaOG7kyBzxqEgdOG6o2kgeG9uZwogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBuw7p0IEZvbGxvdyB0aGVvIGPDoWMgY8OhY2gga2jDoWMgbmhhdQogICAgICAgICAgICBmb2xsb3dfYnV0dG9uID0gTm9uZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDw6FjaCAxOiBUw6xtIHRoZW8gdGV4dCB0aeG6v25nIFZp4buHdCB2w6AgdGnhur9uZyBBbmgKICAgICAgICAgICAgZm9sbG93X3RleHRzID0gWyJUaGVvIGTDtWkiLCAiRm9sbG93IiwgIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciLCAixJDDoyB5w6p1IGPhuqd1IiwgIlJlcXVlc3RlZCJdCiAgICAgICAgICAgIGZvciB0ZXh0IGluIGZvbGxvd190ZXh0czoKICAgICAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD10ZXh0KQogICAgICAgICAgICAgICAgaWYgZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAKICAgICAgICAgICAgIyBDw6FjaCAyOiBUw6xtIHRoZW8gY29udGVudC1kZXNjCiAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgZm9sbG93X2Rlc2NzID0gWyJUaGVvIGTDtWkiLCAiRm9sbG93IiwgIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciXQogICAgICAgICAgICAgICAgZm9yIGRlc2MgaW4gZm9sbG93X2Rlc2NzOgogICAgICAgICAgICAgICAgICAgIGZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPWRlc2MpCiAgICAgICAgICAgICAgICAgICAgaWYgZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjhu60gbOG6oWkgbOG6p24gbuG7r2EgbuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgZm9sbG93CiAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IG7DunQgdGhlbyBkw7VpIOG7nyBs4bqnbiDEkeG6p3UsIHRo4butIHZ14buRdCBtw6BuIGjDrG5oIHbDoCB0w6xtIGzhuqFpIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxLjUpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjhu60gbOG6oWkgdOG6pXQgY+G6oyBjw6FjIGPDoWNoCiAgICAgICAgICAgICAgICBmb3IgdGV4dCBpbiBmb2xsb3dfdGV4dHM6CiAgICAgICAgICAgICAgICAgICAgZm9sbG93X2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PXRleHQpCiAgICAgICAgICAgICAgICAgICAgaWYgZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBmb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IHRoZW8gZMO1aSBzYXUgbmhp4buBdSBs4bqnbiB0aOG7rSIpCiAgICAgICAgICAgICAgICByZXR1cm4gMgogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0ZXh0IGPhu6dhIG7DunQKICAgICAgICAgICAgYnV0dG9uX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KGZvbGxvd19idXR0b24pCiAgICAgICAgICAgIGJ1dHRvbl9yZXNvdXJjZV9pZCA9IGZvbGxvd19idXR0b24uZ2V0KCJyZXNvdXJjZS1pZCIsICIiKQogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiVGV4dCBj4bunYSBuw7p0IGZvbGxvdzogJ3tidXR0b25fdGV4dH0nLCByZXNvdXJjZS1pZDogJ3tidXR0b25fcmVzb3VyY2VfaWR9JyIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdHLhuqFuZyB0aMOhaSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyLEkGFuZyB0aGVvIGTDtWkiLCAiRm9sbG93aW5nIl06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0aGVvIGTDtWkgdMOgaSBraG/huqNuIHt1c2VybmFtZX0gdOG7qyB0csaw4bubYyIpCiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIl06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB5w6p1IGPhuqd1IHRoZW8gZMO1aSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB04burIHRyxrDhu5tjIikKICAgICAgICAgICAgICAgIHJldHVybiA1CiAgICAgICAgICAgIAogICAgICAgICAgICAjIE7hur91IGzDoCAiVGhlbyBkw7VpIiBob+G6t2MgIkZvbGxvdyIgdGjDrCBjbGljayB2w6BvIG7DunQKICAgICAgICAgICAgaWYgYnV0dG9uX3RleHQgaW4gWyJUaGVvIGTDtWkiLCAiRm9sbG93Il06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUaOG7sWMgaGnhu4duIGNsaWNrIHbDoG8gbsO6dCB0aGVvIGTDtWkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzhuqV5IHJlc291cmNlX2lkIGPhu6dhIGJ1dHRvbiDEkeG7gyBraeG7g20gdHJhIGzhuqFpIHNhdQogICAgICAgICAgICAgICAgYnV0dG9uX3Jlc291cmNlX2lkID0gZm9sbG93X2J1dHRvbi5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihmb2xsb3dfYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDQpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgIlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIgogICAgICAgICAgICAgICAgaWYgc2VsZi5fY2hlY2tfYWNjb3VudF9zdGF0dXNfZGlhbG9nKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIlTDoGkga2hv4bqjbiBi4buLIGjhuqFuIGNo4bq/LCBuZ+G7q25nIGhv4bqhdCDEkeG7mW5nIHbDoCBo4buneSBqb2IiKQogICAgICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBuZ+G7q25nIGhv4bqhdCDEkeG7mW5nCiAgICAgICAgICAgICAgICAgICAgIyBUcuG6oyB24buBIHN0YXR1cyAyIMSR4buDIGLDoW8gbOG7l2kgdsOgIGjhu6d5IGpvYgogICAgICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVnXhu5F0IHh14buRbmcgMSBs4bqnbiDEkeG7gyByZWZyZXNoIHRy4bqhbmcgdGjDoWkKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX2Rvd24oKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIGPDsyBkaWFsb2cgaGnhu4duIGzDqm4ga2jDtG5nCiAgICAgICAgICAgICAgICAjIHNjcmVlbl94bWwgPSBzZWxmLmR1bXBfc2NyZWVuX3dpdGhfcmV0cnkoKQogICAgICAgICAgICAgICAgIyBpZiBzY3JlZW5feG1sOgogICAgICAgICAgICAgICAgIyAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyBj4bqjbmggYsOhbyBob+G6t2MgZ2nhu5tpIGjhuqFuCiAgICAgICAgICAgICAgICAjICAgICBkaWFsb2dzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKHNjcmVlbl94bWwsIGNsYXNzX25hbWU9ImFuZHJvaWQuYXBwLkRpYWxvZyIpCiAgICAgICAgICAgICAgICAjICAgICBmb3IgZGlhbG9nIGluIGRpYWxvZ3M6CiAgICAgICAgICAgICAgICAjICAgICAgICAgZGlhbG9nX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KGRpYWxvZykKICAgICAgICAgICAgICAgICMgICAgICAgICBpZiBhbnkoa2V5d29yZCBpbiBkaWFsb2dfdGV4dC5sb3dlcigpIGZvciBrZXl3b3JkIGluIFsidGjhu60gbOG6oWkgc2F1IiwgImdp4bubaSBo4bqhbiIsICJsaW1pdCIsICJ0cnkgYWdhaW4iXSk6CiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgICMgVMOsbSB2w6AgbmjhuqVuIG7DunQgT0svxJDDs25nCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIG9rX2J1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoc2NyZWVuX3htbCwgY2xhc3NfbmFtZT0iYW5kcm9pZC53aWRnZXQuQnV0dG9uIikKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgZm9yIGJ0biBpbiBva19idXR0b25zOgogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgYnRuX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KGJ0bikKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgICAgIGlmIGJ0bl90ZXh0IGFuZCBidG5fdGV4dC5sb3dlcigpIGluIFsib2siLCAixJHDs25nIiwgInTDtGkgaGnhu4N1IiwgIsSR4buTbmcgw70iXToKICAgICAgICAgICAgICAgICMgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnRuKQogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAjICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIkpvYiBraMO0bmcgaG/DoG4gdGjDoG5oLCBi4buLIGdp4bubaSBo4bqhbiB0aGVvIGTDtWkiKQogICAgICAgICAgICAgICAgIyAgICAgICAgICAgICByZXR1cm4gMwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgdGV4dCBzYXUga2hpIG5o4bqlbiB0aGVvIGTDtWkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gbOG6oWkgbsO6dCBmb2xsb3cgxJHhu4Mga2nhu4NtIHRyYSB0cuG6oW5nIHRow6FpIC0gxrB1IHRpw6puIHRoZW8gcmVzb3VyY2UtaWQgbuG6v3UgY8OzCiAgICAgICAgICAgICAgICB1cGRhdGVkX2ZvbGxvd19idXR0b24gPSBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTuG6v3UgY8OzIHJlc291cmNlX2lkLCB0w6xtIHRoZW8gcmVzb3VyY2VfaWQgdHLGsOG7m2MKICAgICAgICAgICAgICAgIGlmIGJ1dHRvbl9yZXNvdXJjZV9pZDoKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2ZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQocmVzb3VyY2VfaWQ9YnV0dG9uX3Jlc291cmNlX2lkKQogICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgdMOsbSBs4bqhaSBuw7p0IGZvbGxvdyB0aGVvIHJlc291cmNlLWlkOiB7YnV0dG9uX3Jlc291cmNlX2lkfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIHTDrG0gdGjhuqV5IHRoZW8gcmVzb3VyY2VfaWQgaG/hurdjIGtow7RuZyBjw7MgcmVzb3VyY2VfaWQsIHTDrG0gdGhlbyB0ZXh0CiAgICAgICAgICAgICAgICBpZiBub3QgdXBkYXRlZF9mb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgIGZvbGxvd190ZXh0cyA9IFsixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyIsICLEkMOjIHnDqnUgY+G6p3UiLCAiUmVxdWVzdGVkIiwgIlRoZW8gZMO1aSIsICJGb2xsb3ciXQogICAgICAgICAgICAgICAgICAgIGZvciB0ZXh0IGluIGZvbGxvd190ZXh0czoKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9mb2xsb3dfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9dGV4dCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdXBkYXRlZF9mb2xsb3dfYnV0dG9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogdMOsbSB0aGVvIGNvbnRlbnQtZGVzYwogICAgICAgICAgICAgICAgaWYgbm90IHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBmb2xsb3dfZGVzY3MgPSBbIlRoZW8gZMO1aSIsICJGb2xsb3ciLCAixJBhbmcgdGhlbyBkw7VpIiwgIkZvbGxvd2luZyJdCiAgICAgICAgICAgICAgICAgICAgZm9yIGRlc2MgaW4gZm9sbG93X2Rlc2NzOgogICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2ZvbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPWRlc2MpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfZm9sbG93X2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX3RleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHVwZGF0ZWRfZm9sbG93X2J1dHRvbikKICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX3Jlc291cmNlX2lkID0gdXBkYXRlZF9mb2xsb3dfYnV0dG9uLmdldCgicmVzb3VyY2UtaWQiLCAiIikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU2F1IGtoaSBjbGljayBmb2xsb3c6IHRleHQ9J3t1cGRhdGVkX3RleHR9JywgcmVzb3VyY2UtaWQ9J3t1cGRhdGVkX3Jlc291cmNlX2lkfSciKQogICAgICAgICAgICAgICAgICAgICMgVHJpbSB3aGl0ZXNwYWNlIHThu6sgdXBkYXRlZF90ZXh0CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF90ZXh0ID0gdXBkYXRlZF90ZXh0LnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgY8OhYyB0csaw4budbmcgaOG7o3Aga2jDoWMgbmhhdQogICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfdGV4dCBpbiBbIsSQYW5nIHRoZW8gZMO1aSIsICJGb2xsb3dpbmciLCAiTmjhuq9uIHRpbiIsICJNZXNzYWdlIl06CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIkZvbGxvdyB0aMOgbmggY8O0bmchIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgICAgICAgICBlbGlmIHVwZGF0ZWRfdGV4dCBpbiBbIsSQw6MgecOqdSBj4bqndSIsICJSZXF1ZXN0ZWQiXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBn4butaSB5w6p1IGPhuqd1IHRoZW8gZMO1aSB0aMOgbmggY8O0bmchIikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDUKICAgICAgICAgICAgICAgICAgICBlbGlmIHVwZGF0ZWRfdGV4dCBpbiBbIlRoZW8gZMO1aSIsICJGb2xsb3ciXToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJGb2xsb3cga2jDtG5nIHRow6BuaCBjw7RuZywgdGV4dCBj4bunYSBuw7p0IHbhuqtuIGzDoDoge3VwZGF0ZWRfdGV4dH0iKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gMwogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiRm9sbG93IGtow7RuZyB0aMOgbmggY8O0bmcsIHRleHQgY+G7p2EgbsO6dCBsw6A6IHt1cGRhdGVkX3RleHR9IikKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDMKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCwgY8OzIHRo4buDIMSRw6MgZm9sbG93IHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGZvbGxvdyBzYXUga2hpIG5o4bqlbiwgZ2nhuqMgxJHhu4tuaCDEkcOjIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIDEKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiVGV4dCBj4bunYSBuw7p0IGtow7RuZyBraOG7m3AgduG7m2kgJ1RoZW8gZMO1aScgaG/hurdjICdGb2xsb3cnOiB7YnV0dG9uX3RleHR9IikKICAgICAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSB0aOG7sWMgaGnhu4duIGpvYiBmb2xsb3c6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIDIKICAgIAogICAgZGVmIF9zY3JvbGxfZmVlZF9hZnRlcl9qb2Ioc2VsZik6CiAgICAgICAgIiIiVnXhu5F0IGLhuqNuZyB0aW4gMS01IGzhuqduIHNhdSBraGkgam9iIHRow6BuaCBjw7RuZyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSYW5kb20gc+G7kSBs4bqnbiB2deG7kXQgdOG7qyAxLTUKICAgICAgICAgICAgc2Nyb2xsX2NvdW50ID0gcmFuZG9tLnJhbmRpbnQoMSwgNSkKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlZ14buRdCBi4bqjbmcgdGluIHtzY3JvbGxfY291bnR9IGzhuqduIHNhdSBraGkgam9iIHRow6BuaCBjw7RuZyIpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShzY3JvbGxfY291bnQpOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgIyBOZ2jhu4kgcmFuZG9tIDItNCBnacOieSBnaeG7r2EgY8OhYyBs4bqnbiB2deG7kXQKICAgICAgICAgICAgICAgIHdhaXRfdGltZSA9IHJhbmRvbS5yYW5kaW50KDIsIDUpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAod2FpdF90aW1lKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiSG/DoG4gdGjDoG5oIHZ14buRdCBi4bqjbmcgdGluIHNhdSBqb2IiKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHZ14buRdCBi4bqjbmcgdGluIHNhdSBqb2I6IHtzdHIoZSl9IikKICAgIAogICAgZGVmIF9vcGVuX3Byb2ZpbGVfcGFnZShzZWxmLCBwcm9maWxlX2xpbms6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBN4bufIHRyYW5nIHByb2ZpbGUgVGlrVG9rIGLhurFuZyB0w6xtIGtp4bq/bSBob+G6t2MgbGluayB0cuG7sWMgdGnhur9wCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgcHJvZmlsZV9saW5rOiBMaW5rIMSR4bq/biB0cmFuZyBjw6EgbmjDom4KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBUcsOtY2ggeHXhuqV0IHVzZXJuYW1lIHThu6sgVVJMIFRpa1RvawogICAgICAgICAgICB1c2VybmFtZV9tYXRjaCA9IHJlLnNlYXJjaChyJ3Rpa3Rva1wuY29tL0AoW14vP10rKScsIHByb2ZpbGVfbGluaykKICAgICAgICAgICAgaWYgbm90IHVzZXJuYW1lX21hdGNoOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgdHLDrWNoIHh14bqldCB1c2VybmFtZSB04burIGxpbms6IHtwcm9maWxlX2xpbmt9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHVzZXJuYW1lID0gdXNlcm5hbWVfbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmFuZG9tIGNo4buNbiAxIHRyb25nIDIgY8OhY2g6IHTDrG0ga2nhur9tIGhv4bq3YyBt4bufIHRy4buxYyB0aeG6v3AgbGluawogICAgICAgICAgICBpZiByYW5kb20uY2hvaWNlKFtUcnVlLCBGYWxzZV0pOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIk3hu58gdHJhbmcgY8OhIG5ow6JuIGLhurFuZyBjw6FjaCB0w6xtIGtp4bq/bToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAjIFRo4butIG3hu58gYuG6sW5nIHTDrG0ga2nhur9tCiAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fb3Blbl9wcm9maWxlX2J5X3NlYXJjaCh1c2VybmFtZSk6CiAgICAgICAgICAgICAgICAgICAgIyBO4bq/dSB0w6xtIGtp4bq/bSB0aOG6pXQgYuG6oWksIGZhbGxiYWNrIHNhbmcgbeG7nyBsaW5rCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSBraeG6v20gdGjhuqV0IGLhuqFpLCBt4bufIGLhurFuZyBsaW5rIHRy4buxYyB0aeG6v3AiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLm9wZW5fdXJsKHByb2ZpbGVfbGluayxzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCg0KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBDw6FjaCAyOiBN4bufIHRy4buxYyB0aeG6v3AgVVJMIHRow7RuZyBxdWEgaGVscGVyLm9wZW5fdXJsKCkKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJN4bufIHRyYW5nIGPDoSBuaMOibiBi4bqxbmcgbGluayB0cuG7sWMgdGnhur9wOiB7cHJvZmlsZV9saW5rfSIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX3VybChwcm9maWxlX2xpbmssc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBDaOG7nSB0aMOqbSBjaG8gdHJhbmcgaOG7kyBzxqEgdOG6o2kgeG9uZwogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyB2w6BvIMSRw7puZyBwcm9maWxlIGtow7RuZyBi4bqxbmcgY8OhY2ggdMOsbSBidXR0b24gY8OzIHRleHQgPSBAdXNlcm5hbWUKICAgICAgICAgICAgIyBUw6xtIGJ1dHRvbiBjw7MgdGV4dCBjaMOtbmggeMOhYyBi4bqxbmcgQHVzZXJuYW1lIChUaWtUb2sgbHXDtG4gY8OzIEAgdHLGsOG7m2MgdXNlcm5hbWUpCiAgICAgICAgICAgIGF0X3VzZXJuYW1lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5CdXR0b24iLCB0ZXh0PWYiQHt1c2VybmFtZX0iKQogICAgICAgICAgICBpZiBhdF91c2VybmFtZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB4w6FjIG5o4bqtbiB2w6BvIMSRw7puZyBwcm9maWxlIGPhu6dhIHt1c2VybmFtZX0gKHTDrG0gdGjhuqV5IGJ1dHRvbiBjw7MgdGV4dDogJ0B7dXNlcm5hbWV9JykiKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGJ1dHRvbiBjw7MgdGV4dCA9ICdAe3VzZXJuYW1lfScgdHLDqm4gbcOgbiBow6xuaCwgY8OzIHRo4buDIGtow7RuZyB2w6BvIMSRw7puZyBwcm9maWxlIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCBmIkzhu5dpIGtoaSBt4bufIHRyYW5nIHByb2ZpbGU6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBfb3Blbl9wcm9maWxlX2J5X3NlYXJjaChzZWxmLCB1c2VybmFtZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE3hu58gdHJhbmcgcHJvZmlsZSBUaWtUb2sgYuG6sW5nIGPDoWNoIHTDrG0ga2nhur9tIHVzZXJuYW1lCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdXNlcm5hbWU6IFVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiBj4bqnbiB0w6xtCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVMOsbSB0YWIgdMOsbSBraeG6v20KICAgICAgICAgICAgc2VhcmNoX3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlTDrG0ga2nhur9tIikKICAgICAgICAgICAgaWYgbm90IHNlYXJjaF90YWI6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiBUw6xtIGtp4bq/bSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoc2VhcmNoX3RhYikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCgogICAgICAgICAgICAjIFTDrG0gw7Qgbmjhuq1wIHTDrG0ga2nhur9tCiAgICAgICAgICAgIHNlYXJjaF9pbnB1dCA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5FZGl0VGV4dCIpCiAgICAgICAgICAgIGlmIG5vdCBzZWFyY2hfaW5wdXQ6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IMO0IG5o4bqtcCB0w6xtIGtp4bq/bSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmjhuq1wIHVzZXJuYW1lIGPhuqduIHTDrG0KICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHNlYXJjaF9pbnB1dCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEuNSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgaMOgbSBpbnB1dF90ZXh0IG3hu5l0IGzhuqduIGR1eSBuaOG6pXQKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQYW5nIG5o4bqtcCB0ZXh0OiAne3VzZXJuYW1lfSciKQogICAgICAgICAgICBzZWxmLmhlbHBlci5pbnB1dF90ZXh0KGYie3VzZXJuYW1lfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoNikKCgogICAgICAgICAgICAjIFTDrG0gbsO6dCBUw6xtIGtp4bq/bSB2w6AgY2xpY2sKICAgICAgICAgICAgc2VhcmNoX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5CdXR0b24iLCB0ZXh0PSJUw6xtIGtp4bq/bSIpCiAgICAgICAgICAgIGlmIHNlYXJjaF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJUw6xtIHRo4bqleSBuw7p0ICdUw6xtIGtp4bq/bScsIMSRYW5nIGNsaWNrLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzZWFyY2hfYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCAnVMOsbSBraeG6v20nIikKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBzZWFyY2ggduG7m2kgZW50ZXIga2V5CiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19lbnRlcigpCiAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMikgCgogICAgICAgICAgICAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB0YWIgIk5nxrDhu51pIGTDuW5nIiB2w6AgY2xpY2sgdsOgbyBuw7MgLSDEkeG7o2kgdOG7kWkgxJFhIDEwcwogICAgICAgICAgICB1c2VyX3RhYiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQodGV4dD0iTmfGsOG7nWkgZMO5bmciLCB0aW1lb3V0PTEwKQogICAgICAgICAgICBpZiBub3QgdXNlcl90YWI6CiAgICAgICAgICAgICAgICB1c2VyX3RhYiA9IHNlbGYuaGVscGVyLndhaXRfZm9yX2VsZW1lbnQoY29udGVudF9kZXNjPSJOZ8aw4budaSBkw7luZyIsIHRpbWVvdXQ9NikKCiAgICAgICAgICAgIGlmIHVzZXJfdGFiOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygiVMOsbSB0aOG6pXkgdGFiIE5nxrDhu51pIGTDuW5nLCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1c2VyX3RhYikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHTDrG0gdGjhuqV5IHRhYiBOZ8aw4budaSBkw7luZyBzYXUgMTBzIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gVGV4dFZpZXcgY8OzIHRleHQgY2jDrW5oIHjDoWMgYuG6sW5nIHVzZXJuYW1lIChraMO0bmcgY8OzIEApIC0gxJHhu6NpIHThu5FpIMSRYSA2cwogICAgICAgICAgICB1c2VybmFtZV9lbGVtZW50ID0gc2VsZi5oZWxwZXIud2FpdF9mb3JfZWxlbWVudCh0ZXh0PXVzZXJuYW1lLCBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5UZXh0VmlldyIsIHRpbWVvdXQ9NikKCiAgICAgICAgICAgIGlmIHVzZXJuYW1lX2VsZW1lbnQ6CiAgICAgICAgICAgICAgICAjIENsaWNrIHbDoG8gZWxlbWVudCDEkeG6p3UgdGnDqm4gdMOsbSDEkcaw4bujYwogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7dXNlcm5hbWV9LCDEkWFuZyBjbGljayB2w6BvLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcih1c2VybmFtZV9lbGVtZW50KQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3VzZXJuYW1lfSB0cm9uZyBr4bq/dCBxdeG6oyB0w6xtIGtp4bq/bSBzYXUgMTBzIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnByZXNzX2JhY2soKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHTDrG0ga2nhur9tIHTDoGkga2hv4bqjbjoge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9wZXJmb3JtX2xpa2Vfam9iKHNlbGYsIHBvc3RfbGluazogc3RyKSAtPiBpbnQ6CiAgICAgICAgIiIiCiAgICAgICAgVGjhu7FjIGhp4buHbiBqb2IgbGlrZSB2aWRlbyB0csOqbiBUaWtUb2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBwb3N0X2xpbms6IExpbmsgxJHhur9uIHZpZGVvIGPhuqduIGxpa2UKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgaW50OiBUcuG6oW5nIHRow6FpIGpvYiAoMDogY2jGsGEgbMOgbSwgMTogaG/DoG4gdGjDoG5oLCAyOiBs4buXaSwgMzogxJHDoyBsaWtlIHRyxrDhu5tjIMSRw7MpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cKCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLmVuc3VyZV9ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiTeG7nyB2aWRlbyBUaWtUb2sgYuG6sW5nIGxpbmsgdHLhu7FjIHRp4bq/cDoge3Bvc3RfbGlua30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBN4bufIHRy4buxYyB0aeG6v3AgVVJMIHRow7RuZyBxdWEgaGVscGVyLm9wZW5fdXJsKCkKICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl91cmwocG9zdF9saW5rLHNlbGYuYXBwX3BhY2thZ2UpCgogICAgICAgICAgICAjIFJhbmRvbSBuZ2jhu4kgMy0xMCBnacOieSBuaMawIG5nxrDhu51pIGTDuW5nIHRow7RuZyB0aMaw4budbmcKICAgICAgICAgICAgd2FpdF90aW1lID0gcmFuZG9tLnJhbmRpbnQoMywgMTApCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkGFuZyBuZ2jhu4kge3dhaXRfdGltZX1zIG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjDtG5nIHRoxrDhu51uZy4uLiIpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCh3YWl0X3RpbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFTDrG0gbsO6dCBsaWtlIGLhurFuZyBjb250ZW50LWRlc2MgIlRow61jaCB2aWRlby4iCiAgICAgICAgICAgIGxpa2VfYnV0dG9uID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgbGlrZV9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci53YXJuaW5nKCJLaMO0bmcgdMOsbSB0aOG6pXkgbsO6dCBsaWtlIHRyw6puIG3DoG4gaMOsbmgiKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgdGjDtG5nIHRpbiBuw7p0IGxpa2UgYmFuIMSR4bqndQogICAgICAgICAgICBpbml0aWFsX2NvbnRlbnRfZGVzYyA9IGxpa2VfYnV0dG9uLmdldCgiY29udGVudC1kZXNjIiwgIiIpCiAgICAgICAgICAgIGluaXRpYWxfcmVzb3VyY2VfaWQgPSBsaWtlX2J1dHRvbi5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgIGluaXRpYWxfc2VsZWN0ZWQgPSBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGxpa2VfYnV0dG9uKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRy4bqhbmcgdGjDoWkgbsO6dCBsaWtlIGJhbiDEkeG6p3U6IHNlbGVjdGVkPXtpbml0aWFsX3NlbGVjdGVkfSwgY29udGVudC1kZXNjPSd7aW5pdGlhbF9jb250ZW50X2Rlc2N9JywgcmVzb3VyY2UtaWQ9J3tpbml0aWFsX3Jlc291cmNlX2lkfSciKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IMSRw6MgbGlrZSB04burIHRyxrDhu5tjCiAgICAgICAgICAgIGlmIGluaXRpYWxfc2VsZWN0ZWQgb3IgIkLhu48gdGjDrWNoIiBpbiBpbml0aWFsX2NvbnRlbnRfZGVzYyBvciAiVW5saWtlIiBpbiBpbml0aWFsX2NvbnRlbnRfZGVzYzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlZpZGVvIMSRw6MgxJHGsOG7o2MgbGlrZSB04burIHRyxrDhu5tjIikKICAgICAgICAgICAgICAgIHJlc3VsdCA9IDMgICMgxJDDoyBsaWtlIHRyxrDhu5tjIMSRw7MKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGjhu7FjIGhp4buHbiBsaWtlIHZpZGVvCiAgICAgICAgICAgICAgICByZXN1bHQgPSBzZWxmLl9hdHRlbXB0X2xpa2VfdmlkZW8obGlrZV9idXR0b24pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFNhdSBraGkgbGlrZSB4b25nLCB2deG7kXQgcmFuZG9tIDItNSB2aWRlbyBy4buTaSB24buBIHRyYW5nIGNo4bunCiAgICAgICAgICAgIGlmIHJlc3VsdCA9PSAxOiAgIyBUaMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHNlbGYuX3Njcm9sbF92aWRlb3NfYW5kX3JldHVybl9ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiByZXN1bHQKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gam9iIGxpa2U6IHtzdHIoZSl9IikKICAgICAgICAgICAgcmV0dXJuIDIKCiAgICBkZWYgX2ZpbmRfbGlrZV9idXR0b24oc2VsZik6CiAgICAgICAgIiIiVMOsbSBuw7p0IGxpa2UgdHLDqm4gdmlkZW8gVGlrVG9rIiIiCiAgICAgICAgIyBUaOG7rSBjw6FjIGPDoWNoIHTDrG0ga2jDoWMgbmhhdSBjaG8gbsO6dCBsaWtlCiAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJUaMOtY2giKQogICAgICAgIGlmIG5vdCBsaWtlX2J1dHRvbjoKICAgICAgICAgICAgbGlrZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJMaWtlIikKICAgICAgICBpZiBub3QgbGlrZV9idXR0b246CiAgICAgICAgICAgICMgVMOsbSB0aGVvIHJlc291cmNlLWlkIGhv4bq3YyB4cGF0aAogICAgICAgICAgICBsaWtlX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChyZXNvdXJjZV9pZD0iY29tLnNzLmFuZHJvaWQudWdjLnRyaWxsOmlkL2xpa2VfYnV0dG9uIikKICAgICAgICByZXR1cm4gbGlrZV9idXR0b24KCiAgICBkZWYgX2F0dGVtcHRfbGlrZV92aWRlbyhzZWxmLCBsaWtlX2J1dHRvbik6CiAgICAgICAgIiIiVGjhu7FjIGhp4buHbiBsaWtlIHZpZGVvLCDGsHUgdGnDqm4gYuG6pW0gcmFuZG9tIHThu41hIMSR4buZLCBmYWxsYmFjayBzYW5nIGLhuqVtIG7DunQgbGlrZSIiIgogICAgICAgICMgTOG6pXkga8OtY2ggdGjGsOG7m2MgbcOgbiBow6xuaCDEkeG7gyB0w61uaCB04buNYSDEkeG7mSByYW5kb20KICAgICAgICB3aWR0aCwgaGVpZ2h0ID0gc2VsZi5oZWxwZXIuZ2V0X3NjcmVlbl9zaXplKCkKICAgICAgICAKICAgICAgICAjIFRo4butIGLhuqVtIHJhbmRvbSB04buNYSDEkeG7mSB0csaw4bubYyAoZG91YmxlIGNsaWNrKQogICAgICAgIHggPSBpbnQod2lkdGggKiByYW5kb20udW5pZm9ybSgwLjUsIDAuNikpCiAgICAgICAgeSA9IGludChoZWlnaHQgKiByYW5kb20udW5pZm9ybSgwLjUsIDAuNikpCiAgICAgICAgCiAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlRo4butIGRvdWJsZSBjbGljayB04bqhaSB04buNYSDEkeG7mSAoe3h9LCB7eX0pIMSR4buDIGxpa2UgdmlkZW8iKQogICAgICAgIAogICAgICAgICMgVGjhu7FjIGhp4buHbiBkb3VibGUgY2xpY2sKICAgICAgICBzZWxmLmhlbHBlci50YXAoeCwgeSkKICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMC4xKQogICAgICAgIHNlbGYuaGVscGVyLnRhcCh4LCB5KQogICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKSAgIyBDaOG7nSBhbmltYXRpb24KICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEga+G6v3QgcXXhuqMgc2F1IGRvdWJsZSBjbGljawogICAgICAgIGlmIHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IsSQw6MgdGjDrWNoIHZpZGVvIik6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIsSQw6MgbGlrZSB2aWRlbyB0aMOgbmggY8O0bmcgYuG6sW5nIGRvdWJsZSBjbGljayIpCiAgICAgICAgICAgIHJldHVybiAxCgogICAgICAgIAogICAgICAgICMgTuG6v3UgZG91YmxlIGNsaWNrIGtow7RuZyB0aMOgbmggY8O0bmcsIGLhuqVtIHRy4buxYyB0aeG6v3AgdsOgbyBuw7p0IGxpa2UKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJEb3VibGUgY2xpY2sgY2jGsGEgbGlrZSDEkcaw4bujYywgYuG6pW0gdHLhu7FjIHRp4bq/cCB2w6BvIG7DunQgbGlrZSIpCiAgICAgICAgCiAgICAgICAgIyBM4bqleSBs4bqhaSB0aMO0bmcgdGluIG7DunQgbGlrZSBt4bubaSBuaOG6pXQKICAgICAgICBjdXJyZW50X2xpa2VfYnV0dG9uID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgaWYgbm90IGN1cnJlbnRfbGlrZV9idXR0b246CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGxpa2UgxJHhu4MgYuG6pW0gdHLhu7FjIHRp4bq/cCIpCiAgICAgICAgICAgIHJldHVybiAyCiAgICAgICAgCiAgICAgICAgIyBC4bqlbSB2w6BvIG7DunQgbGlrZQogICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50KGN1cnJlbnRfbGlrZV9idXR0b24pCiAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIGvhur90IHF14bqjIHNhdSBraGkgYuG6pW0gbsO6dAogICAgICAgIGxpa2VfYnV0dG9uX2ZpbmFsID0gc2VsZi5fZmluZF9saWtlX2J1dHRvbigpCiAgICAgICAgaWYgbGlrZV9idXR0b25fZmluYWw6CiAgICAgICAgICAgIGlzX3NlbGVjdGVkX2ZpbmFsID0gc2VsZi5oZWxwZXIuaXNfZWxlbWVudF9zZWxlY3RlZChsaWtlX2J1dHRvbl9maW5hbCkKICAgICAgICAgICAgY29udGVudF9kZXNjX2ZpbmFsID0gbGlrZV9idXR0b25fZmluYWwuZ2V0KCJjb250ZW50LWRlc2MiLCAiIikKICAgICAgICAgICAgcmVzb3VyY2VfaWRfZmluYWwgPSBsaWtlX2J1dHRvbl9maW5hbC5nZXQoInJlc291cmNlLWlkIiwgIiIpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYiU2F1IGtoaSBi4bqlbSBuw7p0IGxpa2U6IHNlbGVjdGVkPXtpc19zZWxlY3RlZF9maW5hbH0sIGNvbnRlbnQtZGVzYz0ne2NvbnRlbnRfZGVzY19maW5hbH0nLCByZXNvdXJjZS1pZD0ne3Jlc291cmNlX2lkX2ZpbmFsfSciKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgaXNfc2VsZWN0ZWRfZmluYWwgb3IgIkLhu48gdGjDrWNoIiBpbiBjb250ZW50X2Rlc2NfZmluYWwgb3IgIlVubGlrZSIgaW4gY29udGVudF9kZXNjX2ZpbmFsOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyBsaWtlIHZpZGVvIHRow6BuaCBjw7RuZyBi4bqxbmcgY2xpY2sgbsO6dCIpCiAgICAgICAgICAgICAgICByZXR1cm4gMQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIud2FybmluZygiS2jDtG5nIHRo4buDIGxpa2UgdmlkZW8gc2F1IGtoaSB0aOG7rSBj4bqjIDIgY8OhY2giKQogICAgICAgICAgICAgICAgcmV0dXJuIDIKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEtow7RuZyB0w6xtIHRo4bqleSBuw7p0IMSR4buDIGtp4buDbSB0cmEsIGdp4bqjIMSR4buLbmggdGjDoG5oIGPDtG5nCiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IGxpa2UgxJHhu4Mga2nhu4NtIHRyYSwgZ2nhuqMgxJHhu4tuaCB0aMOgbmggY8O0bmciKQogICAgICAgICAgICByZXR1cm4gMQoKICAgIGRlZiBfc2Nyb2xsX3ZpZGVvc19hbmRfcmV0dXJuX2hvbWUoc2VsZik6CiAgICAgICAgIiIiVnXhu5F0IHJhbmRvbSAyLTUgdmlkZW8gcuG7k2kgduG7gSB0cmFuZyBjaOG7pyIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBSYW5kb20gc+G7kSBsxrDhu6NuZyB2aWRlbyBz4bq9IHZ14buRdCAoMi01KQogICAgICAgICAgICBudW1fdmlkZW9zID0gcmFuZG9tLnJhbmRpbnQoMiwgNSkKICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlPhur0gdnXhu5F0IHF1YSB7bnVtX3ZpZGVvc30gdmlkZW8gdHLGsOG7m2Mga2hpIHbhu4EgdHJhbmcgY2jhu6ciKQogICAgICAgICAgICAKICAgICAgICAgICAgd2lkdGgsIGhlaWdodCA9IHNlbGYuaGVscGVyLmdldF9zY3JlZW5fc2l6ZSgpCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgaSBpbiByYW5nZShudW1fdmlkZW9zKToKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIlZ14buRdCB2aWRlbyB0aOG7qSB7aSsxfS97bnVtX3ZpZGVvc30iKQogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfdXAoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIE5naOG7iSByYW5kb20gMi00IGdpw6J5IG5oxrAgbmfGsOG7nWkgZMO5bmcgdGjhuq10CiAgICAgICAgICAgICAgICB3YWl0X3RpbWUgPSByYW5kb20ucmFuZGludCgyLCA0KQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKHdhaXRfdGltZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVuG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJIb8OgbiB0aMOgbmggdnXhu5F0IHZpZGVvLCDEkWFuZyBxdWF5IHbhu4EgdHJhbmcgY2jhu6ciKQogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgdnXhu5F0IHZpZGVvOiB7c3RyKGUpfSIpCiAgICAgICAgICAgICMgVuG6q24gY+G7kSBn4bqvbmcgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIAogICAgZGVmIGdldF9qb2JfcGFyYW1zKHNlbGYsIGFjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aGFtIHPhu5EgxJHhu4MgZ+G7jWkgQVBJIGzhuqV5IGpvYiBjaG8gVGlrVG9rCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudDogVGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdFtzdHIsIEFueV06IFRoYW0gc+G7kQogICAgICAgICIiIgogICAgICAgIGdvbGlrZV9pZCA9IGFjY291bnQuZ2V0KCJnb2xpa2VfaWQiKQogICAgICAgIGlmIG5vdCBnb2xpa2VfaWQ6CiAgICAgICAgICAgIHJldHVybiB7fQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAiYWNjb3VudF9pZCI6IGdvbGlrZV9pZCwKICAgICAgICAgICAgImRhdGEiOiAibnVsbCIKICAgICAgICB9CiAgICAgICAgCiAgICBkZWYgc3luY19hY2NvdW50c190b19kYihzZWxmKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICDEkOG7k25nIGLhu5kgdMOgaSBraG/huqNuIHThu6sgdGhp4bq/dCBi4buLIHbDoG8gZGF0YWJhc2UKICAgICAgICBHaGkgxJHDqCBwaMawxqFuZyB0aOG7qWMgY+G7p2EgbOG7m3AgY2hhIMSR4buDIMSR4bqjbSBi4bqjbyBjaOG7iSBjw7MgbeG7mXQgdMOgaSBraG/huqNuIMSRxrDhu6NjIMSRw6FuaCBk4bqldSBsw6AgxJFhbmcgbG9naW4KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIFRpa1RvayB0cm9uZyBEQgogICAgICAgICAgICBzZWxmLmRiLnJlc2V0X2xvZ2luX3N0YXR1c19ieV9hcHAoc2VsZi5hcHBfbmFtZSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG6pXkgZGFuaCBzw6FjaCB0w6BpIGtob+G6o24gdOG7qyB0aGnhur90IGLhu4sKICAgICAgICAgICAgZGV2aWNlX2FjY291bnRzID0gc2VsZi5nZXRfYWNjb3VudHNfZnJvbV9kZXZpY2UoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgdOG7qyBkYXRhYmFzZQogICAgICAgICAgICBhbmRyb2lkX2lkID0gc2VsZi5kYi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIGhp4buHbiBjw7MgdHJvbmcgREIgY2hvIGFwcCBuw6B5CiAgICAgICAgICAgIGV4aXN0aW5nX2FjY291bnRzID0gc2VsZi5kYi5nZXRfYWNjb3VudHMoYXBwPXNlbGYuYXBwX25hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFThuqFvIHNldCBjw6FjIHVuaXF1ZV91c2VybmFtZSB04burIHRoaeG6v3QgYuG7iyDEkeG7gyBk4buFIHNvIHPDoW5oCiAgICAgICAgICAgIGRldmljZV91c2VybmFtZXMgPSBzZXQoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBkZXZpY2VfYWNjb3VudHM6CiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKQogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX3VzZXJuYW1lcy5hZGQodXNlcm5hbWUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdMOgaSBraG/huqNuIHRyb25nIERCIG3DoCBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4sgLT4gxJHDoW5oIGThuqV1IGxvZ291dAogICAgICAgICAgICBmb3IgZXhpc3RpbmdfYWNjb3VudCBpbiBleGlzdGluZ19hY2NvdW50czoKICAgICAgICAgICAgICAgIGV4aXN0aW5nX3VzZXJuYW1lID0gZXhpc3RpbmdfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIpCiAgICAgICAgICAgICAgICBpZiBleGlzdGluZ191c2VybmFtZSBhbmQgZXhpc3RpbmdfdXNlcm5hbWUgbm90IGluIGRldmljZV91c2VybmFtZXM6CiAgICAgICAgICAgICAgICAgICAgIyBUw6BpIGtob+G6o24gY8OzIHRyb25nIERCIG5oxrBuZyBraMO0bmcgY8OzIHRyw6puIHRoaeG6v3QgYuG7iyAtPiBsb2dvdXQKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgIT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2V4aXN0aW5nX3VzZXJuYW1lfSBraMO0bmcgY8OybiB0csOqbiB0aGnhur90IGLhu4ssIMSRw6FuaCBk4bqldSBsb2dvdXQiKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGV4aXN0aW5nX2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJzdGF0dXMiOiAibG9nb3V0IiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiAiVMOgaSBraG/huqNuIGtow7RuZyBjw7JuIHRyw6puIHRoaeG6v3QgYuG7iyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAiaXNfbG9naW4iOiBGYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IGhv4bq3YyB0aMOqbSBt4bubaSB2w6BvIERCCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGRldmljZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICMgVGjDqm0gdGjDtG5nIHRpbiBhcHAgdsOgIGRldmljZV9pZAogICAgICAgICAgICAgICAgYWNjb3VudFsiYXBwIl0gPSBzZWxmLmFwcF9uYW1lCiAgICAgICAgICAgICAgICBhY2NvdW50WyJkZXZpY2VfaWQiXSA9IGFuZHJvaWRfaWQKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IGzDoCBjaMawYSDEkeG7k25nIGLhu5kgxJHhu4MgZ+G7rWkgbMOqbiBzZXJ2ZXIKICAgICAgICAgICAgICAgIGFjY291bnRbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgS2nhu4NtIHRyYSB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSBjaMawYSBk4buxYSB2w6BvIHVuaXF1ZV91c2VybmFtZSArIGFwcAogICAgICAgICAgICAgICAgZXhpc3RpbmdfYWNjb3VudCA9IHNlbGYuZGIuZ2V0X2FjY291bnRfYnlfdW5pcXVlX3VzZXJuYW1lKHNlbGYuYXBwX25hbWUsIGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiKSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgZXhpc3RpbmdfYWNjb3VudDoKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gaGnhu4duIGPDsyAtIGNo4buJIMSR4buTbmcgYuG7mSB0cuG6oW5nIHRow6FpIGxvZ2luL2xvZ291dAogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBleGlzdGluZ19hY2NvdW50WyJpZCJdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBDaHXhuqluIGLhu4sgZOG7ryBsaeG7h3UgY+G6rXAgbmjhuq10IHThu5FpIHRoaeG7g3UKICAgICAgICAgICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgImlzX2xvZ2luIjogYWNjb3VudC5nZXQoImlzX2xvZ2luIiwgRmFsc2UpLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBhY2NvdW50LmdldCgibGFzdF91cGRhdGUiLCBpbnQodGltZS50aW1lKCkpKSwKICAgICAgICAgICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3UgdMOgaSBraG/huqNuIHRyb25nIERCIMSRYW5nIOG7nyB0cuG6oW5nIHRow6FpIGxvZ291dCBuaMawbmcgeHXhuqV0IGhp4buHbiBs4bqhaSB0csOqbiB0aGnhur90IGLhu4sKICAgICAgICAgICAgICAgICAgICBpZiBleGlzdGluZ19hY2NvdW50LmdldCgic3RhdHVzIikgPT0gImxvZ291dCI6CiAgICAgICAgICAgICAgICAgICAgICAgICMgUmVzZXQgdOG7qyBsb2dvdXQgduG7gSBhY3RpdmUgdsOgIHjDs2EgaW5hY3RpdmVfcmVhc29uCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJzdGF0dXMiXSA9ICJhY3RpdmUiCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhWyJpbmFjdGl2ZV9yZWFzb24iXSA9ICIiCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJUw6BpIGtob+G6o24ge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gxJHDoyB4deG6pXQgaGnhu4duIGzhuqFpIHRyw6puIHRoaeG6v3QgYuG7iywgcmVzZXQgdOG7qyBsb2dvdXQgduG7gSBhY3RpdmUiKQogICAgICAgICAgICAgICAgICAgICMgTuG6v3UgxJHDoyBhY3RpdmUgdGjDrCBnaeG7ryBuZ3V5w6puIHN0YXR1cywga2jDtG5nIHRoYXkgxJHhu5VpIGfDrCBraMOhYwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHEg25nIG5o4bqtcCBjaG8gdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJyl9IHRyb25nIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgVGjDqm0gdMOgaSBraG/huqNuIG3hu5tpIHbhu5tpIHRy4bqhbmcgdGjDoWkgYWN0aXZlCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudFsic3RhdHVzIl0gPSAiYWN0aXZlIgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIuYWRkX2FjY291bnQoYWNjb3VudCkKICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyB0aMOqbSB0w6BpIGtob+G6o24gbeG7m2kge2FjY291bnQuZ2V0KCd1bmlxdWVfdXNlcm5hbWUnKX0gY2hvIHtzZWxmLmFwcF9uYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIGRldmljZV9hY2NvdW50cwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsIGYiTOG7l2kga2hpIMSR4buTbmcgYuG7mSB0w6BpIGtob+G6o24ge3NlbGYuYXBwX25hbWV9IikKICAgICAgICAgICAgcmV0dXJuIFtdCgogICAgZGVmIG1hcF9nb2xpa2VfYWNjb3VudHMoc2VsZiwgZ29saWtlX2FjY291bnRzOiBMaXN0W0RpY3Rbc3RyLCBBbnldXSwgZGV2aWNlX2FjY291bnRzOiBMaXN0W0RpY3Rbc3RyLCBBbnldXSkgLT4gTGlzdFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiCiAgICAgICAgw4FuaCB44bqhIHTDoGkga2hv4bqjbiB04burIEdvTGlrZSB2w6BvIHTDoGkga2hv4bqjbiB0csOqbiB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBnb2xpa2VfYWNjb3VudHM6IERhbmggc8OhY2ggdMOgaSBraG/huqNuIHThu6sgR29MaWtlIEFQSQogICAgICAgICAgICBkZXZpY2VfYWNjb3VudHM6IERhbmggc8OhY2ggdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24gxJHDoyDDoW5oIHjhuqEKICAgICAgICAiIiIKICAgICAgICBtYXBwZWRfYWNjb3VudHMgPSBbXQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgIyBDaHXhuqluIGjDs2EgZOG7ryBsaeG7h3UgdOG7qyBHb0xpa2UKICAgICAgICAgICAgZ29saWtlX2RhdGEgPSB7fQogICAgICAgICAgICBmb3IgYWNjIGluIGdvbGlrZV9hY2NvdW50czoKICAgICAgICAgICAgICAgICMgVHLDrWNoIHh14bqldCB0aMO0bmcgdGluIHThu6sgdMOgaSBraG/huqNuIEdvTGlrZQogICAgICAgICAgICAgICAgZ29saWtlX2FjY291bnQgPSB7CiAgICAgICAgICAgICAgICAgICAgImdvbGlrZV9pZCI6IGFjYy5nZXQoImlkIiksCiAgICAgICAgICAgICAgICAgICAgIm5pY2tuYW1lIjogYWNjLmdldCgibmlja25hbWUiKSwKICAgICAgICAgICAgICAgICAgICAidW5pcXVlX2lkIjogYWNjLmdldCgidW5pcXVlX2lkIiksCiAgICAgICAgICAgICAgICAgICAgInVuaXF1ZV91c2VybmFtZSI6IGFjYy5nZXQoInVuaXF1ZV91c2VybmFtZSIpLAogICAgICAgICAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBhY2MuZ2V0KCJhdmF0YXJfdGh1bWIiKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFPhu60gZOG7pW5nIHVuaXF1ZV91c2VybmFtZSBsw6BtIGtow7NhIMSR4buDIGThu4Ugw6FuaCB44bqhCiAgICAgICAgICAgICAgICB1c2VybmFtZSA9IGdvbGlrZV9hY2NvdW50WyJ1bmlxdWVfdXNlcm5hbWUiXQogICAgICAgICAgICAgICAgaWYgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgZ29saWtlX2RhdGFbdXNlcm5hbWUubG93ZXIoKV0gPSBnb2xpa2VfYWNjb3VudAogICAgICAgICAgICAKICAgICAgICAgICAgIyDDgW5oIHjhuqEgduG7m2kgdMOgaSBraG/huqNuIHRyw6puIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBmb3IgZGV2aWNlX2FjY291bnQgaW4gZGV2aWNlX2FjY291bnRzOgogICAgICAgICAgICAgICAgdXNlcm5hbWUgPSBkZXZpY2VfYWNjb3VudC5nZXQoInVuaXF1ZV91c2VybmFtZSIsICIiKS5sb3dlcigpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmIHVzZXJuYW1lIGluIGdvbGlrZV9kYXRhOgogICAgICAgICAgICAgICAgICAgICMgxJDDoyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gdHJvbmcgZGFuaCBzw6FjaCBHb0xpa2UKICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHThu6sgR29MaWtlIHbDoG8gdMOgaSBraG/huqNuIHRoaeG6v3QgYuG7iwogICAgICAgICAgICAgICAgICAgIGdvbGlrZV9pbmZvID0gZ29saWtlX2RhdGFbdXNlcm5hbWVdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgICAgICAgICAiZ29saWtlX2lkIjogZ29saWtlX2luZm9bImdvbGlrZV9pZCJdLAogICAgICAgICAgICAgICAgICAgICAgICAiaXNfZ29saWtlX2xpbmtlZCI6IFRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBnb2xpa2VfaW5mb1siYXZhdGFyX3RodW1iIl0gb3IgZGV2aWNlX2FjY291bnQuZ2V0KCJhdmF0YXJfdGh1bWIiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBnb2xpa2VfaW5mb1sidW5pcXVlX2lkIl0gb3IgZGV2aWNlX2FjY291bnQuZ2V0KCJ1bmlxdWVfaWQiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUw6xtIElEIHTDoGkga2hv4bqjbiB0cm9uZyBEQgogICAgICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBkZXZpY2VfYWNjb3VudC5nZXQoImlkIikKICAgICAgICAgICAgICAgICAgICBpZiBhY2NvdW50X2lkOgogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB2w6BvIERCCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHbDoG8gZGV2aWNlX2FjY291bnQKICAgICAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2FjY291bnQudXBkYXRlKHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAgICAgICAgICAgICBtYXBwZWRfYWNjb3VudHMuYXBwZW5kKGRldmljZV9hY2NvdW50KQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6Mgw6FuaCB44bqhIHTDoGkga2hv4bqjbiBUaWtUb2s6IHt1c2VybmFtZX0iKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIG1hcHBlZF9hY2NvdW50cwogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSDDoW5oIHjhuqEgdMOgaSBraG/huqNuIFRpa1RvayIpCiAgICAgICAgICAgIHJldHVybiBbXQogICAgCiAgICBkZWYgX25hdmlnYXRlX3RvX3Byb2ZpbGVfdGFiKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJBp4buBdSBoxrDhu5tuZyDEkeG6v24gdGFiIGjhu5Mgc8ahIFRpa1RvawogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHbDoCBi4bqlbSB2w6BvIG7DunQgIkjhu5Mgc8ahIgogICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgcHJvZmlsZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iSOG7kyBzxqEiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IHByb2ZpbGVfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IEjhu5Mgc8ahIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihwcm9maWxlX2J1dHRvbikKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGRpYWxvZyAiS2jDtG5nIGNobyBwaMOpcCIgbuG6v3UgY8OzCiAgICAgICAgICAgIG5vdF9hbGxvd19idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iS2jDtG5nIGNobyBwaMOpcCIpCiAgICAgICAgICAgIGlmIG5vdF9hbGxvd19idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gZGlhbG9nICdLaMO0bmcgY2hvIHBow6lwJywgxJFhbmcgY2xpY2sgxJHhu4MgxJHDs25nLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihub3RfYWxsb3dfYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgogICAgICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHjhu60gbMO9IGRpYWxvZyAiTMawdSBs4bqhaSDEkcSDbmcgbmjhuq1wIGzhuqduIHNhdSIgbuG6v3UgY8OzCiAgICAgICAgICAgIHNhdmVfbG9naW5fYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KHRleHQ9IkzGsHUgdGjDtG5nIHRpbiDEkcSDbmcgbmjhuq1wIikKICAgICAgICAgICAgaWYgc2F2ZV9sb2dpbl9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gZGlhbG9nICdMxrB1IGzhuqFpIMSRxINuZyBuaOG6rXAgbOG6p24gc2F1JywgxJFhbmcgY2xpY2sgxJHhu4MgxJHDs25nLi4uIikKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihzYXZlX2xvZ2luX2J1dHRvbikKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQoKCiAgICAgICAgICAgICMgVnXhu5F0IGzDqm4gMSBs4bqnbiDEkeG7gyB04bqjaSDEkeG6p3kgxJHhu6cgbuG7mWkgZHVuZwogICAgICAgICAgICBzZWxmLmhlbHBlci5zd2lwZV91cCgpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSDEkWnhu4F1IGjGsOG7m25nIMSR4bq/biB0YWIgaOG7kyBzxqEiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIF9vcGVuX3Byb2ZpbGVfbWVudShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIE3hu58gbWVudSBo4buTIHPGoSAoZGFuaCBzw6FjaCB0w6BpIGtob+G6o24pCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKCiAgICAgICAgICAgICMgVMOsbSBuw7p0IG1lbnUgaOG7kyBzxqEKICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgICAgIG1lbnVfYnV0dG9uID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50X2luX3htbChzY3JlZW5feG1sLCBjb250ZW50X2Rlc2M9Ik1lbnUgaOG7kyBzxqEiKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IG1lbnVfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBuw7p0IE1lbnUgaOG7kyBzxqEiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB04buNYSDEkeG7mSBj4bunYSBuw7p0IG1lbnUgdsOgIGNsaWNrIHbhu5tpIMSR4buZIGzhu4djaCBuZ+G6q3Ugbmhpw6puCiAgICAgICAgICAgIGJvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhtZW51X2J1dHRvbikKICAgICAgICAgICAgeDEsIHkxLCB4MiwgeTIgPSBib3VuZHMKICAgICAgICAgICAgeSA9ICgoeTIgLSB5MSkgLy8gMikgKyB5MQogICAgICAgICAgICB4ID0geDIgLy8gMgogICAgICAgICAgICB4ICs9IHJhbmRvbS5yYW5kaW50KC0xMCwgMTApCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLmhlbHBlci50YXAoeCwgeSkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCgogICAgICAgICAgICAjIGtp4buDbSB0cmEgZGlhbG9nIHRleHQ9IkZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4iCgogICAgICAgICAgICBmb2xsb3dfZnJpZW5kc19kaWFsb2cgPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iRm9sbG93IGLhuqFuIGLDqCBj4bunYSBi4bqhbiIpCiAgICAgICAgICAgIGlmIGZvbGxvd19mcmllbmRzX2RpYWxvZzoKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgJ0ZvbGxvdyBi4bqhbiBiw6ggY+G7p2EgYuG6oW4nLCDEkWFuZyBjbGljayDEkeG7gyDEkcOzbmcuLi4iKQogICAgICAgICAgICAgICAgY2xvc2VfZGlhbG9nID0gc2VsZi5oZWxwZXIuZmluZF9lbGVtZW50KGNvbnRlbnRfZGVzYz0ixJDDs25nIikKICAgICAgICAgICAgICAgIGlmIGNsb3NlX2RpYWxvZzoKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoY2xvc2VfZGlhbG9nKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBt4bufIG1lbnUgaOG7kyBzxqEiKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgaXNfaG9tZV9zY3JlZW4oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcg4bufIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgVGlrVG9rIGtow7RuZwogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgxJFhbmcg4bufIHRyYW5nIGNo4bunLCBGYWxzZSBu4bq/dSBraMO0bmcKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBwYWNrYWdlIGhp4buHbiB04bqhaSB0csaw4bubYyB0acOqbgogICAgICAgICAgICBjdXJyZW50X3BhY2thZ2UgPSBzZWxmLmhlbHBlci5nZXRfY3VycmVudF9wYWNrYWdlKCkKICAgICAgICAgICAgaWYgY3VycmVudF9wYWNrYWdlICE9IHNlbGYuYXBwX3BhY2thZ2U6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBjw7MgbsO6dCAiVHJhbmcgY2jhu6ciIMSRxrDhu6NjIGNo4buNbiAoc2VsZWN0ZWQ9dHJ1ZSkgdHJvbmcgdGhhbmggdGFiIGtow7RuZwogICAgICAgICAgICBob21lX3RhYiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChjb250ZW50X2Rlc2M9IlRyYW5nIGNo4bunIikKICAgICAgICAgICAgaWYgaG9tZV90YWI6CiAgICAgICAgICAgICAgICBpZiBzZWxmLmhlbHBlci5pc19lbGVtZW50X3NlbGVjdGVkKGhvbWVfdGFiKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIE7hur91IHTDrG0gdGjhuqV5IHRhYiAiVHJhbmcgY2jhu6ciIG5oxrBuZyBjaMawYSDEkcaw4bujYyBjaOG7jW4sIGNsaWNrIHbDoG8gxJHDswogICAgICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihob21lX3RhYikKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMS41KQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2jDtG5nIHTDrG0gdGjhuqV5IGPDoWMgeeG6v3UgdOG7kSBj4bunYSB0cmFuZyBjaOG7pwogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBraeG7g20gdHJhIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBlbnN1cmVfaG9tZV9zY3JlZW4oc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICDEkOG6o20gYuG6o28gxJFhbmcg4bufIG3DoG4gaMOsbmggdHJhbmcgY2jhu6cgVGlrVG9rCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHBhY2thZ2UgaGnhu4duIHThuqFpIHRyxrDhu5tjIHRpw6puCiAgICAgICAgICAgIGN1cnJlbnRfcGFja2FnZSA9IHNlbGYuaGVscGVyLmdldF9jdXJyZW50X3BhY2thZ2UoKQogICAgICAgICAgICBpZiBjdXJyZW50X3BhY2thZ2UgIT0gc2VsZi5hcHBfcGFja2FnZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJBcHAgaGnhu4duIHThuqFpICh7Y3VycmVudF9wYWNrYWdlfSkga2jDtG5nIHBo4bqjaSBUaWtUb2ssIG3hu58gYXBwIFRpa1Rvay4uLiIpCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5vcGVuX2FwcChzZWxmLmFwcF9wYWNrYWdlKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDMpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVmFsaWRhdGUgYXBwIGtow7RuZyBi4buLIGJhbm5lZCBzYXUga2hpIG3hu58KICAgICAgICAgICAgICAgIGlmIG5vdCBzZWxmLnZhbGlkYXRlX2FwcF9ub3RfYmFubmVkKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXJyb3IoIkFwcCBUaWtUb2sgY8OzIHbhuqVuIMSR4buBIChiYW5uZWQvY+G6o25oIGLDoW8pIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gxJHDoyDhu58gdHJhbmcgY2jhu6cgY2jGsGEKICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyDhu58gdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBO4bq/dSBjaMawYSwgY+G7kSBn4bqvbmcgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICByZXR1cm4gc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMSR4bqjbSBi4bqjbyB24buBIHRyYW5nIGNo4bunIFRpa1RvayIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgdmFsaWRhdGVfYXBwX25vdF9iYW5uZWQoc2VsZik6CiAgICAgICAgIiIiCiAgICAgICAgxJDhuqNtIGLhuqNvIGtow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gYuG7iyBiYW5uZWQKICAgICAgICAiIiIKICAgICAgICAjIEtp4buDbSB0cmEgZGlhbG9nIGPhuqNuaCBiw6FvIGNodW5nCiAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCiAgICAgICAgIyBLaeG7g20gdHJhIGRpYWxvZyAiQ+G6rXAgbmjhuq10IENow61uaCBzw6FjaCBxdXnhu4FuIHJpw6puZyB0xrAiCiAgICAgICAgcHJpdmFjeV91cGRhdGVfZWxlbWVudHMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgIHRleHQ9IkPhuq1wIG5o4bqtdCBDaMOtbmggc8OhY2ggcXV54buBbiByacOqbmcgdMawIgogICAgICAgICkKCiAgICAgICAgaWYgcHJpdmFjeV91cGRhdGVfZWxlbWVudHM6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oIlBow6F0IGhp4buHbiBkaWFsb2cgJ0Phuq1wIG5o4bqtdCBDaMOtbmggc8OhY2ggcXV54buBbiByacOqbmcgdMawJywgxJFhbmcgeOG7rSBsw70uLi4iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIG7DunQgIsSQw6MgaGnhu4N1IiB2w6AgYuG6pW0gdHLhu7FjIHRp4bq/cAogICAgICAgICAgICB1bmRlcnN0YW5kX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSLEkMOjIGhp4buDdSIpCiAgICAgICAgICAgIGlmIHVuZGVyc3RhbmRfYnV0dG9uOgogICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKHVuZGVyc3RhbmRfYnV0dG9uKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICBzY3JlZW5feG1sID0gc2VsZi5oZWxwZXIuZHVtcF9zY3JlZW5feG1sKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGjhu60gdMOsbSB24bubaSBjw6FjIHRleHQga2jDoWMKICAgICAgICAgICAgICAgIGZvciB0ZXh0IGluIFsiVGnhur9wIHThu6VjIiwgIsSQ4buTbmcgw70iLCAiQ29udGludWUiLCAiQWdyZWUiLCAiQ2jhuqVwIG5o4bqtbiIsICJBY2NlcHQiXToKICAgICAgICAgICAgICAgICAgICBidXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD10ZXh0KQogICAgICAgICAgICAgICAgICAgIGlmIGJ1dHRvbjoKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIudGFwX2VsZW1lbnRfY2VudGVyKGJ1dHRvbikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICMgS2nhu4NtIHRyYSBkaWFsb2cgIlRy4bqhbmcgdGjDoWkgdMOgaSBraG/huqNuIgogICAgICAgIGFjY291bnRfc3RhdHVzX2VsZW1lbnRzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICB0ZXh0PSJUcuG6oW5nIHRow6FpIHTDoGkga2hv4bqjbiIKICAgICAgICApCgogICAgICAgIGlmIGFjY291bnRfc3RhdHVzX2VsZW1lbnRzOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJQaMOhdCBoaeG7h24gZGlhbG9nIMSRxINuZyB4deG6pXQgdMOgaSBraG/huqNuLi4uIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSBuw7p0IGPDsyBpZCBsw6AgYnV0dG9uMSB2w6AgYuG6pW0KICAgICAgICAgICAgYnV0dG9uMSA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudChyZXNvdXJjZV9pZD0iYW5kcm9pZDppZC9idXR0b24xIikKICAgICAgICAgICAgaWYgYnV0dG9uMToKICAgICAgICAgICAgICAgIHNlbGYuaGVscGVyLnRhcF9lbGVtZW50X2NlbnRlcihidXR0b24xKQogICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEwKQogICAgICAgICAgICAgICAgc2NyZWVuX3htbCA9IHNlbGYuaGVscGVyLmR1bXBfc2NyZWVuX3htbCgpCgogICAgICAgICMgVMOsbSBkaWFsb2cgY+G6o25oIGLDoW8gYuG6sW5nIElEIGhv4bq3YyBjb250ZW50LWRlc2MgY8OzIGNo4bupYSAiY+G6o25oIGLDoW8iLCAibOG7l2kiLCAidGjDtG5nIGLDoW8iCiAgICAgICAgYWxlcnRfZGlhbG9ncyA9IHNlbGYuaGVscGVyLmZpbmRfYWxsX2VsZW1lbnRzX2luX3htbCgKICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgY2xhc3NfbmFtZT0iYW5kcm9pZC5hcHAuRGlhbG9nIgogICAgICAgICkKICAgICAgICAKICAgICAgICBmb3IgZGlhbG9nIGluIGFsZXJ0X2RpYWxvZ3M6CiAgICAgICAgICAgICMgVMOsbSB0ZXh0IHRyb25nIGRpYWxvZwogICAgICAgICAgICB0ZXh0X3ZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LlRleHRWaWV3IgogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBmb3IgdGV4dF92aWV3IGluIHRleHRfdmlld3M6CiAgICAgICAgICAgICAgICB0ZXh0ID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfdGV4dCh0ZXh0X3ZpZXcpCiAgICAgICAgICAgICAgICBpZiB0ZXh0IGFuZCBhbnkoa2V5d29yZCBpbiB0ZXh0Lmxvd2VyKCkgZm9yIGtleXdvcmQgaW4gWyJj4bqjbmggYsOhbyIsICJs4buXaSIsICJ0aMO0bmcgYsOhbyIsICJi4buLIGtow7NhIiwgInZpIHBo4bqhbSJdKToKICAgICAgICAgICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggY+G6o25oIGLDoW8gaGnhu4duIHThuqFpIHThu6sgZGIKICAgICAgICAgICAgICAgICAgICBjdXJyZW50X3dhcm5pbmdzID0gc2VsZi5kYi5nZXQoImxvZ3Mtd2FybmluZy1tZXNzYWdlIiwgW10pCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUaMOqbSBj4bqjbmggYsOhbyBt4bubaQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfd2FybmluZ3MuYXBwZW5kKHsKICAgICAgICAgICAgICAgICAgICAgICAgInRpbWUiOiBkYXRldGltZS5kYXRldGltZS5ub3coKS5pc29mb3JtYXQoKSwKICAgICAgICAgICAgICAgICAgICAgICAgIm1lc3MiOiB0ZXh0CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIENo4buJIGdp4buvIGzhuqFpIHThu5FpIMSRYSAyMCBsb2cgZ+G6p24gbmjhuqV0CiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKGN1cnJlbnRfd2FybmluZ3MpID4gMjA6CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnRfd2FybmluZ3MgPSBjdXJyZW50X3dhcm5pbmdzWy0yMDpdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBMxrB1IGzhuqFpIHbDoG8gZGIKICAgICAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgibG9ncy13YXJuaW5nLW1lc3NhZ2UiLCBjdXJyZW50X3dhcm5pbmdzKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiLEkMOjIGzGsHUgY+G6o25oIGLDoW8gVGlrVG9rOiB7dGV4dH0iKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgVMOsbSBuw7p0IE9LIGhv4bq3YyDEkMOzbmcgxJHhu4MgxJHDs25nIGRpYWxvZwogICAgICAgICAgICAgICAgICAgIGJ1dHRvbnMgPSBzZWxmLmhlbHBlci5maW5kX2FsbF9lbGVtZW50c19pbl94bWwoCiAgICAgICAgICAgICAgICAgICAgICAgIHNjcmVlbl94bWwsCiAgICAgICAgICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgZm9yIGJ1dHRvbiBpbiBidXR0b25zOgogICAgICAgICAgICAgICAgICAgICAgICBidXR0b25fdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQoYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBidXR0b25fdGV4dCBhbmQgYnV0dG9uX3RleHQubG93ZXIoKSBpbiBbIm9rIiwgIsSRw7NuZyIsICJ0w7RpIGhp4buDdSIsICLEkeG7k25nIMO9Il06CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoYnV0dG9uKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDEpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZSAgIyBDw7MgY+G6o25oIGLDoW8gdGjDrCByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgICAgICAKICAgICAgICByZXR1cm4gVHJ1ZSAgIyBLaMO0bmcgY8OzIGPhuqNuaCBiw6FvCiAgICAgICAgCiAgICBkZWYgYmFja190b19ob21lKHNlbGYpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgUXVheSB24buBIHRyYW5nIGNo4bunIFRpa1RvayB04burIGLhuqV0IGvhu7MgbcOgbiBow6xuaCBuw6BvCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICIiIgogICAgICAgIG1heF9hdHRlbXB0cyA9IDUKICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJRdWF5IHbhu4EgdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICBmb3IgYXR0ZW1wdCBpbiByYW5nZShtYXhfYXR0ZW1wdHMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6Mg4bufIHRyYW5nIGNo4bunIGNoxrBhCiAgICAgICAgICAgICAgICBpZiBzZWxmLmlzX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbygixJDDoyDhu58gdHJhbmcgY2jhu6cgVGlrVG9rIikKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgcGFja2FnZSBoaeG7h24gdOG6oWkgdHLGsOG7m2Mga2hpIHRo4buxYyBoaeG7h24gdGhhbyB0w6FjCiAgICAgICAgICAgICAgICBjdXJyZW50X3BhY2thZ2UgPSBzZWxmLmhlbHBlci5nZXRfY3VycmVudF9wYWNrYWdlKCkKICAgICAgICAgICAgICAgIGlmIGN1cnJlbnRfcGFja2FnZSAhPSBzZWxmLmFwcF9wYWNrYWdlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiJBcHAgaGnhu4duIHThuqFpICh7Y3VycmVudF9wYWNrYWdlfSkga2jDtG5nIHBo4bqjaSBUaWtUb2ssIG3hu58gbOG6oWkgYXBwIFRpa1Rvay4uLiIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIub3Blbl9hcHAoc2VsZi5hcHBfcGFja2FnZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhZmVfc2xlZXAoMykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgc2F1IGtoaSBt4bufIGFwcAogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFTDrG0gbsO6dCAiVHJhbmcgY2jhu6ciIOG7nyBib3R0b20gbmF2aWdhdGlvCiAgICAgICAgICAgICAgICBob21lX2J1dHRvbiA9IHNlbGYuaGVscGVyLmZpbmRfZWxlbWVudCh0ZXh0PSJUcmFuZyBjaOG7pyIpCiAgICAgICAgICAgICAgICBpZiBub3QgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQoY29udGVudF9kZXNjPSJUcmFuZyBjaOG7pyIpCiAgICAgICAgICAgICAgICBpZiBub3QgaG9tZV9idXR0b246CiAgICAgICAgICAgICAgICAgICAgaG9tZV9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnQodGV4dD0iSG9tZSIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiBob21lX2J1dHRvbjoKICAgICAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIoaG9tZV9idXR0b24pCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIGzhuqFpCiAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5pc19ob21lX3NjcmVlbigpOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGtow7RuZyB0w6xtIHRo4bqleSBuw7p0IGhvbWUsIHRo4butIG5o4bqlbiBiYWNrCiAgICAgICAgICAgICAgICAgICAgc2VsZi5oZWxwZXIucHJlc3NfYmFjaygpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoZiJM4buXaSBraGkgY+G7kSBn4bqvbmcgduG7gSB0cmFuZyBjaOG7pyAobOG6p24ge2F0dGVtcHQgKyAxfSk6IHtlfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHF1YXkgduG7gSB0cmFuZyBjaOG7pyBUaWtUb2sgc2F1IG5oaeG7gXUgbOG6p24gdGjhu60iKQogICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgc3dpdGNoX2FjY291bnQoc2VsZiwgdGFyZ2V0X2FjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIENodXnhu4NuIHNhbmcgdMOgaSBraG/huqNuIFRpa1RvayBraMOhYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhcmdldF9hY2NvdW50OiBUaMO0bmcgdGluIHTDoGkga2hv4bqjbiBj4bqnbiBjaHV54buDbgogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGNodXnhu4NuIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdGFyZ2V0X3VzZXJuYW1lID0gdGFyZ2V0X2FjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIikKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmluZm8oZiLEkGFuZyBjaHV54buDbiBzYW5nIHTDoGkga2hv4bqjbiBUaWtUb2s6IHt0YXJnZXRfdXNlcm5hbWV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIMSRYW5nIOG7nyB0cmFuZyBjaOG7pwogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfaG9tZV9zY3JlZW4oKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgIyBWw6BvIHRyYW5nIGjhu5Mgc8ahCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9uYXZpZ2F0ZV90b19wcm9maWxlX3RhYigpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBWdeG7kXQgbMOqbiAxIGzhuqduCiAgICAgICAgICAgIHNlbGYuaGVscGVyLnN3aXBlX3VwKCkKICAgICAgICAgICAgc2VsZi5zYWZlX3NsZWVwKDAuNSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTeG7nyBtZW51IGjhu5Mgc8ahCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9vcGVuX3Byb2ZpbGVfbWVudSgpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICBhZGRfYWNjb3VudF9idXR0b24gPSBzZWxmLmhlbHBlci5maW5kX2VsZW1lbnRfaW5feG1sKHNjcmVlbl94bWwsIGNvbnRlbnRfZGVzYz0iVGjDqm0gdMOgaSBraG/huqNuIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBhZGRfYWNjb3VudF9idXR0b246CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcigiS2jDtG5nIHTDrG0gdGjhuqV5IG1lbnUgdMOgaSBraG/huqNuIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVMOsbSB0w6BpIGtob+G6o24gY+G6p24gY2h1eeG7g24KICAgICAgICAgICAgYWNjb3VudF9idXR0b25zID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgdGFyZ2V0X2l0ZW0gPSBOb25lCiAgICAgICAgICAgIGZvciBidXR0b24gaW4gYWNjb3VudF9idXR0b25zOgogICAgICAgICAgICAgICAgaWYgYnV0dG9uLmdldCgiY29udGVudC1kZXNjIikgPT0gIlRow6ptIHTDoGkga2hv4bqjbiIgb3IgYnV0dG9uLmdldCgiY29udGVudC1kZXNjIikgPT0gIsSQw7NuZyI6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gYnV0dG9uLmdldCgiY29udGVudC1kZXNjIiwgIiIpCiAgICAgICAgICAgICAgICBpZiBub3QgdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgdGV4dHZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5feG1sLAogICAgICAgICAgICAgICAgICAgICAgICBjbGFzc19uYW1lPSJhbmRyb2lkLndpZGdldC5UZXh0VmlldyIKICAgICAgICAgICAgICAgICAgICApCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgYnV0dG9uX2JvdW5kcyA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X2JvdW5kcyhidXR0b24pCiAgICAgICAgICAgICAgICAgICAgZm9yIHR2IGluIHRleHR2aWV3czoKICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzID0gc2VsZi5oZWxwZXIuZ2V0X2VsZW1lbnRfYm91bmRzKHR2KQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHZfYm91bmRzWzBdID49IGJ1dHRvbl9ib3VuZHNbMF0gYW5kCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0dl9ib3VuZHNbMV0gPj0gYnV0dG9uX2JvdW5kc1sxXSBhbmQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR2X2JvdW5kc1syXSA8PSBidXR0b25fYm91bmRzWzJdIGFuZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHZfYm91bmRzWzNdIDw9IGJ1dHRvbl9ib3VuZHNbM10pOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCA9IHNlbGYuaGVscGVyLmdldF9lbGVtZW50X3RleHQodHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiB0ZXh0IGFuZCB0ZXh0ICE9ICJudWxsIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSA9IHRleHQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZiB1c2VybmFtZSA9PSB0YXJnZXRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0X2l0ZW0gPSBidXR0b24KICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgdGFyZ2V0X2l0ZW06CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5lcnJvcihmIktow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24ge3RhcmdldF91c2VybmFtZX0gdHJvbmcgZGFuaCBzw6FjaCIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiBsw6AgYuG7iyB2w7QgaGnhu4d1IGjDs2EgdHJvbmcgREIKICAgICAgICAgICAgICAgIHNlbGYuZGIudXBkYXRlX2FjY291bnQodGFyZ2V0X2FjY291bnRbImlkIl0sIHsKICAgICAgICAgICAgICAgICAgICAic3RhdHVzIjogImRpc2FibGVkIiwKICAgICAgICAgICAgICAgICAgICAiZGlzYWJsZV9yZWFzb24iOiAiVMOgaSBraG/huqNuIGtow7RuZyBjw7MgdHLDqm4gdGhp4bq/dCBi4buLIiwKICAgICAgICAgICAgICAgICAgICAibGFzdF91cGRhdGUiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgICAgICJpc19zeW5jIjogRmFsc2UKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgTmjhuqVuIEJhY2sgxJHhu4MgxJHDs25nIGRhbmggc8OhY2ggdMOgaSBraG/huqNuCiAgICAgICAgICAgICAgICBzZWxmLmhlbHBlci5wcmVzc19iYWNrKCkKICAgICAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgxKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIFF1YXkgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIE5o4bqlcCB2w6BvIHTDoGkga2hv4bqjbiBt4bulYyB0acOqdQogICAgICAgICAgICBzZWxmLmhlbHBlci50YXBfZWxlbWVudF9jZW50ZXIodGFyZ2V0X2l0ZW0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgc2FmZV9zbGVlcCByZXR1cm4gdmFsdWUgxJHhu4MgY8OzIHRo4buDIHRob8OhdCBz4bubbQogICAgICAgICAgICBpZiBub3Qgc2VsZi5zYWZlX3NsZWVwKDYpOiAgIyDEkOG7o2kgY2h1eeG7g24gdMOgaSBraG/huqNuIGhvw6BuIHThuqV0CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKCJOaOG6rW4gxJHGsOG7o2MgecOqdSBj4bqndSBk4burbmcgdHJvbmcgc3dpdGNoX3RvX2FjY291bnQiKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgeGVtIMSRw6MgY2h1eeG7g24gdMOgaSBraG/huqNuIHRow6BuaCBjw7RuZyBjaMawYQogICAgICAgICAgICBjdXJyZW50X3VzZXJuYW1lID0gc2VsZi5nZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgY3VycmVudF91c2VybmFtZSA9PSB0YXJnZXRfdXNlcm5hbWU6CiAgICAgICAgICAgICAgICBzZWxmLmxvZ2dlci5pbmZvKGYixJDDoyBjaHV54buDbiB0w6BpIGtob+G6o24gdGjDoG5oIGPDtG5nIHNhbmcge3RhcmdldF91c2VybmFtZX0iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLmVycm9yKGYixJDDoyBi4bqlbSB2w6BvIHTDoGkga2hv4bqjbiB7dGFyZ2V0X3VzZXJuYW1lfSBuaMawbmcga2nhu4NtIHRyYSBs4bqhaSB0aOG6pXkgxJFhbmcgxJHEg25nIG5o4bqtcCBsw6Age2N1cnJlbnRfdXNlcm5hbWV9IikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLmxvZ2dlci5leGNlcHRpb24oZSwgIkzhu5dpIGtoaSBjaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhuqNtIGLhuqNvIHF1YXkgduG7gSB0cmFuZyBjaOG7pwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmJhY2tfdG9faG9tZSgpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICBkZWYgX3BlcmZvcm1fYWNjb3VudF9zd2l0Y2goc2VsZiwgdGFyZ2V0X2FjY291bnQ6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gY8OhYyB0aGFvIHTDoWMgVUkgxJHhu4MgY2h1eeG7g24gdMOgaSBraG/huqNuIFRpa1RvawogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhcmdldF9hY2NvdW50OiBUw6BpIGtob+G6o24gY+G6p24gY2h1eeG7g24gxJHhur9uCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLnN3aXRjaF9hY2NvdW50KHRhcmdldF9hY2NvdW50KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgc2VsZi5sb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgdGjhu7FjIGhp4buHbiBjaHV54buDbiB0w6BpIGtob+G6o24gVGlrVG9rIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBnZXRfY3VycmVudF9sb2dnZWRfaW5fdXNlcm5hbWUoc2VsZikgLT4gT3B0aW9uYWxbc3RyXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB1c2VybmFtZSBj4bunYSB0w6BpIGtob+G6o24gVGlrVG9rIMSRYW5nIMSRxINuZyBuaOG6rXAKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHIgaG/hurdjIE5vbmU6IFVzZXJuYW1lIGPhu6dhIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wLCBob+G6t2MgTm9uZSBu4bq/dSBraMO0bmcgY8OzCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIMSQ4bqjbSBi4bqjbyDEkWFuZyDhu58gdHJhbmcgY2jhu6cKICAgICAgICAgICAgaWYgbm90IHNlbGYuZW5zdXJlX2hvbWVfc2NyZWVuKCk6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQoKICAgICAgICAgICAgIyBWw6BvIHRyYW5nIGjhu5Mgc8ahIMSR4buDIGzhuqV5IHVzZXJuYW1lCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9uYXZpZ2F0ZV90b19wcm9maWxlX3RhYigpOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVnXhu5F0IHh14buRbmcgdsOgIGNo4budIDIgZ2nDonkKICAgICAgICAgICAgc2VsZi5oZWxwZXIuc3dpcGVfZG93bigpCiAgICAgICAgICAgIHNlbGYuc2FmZV9zbGVlcCgyKQoKICAgICAgICAgICAgIyBUw6xtIHVzZXJuYW1lIHRyb25nIHRyYW5nIGjhu5Mgc8ahCiAgICAgICAgICAgIHNjcmVlbl94bWwgPSBzZWxmLmhlbHBlci5kdW1wX3NjcmVlbl94bWwoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUw6xtIHRyb25nIGPDoWMgVGV4dFZpZXcgY8OzIHRo4buDIGNo4bupYSB1c2VybmFtZQogICAgICAgICAgICB0ZXh0X3ZpZXdzID0gc2VsZi5oZWxwZXIuZmluZF9hbGxfZWxlbWVudHNfaW5feG1sKAogICAgICAgICAgICAgICAgc2NyZWVuX3htbCwKICAgICAgICAgICAgICAgIGNsYXNzX25hbWU9ImFuZHJvaWQud2lkZ2V0LkJ1dHRvbiIKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgdXNlcm5hbWUgPSBOb25lCiAgICAgICAgICAgIGZvciB0ZXh0X3ZpZXcgaW4gdGV4dF92aWV3czoKICAgICAgICAgICAgICAgIHRleHQgPSBzZWxmLmhlbHBlci5nZXRfZWxlbWVudF90ZXh0KHRleHRfdmlldykKICAgICAgICAgICAgICAgIGlmIHRleHQgYW5kIHRleHQuc3RhcnRzd2l0aCgiQCIpIGFuZCBsZW4odGV4dCkgPiAxOgogICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lID0gdGV4dFsxOl0gICMgQuG7jyBrw70gdOG7sSBACiAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBRdWF5IGzhuqFpIHRyYW5nIGNo4bunCiAgICAgICAgICAgIHNlbGYuYmFja190b19ob21lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHVzZXJuYW1lOgogICAgICAgICAgICAgICAgc2VsZi5sb2dnZXIuaW5mbyhmIsSQw6MgbOG6pXkgdXNlcm5hbWUgdOG7qyB0cmFuZyBo4buTIHPGoToge3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gdXNlcm5hbWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYubG9nZ2VyLndhcm5pbmcoIktow7RuZyB0aOG7gyBs4bqleSB1c2VybmFtZSB04burIHRyYW5nIGjhu5Mgc8ahIikKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYubG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGzhuqV5IHVzZXJuYW1lIHTDoGkga2hv4bqjbiDEkWFuZyDEkcSDbmcgbmjhuq1wIikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5iYWNrX3RvX2hvbWUoKQogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBOb25l').decode('utf-8'))
