import base64
exec(base64.b64decode('aW1wb3J0IHNxbGl0ZTMKaW1wb3J0IGpzb24KaW1wb3J0IG9zCmltcG9ydCB0aW1lCmltcG9ydCB0aHJlYWRpbmcKaW1wb3J0IHV1aWQKZnJvbSB0eXBpbmcgaW1wb3J0IERpY3QsIEFueSwgTGlzdCwgT3B0aW9uYWwsIFVuaW9uCmltcG9ydCBjb25maWcKCmNsYXNzIERhdGFiYXNlU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9wYXRoOiBzdHIgPSAiZGF0YS5kYiIsIGRlZmF1bHRfY29uZmlnX3BhdGg6IHN0ciA9ICJkZWZhdWx0Q29uZmlnLmpzb24iKToKICAgICAgICBzZWxmLmRiX3BhdGggPSBkYl9wYXRoCiAgICAgICAgc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoID0gZGVmYXVsdF9jb25maWdfcGF0aAogICAgICAgIHNlbGYubG9jYWwgPSB0aHJlYWRpbmcubG9jYWwoKSAgIyBMxrB1IHRy4buvIHJpw6puZyBjaG8gbeG7l2kgdGhyZWFkCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBzZWxmLl9pbml0X2RiKCkKICAgICAgICAKICAgIGRlZiBfZ2V0X2Nvbm5lY3Rpb24oc2VsZik6CiAgICAgICAgIiIiTOG6pXkga+G6v3QgbuG7kWkgU1FMaXRlIGNobyB0aHJlYWQgaGnhu4duIHThuqFpIiIiCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZi5sb2NhbCwgJ2Nvbm4nKSBvciBzZWxmLmxvY2FsLmNvbm4gaXMgTm9uZToKICAgICAgICAgICAgc2VsZi5sb2NhbC5jb25uID0gc3FsaXRlMy5jb25uZWN0KHNlbGYuZGJfcGF0aCkKICAgICAgICByZXR1cm4gc2VsZi5sb2NhbC5jb25uCiAgICAgICAgCiAgICBkZWYgX2luaXRfZGIoc2VsZik6CiAgICAgICAgIiIiS2jhu59pIHThuqFvIGPhuqV1IHRyw7pjIGRhdGFiYXNlIG7hur91IGNoxrBhIHThu5NuIHThuqFpIiIiCiAgICAgICAgY29ubiA9IHNxbGl0ZTMuY29ubmVjdChzZWxmLmRiX3BhdGgpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgVOG6oW8gYuG6o25nIGNvbmZpZwogICAgICAgIGN1cnNvci5leGVjdXRlKCcnJwogICAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGNvbmZpZyAoCiAgICAgICAgICAgIGtleSBURVhUIFBSSU1BUlkgS0VZLAogICAgICAgICAgICB2YWx1ZSBURVhUCiAgICAgICAgKQogICAgICAgICcnJykKICAgICAgICAKICAgICAgICAjIFThuqFvIGLhuqNuZyBhY2NvdW50IHbhu5tpIHV1aWQKICAgICAgICBjdXJzb3IuZXhlY3V0ZSgnJycKICAgICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyBhY2NvdW50cyAoCiAgICAgICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVksCiAgICAgICAgICAgIGFjY291bnRfdXVpZCBURVhUIFVOSVFVRSwKICAgICAgICAgICAgYXBwIFRFWFQsCiAgICAgICAgICAgIG5pY2tuYW1lIFRFWFQsCiAgICAgICAgICAgIHVuaXF1ZV9pZCBURVhULAogICAgICAgICAgICB1bmlxdWVfdXNlcm5hbWUgVEVYVCwKICAgICAgICAgICAgc3RhdHVzIFRFWFQsCiAgICAgICAgICAgIGluYWN0aXZlX3JlYXNvbiBURVhULAogICAgICAgICAgICBpc19sb2dpbiBJTlRFR0VSLAogICAgICAgICAgICBhdmF0YXJfdGh1bWIgVEVYVCwKICAgICAgICAgICAgdG90YWxfam9icyBJTlRFR0VSLAogICAgICAgICAgICBqb2JfZW5hYmxlIElOVEVHRVIsCiAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsIElOVEVHRVIsCiAgICAgICAgICAgIGpvYl90b2RheSBJTlRFR0VSLAogICAgICAgICAgICBqb2JfbWF4X2RheSBJTlRFR0VSLAogICAgICAgICAgICBqb2JzX2RvbmVfaW5fc2Vzc2lvbiBJTlRFR0VSLAogICAgICAgICAgICBtYXhfam9ic19wZXJfc2Vzc2lvbiBJTlRFR0VSLAogICAgICAgICAgICBsYXN0X2pvYl90aW1lIElOVEVHRVIsCiAgICAgICAgICAgIGxhc3RfdXBkYXRlIElOVEVHRVIsCiAgICAgICAgICAgIGNhcmVfdG9kYXkgSU5URUdFUiwKICAgICAgICAgICAgaXNfZ29saWtlX2xpbmtlZCBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZ29saWtlX2lkIFRFWFQsCiAgICAgICAgICAgIGRldmljZV9pZCBURVhULAogICAgICAgICAgICBpc19zeW5jIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBkaXNhYmxlX2ZvbGxvdyBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZm9sbG93X2Rpc2FibGVfdW50aWwgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIGZvbGxvd190b2RheSBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZm9sbG93X2luX3Nlc3Npb24gSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIG1heF9mb2xsb3dfZGF5IElOVEVHRVIgREVGQVVMVCAyMCwKICAgICAgICAgICAgbWF4X2ZvbGxvd19zZXNzaW9uIElOVEVHRVIgREVGQVVMVCA1LAogICAgICAgICAgICBsYXN0X2ZvbGxvd190aW1lIElOVEVHRVIgREVGQVVMVCAwLAogICAgICAgICAgICBpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIFRFWFQsCiAgICAgICAgICAgIGRhdGEgVEVYVAogICAgICAgICkKICAgICAgICAnJycpCiAgICAgICAgCiAgICAgICAgIyBU4bqhbyBi4bqjbmcgam9ic19oaXN0b3J5IMSR4buDIGzGsHUgbOG7i2NoIHPhu60gam9iCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoJycnCiAgICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgam9ic19oaXN0b3J5ICgKICAgICAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSwKICAgICAgICAgICAgam9iX3V1aWQgVEVYVCBVTklRVUUsCiAgICAgICAgICAgIGFjY291bnRfdXVpZCBURVhULAogICAgICAgICAgICBkZXZpY2VfaWQgVEVYVCwKICAgICAgICAgICAgYXBwIFRFWFQsCiAgICAgICAgICAgIGpvYl9pZCBURVhULAogICAgICAgICAgICBqb2JfdHlwZSBURVhULAogICAgICAgICAgICBvYmplY3RfaWQgVEVYVCwKICAgICAgICAgICAgbGluayBURVhULAogICAgICAgICAgICBzdGF0dXMgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIHN1Y2Nlc3MgSU5URUdFUiBERUZBVUxUIDAsCiAgICAgICAgICAgIHByaWNlIFJFQUwgREVGQVVMVCAwLAogICAgICAgICAgICBlcnJvcl9tZXNzYWdlIFRFWFQsCiAgICAgICAgICAgIGNyZWF0ZWRfYXQgSU5URUdFUiwKICAgICAgICAgICAgbGFzdF91cGRhdGUgSU5URUdFUiwKICAgICAgICAgICAgaXNfc3luYyBJTlRFR0VSIERFRkFVTFQgMCwKICAgICAgICAgICAgZGF0YSBURVhUCiAgICAgICAgKQogICAgICAgICcnJykKICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRow6ptIGPhu5l0IGFjY291bnRfdXVpZCBu4bq/dSBjaMawYSB04buTbiB04bqhaQogICAgICAgIGN1cnNvci5leGVjdXRlKCJQUkFHTUEgdGFibGVfaW5mbyhhY2NvdW50cykiKQogICAgICAgIGNvbHVtbnMgPSBbcm93WzFdIGZvciByb3cgaW4gY3Vyc29yLmZldGNoYWxsKCldCiAgICAgICAgaWYgImFjY291bnRfdXVpZCIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGFjY291bnRfdXVpZCBURVhUIFVOSVFVRSIpCiAgICAgICAgICAgICMgVOG6oW8gVVVJRCBjaG8gY8OhYyB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiU0VMRUNUIGlkIEZST00gYWNjb3VudHMiKQogICAgICAgICAgICBhY2NvdW50cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgICAgIGZvciBhY2NvdW50IGluIGFjY291bnRzOgogICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgIGFjY291bnRfdXVpZCA9IHN0cih1dWlkLnV1aWQ0KCkpCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiVVBEQVRFIGFjY291bnRzIFNFVCBhY2NvdW50X3V1aWQgPSA/IFdIRVJFIGlkID0gPyIsIChhY2NvdW50X3V1aWQsIGFjY291bnRfaWQpKQogICAgICAgICAgICBwcmludCgixJDDoyB0aMOqbSBj4buZdCBhY2NvdW50X3V1aWQgdsOgbyBi4bqjbmcgYWNjb3VudHMgdsOgIHThuqFvIFVVSUQgY2hvIGPDoWMgdMOgaSBraG/huqNuIGhp4buHbiBjw7MiKQogICAgICAgICAgICAKICAgICAgICAjIEtp4buDbSB0cmEgdsOgIHRow6ptIGPhu5l0IGlzX3N5bmMgbuG6v3UgY2jGsGEgdOG7k24gdOG6oWkKICAgICAgICBpZiAiaXNfc3luYyIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGlzX3N5bmMgSU5URUdFUiBERUZBVUxUIDAiKQogICAgICAgICAgICBwcmludCgixJDDoyB0aMOqbSBj4buZdCBpc19zeW5jIHbDoG8gYuG6o25nIGFjY291bnRzIikKICAgICAgICAKICAgICAgICAjIFRow6ptIGPhu5l0IGRpc2FibGVfZm9sbG93IG7hur91IGNoxrBhIGPDswogICAgICAgIGlmICJkaXNhYmxlX2ZvbGxvdyIgbm90IGluIGNvbHVtbnM6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIGRpc2FibGVfZm9sbG93IElOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICAgICAgcHJpbnQoIsSQw6MgdGjDqm0gY+G7mXQgZGlzYWJsZV9mb2xsb3cgdsOgbyBi4bqjbmcgYWNjb3VudHMiKQogICAgICAgIAogICAgICAgICMgVGjDqm0gY+G7mXQgZm9sbG93X2Rpc2FibGVfdW50aWwgbuG6v3UgY2jGsGEgY8OzCiAgICAgICAgaWYgImZvbGxvd19kaXNhYmxlX3VudGlsIiBub3QgaW4gY29sdW1uczoKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIkFMVEVSIFRBQkxFIGFjY291bnRzIEFERCBDT0xVTU4gZm9sbG93X2Rpc2FibGVfdW50aWwgSU5URUdFUiBERUZBVUxUIDAiKQogICAgICAgICAgICBwcmludCgixJDDoyB0aMOqbSBj4buZdCBmb2xsb3dfZGlzYWJsZV91bnRpbCB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBjw6FjIGPhu5l0IGZvbGxvdyB0cmFja2luZyBu4bq/dSBjaMawYSBjw7MKICAgICAgICBmb2xsb3dfY29sdW1ucyA9IFsKICAgICAgICAgICAgKCJmb2xsb3dfdG9kYXkiLCAiSU5URUdFUiBERUZBVUxUIDAiKSwKICAgICAgICAgICAgKCJmb2xsb3dfaW5fc2Vzc2lvbiIsICJJTlRFR0VSIERFRkFVTFQgMCIpLAogICAgICAgICAgICAoIm1heF9mb2xsb3dfZGF5IiwgIklOVEVHRVIgREVGQVVMVCAyMCIpLAogICAgICAgICAgICAoIm1heF9mb2xsb3dfc2Vzc2lvbiIsICJJTlRFR0VSIERFRkFVTFQgNSIpLAogICAgICAgICAgICAoImxhc3RfZm9sbG93X3RpbWUiLCAiSU5URUdFUiBERUZBVUxUIDAiKSwKICAgICAgICAgICAgKCJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIiwgIlRFWFQiKQogICAgICAgIF0KICAgICAgICAKICAgICAgICBmb3IgY29sX25hbWUsIGNvbF90eXBlIGluIGZvbGxvd19jb2x1bW5zOgogICAgICAgICAgICBpZiBjb2xfbmFtZSBub3QgaW4gY29sdW1uczoKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKGYiQUxURVIgVEFCTEUgYWNjb3VudHMgQUREIENPTFVNTiB7Y29sX25hbWV9IHtjb2xfdHlwZX0iKQogICAgICAgICAgICAgICAgcHJpbnQoZiLEkMOjIHRow6ptIGPhu5l0IHtjb2xfbmFtZX0gdsOgbyBi4bqjbmcgYWNjb3VudHMiKQogICAgICAgIAogICAgICAgICMgVGjDqm0gY8OhYyBj4buZdCBjYXJlIHRyYWNraW5nIG7hur91IGNoxrBhIGPDswogICAgICAgIGNhcmVfY29sdW1ucyA9IFsKICAgICAgICAgICAgKCJsYXN0X2NhcmVfdGltZSIsICJJTlRFR0VSIERFRkFVTFQgMCIpLAogICAgICAgICAgICAoImxhc3Rfdmlld19zdG9yaWVzIiwgIklOVEVHRVIgREVGQVVMVCAwIikKICAgICAgICBdCiAgICAgICAgCiAgICAgICAgZm9yIGNvbF9uYW1lLCBjb2xfdHlwZSBpbiBjYXJlX2NvbHVtbnM6CiAgICAgICAgICAgIGlmIGNvbF9uYW1lIG5vdCBpbiBjb2x1bW5zOgogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoZiJBTFRFUiBUQUJMRSBhY2NvdW50cyBBREQgQ09MVU1OIHtjb2xfbmFtZX0ge2NvbF90eXBlfSIpCiAgICAgICAgICAgICAgICBwcmludChmIsSQw6MgdGjDqm0gY+G7mXQge2NvbF9uYW1lfSB2w6BvIGLhuqNuZyBhY2NvdW50cyIpCiAgICAgICAgCiAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgIGNvbm4uY2xvc2UoKQogICAgICAgIAogICAgICAgICMgS2jhu59pIHThuqFvIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBjb25maWcucHkKICAgICAgICBzZWxmLmluaXRfZGVmYXVsdF9jb25maWcoKQogICAgICAgIAogICAgZGVmIGxvYWRfZGVmYXVsdF9jb25maWcoc2VsZikgLT4gRGljdFtzdHIsIEFueV06CiAgICAgICAgIiIixJDhu41jIGPhuqV1IGjDrG5oIG3hurdjIMSR4buLbmggdOG7qyBmaWxlIiIiCiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5kZWZhdWx0X2NvbmZpZ19wYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHNlbGYuZGVmYXVsdF9jb25maWdfcGF0aCwgJ3InKSBhcyBmOgogICAgICAgICAgICAgICAgcmV0dXJuIGpzb24ubG9hZChmKQogICAgICAgIHJldHVybiB7fQogICAgICAgIAogICAgZGVmIGdldChzZWxmLCBrZXk6IHN0ciwgZGVmYXVsdD1Ob25lKSAtPiBBbnk6CiAgICAgICAgIiIiTOG6pXkgZ2nDoSB0cuG7iyBj4bqldSBow6xuaCB04burIERCLCBu4bq/dSBraMO0bmcgY8OzIHRow6wgbOG6pXkgdOG7qyBkZWZhdWx0IGNvbmZpZyIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1QgdmFsdWUgRlJPTSBjb25maWcgV0hFUkUga2V5ID0gPyIsIChrZXksKSkKICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIHJlc3VsdDoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgduG7gSBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgICAgICB2YWx1ZSA9IHJlc3VsdFswXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXR1cm4ganNvbi5sb2Fkcyh2YWx1ZSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIyBM4bqleSB04burIGRlZmF1bHQgY29uZmlnCiAgICAgICAgICAgIGRlZmF1bHRfY29uZmlnID0gc2VsZi5sb2FkX2RlZmF1bHRfY29uZmlnKCkKICAgICAgICAgICAgaWYga2V5IGluIGRlZmF1bHRfY29uZmlnOgogICAgICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRfY29uZmlnW2tleV0KICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHQKICAgIAogICAgZGVmIHNldChzZWxmLCBrZXk6IHN0ciwgdmFsdWU6IEFueSkgLT4gYm9vbDoKICAgICAgICAiIiJMxrB1IGdpw6EgdHLhu4sgY+G6pXUgaMOsbmggdsOgbyBEQiIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGThu68gbGnhu4d1IHBo4bupYyB04bqhcCB0aMOgbmggSlNPTgogICAgICAgIGlmIGlzaW5zdGFuY2UodmFsdWUsIChkaWN0LCBsaXN0KSk6CiAgICAgICAgICAgIHZhbHVlID0ganNvbi5kdW1wcyh2YWx1ZSkKICAgICAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICJJTlNFUlQgT1IgUkVQTEFDRSBJTlRPIGNvbmZpZyAoa2V5LCB2YWx1ZSkgVkFMVUVTICg/LCA/KSIsCiAgICAgICAgICAgICAgICAoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBsxrB1IGPhuqV1IGjDrG5oOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGRlbGV0ZShzZWxmLCBrZXk6IHN0cikgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIG3hu5l0IGPhuqV1IGjDrG5oIGto4buPaSBkYXRhYmFzZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGtleTogS2jDs2EgY+G6pXUgaMOsbmggY+G6p24geMOzYQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gY29uZmlnIFdIRVJFIGtleSA9ID8iLCAoa2V5LCkpCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgY+G6pXUgaMOsbmgge2tleX06IHtlfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgCiAgICBkZWYgc2F2ZV9kZXZpY2VfaW5mbyhzZWxmLCBkZXZpY2VfaW5mbzogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGPhuqV1IGjDrG5oIiIiCiAgICAgICAgcmV0dXJuIHNlbGYuc2V0KCJkZXZpY2VfaW5mbyIsIGRldmljZV9pbmZvKQogICAgCiAgICBkZWYgZ2V0X2RldmljZV9pbmZvKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIkzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLIMSRw6MgbMawdSIiIgogICAgICAgIGRldmljZV9pbmZvID0gc2VsZi5nZXQoImRldmljZV9pbmZvIiwge30pCiAgICAgICAgcmV0dXJuIGRldmljZV9pbmZvCiAgICAKICAgIGRlZiBhZGRfYWNjb3VudChzZWxmLCBhY2NvdW50X2RhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIlRow6ptIHTDoGkga2hv4bqjbiBt4bubaSB2w6BvIGRhdGFiYXNlIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIG1vZHVsZQogICAgICAgIGltcG9ydCBjb25maWcgYXMgY29uZmlnX21vZHVsZQogICAgICAgIAogICAgICAgICMgTuG6v3Uga2jDtG5nIGPDsyBkZXZpY2VfaWQsIHPhu60gZOG7pW5nIGRldmljZV9pZCBoaeG7h24gdOG6oWkKICAgICAgICBkZXZpY2VfaWQgPSBhY2NvdW50X2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIAogICAgICAgICMgVMOhY2ggZOG7ryBsaeG7h3UgY2jDrW5oIHbDoCBk4buvIGxp4buHdSBwaOG7pQogICAgICAgIG1haW5fZGF0YSA9IHsKICAgICAgICAgICAgImFwcCI6IGFjY291bnRfZGF0YS5nZXQoImFwcCIsICIiKSwKICAgICAgICAgICAgIm5pY2tuYW1lIjogYWNjb3VudF9kYXRhLmdldCgibmlja25hbWUiLCAiIiksCiAgICAgICAgICAgICJ1bmlxdWVfaWQiOiBhY2NvdW50X2RhdGEuZ2V0KCJ1bmlxdWVfaWQiLCAiIiksCiAgICAgICAgICAgICJ1bmlxdWVfdXNlcm5hbWUiOiBhY2NvdW50X2RhdGEuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiIiksCiAgICAgICAgICAgICJzdGF0dXMiOiBhY2NvdW50X2RhdGEuZ2V0KCJzdGF0dXMiLCAiaW5hY3RpdmUiKSwKICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGFjY291bnRfZGF0YS5nZXQoImluYWN0aXZlX3JlYXNvbiIsICIiKSwKICAgICAgICAgICAgImlzX2xvZ2luIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJhdmF0YXJfdGh1bWIiOiBhY2NvdW50X2RhdGEuZ2V0KCJhdmF0YXJfdGh1bWIiLCAiIiksCiAgICAgICAgICAgICJ0b3RhbF9qb2JzIjogYWNjb3VudF9kYXRhLmdldCgidG90YWxfam9icyIsIDApLAogICAgICAgICAgICAiam9iX2VuYWJsZSI6IDEgaWYgYWNjb3VudF9kYXRhLmdldCgiam9iX2VuYWJsZSIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICJqb2JfZGlzYWJsZV91bnRpbCI6IGFjY291bnRfZGF0YS5nZXQoImpvYl9kaXNhYmxlX3VudGlsIiwgMCksCiAgICAgICAgICAgICJqb2JfdG9kYXkiOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JfdG9kYXkiLCAwKSwKICAgICAgICAgICAgImpvYl9tYXhfZGF5IjogYWNjb3VudF9kYXRhLmdldCgiam9iX21heF9kYXkiLCBjb25maWdfbW9kdWxlLk1BWF9KT0JTX1BFUl9EQVkpLAogICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJqb2JzX2RvbmVfaW5fc2Vzc2lvbiIsIDApLAogICAgICAgICAgICAibWF4X2pvYnNfcGVyX3Nlc3Npb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJtYXhfam9ic19wZXJfc2Vzc2lvbiIsIGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX1NFU1NJT04pLAogICAgICAgICAgICAibGFzdF9qb2JfdGltZSI6IGFjY291bnRfZGF0YS5nZXQoImxhc3Rfam9iX3RpbWUiLCAwKSwKICAgICAgICAgICAgImxhc3RfdXBkYXRlIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgImNhcmVfdG9kYXkiOiBhY2NvdW50X2RhdGEuZ2V0KCJjYXJlX3RvZGF5IiwgMCksCiAgICAgICAgICAgICJpc19nb2xpa2VfbGlua2VkIjogMSBpZiBhY2NvdW50X2RhdGEuZ2V0KCJpc19nb2xpa2VfbGlua2VkIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgImdvbGlrZV9pZCI6IGFjY291bnRfZGF0YS5nZXQoImdvbGlrZV9pZCIsICIiKSwKICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgImlzX3N5bmMiOiAxIGlmIGFjY291bnRfZGF0YS5nZXQoImlzX3N5bmMiLCBGYWxzZSkgZWxzZSAwLAogICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiAxIGlmIGFjY291bnRfZGF0YS5nZXQoImRpc2FibGVfZm9sbG93IiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgImZvbGxvd19kaXNhYmxlX3VudGlsIjogYWNjb3VudF9kYXRhLmdldCgiZm9sbG93X2Rpc2FibGVfdW50aWwiLCAwKSwKICAgICAgICAgICAgImZvbGxvd190b2RheSI6IGFjY291bnRfZGF0YS5nZXQoImZvbGxvd190b2RheSIsIDApLAogICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJmb2xsb3dfaW5fc2Vzc2lvbiIsIDApLAogICAgICAgICAgICAibWF4X2ZvbGxvd19kYXkiOiBhY2NvdW50X2RhdGEuZ2V0KCJtYXhfZm9sbG93X2RheSIsIDIwKSwKICAgICAgICAgICAgIm1heF9mb2xsb3dfc2Vzc2lvbiI6IGFjY291bnRfZGF0YS5nZXQoIm1heF9mb2xsb3dfc2Vzc2lvbiIsIDUpLAogICAgICAgICAgICAibGFzdF9mb2xsb3dfdGltZSI6IGFjY291bnRfZGF0YS5nZXQoImxhc3RfZm9sbG93X3RpbWUiLCAwKSwKICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiBhY2NvdW50X2RhdGEuZ2V0KCJpbmFjdGl2ZV9mb2xsb3dfcmVhc29uIiwgIiIpLAogICAgICAgICAgICAibGFzdF9jYXJlX3RpbWUiOiBhY2NvdW50X2RhdGEuZ2V0KCJsYXN0X2NhcmVfdGltZSIsIDApLAogICAgICAgICAgICAibGFzdF92aWV3X3N0b3JpZXMiOiBhY2NvdW50X2RhdGEuZ2V0KCJsYXN0X3ZpZXdfc3RvcmllcyIsIDApLAogICAgICAgICAgICAiYWNjb3VudF91dWlkIjogYWNjb3VudF9kYXRhLmdldCgiYWNjb3VudF91dWlkIiwgc3RyKHV1aWQudXVpZDQoKSkpLCAgIyBU4bqhbyBVVUlEIG7hur91IGNoxrBhIGPDswogICAgICAgIH0KICAgICAgICAKICAgICAgICAjIEzGsHUgSUQgdOG7qyBk4buvIGxp4buHdSDEkeG6p3UgdsOgbyBu4bq/dSBjw7MKICAgICAgICBpZiAiaWQiIGluIGFjY291bnRfZGF0YToKICAgICAgICAgICAgbWFpbl9kYXRhWyJpZCJdID0gYWNjb3VudF9kYXRhWyJpZCJdCiAgICAgICAgCiAgICAgICAgIyBMxrB1IGThu68gbGnhu4d1IHBo4bulIGTGsOG7m2kgZOG6oW5nIEpTT04KICAgICAgICBleHRyYV9kYXRhID0ge2s6IHYgZm9yIGssIHYgaW4gYWNjb3VudF9kYXRhLml0ZW1zKCkgaWYgayBub3QgaW4gbWFpbl9kYXRhfQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY29sdW1ucyA9ICIsICIuam9pbihtYWluX2RhdGEua2V5cygpKQogICAgICAgICAgICBwbGFjZWhvbGRlcnMgPSAiLCAiLmpvaW4oWyI/Il0gKiBsZW4obWFpbl9kYXRhKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHZhbHVlcyA9IGxpc3QobWFpbl9kYXRhLnZhbHVlcygpKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB2w6BvIGN14buRaQogICAgICAgICAgICBjb2x1bW5zICs9ICIsIGRhdGEiCiAgICAgICAgICAgIHBsYWNlaG9sZGVycyArPSAiLCA/IgogICAgICAgICAgICB2YWx1ZXMuYXBwZW5kKGpzb24uZHVtcHMoZXh0cmFfZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICBxdWVyeSA9IGYiSU5TRVJUIE9SIFJFUExBQ0UgSU5UTyBhY2NvdW50cyAoe2NvbHVtbnN9KSBWQUxVRVMgKHtwbGFjZWhvbGRlcnN9KSIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIHZhbHVlcykKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgdGjDqm0gdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiB1cGRhdGVfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQsIGRhdGE6IERpY3Rbc3RyLCBBbnldKSAtPiBib29sOgogICAgICAgICIiIkPhuq1wIG5o4bqtdCB0aMO0bmcgdGluIHTDoGkga2hv4bqjbiIiIgogICAgICAgICMgTOG6pXkgdMOgaSBraG/huqNuIGhp4buHbiB04bqhaQogICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgaWYgbm90IGFjY291bnQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IGThu68gbGnhu4d1CiAgICAgICAgYWNjb3VudC51cGRhdGUoZGF0YSkKICAgICAgICBhY2NvdW50WyJsYXN0X3VwZGF0ZSJdID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIAogICAgICAgICMgTMawdSBs4bqhaQogICAgICAgIHJldHVybiBzZWxmLmFkZF9hY2NvdW50KGFjY291bnQpCiAgICAKICAgIGRlZiBnZXRfYWNjb3VudChzZWxmLCBhY2NvdW50X2lkOiBpbnQpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiJM4bqleSB0aMO0bmcgdGluIGPhu6dhIG3hu5l0IHTDoGkga2hv4bqjbiB0aGVvIElEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IiwgKGFjY291bnRfaWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgaWYgImRpc2FibGVfZm9sbG93IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGZvbGxvdyB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICBpZiAiZm9sbG93X3RvZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSA9IGludChhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSkgaWYgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gZWxzZSAwCiAgICAgICAgaWYgImZvbGxvd19pbl9zZXNzaW9uIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdID0gaW50KGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0pIGlmIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gZWxzZSAwCiAgICAgICAgaWYgIm1heF9mb2xsb3dfZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJtYXhfZm9sbG93X2RheSJdID0gaW50KGFjY291bnRbIm1heF9mb2xsb3dfZGF5Il0pIGlmIGFjY291bnRbIm1heF9mb2xsb3dfZGF5Il0gZWxzZSAyMAogICAgICAgIGlmICJtYXhfZm9sbG93X3Nlc3Npb24iIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbIm1heF9mb2xsb3dfc2Vzc2lvbiJdID0gaW50KGFjY291bnRbIm1heF9mb2xsb3dfc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJtYXhfZm9sbG93X3Nlc3Npb24iXSBlbHNlIDUKICAgICAgICBpZiAibGFzdF9mb2xsb3dfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGNhcmUgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImxhc3RfY2FyZV90aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0pIGlmIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gZWxzZSAwCiAgICAgICAgaWYgImxhc3Rfdmlld19zdG9yaWVzIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdID0gaW50KGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0pIGlmIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gZWxzZSAwCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudF9ieV91dWlkKHNlbGYsIGFjY291bnRfdXVpZDogc3RyKSAtPiBPcHRpb25hbFtEaWN0W3N0ciwgQW55XV06CiAgICAgICAgIiIiTOG6pXkgdGjDtG5nIHRpbiBj4bunYSBt4buZdCB0w6BpIGtob+G6o24gdGhlbyBVVUlEIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gYWNjb3VudHMgV0hFUkUgYWNjb3VudF91dWlkID0gPyIsIChhY2NvdW50X3V1aWQsKSkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHQgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgIAogICAgICAgIGlmIG5vdCByZXN1bHQ6CiAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkgY8OhYyB0csaw4budbmcgYm9vbGVhbgogICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgYWNjb3VudFsiam9iX2VuYWJsZSJdID0gYm9vbChhY2NvdW50WyJqb2JfZW5hYmxlIl0pCiAgICAgICAgYWNjb3VudFsiaXNfZ29saWtlX2xpbmtlZCJdID0gYm9vbChhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0pCiAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgaWYgImRpc2FibGVfZm9sbG93IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdID0gYm9vbChhY2NvdW50WyJkaXNhYmxlX2ZvbGxvdyJdKQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGZvbGxvdyB0aMOgbmgga2nhu4N1IGThu68gbGnhu4d1IHBow7kgaOG7o3AKICAgICAgICBpZiAiZm9sbG93X3RvZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSA9IGludChhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSkgaWYgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gZWxzZSAwCiAgICAgICAgaWYgImZvbGxvd19pbl9zZXNzaW9uIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfaW5fc2Vzc2lvbiJdID0gaW50KGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0pIGlmIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gZWxzZSAwCiAgICAgICAgaWYgIm1heF9mb2xsb3dfZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJtYXhfZm9sbG93X2RheSJdID0gaW50KGFjY291bnRbIm1heF9mb2xsb3dfZGF5Il0pIGlmIGFjY291bnRbIm1heF9mb2xsb3dfZGF5Il0gZWxzZSAyMAogICAgICAgIGlmICJtYXhfZm9sbG93X3Nlc3Npb24iIGluIGFjY291bnQ6CiAgICAgICAgICAgIGFjY291bnRbIm1heF9mb2xsb3dfc2Vzc2lvbiJdID0gaW50KGFjY291bnRbIm1heF9mb2xsb3dfc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJtYXhfZm9sbG93X3Nlc3Npb24iXSBlbHNlIDUKICAgICAgICBpZiAibGFzdF9mb2xsb3dfdGltZSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfZm9sbG93X3RpbWUiXSkgaWYgYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdIGVsc2UgMAogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGNhcmUgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgaWYgImxhc3RfY2FyZV90aW1lIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0pIGlmIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gZWxzZSAwCiAgICAgICAgaWYgImxhc3Rfdmlld19zdG9yaWVzIiBpbiBhY2NvdW50OgogICAgICAgICAgICBhY2NvdW50WyJsYXN0X3ZpZXdfc3RvcmllcyJdID0gaW50KGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0pIGlmIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gZWxzZSAwCiAgICAgICAgCiAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZXh0cmFfZGF0YSA9IGpzb24ubG9hZHMoYWNjb3VudFsiZGF0YSJdKQogICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBhY2NvdW50OgogICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBhY2NvdW50CiAgICAKICAgIGRlZiBnZXRfYWNjb3VudHMoc2VsZiwgYXBwOiBzdHIgPSBOb25lLCBzdGF0dXM6IHN0ciA9IE5vbmUsIGpvYl9lbmFibGU6IGJvb2wgPSBOb25lLCBkZXZpY2VfaWQ6IEFueSA9IFRydWUpIC0+IExpc3RbRGljdFtzdHIsIEFueV1dOgogICAgICAgICIiIkzhuqV5IGRhbmggc8OhY2ggdMOgaSBraG/huqNuIHRoZW8gxJFp4buBdSBraeG7h24gbOG7jWMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHA6IFTDqm4g4bupbmcgZOG7pW5nIMSR4buDIGzhu41jCiAgICAgICAgICAgIHN0YXR1czogVHLhuqFuZyB0aMOhaSB0w6BpIGtob+G6o24gxJHhu4MgbOG7jWMKICAgICAgICAgICAgam9iX2VuYWJsZTogTOG7jWMgdGhlbyB0cuG6oW5nIHRow6FpIGLhuq10L3Thuq90IGpvYgogICAgICAgICAgICBkZXZpY2VfaWQ6IEzhu41jIHRoZW8gZGV2aWNlX2lkLCBjw7MgdGjhu4MgbMOgOgogICAgICAgICAgICAgICAgLSBUcnVlOiBM4buNYyB0aGVvIGRldmljZV9pZCBj4bunYSB0aGnhur90IGLhu4sgaGnhu4duIHThuqFpICht4bq3YyDEkeG7i25oKQogICAgICAgICAgICAgICAgLSBGYWxzZS9Ob25lOiBLaMO0bmcgbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIC0gQ2h14buXaTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7pSB0aOG7gyDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgcXVlcnkgPSAiU0VMRUNUICogRlJPTSBhY2NvdW50cyIKICAgICAgICBwYXJhbXMgPSBbXQogICAgICAgIAogICAgICAgICMgVGjDqm0gxJFp4buBdSBraeG7h24gbOG7jWMKICAgICAgICBjb25kaXRpb25zID0gW10KICAgICAgICBpZiBhcHA6CiAgICAgICAgICAgIGNvbmRpdGlvbnMuYXBwZW5kKCJhcHAgPSA/IikKICAgICAgICAgICAgcGFyYW1zLmFwcGVuZChhcHApCiAgICAgICAgaWYgc3RhdHVzOgogICAgICAgICAgICBjb25kaXRpb25zLmFwcGVuZCgic3RhdHVzID0gPyIpCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoc3RhdHVzKQogICAgICAgIGlmIGpvYl9lbmFibGUgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGNvbmRpdGlvbnMuYXBwZW5kKCJqb2JfZW5hYmxlID0gPyIpCiAgICAgICAgICAgIHBhcmFtcy5hcHBlbmQoMSBpZiBqb2JfZW5hYmxlIGVsc2UgMCkKICAgICAgICAgICAgCiAgICAgICAgaWYgY29uZGl0aW9uczoKICAgICAgICAgICAgcXVlcnkgKz0gIiBXSEVSRSAiICsgIiBBTkQgIi5qb2luKGNvbmRpdGlvbnMpCiAgICAgICAgICAgIAogICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCBwYXJhbXMpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgICAgIGFjY291bnRbImpvYl9lbmFibGUiXSA9IGJvb2woYWNjb3VudFsiam9iX2VuYWJsZSJdKQogICAgICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgICAgIGlmICJkaXNhYmxlX2ZvbGxvdyIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImRpc2FibGVfZm9sbG93Il0gPSBib29sKGFjY291bnRbImRpc2FibGVfZm9sbG93Il0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBmb2xsb3cgdGjDoG5oIGtp4buDdSBk4buvIGxp4buHdSBwaMO5IGjhu6NwCiAgICAgICAgICAgIGlmICJmb2xsb3dfdG9kYXkiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSA9IGludChhY2NvdW50WyJmb2xsb3dfdG9kYXkiXSkgaWYgYWNjb3VudFsiZm9sbG93X3RvZGF5Il0gZWxzZSAwCiAgICAgICAgICAgIGlmICJmb2xsb3dfaW5fc2Vzc2lvbiIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImZvbGxvd19pbl9zZXNzaW9uIl0gPSBpbnQoYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSkgaWYgYWNjb3VudFsiZm9sbG93X2luX3Nlc3Npb24iXSBlbHNlIDAKICAgICAgICAgICAgaWYgIm1heF9mb2xsb3dfZGF5IiBpbiBhY2NvdW50OgogICAgICAgICAgICAgICAgYWNjb3VudFsibWF4X2ZvbGxvd19kYXkiXSA9IGludChhY2NvdW50WyJtYXhfZm9sbG93X2RheSJdKSBpZiBhY2NvdW50WyJtYXhfZm9sbG93X2RheSJdIGVsc2UgMjAKICAgICAgICAgICAgaWYgIm1heF9mb2xsb3dfc2Vzc2lvbiIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbIm1heF9mb2xsb3dfc2Vzc2lvbiJdID0gaW50KGFjY291bnRbIm1heF9mb2xsb3dfc2Vzc2lvbiJdKSBpZiBhY2NvdW50WyJtYXhfZm9sbG93X3Nlc3Npb24iXSBlbHNlIDUKICAgICAgICAgICAgaWYgImxhc3RfZm9sbG93X3RpbWUiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0gPSBpbnQoYWNjb3VudFsibGFzdF9mb2xsb3dfdGltZSJdKSBpZiBhY2NvdW50WyJsYXN0X2ZvbGxvd190aW1lIl0gZWxzZSAwCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBjYXJlIHRow6BuaCBraeG7g3UgZOG7ryBsaeG7h3UgcGjDuSBo4bujcAogICAgICAgICAgICBpZiAibGFzdF9jYXJlX3RpbWUiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBhY2NvdW50WyJsYXN0X2NhcmVfdGltZSJdID0gaW50KGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0pIGlmIGFjY291bnRbImxhc3RfY2FyZV90aW1lIl0gZWxzZSAwCiAgICAgICAgICAgIGlmICJsYXN0X3ZpZXdfc3RvcmllcyIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImxhc3Rfdmlld19zdG9yaWVzIl0gPSBpbnQoYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSkgaWYgYWNjb3VudFsibGFzdF92aWV3X3N0b3JpZXMiXSBlbHNlIDAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudCBhbmQgYWNjb3VudFsiZGF0YSJdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGFjY291bnRbImRhdGEiXSkKICAgICAgICAgICAgICAgICAgICBhY2NvdW50LnVwZGF0ZShleHRyYV9kYXRhKQogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgICAgICBpZiAiZGF0YSIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGRlbCBhY2NvdW50WyJkYXRhIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICBhY2NvdW50cy5hcHBlbmQoYWNjb3VudCkKICAgICAgICAKICAgICAgICAjIEzhu41jIHRoZW8gZGV2aWNlX2lkIG7hur91IGPhuqduCiAgICAgICAgaWYgZGV2aWNlX2lkIGlzIFRydWU6CiAgICAgICAgICAgICMgTOG6pXkgZGV2aWNlX2lkIGPhu6dhIHRoaeG6v3QgYuG7iyBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY3VycmVudF9kZXZpY2VfaWQgPSBzZWxmLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBjdXJyZW50X2RldmljZV9pZDoKICAgICAgICAgICAgICAgICMgTOG7jWMgdMOgaSBraG/huqNuIHRoZW8gZGV2aWNlX2lkIGPhu6dhIHRoaeG6v3QgYuG7iyBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIGFjY291bnRzID0gW2FjYyBmb3IgYWNjIGluIGFjY291bnRzIGlmIGFjYy5nZXQoImRldmljZV9pZCIpID09IGN1cnJlbnRfZGV2aWNlX2lkXQogICAgICAgIGVsaWYgaXNpbnN0YW5jZShkZXZpY2VfaWQsIHN0cikgYW5kIGRldmljZV9pZDoKICAgICAgICAgICAgIyBM4buNYyB0aGVvIGRldmljZV9pZCBj4bulIHRo4buDIMSRxrDhu6NjIHRydXnhu4FuIHbDoG8KICAgICAgICAgICAgYWNjb3VudHMgPSBbYWNjIGZvciBhY2MgaW4gYWNjb3VudHMgaWYgYWNjLmdldCgiZGV2aWNlX2lkIikgPT0gZGV2aWNlX2lkXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gYWNjb3VudHMKICAgIAogICAgZGVmIGRlbGV0ZV9hY2NvdW50KHNlbGYsIGFjY291bnRfaWQ6IGludCkgLT4gYm9vbDoKICAgICAgICAiIiJYw7NhIHTDoGkga2hv4bqjbiBraOG7j2kgZGF0YWJhc2UiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKCJERUxFVEUgRlJPTSBhY2NvdW50cyBXSEVSRSBpZCA9ID8iLCAoYWNjb3VudF9pZCwpKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBjdXJzb3Iucm93Y291bnQgPiAwCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSB4w7NhIHTDoGkga2hv4bqjbjoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBjbG9zZShzZWxmKToKICAgICAgICAiIiLEkMOzbmcga+G6v3QgbuG7kWkgZGF0YWJhc2UgY+G7p2EgdGhyZWFkIGhp4buHbiB04bqhaSIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLmxvY2FsLCAnY29ubicpIGFuZCBzZWxmLmxvY2FsLmNvbm46CiAgICAgICAgICAgICAgICBzZWxmLmxvY2FsLmNvbm4uY2xvc2UoKQogICAgICAgICAgICAgICAgc2VsZi5sb2NhbC5jb25uID0gTm9uZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSBjw6FjIHRoYW0gY2hp4bq/dSB0aHJlYWQgxJHhu4MgdHLDoW5oIGzhu5dpCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2xvY2FsJyk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYubG9jYWwsICdfbG9jYWxfX2ltcGwnKToKICAgICAgICAgICAgICAgICAgICAjIFjDs2EgdGhhbSBjaGnhur91IHRyb25nIFRocmVhZExvY2FsCiAgICAgICAgICAgICAgICAgICAgZGVsYXR0cihzZWxmLmxvY2FsLCAnX2xvY2FsX19pbXBsJykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIMSRw7NuZyBr4bq/dCBu4buRaSBkYXRhYmFzZToge2V9IikKICAgICAgICAgICAgCiAgICBkZWYgX19kZWxfXyhzZWxmKToKICAgICAgICAiIiJI4buneSDEkeG7kWkgdMaw4bujbmciIiIKICAgICAgICBzZWxmLmNsb3NlKCkKICAgIAogICAgZGVmIHVwZGF0ZV9vcl9pbnNlcnRfYWNjb3VudChzZWxmLCBhcHBfbmFtZTogc3RyLCB1bmlxdWVfaWQ6IHN0ciwgZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgQ+G6rXAgbmjhuq10IGhv4bq3YyB0aMOqbSBt4bubaSBt4buZdCB0w6BpIGtob+G6o24gdsOgbyBkYXRhYmFzZQogICAgICAgICIiIgogICAgICAgICMgxJDhuqNtIGLhuqNvIGNvbm5lY3Rpb24gbMOgIGPhu6dhIHRocmVhZCBoaeG7h24gdOG6oWkKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIHhlbSB0w6BpIGtob+G6o24gxJHDoyB04buTbiB04bqhaSBjaMawYQogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICIiIlNFTEVDVCBpZCBGUk9NIGFjY291bnRzIFdIRVJFIGFwcF9uYW1lID0gPyBBTkQgdW5pcXVlX2lkID0gPyIiIiwgCiAgICAgICAgICAgICAgICAoYXBwX25hbWUsIHVuaXF1ZV9pZCkKICAgICAgICAgICAgKQogICAgICAgICAgICBhY2NvdW50ID0gY3Vyc29yLmZldGNob25lKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIGFjY291bnQ6CiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0w6BpIGtob+G6o24gaGnhu4duIGPDswogICAgICAgICAgICAgICAgYWNjb3VudF9pZCA9IGFjY291bnRbMF0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBM4bqleSBk4buvIGxp4buHdSBoaeG7h24gdOG6oWkKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIlNFTEVDVCBkYXRhIEZST00gYWNjb3VudHMgV0hFUkUgaWQgPSA/IiIiLAogICAgICAgICAgICAgICAgICAgIChhY2NvdW50X2lkLCkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGN1cnJlbnRfZGF0YV9yb3cgPSBjdXJzb3IuZmV0Y2hvbmUoKQogICAgICAgICAgICAgICAgY3VycmVudF9kYXRhID0ganNvbi5sb2FkcyhjdXJyZW50X2RhdGFfcm93WzBdKSBpZiBjdXJyZW50X2RhdGFfcm93IGVsc2Uge30KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBI4bujcCBuaOG6pXQgZOG7ryBsaeG7h3UgY8WpIHbDoCBt4bubaQogICAgICAgICAgICAgICAgbWVyZ2VkX2RhdGEgPSB7KipjdXJyZW50X2RhdGEsICoqZGF0YX0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQKICAgICAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgICAgICIiIlVQREFURSBhY2NvdW50cyBTRVQgCiAgICAgICAgICAgICAgICAgICAgICAgZGF0YSA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgbmlja25hbWUgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cyA9ID8sCiAgICAgICAgICAgICAgICAgICAgICAgaXNfbG9naW4gPSA/LAogICAgICAgICAgICAgICAgICAgICAgIGpvYl9lbmFibGUgPSA/LAogICAgICAgICAgICAgICAgICAgICAgIGpvYl9tYXhfZGF5ID0gPywKICAgICAgICAgICAgICAgICAgICAgICBsYXN0X3VwZGF0ZSA9ID8KICAgICAgICAgICAgICAgICAgICAgICBXSEVSRSBpZCA9ID8iIiIsCiAgICAgICAgICAgICAgICAgICAgKAogICAgICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXBzKG1lcmdlZF9kYXRhKSwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoIm5pY2tuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgic3RhdHVzIiwgImFjdGl2ZSIpLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIDEgaWYgZGF0YS5nZXQoImpvYl9lbmFibGUiLCBUcnVlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJqb2JfbWF4X2RheSIsIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZKSwKICAgICAgICAgICAgICAgICAgICAgICAgaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICAgICAgICAgYWNjb3VudF9pZAogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgVGjDqm0gdMOgaSBraG/huqNuIG3hu5tpCiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgKICAgICAgICAgICAgICAgICAgICAiIiJJTlNFUlQgSU5UTyBhY2NvdW50cyAoCiAgICAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUsIHVuaXF1ZV9pZCwgbmlja25hbWUsIGRhdGEsIHN0YXR1cywgaXNfbG9naW4sIGpvYl9lbmFibGUsIGpvYl9tYXhfZGF5LCBpc19nb2xpa2VfbGlua2VkLCBnb2xpa2VfaWQsIGxhc3RfdXBkYXRlCiAgICAgICAgICAgICAgICAgICAgKSBWQUxVRVMgKD8sID8sID8sID8sID8sID8sID8sID8sID8sID8sID8pIiIiLAogICAgICAgICAgICAgICAgICAgICgKICAgICAgICAgICAgICAgICAgICAgICAgYXBwX25hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgIHVuaXF1ZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5nZXQoIm5pY2tuYW1lIiwgIiIpLAogICAgICAgICAgICAgICAgICAgICAgICBqc29uLmR1bXBzKGRhdGEpLAogICAgICAgICAgICAgICAgICAgICAgICBkYXRhLmdldCgic3RhdHVzIiwgImFjdGl2ZSIpLAogICAgICAgICAgICAgICAgICAgICAgICAxIGlmIGRhdGEuZ2V0KCJpc19sb2dpbiIsIEZhbHNlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIDEgaWYgZGF0YS5nZXQoImpvYl9lbmFibGUiLCBUcnVlKSBlbHNlIDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEuZ2V0KCJqb2JfbWF4X2RheSIsIGNvbmZpZy5NQVhfSk9CU19QRVJfREFZKSwKICAgICAgICAgICAgICAgICAgICAgICAgMCwgICMgaXNfZ29saWtlX2xpbmtlZAogICAgICAgICAgICAgICAgICAgICAgICAiIiwgIyBnb2xpa2VfaWQKICAgICAgICAgICAgICAgICAgICAgICAgaW50KHRpbWUudGltZSgpKQogICAgICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbm4uY29tbWl0KCkKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBj4bqtcCBuaOG6rXQvdGjDqm0gdMOgaSBraG/huqNuOiB7ZX0iKQogICAgICAgICAgICBjb25uLnJvbGxiYWNrKCkKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiByZXNldF9sb2dpbl9zdGF0dXNfYnlfYXBwKHNlbGYsIGFwcF9uYW1lOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgxJDhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW4gY2hvIHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGPhu6dhIG3hu5l0IOG7qW5nIGThu6VuZwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGFwcF9uYW1lOiBUw6puIOG7qW5nIGThu6VuZyAoYXBwLCBraMO0bmcgcGjhuqNpIGFwcF9uYW1lKQogICAgICAgICIiIgogICAgICAgICMgxJDhuqNtIGLhuqNvIGNvbm5lY3Rpb24gbMOgIGPhu6dhIHRocmVhZCBoaeG7h24gdOG6oWkKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkOG6t3QgbOG6oWkgdHLhuqFuZyB0aMOhaSBsb2dpbiBjaG8gdOG6pXQgY+G6oyB0w6BpIGtob+G6o24gdsOgIMSRw6FuaCBk4bqldSBj4bqnbiDEkeG7k25nIGLhu5kKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiIiJVUERBVEUgYWNjb3VudHMgU0VUIGlzX2xvZ2luID0gMCwgaXNfc3luYyA9IDAgV0hFUkUgYXBwID0gPyIiIiwKICAgICAgICAgICAgICAgIChhcHBfbmFtZSwpCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ8WpbmcgY+G6rXAgbmjhuq10IHRyxrDhu51uZyBpc19sb2dpbiB0cm9uZyBkYXRhIEpTT04KICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAiIiJTRUxFQ1QgaWQsIGRhdGEgRlJPTSBhY2NvdW50cyBXSEVSRSBhcHAgPSA/IiIiLAogICAgICAgICAgICAgICAgKGFwcF9uYW1lLCkKICAgICAgICAgICAgKQogICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMgPSBjdXJzb3IuZmV0Y2hhbGwoKQogICAgICAgICAgICBmb3IgYWNjb3VudCBpbiBhY2NvdW50czoKICAgICAgICAgICAgICAgIGFjY291bnRfaWQgPSBhY2NvdW50WzBdCiAgICAgICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkcyhhY2NvdW50WzFdKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEPhuq1wIG5o4bqtdCB0cuG6oW5nIHRow6FpIGxvZ2luIHRyb25nIGRhdGEKICAgICAgICAgICAgICAgIGRhdGFbImlzX2xvZ2luIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgICAgICAgICBkYXRhWyJpc19zeW5jIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEzGsHUgbOG6oWkgZGF0YQogICAgICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICAgICAgICAgIiIiVVBEQVRFIGFjY291bnRzIFNFVCBkYXRhID0gPyBXSEVSRSBpZCA9ID8iIiIsCiAgICAgICAgICAgICAgICAgICAgKGpzb24uZHVtcHMoZGF0YSksIGFjY291bnRfaWQpCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgxJHhurd0IGzhuqFpIHRy4bqhbmcgdGjDoWkgbG9naW46IHtlfSIpCiAgICAgICAgICAgIGNvbm4ucm9sbGJhY2soKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIGFkZF9qb2JfaGlzdG9yeShzZWxmLCBqb2JfZGF0YTogRGljdFtzdHIsIEFueV0pIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBUaMOqbSBt4buZdCBi4bqjbiBnaGkgbOG7i2NoIHPhu60gam9iIG3hu5tpCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgam9iX2RhdGE6IEThu68gbGnhu4d1IGpvYiBj4bqnbiBsxrB1CiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogVVVJRCBj4bunYSBqb2IgxJHDoyB0aMOqbQogICAgICAgICIiIgogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIGN1cnJlbnRfdGltZSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICBqb2JfdXVpZCA9IGpvYl9kYXRhLmdldCgiam9iX3V1aWQiLCBzdHIodXVpZC51dWlkNCgpKSkKICAgICAgICAKICAgICAgICAjIE7hur91IGtow7RuZyBjw7MgZGV2aWNlX2lkLCBz4butIGThu6VuZyBkZXZpY2VfaWQgaGnhu4duIHThuqFpCiAgICAgICAgZGV2aWNlX2lkID0gam9iX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgIGlmIG5vdCBkZXZpY2VfaWQ6CiAgICAgICAgICAgIGRldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIAogICAgICAgICMgVMOhY2ggZOG7ryBsaeG7h3UgY2jDrW5oIHbDoCBk4buvIGxp4buHdSBwaOG7pQogICAgICAgIG1haW5fZGF0YSA9IHsKICAgICAgICAgICAgImpvYl91dWlkIjogam9iX3V1aWQsCiAgICAgICAgICAgICJhY2NvdW50X3V1aWQiOiBqb2JfZGF0YS5nZXQoImFjY291bnRfdXVpZCIsICIiKSwKICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgImFwcCI6IGpvYl9kYXRhLmdldCgiYXBwIiwgIiIpLAogICAgICAgICAgICAiam9iX2lkIjogam9iX2RhdGEuZ2V0KCJqb2JfaWQiLCAiIiksCiAgICAgICAgICAgICJqb2JfdHlwZSI6IGpvYl9kYXRhLmdldCgiam9iX3R5cGUiLCAiIiksCiAgICAgICAgICAgICJvYmplY3RfaWQiOiBqb2JfZGF0YS5nZXQoIm9iamVjdF9pZCIsICIiKSwKICAgICAgICAgICAgImxpbmsiOiBqb2JfZGF0YS5nZXQoImxpbmsiLCAiIiksCiAgICAgICAgICAgICJzdGF0dXMiOiBqb2JfZGF0YS5nZXQoInN0YXR1cyIsIDApLAogICAgICAgICAgICAic3VjY2VzcyI6IDEgaWYgam9iX2RhdGEuZ2V0KCJzdWNjZXNzIiwgRmFsc2UpIGVsc2UgMCwKICAgICAgICAgICAgInByaWNlIjogam9iX2RhdGEuZ2V0KCJwcmljZSIsIDAuMCksCiAgICAgICAgICAgICJlcnJvcl9tZXNzYWdlIjogam9iX2RhdGEuZ2V0KCJlcnJvcl9tZXNzYWdlIiwgIiIpLAogICAgICAgICAgICAiY3JlYXRlZF9hdCI6IGpvYl9kYXRhLmdldCgiY3JlYXRlZF9hdCIsIGN1cnJlbnRfdGltZSksCiAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGN1cnJlbnRfdGltZSwKICAgICAgICAgICAgImlzX3N5bmMiOiAwICAjIE3hurdjIMSR4buLbmggY2jGsGEgxJHhu5NuZyBi4buZCiAgICAgICAgfQogICAgICAgIAogICAgICAgICMgTMawdSBJRCB04burIGThu68gbGnhu4d1IMSR4bqndSB2w6BvIG7hur91IGPDswogICAgICAgIGlmICJpZCIgaW4gam9iX2RhdGE6CiAgICAgICAgICAgIG1haW5fZGF0YVsiaWQiXSA9IGpvYl9kYXRhWyJpZCJdCiAgICAgICAgCiAgICAgICAgIyBMxrB1IGThu68gbGnhu4d1IHBo4bulIGTGsOG7m2kgZOG6oW5nIEpTT04KICAgICAgICBleHRyYV9kYXRhID0ge2s6IHYgZm9yIGssIHYgaW4gam9iX2RhdGEuaXRlbXMoKSBpZiBrIG5vdCBpbiBtYWluX2RhdGEgYW5kIGsgIT0gImRhdGEifQogICAgICAgIGlmICJkYXRhIiBpbiBqb2JfZGF0YSBhbmQgaXNpbnN0YW5jZShqb2JfZGF0YVsiZGF0YSJdLCBkaWN0KToKICAgICAgICAgICAgZXh0cmFfZGF0YS51cGRhdGUoam9iX2RhdGFbImRhdGEiXSkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbHVtbnMgPSAiLCAiLmpvaW4obWFpbl9kYXRhLmtleXMoKSkKICAgICAgICAgICAgcGxhY2Vob2xkZXJzID0gIiwgIi5qb2luKFsiPyJdICogbGVuKG1haW5fZGF0YSkpCiAgICAgICAgICAgIAogICAgICAgICAgICB2YWx1ZXMgPSBsaXN0KG1haW5fZGF0YS52YWx1ZXMoKSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdsOgbyBjdeG7kWkKICAgICAgICAgICAgY29sdW1ucyArPSAiLCBkYXRhIgogICAgICAgICAgICBwbGFjZWhvbGRlcnMgKz0gIiwgPyIKICAgICAgICAgICAgdmFsdWVzLmFwcGVuZChqc29uLmR1bXBzKGV4dHJhX2RhdGEpKQogICAgICAgICAgICAKICAgICAgICAgICAgcXVlcnkgPSBmIklOU0VSVCBPUiBSRVBMQUNFIElOVE8gam9ic19oaXN0b3J5ICh7Y29sdW1uc30pIFZBTFVFUyAoe3BsYWNlaG9sZGVyc30pIgogICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZShxdWVyeSwgdmFsdWVzKQogICAgICAgICAgICBjb25uLmNvbW1pdCgpCiAgICAgICAgICAgIHJldHVybiBqb2JfdXVpZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgdGjDqm0gbOG7i2NoIHPhu60gam9iOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gIiIKICAgIAogICAgZGVmIHVwZGF0ZV9qb2JfaGlzdG9yeShzZWxmLCBqb2JfdXVpZDogc3RyLCBkYXRhOiBEaWN0W3N0ciwgQW55XSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiBs4buLY2ggc+G7rSBqb2IKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfdXVpZDogVVVJRCBj4bunYSBqb2IgY+G6p24gY+G6rXAgbmjhuq10CiAgICAgICAgICAgIGRhdGE6IEThu68gbGnhu4d1IGPhuq1wIG5o4bqtdAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGPhuq1wIG5o4bqtdCB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgICMgTOG6pXkgam9iIGhp4buHbiB04bqhaQogICAgICAgIGpvYiA9IHNlbGYuZ2V0X2pvYl9oaXN0b3J5KGpvYl91dWlkKQogICAgICAgIGlmIG5vdCBqb2I6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIAogICAgICAgICMgQ+G6rXAgbmjhuq10IGThu68gbGnhu4d1CiAgICAgICAgam9iLnVwZGF0ZShkYXRhKQogICAgICAgIGpvYlsibGFzdF91cGRhdGUiXSA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAKICAgICAgICAjIEzGsHUgbOG6oWkKICAgICAgICByZXR1cm4gYm9vbChzZWxmLmFkZF9qb2JfaGlzdG9yeShqb2IpKQogICAgCiAgICBkZWYgZ2V0X2pvYl9oaXN0b3J5KHNlbGYsIGpvYl91dWlkOiBzdHIpIC0+IE9wdGlvbmFsW0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSB0aMO0bmcgdGluIGzhu4tjaCBz4butIGpvYiB0aGVvIFVVSUQKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBqb2JfdXVpZDogVVVJRCBj4bunYSBqb2IgY+G6p24gbOG6pXkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgRGljdCBob+G6t2MgTm9uZTogVGjDtG5nIHRpbiBqb2IgbuG6v3UgdMOsbSB0aOG6pXksIE5vbmUgbuG6v3Uga2jDtG5nCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoIlNFTEVDVCAqIEZST00gam9ic19oaXN0b3J5IFdIRVJFIGpvYl91dWlkID0gPyIsIChqb2JfdXVpZCwpKQogICAgICAgIGNvbHVtbl9uYW1lcyA9IFtkZXNjcmlwdGlvblswXSBmb3IgZGVzY3JpcHRpb24gaW4gY3Vyc29yLmRlc2NyaXB0aW9uXQogICAgICAgIHJlc3VsdCA9IGN1cnNvci5mZXRjaG9uZSgpCiAgICAgICAgCiAgICAgICAgaWYgbm90IHJlc3VsdDoKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgCiAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICBqb2IgPSB7Y29sdW1uX25hbWVzW2ldOiByZXN1bHRbaV0gZm9yIGkgaW4gcmFuZ2UobGVuKGNvbHVtbl9uYW1lcykpfQogICAgICAgIAogICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGPDoWMgdHLGsOG7nW5nIGJvb2xlYW4KICAgICAgICBqb2JbInN1Y2Nlc3MiXSA9IGJvb2woam9iWyJzdWNjZXNzIl0pCiAgICAgICAgam9iWyJpc19zeW5jIl0gPSBib29sKGpvYlsiaXNfc3luYyJdKQogICAgICAgIAogICAgICAgICMgVGjDqm0gZOG7ryBsaeG7h3UgcGjhu6UgdOG7qyB0csaw4budbmcgZGF0YQogICAgICAgIGlmICJkYXRhIiBpbiBqb2IgYW5kIGpvYlsiZGF0YSJdOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2Fkcyhqb2JbImRhdGEiXSkKICAgICAgICAgICAgICAgIGpvYi51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAKICAgICAgICAjIFjDs2EgdHLGsOG7nW5nIGRhdGEgxJHhu4MgdHLDoW5oIHRyw7luZyBs4bq3cAogICAgICAgIGlmICJkYXRhIiBpbiBqb2I6CiAgICAgICAgICAgIGRlbCBqb2JbImRhdGEiXQogICAgICAgICAgICAKICAgICAgICByZXR1cm4gam9iCiAgICAKICAgIGRlZiBnZXRfam9iX2hpc3RvcnlfYnlfYWNjb3VudChzZWxmLCBhY2NvdW50X3V1aWQ6IHN0ciwgbGltaXQ6IGludCA9IDUwKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBs4buLY2ggc+G7rSBqb2IgY+G7p2EgbeG7mXQgdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgYWNjb3VudF91dWlkOiBVVUlEIGPhu6dhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBsaW1pdDogU+G7kSBsxrDhu6NuZyBi4bqjbiBnaGkgdOG7kWkgxJFhIHRy4bqjIHbhu4EKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgTGlzdFtEaWN0W3N0ciwgQW55XV06IERhbmggc8OhY2ggbOG7i2NoIHPhu60gam9iCiAgICAgICAgIiIiCiAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICBjdXJzb3IgPSBjb25uLmN1cnNvcigpCiAgICAgICAgCiAgICAgICAgY3Vyc29yLmV4ZWN1dGUoCiAgICAgICAgICAgICJTRUxFQ1QgKiBGUk9NIGpvYnNfaGlzdG9yeSBXSEVSRSBhY2NvdW50X3V1aWQgPSA/IE9SREVSIEJZIGNyZWF0ZWRfYXQgREVTQyBMSU1JVCA/IiwgCiAgICAgICAgICAgIChhY2NvdW50X3V1aWQsIGxpbWl0KQogICAgICAgICkKICAgICAgICBjb2x1bW5fbmFtZXMgPSBbZGVzY3JpcHRpb25bMF0gZm9yIGRlc2NyaXB0aW9uIGluIGN1cnNvci5kZXNjcmlwdGlvbl0KICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICBqb2JzID0gW10KICAgICAgICBmb3IgcmVzdWx0IGluIHJlc3VsdHM6CiAgICAgICAgICAgICMgQ2h1eeG7g24gxJHhu5VpIGvhur90IHF14bqjIHRow6BuaCBkaWN0CiAgICAgICAgICAgIGpvYiA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgICAgIGpvYlsic3VjY2VzcyJdID0gYm9vbChqb2JbInN1Y2Nlc3MiXSkKICAgICAgICAgICAgam9iWyJpc19zeW5jIl0gPSBib29sKGpvYlsiaXNfc3luYyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBk4buvIGxp4buHdSBwaOG7pSB04burIHRyxrDhu51uZyBkYXRhCiAgICAgICAgICAgIGlmICJkYXRhIiBpbiBqb2IgYW5kIGpvYlsiZGF0YSJdOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGV4dHJhX2RhdGEgPSBqc29uLmxvYWRzKGpvYlsiZGF0YSJdKQogICAgICAgICAgICAgICAgICAgIGpvYi51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGpvYjoKICAgICAgICAgICAgICAgIGRlbCBqb2JbImRhdGEiXQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGpvYnMuYXBwZW5kKGpvYikKICAgICAgICAgICAgCiAgICAgICAgcmV0dXJuIGpvYnMKICAgIAogICAgZGVmIGdldF9wZW5kaW5nX3N5bmNfaXRlbXMoc2VsZiwgdGFibGU6IHN0ciwgbGltaXQ6IGludCA9IDEwMCwgZGV2aWNlX2lkOiBBbnkgPSBUcnVlKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIGPDoWMgYuG6o24gZ2hpIGNoxrBhIMSRxrDhu6NjIMSR4buTbmcgYuG7mQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhYmxlOiBUw6puIGLhuqNuZyAoJ2FjY291bnRzJyBob+G6t2MgJ2pvYnNfaGlzdG9yeScpCiAgICAgICAgICAgIGxpbWl0OiBT4buRIGzGsOG7o25nIGLhuqNuIGdoaSB04buRaSDEkWEgdHLhuqMgduG7gQogICAgICAgICAgICBkZXZpY2VfaWQ6IFRoaeG6v3QgYuG7iyBJRCDEkeG7gyBs4buNYzoKICAgICAgICAgICAgICAgIC0gVHJ1ZTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgaGnhu4duIHThuqFpICht4bq3YyDEkeG7i25oKQogICAgICAgICAgICAgICAgLSBGYWxzZS9Ob25lOiBLaMO0bmcgbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICAgICAgICAgIC0gQ2h14buXaTogTOG7jWMgdGhlbyBkZXZpY2VfaWQgY+G7pSB0aOG7gyDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIExpc3RbRGljdFtzdHIsIEFueV1dOiBEYW5oIHPDoWNoIGLhuqNuIGdoaSBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAiIiIKICAgICAgICBpZiB0YWJsZSBub3QgaW4gWydhY2NvdW50cycsICdqb2JzX2hpc3RvcnknXToKICAgICAgICAgICAgcmV0dXJuIFtdCiAgICAgICAgICAgIAogICAgICAgIGNvbm4gPSBzZWxmLl9nZXRfY29ubmVjdGlvbigpCiAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgIAogICAgICAgIHV1aWRfZmllbGQgPSAiYWNjb3VudF91dWlkIiBpZiB0YWJsZSA9PSAiYWNjb3VudHMiIGVsc2UgImpvYl91dWlkIgogICAgICAgIAogICAgICAgICMgVGjDqm0gxJFp4buBdSBraeG7h24gbOG7jWMgdGhlbyBkZXZpY2VfaWQKICAgICAgICBpZiBkZXZpY2VfaWQgaXMgVHJ1ZToKICAgICAgICAgICAgIyBM4bqleSBkZXZpY2VfaWQgaGnhu4duIHThuqFpCiAgICAgICAgICAgIGN1cnJlbnRfZGV2aWNlX2lkID0gc2VsZi5nZXRfb3JfY3JlYXRlX2RldmljZV9pZCgpCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJTRUxFQ1QgKiBGUk9NIHt0YWJsZX0gV0hFUkUgaXNfc3luYyA9IDAgQU5EIGRldmljZV9pZCA9ID8gTElNSVQgPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIChjdXJyZW50X2RldmljZV9pZCwgbGltaXQpKQogICAgICAgIGVsaWYgZGV2aWNlX2lkOgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGRldmljZV9pZCDEkcaw4bujYyB0cnV54buBbiB2w6BvCiAgICAgICAgICAgIHF1ZXJ5ID0gZiJTRUxFQ1QgKiBGUk9NIHt0YWJsZX0gV0hFUkUgaXNfc3luYyA9IDAgQU5EIGRldmljZV9pZCA9ID8gTElNSVQgPyIKICAgICAgICAgICAgY3Vyc29yLmV4ZWN1dGUocXVlcnksIChkZXZpY2VfaWQsIGxpbWl0KSkKICAgICAgICBlbHNlOgogICAgICAgICAgICAjIEtow7RuZyBs4buNYyB0aGVvIGRldmljZV9pZAogICAgICAgICAgICBxdWVyeSA9IGYiU0VMRUNUICogRlJPTSB7dGFibGV9IFdIRVJFIGlzX3N5bmMgPSAwIExJTUlUID8iCiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCAobGltaXQsKSkKICAgICAgICAgICAgCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgaXRlbXMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgaXRlbSA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGl0ZW0gYW5kIGl0ZW1bImRhdGEiXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2FkcyhpdGVtWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgaXRlbS51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGl0ZW06CiAgICAgICAgICAgICAgICBkZWwgaXRlbVsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgaXRlbXMuYXBwZW5kKGl0ZW0pCiAgICAgICAgICAgIAogICAgICAgIHJldHVybiBpdGVtcwogICAgCiAgICBkZWYgbWFya19hc19zeW5jZWQoc2VsZiwgdGFibGU6IHN0ciwgdXVpZF92YWx1ZTogc3RyKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIMSQw6FuaCBk4bqldSBi4bqjbiBnaGkgxJHDoyDEkcaw4bujYyDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YWJsZTogVMOqbiBi4bqjbmcgKCdhY2NvdW50cycgaG/hurdjICdqb2JzX2hpc3RvcnknKQogICAgICAgICAgICB1dWlkX3ZhbHVlOiBHacOhIHRy4buLIFVVSUQgY+G7p2EgYuG6o24gZ2hpCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgY+G6rXAgbmjhuq10IHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgaWYgdGFibGUgbm90IGluIFsnYWNjb3VudHMnLCAnam9ic19oaXN0b3J5J106CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICB1dWlkX2ZpZWxkID0gImFjY291bnRfdXVpZCIgaWYgdGFibGUgPT0gImFjY291bnRzIiBlbHNlICJqb2JfdXVpZCIKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGN1cnNvci5leGVjdXRlKAogICAgICAgICAgICAgICAgZiJVUERBVEUge3RhYmxlfSBTRVQgaXNfc3luYyA9IDEgV0hFUkUge3V1aWRfZmllbGR9ID0gPyIsCiAgICAgICAgICAgICAgICAodXVpZF92YWx1ZSwpCiAgICAgICAgICAgICkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICByZXR1cm4gY3Vyc29yLnJvd2NvdW50ID4gMAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJM4buXaSBraGkgxJHDoW5oIGThuqV1IMSRw6MgxJHhu5NuZyBi4buZOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIGdldF9kZXZpY2VfY29uZmlnKHNlbGYsIGtleTogc3RyLCBkZWZhdWx0PU5vbmUpIC0+IEFueToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBrZXk6IEtow7NhIGPhuqV1IGjDrG5oCiAgICAgICAgICAgIGRlZmF1bHQ6IEdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaCBu4bq/dSBraMO0bmcgdMOsbSB0aOG6pXkKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgQW55OiBHacOhIHRy4buLIGPhuqV1IGjDrG5oIGhv4bq3YyBnacOhIHRy4buLIG3hurdjIMSR4buLbmgKICAgICAgICAiIiIKICAgICAgICAjIEzhuqV5IGPhuqV1IGjDrG5oIHThu6sgZGF0YWJhc2UKICAgICAgICByZXR1cm4gc2VsZi5nZXQoa2V5LCBkZWZhdWx0KQoKICAgIGRlZiBzZXRfZGV2aWNlX2NvbmZpZyhzZWxmLCBrZXk6IHN0ciwgdmFsdWU6IEFueSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBTZXQgYSBkZXZpY2UgY29uZmlndXJhdGlvbiB2YWx1ZSBpbiB0aGUgY29uZmlnIHRhYmxlCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAga2V5OiBUaGUgY29uZmlndXJhdGlvbiBrZXkKICAgICAgICAgICAgdmFsdWU6IFRoZSB2YWx1ZSB0byBzZXQKICAgICAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBpZiBzdWNjZXNzZnVsLCBGYWxzZSBvdGhlcndpc2UKICAgICAgICAiIiIKICAgICAgICByZXR1cm4gc2VsZi5zZXQoa2V5LCB2YWx1ZSkKCiAgICBkZWYgZ2V0X2FsbF9kZXZpY2VfY29uZmlnKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEdldCBhbGwgZGV2aWNlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogRGljdGlvbmFyeSBvZiBhbGwgZGV2aWNlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3MKICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICAjIEdldCBhbGwga2V5cyBzdGFydGluZyB3aXRoICJkZXZpY2VfIiBidXQgZXhjbHVkZSBkZXZpY2VfaW5mbwogICAgICAgIGN1cnNvci5leGVjdXRlKCJTRUxFQ1Qga2V5LCB2YWx1ZSBGUk9NIGNvbmZpZyBXSEVSRSBrZXkgIT0gJ2RldmljZV9pbmZvJyBBTkQga2V5ICE9ICdkZXZpY2VfaWQnIikKICAgICAgICByZXN1bHRzID0gY3Vyc29yLmZldGNoYWxsKCkKICAgICAgICAKICAgICAgICAjIEJ1aWxkIGNvbmZpZyBkaWN0aW9uYXJ5LCByZW1vdmluZyAiZGV2aWNlXyIgcHJlZml4IGZyb20ga2V5cwogICAgICAgIGRldmljZV9jb25maWcgPSB7fQogICAgICAgIGZvciBrZXksIHZhbHVlIGluIHJlc3VsdHM6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWdba2V5XSA9IGpzb24ubG9hZHModmFsdWUpCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIGRldmljZV9jb25maWdba2V5XSA9IHZhbHVlCiAgICAgICAgCiAgICAgICAgIyBJbXBvcnQgY29uZmlnIG1vZHVsZQogICAgICAgIGltcG9ydCBjb25maWcgYXMgY29uZmlnX21vZHVsZQogICAgICAgIAogICAgICAgICMgQWRkIGRlZmF1bHQgdmFsdWVzIGZvciBtaXNzaW5nIGNvbmZpZyBpdGVtcwogICAgICAgIGRlZmF1bHRfY29uZmlncyA9IHsKICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9kYXkiOiBjb25maWdfbW9kdWxlLk1BWF9KT0JTX1BFUl9EQVksCiAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGNvbmZpZ19tb2R1bGUuTUFYX0pPQlNfUEVSX1NFU1NJT04sCiAgICAgICAgICAgICJqb2JfaW50ZXJ2YWxfc2Vjb25kcyI6IGNvbmZpZ19tb2R1bGUuSk9CX0NIRUNLX0lOVEVSVkFMLAogICAgICAgICAgICAicmVwb3J0X2ludGVydmFsIjogY29uZmlnX21vZHVsZS5NUVRUX1JFUE9SVF9JTlRFUlZBTAogICAgICAgIH0KICAgICAgICAKICAgICAgICBmb3Iga2V5LCBkZWZhdWx0X3ZhbHVlIGluIGRlZmF1bHRfY29uZmlncy5pdGVtcygpOgogICAgICAgICAgICBpZiBrZXkgbm90IGluIGRldmljZV9jb25maWc6CiAgICAgICAgICAgICAgICBkZXZpY2VfY29uZmlnW2tleV0gPSBkZWZhdWx0X3ZhbHVlCiAgICAgICAgCiAgICAgICAgIyBMb+G6oWkgYuG7jyBjw6FjIHRyxrDhu51uZyBraMO0bmcgY+G6p24gdGhp4bq/dAogICAgICAgIGtleXNfdG9fcmVtb3ZlID0gWyJpZCIsICJnb2xpa2VfYXBpX2Jhc2UiXQogICAgICAgIGZvciBrZXkgaW4ga2V5c190b19yZW1vdmU6CiAgICAgICAgICAgIGlmIGtleSBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgZGVsIGRldmljZV9jb25maWdba2V5XQogICAgICAgIAogICAgICAgIHJldHVybiBkZXZpY2VfY29uZmlnCgogICAgZGVmIHNhdmVfZGV2aWNlX2NvbmZpZyhzZWxmLCBjb25maWdfZGljdDogRGljdFtzdHIsIEFueV0pIC0+IGJvb2w6CiAgICAgICAgIiIiCiAgICAgICAgTMawdSBuaGnhu4F1IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyBjw7luZyBsw7pjCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgY29uZmlnX2RpY3Q6IERpY3Rpb25hcnkgY2jhu6lhIGPDoWMgY+G6t3Aga2V5LXZhbHVlIGPhuqV1IGjDrG5oCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIGJvb2w6IFRydWUgbuG6v3UgdGjDoG5oIGPDtG5nLCBGYWxzZSBu4bq/dSB0aOG6pXQgYuG6oWkKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGNvbmZpZ19kaWN0Lml0ZW1zKCk6CiAgICAgICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKGtleSwgdmFsdWUpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBsxrB1IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAKICAgIGRlZiBpbml0X2RlZmF1bHRfY29uZmlnKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEto4bufaSB04bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIGNobyB0aGnhur90IGLhu4sKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBEaWN0W3N0ciwgQW55XTogQ+G6pXUgaMOsbmggxJHDoyBraOG7n2kgdOG6oW8KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgVOG6oW8gY+G6pXUgaMOsbmggbeG6t2MgxJHhu4tuaAogICAgICAgICAgICBkZWZhdWx0X2NvbmZpZyA9IHsKICAgICAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggY2h1bmcKICAgICAgICAgICAgICAgICJzeW5jX2ludGVydmFsIjogY29uZmlnLlNZTkNfSU5URVJWQUwsCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6pXUgaMOsbmggY2hvIGpvYgogICAgICAgICAgICAgICAgImpvYl9jaGVja19pbnRlcnZhbCI6IGNvbmZpZy5KT0JfQ0hFQ0tfSU5URVJWQUwsCiAgICAgICAgICAgICAgICAiam9iX2hvdXIiOiBjb25maWcuSk9CX0hPVVIsCiAgICAgICAgICAgICAgICAiam9iX2Nvb2xkb3duX21pbnV0ZXMiOiBjb25maWcuREVGQVVMVF9DT09MRE9XTl9NSU5VVEVTLAogICAgICAgICAgICAgICAgIm1heF9qb2JzX3Blcl9kYXkiOiBjb25maWcuTUFYX0pPQlNfUEVSX0RBWSwKICAgICAgICAgICAgICAgICJtYXhfam9ic19wZXJfc2Vzc2lvbiI6IGNvbmZpZy5NQVhfSk9CU19QRVJfU0VTU0lPTiwKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBEYW5oIHPDoWNoIGPDoWMgYXBwIMSRxrDhu6NjIGvDrWNoIGhv4bqhdAogICAgICAgICAgICAgICAgImVuYWJsZWRfYXBwcyI6IGNvbmZpZy5FTkFCTEVEX0FQUFMsCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIHbDoG8gZGF0YWJhc2UKICAgICAgICAgICAgZm9yIGtleSwgdmFsdWUgaW4gZGVmYXVsdF9jb25maWcuaXRlbXMoKToKICAgICAgICAgICAgICAgICMgQ2jhu4kgbMawdSBu4bq/dSBjaMawYSBjw7MgdHJvbmcgZGF0YWJhc2UKICAgICAgICAgICAgICAgIGlmIHNlbGYuZ2V0X2RldmljZV9jb25maWcoa2V5KSBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2V0X2RldmljZV9jb25maWcoa2V5LCB2YWx1ZSkKICAgICAgICAgICAgCiAgICAgICAgICAgIHByaW50KCLEkMOjIGto4bufaSB04bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oIGNobyB0aGnhur90IGLhu4siKQogICAgICAgICAgICByZXR1cm4gZGVmYXVsdF9jb25maWcKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGto4bufaSB04bqhbyBj4bqldSBow6xuaCBt4bq3YyDEkeG7i25oOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4ge30KICAgICAgICAgICAgCiAgICBkZWYgZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoc2VsZikgLT4gc3RyOgogICAgICAgICIiIgogICAgICAgIEzhuqV5IGhv4bq3YyB04bqhbyBkZXZpY2VfaWQKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IGRldmljZV9pZAogICAgICAgICIiIgogICAgICAgICMgS2nhu4NtIHRyYSB4ZW0gY8OzIGRldmljZV9pZCB0cm9uZyBkYXRhYmFzZSBraMO0bmcKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmdldF9kZXZpY2VfY29uZmlnKCJkZXZpY2VfaWQiLCAiIikKICAgICAgICBpZiBkZXZpY2VfaWQ6CiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAgICAgCiAgICAgICAgIyBUaOG7rSBs4bqleSBkZXZpY2VfaWQgdOG7qyBo4buHIHRo4buRbmcKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLl9nZXRfZGV2aWNlX2lkX2Zyb21fc3lzdGVtKCkKICAgICAgICBpZiBkZXZpY2VfaWQ6CiAgICAgICAgICAgICMgTMawdSB2w6BvIGPhuqV1IGjDrG5oIHbDoCB0cuG6oyB24buBCiAgICAgICAgICAgIHByaW50KGYixJDDoyBs4bqleSDEkcaw4bujYyBkZXZpY2VfaWQgdOG7qyBo4buHIHRo4buRbmc6IHtkZXZpY2VfaWR9IikKICAgICAgICAgICAgc2VsZi5zZXRfZGV2aWNlX2NvbmZpZygiZGV2aWNlX2lkIiwgZGV2aWNlX2lkKQogICAgICAgICAgICByZXR1cm4gZGV2aWNlX2lkCiAgICAgICAgICAgIAogICAgICAgICMgVGjhu60gbOG6pXkgZGV2aWNlX2lkIHThu6sgaGVscGVyIHNlcnZpY2UKICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLl9nZXRfZGV2aWNlX2lkX2Zyb21faGVscGVyKCkKICAgICAgICBpZiBkZXZpY2VfaWQ6CiAgICAgICAgICAgICMgTMawdSB2w6BvIGPhuqV1IGjDrG5oIHbDoCB0cuG6oyB24buBCiAgICAgICAgICAgIHByaW50KGYixJDDoyBs4bqleSDEkcaw4bujYyBkZXZpY2VfaWQgdOG7qyBoZWxwZXIgc2VydmljZToge2RldmljZV9pZH0iKQogICAgICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKCJkZXZpY2VfaWQiLCBkZXZpY2VfaWQpCiAgICAgICAgICAgIHJldHVybiBkZXZpY2VfaWQKICAgICAgICAgICAgCiAgICAgICAgIyBO4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2MsIHThuqFvIG3hu5tpCiAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgIGltcG9ydCBzdHJpbmcKICAgICAgICByYW5kb21faWQgPSAnJy5qb2luKHJhbmRvbS5jaG9pY2VzKHN0cmluZy5hc2NpaV9sb3dlcmNhc2UgKyBzdHJpbmcuZGlnaXRzLCBrPTEwKSkKICAgICAgICBkZXZpY2VfaWQgPSBmInJhbmRvbV97cmFuZG9tX2lkfSIKICAgICAgICBwcmludChmIktow7RuZyBs4bqleSDEkcaw4bujYyBkZXZpY2VfaWQgYuG6sW5nIGPDoWMgY8OhY2ggdHLDqm4sIHThuqFvIG3hu5tpOiB7ZGV2aWNlX2lkfSIpCiAgICAgICAgCiAgICAgICAgIyBMxrB1IHbDoG8gY+G6pXUgaMOsbmgKICAgICAgICBzZWxmLnNldF9kZXZpY2VfY29uZmlnKCJkZXZpY2VfaWQiLCBkZXZpY2VfaWQpCiAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgIAogICAgZGVmIF9nZXRfZGV2aWNlX2lkX2Zyb21fc3lzdGVtKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkZXZpY2VfaWQgdOG7qyBo4buHIHRo4buRbmcgKHPhu60gZOG7pW5nIGzhu4duaCBnZXRwcm9wKQogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIHN0cjogZGV2aWNlX2lkIGhv4bq3YyBjaHXhu5dpIHLhu5duZyBu4bq/dSBraMO0bmcgbOG6pXkgxJHGsOG7o2MKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBzdWJwcm9jZXNzCiAgICAgICAgICAgIHJlc3VsdCA9IHN1YnByb2Nlc3MucnVuKFsiZ2V0cHJvcCIsICJyby5zZXJpYWxubyJdLCBjYXB0dXJlX291dHB1dD1UcnVlLCB0ZXh0PVRydWUpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHJlc3VsdC5zdGRvdXQuc3RyaXAoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgZGV2aWNlX2lkIGFuZCBkZXZpY2VfaWQgIT0gInVua25vd24iOgogICAgICAgICAgICAgICAgcmV0dXJuIGRldmljZV9pZAogICAgICAgICAgICByZXR1cm4gIiIKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIGzhuqV5IGRldmljZV9pZCB04burIGjhu4cgdGjhu5FuZzoge2V9IikKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgICAgIAogICAgZGVmIF9nZXRfZGV2aWNlX2lkX2Zyb21faGVscGVyKHNlbGYpIC0+IHN0cjoKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkZXZpY2VfaWQgdOG7qyBoZWxwZXIgc2VydmljZSAoYW5kcm9pZF9pZCkKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBzdHI6IGRldmljZV9pZCBob+G6t2MgY2h14buXaSBy4buXbmcgbuG6v3Uga2jDtG5nIGzhuqV5IMSRxrDhu6NjCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEPhuqduIGltcG9ydCBIZWxwZXJTZXJ2aWNlIHThuqFpIMSRw6J5IMSR4buDIHRyw6FuaCBpbXBvcnQgdsOybmcKICAgICAgICAgICAgZnJvbSBzZXJ2aWNlcy5oZWxwZXJfc2VydmljZSBpbXBvcnQgSGVscGVyU2VydmljZQogICAgICAgICAgICBpbXBvcnQgY29uZmlnCiAgICAgICAgICAgIAogICAgICAgICAgICBoZWxwZXIgPSBIZWxwZXJTZXJ2aWNlKGJhc2VfdXJsPWNvbmZpZy5IRUxQRVJfU0VSVklDRV9VUkwpCiAgICAgICAgICAgIGRldmljZV9pbmZvID0gaGVscGVyLmdldF9kZXZpY2VfaW5mbygpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBkZXZpY2VfaW5mbyBhbmQgInN0YXR1cyIgaW4gZGV2aWNlX2luZm8gYW5kIGRldmljZV9pbmZvWyJzdGF0dXMiXSA9PSAic3VjY2VzcyI6CiAgICAgICAgICAgICAgICBkYXRhID0gZGV2aWNlX2luZm8uZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgICAgICBhbmRyb2lkX2lkID0gZGF0YS5nZXQoImFuZHJvaWRfaWQiLCAiIikKICAgICAgICAgICAgICAgIGlmIGFuZHJvaWRfaWQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGFuZHJvaWRfaWQKICAgICAgICAgICAgcmV0dXJuICIiCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIkzhu5dpIGtoaSBs4bqleSBkZXZpY2VfaWQgdOG7qyBoZWxwZXI6IHtlfSIpCiAgICAgICAgICAgIHJldHVybiAiIgogICAgICAgICAgICAKICAgIGRlZiBtaWdyYXRlX2dvbGlrZV9jb25maWcoc2VsZikgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBYw7NhIGPDoWMgY+G6pXUgaMOsbmggR29MaWtlIHRyw7luZyBs4bq3cCBraMO0bmcgY8OybiBj4bqnbiB0aGnhur90CiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcHJpbnQoIsSQYW5nIHjDs2EgY+G6pXUgaMOsbmggR29MaWtlIHRyw7luZyBs4bq3cC4uLiIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIE3hu58ga+G6v3QgbuG7kWkgREIKICAgICAgICAgICAgY29ubiA9IHNlbGYuX2dldF9jb25uZWN0aW9uKCkKICAgICAgICAgICAgY3Vyc29yID0gY29ubi5jdXJzb3IoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBEYW5oIHPDoWNoIGPDoWMga2V5IGPhuqduIHjDs2EKICAgICAgICAgICAga2V5c190b19kZWxldGUgPSBbCiAgICAgICAgICAgICAgICAiZ29saWtlX2hlYWRlcnMiLCAKICAgICAgICAgICAgICAgICJnb2xpa2VfaGVhZGVyc191cGRhdGVkIiwKICAgICAgICAgICAgICAgICJnb2xpa2VfYXBpX2Jhc2UiCiAgICAgICAgICAgIF0KICAgICAgICAgICAgCiAgICAgICAgICAgICMgWMOzYSBjw6FjIGtleSB0csO5bmcgbOG6t3AgY8WpCiAgICAgICAgICAgIGRlbGV0ZWRfY291bnQgPSAwCiAgICAgICAgICAgIGZvciBrZXkgaW4ga2V5c190b19kZWxldGU6CiAgICAgICAgICAgICAgICBjdXJzb3IuZXhlY3V0ZSgiREVMRVRFIEZST00gY29uZmlnIFdIRVJFIGtleSA9ID8iLCAoa2V5LCkpCiAgICAgICAgICAgICAgICBkZWxldGVkX2NvdW50ICs9IGN1cnNvci5yb3djb3VudAogICAgICAgICAgICAKICAgICAgICAgICAgIyBDb21taXQgdGhheSDEkeG7lWkKICAgICAgICAgICAgY29ubi5jb21taXQoKQogICAgICAgICAgICAKICAgICAgICAgICAgcHJpbnQoZiLEkMOjIHjDs2Ege2RlbGV0ZWRfY291bnR9IGPhuqV1IGjDrG5oIEdvTGlrZSB0csO5bmcgbOG6t3AiKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHByaW50KGYiTOG7l2kga2hpIHjDs2EgY+G6pXUgaMOsbmggR29MaWtlIHRyw7luZyBs4bq3cDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlIAoKICAgIGRlZiBzZXRfYWNjb3VudF9pbmFjdGl2ZV91bnRpbF9uZXh0X3Jlc2V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgaW5hY3RpdmVfcmVhc29uOiBzdHIgPSAixJDDoyDEkeG6oXQgZ2nhu5tpIGjhuqFuIGpvYiBow6BuZyBuZ8OgeSIpIC0+IGJvb2w6CiAgICAgICAgIiIixJDhurd0IHTDoGkga2hv4bqjbiB2w6BvIHRy4bqhbmcgdGjDoWkgaW5hY3RpdmUgxJHhur9uIGdp4budIHJlc2V0IHRp4bq/cCB0aGVvIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUsIGNvbmZpZywgdGltZQogICAgICAgICAgICAjIEzhuqV5IHRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgIyBHaeG7nSByZXNldAogICAgICAgICAgICBqb2JfaG91ciA9IHNlbGYuZ2V0KCJqb2JfaG91ciIsIGNvbmZpZy5KT0JfSE9VUikKICAgICAgICAgICAgbm93ID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICAgICAgbmV4dF9yZXNldCA9IG5vdy5yZXBsYWNlKGhvdXI9am9iX2hvdXIsIG1pbnV0ZT0wLCBzZWNvbmQ9MCwgbWljcm9zZWNvbmQ9MCkKICAgICAgICAgICAgaWYgbm93ID49IG5leHRfcmVzZXQ6CiAgICAgICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbmV4dF9yZXNldCArIGRhdGV0aW1lLnRpbWVkZWx0YShkYXlzPTEpCiAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gaW50KG5leHRfcmVzZXQudGltZXN0YW1wKCkpCiAgICAgICAgICAgIHVwZGF0ZV9kYXRhID0gewogICAgICAgICAgICAgICAgInN0YXR1cyI6ICJpbmFjdGl2ZSIsCiAgICAgICAgICAgICAgICAiam9iX2Rpc2FibGVfdW50aWwiOiBqb2JfZGlzYWJsZV91bnRpbCwKICAgICAgICAgICAgICAgICJqb2JzX2RvbmVfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImluYWN0aXZlX3JlYXNvbiI6IGluYWN0aXZlX3JlYXNvbgogICAgICAgICAgICB9CiAgICAgICAgICAgIHNlbGYudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgdXBkYXRlX2RhdGEpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltEQl0gTOG7l2kgc2V0X2FjY291bnRfaW5hY3RpdmVfdW50aWxfbmV4dF9yZXNldDoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlKHNlbGYsIGFjY291bnRfaWQ6IGludCwgY29vbGRvd25fbWludXRlczogaW50ID0gTm9uZSwgaW5hY3RpdmVfcmVhc29uOiBzdHIgPSAixJDDoyBob8OgbiB0aMOgbmggc+G7kSBqb2IgdHJvbmcgcGhpw6puIikgLT4gYm9vbDoKICAgICAgICAiIiLEkOG6t3QgdMOgaSBraG/huqNuIHbDoG8gdHLhuqFuZyB0aMOhaSBpbmFjdGl2ZSB0cm9uZyBraG/huqNuZyB0aOG7nWkgZ2lhbiAocGjDunQpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgdGltZSwgY29uZmlnCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgcHJpbnQoZiJbREJdIEtow7RuZyB0w6xtIHRo4bqleSB0w6BpIGtob+G6o24gY8OzIElEIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgaWYgY29vbGRvd25fbWludXRlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZ2V0KCJqb2JfY29vbGRvd25fbWludXRlcyIsIGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMpCiAgICAgICAgICAgIGpvYl9kaXNhYmxlX3VudGlsID0gaW50KHRpbWUudGltZSgpICsgY29vbGRvd25fbWludXRlcyAqIDYwKQogICAgICAgICAgICB1cGRhdGVfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAiaW5hY3RpdmUiLAogICAgICAgICAgICAgICAgImpvYl9kaXNhYmxlX3VudGlsIjogam9iX2Rpc2FibGVfdW50aWwsCiAgICAgICAgICAgICAgICAiam9ic19kb25lX2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImZvbGxvd19pbl9zZXNzaW9uIjogMCwKICAgICAgICAgICAgICAgICJpbmFjdGl2ZV9yZWFzb24iOiBpbmFjdGl2ZV9yZWFzb24KICAgICAgICAgICAgfQogICAgICAgICAgICBzZWxmLnVwZGF0ZV9hY2NvdW50KGFjY291bnRfaWQsIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlOiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UgCgogICAgZGVmIHNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvd191bnRpbF9uZXh0X3Jlc2V0KHNlbGYsIGFjY291bnRfaWQ6IGludCwgcmVhc29uOiBzdHIgPSAiRm9sbG93IHBlbmRpbmcvbGltaXQiKSAtPiBib29sOgogICAgICAgICIiIkNo4buJIGtow7NhIGNo4bupYyBuxINuZyBGT0xMT1cgY+G7p2EgdMOgaSBraG/huqNuIHThu5tpIGdp4budIHJlc2V0IHRp4bq/cCB0aGVvIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUsIGNvbmZpZywgdGltZQogICAgICAgICAgICBhY2MgPSBzZWxmLmdldF9hY2NvdW50KGFjY291bnRfaWQpCiAgICAgICAgICAgIGlmIG5vdCBhY2M6CiAgICAgICAgICAgICAgICBwcmludChmIltEQl0gS2jDtG5nIHTDrG0gdGjhuqV5IHTDoGkga2hv4bqjbiB7YWNjb3VudF9pZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIGpvYl9ob3VyID0gc2VsZi5nZXQoImpvYl9ob3VyIiwgY29uZmlnLkpPQl9IT1VSKQogICAgICAgICAgICBub3cgPSBkYXRldGltZS5kYXRldGltZS5ub3coKQogICAgICAgICAgICBuZXh0X3Jlc2V0ID0gbm93LnJlcGxhY2UoaG91cj1qb2JfaG91ciwgbWludXRlPTAsIHNlY29uZD0wLCBtaWNyb3NlY29uZD0wKQogICAgICAgICAgICBpZiBub3cgPj0gbmV4dF9yZXNldDoKICAgICAgICAgICAgICAgIG5leHRfcmVzZXQgKz0gZGF0ZXRpbWUudGltZWRlbHRhKGRheXM9MSkKICAgICAgICAgICAgc2VsZi51cGRhdGVfYWNjb3VudChhY2NvdW50X2lkLCB7CiAgICAgICAgICAgICAgICAiZGlzYWJsZV9mb2xsb3ciOiBUcnVlLAogICAgICAgICAgICAgICAgImZvbGxvd19kaXNhYmxlX3VudGlsIjogaW50KG5leHRfcmVzZXQudGltZXN0YW1wKCkpLAogICAgICAgICAgICAgICAgImluYWN0aXZlX2ZvbGxvd19yZWFzb24iOiByZWFzb24sCiAgICAgICAgICAgICAgICAiZm9sbG93X2luX3Nlc3Npb24iOiAwLAogICAgICAgICAgICAgICAgImlzX3N5bmMiOiBGYWxzZQogICAgICAgICAgICB9KQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgcHJpbnQoZiJbREJdIEzhu5dpIHNldF9hY2NvdW50X2luYWN0aXZlX2ZvbGxvd191bnRpbF9uZXh0X3Jlc2V0OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2V0X2FjY291bnRfaW5hY3RpdmVfZm9sbG93KHNlbGYsIGFjY291bnRfaWQ6IGludCwgY29vbGRvd25fbWludXRlczogaW50ID0gTm9uZSwgcmVhc29uOiBzdHIgPSAiRm9sbG93IHBlbmRpbmcvbGltaXQiKSAtPiBib29sOgogICAgICAgICIiIktow7NhIEZPTExPVyB0cm9uZyBt4buZdCBraG/huqNuZyB0aOG7nWkgZ2lhbiAocGjDunQpIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgdGltZSwgY29uZmlnCiAgICAgICAgICAgIGFjYyA9IHNlbGYuZ2V0X2FjY291bnQoYWNjb3VudF9pZCkKICAgICAgICAgICAgaWYgbm90IGFjYzoKICAgICAgICAgICAgICAgIHByaW50KGYiW0RCXSBLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHthY2NvdW50X2lkfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgaWYgY29vbGRvd25fbWludXRlcyBpcyBOb25lOgogICAgICAgICAgICAgICAgY29vbGRvd25fbWludXRlcyA9IHNlbGYuZ2V0KCJqb2JfY29vbGRvd25fbWludXRlcyIsIGNvbmZpZy5ERUZBVUxUX0NPT0xET1dOX01JTlVURVMpCiAgICAgICAgICAgIHNlbGYudXBkYXRlX2FjY291bnQoYWNjb3VudF9pZCwgewogICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IjogVHJ1ZSwKICAgICAgICAgICAgICAgICJmb2xsb3dfZGlzYWJsZV91bnRpbCI6IGludCh0aW1lLnRpbWUoKSArIGNvb2xkb3duX21pbnV0ZXMgKiA2MCksCiAgICAgICAgICAgICAgICAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiI6IHJlYXNvbiwKICAgICAgICAgICAgICAgICJmb2xsb3dfaW5fc2Vzc2lvbiI6IDAsCiAgICAgICAgICAgICAgICAiaXNfc3luYyI6IEZhbHNlCiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBwcmludChmIltEQl0gTOG7l2kgc2V0X2FjY291bnRfaW5hY3RpdmVfZm9sbG93OiB7ZX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIAogICAgZGVmIGdldF9hY2NvdW50c19ieV9hcHBfYW5kX2dvbGlrZV9zdGF0dXMoc2VsZiwgYXBwOiBzdHIsIGlzX2xpbmtlZDogYm9vbCA9IEZhbHNlKSAtPiBMaXN0W0RpY3Rbc3RyLCBBbnldXToKICAgICAgICAiIiIKICAgICAgICBM4bqleSBkYW5oIHPDoWNoIHTDoGkga2hv4bqjbiB0aGVvIGFwcCB2w6AgdHLhuqFuZyB0aMOhaSBnb2xpa2UKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBhcHA6IFTDqm4g4bupbmcgZOG7pW5nIChpbnN0YWdyYW0sIHRpa3RvaywgLi4uKQogICAgICAgICAgICBpc19saW5rZWQ6IFRydWUgbuG6v3UgbOG6pXkgdMOgaSBraG/huqNuIMSRw6MgbGnDqm4ga+G6v3QsIEZhbHNlIG7hur91IGzhuqV5IHTDoGkga2hv4bqjbiBjaMawYSBsacOqbiBr4bq/dAogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W0RpY3Rbc3RyLCBBbnldXTogRGFuaCBzw6FjaCB0w6BpIGtob+G6o24KICAgICAgICAiIiIKICAgICAgICBjb25uID0gc2VsZi5fZ2V0X2Nvbm5lY3Rpb24oKQogICAgICAgIGN1cnNvciA9IGNvbm4uY3Vyc29yKCkKICAgICAgICAKICAgICAgICBxdWVyeSA9ICJTRUxFQ1QgKiBGUk9NIGFjY291bnRzIFdIRVJFIGFwcCA9ID8gQU5EIGlzX2dvbGlrZV9saW5rZWQgPSA/IgogICAgICAgIHBhcmFtcyA9IFthcHAsIDEgaWYgaXNfbGlua2VkIGVsc2UgMF0KICAgICAgICAKICAgICAgICAjIEzhu41jIHRoZW8gZGV2aWNlX2lkIGPhu6dhIHRoaeG6v3QgYuG7iyBoaeG7h24gdOG6oWkKICAgICAgICBjdXJyZW50X2RldmljZV9pZCA9IHNlbGYuZ2V0X29yX2NyZWF0ZV9kZXZpY2VfaWQoKQogICAgICAgIGlmIGN1cnJlbnRfZGV2aWNlX2lkOgogICAgICAgICAgICBxdWVyeSArPSAiIEFORCBkZXZpY2VfaWQgPSA/IgogICAgICAgICAgICBwYXJhbXMuYXBwZW5kKGN1cnJlbnRfZGV2aWNlX2lkKQogICAgICAgIAogICAgICAgIGN1cnNvci5leGVjdXRlKHF1ZXJ5LCBwYXJhbXMpCiAgICAgICAgY29sdW1uX25hbWVzID0gW2Rlc2NyaXB0aW9uWzBdIGZvciBkZXNjcmlwdGlvbiBpbiBjdXJzb3IuZGVzY3JpcHRpb25dCiAgICAgICAgcmVzdWx0cyA9IGN1cnNvci5mZXRjaGFsbCgpCiAgICAgICAgCiAgICAgICAgYWNjb3VudHMgPSBbXQogICAgICAgIGZvciByZXN1bHQgaW4gcmVzdWx0czoKICAgICAgICAgICAgIyBDaHV54buDbiDEkeG7lWkga+G6v3QgcXXhuqMgdGjDoG5oIGRpY3QKICAgICAgICAgICAgYWNjb3VudCA9IHtjb2x1bW5fbmFtZXNbaV06IHJlc3VsdFtpXSBmb3IgaSBpbiByYW5nZShsZW4oY29sdW1uX25hbWVzKSl9CiAgICAgICAgICAgIAogICAgICAgICAgICAjIENodXnhu4NuIMSR4buVaSBjw6FjIHRyxrDhu51uZyBib29sZWFuCiAgICAgICAgICAgIGFjY291bnRbImlzX2xvZ2luIl0gPSBib29sKGFjY291bnRbImlzX2xvZ2luIl0pCiAgICAgICAgICAgIGFjY291bnRbImpvYl9lbmFibGUiXSA9IGJvb2woYWNjb3VudFsiam9iX2VuYWJsZSJdKQogICAgICAgICAgICBhY2NvdW50WyJpc19nb2xpa2VfbGlua2VkIl0gPSBib29sKGFjY291bnRbImlzX2dvbGlrZV9saW5rZWQiXSkKICAgICAgICAgICAgYWNjb3VudFsiaXNfc3luYyJdID0gYm9vbChhY2NvdW50WyJpc19zeW5jIl0pCiAgICAgICAgICAgIGlmICJkaXNhYmxlX2ZvbGxvdyIgaW4gYWNjb3VudDoKICAgICAgICAgICAgICAgIGFjY291bnRbImRpc2FibGVfZm9sbG93Il0gPSBib29sKGFjY291bnRbImRpc2FibGVfZm9sbG93Il0pCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIGThu68gbGnhu4d1IHBo4bulIHThu6sgdHLGsOG7nW5nIGRhdGEKICAgICAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQgYW5kIGFjY291bnRbImRhdGEiXToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBleHRyYV9kYXRhID0ganNvbi5sb2FkcyhhY2NvdW50WyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgYWNjb3VudC51cGRhdGUoZXh0cmFfZGF0YSkKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBYw7NhIHRyxrDhu51uZyBkYXRhIMSR4buDIHRyw6FuaCB0csO5bmcgbOG6t3AKICAgICAgICAgICAgaWYgImRhdGEiIGluIGFjY291bnQ6CiAgICAgICAgICAgICAgICBkZWwgYWNjb3VudFsiZGF0YSJdCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgYWNjb3VudHMuYXBwZW5kKGFjY291bnQpCiAgICAgICAgCiAgICAgICAgcmV0dXJuIGFjY291bnRz').decode('utf-8'))
