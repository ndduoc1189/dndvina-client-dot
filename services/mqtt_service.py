import base64
exec(base64.b64decode('aW1wb3J0IHBhaG8ubXF0dC5jbGllbnQgYXMgbXF0dAppbXBvcnQgdGhyZWFkaW5nCmltcG9ydCBqc29uCmltcG9ydCB0aW1lCmltcG9ydCB1dWlkCmltcG9ydCBvcwppbXBvcnQgYmFzZTY0CmZyb20gdHlwaW5nIGltcG9ydCBEaWN0LCBBbnksIExpc3QsIE9wdGlvbmFsLCBDYWxsYWJsZSwgVW5pb24KaW1wb3J0IGNvbmZpZwppbXBvcnQgdXRpbHMKaW1wb3J0IHNvY2tldAppbXBvcnQgcmFuZG9tCmltcG9ydCBzdWJwcm9jZXNzCgojIExvZ2dlcgpsb2dnZXIgPSB1dGlscy5nZXRfbG9nZ2VyKCJNUVRUU2VydmljZSIpCgpjbGFzcyBNUVRUU2VydmljZToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBkYl9zZXJ2aWNlLCBkZXZpY2VfaWQsIGhlbHBlcl9zZXJ2aWNlPU5vbmUsIGpvYl9zZXJ2aWNlPU5vbmUsIG1pbmluZ19zZXJ2aWNlPU5vbmUpOgogICAgICAgICMgS2jhu59pIHThuqFvIGPDoWMgc2VydmljZQogICAgICAgIHNlbGYuZGIgPSBkYl9zZXJ2aWNlCiAgICAgICAgc2VsZi5oZWxwZXJfc2VydmljZSA9IGhlbHBlcl9zZXJ2aWNlCiAgICAgICAgc2VsZi5qb2Jfc2VydmljZSA9IGpvYl9zZXJ2aWNlICAjIFRow6ptIHJlZmVyZW5jZSDEkeG6v24gSm9iU2VydmljZQogICAgICAgIHNlbGYubWluaW5nX3NlcnZpY2UgPSBtaW5pbmdfc2VydmljZSAgIyBUaMOqbSByZWZlcmVuY2UgxJHhur9uIE1pbmluZ1NlcnZpY2UKICAgICAgICAKICAgICAgICAjIFN0cmVhbSBsb2cgc3RhdGUKICAgICAgICBzZWxmLnN0cmVhbV9hY3RpdmUgPSBGYWxzZQogICAgICAgIHNlbGYuc3RyZWFtX3RocmVhZCA9IE5vbmUKICAgICAgICBzZWxmLnN0cmVhbV9zdG9wX2V2ZW50ID0gdGhyZWFkaW5nLkV2ZW50KCkKICAgICAgICBzZWxmLnN0cmVhbV90aW1lb3V0ID0gNjAgICMgNjAgc2Vjb25kcyBkZWZhdWx0CiAgICAgICAgc2VsZi5zdHJlYW1fbGFzdF9hY3Rpdml0eSA9IDAKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIE1RVFQKICAgICAgICBzZWxmLmNsaWVudF9pZCA9IGYie2NvbmZpZy5NUVRUX0NMSUVOVF9JRF9QUkVGSVh9X3tyYW5kb20ucmFuZGludCgxLCA5OSl9X3tkZXZpY2VfaWR9IgogICAgICAgIHNlbGYuYnJva2VyX3VybCA9IGNvbmZpZy5NUVRUX1NFUlZFUlNbY29uZmlnLk1PREVdCiAgICAgICAgc2VsZi5icm9rZXJfYWRkcmVzcyA9IHNlbGYuYnJva2VyX3VybC5yZXBsYWNlKCJtcXR0Oi8vIiwgIiIpLnNwbGl0KCI6IilbMF0KICAgICAgICBzZWxmLmJyb2tlcl9wb3J0ID0gaW50KHNlbGYuYnJva2VyX3VybC5zcGxpdCgiOiIpWy0xXSkgaWYgIjoiIGluIHNlbGYuYnJva2VyX3VybCBlbHNlIDE4ODMKICAgICAgICBzZWxmLnVzZXJuYW1lID0gY29uZmlnLk1RVFRfVVNFUk5BTUUKICAgICAgICBzZWxmLnBhc3N3b3JkID0gY29uZmlnLk1RVFRfUEFTU1dPUkQKICAgICAgICAKICAgICAgICAjIFRy4bqhbmcgdGjDoWkga+G6v3QgbuG7kWkKICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgc2VsZi5jbGllbnQgPSBOb25lCiAgICAgICAgc2VsZi5kZXZpY2VfaWQgPSBkZXZpY2VfaWQKICAgICAgICAKICAgICAgICAjIFJlY29ubmVjdGlvbiBsb2dpYwogICAgICAgIHNlbGYucmVjb25uZWN0X2RlbGF5ID0gMSAgIyBC4bqvdCDEkeG6p3UgduG7m2kgMSBnacOieQogICAgICAgIHNlbGYubWF4X3JlY29ubmVjdF9kZWxheSA9IDYwICAjIFThu5FpIMSRYSA2MCBnacOieQogICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ID0gMAogICAgICAgIHNlbGYubGFzdF9kaXNjb25uZWN0X3RpbWUgPSAwCiAgICAgICAgc2VsZi5tYW51YWxfZGlzY29ubmVjdCA9IEZhbHNlICAjIEZsYWcgxJHhu4MgcGjDom4gYmnhu4d0IGRpc2Nvbm5lY3QgY8OzIGNo4bunIMO9IHbDoCBraMO0bmcgY2jhu6cgw70KICAgICAgICAKICAgICAgICAjIFRvcGljcwogICAgICAgIHNlbGYudG9waWNfY2xpZW50X3N5bmMgPSBjb25maWcuTVFUVF9UT1BJQ19DTElFTlRfU1lOQwogICAgICAgIHNlbGYudG9waWNfc2VydmVyX3Rhc2sgPSBmIntjb25maWcuTVFUVF9UT1BJQ19TRVJWRVJfVEFTS19QUkVGSVh9L3tzZWxmLmRldmljZV9pZH0iCiAgICAgICAgCiAgICAgICAgIyBRdeG6o24gbMO9IHRhc2sgdsOgIHN5bmMKICAgICAgICBzZWxmLnRhc2tfaGFuZGxlcnMgPSB7fQogICAgICAgIHNlbGYuc3luY190aHJlYWQgPSBOb25lCiAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gY29uZmlnLlNZTkNfSU5URVJWQUwKICAgICAgICBzZWxmLnN5bmNfcnVubmluZyA9IEZhbHNlCiAgICAKICAgIGRlZiBzZXRfam9iX3NlcnZpY2Uoc2VsZiwgam9iX3NlcnZpY2UpOgogICAgICAgICIiIgogICAgICAgIMSQ4bq3dCBKb2JTZXJ2aWNlIMSR4buDIHjhu60gbMO9IGPDoWMgdGjDtG5nIGLDoW8gY29uZmlnIHVwZGF0ZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGpvYl9zZXJ2aWNlOiBJbnN0YW5jZSBj4bunYSBKb2JTZXJ2aWNlCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi5qb2Jfc2VydmljZSA9IGpvYl9zZXJ2aWNlCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgxJHhurd0IEpvYlNlcnZpY2UgY2hvIE1RVFRTZXJ2aWNlIikKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBGYWxzZQogICAgICAgIHNlbGYuc3RvcF9ldmVudCA9IHRocmVhZGluZy5FdmVudCgpCiAgICAgICAgc2VsZi5zeW5jX2ludGVydmFsID0gc2VsZi5kYi5nZXRfZGV2aWNlX2NvbmZpZygic3luY19pbnRlcnZhbCIsIGNvbmZpZy5TWU5DX0lOVEVSVkFMKQogICAgICAgIAogICAgICAgICMgVGhlbyBkw7VpIFJBTSDEkeG7gyB04buxIMSR4buZbmcgcmVib290CiAgICAgICAgc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSA9IFtdICAjIEzGsHUgMyBs4bqnbiDEkW8gUkFNIGfhuqduIG5o4bqldAogICAgICAgIHNlbGYuaGlnaF9yYW1fdGhyZXNob2xkID0gODggICMgTmfGsOG7oW5nIFJBTSBjYW8gKCUpCiAgICAgICAgc2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdCA9IDMgICMgU+G7kSBs4bqnbiBsacOqbiB0aeG6v3AgUkFNIGNhbyB0csaw4bubYyBraGkgcmVib290CiAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIG3DtGkgdHLGsOG7nW5nIFRlcm11eAogICAgICAgIHNlbGYuaXNfdGVybXV4ID0gJ1RFUk1VWF9WRVJTSU9OJyBpbiBvcy5lbnZpcm9uIG9yICcvZGF0YS9kYXRhL2NvbS50ZXJtdXgnIGluIG9zLmVudmlyb24uZ2V0KCdQQVRIJywgJycpCiAgICAgICAgaWYgc2VsZi5pc190ZXJtdXg6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkGFuZyBjaOG6oXkgdHJvbmcgbcO0aSB0csaw4budbmcgVGVybXV4IikKCiAgICBkZWYgX2NyZWF0ZV9jbGllbnQoc2VsZikgLT4gbXF0dC5DbGllbnQ6CiAgICAgICAgIiIiVOG6oW8gdsOgIGPhuqV1IGjDrG5oIE1RVFQgY2xpZW50IiIiCiAgICAgICAgY2xpZW50ID0gTm9uZQoKICAgICAgICAjIFRo4butIHThuqFvIHbhu5tpIEFQSSB2MgogICAgICAgIHRyeToKICAgICAgICAgICAgY2xpZW50ID0gbXF0dC5DbGllbnQoCiAgICAgICAgICAgICAgICBjbGllbnRfaWQ9c2VsZi5jbGllbnRfaWQsCiAgICAgICAgICAgICAgICBjbGVhbl9zZXNzaW9uPVRydWUsCiAgICAgICAgICAgICAgICBwcm90b2NvbD1tcXR0Lk1RVFR2MzExLAogICAgICAgICAgICAgICAgY2FsbGJhY2tfYXBpX3ZlcnNpb249Z2V0YXR0cihtcXR0LkNhbGxiYWNrQVBJVmVyc2lvbiwgJ1ZFUlNJT04yJywgTm9uZSkKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYyIikKICAgICAgICBleGNlcHQgKEF0dHJpYnV0ZUVycm9yLCBUeXBlRXJyb3IpOgogICAgICAgICAgICAjIEZhbGxiYWNrIEFQSSB2MQogICAgICAgICAgICBjbGllbnQgPSBtcXR0LkNsaWVudCgKICAgICAgICAgICAgICAgIGNsaWVudF9pZD1zZWxmLmNsaWVudF9pZCwKICAgICAgICAgICAgICAgIGNsZWFuX3Nlc3Npb249VHJ1ZSwKICAgICAgICAgICAgICAgIHByb3RvY29sPW1xdHQuTVFUVHYzMTEKICAgICAgICAgICAgKQogICAgICAgICAgICBsb2dnZXIuaW5mbygiVOG6oW8gTVFUVCBjbGllbnQgduG7m2kgQVBJIHYxIikKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIHjDoWMgdGjhu7FjIG7hur91IGPDswogICAgICAgIGlmIHNlbGYudXNlcm5hbWUgYW5kIHNlbGYucGFzc3dvcmQ6CiAgICAgICAgICAgIGNsaWVudC51c2VybmFtZV9wd19zZXQoc2VsZi51c2VybmFtZSwgc2VsZi5wYXNzd29yZCkKICAgICAgICAKICAgICAgICAjIMSQxINuZyBrw70gY2FsbGJhY2sKICAgICAgICBjbGllbnQub25fY29ubmVjdCA9IHNlbGYuX29uX2Nvbm5lY3QKICAgICAgICBjbGllbnQub25fbWVzc2FnZSA9IHNlbGYuX29uX21lc3NhZ2UKICAgICAgICBjbGllbnQub25fZGlzY29ubmVjdCA9IHNlbGYuX29uX2Rpc2Nvbm5lY3QKICAgICAgICAKICAgICAgICAjIEPhuqV1IGjDrG5oIGtlZXAtYWxpdmUgZMOgaSBoxqFuIHbDoCByZWNvbm5lY3Rpb24KICAgICAgICBjbGllbnQucmVjb25uZWN0X2RlbGF5X3NldChtaW5fZGVsYXk9MSwgbWF4X2RlbGF5PTYwKQogICAgICAgIAogICAgICAgIHJldHVybiBjbGllbnQKCiAgICBkZWYgY29ubmVjdChzZWxmKSAtPiBib29sOgogICAgICAgICIiIkvhur90IG7hu5FpIMSR4bq/biBNUVRUIGJyb2tlciB24bubaSBleHBvbmVudGlhbCBiYWNrb2ZmIiIiCiAgICAgICAgZGVmIGNhbl9jb25uZWN0KGhvc3Q6IHN0ciwgcG9ydDogaW50LCB0aW1lb3V0OiBmbG9hdCA9IDMuMCkgLT4gYm9vbDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgd2l0aCBzb2NrZXQuY3JlYXRlX2Nvbm5lY3Rpb24oKGhvc3QsIHBvcnQpLCB0aW1lb3V0PXRpbWVvdXQpOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgbWFpbl9ob3N0ID0gc2VsZi5icm9rZXJfYWRkcmVzcwogICAgICAgIG1haW5fcG9ydCA9IHNlbGYuYnJva2VyX3BvcnQKICAgICAgICBmYWxsYmFja19ob3N0ID0gIjEwLjAuMC42IgogICAgICAgIGZhbGxiYWNrX3BvcnQgPSA5MDIwCgogICAgICAgICMgS2nhu4NtIHRyYSBr4bq/dCBu4buRaSBzb2NrZXQgdOG7m2kgY+G6oyAyIElQCiAgICAgICAgbWFpbl9vayA9IGNhbl9jb25uZWN0KG1haW5faG9zdCwgbWFpbl9wb3J0KQogICAgICAgIGZhbGxiYWNrX29rID0gY2FuX2Nvbm5lY3QoZmFsbGJhY2tfaG9zdCwgZmFsbGJhY2tfcG9ydCkKICAgICAgICBpZiBtYWluX29rOgogICAgICAgICAgICBjb25uZWN0X2hvc3QgPSBtYWluX2hvc3QKICAgICAgICAgICAgY29ubmVjdF9wb3J0ID0gbWFpbl9wb3J0CiAgICAgICAgZWxpZiBmYWxsYmFja19vazoKICAgICAgICAgICAgY29ubmVjdF9ob3N0ID0gZmFsbGJhY2tfaG9zdAogICAgICAgICAgICBjb25uZWN0X3BvcnQgPSBmYWxsYmFja19wb3J0CiAgICAgICAgZWxzZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIGvhur90IG7hu5FpIMSRxrDhu6NjIHNvY2tldCB04bubaSBj4bqjIHttYWluX2hvc3R9OnttYWluX3BvcnR9IGzhuqtuIHtmYWxsYmFja19ob3N0fTp7ZmFsbGJhY2tfcG9ydH0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFThuqFvIGNsaWVudCBt4bubaSBu4bq/dSBjaMawYSBjw7MgaG/hurdjIGNsaWVudCBjxakgYuG7iyBs4buXaQogICAgICAgICAgICBpZiBzZWxmLmNsaWVudCBpcyBOb25lOgogICAgICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBzZWxmLl9jcmVhdGVfY2xpZW50KCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgUmVzZXQgdHLhuqFuZyB0aMOhaQogICAgICAgICAgICBzZWxmLnN0b3BfZXZlbnQuY2xlYXIoKQogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3QgPSBGYWxzZQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkGFuZyBr4bq/dCBu4buRaSB04bubaSBNUVRUIGJyb2tlciB7Y29ubmVjdF9ob3N0fTp7Y29ubmVjdF9wb3J0fSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGtlZXBhbGl2ZSBs4bubbiBoxqFuICgxMjAgZ2nDonkgdGhheSB2w6wgNjApIMSR4buDIHBow6F0IGhp4buHbiBt4bqldCBr4bq/dCBu4buRaQogICAgICAgICAgICAjIEtoaSBt4bqldCBt4bqhbmcgcuG7k2kgY8OzIGzhuqFpLCBjbGllbnQgc+G6vSB04buxIMSR4buZbmcgcmVjb25uZWN0IHF1YSBfb25fZGlzY29ubmVjdCBjYWxsYmFjawogICAgICAgICAgICBzZWxmLmNsaWVudC5jb25uZWN0X2FzeW5jKGNvbm5lY3RfaG9zdCwgY29ubmVjdF9wb3J0LCBrZWVwYWxpdmU9MTIwKQogICAgICAgICAgICBzZWxmLmNsaWVudC5sb29wX3N0YXJ0KCkKCiAgICAgICAgICAgIGRlZiBfd2FpdF9jb25uZWN0ZWQodGltZW91dF9zZWM6IGludCA9IDE1KSAtPiBib29sOgogICAgICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2UodGltZW91dF9zZWMpOgogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMSkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgaWYgX3dhaXRfY29ubmVjdGVkKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6Mga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nIMSR4bq/biBNUVRUIGJyb2tlciB7Y29ubmVjdF9ob3N0fTp7Y29ubmVjdF9wb3J0fSIpCiAgICAgICAgICAgICAgICBzZWxmLmJyb2tlcl9hZGRyZXNzID0gY29ubmVjdF9ob3N0CiAgICAgICAgICAgICAgICBzZWxmLmJyb2tlcl9wb3J0ID0gY29ubmVjdF9wb3J0CiAgICAgICAgICAgICAgICAjIFJlc2V0IHJlY29ubmVjdCBkZWxheSBraGkga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9kZWxheSA9IDEKICAgICAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ID0gMAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkvhur90IG7hu5FpIE1RVFQgdGjhuqV0IGLhuqFpIHThu5tpIHtjb25uZWN0X2hvc3R9Ontjb25uZWN0X3BvcnR9IikKICAgICAgICAgICAgICAgIHNlbGYuX2NsZWFudXBfY2xpZW50KCkKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGvhur90IG7hu5FpIE1RVFQ6IHtzdHIoZSl9IikKICAgICAgICAgICAgc2VsZi5fY2xlYW51cF9jbGllbnQoKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2NsZWFudXBfY2xpZW50KHNlbGYpOgogICAgICAgICIiIkThu41uIGThurlwIE1RVFQgY2xpZW50IiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBzZWxmLmNsaWVudDoKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50Lmxvb3Bfc3RvcCgpCiAgICAgICAgICAgICAgICBzZWxmLmNsaWVudC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50ID0gTm9uZQogICAgICAgICAgICBzZWxmLmlzX2Nvbm5lY3RlZCA9IEZhbHNlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBk4buNbiBk4bq5cCBNUVRUIGNsaWVudDoge2V9IikKCiAgICBkZWYgZW5zdXJlX2Nvbm5lY3RlZChzZWxmKSAtPiBib29sOgogICAgICAgICIiIsSQ4bqjbSBi4bqjbyBr4bq/dCBu4buRaSBNUVRUIHRyxrDhu5tjIGtoaSB0aOG7sWMgaGnhu4duIGPDoWMgdGhhbyB0w6FjIHbhu5tpIHJhdGUgbGltaXRpbmciIiIKICAgICAgICBpZiBzZWxmLmlzX2Nvbm5lY3RlZDoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgCiAgICAgICAgIyBLaeG7g20gdHJhIHhlbSBjw7MgxJFhbmcgdHJvbmcgcXXDoSB0csOsbmggcmVjb25uZWN0IGtow7RuZwogICAgICAgIGN1cnJlbnRfdGltZSA9IHRpbWUudGltZSgpCiAgICAgICAgaWYgY3VycmVudF90aW1lIC0gc2VsZi5sYXN0X2Rpc2Nvbm5lY3RfdGltZSA8IDU6ICAjIENo4budIMOtdCBuaOG6pXQgNSBnacOieSB04burIGzhuqduIGRpc2Nvbm5lY3QgY3Xhu5FpCiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygixJBhbmcgdHJvbmcgdGjhu51pIGdpYW4gY29vbGRvd24gcmVjb25uZWN0LCBjaOG7nS4uLiIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICAKICAgICAgICBsb2dnZXIud2FybmluZygiTVFUVCBjaMawYSBr4bq/dCBu4buRaSwgxJFhbmcgdGjhu60ga+G6v3QgbuG7kWkgbOG6oWkuLi4iKQogICAgICAgIHJldHVybiBzZWxmLmNvbm5lY3QoKQoKICAgIGRlZiBfb25fY29ubmVjdChzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCBmbGFncywgcmMsIHByb3BlcnRpZXM9Tm9uZSk6CiAgICAgICAgIiIiQ2FsbGJhY2sga2hpIGvhur90IG7hu5FpIHRow6BuaCBjw7RuZyIiIgogICAgICAgIGlmIHJjID09IDA6CiAgICAgICAgICAgIHNlbGYuaXNfY29ubmVjdGVkID0gVHJ1ZQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcgdOG7m2kgTVFUVCBicm9rZXIiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMSDbmcga8O9IG5o4bqtbiB0YXNrCiAgICAgICAgICAgIHNlbGYuY2xpZW50LnN1YnNjcmliZShzZWxmLnRvcGljX3NlcnZlcl90YXNrLCBxb3M9MSkKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIMSRxINuZyBrw70gbmjhuq1uIHRhc2sgdOG6oWk6IHtzZWxmLnRvcGljX3NlcnZlcl90YXNrfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpCiAgICAgICAgICAgIHNlbGYuc2VuZF9jb25uZWN0X25vdGlmaWNhdGlvbigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFJlc2V0IHJlY29ubmVjdCBjb3VudGVyIGtoaSBr4bq/dCBu4buRaSB0aMOgbmggY8O0bmcKICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfY291bnQgPSAwCiAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2RlbGF5ID0gMQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkvhur90IG7hu5FpIE1RVFQgdGjhuqV0IGLhuqFpIHbhu5tpIG3DoyBs4buXaToge3JjfSIpCiAgICAgICAgICAgICMgVMSDbmcgcmVjb25uZWN0IGNvdW50IGtoaSBr4bq/dCBu4buRaSB0aOG6pXQgYuG6oWkKICAgICAgICAgICAgc2VsZi5yZWNvbm5lY3RfY291bnQgKz0gMQoKICAgIGRlZiBfb25fZGlzY29ubmVjdChzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCByYywgcHJvcGVydGllcz1Ob25lLCByZWFzb25fY29kZT1Ob25lLCAqKmt3YXJncyk6CiAgICAgICAgIiIiQ2FsbGJhY2sga2hpIG5n4bqvdCBr4bq/dCBu4buRaSB24bubaSBjxqEgY2jhur8gcmVjb25uZWN0IHRow7RuZyBtaW5oIiIiCiAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgIHNlbGYubGFzdF9kaXNjb25uZWN0X3RpbWUgPSB0aW1lLnRpbWUoKQogICAgICAgIAogICAgICAgIGlmIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3Q6CiAgICAgICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIG5n4bqvdCBr4bq/dCBu4buRaSBNUVRUIHRoZW8gecOqdSBj4bqndSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICBpZiByYyAhPSAwOgogICAgICAgICAgICBzZWxmLnJlY29ubmVjdF9jb3VudCArPSAxCiAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTmfhuq90IGvhur90IG7hu5FpIE1RVFQga2jDtG5nIG1vbmcgbXXhu5FuIGzhuqduIHtzZWxmLnJlY29ubmVjdF9jb3VudH0gduG7m2kgbcOjIGzhu5dpOiB7cmN9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgQ2jhu4kgYXV0by1yZWNvbm5lY3QgbuG6v3Uga2jDtG5nIHBo4bqjaSBtYW51YWwgZGlzY29ubmVjdAogICAgICAgICAgICBpZiBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpOgogICAgICAgICAgICAgICAgc2VsZi5fc2NoZWR1bGVfcmVjb25uZWN0KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBuZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIpCgogICAgZGVmIF9zY2hlZHVsZV9yZWNvbm5lY3Qoc2VsZik6CiAgICAgICAgIiIiTMOqbiBs4buLY2gga+G6v3QgbuG7kWkgbOG6oWkgbeG7l2kgMzAgZ2nDonksIGzhurdwIHbDtCBo4bqhbiDEkeG6v24ga2hpIGThu6tuZyBhcHAiIiIKICAgICAgICBsb2dnZXIuaW5mbygiU+G6vSB0aOG7rSBr4bq/dCBu4buRaSBs4bqhaSBzYXUgMzAgZ2nDonkuLi4iKQogICAgICAgIAogICAgICAgIGRlZiByZWNvbm5lY3RfbG9vcCgpOgogICAgICAgICAgICB3aGlsZSBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpIGFuZCBub3Qgc2VsZi5tYW51YWxfZGlzY29ubmVjdDoKICAgICAgICAgICAgICAgICMgQ2jhu50gMzAgZ2nDonksIGPDsyB0aOG7gyBi4buLIG5n4bqvdCBi4bufaSBzdG9wX2V2ZW50CiAgICAgICAgICAgICAgICBpZiBzZWxmLnN0b3BfZXZlbnQud2FpdCgzMCk6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgICMgQuG7iyBk4burbmcsIHRob8OhdCBsb29wCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEtp4buDbSB0cmEgbOG6oWkgdHLhuqFuZyB0aMOhaSB0csaw4bubYyBraGkgdGjhu60ga+G6v3QgbuG7kWkKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkIG9yIHNlbGYubWFudWFsX2Rpc2Nvbm5lY3Q6CiAgICAgICAgICAgICAgICAgICAgYnJlYWsgICMgxJDDoyBr4bq/dCBu4buRaSBob+G6t2MgYuG7iyBk4burbmcgdGjhu6cgY8O0bmcKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjhu60ga+G6v3QgbuG7kWkgbOG6oWkgTVFUVCAobOG6p24ge3NlbGYucmVjb25uZWN0X2NvdW50fSkiKQogICAgICAgICAgICAgICAgaWYgc2VsZi5jb25uZWN0KCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkvhur90IG7hu5FpIGzhuqFpIE1RVFQgdGjDoG5oIGPDtG5nIikKICAgICAgICAgICAgICAgICAgICBicmVhayAgIyBL4bq/dCBu4buRaSB0aMOgbmggY8O0bmcsIHRob8OhdCBsb29wCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVjb25uZWN0X2NvdW50ICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkvhur90IG7hu5FpIGzhuqFpIE1RVFQgdGjhuqV0IGLhuqFpIGzhuqduIHtzZWxmLnJlY29ubmVjdF9jb3VudH0sIHRo4butIGzhuqFpIHNhdSAzMCBnacOieS4uLiIpCiAgICAgICAgCiAgICAgICAgIyBDaOG6oXkgdHJvbmcgdGhyZWFkIHJpw6puZyDEkeG7gyBraMO0bmcgYmxvY2sKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1yZWNvbm5lY3RfbG9vcCwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKCiAgICBkZWYgX3NhZmVfcHVibGlzaChzZWxmLCB0b3BpYzogc3RyLCBwYXlsb2FkOiBzdHIsIHFvczogaW50ID0gMSkgLT4gYm9vbDoKICAgICAgICAiIiIKICAgICAgICBH4butaSBtZXNzYWdlIGFuIHRvw6BuIHbhu5tpIGtp4buDbSB0cmEga+G6v3QgbuG7kWkgdHLGsOG7m2Mga2hpIHB1Ymxpc2gKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0b3BpYzogTVFUVCB0b3BpYwogICAgICAgICAgICBwYXlsb2FkOiBO4buZaSBkdW5nIG1lc3NhZ2UgKHN0cmluZykKICAgICAgICAgICAgcW9zOiBRdWFsaXR5IG9mIFNlcnZpY2UgKDAsIDEsIGhv4bq3YyAyKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGfhu61pIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3Qgc2VsZi5lbnN1cmVfY29ubmVjdGVkKCk6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgZ+G7rWkgbWVzc2FnZSDEkeG6v24ge3RvcGljfTogTVFUVCBjaMawYSBr4bq/dCBu4buRaSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYuY2xpZW50LnB1Ymxpc2godG9waWMsIHBheWxvYWQsIHFvcz1xb3MpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXN1bHQucmMgPT0gbXF0dC5NUVRUX0VSUl9TVUNDRVNTOgogICAgICAgICAgICAgICAgI2xvZ2dlci5pbmZvKGYixJDDoyBn4butaSBtZXNzYWdlIHRow6BuaCBjw7RuZyDEkeG6v24ge3RvcGljfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIG1lc3NhZ2UgxJHhur9uIHt0b3BpY306IHttcXR0LmVycm9yX3N0cmluZyhyZXN1bHQucmMpfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSBraGkgZ+G7rWkgbWVzc2FnZSDEkeG6v24ge3RvcGljfToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgc2VuZF90YXNrX3JlcG9ydChzZWxmLCB0YXNrX2lkOiBzdHIsIGRldmljZV9pZDogc3RyLCBzdGF0dXM6IHN0ciwgY2xpZW50X21lc3NhZ2U6IHN0ciA9ICIiLCBkYXRhOiBEaWN0W3N0ciwgQW55XSA9IE5vbmUpOgogICAgICAgICIiIgogICAgICAgIEfhu61pIGLDoW8gY8OhbyBr4bq/dCBxdeG6oyB0aOG7sWMgaGnhu4duIHRhc2sKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2lkOiBJRCBj4bunYSB0YXNrCiAgICAgICAgICAgIGRldmljZV9pZDogSUQgY+G7p2EgdGhp4bq/dCBi4buLCiAgICAgICAgICAgIHN0YXR1czogVHLhuqFuZyB0aMOhaSAoc3VjY2Vzcy9mYWlsZWQpCiAgICAgICAgICAgIGNsaWVudF9tZXNzYWdlOiBUaMO0bmcgxJFp4buHcCB04burIGNsaWVudAogICAgICAgICAgICBkYXRhOiBE4buvIGxp4buHdSBi4buVIHN1bmcgKG9wdGlvbmFsKQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgcmVwb3J0X2RhdGEgPSB7CiAgICAgICAgICAgICAgICAidGFza19pZCI6IHRhc2tfaWQsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgInN0YXR1cyI6IHN0YXR1cywKICAgICAgICAgICAgICAgICJjbGllbnRfbWVzc2FnZSI6IGNsaWVudF9tZXNzYWdlLAogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBkYXRhIG7hur91IGPDswogICAgICAgICAgICBpZiBkYXRhOgogICAgICAgICAgICAgICAgcmVwb3J0X2RhdGFbImRhdGEiXSA9IGRhdGEKCiAgICAgICAgICAgIGlmIHNlbGYuX3NhZmVfcHVibGlzaCgiZG5kdmluYS9jbGllbnQvdGFza19yZXBvcnQiLCBqc29uLmR1bXBzKHJlcG9ydF9kYXRhKSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgZ+G7rWkgYsOhbyBjw6FvIHRhc2sge3Rhc2tfaWR9IHbhu5tpIHRy4bqhbmcgdGjDoWkge3N0YXR1c30iKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGfhu61pIGLDoW8gY8OhbyB0YXNrOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBzZW5kX2Nvbm5lY3Rfbm90aWZpY2F0aW9uKHNlbGYpOgogICAgICAgICIiIkfhu61pIHRow7RuZyBiw6FvIGvhur90IG7hu5FpIMSR4bq/biBzZXJ2ZXIiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGNvbm5lY3RfZGF0YSA9IHsKICAgICAgICAgICAgICAgICJkZXZpY2VfaWQiOiBzZWxmLmRldmljZV9pZCwKICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmIHNlbGYuX3NhZmVfcHVibGlzaCgiZG5kdmluYS9jbGllbnQvY29ubmVjdCIsIGpzb24uZHVtcHMoY29ubmVjdF9kYXRhKSk6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgZ+G7rWkgdGjDtG5nIGLDoW8ga+G6v3QgbuG7kWkgY2hvIHRoaeG6v3QgYuG7iyB7c2VsZi5kZXZpY2VfaWR9IikKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGtoaSBn4butaSB0aMO0bmcgYsOhbyBr4bq/dCBu4buRaToge3N0cihlKX0iKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgcmVnaXN0ZXJfdGFza19oYW5kbGVyKHNlbGYsIHRhc2tfdHlwZTogc3RyLCBoYW5kbGVyOiBDYWxsYWJsZSk6CiAgICAgICAgIiIiCiAgICAgICAgxJDEg25nIGvDvSBoYW5kbGVyIGNobyBsb+G6oWkgdGFzawogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfdHlwZTogTG/huqFpIHRhc2sKICAgICAgICAgICAgaGFuZGxlcjogSMOgbSB44butIGzDvSB0YXNrCiAgICAgICAgIiIiCiAgICAgICAgc2VsZi50YXNrX2hhbmRsZXJzW3Rhc2tfdHlwZV0gPSBoYW5kbGVyCiAgICAKICAgIGRlZiBfcmVhZF9yZWNlbnRfbG9ncyhzZWxmLCBudW1fbGluZXM9MjAwKToKICAgICAgICAiIiIKICAgICAgICDEkOG7jWMgY8OhYyBkw7JuZyBsb2cgZ+G6p24gbmjhuqV0IHThu6sgZmlsZSBhcHAubG9nCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgbnVtX2xpbmVzOiBT4buRIGTDsm5nIGxvZyBj4bqnbiDEkeG7jWMgKG3hurdjIMSR4buLbmggMTAwKQogICAgICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBMaXN0W3N0cl06IERhbmggc8OhY2ggY8OhYyBkw7JuZyBsb2cgZ+G6p24gbmjhuqV0IGhv4bq3YyB0aMO0bmcgYsOhbyBs4buXaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nX2ZpbGVfcGF0aCA9IG9zLnBhdGguam9pbihjb25maWcuQkFTRV9ESVIsICJhcHAubG9nIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBvcy5wYXRoLmV4aXN0cyhsb2dfZmlsZV9wYXRoKToKICAgICAgICAgICAgICAgICMgRmlsZSBjaMawYSDEkcaw4bujYyB04bqhbyBi4bufaSBsb2dnaW5nIHN5c3RlbQogICAgICAgICAgICAgICAgcmV0dXJuIFtmIltJTkZPXSBGaWxlIGxvZyBjaMawYSDEkcaw4bujYyB04bqhbywgY2jGsGEgY8OzIGxvZyBuw6BvIl0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4butIMSR4buNYyBmaWxlIHbhu5tpIHJldHJ5IMSR4buDIHRyw6FuaCB4dW5nIMSR4buZdAogICAgICAgICAgICBtYXhfcmV0cmllcyA9IDMKICAgICAgICAgICAgZm9yIGF0dGVtcHQgaW4gcmFuZ2UobWF4X3JldHJpZXMpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihsb2dfZmlsZV9wYXRoLCAncicsIGVuY29kaW5nPSd1dGYtOCcsIGVycm9ycz0naWdub3JlJykgYXMgZjoKICAgICAgICAgICAgICAgICAgICAgICAgbGluZXMgPSBmLnJlYWRsaW5lcygpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgbnVtX2xpbmVzIGTDsm5nIGN14buRaSBjw7luZwogICAgICAgICAgICAgICAgICAgIHJlY2VudF9saW5lcyA9IGxpbmVzWy1udW1fbGluZXM6XSBpZiBsZW4obGluZXMpID4gbnVtX2xpbmVzIGVsc2UgbGluZXMKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIExv4bqhaSBi4buPIGvDvSB04buxIHh14buRbmcgZMOybmcgdsOgIGPDoWMga2hv4bqjbmcgdHLhuq9uZyB0aOG7q2EKICAgICAgICAgICAgICAgICAgICByZWNlbnRfbG9ncyA9IFtsaW5lLnN0cmlwKCkgZm9yIGxpbmUgaW4gcmVjZW50X2xpbmVzIGlmIGxpbmUuc3RyaXAoKV0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVjZW50X2xvZ3MKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGV4Y2VwdCAoUGVybWlzc2lvbkVycm9yLCBJT0Vycm9yLCBPU0Vycm9yKSBhcyBmaWxlX2Vycm9yOgogICAgICAgICAgICAgICAgICAgIGlmIGF0dGVtcHQgPCBtYXhfcmV0cmllcyAtIDE6CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMC4xKSAgIyBDaOG7nSAxMDBtcyBy4buTaSB0aOG7rSBs4bqhaQogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBbZiJbRVJST1JdIEtow7RuZyB0aOG7gyDEkeG7jWMgZmlsZSBsb2c6IHtzdHIoZmlsZV9lcnJvcil9Il0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4gW2YiW0VSUk9SXSBM4buXaSDEkeG7jWMgZmlsZSBsb2c6IHtzdHIoZSl9Il0KCiAgICBkZWYgc3luY19kYXRhKHNlbGYpOgogICAgICAgICIiIsSQ4buTbmcgYuG7mSBk4buvIGxp4buHdSB24bubaSBzZXJ2ZXIiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgTuG6v3UgY2jGsGEga+G6v3QgbuG7kWkgTVFUVCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiBub3Qgc2VsZi5pc19jb25uZWN0ZWQ6CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiQ2jGsGEga+G6v3QgbuG7kWkgTVFUVCwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGhlbHBlciBzZXJ2aWNlCiAgICAgICAgICAgIGhlbHBlciA9IHNlbGYuaGVscGVyX3NlcnZpY2UKICAgICAgICAgICAgaWYgbm90IGhlbHBlcjoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIGPDsyBoZWxwZXIgc2VydmljZSwga2jDtG5nIHRo4buDIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGRldmljZV9pZAogICAgICAgICAgICBkZXZpY2VfaWQgPSBzZWxmLmRiLmdldF9vcl9jcmVhdGVfZGV2aWNlX2lkKCkKICAgICAgICAgICAgaWYgbm90IGRldmljZV9pZDoKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHjDoWMgxJHhu4tuaCBkZXZpY2VfaWQsIGtow7RuZyB0aOG7gyDEkeG7k25nIGLhu5kgZOG7ryBsaeG7h3UiKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfaW5mbyA9IE5vbmUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGV2aWNlX2luZm9fcmVzcG9uc2UgPSBoZWxwZXIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBO4bq/dSBs4bqleSB0aMOgbmggY8O0bmcsIGzGsHUgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICAgICAgaWYgZGV2aWNlX2luZm9fcmVzcG9uc2VbInN0YXR1cyJdID09ICJzdWNjZXNzIiBhbmQgImRhdGEiIGluIGRldmljZV9pbmZvX3Jlc3BvbnNlOgogICAgICAgICAgICAgICAgICAgICMgTMawdSB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iyB2w6BvIGRhdGFiYXNlCiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5zYXZlX2RldmljZV9pbmZvKGRldmljZV9pbmZvX3Jlc3BvbnNlWyJkYXRhIl0pCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2luZm8gPSBkZXZpY2VfaW5mb19yZXNwb25zZVsiZGF0YSJdCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUaGVvIGTDtWkgUkFNIMSR4buDIHThu7EgxJHhu5luZyByZWJvb3QKICAgICAgICAgICAgICAgICAgICBzZWxmLl9tb25pdG9yX3JhbV91c2FnZShkZXZpY2VfaW5mbykKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIGzhuqV5IHRow7RuZyB0aW4gdGhp4bq/dCBi4buLOiB7ZX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTuG6v3Uga2jDtG5nIGzhuqV5IMSRxrDhu6NjIHRow7RuZyB0aW4gdGhp4bq/dCBi4buLLCBz4butIGThu6VuZyB0aMO0bmcgdGluIMSRw6MgbMawdSB0cm9uZyBkYXRhYmFzZQogICAgICAgICAgICBpZiBub3QgZGV2aWNlX2luZm86CiAgICAgICAgICAgICAgICBkZXZpY2VfaW5mbyA9IHNlbGYuZGIuZ2V0X2RldmljZV9pbmZvKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgZGV2aWNlX2luZm86CiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZygiS2jDtG5nIGPDsyB0aMO0bmcgdGluIHRoaeG6v3QgYuG7iywgxJHhu5NuZyBi4buZIGThu68gbGnhu4d1IGPDsyB0aOG7gyBraMO0bmcgxJHhuqd5IMSR4bunIikKICAgICAgICAgICAgICAgIGRldmljZV9pbmZvID0ge30KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iwogICAgICAgICAgICBkZXZpY2VfY29uZmlnID0gc2VsZi5kYi5nZXRfYWxsX2RldmljZV9jb25maWcoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buZcCBjw6FjIHRy4bqhbmcgdGjDoWkgcnVudGltZSAocGF1c2Vfam9iLCBkZXZpY2VfaXNfd29ya2luZywgZGV2aWNlX21lc3NhZ2UpIHbDoG8gZGV2aWNlX2luZm8KICAgICAgICAgICAgZm9yIHJ1bnRpbWVfa2V5IGluIFsicGF1c2Vfam9iIiwgImRldmljZV9pc193b3JraW5nIiwgImRldmljZV9tZXNzYWdlIl06CiAgICAgICAgICAgICAgICBpZiBydW50aW1lX2tleSBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgICAgIGRldmljZV9pbmZvW3J1bnRpbWVfa2V5XSA9IGRldmljZV9jb25maWcucG9wKHJ1bnRpbWVfa2V5KQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEdpw6EgdHLhu4sgbeG6t2MgxJHhu4tuaCBu4bq/dSBjaMawYSBj4bqldSBow6xuaAogICAgICAgICAgICAgICAgICAgIGRldmljZV9pbmZvW3J1bnRpbWVfa2V5XSA9IEZhbHNlIGlmIHJ1bnRpbWVfa2V5ICE9ICJkZXZpY2VfbWVzc2FnZSIgZWxzZSAiIgogICAgICAgICAgICAKICAgICAgICAgICAgIyBMb+G6oWkgYuG7jyBnb2xpa2VfcmVwb3J0IGto4buPaSBkZXZpY2VfY29uZmlnIMSR4buDIGfhu61pIHJpw6puZwogICAgICAgICAgICBnb2xpa2VfcmVwb3J0ID0gTm9uZQogICAgICAgICAgICBpZiAiZ29saWtlX3JlcG9ydCIgaW4gZGV2aWNlX2NvbmZpZzoKICAgICAgICAgICAgICAgIGdvbGlrZV9yZXBvcnQgPSBkZXZpY2VfY29uZmlnLnBvcCgiZ29saWtlX3JlcG9ydCIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIExv4bqhaSBi4buPIGdvbGlrZV9hcGlfYmFzZSBraOG7j2kgZGV2aWNlX2NvbmZpZwogICAgICAgICAgICBpZiAiZ29saWtlX2FwaV9iYXNlIiBpbiBkZXZpY2VfY29uZmlnOgogICAgICAgICAgICAgICAgZGV2aWNlX2NvbmZpZy5wb3AoImdvbGlrZV9hcGlfYmFzZSIpCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIsSQw6MgbG/huqFpIGLhu48gZ29saWtlX2FwaV9iYXNlIGto4buPaSBk4buvIGxp4buHdSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBtaW5pbmdfaW5mbyB04burIG1pbmluZ19zZXJ2aWNlIChu4bq/dSBjw7MpCiAgICAgICAgICAgIG1pbmluZ19pbmZvID0gTm9uZQogICAgICAgICAgICBpZiBzZWxmLm1pbmluZ19zZXJ2aWNlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG1pbmluZ19zdW1tYXJ5ID0gc2VsZi5taW5pbmdfc2VydmljZS5nZXRfbWluaW5nX3N1bW1hcnkoKQogICAgICAgICAgICAgICAgICAgIGlmIG1pbmluZ19zdW1tYXJ5LmdldCgic3VjY2VzcyIpOgogICAgICAgICAgICAgICAgICAgICAgICBtaW5pbmdfaW5mbyA9IG1pbmluZ19zdW1tYXJ5CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIkzhuqV5IG1pbmluZyBpbmZvOiB7bWluaW5nX2luZm8uZ2V0KCdydW5uaW5nX21pbmVycycsIDApfS97bWluaW5nX2luZm8uZ2V0KCd0b3RhbF9taW5lcnMnLCAwKX0gbWluZXJzIikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIkzhu5dpIGtoaSBs4bqleSBtaW5pbmcgaW5mbzoge2V9IikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IGPDoWMgdMOgaSBraG/huqNuIGNoxrBhIMSR4buTbmcgYuG7mQogICAgICAgICAgICBwZW5kaW5nX2FjY291bnRzID0gc2VsZi5kYi5nZXRfcGVuZGluZ19zeW5jX2l0ZW1zKCJhY2NvdW50cyIsIGxpbWl0PTUwKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBM4bqleSBjw6FjIGpvYiBjaMawYSDEkeG7k25nIGLhu5kKICAgICAgICAgICAgcGVuZGluZ19qb2JzID0gc2VsZi5kYi5nZXRfcGVuZGluZ19zeW5jX2l0ZW1zKCJqb2JzX2hpc3RvcnkiLCBsaW1pdD01MCkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDhu41jIDIwMCBkw7JuZyBsb2cgZ+G6p24gbmjhuqV0CiAgICAgICAgICAgIHJlY2VudF9sb2dzID0gc2VsZi5fcmVhZF9yZWNlbnRfbG9ncygyMDApCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBU4bqhbyBwYXlsb2FkCiAgICAgICAgICAgIHBheWxvYWQgPSB7CiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogZGV2aWNlX2lkLAogICAgICAgICAgICAgICAgImRldmljZV9pbmZvIjogZGV2aWNlX2luZm8sCiAgICAgICAgICAgICAgICAiZGV2aWNlX2NvbmZpZyI6IGRldmljZV9jb25maWcsCiAgICAgICAgICAgICAgICAibWV0YV9kYXRhIjogewogICAgICAgICAgICAgICAgICAgICJkZXZpY2VfbG9ncyI6IHJlY2VudF9sb2dzCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgInRpbWVzdGFtcCI6IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBnb2xpa2VfcmVwb3J0IG7hur91IGPDswogICAgICAgICAgICBpZiBnb2xpa2VfcmVwb3J0OgogICAgICAgICAgICAgICAgcGF5bG9hZFsiZ29saWtlX3JlcG9ydCJdID0gZ29saWtlX3JlcG9ydAogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaMOqbSBtaW5pbmdfaW5mbyBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgbWluaW5nX2luZm86CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJtaW5pbmdfaW5mbyJdID0gbWluaW5nX2luZm8KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIHTDoGkga2hv4bqjbiBjaMawYSDEkeG7k25nIGLhu5kgbuG6v3UgY8OzCiAgICAgICAgICAgIGlmIHBlbmRpbmdfYWNjb3VudHM6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJhY2NvdW50cyJdID0gcGVuZGluZ19hY2NvdW50cwogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDhu5NuZyBi4buZIHtsZW4ocGVuZGluZ19hY2NvdW50cyl9IHTDoGkga2hv4bqjbiBjaMawYSDEkeG7k25nIGLhu5kiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgVGjDqm0gam9iIGNoxrBhIMSR4buTbmcgYuG7mSBu4bq/dSBjw7MKICAgICAgICAgICAgaWYgcGVuZGluZ19qb2JzOgogICAgICAgICAgICAgICAgcGF5bG9hZFsiam9icyJdID0gcGVuZGluZ19qb2JzCiAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoZiLEkOG7k25nIGLhu5kge2xlbihwZW5kaW5nX2pvYnMpfSBqb2IgY2jGsGEgxJHhu5NuZyBi4buZIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEfhu61pIGThu68gbGnhu4d1CiAgICAgICAgICAgIHNlbGYuX3NhZmVfcHVibGlzaChjb25maWcuTVFUVF9UT1BJQ19DTElFTlRfU1lOQywganNvbi5kdW1wcyhwYXlsb2FkKSkKICAgICAgICAgICAgCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSB24bubaSBzZXJ2ZXIiKQogICAgCiAgICBkZWYgc3RhcnRfc3luY190aHJlYWQoc2VsZik6CiAgICAgICAgIiIiQuG6r3QgxJHhuqd1IHRocmVhZCDEkeG7k25nIGLhu5kgdOG7sSDEkeG7mW5nIiIiCiAgICAgICAgaWYgc2VsZi5zeW5jX3RocmVhZCBpcyBub3QgTm9uZSBhbmQgc2VsZi5zeW5jX3RocmVhZC5pc19hbGl2ZSgpOgogICAgICAgICAgICBsb2dnZXIud2FybmluZygiVGhyZWFkIMSR4buTbmcgYuG7mSDEkcOjIMSRYW5nIGNo4bqheSIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICBzZWxmLnJ1bm5pbmcgPSBUcnVlCiAgICAgICAgc2VsZi5zdG9wX2V2ZW50LmNsZWFyKCkKICAgICAgICBzZWxmLnN5bmNfdGhyZWFkID0gdGhyZWFkaW5nLlRocmVhZCh0YXJnZXQ9c2VsZi5fc3luY19sb29wLCBkYWVtb249VHJ1ZSkKICAgICAgICBzZWxmLnN5bmNfdGhyZWFkLnN0YXJ0KCkKICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBraOG7n2kgxJHhu5luZyB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIpCiAgICAKICAgIGRlZiBfc3luY19sb29wKHNlbGYpOgogICAgICAgICIiIkxvb3AgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIiIgogICAgICAgIGxvZ2dlci5pbmZvKGYiQuG6r3QgxJHhuqd1IMSR4buTbmcgYuG7mSB04buxIMSR4buZbmcgbeG7l2kge3NlbGYuc3luY19pbnRlcnZhbH0gZ2nDonkiKQoKICAgICAgICB3aGlsZSBub3Qgc2VsZi5zdG9wX2V2ZW50LmlzX3NldCgpIGFuZCBzZWxmLnJ1bm5pbmc6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIHNlbGYuaXNfY29ubmVjdGVkOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc3luY19kYXRhKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgdHJvbmcgcXXDoSB0csOsbmggxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZzoge3N0cihlKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICMgTmdo4buJIMSR4bq/biBs4bqnbiDEkeG7k25nIGLhu5kgdGnhur9wIHRoZW8KICAgICAgICAgICAgZm9yIF8gaW4gcmFuZ2Uoc2VsZi5zeW5jX2ludGVydmFsKToKICAgICAgICAgICAgICAgIGlmIHNlbGYuc3RvcF9ldmVudC5pc19zZXQoKSBvciBub3Qgc2VsZi5ydW5uaW5nOgogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDEpCiAgICAKICAgIGRlZiBzdG9wX3N5bmNfdGhyZWFkKHNlbGYpOgogICAgICAgICIiIkThu6tuZyB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIiIgogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgc2VsZi5zdG9wX2V2ZW50LnNldCgpCiAgICAgICAgaWYgc2VsZi5zeW5jX3RocmVhZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5zeW5jX3RocmVhZC5qb2luKHRpbWVvdXQ9Mi4wKQogICAgICAgICAgICBzZWxmLnN5bmNfdGhyZWFkID0gTm9uZQogICAgICAgIGxvZ2dlci5pbmZvKCLEkMOjIGThu6tuZyB0aHJlYWQgxJHhu5NuZyBi4buZIHThu7EgxJHhu5luZyIpCiAgICAKICAgIGRlZiBkaXNjb25uZWN0KHNlbGYpOgogICAgICAgICIiIk5n4bqvdCBr4bq/dCBu4buRaSBNUVRUIiIiCiAgICAgICAgc2VsZi5tYW51YWxfZGlzY29ubmVjdCA9IFRydWUgICMgxJDDoW5oIGThuqV1IMSRw6J5IGzDoCBkaXNjb25uZWN0IGPDsyBjaOG7pyDDvQogICAgICAgIHNlbGYuc3RvcF9zeW5jX3RocmVhZCgpCiAgICAgICAgCiAgICAgICAgIyBE4burbmcgc3RyZWFtIG7hur91IMSRYW5nIGNo4bqheQogICAgICAgIHNlbGYuc3RvcF9zdHJlYW0oKQogICAgICAgIAogICAgICAgIGlmIHNlbGYuY2xpZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLmNsaWVudC5sb29wX3N0b3AoKQogICAgICAgICAgICBzZWxmLmNsaWVudC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgc2VsZi5pc19jb25uZWN0ZWQgPSBGYWxzZQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBuZ+G6r3Qga+G6v3QgbuG7kWkgTVFUVCIpCiAgICAgICAgCiAgICAgICAgIyBE4burbmcgdOG6pXQgY+G6oyBhdXRvLXJlY29ubmVjdAogICAgICAgIHNlbGYuc3RvcF9ldmVudC5zZXQoKQogICAgCiAgICBkZWYgc2V0dXBfbXF0dF9oYW5kbGVycyhzZWxmKToKICAgICAgICAiIiJUaGnhur90IGzhuq1wIGPDoWMgaGFuZGxlciBjaG8gTVFUVCB0YXNrcyIiIgogICAgICAgICMgxJDEg25nIGvDvSBjw6FjIHRhc2sgaGFuZGxlciBt4bq3YyDEkeG7i25oCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9jb25maWciLCBzZWxmLl9oYW5kbGVfdXBkYXRlX2RldmljZV9jb25maWcpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9zeW5jZWQiLCBzZWxmLl9oYW5kbGVfdXBkYXRlX3N5bmNlZCkKICAgICAgICBzZWxmLnJlZ2lzdGVyX3Rhc2tfaGFuZGxlcigiYWNjb3VudF91cGRhdGUiLCBzZWxmLl9oYW5kbGVfYWNjb3VudF91cGRhdGUpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9wcm94eSIsIHNlbGYuX2hhbmRsZV91cGRhdGVfcHJveHkpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInVwZGF0ZV9taW5pbmdfY29uZmlnIiwgc2VsZi5faGFuZGxlX21pbmluZ19jb25maWdfdXBkYXRlKQogICAgICAgIHNlbGYucmVnaXN0ZXJfdGFza19oYW5kbGVyKCJzdHJlYW1fbG9nIiwgc2VsZi5faGFuZGxlX3N0cmVhbV9sb2cpCiAgICAgICAgc2VsZi5yZWdpc3Rlcl90YXNrX2hhbmRsZXIoInJ1bl9jbWQiLCBzZWxmLl9oYW5kbGVfcnVuX2NtZCkKICAgICAgICBzZWxmLnJlZ2lzdGVyX3Rhc2tfaGFuZGxlcigiZmxhc2hfbGlnaHQiLCBzZWxmLl9oYW5kbGVfZmxhc2hfbGlnaHQpCiAgICAgICAgCiAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgdGhp4bq/dCBs4bqtcCBjw6FjIE1RVFQgdGFzayBoYW5kbGVyIikKICAgIAogICAgZGVmIF9oYW5kbGVfbWluaW5nX2NvbmZpZ191cGRhdGUoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIHVwZGF0ZSBtaW5pbmcgY29uZmlnIHThu6sgc2VydmVyCiAgICAgICAgCiAgICAgICAgVGFzayBmb3JtYXQgdOG7qyBzZXJ2ZXIgTVFUVDoKICAgICAgICB7CiAgICAgICAgICAgICJ0YXNrX2lkIjogInRhc2tfMTIzNDU2Nzg5MF8xMjMiLAogICAgICAgICAgICAiZGV2aWNlX2lkIjogImRldmljZS0wMDEiLAogICAgICAgICAgICAidGFza190eXBlIjogInVwZGF0ZV9taW5pbmdfY29uZmlnIiwKICAgICAgICAgICAgImRhdGEiOiB7CiAgICAgICAgICAgICAgICAibWluaW5nX2NvbmZpZyI6IFsKICAgICAgICAgICAgICAgICAgICB7ICJjb2luX25hbWUiOiAiVlJTQyIsICJtaW5pbmdfdG9vbCI6ICJjY21pbmVyIiwgImNvbmZpZyI6IHsuLi59IH0sCiAgICAgICAgICAgICAgICAgICAgeyAiY29pbl9uYW1lIjogIkRFUk8iLCAibWluaW5nX3Rvb2wiOiAiYXN0cm9taW5lciIsICJjb25maWciOiB7Li4ufSB9CiAgICAgICAgICAgICAgICBdCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJtZXNzYWdlIjogIkPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCBtaW5pbmciLAogICAgICAgICAgICAidGltZXN0YW1wIjogIjIwMjUtMTAtMjhULi4uIgogICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgbWluaW5nX2NvbmZpZ19hcnJheSA9IGRhdGEuZ2V0KCJtaW5pbmdfY29uZmlnIiwgW10pCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCBtaW5pbmcgY29uZmlnIHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJNaW5pbmcgY29uZmlnIHThu6sgTVFUVCBjw7Mge2xlbihtaW5pbmdfY29uZmlnX2FycmF5KX0gbWluZXJzOiIpCiAgICAgICAgICAgIGZvciBtaW5lciBpbiBtaW5pbmdfY29uZmlnX2FycmF5OgogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiIgIC0ge21pbmVyLmdldCgnY29pbl9uYW1lJywgJ1Vua25vd24nKX0gKHttaW5lci5nZXQoJ21pbmluZ190b29sJywgJ1Vua25vd24nKX0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBtaW5pbmdfc2VydmljZSBjw7MgdOG7k24gdOG6oWkga2jDtG5nCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLm1pbmluZ19zZXJ2aWNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gIk1pbmluZyBzZXJ2aWNlIGNoxrBhIMSRxrDhu6NjIGto4bufaSB04bqhbyIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiBub3QgbWluaW5nX2NvbmZpZ19hcnJheToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJNaW5pbmcgY29uZmlnIGFycmF5IHLhu5duZyIKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGVycm9yX21zZykKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgVOG6oW8gY29uZmlnIG9iamVjdCDEkeG7gyBn4butaSBzYW5nIG1pbmluZyBBUEkKICAgICAgICAgICAgIyBhdXRvX3N0YXJ0IG3hurdjIMSR4buLbmggdHJ1ZQogICAgICAgICAgICAjIGxhc3Rfc3luY19jb25maWcgbMOgIHRpbWVzdGFtcCBoaeG7h24gdOG6oWkKICAgICAgICAgICAgY29uZmlnX3RvX3VwZGF0ZSA9IHsKICAgICAgICAgICAgICAgICJsYXN0X3N5bmNfY29uZmlnIjogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICJhdXRvX3N0YXJ0IjogVHJ1ZSwKICAgICAgICAgICAgICAgICJtaW5lcnMiOiBtaW5pbmdfY29uZmlnX2FycmF5CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJBhbmcgdXBkYXRlIHtsZW4obWluaW5nX2NvbmZpZ19hcnJheSl9IG1pbmVycyB24bubaSBhdXRvX3N0YXJ0PVRydWUiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSB0cuG7sWMgdGnhur9wIHVwZGF0ZV9jb25maWcgKGZvcmNlPVRydWUgbeG6t2MgxJHhu4tuaCkgxJHhu4MgxJHDqCBjb25maWcKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5taW5pbmdfc2VydmljZS51cGRhdGVfY29uZmlnKGNvbmZpZ190b191cGRhdGUpCiAgICAgICAgICAgIAogICAgICAgICAgICBpZiByZXN1bHQuZ2V0KCJzdWNjZXNzIik6CiAgICAgICAgICAgICAgICAjIEzhuqV5IHN1bW1hcnkgxJHhu4MgYsOhbyBjw6FvCiAgICAgICAgICAgICAgICBzdW1tYXJ5ID0gc2VsZi5taW5pbmdfc2VydmljZS5nZXRfbWluaW5nX3N1bW1hcnkoKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBtZXNzYWdlID0gKAogICAgICAgICAgICAgICAgICAgIGYixJDDoyBj4bqtcCBuaOG6rXQgbWluaW5nIGNvbmZpZzogIgogICAgICAgICAgICAgICAgICAgIGYie3N1bW1hcnkuZ2V0KCdydW5uaW5nX21pbmVycycsIDApfS97c3VtbWFyeS5nZXQoJ3RvdGFsX21pbmVycycsIDApfSBtaW5lcnMgcnVubmluZyIKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8obWVzc2FnZSkKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgbWVzc2FnZSkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiS2jDtG5nIHRo4buDIHVwZGF0ZSBtaW5pbmcgY29uZmlnOiB7cmVzdWx0LmdldCgnZXJyb3InLCAnVW5rbm93biBlcnJvcicpfSIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnZXIuZXhjZXB0aW9uKGUsICJM4buXaSBraGkgeOG7rSBsw70gbWluaW5nIGNvbmZpZyB1cGRhdGUiKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIiksCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKSwKICAgICAgICAgICAgICAgICJmYWlsZWQiLAogICAgICAgICAgICAgICAgZiJM4buXaToge3N0cihlKX0iCiAgICAgICAgICAgICkKICAgICAgICAKICAgIGRlZiBfaGFuZGxlX3VwZGF0ZV9kZXZpY2VfY29uZmlnKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICBjb25maWdfZGF0YSA9IHRhc2tfZGF0YS5nZXQoImNvbmZpZ19kYXRhIiwge30pCiAgICAgICAgICAgIGlmIG5vdCBjb25maWdfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJE4buvIGxp4buHdSBj4bqldSBow6xuaCB0aGnhur90IGLhu4sgcuG7l25nIikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiROG7ryBsaeG7h3UgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIHLhu5duZyIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgTMawdSB04burbmcgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnNhdmVfZGV2aWNlX2NvbmZpZyhjb25maWdfZGF0YSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHN1Y2Nlc3M6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izogeycsICcuam9pbihjb25maWdfZGF0YS5rZXlzKCkpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHThuqV0IGPhuqMgdMOgaSBraG/huqNuIGzDoCBjaMawYSBzeW5jIMSR4buDIMSR4bqjbSBi4bqjbyB0aMO0bmcgdGluIG3hu5tpIG5o4bqldCDEkcaw4bujYyBn4butaSBsw6puIHNlcnZlcgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfYWNjb3VudHMgPSBzZWxmLmRiLm1hcmtfYWxsX2FjY291bnRzX25vdF9zeW5jZWQoKQogICAgICAgICAgICAgICAgICAgIGlmIHVwZGF0ZWRfYWNjb3VudHMgPiAwOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHDoW5oIGThuqV1IHt1cGRhdGVkX2FjY291bnRzfSB0w6BpIGtob+G6o24gbMOgIGNoxrBhIHN5bmMgc2F1IGtoaSBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggdGhp4bq/dCBi4buLIikKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIktow7RuZyBjw7MgdMOgaSBraG/huqNuIG7DoG8gY+G6p24gxJHDoW5oIGThuqV1IGNoxrBhIHN5bmMiKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTOG7l2kga2hpIMSRw6FuaCBk4bqldSB0w6BpIGtob+G6o24gY2jGsGEgc3luYzoge2V9IikKICAgICAgICAgICAgICAgICAgICAjIEtow7RuZyBmYWlsIHRhc2sgdsOsIHZp4buHYyBj4bqtcCBuaOG6rXQgY29uZmlnIMSRw6MgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgQ+G6rXAgbmjhuq10IHN5bmNfaW50ZXJ2YWwgbuG6v3UgbsOzIHRoYXkgxJHhu5VpCiAgICAgICAgICAgICAgICBpZiAic3luY19pbnRlcnZhbCIgaW4gY29uZmlnX2RhdGE6CiAgICAgICAgICAgICAgICAgICAgbmV3X3N5bmNfaW50ZXJ2YWwgPSBjb25maWdfZGF0YVsic3luY19pbnRlcnZhbCJdCiAgICAgICAgICAgICAgICAgICAgaWYgbmV3X3N5bmNfaW50ZXJ2YWwgIT0gc2VsZi5zeW5jX2ludGVydmFsOgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkPhuq1wIG5o4bqtdCBzeW5jX2ludGVydmFsIHThu6sge3NlbGYuc3luY19pbnRlcnZhbH0gdGjDoG5oIHtuZXdfc3luY19pbnRlcnZhbH0iKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN5bmNfaW50ZXJ2YWwgPSBuZXdfc3luY19pbnRlcnZhbAogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgIyBLaOG7n2kgxJHhu5luZyBs4bqhaSB0aHJlYWQgxJHhu5NuZyBi4buZIG7hur91IMSRYW5nIGNo4bqheQogICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnN5bmNfdGhyZWFkIGlzIG5vdCBOb25lIGFuZCBzZWxmLnN5bmNfdGhyZWFkLmlzX2FsaXZlKCk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiS2jhu59pIMSR4buZbmcgbOG6oWkgdGhyZWFkIMSR4buTbmcgYuG7mSB24bubaSBraG/huqNuZyB0aOG7nWkgZ2lhbiBt4bubaSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnN0b3Bfc3luY190aHJlYWQoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGFydF9zeW5jX3RocmVhZCgpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgVGjDtG5nIGLDoW8gY2hvIEpvYlNlcnZpY2UgduG7gSB04bqldCBj4bqjIGNvbmZpZyB1cGRhdGUKICAgICAgICAgICAgICAgIGlmIHNlbGYuam9iX3NlcnZpY2UgYW5kIGhhc2F0dHIoc2VsZi5qb2Jfc2VydmljZSwgJ2hhbmRsZV9tcXR0X2NvbmZpZ191cGRhdGUnKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiVGjDtG5nIGLDoW8gSm9iU2VydmljZSB24buBIGNvbmZpZyB1cGRhdGUiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuam9iX3NlcnZpY2UuaGFuZGxlX21xdHRfY29uZmlnX3VwZGF0ZShjb25maWdfZGF0YSkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgIyBMb2cgdGjDqm0gdGjDtG5nIHRpbiB24buBIGpvYi1yZWxhdGVkIGNvbmZpZ3MKICAgICAgICAgICAgICAgIGpvYl9yZWxhdGVkX2tleXMgPSBbIm1heF9qb2JzX3Blcl9kYXkiLCAibWF4X2pvYnNfcGVyX3Nlc3Npb24iLCAiam9iX2ludGVydmFsX3NlY29uZHMiLCAiY2FyZV9pbl93b3JraW5nX2pvYiJdCiAgICAgICAgICAgICAgICBpZiBhbnkoa2V5IGluIGNvbmZpZ19kYXRhIGZvciBrZXkgaW4gam9iX3JlbGF0ZWRfa2V5cyk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkPhuqV1IGjDrG5oIGxpw6puIHF1YW4gxJHhur9uIEpvYlNlcnZpY2UgxJHDoyDEkcaw4bujYyBj4bqtcCBuaOG6rXQiKQogICAgICAgICAgICAgICAgICAgICMgSm9iU2VydmljZSBz4bq9IHjhu60gbMO9IGxvZ2ljIHJlc3RhcnQgc2Vzc2lvbiBu4bq/dSBj4bqnbiB0aGnhur90CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgR+G7rWkgYsOhbyBjw6FvIHRow6BuaCBjw7RuZwogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgInN1Y2Nlc3MiLCBmIsSQw6MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izogeycsICcuam9pbihjb25maWdfZGF0YS5rZXlzKCkpfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7iyIKICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IGPhuqV1IGjDrG5oIHRoaeG6v3QgYuG7izoge3N0cihlKX0iCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfc3luY2VkKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBj4bqtcCBuaOG6rXQgdHLhuqFuZyB0aMOhaSDEkeG7k25nIGLhu5kKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICB0YXNrX2RhdGE6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZygiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZIHThu6sgc2VydmVyIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGFjY291bnRfY291bnQgPSAwCiAgICAgICAgICAgIGpvYl9jb3VudCA9IDAKICAgICAgICAgICAgCiAgICAgICAgICAgICMgxJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIMSR4buTbmcgYuG7mQogICAgICAgICAgICBpZiAiYWNjb3VudHMiIGluIGRhdGEgYW5kIGlzaW5zdGFuY2UoZGF0YVsiYWNjb3VudHMiXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3IgYWNjb3VudF91dWlkIGluIGRhdGFbImFjY291bnRzIl06CiAgICAgICAgICAgICAgICAgICAgc2VsZi5kYi5tYXJrX2FzX3N5bmNlZCgiYWNjb3VudHMiLCBhY2NvdW50X3V1aWQpCiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYixJDDoW5oIGThuqV1IHTDoGkga2hv4bqjbiDEkcOjIMSR4buTbmcgYuG7mToge2FjY291bnRfdXVpZH0iKQogICAgICAgICAgICAgICAgYWNjb3VudF9jb3VudCA9IGxlbihkYXRhWyJhY2NvdW50cyJdKQogICAgICAgICAgICAKICAgICAgICAgICAgIyDEkMOhbmggZOG6pXUgam9iIMSRw6MgxJHhu5NuZyBi4buZCiAgICAgICAgICAgIGlmICJqb2JzIiBpbiBkYXRhIGFuZCBpc2luc3RhbmNlKGRhdGFbImpvYnMiXSwgbGlzdCk6CiAgICAgICAgICAgICAgICBmb3Igam9iX3V1aWQgaW4gZGF0YVsiam9icyJdOgogICAgICAgICAgICAgICAgICAgIHNlbGYuZGIubWFya19hc19zeW5jZWQoImpvYnNfaGlzdG9yeSIsIGpvYl91dWlkKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIsSQw6FuaCBk4bqldSBqb2IgxJHDoyDEkeG7k25nIGLhu5k6IHtqb2JfdXVpZH0iKQogICAgICAgICAgICAgICAgam9iX2NvdW50ID0gbGVuKGRhdGFbImpvYnMiXSkKICAgICAgICAgICAgCiAgICAgICAgICAgICMgSGnhu4NuIHRo4buLIHRow7RuZyBiw6FvIHThu5VuZyBo4bujcCBob+G6t2MgdGjDtG5nIGLDoW8gdOG7qyBzZXJ2ZXIKICAgICAgICAgICAgaWYgIm1lc3NhZ2UiIGluIHRhc2tfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiVGjDtG5nIGLDoW8gdOG7qyBzZXJ2ZXI6IHt0YXNrX2RhdGFbJ21lc3NhZ2UnXX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBIaeG7g24gdGjhu4sgdGjDtG5nIGLDoW8gdOG7lW5nIGjhu6NwIG7hur91IGtow7RuZyBjw7MgbWVzc2FnZSB04burIHNlcnZlcgogICAgICAgICAgICAgICAgaWYgYWNjb3VudF9jb3VudCA+IDAgb3Igam9iX2NvdW50ID4gMDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgxJHhu5NuZyBi4buZIHRow6BuaCBjw7RuZzoge2FjY291bnRfY291bnR9IHTDoGkga2hv4bqjbiwge2pvYl9jb3VudH0gam9iIikKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kgeOG7rSBsw70gY+G6rXAgbmjhuq10IHRy4bqhbmcgdGjDoWkgxJHhu5NuZyBi4buZOiB7c3RyKGUpfSIpCiAgICAgICAgICAgIAogICAgCiAgICBkZWYgX2hhbmRsZV9hY2NvdW50X3VwZGF0ZShzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgY+G6rXAgbmjhuq10IHRow7RuZyB0aW4gdMOgaSBraG/huqNuCiAgICAgICAgCiAgICAgICAgQXJnczoKICAgICAgICAgICAgdGFza19kYXRhOiBE4buvIGxp4buHdSB0YXNrIHThu6sgc2VydmVyIGPDsyBj4bqldSB0csO6YzoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgInRhc2tfaWQiOiAidGFza18xNzQ5Mzk5NTM2MjcyXzY0MSIsCiAgICAgICAgICAgICAgICAiZGV2aWNlX2lkIjogImExMjVmNjI0ZjQxYTRmN2MiLAogICAgICAgICAgICAgICAgInRhc2tfdHlwZSI6ICJhY2NvdW50X3VwZGF0ZSIsCiAgICAgICAgICAgICAgICAiZGF0YSI6IHsKICAgICAgICAgICAgICAgICAgICAiYXBwIjogImluc3RhZ3JhbSIsCiAgICAgICAgICAgICAgICAgICAgInN0YXR1cyI6ICJpbmFjdGl2ZSIsCgogICAgICAgICAgICAgICAgICAgICJqb2JfdG9kYXkiOiAzMCwKICAgICAgICAgICAgICAgICAgICAiam9iX2VuYWJsZSI6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgImFjY291bnRfdXVpZCI6ICI3ZWQ5NTU3ZC03NmE0LTQ3ZjctODg1MC03Y2VlZjBjNjkwYWYiCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAiIiwKICAgICAgICAgICAgICAgICJzdGF0dXMiOiAicGVuZGluZyIKICAgICAgICAgICAgfQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgdGFza19pZCA9IHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKQogICAgICAgICAgICBkZXZpY2VfaWQgPSB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKQogICAgICAgICAgICBkYXRhID0gdGFza19kYXRhLmdldCgiZGF0YSIsIHt9KQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gecOqdSBj4bqndSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCBkYXRhIG9yICJhY2NvdW50X3V1aWQiIG5vdCBpbiBkYXRhOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIkThu68gbGnhu4d1IHTDoGkga2hv4bqjbiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgIkThu68gbGnhu4d1IHTDoGkga2hv4bqjbiBraMO0bmcgaOG7o3AgbOG7hyIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIEzhuqV5IHTDoGkga2hv4bqjbiB04burIERCCiAgICAgICAgICAgIGFjY291bnQgPSBzZWxmLmRiLmdldF9hY2NvdW50X2J5X3V1aWQoZGF0YVsiYWNjb3VudF91dWlkIl0pCiAgICAgICAgICAgIGlmIG5vdCBhY2NvdW50OgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJLaMO0bmcgdMOsbSB0aOG6pXkgdMOgaSBraG/huqNuIHbhu5tpIFVVSUQ6IHtkYXRhWydhY2NvdW50X3V1aWQnXX0iCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBD4bqtcCBuaOG6rXQgdGjDtG5nIHRpbiB0w6BpIGtob+G6o24KICAgICAgICAgICAgdXBkYXRlX2RhdGEgPSB7fQogICAgICAgICAgICB2YWxpZF9maWVsZHMgPSBbInN0YXR1cyIsICJqb2JfZW5hYmxlIiwgImpvYl9kaXNhYmxlX3VudGlsIiwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgImRpc2FibGVfZm9sbG93IiwgImZvbGxvd19kaXNhYmxlX3VudGlsIiwgImZvbGxvd190b2RheSIsICJmb2xsb3dfaW5fc2Vzc2lvbiIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICJtYXhfZm9sbG93X2RheSIsICJtYXhfZm9sbG93X3Nlc3Npb24iLCAiaW5hY3RpdmVfZm9sbG93X3JlYXNvbiJdCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEtp4buDbSB0cmEgbuG6v3Ugc3RhdHVzID0gImRlbGV0ZSIgdGjDrCB4w7NhIHTDoGkga2hv4bqjbgogICAgICAgICAgICBpZiBkYXRhLmdldCgic3RhdHVzIikgPT0gImRlbGV0ZSI6CiAgICAgICAgICAgICAgICBhY2NvdW50X3V1aWQgPSBkYXRhWyJhY2NvdW50X3V1aWQiXQogICAgICAgICAgICAgICAgYWNjb3VudF91c2VybmFtZSA9IGFjY291bnQuZ2V0KCJ1bmlxdWVfdXNlcm5hbWUiLCAiVW5rbm93biIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgeMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IChVVUlEOiB7YWNjb3VudF91dWlkfSkiKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIDEuIFjDs2EgdOG6pXQgY+G6oyBqb2IgaGlzdG9yeSBj4bunYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGpvYl9oaXN0b3J5X2RlbGV0ZWQgPSBzZWxmLmRiLmRlbGV0ZV9qb2JfaGlzdG9yeV9ieV9hY2NvdW50KGFjY291bnRfdXVpZCkKICAgICAgICAgICAgICAgIGlmIGpvYl9oaXN0b3J5X2RlbGV0ZWQ6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiLEkMOjIHjDs2Egam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHRo4buDIHjDs2Egam9iIGhpc3RvcnkgY+G7p2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICMgMi4gWMOzYSB0w6BpIGtob+G6o24KICAgICAgICAgICAgICAgIGFjY291bnRfZGVsZXRlZCA9IHNlbGYuZGIuZGVsZXRlX2FjY291bnQoYWNjb3VudFsiaWQiXSkKICAgICAgICAgICAgICAgIGlmIGFjY291bnRfZGVsZXRlZDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIsSQw6MgeMOzYSB0w6BpIGtob+G6o24ge2FjY291bnRfdXNlcm5hbWV9IChJRDoge2FjY291bnRbJ2lkJ119KSBraOG7j2kgZGF0YWJhc2UiKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgZiLEkMOjIHjDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGVycm9yX21zZyA9IGYiS2jDtG5nIHRo4buDIHjDs2EgdMOgaSBraG/huqNuIHthY2NvdW50X3VzZXJuYW1lfSIKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgIGZvciBrZXksIHZhbHVlIGluIGRhdGEuaXRlbXMoKToKICAgICAgICAgICAgICAgIGlmIGtleSBpbiB2YWxpZF9maWVsZHM6CiAgICAgICAgICAgICAgICAgICAgdXBkYXRlX2RhdGFba2V5XSA9IHZhbHVlCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIG5vdCB1cGRhdGVfZGF0YToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJLaMO0bmcgY8OzIHRow7RuZyB0aW4gY+G6p24gY+G6rXAgbmjhuq10IikKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCAiS2jDtG5nIGPDsyB0aMO0bmcgdGluIGPhuqduIGPhuq1wIG5o4bqtdCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgIyBMxrB1IGzhuqFpIHbDoG8gREIKICAgICAgICAgICAgdXBkYXRlX2RhdGFbImlzX3N5bmMiXSA9IEZhbHNlCiAgICAgICAgICAgIHN1Y2Nlc3MgPSBzZWxmLmRiLnVwZGF0ZV9hY2NvdW50KGFjY291bnRbImlkIl0sIHVwZGF0ZV9kYXRhKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc3VjY2VzczoKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuIHthY2NvdW50LmdldCgndW5pcXVlX3VzZXJuYW1lJywgJycpfSAoVVVJRDoge2RhdGFbJ2FjY291bnRfdXVpZCddfSkgduG7m2kgZOG7ryBsaeG7h3U6IHt1cGRhdGVfZGF0YX0iKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgInN1Y2Nlc3MiLCBmIsSQw6MgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICcnKX0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJLaMO0bmcgdGjhu4MgY+G6rXAgbmjhuq10IHTDoGkga2hv4bqjbiB7YWNjb3VudC5nZXQoJ3VuaXF1ZV91c2VybmFtZScsICcnKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgdMOgaSBraG/huqNuOiB7c3RyKGUpfSIKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGVycm9yX21zZykKICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKCiAgICBkZWYgX2hhbmRsZV91cGRhdGVfcHJveHkoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGPhuq1wIG5o4bqtdCBj4bqldSBow6xuaCBwcm94eQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHRhc2tfZGF0YTogROG7ryBsaeG7h3UgdGFzayB04burIHNlcnZlciBjw7MgY+G6pXUgdHLDumM6CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICJ0YXNrX2lkIjogInRhc2tfMTc0OTM5OTUzNjI3Ml82NDEiLAogICAgICAgICAgICAgICAgImRldmljZV9pZCI6ICJhMTI1ZjYyNGY0MWE0ZjdjIiwKICAgICAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAidXBkYXRlX3Byb3h5IiwKICAgICAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgICAgICJwcm94eV9jb25maWciOiB7CiAgICAgICAgICAgICAgICAgICAgICAgICJpZCI6ICJwcm94eV80NTYiLAogICAgICAgICAgICAgICAgICAgICAgICAiaG9zdCI6ICJwcm94eS5leGFtcGxlLmNvbSIsCiAgICAgICAgICAgICAgICAgICAgICAgICJwb3J0IjogODA4MCwKICAgICAgICAgICAgICAgICAgICAgICAgInVzZXJuYW1lIjogInVzZXIiLAogICAgICAgICAgICAgICAgICAgICAgICAicGFzc3dvcmQiOiAicGFzcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICJ0eXBlIjogImh0dHAiCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICJtZXNzYWdlIjogIiIsCiAgICAgICAgICAgICAgICAic3RhdHVzIjogInBlbmRpbmciCiAgICAgICAgICAgIH0KICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfaWQgPSB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIikKICAgICAgICAgICAgZGV2aWNlX2lkID0gdGFza19kYXRhLmdldCgiZGV2aWNlX2lkIikKICAgICAgICAgICAgZGF0YSA9IHRhc2tfZGF0YS5nZXQoImRhdGEiLCB7fSkKICAgICAgICAgICAgCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTmjhuq1uIHnDqnUgY+G6p3UgY+G6rXAgbmjhuq10IHByb3h5IHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgIHByb3h5X2NvbmZpZyA9IGRhdGEKICAgICAgICAgICAgaWYgbm90IHByb3h5X2NvbmZpZzoKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJUaGnhur91IHRow7RuZyB0aW4gcHJveHlfY29uZmlnIHRyb25nIGThu68gbGnhu4d1IHRhc2siCiAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhlcnJvcl9tc2cpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAiZmFpbGVkIiwgZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIEzGsHUgY+G6pXUgaMOsbmggcHJveHkgdsOgbyBkYXRhYmFzZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfY29uZmlnIiwgcHJveHlfY29uZmlnKQogICAgICAgICAgICAgICAgIyBSZXNldCB0cuG6oW5nIHRow6FpIHnDqnUgY+G6p3UgcHJveHkgdsOsIMSRw6Mgbmjhuq1uIMSRxrDhu6NjIHByb3h5CiAgICAgICAgICAgICAgICBzZWxmLmRiLnNldCgicHJveHlfcmVxdWVzdGVkIiwgMCkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDoyBj4bqtcCBuaOG6rXQgY+G6pXUgaMOsbmggcHJveHk6IHtwcm94eV9jb25maWdbJ25hbWUnXX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIEfhu61pIGLDoW8gY8OhbyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHN1Y2Nlc3NfbXNnID0gZiLEkMOjIGPhuq1wIG5o4bqtdCBwcm94eToge3Byb3h5X2NvbmZpZ1snbmFtZSddfSIKICAgICAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJzdWNjZXNzIiwgc3VjY2Vzc19tc2cpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSBraGkgbMawdSBj4bqldSBow6xuaCBwcm94eToge3N0cihlKX0iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXJyb3JfbXNnID0gZiJM4buXaSB44butIGzDvSBj4bqtcCBuaOG6rXQgcHJveHk6IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCh0YXNrX2lkLCBkZXZpY2VfaWQsICJmYWlsZWQiLCBlcnJvcl9tc2cpCgogICAgZGVmIF9oYW5kbGVfc3RyZWFtX2xvZyhzZWxmLCB0YXNrX2RhdGEpOgogICAgICAgICIiIgogICAgICAgIFjhu60gbMO9IHRhc2sgc3RyZWFtIGxvZyByZWFsdGltZQogICAgICAgIAogICAgICAgIFRhc2sgZm9ybWF0OgogICAgICAgIHsKICAgICAgICAgICAgInRhc2tfaWQiOiAidGFza18xMjM0NTY3ODkwXzEyMyIsCiAgICAgICAgICAgICJkZXZpY2VfaWQiOiAiZGV2aWNlLTAwMSIsCiAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAic3RyZWFtX2xvZyIsCiAgICAgICAgICAgICJtZXNzYWdlIjogIkLhuq90IMSR4bqndSBzdHJlYW0gbG9nIiwKICAgICAgICAgICAgInRpbWVzdGFtcCI6ICIyMDI1LTEwLTMxVC4uLiIKICAgICAgICB9CiAgICAgICAgCiAgICAgICAgTG9naWM6CiAgICAgICAgLSBDYXB0dXJlIHThuqV0IGPhuqMgbG9nIG1lc3NhZ2VzIHJlYWx0aW1lCiAgICAgICAgLSBQdWJsaXNoIGzDqm4gdG9waWM6IGRuZHZpbmEvY2xpZW50L2xvZy97ZGV2aWNlX2lkfQogICAgICAgIC0gVGltZW91dCA2MHMsIHJlc2V0IG7hur91IG5o4bqtbiB0YXNrIG3hu5tpCiAgICAgICAgLSBU4buxIMSR4buZbmcgZOG7q25nIHNhdSA2MHMga2jDtG5nIGhv4bqhdCDEkeG7mW5nCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IHN0cmVhbSBsb2cgdOG7qyBzZXJ2ZXIgKHRhc2tfaWQ6IHt0YXNrX2lkfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBSZXNldCB0aW1lb3V0IG7hur91IMSRYW5nIHN0cmVhbQogICAgICAgICAgICBpZiBzZWxmLnN0cmVhbV9hY3RpdmU6CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbygiTG9nIHN0cmVhbSDEkWFuZyBjaOG6oXksIHJlc2V0IHRpbWVvdXQgduG7gSA2MHMiKQogICAgICAgICAgICAgICAgc2VsZi5zdHJlYW1fbGFzdF9hY3Rpdml0eSA9IHRpbWUudGltZSgpCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsICLEkMOjIHJlc2V0IGxvZyBzdHJlYW0gdGltZW91dCIpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgCiAgICAgICAgICAgICMgQuG6r3QgxJHhuqd1IGxvZyBzdHJlYW0gbeG7m2kKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkLhuq90IMSR4bqndSBsb2cgc3RyZWFtIG3hu5tpIikKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gVHJ1ZQogICAgICAgICAgICBzZWxmLnN0cmVhbV9sYXN0X2FjdGl2aXR5ID0gdGltZS50aW1lKCkKICAgICAgICAgICAgc2VsZi5zdHJlYW1fc3RvcF9ldmVudC5jbGVhcigpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFN0YXJ0IGxvZyBzdHJlYW1pbmcKICAgICAgICAgICAgdXRpbHMuc3RhcnRfbG9nX3N0cmVhbShzZWxmKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTdGFydCBzdHJlYW0gdGhyZWFkCiAgICAgICAgICAgIHNlbGYuc3RyZWFtX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQoCiAgICAgICAgICAgICAgICB0YXJnZXQ9c2VsZi5fc3RyZWFtX2xvZ19sb29wLAogICAgICAgICAgICAgICAgYXJncz0oZGV2aWNlX2lkLCksCiAgICAgICAgICAgICAgICBkYWVtb249VHJ1ZQogICAgICAgICAgICApCiAgICAgICAgICAgIHNlbGYuc3RyZWFtX3RocmVhZC5zdGFydCgpCiAgICAgICAgICAgIAogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQodGFza19pZCwgZGV2aWNlX2lkLCAic3VjY2VzcyIsICLEkMOjIGLhuq90IMSR4bqndSBzdHJlYW0gbG9nIikKICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9tc2cgPSBmIkzhu5dpIHjhu60gbMO9IHN0cmVhbSBsb2c6IHtzdHIoZSl9IgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJ0YXNrX2lkIiksCiAgICAgICAgICAgICAgICB0YXNrX2RhdGEuZ2V0KCJkZXZpY2VfaWQiKSwKICAgICAgICAgICAgICAgICJmYWlsZWQiLAogICAgICAgICAgICAgICAgZXJyb3JfbXNnCiAgICAgICAgICAgICkKICAgIAogICAgZGVmIF9zdHJlYW1fbG9nX2xvb3Aoc2VsZiwgZGV2aWNlX2lkOiBzdHIpOgogICAgICAgICIiIgogICAgICAgIExvb3Agc3RyZWFtIGxvZyByZWFsdGltZQogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRldmljZV9pZDogRGV2aWNlIElEIMSR4buDIHB1Ymxpc2ggbMOqbiB0b3BpYwogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgc3RyZWFtX3RvcGljID0gZiJkbmR2aW5hL2NsaWVudC9sb2cve2RldmljZV9pZH0iCiAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiTG9nIHN0cmVhbSBsb29wIHN0YXJ0ZWQsIHB1Ymxpc2hpbmcgdG86IHtzdHJlYW1fdG9waWN9IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGNvbnNlY3V0aXZlX2Vycm9ycyA9IDAKICAgICAgICAgICAgbWF4X2NvbnNlY3V0aXZlX2Vycm9ycyA9IDUKICAgICAgICAgICAgCiAgICAgICAgICAgIHdoaWxlIHNlbGYuc3RyZWFtX2FjdGl2ZSBhbmQgbm90IHNlbGYuc3RyZWFtX3N0b3BfZXZlbnQuaXNfc2V0KCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyBLaeG7g20gdHJhIHRpbWVvdXQgKDYwcykKICAgICAgICAgICAgICAgICAgICBlbGFwc2VkID0gdGltZS50aW1lKCkgLSBzZWxmLnN0cmVhbV9sYXN0X2FjdGl2aXR5CiAgICAgICAgICAgICAgICAgICAgaWYgZWxhcHNlZCA+PSBzZWxmLnN0cmVhbV90aW1lb3V0OgogICAgICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkxvZyBzdHJlYW0gdGltZW91dCBzYXUge3NlbGYuc3RyZWFtX3RpbWVvdXR9cywgxJFhbmcgZOG7q25nLi4uIikKICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAjIE7hur91IGPDsyBxdcOhIG5oaeG7gXUgbOG7l2kgbGnDqm4gdGnhur9wLCBk4burbmcgc3RyZWFtCiAgICAgICAgICAgICAgICAgICAgaWYgY29uc2VjdXRpdmVfZXJyb3JzID49IG1heF9jb25zZWN1dGl2ZV9lcnJvcnM6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIlF1w6Egbmhp4buBdSBs4buXaSBsacOqbiB0aeG6v3AgKHtjb25zZWN1dGl2ZV9lcnJvcnN9KSwgZOG7q25nIGxvZyBzdHJlYW0iKQogICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgTOG6pXkgbG9nIGVudHJpZXMgdOG7qyBxdWV1ZQogICAgICAgICAgICAgICAgICAgIHBlbmRpbmdfbG9ncyA9IHV0aWxzLmdldF9wZW5kaW5nX2xvZ3MoKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmIHBlbmRpbmdfbG9nczoKICAgICAgICAgICAgICAgICAgICAgICAgIyBSZXNldCBlcnJvciBjb3VudGVyIGtoaSBjw7MgbG9nCiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNlY3V0aXZlX2Vycm9ycyA9IDAKICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgVOG6oW8gcGF5bG9hZCDEkeG7gyBwdWJsaXNoCiAgICAgICAgICAgICAgICAgICAgICAgIHN0cmVhbV9wYXlsb2FkID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgImRldmljZV9pZCI6IGRldmljZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICJ0aW1lc3RhbXAiOiBpbnQodGltZS50aW1lKCkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgImxvZ3MiOiBwZW5kaW5nX2xvZ3MsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAidGltZW91dF9yZW1haW5pbmciOiBpbnQoc2VsZi5zdHJlYW1fdGltZW91dCAtIGVsYXBzZWQpCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgICAgICMgUHVibGlzaCBsw6puIE1RVFQKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2FmZV9wdWJsaXNoKHN0cmVhbV90b3BpYywganNvbi5kdW1wcyhzdHJlYW1fcGF5bG9hZCksIHFvcz0wKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgU2xlZXAgMC41cyB0csaw4bubYyBraGkgY2hlY2sgdGnhur9wCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgwLjUpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgY29uc2VjdXRpdmVfZXJyb3JzICs9IDEKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJM4buXaSB0cm9uZyBsb2cgc3RyZWFtIGxvb3AgKHtjb25zZWN1dGl2ZV9lcnJvcnN9L3ttYXhfY29uc2VjdXRpdmVfZXJyb3JzfSk6IHtlfSIpCiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgwLjUpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIENsZWFudXAKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gRmFsc2UKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIkxvZyBzdHJlYW0gxJHDoyBk4burbmciKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIGxvZyBzdHJlYW0gbG9vcDoge2V9IikKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gRmFsc2UKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICAjIEFsd2F5cyBzdG9wIGxvZyBzdHJlYW1pbmcga2hpIGxvb3Aga+G6v3QgdGjDumMKICAgICAgICAgICAgdXRpbHMuc3RvcF9sb2dfc3RyZWFtKCkKCiAgICBkZWYgX2hhbmRsZV9ydW5fY21kKHNlbGYsIHRhc2tfZGF0YSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayBydW4gY29tbWFuZCB04burIHNlcnZlcgogICAgICAgIAogICAgICAgIFRhc2sgZm9ybWF0IHThu6sgc2VydmVyIE1RVFQ6CiAgICAgICAgewogICAgICAgICAgICAidGFza19pZCI6ICJ0YXNrXzEyMzQ1Njc4OTBfMTIzIiwKICAgICAgICAgICAgImRldmljZV9pZCI6ICJkZXZpY2UtMDAxIiwgCiAgICAgICAgICAgICJ0YXNrX3R5cGUiOiAicnVuX2NtZCIsCiAgICAgICAgICAgICJkYXRhIjogewogICAgICAgICAgICAgICAgImNvbW1hbmQiOiAibHMgLWxhIiwKICAgICAgICAgICAgICAgICJ0aW1lb3V0IjogMzAsCiAgICAgICAgICAgICAgICAic2hlbGwiOiB0cnVlCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIGRhdGEgPSB0YXNrX2RhdGEuZ2V0KCJkYXRhIiwge30pCiAgICAgICAgICAgIAogICAgICAgICAgICBjb21tYW5kID0gZGF0YS5nZXQoImNvbW1hbmQiKQogICAgICAgICAgICB0aW1lb3V0ID0gZGF0YS5nZXQoInRpbWVvdXQiLCAzMCkgICMgRGVmYXVsdCAzMHMgdGltZW91dAogICAgICAgICAgICB1c2Vfc2hlbGwgPSBkYXRhLmdldCgic2hlbGwiLCBUcnVlKSAgIyBEZWZhdWx0IHVzZSBzaGVsbAogICAgICAgICAgICAKICAgICAgICAgICAgaWYgbm90IGNvbW1hbmQ6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSAiS2jDtG5nIGPDsyBjb21tYW5kIMSR4buDIHRo4buxYyB0aGkiCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJOaOG6rW4gecOqdSBj4bqndSBjaOG6oXkgY29tbWFuZDoge2NvbW1hbmR9ICh0aW1lb3V0OiB7dGltZW91dH1zKSIpCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFRo4buxYyB0aGkgY29tbWFuZAogICAgICAgICAgICByZXN1bHQgPSBzZWxmLl9leGVjdXRlX2NvbW1hbmQoY29tbWFuZCwgdGltZW91dCwgdXNlX3NoZWxsKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4butaSBiw6FvIGPDoW8ga+G6v3QgcXXhuqMKICAgICAgICAgICAgaWYgcmVzdWx0WyJzdWNjZXNzIl06CiAgICAgICAgICAgICAgICAjIFThuqFvIHJlc3BvbnNlIHbhu5tpIHN0ZG91dC9zdGRlcnIKICAgICAgICAgICAgICAgIHJlc3BvbnNlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgImNvbW1hbmQiOiBjb21tYW5kLAogICAgICAgICAgICAgICAgICAgICJleGl0X2NvZGUiOiByZXN1bHRbImV4aXRfY29kZSJdLAogICAgICAgICAgICAgICAgICAgICJzdGRvdXQiOiByZXN1bHRbInN0ZG91dCJdLAogICAgICAgICAgICAgICAgICAgICJzdGRlcnIiOiByZXN1bHRbInN0ZGVyciJdLAogICAgICAgICAgICAgICAgICAgICJleGVjdXRpb25fdGltZSI6IHJlc3VsdFsiZXhlY3V0aW9uX3RpbWUiXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICAgICAgdGFza19pZCwgCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2lkLCAKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyIsIAogICAgICAgICAgICAgICAgICAgIGYiQ29tbWFuZCBleGVjdXRlZCBzdWNjZXNzZnVsbHkgKGV4aXQgY29kZToge3Jlc3VsdFsnZXhpdF9jb2RlJ119KSIsCiAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2VfZGF0YQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIExvZyBr4bq/dCBxdeG6oyBjaGkgdGnhur90CiAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkNvbW1hbmQgZXhlY3V0ZWQgc3VjY2Vzc2Z1bGx5OiB7Y29tbWFuZH0gKGV4aXRfY29kZToge3Jlc3VsdFsnZXhpdF9jb2RlJ119LCB0aW1lOiB7cmVzdWx0WydleGVjdXRpb25fdGltZSddfXMpIikKICAgICAgICAgICAgICAgIGlmIHJlc3VsdFsic3Rkb3V0Il0uc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuaW5mbyhmIlNURE9VVDpcbntyZXN1bHRbJ3N0ZG91dCddLnN0cmlwKCl9IikKICAgICAgICAgICAgICAgIGlmIHJlc3VsdFsic3RkZXJyIl0uc3RyaXAoKToKICAgICAgICAgICAgICAgICAgICBsb2dnZXIud2FybmluZyhmIlNUREVSUjpcbntyZXN1bHRbJ3N0ZGVyciddLnN0cmlwKCl9IikKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTOG7l2kgdGjhu7FjIHRoaQogICAgICAgICAgICAgICAgZXJyb3JfZGF0YSA9IHsKICAgICAgICAgICAgICAgICAgICAiY29tbWFuZCI6IGNvbW1hbmQsCiAgICAgICAgICAgICAgICAgICAgImVycm9yIjogcmVzdWx0WyJlcnJvciJdLAogICAgICAgICAgICAgICAgICAgICJzdGRvdXQiOiByZXN1bHQuZ2V0KCJzdGRvdXQiLCAiIiksCiAgICAgICAgICAgICAgICAgICAgInN0ZGVyciI6IHJlc3VsdC5nZXQoInN0ZGVyciIsICIiKQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICAgICAgdGFza19pZCwKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfaWQsIAogICAgICAgICAgICAgICAgICAgICJmYWlsZWQiLAogICAgICAgICAgICAgICAgICAgIGYiQ29tbWFuZCBleGVjdXRpb24gZmFpbGVkOiB7cmVzdWx0WydlcnJvciddfSIsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JfZGF0YQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIExvZyBs4buXaSBjaGkgdGnhur90CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJDb21tYW5kIGV4ZWN1dGlvbiBmYWlsZWQ6IHtjb21tYW5kfSAtIHtyZXN1bHRbJ2Vycm9yJ119IikKICAgICAgICAgICAgICAgIGlmIHJlc3VsdC5nZXQoInN0ZG91dCIsICIiKS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYiU1RET1VUOlxue3Jlc3VsdFsnc3Rkb3V0J10uc3RyaXAoKX0iKQogICAgICAgICAgICAgICAgaWYgcmVzdWx0LmdldCgic3RkZXJyIiwgIiIpLnN0cmlwKCk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiU1RERVJSOlxue3Jlc3VsdFsnc3RkZXJyJ10uc3RyaXAoKX0iKQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBlcnJvcl9tc2cgPSBmIkzhu5dpIHjhu60gbMO9IHJ1bl9jbWQgdGFzazoge3N0cihlKX0iCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCgKICAgICAgICAgICAgICAgIHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKSwKICAgICAgICAgICAgICAgIHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpLAogICAgICAgICAgICAgICAgImZhaWxlZCIsIAogICAgICAgICAgICAgICAgZXJyb3JfbXNnCiAgICAgICAgICAgICkKCiAgICBkZWYgX2V4ZWN1dGVfY29tbWFuZChzZWxmLCBjb21tYW5kOiBzdHIsIHRpbWVvdXQ6IGludCA9IDMwLCB1c2Vfc2hlbGw6IGJvb2wgPSBUcnVlKSAtPiBEaWN0W3N0ciwgQW55XToKICAgICAgICAiIiIKICAgICAgICBUaOG7sWMgdGhpIGNvbW1hbmQgdsOgIHRy4bqjIHbhu4Ega+G6v3QgcXXhuqMKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjb21tYW5kOiBDb21tYW5kIHN0cmluZyDEkeG7gyB0aOG7sWMgdGhpCiAgICAgICAgICAgIHRpbWVvdXQ6IFRpbWVvdXQgdHJvbmcgZ2nDonkgCiAgICAgICAgICAgIHVzZV9zaGVsbDogVHJ1ZSDEkeG7gyBjaOG6oXkgdHJvbmcgc2hlbGwsIEZhbHNlIMSR4buDIGNo4bqheSB0cuG7sWMgdGnhur9wCiAgICAgICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgduG7m2kgdGjDtG5nIHRpbiBr4bq/dCBxdeG6ozoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBib29sLAogICAgICAgICAgICAgICAgImV4aXRfY29kZSI6IGludCwKICAgICAgICAgICAgICAgICJzdGRvdXQiOiBzdHIsCiAgICAgICAgICAgICAgICAic3RkZXJyIjogc3RyLCAKICAgICAgICAgICAgICAgICJleGVjdXRpb25fdGltZSI6IGZsb2F0LAogICAgICAgICAgICAgICAgImVycm9yIjogc3RyICAjIG7hur91IGPDsyBs4buXaQogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgaW1wb3J0IHRpbWUKICAgICAgICAKICAgICAgICBzdGFydF90aW1lID0gdGltZS50aW1lKCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgQ2h14bqpbiBi4buLIGNvbW1hbmQKICAgICAgICAgICAgaWYgdXNlX3NoZWxsOgogICAgICAgICAgICAgICAgaWYgb3MubmFtZSA9PSAnbnQnOiAgIyBXaW5kb3dzCiAgICAgICAgICAgICAgICAgICAgIyBT4butIGThu6VuZyBjbWQuZXhlIGNobyBXaW5kb3dzCiAgICAgICAgICAgICAgICAgICAgY21kX2FyZ3MgPSBbJ2NtZCcsICcvYycsIGNvbW1hbmRdCiAgICAgICAgICAgICAgICBlbHNlOiAgIyBMaW51eC9Vbml4CiAgICAgICAgICAgICAgICAgICAgY21kX2FyZ3MgPSBbJy9iaW4vYmFzaCcsICctYycsIGNvbW1hbmRdCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFNwbGl0IGNvbW1hbmQgdGjDoG5oIGxpc3QgYXJndW1lbnRzCiAgICAgICAgICAgICAgICBjbWRfYXJncyA9IGNvbW1hbmQuc3BsaXQoKQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiRXhlY3V0aW5nIGNvbW1hbmQ6IHtjbWRfYXJnc30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBUaOG7sWMgdGhpIGNvbW1hbmQKICAgICAgICAgICAgcmVzdWx0ID0gc3VicHJvY2Vzcy5ydW4oCiAgICAgICAgICAgICAgICBjbWRfYXJncywKICAgICAgICAgICAgICAgIHN0ZG91dD1zdWJwcm9jZXNzLlBJUEUsCiAgICAgICAgICAgICAgICBzdGRlcnI9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICAgICAgdGV4dD1UcnVlLAogICAgICAgICAgICAgICAgdGltZW91dD10aW1lb3V0LAogICAgICAgICAgICAgICAgc2hlbGw9RmFsc2UgICMgxJDDoyBoYW5kbGUgc2hlbGwg4bufIHRyw6puCiAgICAgICAgICAgICkKICAgICAgICAgICAgCiAgICAgICAgICAgIGV4ZWN1dGlvbl90aW1lID0gdGltZS50aW1lKCkgLSBzdGFydF90aW1lCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBUcnVlLAogICAgICAgICAgICAgICAgImV4aXRfY29kZSI6IHJlc3VsdC5yZXR1cm5jb2RlLAogICAgICAgICAgICAgICAgInN0ZG91dCI6IHJlc3VsdC5zdGRvdXQsCiAgICAgICAgICAgICAgICAic3RkZXJyIjogcmVzdWx0LnN0ZGVyciwKICAgICAgICAgICAgICAgICJleGVjdXRpb25fdGltZSI6IHJvdW5kKGV4ZWN1dGlvbl90aW1lLCAzKQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBzdWJwcm9jZXNzLlRpbWVvdXRFeHBpcmVkIGFzIGU6CiAgICAgICAgICAgIGV4ZWN1dGlvbl90aW1lID0gdGltZS50aW1lKCkgLSBzdGFydF90aW1lCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLAogICAgICAgICAgICAgICAgImV4aXRfY29kZSI6IC0xLAogICAgICAgICAgICAgICAgInN0ZG91dCI6IGUuc3Rkb3V0LmRlY29kZSgndXRmLTgnKSBpZiBlLnN0ZG91dCBlbHNlICIiLAogICAgICAgICAgICAgICAgInN0ZGVyciI6IGUuc3RkZXJyLmRlY29kZSgndXRmLTgnKSBpZiBlLnN0ZGVyciBlbHNlICIiLAogICAgICAgICAgICAgICAgImV4ZWN1dGlvbl90aW1lIjogcm91bmQoZXhlY3V0aW9uX3RpbWUsIDMpLAogICAgICAgICAgICAgICAgImVycm9yIjogZiJDb21tYW5kIHRpbWVvdXQgYWZ0ZXIge3RpbWVvdXR9cyIKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3IgYXMgZToKICAgICAgICAgICAgZXhlY3V0aW9uX3RpbWUgPSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAiZXhpdF9jb2RlIjogZS5yZXR1cm5jb2RlLAogICAgICAgICAgICAgICAgInN0ZG91dCI6IGUuc3Rkb3V0IGlmIGUuc3Rkb3V0IGVsc2UgIiIsCiAgICAgICAgICAgICAgICAic3RkZXJyIjogZS5zdGRlcnIgaWYgZS5zdGRlcnIgZWxzZSAiIiwKICAgICAgICAgICAgICAgICJleGVjdXRpb25fdGltZSI6IHJvdW5kKGV4ZWN1dGlvbl90aW1lLCAzKSwKICAgICAgICAgICAgICAgICJlcnJvciI6IGYiQ29tbWFuZCBmYWlsZWQgd2l0aCBleGl0IGNvZGUge2UucmV0dXJuY29kZX0iCiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yIGFzIGU6CiAgICAgICAgICAgIGV4ZWN1dGlvbl90aW1lID0gdGltZS50aW1lKCkgLSBzdGFydF90aW1lCiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLAogICAgICAgICAgICAgICAgImV4aXRfY29kZSI6IC0xLAogICAgICAgICAgICAgICAgInN0ZG91dCI6ICIiLAogICAgICAgICAgICAgICAgInN0ZGVyciI6ICIiLAogICAgICAgICAgICAgICAgImV4ZWN1dGlvbl90aW1lIjogcm91bmQoZXhlY3V0aW9uX3RpbWUsIDMpLAogICAgICAgICAgICAgICAgImVycm9yIjogZiJDb21tYW5kIG5vdCBmb3VuZDoge2V9IgogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgZXhlY3V0aW9uX3RpbWUgPSB0aW1lLnRpbWUoKSAtIHN0YXJ0X3RpbWUKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICJzdWNjZXNzIjogRmFsc2UsCiAgICAgICAgICAgICAgICAiZXhpdF9jb2RlIjogLTEsCiAgICAgICAgICAgICAgICAic3Rkb3V0IjogIiIsCiAgICAgICAgICAgICAgICAic3RkZXJyIjogIiIsCiAgICAgICAgICAgICAgICAiZXhlY3V0aW9uX3RpbWUiOiByb3VuZChleGVjdXRpb25fdGltZSwgMyksCiAgICAgICAgICAgICAgICAiZXJyb3IiOiBmIlVuZXhwZWN0ZWQgZXJyb3I6IHtzdHIoZSl9IgogICAgICAgICAgICB9CgogICAgZGVmIF9oYW5kbGVfZmxhc2hfbGlnaHQoc2VsZiwgdGFza19kYXRhKToKICAgICAgICAiIiIKICAgICAgICBY4butIGzDvSB0YXNrIGLhuq10IMSRw6huIGZsYXNoIHThu6sgc2VydmVyCiAgICAgICAgCiAgICAgICAgVGFzayBmb3JtYXQgdOG7qyBzZXJ2ZXIgTVFUVDoKICAgICAgICB7CiAgICAgICAgICAgICJ0YXNrX2lkIjogInRhc2tfMTIzNDU2Nzg5MF8xMjMiLAogICAgICAgICAgICAiZGV2aWNlX2lkIjogImRldmljZS0wMDEiLCAKICAgICAgICAgICAgInRhc2tfdHlwZSI6ICJmbGFzaF9saWdodCIKICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICB0YXNrX2lkID0gdGFza19kYXRhLmdldCgidGFza19pZCIpCiAgICAgICAgICAgIGRldmljZV9pZCA9IHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIk5o4bqtbiB5w6p1IGPhuqd1IGLhuq10IMSRw6huIGZsYXNoIHThu6sgc2VydmVyICh0YXNrX2lkOiB7dGFza19pZH0pIikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgS2nhu4NtIHRyYSBoZWxwZXJfc2VydmljZQogICAgICAgICAgICBpZiBub3Qgc2VsZi5oZWxwZXJfc2VydmljZToKICAgICAgICAgICAgICAgIGVycm9yX21zZyA9ICJIZWxwZXIgc2VydmljZSBjaMawYSDEkcaw4bujYyBraOG7n2kgdOG6oW8iCiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZXJyb3JfbXNnKQogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3Rhc2tfcmVwb3J0KHRhc2tfaWQsIGRldmljZV9pZCwgImZhaWxlZCIsIGVycm9yX21zZykKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgIyBH4buNaSBBUEkgZmxhc2gtbGlnaHQKICAgICAgICAgICAgcmVzdWx0ID0gc2VsZi5fY2FsbF9mbGFzaF9saWdodF9hcGkoKQogICAgICAgICAgICAKICAgICAgICAgICAgaWYgcmVzdWx0WyJzdWNjZXNzIl06CiAgICAgICAgICAgICAgICAjIEfhu61pIGLDoW8gY8OhbyB0aMOgbmggY8O0bmcKICAgICAgICAgICAgICAgIHJlc3BvbnNlX2RhdGEgPSB7CiAgICAgICAgICAgICAgICAgICAgIm1lc3NhZ2UiOiAixJDDqG4gZmxhc2ggxJHDoyDEkcaw4bujYyBi4bqtdCB2w6Agc+G6vSB04buxIMSR4buZbmcgdOG6r3Qgc2F1IDE1IGdpw6J5IgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICAgICAgdGFza19pZCwgCiAgICAgICAgICAgICAgICAgICAgZGV2aWNlX2lkLCAKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyIsIAogICAgICAgICAgICAgICAgICAgIGYixJDDqG4gZmxhc2ggxJHDoyDEkcaw4bujYyBi4bqtdCB0aMOgbmggY8O0bmciLAogICAgICAgICAgICAgICAgICAgIHJlc3BvbnNlX2RhdGEKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgICAgIGxvZ2dlci5pbmZvKGYixJDDqG4gZmxhc2ggxJHDoyDEkcaw4bujYyBi4bqtdCB0aMOgbmggY8O0bmcsIHPhur0gdOG7sSB04bqvdCBzYXUgMTVzIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgR+G7rWkgYsOhbyBjw6FvIGzhu5dpCiAgICAgICAgICAgICAgICBlcnJvcl9kYXRhID0gewogICAgICAgICAgICAgICAgICAgICJlcnJvciI6IHJlc3VsdFsiZXJyb3IiXQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBzZWxmLnNlbmRfdGFza19yZXBvcnQoCiAgICAgICAgICAgICAgICAgICAgdGFza19pZCwKICAgICAgICAgICAgICAgICAgICBkZXZpY2VfaWQsIAogICAgICAgICAgICAgICAgICAgICJmYWlsZWQiLAogICAgICAgICAgICAgICAgICAgIGYiS2jDtG5nIHRo4buDIGLhuq10IMSRw6huIGZsYXNoOiB7cmVzdWx0WydlcnJvciddfSIsCiAgICAgICAgICAgICAgICAgICAgZXJyb3JfZGF0YQogICAgICAgICAgICAgICAgKQogICAgICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiS2jDtG5nIHRo4buDIGLhuq10IMSRw6huIGZsYXNoOiB7cmVzdWx0WydlcnJvciddfSIpCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGVycm9yX21zZyA9IGYiTOG7l2kgeOG7rSBsw70gZmxhc2hfbGlnaHQgdGFzazoge3N0cihlKX0iCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlcnJvcl9tc2cpCiAgICAgICAgICAgIHNlbGYuc2VuZF90YXNrX3JlcG9ydCgKICAgICAgICAgICAgICAgIHRhc2tfZGF0YS5nZXQoInRhc2tfaWQiKSwKICAgICAgICAgICAgICAgIHRhc2tfZGF0YS5nZXQoImRldmljZV9pZCIpLAogICAgICAgICAgICAgICAgImZhaWxlZCIsIAogICAgICAgICAgICAgICAgZXJyb3JfbXNnCiAgICAgICAgICAgICkKCiAgICBkZWYgX2NhbGxfZmxhc2hfbGlnaHRfYXBpKHNlbGYpIC0+IERpY3Rbc3RyLCBBbnldOgogICAgICAgICIiIgogICAgICAgIEfhu41pIEFQSSBmbGFzaC1saWdodCDEkeG7gyBi4bqtdCDEkcOobiBmbGFzaAogICAgICAgIAogICAgICAgIFJldHVybnM6CiAgICAgICAgICAgIERpY3QgduG7m2kgdGjDtG5nIHRpbiBr4bq/dCBxdeG6ozoKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBib29sLAogICAgICAgICAgICAgICAgImVycm9yIjogc3RyICAjIG7hur91IGPDsyBs4buXaQogICAgICAgICAgICB9CiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFPhu60gZOG7pW5nIGhlbHBlcl9zZXJ2aWNlIMSR4buDIGfhu41pIEFQSQogICAgICAgICAgICByZXN1bHQgPSBzZWxmLmhlbHBlcl9zZXJ2aWNlLl9tYWtlX3JlcXVlc3QoImZsYXNoLWxpZ2h0IikKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJlc3VsdC5nZXQoInN0YXR1cyIpID09ICJzdWNjZXNzIjoKICAgICAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBUcnVlCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBlcnJvcl9tc2cgPSByZXN1bHQuZ2V0KCJtZXNzYWdlIiwgIlVua25vd24gZXJyb3IiKQogICAgICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgICAgICAic3VjY2VzcyI6IEZhbHNlLAogICAgICAgICAgICAgICAgICAgICJlcnJvciI6IGVycm9yX21zZwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgInN1Y2Nlc3MiOiBGYWxzZSwKICAgICAgICAgICAgICAgICJlcnJvciI6IGYiQVBJIGNhbGwgZmFpbGVkOiB7c3RyKGUpfSIKICAgICAgICAgICAgfQoKICAgIGRlZiBzdG9wX3N0cmVhbShzZWxmKToKICAgICAgICAiIiJE4burbmcgbG9nIHN0cmVhbSIiIgogICAgICAgIGlmIHNlbGYuc3RyZWFtX2FjdGl2ZToKICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQYW5nIGThu6tuZyBsb2cgc3RyZWFtLi4uIikKICAgICAgICAgICAgc2VsZi5zdHJlYW1fYWN0aXZlID0gRmFsc2UKICAgICAgICAgICAgc2VsZi5zdHJlYW1fc3RvcF9ldmVudC5zZXQoKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBTdG9wIGxvZyBzdHJlYW1pbmcKICAgICAgICAgICAgdXRpbHMuc3RvcF9sb2dfc3RyZWFtKCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHNlbGYuc3RyZWFtX3RocmVhZDoKICAgICAgICAgICAgICAgIHNlbGYuc3RyZWFtX3RocmVhZC5qb2luKHRpbWVvdXQ9Mi4wKQogICAgICAgICAgICAgICAgc2VsZi5zdHJlYW1fdGhyZWFkID0gTm9uZQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICAiIiIKICAgICAgICBLaOG7n2kgxJHhu5luZyBNUVRUIHNlcnZpY2UKICAgICAgICAKICAgICAgICBSZXR1cm5zOgogICAgICAgICAgICBib29sOiBUcnVlIG7hur91IGto4bufaSDEkeG7mW5nIHRow6BuaCBjw7RuZywgRmFsc2UgbuG6v3UgdGjhuqV0IGLhuqFpCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFRoaeG6v3QgbOG6rXAgY8OhYyBoYW5kbGVyIHRyxrDhu5tjIGtoaSBr4bq/dCBu4buRaQogICAgICAgICAgICBzZWxmLnNldHVwX21xdHRfaGFuZGxlcnMoKQogICAgICAgICAgICBzZWxmLmNvbm5lY3QoKQogICAgICAgICAgICAjIEto4bufaSDEkeG7mW5nIHN5bmMgdGhyZWFkIHNhdSBraGkga+G6v3QgbuG7kWkgdGjDoG5oIGPDtG5nCiAgICAgICAgICAgIHNlbGYuc3RhcnRfc3luY190aHJlYWQoKQogICAgICAgICAgICBsb2dnZXIuaW5mbygixJDDoyBraOG7n2kgxJHhu5luZyBNUVRUIHNlcnZpY2UgdsOgIMSR4buTbmcgYuG7mSBk4buvIGxp4buHdSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmV4Y2VwdGlvbihlLCAiTOG7l2kga2hpIGto4bufaSDEkeG7mW5nIE1RVFQgc2VydmljZSIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfb25fbWVzc2FnZShzZWxmLCBjbGllbnQsIHVzZXJkYXRhLCBtc2csIHByb3BlcnRpZXM9Tm9uZSk6CiAgICAgICAgIiIiCiAgICAgICAgQ2FsbGJhY2sga2hpIG5o4bqtbiDEkcaw4bujYyBtZXNzYWdlIHThu6sgTVFUVCBicm9rZXIKICAgICAgICAKICAgICAgICBBcmdzOgogICAgICAgICAgICBjbGllbnQ6IE1RVFQgY2xpZW50IGluc3RhbmNlCiAgICAgICAgICAgIHVzZXJkYXRhOiBVc2VyIGRhdGEgxJHGsOG7o2MgdHJ1eeG7gW4gdsOgbyBjbGllbnQKICAgICAgICAgICAgbXNnOiBNZXNzYWdlIG9iamVjdCBjaOG7qWEgdG9waWMgdsOgIHBheWxvYWQKICAgICAgICAgICAgcHJvcGVydGllczogUHJvcGVydGllcyBj4bunYSBtZXNzYWdlIChNUVRUIHY1KQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiTmjhuq1uIG1lc3NhZ2UgdOG7qyB0b3BpYzoge21zZy50b3BpY30iKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBQYXJzZSBwYXlsb2FkIEpTT04KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGF5bG9hZCA9IGpzb24ubG9hZHMobXNnLnBheWxvYWQuZGVjb2RlKCd1dGYtOCcpKQogICAgICAgICAgICBleGNlcHQganNvbi5KU09ORGVjb2RlRXJyb3I6CiAgICAgICAgICAgICAgICBsb2dnZXIuZXJyb3IoZiJLaMO0bmcgdGjhu4MgcGFyc2UgSlNPTiB04burIHBheWxvYWQ6IHttc2cucGF5bG9hZH0iKQogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIAogICAgICAgICAgICAjIFjhu60gbMO9IG1lc3NhZ2UgZOG7sWEgdHLDqm4gdG9waWMKICAgICAgICAgICAgaWYgbXNnLnRvcGljID09IHNlbGYudG9waWNfc2VydmVyX3Rhc2s6CiAgICAgICAgICAgICAgICBzZWxmLl9oYW5kbGVfc2VydmVyX3Rhc2socGF5bG9hZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiTmjhuq1uIG1lc3NhZ2UgdOG7qyB0b3BpYyBraMO0bmcgeMOhYyDEkeG7i25oOiB7bXNnLnRvcGljfSIpCiAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHjhu60gbMO9IG1lc3NhZ2U6IHtzdHIoZSl9IikKCiAgICBkZWYgX2hhbmRsZV9zZXJ2ZXJfdGFzayhzZWxmLCBwYXlsb2FkOiBEaWN0W3N0ciwgQW55XSk6CiAgICAgICAgIiIiCiAgICAgICAgWOG7rSBsw70gdGFzayB04burIHNlcnZlcgogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIHBheWxvYWQ6IEThu68gbGnhu4d1IHRhc2sgdOG7qyBzZXJ2ZXIKICAgICAgICAiIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRhc2tfdHlwZSA9IHBheWxvYWQuZ2V0KCJ0YXNrX3R5cGUiKQogICAgICAgICAgICBpZiBub3QgdGFza190eXBlOgogICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIk5o4bqtbiB0YXNrIGtow7RuZyBjw7MgdGFza190eXBlIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiTmjhuq1uIHRhc2sgdOG7qyBzZXJ2ZXI6IHt0YXNrX3R5cGV9IikKICAgICAgICAgICAgCiAgICAgICAgICAgICMgR+G7jWkgaGFuZGxlciB0xrDGoW5nIOG7qW5nIG7hur91IMSRw6MgxJHEg25nIGvDvQogICAgICAgICAgICBpZiB0YXNrX3R5cGUgaW4gc2VsZi50YXNrX2hhbmRsZXJzOgogICAgICAgICAgICAgICAgc2VsZi50YXNrX2hhbmRsZXJzW3Rhc2tfdHlwZV0ocGF5bG9hZCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKGYiS2jDtG5nIHTDrG0gdGjhuqV5IGhhbmRsZXIgY2hvIHRhc2tfdHlwZToge3Rhc2tfdHlwZX0iKQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihmIkzhu5dpIHjhu60gbMO9IHRhc2sgdOG7qyBzZXJ2ZXI6IHtzdHIoZSl9IikKICAgIAogICAgZGVmIF9tb25pdG9yX3JhbV91c2FnZShzZWxmLCBkZXZpY2VfaW5mbzogRGljdFtzdHIsIEFueV0pOgogICAgICAgICIiIgogICAgICAgIFRoZW8gZMO1aSBSQU0gdsOgIHThu7EgxJHhu5luZyByZWJvb3QgbuG6v3UgUkFNIGNhbyBsacOqbiB04bulYwogICAgICAgIAogICAgICAgIEFyZ3M6CiAgICAgICAgICAgIGRldmljZV9pbmZvOiBUaMO0bmcgdGluIHRoaeG6v3QgYuG7iyBjaOG7qWEgUkFNIHVzYWdlCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFTDrW5oIHBo4bqnbiB0csSDbSBSQU0gc+G7rSBk4bulbmcgdOG7qyByYW1fdG90YWwgdsOgIHJhbV91c2VkCiAgICAgICAgICAgIHJhbV90b3RhbCA9IGRldmljZV9pbmZvLmdldCgicmFtX3RvdGFsIiwgMCkKICAgICAgICAgICAgcmFtX3VzZWQgPSBkZXZpY2VfaW5mby5nZXQoInJhbV91c2VkIiwgMCkKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmIHJhbV90b3RhbCA+IDAgYW5kIHJhbV91c2VkID49IDA6CiAgICAgICAgICAgICAgICByYW1fdXNhZ2VfcGVyY2VudCA9IChyYW1fdXNlZCAvIHJhbV90b3RhbCkgKiAxMDAKICAgICAgICAgICAgICAgIGxvZ2dlci5kZWJ1ZyhmIlTDrW5oIHRvw6FuIFJBTToge3JhbV91c2VkfU1CL3tyYW1fdG90YWx9TUIgPSB7cmFtX3VzYWdlX3BlcmNlbnQ6LjFmfSUiKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjazogdGjhu60gbOG6pXkgdHLhu7FjIHRp4bq/cCB04burIGRldmljZV9pbmZvCiAgICAgICAgICAgICAgICByYW1fdXNhZ2VfcGVyY2VudCA9IGRldmljZV9pbmZvLmdldCgicmFtX3BlcmNlbnRhZ2UiLCAwKQogICAgICAgICAgICAgICAgaWYgcmFtX3VzYWdlX3BlcmNlbnQgPT0gMDoKICAgICAgICAgICAgICAgICAgICBsb2dnZXIuZGVidWcoIktow7RuZyBjw7MgdGjDtG5nIHRpbiBSQU0gaOG7o3AgbOG7hywgc+G7rSBk4bulbmcgZ2nDoSB0cuG7iyBt4bq3YyDEkeG7i25oIDAiKQogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGYiU+G7rSBk4bulbmcgcmFtX3BlcmNlbnRhZ2UgdHLhu7FjIHRp4bq/cDoge3JhbV91c2FnZV9wZXJjZW50Oi4xZn0lIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAjIFRow6ptIHbDoG8gbOG7i2NoIHPhu60gKGNo4buJIGdp4buvIGzhuqFpIDMgbOG6p24gZ+G6p24gbmjhuqV0KQogICAgICAgICAgICBzZWxmLnJhbV91c2FnZV9oaXN0b3J5LmFwcGVuZChyYW1fdXNhZ2VfcGVyY2VudCkKICAgICAgICAgICAgaWYgbGVuKHNlbGYucmFtX3VzYWdlX2hpc3RvcnkpID4gc2VsZi5jb25zZWN1dGl2ZV9oaWdoX3JhbV9saW1pdDoKICAgICAgICAgICAgICAgIHNlbGYucmFtX3VzYWdlX2hpc3RvcnkucG9wKDApCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuZGVidWcoZiJSQU0gaGnhu4duIHThuqFpOiB7cmFtX3VzYWdlX3BlcmNlbnQ6LjFmfSUgKGzhu4tjaCBz4butOiB7W2Yne3g6LjFmfSUnIGZvciB4IGluIHNlbGYucmFtX3VzYWdlX2hpc3RvcnldfSkiKQogICAgICAgICAgICAKICAgICAgICAgICAgIyBLaeG7g20gdHJhIG7hur91IGPDsyDEkeG7pyAzIGzhuqduIMSRbyB2w6AgdOG6pXQgY+G6oyDEkeG7gXUgPiBuZ8aw4buhbmcKICAgICAgICAgICAgaWYgbGVuKHNlbGYucmFtX3VzYWdlX2hpc3RvcnkpID49IHNlbGYuY29uc2VjdXRpdmVfaGlnaF9yYW1fbGltaXQ6CiAgICAgICAgICAgICAgICBpZiBhbGwodXNhZ2UgPiBzZWxmLmhpZ2hfcmFtX3RocmVzaG9sZCBmb3IgdXNhZ2UgaW4gc2VsZi5yYW1fdXNhZ2VfaGlzdG9yeSk6CiAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoZiJSQU0gY2FvIGxpw6puIHThu6VjIHtzZWxmLmNvbnNlY3V0aXZlX2hpZ2hfcmFtX2xpbWl0fSBs4bqnbiAoPntzZWxmLmhpZ2hfcmFtX3RocmVzaG9sZH0lKToge1tmJ3t4Oi4xZn0lJyBmb3IgeCBpbiBzZWxmLnJhbV91c2FnZV9oaXN0b3J5XX0iKQogICAgICAgICAgICAgICAgICAgIGxvZ2dlci53YXJuaW5nKCJC4bqvdCDEkeG6p3UgcmVib290IHRoaeG6v3QgYuG7iyDEkeG7gyBnaeG6o2kgcGjDs25nIFJBTS4uLiIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBUaOG7sWMgaGnhu4duIHJlYm9vdAogICAgICAgICAgICAgICAgICAgIGlmIHNlbGYuX3JlYm9vdF9kZXZpY2UoKToKICAgICAgICAgICAgICAgICAgICAgICAgbG9nZ2VyLmluZm8oIsSQw6MgZ+G7rWkgbOG7h25oIHJlYm9vdCB0aMOgbmggY8O0bmciKQogICAgICAgICAgICAgICAgICAgICAgICAjIFJlc2V0IGzhu4tjaCBz4butIHNhdSBraGkgcmVib290CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmFtX3VzYWdlX2hpc3RvcnkuY2xlYXIoKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGxvZ2dlci5lcnJvcigiS2jDtG5nIHRo4buDIHRo4buxYyBoaeG7h24gcmVib290IHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHRoZW8gZMO1aSBSQU06IHtlfSIpCiAgICAKICAgIGRlZiBfcmVib290X2RldmljZShzZWxmKSAtPiBib29sOgogICAgICAgICIiIgogICAgICAgIFRo4buxYyBoaeG7h24gcmVib290IHRoaeG6v3QgYuG7iyBxdWEgQURCCiAgICAgICAgCiAgICAgICAgUmV0dXJuczoKICAgICAgICAgICAgYm9vbDogVHJ1ZSBu4bq/dSB0aMOgbmggY8O0bmcsIEZhbHNlIG7hur91IHRo4bqldCBi4bqhaQogICAgICAgICIiIgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBT4butIGThu6VuZyBERVZJQ0VfSVAgdOG7qyBjb25maWcgdGhheSB2w6wgQURCX0hPU1QKICAgICAgICAgICAgZGV2aWNlX2FkZHJlc3MgPSBmIntjb25maWcuREVWSUNFX0lQfTp7Y29uZmlnLkFEQl9QT1JUfSIKICAgICAgICAgICAgCiAgICAgICAgICAgICMgTOG7h25oIHJlYm9vdCBxdWEgQURCCiAgICAgICAgICAgIGNtZCA9IFsiYWRiIiwgIi1zIiwgZGV2aWNlX2FkZHJlc3MsICJyZWJvb3QiXQogICAgICAgICAgICAKICAgICAgICAgICAgbG9nZ2VyLmluZm8oZiJUaOG7sWMgaGnhu4duIHJlYm9vdCB0aGnhur90IGLhu4s6IHsnICcuam9pbihjbWQpfSIpCiAgICAgICAgICAgIAogICAgICAgICAgICByZXN1bHQgPSBzdWJwcm9jZXNzLnJ1bigKICAgICAgICAgICAgICAgIGNtZCwKICAgICAgICAgICAgICAgIGNoZWNrPVRydWUsCiAgICAgICAgICAgICAgICBzdGRvdXQ9c3VicHJvY2Vzcy5QSVBFLAogICAgICAgICAgICAgICAgc3RkZXJyPXN1YnByb2Nlc3MuUElQRSwKICAgICAgICAgICAgICAgIHRleHQ9VHJ1ZSwKICAgICAgICAgICAgICAgIHRpbWVvdXQ9MTAgICMgVGltZW91dCAxMCBnacOieQogICAgICAgICAgICApCiAgICAgICAgICAgIAogICAgICAgICAgICBsb2dnZXIuaW5mbyhmIkzhu4duaCByZWJvb3QgxJHDoyDEkcaw4bujYyBn4butaSB0aMOgbmggY8O0bmciKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5UaW1lb3V0RXhwaXJlZDoKICAgICAgICAgICAgbG9nZ2VyLndhcm5pbmcoIlRpbWVvdXQga2hpIGfhu61pIGzhu4duaCByZWJvb3QgKHRoaeG6v3QgYuG7iyBjw7MgdGjhu4MgxJFhbmcgcmVib290KSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlICAjIENvaSBuaMawIHRow6BuaCBjw7RuZyB2w6wgY8OzIHRo4buDIHRoaeG6v3QgYuG7iyDEkWFuZyByZWJvb3QKICAgICAgICBleGNlcHQgc3VicHJvY2Vzcy5DYWxsZWRQcm9jZXNzRXJyb3IgYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2hpIHRo4buxYyBoaeG7h24gcmVib290OiB7ZS5zdGRlcnJ9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZXhjZXB0IEZpbGVOb3RGb3VuZEVycm9yOgogICAgICAgICAgICBsb2dnZXIuZXJyb3IoIktow7RuZyB0w6xtIHRo4bqleSBs4buHbmggYWRiLCBraMO0bmcgdGjhu4MgcmVib290IHRoaeG6v3QgYuG7iyIpCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2VyLmVycm9yKGYiTOG7l2kga2jDtG5nIHjDoWMgxJHhu4tuaCBraGkgcmVib290IHRoaeG6v3QgYuG7izoge2V9IikKICAgICAgICAgICAgcmV0dXJuIEZhbHNl').decode('utf-8'))
